const a38_0x51914f=a38_0x7510;(function(_0x2adc1a,_0x253a1c){const _0x703244=a38_0x7510,_0x583dc8=_0x2adc1a();while(!![]){try{const _0x197bd6=parseInt(_0x703244(0x146))/0x1*(parseInt(_0x703244(0x123))/0x2)+parseInt(_0x703244(0x152))/0x3+parseInt(_0x703244(0x15c))/0x4*(-parseInt(_0x703244(0x12d))/0x5)+parseInt(_0x703244(0x134))/0x6+-parseInt(_0x703244(0x140))/0x7+-parseInt(_0x703244(0x143))/0x8+-parseInt(_0x703244(0x125))/0x9*(parseInt(_0x703244(0x150))/0xa);if(_0x197bd6===_0x253a1c)break;else _0x583dc8['push'](_0x583dc8['shift']());}catch(_0x2dd057){_0x583dc8['push'](_0x583dc8['shift']());}}}(a38_0x478d,0x5b551));const a38_0x4db1af=(function(){let _0x4dabc7=!![];return function(_0x249711,_0x37bf53){const _0x55066a=_0x4dabc7?function(){const _0x2c0813=a38_0x7510;if(_0x37bf53){const _0x1a2f9c=_0x37bf53[_0x2c0813(0x12e)](_0x249711,arguments);return _0x37bf53=null,_0x1a2f9c;}}:function(){};return _0x4dabc7=![],_0x55066a;};}()),a38_0x10bf3b=a38_0x4db1af(this,function(){const _0x4c37ff=a38_0x7510;return a38_0x10bf3b[_0x4c37ff(0x126)]()[_0x4c37ff(0x15b)](_0x4c37ff(0x136))[_0x4c37ff(0x126)]()[_0x4c37ff(0x154)](a38_0x10bf3b)['search'](_0x4c37ff(0x136));});a38_0x10bf3b();'use strict';var __importDefault=this&&this[a38_0x51914f(0x13d)]||function(_0x414ebf){const _0x521bbe=a38_0x51914f;return _0x414ebf&&_0x414ebf[_0x521bbe(0x147)]?_0x414ebf:{'default':_0x414ebf};};Object[a38_0x51914f(0x14e)](exports,'__esModule',{'value':!![]}),exports[a38_0x51914f(0x13c)]=exports['update']=exports[a38_0x51914f(0x12b)]=exports[a38_0x51914f(0x129)]=exports[a38_0x51914f(0x13a)]=exports[a38_0x51914f(0x157)]=exports[a38_0x51914f(0x138)]=exports['kanban']=exports[a38_0x51914f(0x155)]=void 0x0;const async_mutex_1=require('async-mutex'),socket_1=require('../libs/socket'),Ticket_1=__importDefault(require(a38_0x51914f(0x13b))),sequelize_1=require(a38_0x51914f(0x124)),CreateTicketService_1=__importDefault(require(a38_0x51914f(0x14b))),DeleteTicketService_1=__importDefault(require(a38_0x51914f(0x142))),ListTicketsService_1=__importDefault(require(a38_0x51914f(0x128))),ShowTicketFromUUIDService_1=__importDefault(require(a38_0x51914f(0x15f))),ShowTicketService_1=__importDefault(require(a38_0x51914f(0x14d))),UpdateTicketService_1=__importDefault(require(a38_0x51914f(0x158))),ListTicketsServiceKanban_1=__importDefault(require(a38_0x51914f(0x13e))),updateMutex=new async_mutex_1[(a38_0x51914f(0x127))](),index=async(_0x5a2da8,_0x5378d5)=>{const _0x3cfffe=a38_0x51914f,{pageNumber:_0x31f417,status:_0x3b6851,groups:_0x16e649,date:_0x426e50,updatedAt:_0x51d158,isSearch:_0x5a6228,searchParam:_0x96a9b5,showAll:_0x543470,queueIds:_0x547797,tags:_0x27fbeb,users:_0x2db156,withUnreadMessages:_0x2f0265,notClosed:_0x2c91ed,all:_0x57a6d6}=_0x5a2da8[_0x3cfffe(0x13f)],_0x206688=_0x5a2da8[_0x3cfffe(0x151)]['id'],{companyId:_0x27f2ac}=_0x5a2da8[_0x3cfffe(0x151)];let _0x54c698=[],_0x3bb687=[],_0x30b513=[];_0x547797&&(_0x54c698=JSON['parse'](_0x547797));_0x27fbeb&&(_0x3bb687=JSON[_0x3cfffe(0x156)](_0x27fbeb));_0x2db156&&(_0x30b513=JSON[_0x3cfffe(0x156)](_0x2db156));const {tickets:_0xc5296,count:_0x3de521,hasMore:_0x52a16f}=await(0x0,ListTicketsService_1[_0x3cfffe(0x153)])({'isSearch':_0x5a6228===_0x3cfffe(0x130),'searchParam':_0x96a9b5,'tags':_0x3bb687,'users':_0x30b513,'pageNumber':_0x31f417,'status':_0x3b6851,'groups':_0x16e649,'date':_0x426e50,'updatedAt':_0x51d158,'showAll':_0x543470,'userId':_0x206688,'queueIds':_0x54c698,'withUnreadMessages':_0x2f0265,'notClosed':!!_0x2c91ed,'all':!!_0x57a6d6,'companyId':_0x27f2ac});return _0x5378d5['status'](0xc8)['json']({'tickets':_0xc5296,'count':_0x3de521,'hasMore':_0x52a16f});};exports[a38_0x51914f(0x155)]=index;const kanban=async(_0x431259,_0x2fd6e2)=>{const _0x5a905e=a38_0x51914f,{pageNumber:_0x375b75,status:_0x190a91,date:_0x4f2867,updatedAt:_0x22bc6f,searchParam:_0x5ad18f,showAll:_0x3e403f,queueIds:_0x41d300,tags:_0x5b977e,users:_0x20f3b7,withUnreadMessages:_0x361a8f}=_0x431259[_0x5a905e(0x13f)],_0x287872=_0x431259[_0x5a905e(0x151)]['id'],{companyId:_0x18a501}=_0x431259[_0x5a905e(0x151)];let _0x1e7177=[],_0x119b57=[],_0x19580f=[];_0x41d300&&(_0x1e7177=JSON[_0x5a905e(0x156)](_0x41d300));_0x5b977e&&(_0x119b57=JSON[_0x5a905e(0x156)](_0x5b977e));_0x20f3b7&&(_0x19580f=JSON[_0x5a905e(0x156)](_0x20f3b7));const {tickets:_0x60b3fe,count:_0x2d1bf6,hasMore:_0x218955}=await(0x0,ListTicketsServiceKanban_1[_0x5a905e(0x153)])({'searchParam':_0x5ad18f,'tags':_0x119b57,'users':_0x19580f,'pageNumber':_0x375b75,'status':_0x190a91,'date':_0x4f2867,'updatedAt':_0x22bc6f,'showAll':_0x3e403f,'userId':_0x287872,'queueIds':_0x1e7177,'withUnreadMessages':_0x361a8f,'companyId':_0x18a501});return _0x2fd6e2[_0x5a905e(0x137)](0xc8)[_0x5a905e(0x159)]({'tickets':_0x60b3fe,'count':_0x2d1bf6,'hasMore':_0x218955});};exports[a38_0x51914f(0x12f)]=kanban;const findOpenTicketByContactId=async(_0x15571b,_0x2c007e)=>{const _0x40ca67=a38_0x51914f,_0x39c99f=await Ticket_1[_0x40ca67(0x153)]['findOne']({'where':{'contactId':_0x15571b,'companyId':_0x2c007e,'status':{[sequelize_1['Op']['or']]:[_0x40ca67(0x14a),_0x40ca67(0x14f)]}}});return _0x39c99f;};exports[a38_0x51914f(0x138)]=findOpenTicketByContactId;const store=async(_0x3087d1,_0x588d80)=>{const _0x216110=a38_0x51914f,{contactId:_0x52b768,userId:_0x5b707d,queueId:_0x1c060b}=_0x3087d1['body'],{companyId:_0x1992dc}=_0x3087d1[_0x216110(0x151)],_0x47b0b7=await(0x0,exports[_0x216110(0x138)])(_0x52b768,_0x1992dc);if(_0x47b0b7)return _0x588d80[_0x216110(0x137)](0xc8)[_0x216110(0x159)](_0x47b0b7);const _0x23aeda=await(0x0,CreateTicketService_1[_0x216110(0x153)])({'contactId':_0x52b768,'userId':_0x5b707d,'companyId':_0x1992dc,'queueId':_0x1c060b}),_0x16c5a2=(0x0,socket_1['getIO'])();return _0x16c5a2['to']('company-'+_0x1992dc+'-'+_0x23aeda['status'])['to'](_0x216110(0x148)+_0x23aeda[_0x216110(0x144)]+'-'+_0x23aeda['status'])[_0x216110(0x135)](_0x216110(0x15a)+_0x1992dc+_0x216110(0x15d),{'action':'update','ticket':_0x23aeda}),_0x588d80[_0x216110(0x137)](0xc8)[_0x216110(0x159)](_0x23aeda);};exports[a38_0x51914f(0x157)]=store;const show=async(_0x212d7c,_0x29989f)=>{const _0x36410e=a38_0x51914f,{ticketId:_0x541d35}=_0x212d7c[_0x36410e(0x12a)],{companyId:_0x5eed25}=_0x212d7c[_0x36410e(0x151)],_0x211b68=await(0x0,ShowTicketService_1[_0x36410e(0x153)])(_0x541d35,_0x5eed25);return _0x29989f[_0x36410e(0x137)](0xc8)['json'](_0x211b68);};exports[a38_0x51914f(0x13a)]=show;const showFromUUID=async(_0x5276c1,_0x51ce6d)=>{const _0x36a17b=a38_0x51914f,{uuid:_0x1f4dc7}=_0x5276c1['params'],_0x463d1c=await(0x0,ShowTicketFromUUIDService_1[_0x36a17b(0x153)])(_0x1f4dc7);return _0x51ce6d[_0x36a17b(0x137)](0xc8)[_0x36a17b(0x159)](_0x463d1c);};exports[a38_0x51914f(0x129)]=showFromUUID;function a38_0x7510(_0x2cd616,_0x56a12a){const _0x19431c=a38_0x478d();return a38_0x7510=function(_0x10bf3b,_0x4db1af){_0x10bf3b=_0x10bf3b-0x123;let _0x478d97=_0x19431c[_0x10bf3b];return _0x478d97;},a38_0x7510(_0x2cd616,_0x56a12a);}const closeAll=async(_0x5d9287,_0x15bffe)=>{const _0x1a3408=a38_0x51914f,{companyId:_0x522718}=_0x5d9287[_0x1a3408(0x151)];var _0x53a948=_0x5d9287[_0x1a3408(0x12c)]['status'],_0x21a159=await Ticket_1[_0x1a3408(0x153)][_0x1a3408(0x132)]({'where':{'companyId':_0x522718,'status':_0x53a948}});for(const _0x4aa505 of _0x21a159){(0x0,UpdateTicketService_1[_0x1a3408(0x153)])({'ticketData':{'status':_0x1a3408(0x145),'userId':_0x4aa505[_0x1a3408(0x131)]||null,'queueId':_0x4aa505['queueId']||null,'amountUsedBotQueues':0x0},'ticketId':_0x4aa505['id'],'companyId':_0x522718});}return _0x15bffe[_0x1a3408(0x137)](0xc8)[_0x1a3408(0x159)]({'message':_0x1a3408(0x133)});};exports['closeAll']=closeAll;const update=async(_0x2d13ae,_0x3572b3)=>{const _0x33c339=a38_0x51914f,{ticketId:_0x566685}=_0x2d13ae[_0x33c339(0x12a)],{ticket:_0x3cfe22}=await updateMutex['runExclusive'](async()=>{const _0x533f1a=_0x33c339,_0x502e68=await(0x0,UpdateTicketService_1['default'])({'ticketData':_0x2d13ae[_0x533f1a(0x12c)],'ticketId':Number[_0x533f1a(0x15e)](_0x566685,0xa),'tokenData':_0x2d13ae[_0x533f1a(0x149)]});return _0x502e68;});return _0x3572b3[_0x33c339(0x137)](0xc8)[_0x33c339(0x159)](_0x3cfe22);};exports[a38_0x51914f(0x14c)]=update;function a38_0x478d(){const _0x2065c9=['2808024GnfFtL','emit','(((.+)+)+)+$','status','findOpenTicketByContactId','getIO','show','../models/Ticket','remove','__importDefault','../services/TicketServices/ListTicketsServiceKanban','query','2171582skKguZ','-notification','../services/TicketServices/DeleteTicketService','1272608ASUDfv','queueId','closed','737683nDxkKK','__esModule','queue-','tokenData','open','../services/TicketServices/CreateTicketService','update','../services/TicketServices/ShowTicketService','defineProperty','pending','1810muBxeW','user','1625259JANkDS','default','constructor','index','parse','store','../services/TicketServices/UpdateTicketService','json','company-','search','299912HMteKW','-ticket','parseInt','../services/TicketServices/ShowTicketFromUUIDService','delete','2YImODR','sequelize','18855Iecmcc','toString','Mutex','../services/TicketServices/ListTicketsService','showFromUUID','params','closeAll','body','35NEavgr','apply','kanban','true','userId','findAll','all\x20tickets\x20closed'];a38_0x478d=function(){return _0x2065c9;};return a38_0x478d();}const remove=async(_0x302180,_0x324d89)=>{const _0x4ad372=a38_0x51914f,{ticketId:_0x609ca3}=_0x302180[_0x4ad372(0x12a)],{companyId:_0x9ffc8c}=_0x302180[_0x4ad372(0x151)];await(0x0,ShowTicketService_1['default'])(_0x609ca3,_0x9ffc8c);const _0x405b15=await(0x0,DeleteTicketService_1[_0x4ad372(0x153)])(_0x609ca3),_0x154716=(0x0,socket_1[_0x4ad372(0x139)])();return _0x154716['to'](_0x609ca3)['to'](_0x4ad372(0x15a)+_0x9ffc8c+'-'+_0x405b15['status'])['to']('company-'+_0x9ffc8c+_0x4ad372(0x141))['to'](_0x4ad372(0x148)+_0x405b15[_0x4ad372(0x144)]+'-'+_0x405b15[_0x4ad372(0x137)])['to'](_0x4ad372(0x148)+_0x405b15[_0x4ad372(0x144)]+_0x4ad372(0x141))[_0x4ad372(0x135)](_0x4ad372(0x15a)+_0x9ffc8c+_0x4ad372(0x15d),{'action':_0x4ad372(0x160),'ticketId':+_0x609ca3}),_0x324d89[_0x4ad372(0x137)](0xc8)[_0x4ad372(0x159)]({'message':'ticket\x20deleted'});};exports['remove']=remove;