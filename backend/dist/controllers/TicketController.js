const a47_0x552e15=a47_0x1204;(function(_0x5e654c,_0x4365b2){const _0x161f48=a47_0x1204,_0x411a0b=_0x5e654c();while(!![]){try{const _0x1acabc=-parseInt(_0x161f48(0x14a))/0x1+-parseInt(_0x161f48(0x137))/0x2+-parseInt(_0x161f48(0x15c))/0x3+parseInt(_0x161f48(0x160))/0x4*(parseInt(_0x161f48(0x154))/0x5)+-parseInt(_0x161f48(0x149))/0x6*(-parseInt(_0x161f48(0x13c))/0x7)+-parseInt(_0x161f48(0x164))/0x8*(-parseInt(_0x161f48(0x169))/0x9)+-parseInt(_0x161f48(0x156))/0xa*(-parseInt(_0x161f48(0x16d))/0xb);if(_0x1acabc===_0x4365b2)break;else _0x411a0b['push'](_0x411a0b['shift']());}catch(_0x469890){_0x411a0b['push'](_0x411a0b['shift']());}}}(a47_0x2208,0x41685));const a47_0x4f4e5c=(function(){let _0x2d4c37=!![];return function(_0x1ce3d6,_0x38f8bc){const _0x44f257=_0x2d4c37?function(){const _0x11a546=a47_0x1204;if(_0x38f8bc){const _0x31bab2=_0x38f8bc[_0x11a546(0x161)](_0x1ce3d6,arguments);return _0x38f8bc=null,_0x31bab2;}}:function(){};return _0x2d4c37=![],_0x44f257;};}()),a47_0x45959c=a47_0x4f4e5c(this,function(){const _0x2b0f9d=a47_0x1204;return a47_0x45959c[_0x2b0f9d(0x157)]()[_0x2b0f9d(0x170)](_0x2b0f9d(0x133))[_0x2b0f9d(0x157)]()[_0x2b0f9d(0x15a)](a47_0x45959c)[_0x2b0f9d(0x170)](_0x2b0f9d(0x133));});a47_0x45959c();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x576e48){const _0x543cec=a47_0x1204;return _0x576e48&&_0x576e48[_0x543cec(0x16f)]?_0x576e48:{'default':_0x576e48};};Object['defineProperty'](exports,a47_0x552e15(0x16f),{'value':!![]}),exports[a47_0x552e15(0x16e)]=exports[a47_0x552e15(0x15d)]=exports[a47_0x552e15(0x13e)]=exports[a47_0x552e15(0x148)]=exports['show']=exports[a47_0x552e15(0x155)]=exports[a47_0x552e15(0x150)]=exports[a47_0x552e15(0x146)]=exports[a47_0x552e15(0x134)]=void 0x0;const async_mutex_1=require('async-mutex'),socket_1=require('../libs/socket'),Ticket_1=__importDefault(require('../models/Ticket')),User_1=__importDefault(require('../models/User')),Queue_1=__importDefault(require(a47_0x552e15(0x14d))),sequelize_1=require(a47_0x552e15(0x172)),CreateTicketService_1=__importDefault(require(a47_0x552e15(0x159))),DeleteTicketService_1=__importDefault(require(a47_0x552e15(0x162))),ListTicketsService_1=__importDefault(require(a47_0x552e15(0x14e))),ShowTicketFromUUIDService_1=__importDefault(require(a47_0x552e15(0x13f))),ShowTicketService_1=__importDefault(require(a47_0x552e15(0x14f))),UpdateTicketService_1=__importDefault(require(a47_0x552e15(0x147))),ListTicketsServiceKanban_1=__importDefault(require(a47_0x552e15(0x14c))),updateMutex=new async_mutex_1[(a47_0x552e15(0x15f))](),index=async(_0x48e20e,_0x14ac82)=>{const _0xf745e3=a47_0x552e15,{pageNumber:_0x2ff85a,status:_0x500de8,groups:_0x2b529d,date:_0x570c41,updatedAt:_0x98db3a,isSearch:_0x24dbfc,searchParam:_0x4c9cb,showAll:_0x323cb4,queueIds:_0x2f6d07,tags:_0x2f9564,users:_0x2021ca,withUnreadMessages:_0x2d9bb4,notClosed:_0x2b44f3,all:_0x18ae88}=_0x48e20e['query'],_0x3e8ba4=_0x48e20e[_0xf745e3(0x15b)]['id'],{companyId:_0x2e5d66}=_0x48e20e['user'];let _0x4f26c2=[],_0x30c56f=[],_0x4e0815=[];_0x2f6d07&&(_0x4f26c2=JSON[_0xf745e3(0x138)](_0x2f6d07));_0x2f9564&&(_0x30c56f=JSON[_0xf745e3(0x138)](_0x2f9564));_0x2021ca&&(_0x4e0815=JSON['parse'](_0x2021ca));if(!_0x2f6d07){const _0x50ad22=await User_1[_0xf745e3(0x130)]['findByPk'](_0x3e8ba4,{'include':[{'model':Queue_1[_0xf745e3(0x130)],'as':_0xf745e3(0x173),'attributes':['id']}]});_0x50ad22&&_0x50ad22[_0xf745e3(0x173)]&&(_0x4f26c2=_0x50ad22[_0xf745e3(0x173)]['map'](_0x45f0e6=>_0x45f0e6['id']));}const {tickets:_0x3c4d13,count:_0x2752e1,hasMore:_0x3cb22b}=await(0x0,ListTicketsService_1[_0xf745e3(0x130)])({'isSearch':_0x24dbfc===_0xf745e3(0x143),'searchParam':_0x4c9cb,'tags':_0x30c56f,'users':_0x4e0815,'pageNumber':_0x2ff85a,'status':_0x500de8,'groups':_0x2b529d,'date':_0x570c41,'updatedAt':_0x98db3a,'showAll':_0x323cb4,'userId':_0x3e8ba4,'queueIds':_0x4f26c2,'withUnreadMessages':_0x2d9bb4,'notClosed':!!_0x2b44f3,'all':!!_0x18ae88,'companyId':_0x2e5d66});return _0x14ac82[_0xf745e3(0x132)](0xc8)[_0xf745e3(0x16b)]({'tickets':_0x3c4d13,'count':_0x2752e1,'hasMore':_0x3cb22b});};exports[a47_0x552e15(0x134)]=index;const kanban=async(_0x40385b,_0x45a7c1)=>{const _0x217658=a47_0x552e15,{pageNumber:_0x34d983,status:_0x13ca6a,date:_0x318beb,updatedAt:_0x15645a,searchParam:_0x579e20,showAll:_0x45927f,queueIds:_0xfa6611,tags:_0x1c625b,users:_0x2fba55,withUnreadMessages:_0x5d865c}=_0x40385b[_0x217658(0x165)],_0x5d658f=_0x40385b[_0x217658(0x15b)]['id'],{companyId:_0x4e3860}=_0x40385b[_0x217658(0x15b)];let _0x4ed9d3=[],_0x40682c=[],_0x37d958=[];_0xfa6611&&(_0x4ed9d3=JSON[_0x217658(0x138)](_0xfa6611));_0x1c625b&&(_0x40682c=JSON[_0x217658(0x138)](_0x1c625b));_0x2fba55&&(_0x37d958=JSON[_0x217658(0x138)](_0x2fba55));if(!_0xfa6611){const _0x4e1786=await User_1[_0x217658(0x130)][_0x217658(0x168)](_0x5d658f,{'include':[{'model':Queue_1[_0x217658(0x130)],'as':_0x217658(0x173),'attributes':['id']}]});_0x4e1786&&_0x4e1786[_0x217658(0x173)]&&(_0x4ed9d3=_0x4e1786[_0x217658(0x173)][_0x217658(0x141)](_0x34d769=>_0x34d769['id']));}const {tickets:_0x2e5b9b,count:_0x2d46bc,hasMore:_0x258852}=await(0x0,ListTicketsServiceKanban_1[_0x217658(0x130)])({'searchParam':_0x579e20,'tags':_0x40682c,'users':_0x37d958,'pageNumber':_0x34d983,'status':_0x13ca6a,'date':_0x318beb,'updatedAt':_0x15645a,'showAll':_0x45927f,'userId':_0x5d658f,'queueIds':_0x4ed9d3,'withUnreadMessages':_0x5d865c,'companyId':_0x4e3860});return _0x45a7c1[_0x217658(0x132)](0xc8)[_0x217658(0x16b)]({'tickets':_0x2e5b9b,'count':_0x2d46bc,'hasMore':_0x258852});};exports[a47_0x552e15(0x146)]=kanban;function a47_0x2208(){const _0x493d76=['1434942SBUADv','update','company-','Mutex','1356508YNuvoS','apply','../services/TicketServices/DeleteTicketService','runExclusive','670216cEglLK','query','-notification','pending','findByPk','54jVpDNm','queueId','json','ticket\x20deleted','55066IizWME','remove','__esModule','search','body','sequelize','queues','default','tokenData','status','(((.+)+)+)+$','index','delete','userId','757256DpXedJ','parse','emit','queue-','parseInt','7okcKUs','params','closeAll','../services/TicketServices/ShowTicketFromUUIDService','permissions','map','closed','true','open','getIO','kanban','../services/TicketServices/UpdateTicketService','showFromUUID','168066CzrlBK','400735ltTOEE','canSpyConversations','../services/TicketServices/ListTicketsServiceKanban','../models/Queue','../services/TicketServices/ListTicketsService','../services/TicketServices/ShowTicketService','findOpenTicketByContactId','findOne','findAll','-ticket','5MyghwI','store','1310cZpeBI','toString','all\x20tickets\x20closed','../services/TicketServices/CreateTicketService','constructor','user'];a47_0x2208=function(){return _0x493d76;};return a47_0x2208();}const findOpenTicketByContactId=async(_0x4323fd,_0x269c21)=>{const _0x286146=a47_0x552e15,_0x3a7d95=await Ticket_1['default'][_0x286146(0x151)]({'where':{'contactId':_0x4323fd,'companyId':_0x269c21,'status':{[sequelize_1['Op']['or']]:[_0x286146(0x144),_0x286146(0x167)]}}});return _0x3a7d95;};exports[a47_0x552e15(0x150)]=findOpenTicketByContactId;function a47_0x1204(_0x4c64b8,_0x408097){const _0x1a1748=a47_0x2208();return a47_0x1204=function(_0x45959c,_0x4f4e5c){_0x45959c=_0x45959c-0x130;let _0x220843=_0x1a1748[_0x45959c];return _0x220843;},a47_0x1204(_0x4c64b8,_0x408097);}const store=async(_0x2ee153,_0x3a7a7e)=>{const _0x5473c7=a47_0x552e15,{contactId:_0x33d6e5,userId:_0x3c63aa,queueId:_0x547da9}=_0x2ee153[_0x5473c7(0x171)],{companyId:_0x2fde28}=_0x2ee153[_0x5473c7(0x15b)],_0x2370ad=await(0x0,exports[_0x5473c7(0x150)])(_0x33d6e5,_0x2fde28);if(_0x2370ad)return _0x3a7a7e[_0x5473c7(0x132)](0xc8)[_0x5473c7(0x16b)](_0x2370ad);const _0x25b687=await(0x0,CreateTicketService_1[_0x5473c7(0x130)])({'contactId':_0x33d6e5,'userId':_0x3c63aa,'companyId':_0x2fde28,'queueId':_0x547da9}),_0x4ac0d2=(0x0,socket_1[_0x5473c7(0x145)])();return _0x4ac0d2['to'](_0x5473c7(0x15e)+_0x2fde28+'-'+_0x25b687[_0x5473c7(0x132)])['to'](_0x5473c7(0x13a)+_0x25b687[_0x5473c7(0x16a)]+'-'+_0x25b687[_0x5473c7(0x132)])[_0x5473c7(0x139)](_0x5473c7(0x15e)+_0x2fde28+_0x5473c7(0x153),{'action':_0x5473c7(0x15d),'ticket':_0x25b687}),_0x3a7a7e[_0x5473c7(0x132)](0xc8)[_0x5473c7(0x16b)](_0x25b687);};exports[a47_0x552e15(0x155)]=store;const show=async(_0x3621e0,_0x9b03c0)=>{const _0x49e699=a47_0x552e15,{ticketId:_0x148049}=_0x3621e0[_0x49e699(0x13d)],{companyId:_0x181fe2,id:_0x1b7278,profile:_0x2185ad}=_0x3621e0[_0x49e699(0x15b)],_0x45075e=parseInt(_0x1b7278),_0x414d4e=_0x3621e0[_0x49e699(0x15b)][_0x49e699(0x140)]?.[_0x49e699(0x14b)]||![],_0x4588d6=await(0x0,ShowTicketService_1[_0x49e699(0x130)])({'id':_0x148049,'companyId':_0x181fe2,'userId':_0x45075e,'userProfile':_0x2185ad,'canSpyConversations':_0x414d4e});return _0x9b03c0[_0x49e699(0x132)](0xc8)[_0x49e699(0x16b)](_0x4588d6);};exports['show']=show;const showFromUUID=async(_0x3c53d8,_0x31959f)=>{const _0x3e632a=a47_0x552e15,{uuid:_0x4d9d07}=_0x3c53d8[_0x3e632a(0x13d)],_0x4c4a7a=await(0x0,ShowTicketFromUUIDService_1['default'])(_0x4d9d07);return _0x31959f[_0x3e632a(0x132)](0xc8)[_0x3e632a(0x16b)](_0x4c4a7a);};exports['showFromUUID']=showFromUUID;const closeAll=async(_0x5301d7,_0x33c080)=>{const _0x4fccd4=a47_0x552e15,{companyId:_0x4a8323}=_0x5301d7['user'];var _0xbbb64f=_0x5301d7[_0x4fccd4(0x171)][_0x4fccd4(0x132)],_0x39e47d=await Ticket_1['default'][_0x4fccd4(0x152)]({'where':{'companyId':_0x4a8323,'status':_0xbbb64f}});for(const _0x231c79 of _0x39e47d){(0x0,UpdateTicketService_1[_0x4fccd4(0x130)])({'ticketData':{'status':_0x4fccd4(0x142),'userId':_0x231c79[_0x4fccd4(0x136)]||null,'queueId':_0x231c79[_0x4fccd4(0x16a)]||null,'amountUsedBotQueues':0x0},'ticketId':_0x231c79['id'],'companyId':_0x4a8323});}return _0x33c080[_0x4fccd4(0x132)](0xc8)[_0x4fccd4(0x16b)]({'message':_0x4fccd4(0x158)});};exports[a47_0x552e15(0x13e)]=closeAll;const update=async(_0x555f93,_0x4afead)=>{const _0xa25708=a47_0x552e15,{ticketId:_0x49af18}=_0x555f93['params'],{ticket:_0x27cec2}=await updateMutex[_0xa25708(0x163)](async()=>{const _0xf73017=_0xa25708,_0x21f565=await(0x0,UpdateTicketService_1['default'])({'ticketData':_0x555f93['body'],'ticketId':Number[_0xf73017(0x13b)](_0x49af18,0xa),'tokenData':_0x555f93[_0xf73017(0x131)]});return _0x21f565;});return _0x4afead[_0xa25708(0x132)](0xc8)[_0xa25708(0x16b)](_0x27cec2);};exports['update']=update;const remove=async(_0x1de460,_0x2835a8)=>{const _0x372d84=a47_0x552e15,{ticketId:_0x3ab2d2}=_0x1de460[_0x372d84(0x13d)],{companyId:_0xe71520}=_0x1de460[_0x372d84(0x15b)];await(0x0,ShowTicketService_1[_0x372d84(0x130)])(_0x3ab2d2,_0xe71520);const _0x1bb674=await(0x0,DeleteTicketService_1[_0x372d84(0x130)])(_0x3ab2d2),_0x33a066=(0x0,socket_1[_0x372d84(0x145)])();return _0x33a066['to'](_0x3ab2d2)['to'](_0x372d84(0x15e)+_0xe71520+'-'+_0x1bb674[_0x372d84(0x132)])['to'](_0x372d84(0x15e)+_0xe71520+'-notification')['to'](_0x372d84(0x13a)+_0x1bb674['queueId']+'-'+_0x1bb674[_0x372d84(0x132)])['to'](_0x372d84(0x13a)+_0x1bb674['queueId']+_0x372d84(0x166))[_0x372d84(0x139)](_0x372d84(0x15e)+_0xe71520+_0x372d84(0x153),{'action':_0x372d84(0x135),'ticketId':+_0x3ab2d2}),_0x2835a8[_0x372d84(0x132)](0xc8)[_0x372d84(0x16b)]({'message':_0x372d84(0x16c)});};exports['remove']=remove;