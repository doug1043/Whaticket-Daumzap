const a47_0x1abf49=a47_0x4d00;(function(_0x3d21ea,_0x367e6e){const _0x281040=a47_0x4d00,_0x55a86e=_0x3d21ea();while(!![]){try{const _0x380002=parseInt(_0x281040(0x1ed))/0x1+parseInt(_0x281040(0x1f9))/0x2*(-parseInt(_0x281040(0x1ff))/0x3)+-parseInt(_0x281040(0x1ec))/0x4*(parseInt(_0x281040(0x21a))/0x5)+parseInt(_0x281040(0x204))/0x6*(parseInt(_0x281040(0x214))/0x7)+-parseInt(_0x281040(0x221))/0x8+parseInt(_0x281040(0x22c))/0x9+-parseInt(_0x281040(0x1f2))/0xa;if(_0x380002===_0x367e6e)break;else _0x55a86e['push'](_0x55a86e['shift']());}catch(_0x48e467){_0x55a86e['push'](_0x55a86e['shift']());}}}(a47_0x57ad,0x62e14));const a47_0xe408be=(function(){let _0x3712d0=!![];return function(_0x7e999c,_0x27c09b){const _0x1efca1=_0x3712d0?function(){const _0x436f89=a47_0x4d00;if(_0x27c09b){const _0x211b9e=_0x27c09b[_0x436f89(0x219)](_0x7e999c,arguments);return _0x27c09b=null,_0x211b9e;}}:function(){};return _0x3712d0=![],_0x1efca1;};}()),a47_0x4775ce=a47_0xe408be(this,function(){const _0x13ede0=a47_0x4d00;return a47_0x4775ce[_0x13ede0(0x202)]()['search'](_0x13ede0(0x20f))['toString']()[_0x13ede0(0x217)](a47_0x4775ce)[_0x13ede0(0x1f3)](_0x13ede0(0x20f));});a47_0x4775ce();'use strict';var __importDefault=this&&this[a47_0x1abf49(0x209)]||function(_0x256920){const _0x5989ad=a47_0x1abf49;return _0x256920&&_0x256920[_0x5989ad(0x20e)]?_0x256920:{'default':_0x256920};};Object[a47_0x1abf49(0x225)](exports,a47_0x1abf49(0x20e),{'value':!![]}),exports[a47_0x1abf49(0x212)]=exports[a47_0x1abf49(0x1e9)]=exports[a47_0x1abf49(0x207)]=exports['showFromUUID']=exports['show']=exports['store']=exports['findOpenTicketByContactId']=exports[a47_0x1abf49(0x222)]=exports[a47_0x1abf49(0x1fb)]=void 0x0;const async_mutex_1=require(a47_0x1abf49(0x1f0)),socket_1=require(a47_0x1abf49(0x203)),Ticket_1=__importDefault(require(a47_0x1abf49(0x1fa))),User_1=__importDefault(require(a47_0x1abf49(0x201))),Queue_1=__importDefault(require(a47_0x1abf49(0x229))),sequelize_1=require('sequelize'),CreateTicketService_1=__importDefault(require('../services/TicketServices/CreateTicketService')),DeleteTicketService_1=__importDefault(require(a47_0x1abf49(0x1ea))),ListTicketsService_1=__importDefault(require(a47_0x1abf49(0x1fd))),ShowTicketFromUUIDService_1=__importDefault(require('../services/TicketServices/ShowTicketFromUUIDService')),ShowTicketService_1=__importDefault(require(a47_0x1abf49(0x20b))),UpdateTicketService_1=__importDefault(require(a47_0x1abf49(0x20d))),ListTicketsServiceKanban_1=__importDefault(require(a47_0x1abf49(0x21e))),updateMutex=new async_mutex_1[(a47_0x1abf49(0x20c))](),index=async(_0x3fd151,_0x49acd3)=>{const _0x2358e3=a47_0x1abf49,{pageNumber:_0x7bad3e,status:_0x37fa2a,groups:_0x377c0b,date:_0x515c3c,updatedAt:_0x104561,isSearch:_0x460121,searchParam:_0x697111,showAll:_0x14ccd2,queueIds:_0x3e9321,tags:_0x25ade7,users:_0x2921dc,withUnreadMessages:_0x2e0da0,notClosed:_0x44d3f4,all:_0x758bba}=_0x3fd151[_0x2358e3(0x21f)],_0x4a58c6=_0x3fd151[_0x2358e3(0x22a)]['id'],{companyId:_0x2912f6}=_0x3fd151[_0x2358e3(0x22a)];let _0x4fc00f=[],_0x3dd81b=[],_0x575170=[];_0x3e9321&&(_0x4fc00f=JSON[_0x2358e3(0x223)](_0x3e9321));_0x25ade7&&(_0x3dd81b=JSON[_0x2358e3(0x223)](_0x25ade7));_0x2921dc&&(_0x575170=JSON[_0x2358e3(0x223)](_0x2921dc));if(!_0x3e9321){const _0x46b610=await User_1['default']['findByPk'](_0x4a58c6,{'include':[{'model':Queue_1[_0x2358e3(0x21d)],'as':_0x2358e3(0x200),'attributes':['id']}]});_0x46b610&&_0x46b610['queues']&&(_0x4fc00f=_0x46b610[_0x2358e3(0x200)]['map'](_0x5670fb=>_0x5670fb['id']));}const {tickets:_0x10e2a6,count:_0x5ce4f6,hasMore:_0xfe1675}=await(0x0,ListTicketsService_1['default'])({'isSearch':_0x460121===_0x2358e3(0x206),'searchParam':_0x697111,'tags':_0x3dd81b,'users':_0x575170,'pageNumber':_0x7bad3e,'status':_0x37fa2a,'groups':_0x377c0b,'date':_0x515c3c,'updatedAt':_0x104561,'showAll':_0x14ccd2,'userId':_0x4a58c6,'queueIds':_0x4fc00f,'withUnreadMessages':_0x2e0da0,'notClosed':!!_0x44d3f4,'all':!!_0x758bba,'companyId':_0x2912f6});return _0x49acd3['status'](0xc8)['json']({'tickets':_0x10e2a6,'count':_0x5ce4f6,'hasMore':_0xfe1675});};exports['index']=index;const kanban=async(_0x4c28ef,_0x11445a)=>{const _0x46100a=a47_0x1abf49,{pageNumber:_0x160b91,status:_0x5ec3fb,date:_0x546274,updatedAt:_0x1680ce,searchParam:_0x3650cc,showAll:_0x798b00,queueIds:_0x2cf809,tags:_0x5ecff8,users:_0x3aaec1,withUnreadMessages:_0x143c8e}=_0x4c28ef[_0x46100a(0x21f)],_0x45067b=_0x4c28ef[_0x46100a(0x22a)]['id'],{companyId:_0x49bbca}=_0x4c28ef[_0x46100a(0x22a)];let _0x4fe9cb=[],_0x3574f1=[],_0x43b327=[];_0x2cf809&&(_0x4fe9cb=JSON[_0x46100a(0x223)](_0x2cf809));_0x5ecff8&&(_0x3574f1=JSON[_0x46100a(0x223)](_0x5ecff8));_0x3aaec1&&(_0x43b327=JSON[_0x46100a(0x223)](_0x3aaec1));if(!_0x2cf809){const _0x3567a9=await User_1[_0x46100a(0x21d)][_0x46100a(0x210)](_0x45067b,{'include':[{'model':Queue_1[_0x46100a(0x21d)],'as':_0x46100a(0x200),'attributes':['id']}]});_0x3567a9&&_0x3567a9['queues']&&(_0x4fe9cb=_0x3567a9['queues'][_0x46100a(0x1f4)](_0x472f55=>_0x472f55['id']));}const {tickets:_0x470474,count:_0x886d08,hasMore:_0xafe7ed}=await(0x0,ListTicketsServiceKanban_1['default'])({'searchParam':_0x3650cc,'tags':_0x3574f1,'users':_0x43b327,'pageNumber':_0x160b91,'status':_0x5ec3fb,'date':_0x546274,'updatedAt':_0x1680ce,'showAll':_0x798b00,'userId':_0x45067b,'queueIds':_0x4fe9cb,'withUnreadMessages':_0x143c8e,'companyId':_0x49bbca});return _0x11445a[_0x46100a(0x1ee)](0xc8)[_0x46100a(0x220)]({'tickets':_0x470474,'count':_0x886d08,'hasMore':_0xafe7ed});};exports['kanban']=kanban;const findOpenTicketByContactId=async(_0x4c92a9,_0x475be7)=>{const _0x46f89d=a47_0x1abf49,_0x188a10=await Ticket_1['default'][_0x46f89d(0x208)]({'where':{'contactId':_0x4c92a9,'companyId':_0x475be7,'status':{[sequelize_1['Op']['or']]:[_0x46f89d(0x1f5),_0x46f89d(0x227)]}}});return _0x188a10;};exports[a47_0x1abf49(0x228)]=findOpenTicketByContactId;const store=async(_0x7521bf,_0x219ee1)=>{const _0x56e46f=a47_0x1abf49,{contactId:_0xf5ca1a,userId:_0x2e6c22,queueId:_0xa70c4d}=_0x7521bf[_0x56e46f(0x1e7)],{companyId:_0x3d781e}=_0x7521bf[_0x56e46f(0x22a)],_0x59a087=await(0x0,exports['findOpenTicketByContactId'])(_0xf5ca1a,_0x3d781e);if(_0x59a087)return _0x219ee1[_0x56e46f(0x1ee)](0xc8)[_0x56e46f(0x220)](_0x59a087);const _0x512209=await(0x0,CreateTicketService_1[_0x56e46f(0x21d)])({'contactId':_0xf5ca1a,'userId':_0x2e6c22,'companyId':_0x3d781e,'queueId':_0xa70c4d}),_0x1561a7=(0x0,socket_1[_0x56e46f(0x1f7)])();return _0x1561a7['to']('company-'+_0x3d781e+'-'+_0x512209[_0x56e46f(0x1ee)])['to'](_0x56e46f(0x21b)+_0x512209[_0x56e46f(0x1eb)]+'-'+_0x512209[_0x56e46f(0x1ee)])['emit'](_0x56e46f(0x21c)+_0x3d781e+'-ticket',{'action':_0x56e46f(0x1e9),'ticket':_0x512209}),_0x219ee1[_0x56e46f(0x1ee)](0xc8)[_0x56e46f(0x220)](_0x512209);};exports[a47_0x1abf49(0x226)]=store;function a47_0x4d00(_0x3de5e7,_0x11b2ba){const _0x1d811c=a47_0x57ad();return a47_0x4d00=function(_0x4775ce,_0xe408be){_0x4775ce=_0x4775ce-0x1e7;let _0x57ad3d=_0x1d811c[_0x4775ce];return _0x57ad3d;},a47_0x4d00(_0x3de5e7,_0x11b2ba);}const show=async(_0x38a7fe,_0xb5693a)=>{const _0x4c2f39=a47_0x1abf49,{ticketId:_0x2d65e9}=_0x38a7fe[_0x4c2f39(0x20a)],{companyId:_0x4c9457,id:_0x53167b,profile:_0x2cf5a4}=_0x38a7fe[_0x4c2f39(0x22a)],_0x28a70c=parseInt(_0x53167b),_0x4d00eb=_0x38a7fe[_0x4c2f39(0x22a)][_0x4c2f39(0x1fc)]?.[_0x4c2f39(0x1f8)]||![],_0x21eecb=await(0x0,ShowTicketService_1[_0x4c2f39(0x21d)])({'id':_0x2d65e9,'companyId':_0x4c9457,'userId':_0x28a70c,'userProfile':_0x2cf5a4,'canSpyConversations':_0x4d00eb});return _0xb5693a['status'](0xc8)[_0x4c2f39(0x220)](_0x21eecb);};exports[a47_0x1abf49(0x22b)]=show;const showFromUUID=async(_0x42e8fe,_0x9d5294)=>{const _0x4e7325=a47_0x1abf49,{uuid:_0x5c1852}=_0x42e8fe['params'],_0x43e50e=await(0x0,ShowTicketFromUUIDService_1[_0x4e7325(0x21d)])(_0x5c1852);return _0x9d5294[_0x4e7325(0x1ee)](0xc8)[_0x4e7325(0x220)](_0x43e50e);};exports[a47_0x1abf49(0x1f1)]=showFromUUID;const closeAll=async(_0x4af9e3,_0x4dd5bd)=>{const _0x5ed74b=a47_0x1abf49,{companyId:_0x32dd43}=_0x4af9e3[_0x5ed74b(0x22a)];var _0x1b4ef5=_0x4af9e3[_0x5ed74b(0x1e7)][_0x5ed74b(0x1ee)],_0xb7c1d7=await Ticket_1[_0x5ed74b(0x21d)][_0x5ed74b(0x1fe)]({'where':{'companyId':_0x32dd43,'status':_0x1b4ef5}});for(const _0x1e9227 of _0xb7c1d7){(0x0,UpdateTicketService_1['default'])({'ticketData':{'status':_0x5ed74b(0x213),'userId':_0x1e9227[_0x5ed74b(0x224)]||null,'queueId':_0x1e9227[_0x5ed74b(0x1eb)]||null,'amountUsedBotQueues':0x0},'ticketId':_0x1e9227['id'],'companyId':_0x32dd43});}return _0x4dd5bd[_0x5ed74b(0x1ee)](0xc8)[_0x5ed74b(0x220)]({'message':'all\x20tickets\x20closed'});};function a47_0x57ad(){const _0x2d4240=['Mutex','../services/TicketServices/UpdateTicketService','__esModule','(((.+)+)+)+$','findByPk','-ticket','remove','closed','21nrwWlw','delete','runExclusive','constructor','-notification','apply','497810nDvuwB','queue-','company-','default','../services/TicketServices/ListTicketsServiceKanban','query','json','196904QlzXmQ','kanban','parse','userId','defineProperty','store','pending','findOpenTicketByContactId','../models/Queue','user','show','4876029zHVQyu','body','emit','update','../services/TicketServices/DeleteTicketService','queueId','20LCFSNE','589445mRhIvB','status','ticket\x20deleted','async-mutex','showFromUUID','1880050WKexte','search','map','open','tokenData','getIO','canSpyConversations','1167594ZyBiyV','../models/Ticket','index','permissions','../services/TicketServices/ListTicketsService','findAll','3wEUrTg','queues','../models/User','toString','../libs/socket','1136022RjKSOT','parseInt','true','closeAll','findOne','__importDefault','params','../services/TicketServices/ShowTicketService'];a47_0x57ad=function(){return _0x2d4240;};return a47_0x57ad();}exports[a47_0x1abf49(0x207)]=closeAll;const update=async(_0x57f07a,_0x34a0b8)=>{const _0x1a9240=a47_0x1abf49,{ticketId:_0x2e371f}=_0x57f07a['params'],{ticket:_0xcd7ab7}=await updateMutex[_0x1a9240(0x216)](async()=>{const _0x5b1390=_0x1a9240,_0x5828fc=await(0x0,UpdateTicketService_1[_0x5b1390(0x21d)])({'ticketData':_0x57f07a['body'],'ticketId':Number[_0x5b1390(0x205)](_0x2e371f,0xa),'tokenData':_0x57f07a[_0x5b1390(0x1f6)]});return _0x5828fc;});return _0x34a0b8[_0x1a9240(0x1ee)](0xc8)['json'](_0xcd7ab7);};exports[a47_0x1abf49(0x1e9)]=update;const remove=async(_0xf538bf,_0x33a67f)=>{const _0x1fbb0d=a47_0x1abf49,{ticketId:_0x5b1626}=_0xf538bf['params'],{companyId:_0xc22e4e}=_0xf538bf['user'];await(0x0,ShowTicketService_1[_0x1fbb0d(0x21d)])(_0x5b1626,_0xc22e4e);const _0x131d79=await(0x0,DeleteTicketService_1[_0x1fbb0d(0x21d)])(_0x5b1626),_0x217b8d=(0x0,socket_1[_0x1fbb0d(0x1f7)])();return _0x217b8d['to'](_0x5b1626)['to'](_0x1fbb0d(0x21c)+_0xc22e4e+'-'+_0x131d79['status'])['to']('company-'+_0xc22e4e+_0x1fbb0d(0x218))['to']('queue-'+_0x131d79[_0x1fbb0d(0x1eb)]+'-'+_0x131d79['status'])['to'](_0x1fbb0d(0x21b)+_0x131d79[_0x1fbb0d(0x1eb)]+_0x1fbb0d(0x218))[_0x1fbb0d(0x1e8)]('company-'+_0xc22e4e+_0x1fbb0d(0x211),{'action':_0x1fbb0d(0x215),'ticketId':+_0x5b1626}),_0x33a67f['status'](0xc8)['json']({'message':_0x1fbb0d(0x1ef)});};exports[a47_0x1abf49(0x212)]=remove;