const a47_0x49ab4d=a47_0x95ed;(function(_0x3473ba,_0x5a4cb7){const _0x345079=a47_0x95ed,_0x43c214=_0x3473ba();while(!![]){try{const _0x3a970c=parseInt(_0x345079(0xb7))/0x1*(-parseInt(_0x345079(0xb6))/0x2)+-parseInt(_0x345079(0xb5))/0x3+-parseInt(_0x345079(0xa1))/0x4+parseInt(_0x345079(0x8f))/0x5+parseInt(_0x345079(0x9b))/0x6*(-parseInt(_0x345079(0x84))/0x7)+parseInt(_0x345079(0x86))/0x8+parseInt(_0x345079(0xb9))/0x9*(parseInt(_0x345079(0x87))/0xa);if(_0x3a970c===_0x5a4cb7)break;else _0x43c214['push'](_0x43c214['shift']());}catch(_0xe88adb){_0x43c214['push'](_0x43c214['shift']());}}}(a47_0x3bf1,0x18bc6));const a47_0x3855cb=(function(){let _0xcf5df6=!![];return function(_0x889db7,_0x56b958){const _0x20bc2e=_0xcf5df6?function(){if(_0x56b958){const _0x26bd6d=_0x56b958['apply'](_0x889db7,arguments);return _0x56b958=null,_0x26bd6d;}}:function(){};return _0xcf5df6=![],_0x20bc2e;};}()),a47_0xaa4e2b=a47_0x3855cb(this,function(){const _0x3b764a=a47_0x95ed;return a47_0xaa4e2b[_0x3b764a(0xa7)]()[_0x3b764a(0xb1)](_0x3b764a(0x85))[_0x3b764a(0xa7)]()[_0x3b764a(0xa9)](a47_0xaa4e2b)[_0x3b764a(0xb1)](_0x3b764a(0x85));});a47_0xaa4e2b();'use strict';var __importDefault=this&&this[a47_0x49ab4d(0x9d)]||function(_0x1f6a76){const _0x284317=a47_0x49ab4d;return _0x1f6a76&&_0x1f6a76[_0x284317(0xb4)]?_0x1f6a76:{'default':_0x1f6a76};};Object['defineProperty'](exports,a47_0x49ab4d(0xb4),{'value':!![]}),exports[a47_0x49ab4d(0x9e)]=exports['update']=exports[a47_0x49ab4d(0x8b)]=exports['showFromUUID']=exports['show']=exports['store']=exports['findOpenTicketByContactId']=exports[a47_0x49ab4d(0x8d)]=exports['index']=void 0x0;const async_mutex_1=require(a47_0x49ab4d(0xa2)),socket_1=require('../libs/socket'),Ticket_1=__importDefault(require(a47_0x49ab4d(0xae))),User_1=__importDefault(require(a47_0x49ab4d(0x95))),Queue_1=__importDefault(require(a47_0x49ab4d(0x92))),sequelize_1=require('sequelize'),CreateTicketService_1=__importDefault(require('../services/TicketServices/CreateTicketService')),DeleteTicketService_1=__importDefault(require(a47_0x49ab4d(0x90))),ListTicketsService_1=__importDefault(require(a47_0x49ab4d(0xad))),ShowTicketFromUUIDService_1=__importDefault(require(a47_0x49ab4d(0x93))),ShowTicketService_1=__importDefault(require(a47_0x49ab4d(0x9f))),UpdateTicketService_1=__importDefault(require(a47_0x49ab4d(0x9a))),ListTicketsServiceKanban_1=__importDefault(require(a47_0x49ab4d(0xbd))),updateMutex=new async_mutex_1[(a47_0x49ab4d(0xb2))](),index=async(_0x5183a1,_0xae7046)=>{const _0x1f8690=a47_0x49ab4d,{pageNumber:_0x21b037,status:_0x50f88b,groups:_0x342514,date:_0x52de30,updatedAt:_0x4e9b45,isSearch:_0x558ade,searchParam:_0x2c4f52,showAll:_0x37faf9,queueIds:_0x1e5261,tags:_0xa478c4,users:_0xc9d015,withUnreadMessages:_0x2777a8,notClosed:_0x4e2ff8,all:_0x4f53af}=_0x5183a1[_0x1f8690(0x91)],_0x11bddc=_0x5183a1[_0x1f8690(0xb8)]['id'],{companyId:_0xba3a3b}=_0x5183a1[_0x1f8690(0xb8)];let _0x447fbe=[],_0x3f9bd5=[],_0x72a121=[];_0x1e5261&&(_0x447fbe=JSON[_0x1f8690(0x9c)](_0x1e5261));_0xa478c4&&(_0x3f9bd5=JSON[_0x1f8690(0x9c)](_0xa478c4));_0xc9d015&&(_0x72a121=JSON[_0x1f8690(0x9c)](_0xc9d015));if(!_0x1e5261){const _0x4922ad=await User_1[_0x1f8690(0x8a)][_0x1f8690(0xaa)](_0x11bddc,{'include':[{'model':Queue_1[_0x1f8690(0x8a)],'as':_0x1f8690(0x99),'attributes':['id']}]});_0x4922ad&&_0x4922ad[_0x1f8690(0x99)]&&(_0x447fbe=_0x4922ad[_0x1f8690(0x99)][_0x1f8690(0x94)](_0x2cc856=>_0x2cc856['id']));}const {tickets:_0x48fb3e,count:_0x5887be,hasMore:_0xff2b37}=await(0x0,ListTicketsService_1[_0x1f8690(0x8a)])({'isSearch':_0x558ade===_0x1f8690(0x88),'searchParam':_0x2c4f52,'tags':_0x3f9bd5,'users':_0x72a121,'pageNumber':_0x21b037,'status':_0x50f88b,'groups':_0x342514,'date':_0x52de30,'updatedAt':_0x4e9b45,'showAll':_0x37faf9,'userId':_0x11bddc,'queueIds':_0x447fbe,'withUnreadMessages':_0x2777a8,'notClosed':!!_0x4e2ff8,'all':!!_0x4f53af,'companyId':_0xba3a3b});return _0xae7046['status'](0xc8)[_0x1f8690(0xa4)]({'tickets':_0x48fb3e,'count':_0x5887be,'hasMore':_0xff2b37});};exports[a47_0x49ab4d(0xa8)]=index;const kanban=async(_0x387ce6,_0x3e7c41)=>{const _0x3abc5e=a47_0x49ab4d,{pageNumber:_0x6d983c,status:_0x126071,date:_0x34159f,updatedAt:_0x522a93,searchParam:_0x21df76,showAll:_0xda9d5,queueIds:_0x2ee1dd,tags:_0x5aafb7,users:_0x264f33,withUnreadMessages:_0x388059}=_0x387ce6[_0x3abc5e(0x91)],_0xafeba6=_0x387ce6[_0x3abc5e(0xb8)]['id'],{companyId:_0x24106b}=_0x387ce6['user'];let _0x150261=[],_0x19a12b=[],_0x1407a5=[];_0x2ee1dd&&(_0x150261=JSON[_0x3abc5e(0x9c)](_0x2ee1dd));_0x5aafb7&&(_0x19a12b=JSON['parse'](_0x5aafb7));_0x264f33&&(_0x1407a5=JSON['parse'](_0x264f33));if(!_0x2ee1dd){const _0x4c644a=await User_1['default'][_0x3abc5e(0xaa)](_0xafeba6,{'include':[{'model':Queue_1[_0x3abc5e(0x8a)],'as':_0x3abc5e(0x99),'attributes':['id']}]});_0x4c644a&&_0x4c644a[_0x3abc5e(0x99)]&&(_0x150261=_0x4c644a[_0x3abc5e(0x99)][_0x3abc5e(0x94)](_0x217a17=>_0x217a17['id']));}const {tickets:_0x1668b2,count:_0xfda2b9,hasMore:_0x254983}=await(0x0,ListTicketsServiceKanban_1[_0x3abc5e(0x8a)])({'searchParam':_0x21df76,'tags':_0x19a12b,'users':_0x1407a5,'pageNumber':_0x6d983c,'status':_0x126071,'date':_0x34159f,'updatedAt':_0x522a93,'showAll':_0xda9d5,'userId':_0xafeba6,'queueIds':_0x150261,'withUnreadMessages':_0x388059,'companyId':_0x24106b});return _0x3e7c41['status'](0xc8)[_0x3abc5e(0xa4)]({'tickets':_0x1668b2,'count':_0xfda2b9,'hasMore':_0x254983});};exports[a47_0x49ab4d(0x8d)]=kanban;const findOpenTicketByContactId=async(_0x5f4645,_0x33fb4c)=>{const _0x7d0edf=a47_0x49ab4d,_0x42c0bc=await Ticket_1[_0x7d0edf(0x8a)][_0x7d0edf(0xa6)]({'where':{'contactId':_0x5f4645,'companyId':_0x33fb4c,'status':{[sequelize_1['Op']['or']]:[_0x7d0edf(0xba),_0x7d0edf(0xbb)]}}});return _0x42c0bc;};exports[a47_0x49ab4d(0xbc)]=findOpenTicketByContactId;const store=async(_0x11682f,_0x5211ef)=>{const _0x3dfdec=a47_0x49ab4d,{contactId:_0x11bbea,userId:_0x357b9e,queueId:_0x117f5c}=_0x11682f['body'],{companyId:_0x1d6888}=_0x11682f[_0x3dfdec(0xb8)],_0x5c0959=await(0x0,exports['findOpenTicketByContactId'])(_0x11bbea,_0x1d6888);if(_0x5c0959)return _0x5211ef[_0x3dfdec(0xab)](0xc8)['json'](_0x5c0959);const _0x4a7480=await(0x0,CreateTicketService_1['default'])({'contactId':_0x11bbea,'userId':_0x357b9e,'companyId':_0x1d6888,'queueId':_0x117f5c}),_0x51468a=(0x0,socket_1[_0x3dfdec(0x96)])();return _0x51468a['to'](_0x3dfdec(0xbe)+_0x1d6888+'-'+_0x4a7480[_0x3dfdec(0xab)])['to'](_0x3dfdec(0xaf)+_0x4a7480[_0x3dfdec(0x97)]+'-'+_0x4a7480[_0x3dfdec(0xab)])[_0x3dfdec(0x82)](_0x3dfdec(0xbe)+_0x1d6888+_0x3dfdec(0xbf),{'action':_0x3dfdec(0xb3),'ticket':_0x4a7480}),_0x5211ef[_0x3dfdec(0xab)](0xc8)[_0x3dfdec(0xa4)](_0x4a7480);};exports[a47_0x49ab4d(0x8c)]=store;const show=async(_0x3e5ba3,_0x178806)=>{const _0x17e225=a47_0x49ab4d,{ticketId:_0x16d408}=_0x3e5ba3['params'],{companyId:_0x3b5ce9,id:_0x1db25c,profile:_0xa73885}=_0x3e5ba3[_0x17e225(0xb8)],_0x258d96=parseInt(_0x1db25c),_0x3ad218=_0x3e5ba3[_0x17e225(0xb8)]['permissions']?.['canSpyConversations']||![],_0x25f296=await(0x0,ShowTicketService_1[_0x17e225(0x8a)])({'id':_0x16d408,'companyId':_0x3b5ce9,'userId':_0x258d96,'userProfile':_0xa73885,'canSpyConversations':_0x3ad218});return _0x178806[_0x17e225(0xab)](0xc8)[_0x17e225(0xa4)](_0x25f296);};exports[a47_0x49ab4d(0x89)]=show;const showFromUUID=async(_0xc7d317,_0x2fb99f)=>{const _0x391a64=a47_0x49ab4d,{uuid:_0x441eca}=_0xc7d317[_0x391a64(0x8e)],_0x293fd5=await(0x0,ShowTicketFromUUIDService_1[_0x391a64(0x8a)])(_0x441eca);return _0x2fb99f['status'](0xc8)[_0x391a64(0xa4)](_0x293fd5);};exports['showFromUUID']=showFromUUID;const closeAll=async(_0x11a2ef,_0x4c2751)=>{const _0x211f80=a47_0x49ab4d,{companyId:_0x1a0661}=_0x11a2ef['user'];var _0x12ae0c=_0x11a2ef['body']['status'],_0x2df314=await Ticket_1[_0x211f80(0x8a)][_0x211f80(0xac)]({'where':{'companyId':_0x1a0661,'status':_0x12ae0c}});for(const _0x24cb65 of _0x2df314){(0x0,UpdateTicketService_1[_0x211f80(0x8a)])({'ticketData':{'status':_0x211f80(0x98),'userId':_0x24cb65[_0x211f80(0xc0)]||null,'queueId':_0x24cb65[_0x211f80(0x97)]||null,'amountUsedBotQueues':0x0},'ticketId':_0x24cb65['id'],'companyId':_0x1a0661});}return _0x4c2751[_0x211f80(0xab)](0xc8)['json']({'message':_0x211f80(0xa3)});};function a47_0x3bf1(){const _0x463f1a=['queue-','tokenData','search','Mutex','update','__esModule','392823jozVZr','2eYOaXR','162643kAsDza','user','581355UJODWS','open','pending','findOpenTicketByContactId','../services/TicketServices/ListTicketsServiceKanban','company-','-ticket','userId','emit','ticket\x20deleted','120386UQgXUy','(((.+)+)+)+$','606592zxyfCZ','50LSseOT','true','show','default','closeAll','store','kanban','params','415195ccFQso','../services/TicketServices/DeleteTicketService','query','../models/Queue','../services/TicketServices/ShowTicketFromUUIDService','map','../models/User','getIO','queueId','closed','queues','../services/TicketServices/UpdateTicketService','24ZOUwwx','parse','__importDefault','remove','../services/TicketServices/ShowTicketService','-notification','72576vhRWJb','async-mutex','all\x20tickets\x20closed','json','delete','findOne','toString','index','constructor','findByPk','status','findAll','../services/TicketServices/ListTicketsService','../models/Ticket'];a47_0x3bf1=function(){return _0x463f1a;};return a47_0x3bf1();}exports[a47_0x49ab4d(0x8b)]=closeAll;const update=async(_0x1163e3,_0x2258db)=>{const _0x37fc67=a47_0x49ab4d,{ticketId:_0x2856c8}=_0x1163e3[_0x37fc67(0x8e)],{ticket:_0x12aa5b}=await updateMutex['runExclusive'](async()=>{const _0x334c5c=_0x37fc67,_0x7c694c=await(0x0,UpdateTicketService_1['default'])({'ticketData':_0x1163e3['body'],'ticketId':Number['parseInt'](_0x2856c8,0xa),'tokenData':_0x1163e3[_0x334c5c(0xb0)]});return _0x7c694c;});return _0x2258db[_0x37fc67(0xab)](0xc8)[_0x37fc67(0xa4)](_0x12aa5b);};exports[a47_0x49ab4d(0xb3)]=update;const remove=async(_0x396765,_0x494461)=>{const _0x5f064f=a47_0x49ab4d,{ticketId:_0x51a074}=_0x396765['params'],{companyId:_0x2851eb}=_0x396765[_0x5f064f(0xb8)];await(0x0,ShowTicketService_1[_0x5f064f(0x8a)])(_0x51a074,_0x2851eb);const _0x2fd7c5=await(0x0,DeleteTicketService_1[_0x5f064f(0x8a)])(_0x51a074),_0x3a4457=(0x0,socket_1[_0x5f064f(0x96)])();return _0x3a4457['to'](_0x51a074)['to'](_0x5f064f(0xbe)+_0x2851eb+'-'+_0x2fd7c5['status'])['to'](_0x5f064f(0xbe)+_0x2851eb+_0x5f064f(0xa0))['to']('queue-'+_0x2fd7c5['queueId']+'-'+_0x2fd7c5[_0x5f064f(0xab)])['to'](_0x5f064f(0xaf)+_0x2fd7c5[_0x5f064f(0x97)]+'-notification')['emit'](_0x5f064f(0xbe)+_0x2851eb+_0x5f064f(0xbf),{'action':_0x5f064f(0xa5),'ticketId':+_0x51a074}),_0x494461['status'](0xc8)[_0x5f064f(0xa4)]({'message':_0x5f064f(0x83)});};function a47_0x95ed(_0x749361,_0x123596){const _0x56ac0b=a47_0x3bf1();return a47_0x95ed=function(_0xaa4e2b,_0x3855cb){_0xaa4e2b=_0xaa4e2b-0x82;let _0x3bf1b5=_0x56ac0b[_0xaa4e2b];return _0x3bf1b5;},a47_0x95ed(_0x749361,_0x123596);}exports[a47_0x49ab4d(0x9e)]=remove;