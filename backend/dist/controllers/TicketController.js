const a38_0x5ca610=a38_0x376f;(function(_0x480dca,_0x29c2e6){const _0x54c8d0=a38_0x376f,_0x56789f=_0x480dca();while(!![]){try{const _0x33d390=parseInt(_0x54c8d0(0x185))/0x1*(parseInt(_0x54c8d0(0x1a9))/0x2)+parseInt(_0x54c8d0(0x196))/0x3+-parseInt(_0x54c8d0(0x182))/0x4*(parseInt(_0x54c8d0(0x18c))/0x5)+parseInt(_0x54c8d0(0x1a0))/0x6+parseInt(_0x54c8d0(0x197))/0x7+-parseInt(_0x54c8d0(0x17f))/0x8*(-parseInt(_0x54c8d0(0x17d))/0x9)+-parseInt(_0x54c8d0(0x1b6))/0xa;if(_0x33d390===_0x29c2e6)break;else _0x56789f['push'](_0x56789f['shift']());}catch(_0x4f1369){_0x56789f['push'](_0x56789f['shift']());}}}(a38_0x22c6,0x319cb));const a38_0x3f8314=(function(){let _0x2ae636=!![];return function(_0x211976,_0xc51f69){const _0x152267=_0x2ae636?function(){const _0xe328d9=a38_0x376f;if(_0xc51f69){const _0x3719c1=_0xc51f69[_0xe328d9(0x17a)](_0x211976,arguments);return _0xc51f69=null,_0x3719c1;}}:function(){};return _0x2ae636=![],_0x152267;};}()),a38_0x1535dc=a38_0x3f8314(this,function(){const _0x80413e=a38_0x376f;return a38_0x1535dc[_0x80413e(0x193)]()[_0x80413e(0x180)]('(((.+)+)+)+$')[_0x80413e(0x193)]()[_0x80413e(0x19b)](a38_0x1535dc)[_0x80413e(0x180)]('(((.+)+)+)+$');});a38_0x1535dc();'use strict';var __importDefault=this&&this[a38_0x5ca610(0x195)]||function(_0x56a0f5){const _0x12ad2e=a38_0x5ca610;return _0x56a0f5&&_0x56a0f5[_0x12ad2e(0x184)]?_0x56a0f5:{'default':_0x56a0f5};};Object[a38_0x5ca610(0x18b)](exports,'__esModule',{'value':!![]}),exports['remove']=exports[a38_0x5ca610(0x19a)]=exports[a38_0x5ca610(0x1ae)]=exports['showFromUUID']=exports[a38_0x5ca610(0x18a)]=exports[a38_0x5ca610(0x1a1)]=exports['findOpenTicketByContactId']=exports[a38_0x5ca610(0x198)]=exports[a38_0x5ca610(0x194)]=void 0x0;const async_mutex_1=require('async-mutex'),socket_1=require(a38_0x5ca610(0x1a6)),Ticket_1=__importDefault(require(a38_0x5ca610(0x1ab))),User_1=__importDefault(require('../models/User')),Queue_1=__importDefault(require(a38_0x5ca610(0x190))),sequelize_1=require(a38_0x5ca610(0x192)),CreateTicketService_1=__importDefault(require(a38_0x5ca610(0x1aa))),DeleteTicketService_1=__importDefault(require(a38_0x5ca610(0x188))),ListTicketsService_1=__importDefault(require(a38_0x5ca610(0x1b4))),ShowTicketFromUUIDService_1=__importDefault(require(a38_0x5ca610(0x1ac))),ShowTicketService_1=__importDefault(require(a38_0x5ca610(0x1b1))),UpdateTicketService_1=__importDefault(require('../services/TicketServices/UpdateTicketService')),ListTicketsServiceKanban_1=__importDefault(require(a38_0x5ca610(0x1a8))),updateMutex=new async_mutex_1['Mutex'](),index=async(_0x1ab356,_0x553d83)=>{const _0xe85bc5=a38_0x5ca610,{pageNumber:_0x171374,status:_0x2432cd,groups:_0x560c7d,date:_0x2aa930,updatedAt:_0x712baa,isSearch:_0x2e04fa,searchParam:_0x31aa50,showAll:_0x33e963,queueIds:_0x1a83d5,tags:_0xa09f27,users:_0x18e324,withUnreadMessages:_0x535e2c,notClosed:_0x571109,all:_0x5615e0}=_0x1ab356[_0xe85bc5(0x18f)],_0x156d9f=_0x1ab356[_0xe85bc5(0x1b0)]['id'],{companyId:_0x2585f9}=_0x1ab356[_0xe85bc5(0x1b0)];let _0x3a65d4=[],_0x54f020=[],_0x46187a=[];_0x1a83d5&&(_0x3a65d4=JSON[_0xe85bc5(0x17b)](_0x1a83d5));_0xa09f27&&(_0x54f020=JSON[_0xe85bc5(0x17b)](_0xa09f27));_0x18e324&&(_0x46187a=JSON[_0xe85bc5(0x17b)](_0x18e324));if(!_0x1a83d5){const _0x4b6d63=await User_1[_0xe85bc5(0x19e)]['findByPk'](_0x156d9f,{'include':[{'model':Queue_1[_0xe85bc5(0x19e)],'as':_0xe85bc5(0x187),'attributes':['id']}]});_0x4b6d63&&_0x4b6d63[_0xe85bc5(0x187)]&&(_0x3a65d4=_0x4b6d63[_0xe85bc5(0x187)][_0xe85bc5(0x186)](_0x5d0f19=>_0x5d0f19['id']));}const {tickets:_0x4d9bbe,count:_0xb28ae6,hasMore:_0x4451a2}=await(0x0,ListTicketsService_1[_0xe85bc5(0x19e)])({'isSearch':_0x2e04fa===_0xe85bc5(0x1b3),'searchParam':_0x31aa50,'tags':_0x54f020,'users':_0x46187a,'pageNumber':_0x171374,'status':_0x2432cd,'groups':_0x560c7d,'date':_0x2aa930,'updatedAt':_0x712baa,'showAll':_0x33e963,'userId':_0x156d9f,'queueIds':_0x3a65d4,'withUnreadMessages':_0x535e2c,'notClosed':!!_0x571109,'all':!!_0x5615e0,'companyId':_0x2585f9});return _0x553d83['status'](0xc8)[_0xe85bc5(0x17e)]({'tickets':_0x4d9bbe,'count':_0xb28ae6,'hasMore':_0x4451a2});};exports[a38_0x5ca610(0x194)]=index;const kanban=async(_0x80987a,_0x2abf76)=>{const _0x21247d=a38_0x5ca610,{pageNumber:_0x468c4c,status:_0x31cf42,date:_0x4a44bb,updatedAt:_0x3da2b1,searchParam:_0x41a6e1,showAll:_0x3482b3,queueIds:_0x300321,tags:_0x285cfd,users:_0x229896,withUnreadMessages:_0x5018d6}=_0x80987a['query'],_0x2788e1=_0x80987a['user']['id'],{companyId:_0x5ce8b2}=_0x80987a['user'];let _0x22648d=[],_0x4cfd92=[],_0x10b154=[];_0x300321&&(_0x22648d=JSON['parse'](_0x300321));_0x285cfd&&(_0x4cfd92=JSON['parse'](_0x285cfd));_0x229896&&(_0x10b154=JSON[_0x21247d(0x17b)](_0x229896));if(!_0x300321){const _0x48ac05=await User_1[_0x21247d(0x19e)][_0x21247d(0x19c)](_0x2788e1,{'include':[{'model':Queue_1[_0x21247d(0x19e)],'as':'queues','attributes':['id']}]});_0x48ac05&&_0x48ac05['queues']&&(_0x22648d=_0x48ac05[_0x21247d(0x187)][_0x21247d(0x186)](_0x4266e3=>_0x4266e3['id']));}const {tickets:_0x3631e2,count:_0xc2a15,hasMore:_0x16e08e}=await(0x0,ListTicketsServiceKanban_1[_0x21247d(0x19e)])({'searchParam':_0x41a6e1,'tags':_0x4cfd92,'users':_0x10b154,'pageNumber':_0x468c4c,'status':_0x31cf42,'date':_0x4a44bb,'updatedAt':_0x3da2b1,'showAll':_0x3482b3,'userId':_0x2788e1,'queueIds':_0x22648d,'withUnreadMessages':_0x5018d6,'companyId':_0x5ce8b2});return _0x2abf76[_0x21247d(0x19d)](0xc8)[_0x21247d(0x17e)]({'tickets':_0x3631e2,'count':_0xc2a15,'hasMore':_0x16e08e});};exports['kanban']=kanban;const findOpenTicketByContactId=async(_0x39b589,_0x42bf50)=>{const _0x3617a8=a38_0x5ca610,_0x3ee44f=await Ticket_1[_0x3617a8(0x19e)][_0x3617a8(0x1ad)]({'where':{'contactId':_0x39b589,'companyId':_0x42bf50,'status':{[sequelize_1['Op']['or']]:[_0x3617a8(0x1a4),_0x3617a8(0x18e)]}}});return _0x3ee44f;};exports['findOpenTicketByContactId']=findOpenTicketByContactId;const store=async(_0x3b08c8,_0x3554bd)=>{const _0x592d50=a38_0x5ca610,{contactId:_0x7936a1,userId:_0x3b1bea,queueId:_0x4ef3b2}=_0x3b08c8[_0x592d50(0x183)],{companyId:_0x5d52c2}=_0x3b08c8['user'],_0x2a6d65=await(0x0,exports['findOpenTicketByContactId'])(_0x7936a1,_0x5d52c2);if(_0x2a6d65)return _0x3554bd[_0x592d50(0x19d)](0xc8)[_0x592d50(0x17e)](_0x2a6d65);const _0x357506=await(0x0,CreateTicketService_1['default'])({'contactId':_0x7936a1,'userId':_0x3b1bea,'companyId':_0x5d52c2,'queueId':_0x4ef3b2}),_0x41572c=(0x0,socket_1[_0x592d50(0x1a3)])();return _0x41572c['to'](_0x592d50(0x19f)+_0x5d52c2+'-'+_0x357506[_0x592d50(0x19d)])['to'](_0x592d50(0x191)+_0x357506[_0x592d50(0x1b2)]+'-'+_0x357506[_0x592d50(0x19d)])[_0x592d50(0x18d)](_0x592d50(0x19f)+_0x5d52c2+'-ticket',{'action':_0x592d50(0x19a),'ticket':_0x357506}),_0x3554bd['status'](0xc8)[_0x592d50(0x17e)](_0x357506);};function a38_0x22c6(){const _0x32cca3=['toString','index','__importDefault','960306DDvzde','999523ACfnrv','kanban','-notification','update','constructor','findByPk','status','default','company-','400986kpRGVu','store','showFromUUID','getIO','open','tokenData','../libs/socket','-ticket','../services/TicketServices/ListTicketsServiceKanban','22rjZlWi','../services/TicketServices/CreateTicketService','../models/Ticket','../services/TicketServices/ShowTicketFromUUIDService','findOne','closeAll','parseInt','user','../services/TicketServices/ShowTicketService','queueId','true','../services/TicketServices/ListTicketsService','params','7408930yINdZI','apply','parse','remove','72UdggZJ','json','240544HeiFki','search','delete','100dfxtxP','body','__esModule','29033jTkePO','map','queues','../services/TicketServices/DeleteTicketService','all\x20tickets\x20closed','show','defineProperty','29105FDqTrF','emit','pending','query','../models/Queue','queue-','sequelize'];a38_0x22c6=function(){return _0x32cca3;};return a38_0x22c6();}exports[a38_0x5ca610(0x1a1)]=store;const show=async(_0x146f2a,_0x1ac7ae)=>{const _0x45eed9=a38_0x5ca610,{ticketId:_0x3bbd8c}=_0x146f2a[_0x45eed9(0x1b5)],{companyId:_0x4ce586}=_0x146f2a[_0x45eed9(0x1b0)],_0x568374=await(0x0,ShowTicketService_1[_0x45eed9(0x19e)])(_0x3bbd8c,_0x4ce586);return _0x1ac7ae[_0x45eed9(0x19d)](0xc8)[_0x45eed9(0x17e)](_0x568374);};exports[a38_0x5ca610(0x18a)]=show;const showFromUUID=async(_0x2005f9,_0x3dc03f)=>{const _0x3f1f2a=a38_0x5ca610,{uuid:_0x2ee91e}=_0x2005f9[_0x3f1f2a(0x1b5)],_0x3393b8=await(0x0,ShowTicketFromUUIDService_1['default'])(_0x2ee91e);return _0x3dc03f[_0x3f1f2a(0x19d)](0xc8)[_0x3f1f2a(0x17e)](_0x3393b8);};exports[a38_0x5ca610(0x1a2)]=showFromUUID;function a38_0x376f(_0xd64809,_0x469274){const _0xe4dba=a38_0x22c6();return a38_0x376f=function(_0x1535dc,_0x3f8314){_0x1535dc=_0x1535dc-0x17a;let _0x22c626=_0xe4dba[_0x1535dc];return _0x22c626;},a38_0x376f(_0xd64809,_0x469274);}const closeAll=async(_0x369d0e,_0x284d95)=>{const _0xf2465c=a38_0x5ca610,{companyId:_0x58b878}=_0x369d0e['user'];var _0x4148cf=_0x369d0e[_0xf2465c(0x183)]['status'],_0x49a537=await Ticket_1[_0xf2465c(0x19e)]['findAll']({'where':{'companyId':_0x58b878,'status':_0x4148cf}});for(const _0x492bed of _0x49a537){(0x0,UpdateTicketService_1[_0xf2465c(0x19e)])({'ticketData':{'status':'closed','userId':_0x492bed['userId']||null,'queueId':_0x492bed[_0xf2465c(0x1b2)]||null,'amountUsedBotQueues':0x0},'ticketId':_0x492bed['id'],'companyId':_0x58b878});}return _0x284d95[_0xf2465c(0x19d)](0xc8)[_0xf2465c(0x17e)]({'message':_0xf2465c(0x189)});};exports[a38_0x5ca610(0x1ae)]=closeAll;const update=async(_0x7201aa,_0x428e52)=>{const _0x19204e=a38_0x5ca610,{ticketId:_0x1e4ad6}=_0x7201aa[_0x19204e(0x1b5)],{ticket:_0x5ad7de}=await updateMutex['runExclusive'](async()=>{const _0x510095=_0x19204e,_0x42b918=await(0x0,UpdateTicketService_1[_0x510095(0x19e)])({'ticketData':_0x7201aa[_0x510095(0x183)],'ticketId':Number[_0x510095(0x1af)](_0x1e4ad6,0xa),'tokenData':_0x7201aa[_0x510095(0x1a5)]});return _0x42b918;});return _0x428e52['status'](0xc8)[_0x19204e(0x17e)](_0x5ad7de);};exports[a38_0x5ca610(0x19a)]=update;const remove=async(_0x12bc68,_0x99e940)=>{const _0x1892e0=a38_0x5ca610,{ticketId:_0x53ceb1}=_0x12bc68[_0x1892e0(0x1b5)],{companyId:_0x3f5f47}=_0x12bc68['user'];await(0x0,ShowTicketService_1[_0x1892e0(0x19e)])(_0x53ceb1,_0x3f5f47);const _0x22be68=await(0x0,DeleteTicketService_1[_0x1892e0(0x19e)])(_0x53ceb1),_0x2df932=(0x0,socket_1[_0x1892e0(0x1a3)])();return _0x2df932['to'](_0x53ceb1)['to'](_0x1892e0(0x19f)+_0x3f5f47+'-'+_0x22be68[_0x1892e0(0x19d)])['to'](_0x1892e0(0x19f)+_0x3f5f47+_0x1892e0(0x199))['to'](_0x1892e0(0x191)+_0x22be68['queueId']+'-'+_0x22be68['status'])['to'](_0x1892e0(0x191)+_0x22be68['queueId']+_0x1892e0(0x199))[_0x1892e0(0x18d)](_0x1892e0(0x19f)+_0x3f5f47+_0x1892e0(0x1a7),{'action':_0x1892e0(0x181),'ticketId':+_0x53ceb1}),_0x99e940[_0x1892e0(0x19d)](0xc8)[_0x1892e0(0x17e)]({'message':'ticket\x20deleted'});};exports[a38_0x5ca610(0x17c)]=remove;