const a24_0x2bf8a1=a24_0x75f4;function a24_0x75f4(_0x59d8b8,_0x55a0a6){const _0x11f705=a24_0x14d8();return a24_0x75f4=function(_0x2d7a55,_0x470191){_0x2d7a55=_0x2d7a55-0x144;let _0x14d82e=_0x11f705[_0x2d7a55];return _0x14d82e;},a24_0x75f4(_0x59d8b8,_0x55a0a6);}(function(_0x401717,_0x2c9b22){const _0x27c873=a24_0x75f4,_0x21a394=_0x401717();while(!![]){try{const _0x187935=-parseInt(_0x27c873(0x14d))/0x1+parseInt(_0x27c873(0x1a9))/0x2+-parseInt(_0x27c873(0x178))/0x3*(-parseInt(_0x27c873(0x15c))/0x4)+-parseInt(_0x27c873(0x16b))/0x5*(parseInt(_0x27c873(0x18a))/0x6)+-parseInt(_0x27c873(0x185))/0x7+-parseInt(_0x27c873(0x19e))/0x8*(-parseInt(_0x27c873(0x18d))/0x9)+-parseInt(_0x27c873(0x17e))/0xa*(parseInt(_0x27c873(0x184))/0xb);if(_0x187935===_0x2c9b22)break;else _0x21a394['push'](_0x21a394['shift']());}catch(_0x455b99){_0x21a394['push'](_0x21a394['shift']());}}}(a24_0x14d8,0x6f266));const a24_0x470191=(function(){let _0x1528fb=!![];return function(_0x21cdd4,_0x4fcb58){const _0x7ccc23=_0x1528fb?function(){const _0x1eaae9=a24_0x75f4;if(_0x4fcb58){const _0x39c642=_0x4fcb58[_0x1eaae9(0x1ac)](_0x21cdd4,arguments);return _0x4fcb58=null,_0x39c642;}}:function(){};return _0x1528fb=![],_0x7ccc23;};}()),a24_0x2d7a55=a24_0x470191(this,function(){const _0x536be0=a24_0x75f4;return a24_0x2d7a55[_0x536be0(0x1ba)]()[_0x536be0(0x19b)](_0x536be0(0x14e))['toString']()['constructor'](a24_0x2d7a55)[_0x536be0(0x19b)](_0x536be0(0x14e));});a24_0x2d7a55();'use strict';var __importDefault=this&&this[a24_0x2bf8a1(0x1b4)]||function(_0x1e13c2){const _0xf6cba8=a24_0x2bf8a1;return _0x1e13c2&&_0x1e13c2[_0xf6cba8(0x1b2)]?_0x1e13c2:{'default':_0x1e13c2};};Object[a24_0x2bf8a1(0x154)](exports,a24_0x2bf8a1(0x1b2),{'value':!![]}),exports[a24_0x2bf8a1(0x161)]=exports[a24_0x2bf8a1(0x16f)]=exports[a24_0x2bf8a1(0x1ab)]=exports[a24_0x2bf8a1(0x1a7)]=exports[a24_0x2bf8a1(0x162)]=exports[a24_0x2bf8a1(0x1a3)]=exports[a24_0x2bf8a1(0x18e)]=exports[a24_0x2bf8a1(0x199)]=exports['index']=void 0x0;const fs_1=__importDefault(require('fs')),AppError_1=__importDefault(require('../errors/AppError')),SetTicketMessagesAsRead_1=__importDefault(require(a24_0x2bf8a1(0x176))),socket_1=require('../libs/socket'),Queue_1=__importDefault(require('../models/Queue')),User_1=__importDefault(require(a24_0x2bf8a1(0x189))),Whatsapp_1=__importDefault(require(a24_0x2bf8a1(0x1b5))),ListMessagesService_1=__importDefault(require('../services/MessageServices/ListMessagesService')),ShowTicketService_1=__importDefault(require('../services/TicketServices/ShowTicketService')),DeleteWhatsAppMessage_1=__importDefault(require(a24_0x2bf8a1(0x19a))),SendWhatsAppMedia_1=__importDefault(require(a24_0x2bf8a1(0x17a))),SendWhatsAppMessage_1=__importDefault(require(a24_0x2bf8a1(0x182))),CheckNumber_1=__importDefault(require(a24_0x2bf8a1(0x14f))),EditWhatsAppMessage_1=__importDefault(require(a24_0x2bf8a1(0x193))),ListAllMessagesService_1=__importDefault(require(a24_0x2bf8a1(0x18b))),validator_1=require(a24_0x2bf8a1(0x170)),logger_1=require('../utils/logger'),Message_1=__importDefault(require('../models/Message')),Contact_1=__importDefault(require(a24_0x2bf8a1(0x186))),Ticket_1=__importDefault(require('../models/Ticket')),ForwardMessageService_1=__importDefault(require(a24_0x2bf8a1(0x145))),wbot_1=require(a24_0x2bf8a1(0x17f)),VerifyHandlers_1=require(a24_0x2bf8a1(0x169)),SendPresenceStatus_1=require(a24_0x2bf8a1(0x1af)),index=async(_0x3756c1,_0xaed222)=>{const _0x1ea320=a24_0x2bf8a1,{ticketId:_0x41e8ac}=_0x3756c1['params'],{pageNumber:_0x122f1b,markAsRead:_0x57b420}=_0x3756c1['query'],{companyId:_0x224935,profile:_0x450904}=_0x3756c1['user'],_0x3a5608=[];if(_0x450904!==_0x1ea320(0x15e)){const _0x383faa=await User_1['default']['findByPk'](_0x3756c1[_0x1ea320(0x187)]['id'],{'include':[{'model':Queue_1['default'],'as':_0x1ea320(0x14b)}]});_0x383faa[_0x1ea320(0x14b)]['forEach'](_0x112bfb=>{const _0x3a952a=_0x1ea320;_0x3a5608[_0x3a952a(0x1b8)](_0x112bfb['id']);});}const {count:_0x208d88,messages:_0x1d9853,ticket:_0x1f1315,hasMore:_0x517692}=await(0x0,ListMessagesService_1[_0x1ea320(0x1a1)])({'pageNumber':_0x122f1b,'ticketId':_0x41e8ac,'companyId':_0x224935,'queues':_0x3a5608});return _0x1f1315[_0x1ea320(0x152)]===_0x1ea320(0x1b9)&&_0x57b420===_0x1ea320(0x1a8)&&(0x0,SetTicketMessagesAsRead_1['default'])(_0x1f1315),_0xaed222[_0x1ea320(0x177)]({'count':_0x208d88,'messages':_0x1d9853,'ticket':_0x1f1315,'hasMore':_0x517692});};exports['index']=index;const store=async(_0x4bf1a8,_0x3a6b64)=>{const _0x9d575a=a24_0x2bf8a1,{ticketId:_0x3badc4}=_0x4bf1a8[_0x9d575a(0x1b6)],{body:_0x5cacee,quotedMsg:_0x5dd2eb}=_0x4bf1a8['body'],_0x474645=_0x4bf1a8[_0x9d575a(0x18f)],{companyId:_0x3e275b}=_0x4bf1a8[_0x9d575a(0x187)],_0x29b15=Number(_0x4bf1a8[_0x9d575a(0x187)]['id'])||null,_0x1f1502=await(0x0,ShowTicketService_1[_0x9d575a(0x1a1)])(_0x3badc4,_0x3e275b),{channel:_0x41d987}=_0x1f1502;_0x41d987===_0x9d575a(0x1b9)&&(0x0,SetTicketMessagesAsRead_1[_0x9d575a(0x1a1)])(_0x1f1502);if(_0x474645)_0x41d987==='whatsapp'&&await Promise['all'](_0x474645[_0x9d575a(0x17d)](async _0x114c6c=>{const _0x23eced=_0x9d575a;await(0x0,SendWhatsAppMedia_1[_0x23eced(0x1a1)])({'media':_0x114c6c,'ticket':_0x1f1502}),fs_1[_0x23eced(0x1a1)][_0x23eced(0x196)](_0x114c6c['path']);}));else _0x41d987==='whatsapp'&&await(0x0,SendWhatsAppMessage_1[_0x9d575a(0x1a1)])({'body':_0x5cacee,'ticket':_0x1f1502,'userId':_0x29b15,'quotedMsg':_0x5dd2eb});return _0x3a6b64[_0x9d575a(0x161)]();};function a24_0x14d8(){const _0x358229=['user','ERR_MESSAGE_NOT_FOUND','../models/User','4362rdUYYq','../services/MessageServices/ListAllMessagesService','replace','162THuwXD','getAll','files','getWbot','findByPk','get','../services/WbotServices/EditWhatsAppMessage','g.us','ERR_QUEUE_NOT_FOUND','unlinkSync','ticketId','ERR_SYNTAX','store','../services/WbotServices/DeleteWhatsAppMessage','search','ERR_WHATSAPP_NOT_FOUND','@lid','203336hXKwaK','whatsappId','body','default','companyId','react','dataJson','MessageController.send:\x20Failed\x20to\x20put\x20message\x20on\x20queue','number','remove','true','1770426usEOJU','find','typing','apply','update','key','../helpers/SendPresenceStatus','message','ERR_INTERNAL_ERROR','__esModule','ticket','__importDefault','../models/Whatsapp','params','ERR_FORBIDDEN','push','whatsapp','toString','getIO','../services/MessageServices/ForwardMessageService','logger','messageQueue','query','jid','@s.whatsapp.net','queues','Status\x20','336458iSGfTL','(((.+)+)+)+$','../services/WbotServices/CheckNumber','@g.us','saveOnTicket','channel','fromMe','defineProperty','all','s.whatsapp.net','add','status','remoteJid','\x20enviado\x20com\x20sucesso','error','4xgwrQW','lid','admin','emit','sendMessage','send','edit','includes','dateStart','-appMessage','findOne','SendPausedStatus','app','../services/WbotServices/VerifyHandlers','ERR_CONTACT_NOT_FOUND','4385yiwOCb','contact','verifyMessage','ERR_WHATSAPP_MESSAGE_NOT_SENT','forward','validator','Ticket\x20not\x20found','length','isGroup','profile','parse','../helpers/SetTicketMessagesAsRead','json','1962741EnkLXb','ERR_ACCESS_DENIED','../services/WbotServices/SendWhatsAppMedia','company-','stringify','map','46390qcLkqC','../libs/wbot','SendMessage','TicketId\x20is\x20required','../services/WbotServices/SendWhatsAppMessage','dateEnd','198cpkfDX','3389099XdfFXk','../models/Contact'];a24_0x14d8=function(){return _0x358229;};return a24_0x14d8();}exports['store']=store;const getAll=async(_0x35ffc1,_0x37aedb)=>{const _0x2755e4=a24_0x2bf8a1,_0x106f7f=_0x35ffc1[_0x2755e4(0x148)][_0x2755e4(0x164)],_0x42a875=_0x35ffc1[_0x2755e4(0x148)][_0x2755e4(0x183)],_0x404fed=(0x0,validator_1['toBoolean'])(_0x35ffc1['query'][_0x2755e4(0x153)]),{companyId:_0x29b06e}=_0x35ffc1[_0x2755e4(0x187)],{count:_0x54bc13}=await(0x0,ListAllMessagesService_1['default'])({'companyId':_0x29b06e,'fromMe':_0x404fed,'dateStart':_0x106f7f,'dateEnd':_0x42a875});return _0x37aedb[_0x2755e4(0x177)]({'count':_0x54bc13});};exports[a24_0x2bf8a1(0x18e)]=getAll;const react=async(_0x317438,_0x45c14f)=>{const _0x2f0f11=a24_0x2bf8a1,{messageId:_0x20007e}=_0x317438[_0x2f0f11(0x1b6)],{companyId:_0xbb02fe}=_0x317438['user'],_0x5eaada=Number(_0x317438[_0x2f0f11(0x187)]['id'])||null,{ticketId:_0x4e61fc,emoji:_0x1e47dc}=_0x317438[_0x2f0f11(0x1a0)],_0x4bb55e=await Message_1[_0x2f0f11(0x1a1)][_0x2f0f11(0x166)]({'where':{'id':_0x20007e,'ticketId':_0x4e61fc}});if(!_0x4bb55e)throw new AppError_1['default'](_0x2f0f11(0x188),0x194);const _0xbd5c01=await(0x0,ShowTicketService_1[_0x2f0f11(0x1a1)])(_0x4e61fc,_0xbb02fe),_0x5d542f=await(0x0,wbot_1[_0x2f0f11(0x190)])(_0xbd5c01[_0x2f0f11(0x19f)]);if(!_0x5d542f)throw new AppError_1[(_0x2f0f11(0x1a1))](_0x2f0f11(0x19c),0x1f4);const _0x424d3a=JSON[_0x2f0f11(0x175)](_0x4bb55e[_0x2f0f11(0x1a4)]),_0x4a676d=await _0x5d542f[_0x2f0f11(0x160)](_0xbd5c01[_0x2f0f11(0x16c)][_0x2f0f11(0x159)]||_0xbd5c01[_0x2f0f11(0x16c)][_0x2f0f11(0x1a6)]+(_0xbd5c01[_0x2f0f11(0x173)]?_0x2f0f11(0x150):_0xbd5c01[_0x2f0f11(0x16c)][_0x2f0f11(0x1a6)][_0x2f0f11(0x172)]>0xd?_0x2f0f11(0x19d):_0x2f0f11(0x14a)),{'react':{'text':_0x1e47dc,'key':_0x424d3a[_0x2f0f11(0x1ae)]}});if(!_0x4a676d)throw new AppError_1['default'](_0x2f0f11(0x16e),0x1f4);return await(0x0,VerifyHandlers_1[_0x2f0f11(0x16d)])(_0x4a676d,_0xbd5c01,_0xbd5c01['contact']),_0x45c14f[_0x2f0f11(0x161)]();};exports[a24_0x2bf8a1(0x1a3)]=react;const edit=async(_0x5eefba,_0x11a52c)=>{const _0x169a62=a24_0x2bf8a1,{messageId:_0x208ca1}=_0x5eefba['params'],{companyId:_0x538917}=_0x5eefba[_0x169a62(0x187)],_0xb65e44=Number(_0x5eefba[_0x169a62(0x187)]['id'])||null,{body:_0x19ebee}=_0x5eefba[_0x169a62(0x1a0)],{ticketId:_0x5188b6,message:_0x4c82d7}=await(0x0,EditWhatsAppMessage_1[_0x169a62(0x1a1)])({'messageId':_0x208ca1,'companyId':_0x538917,'userId':_0xb65e44,'body':_0x19ebee}),_0x4d0a2e=(0x0,socket_1['getIO'])();return _0x4d0a2e['to'](_0x5188b6[_0x169a62(0x1ba)]())[_0x169a62(0x15f)](_0x169a62(0x17b)+_0x538917+_0x169a62(0x165),{'action':_0x169a62(0x1ad),'message':_0x4c82d7}),_0x11a52c['send']();};exports[a24_0x2bf8a1(0x162)]=edit;const remove=async(_0x5564a5,_0x22cd67)=>{const _0x34b656=a24_0x2bf8a1,{messageId:_0x31f28a}=_0x5564a5['params'],{companyId:_0x4215ab}=_0x5564a5[_0x34b656(0x187)],_0x4ac6fa=await(0x0,DeleteWhatsAppMessage_1[_0x34b656(0x1a1)])(_0x31f28a),_0x2ff46f=(0x0,socket_1[_0x34b656(0x144)])();return _0x2ff46f['to'](_0x4ac6fa[_0x34b656(0x197)][_0x34b656(0x1ba)]())[_0x34b656(0x15f)]('company-'+_0x4215ab+_0x34b656(0x165),{'action':_0x34b656(0x1ad),'message':_0x4ac6fa}),_0x22cd67['send']();};exports['remove']=remove;const typing=async(_0x49afd5,_0x1c2823)=>{const _0x5dd35b=a24_0x2bf8a1,{ticketId:_0x3cf2e4}=_0x49afd5[_0x5dd35b(0x1b6)],{companyId:_0x1a6aa8}=_0x49afd5[_0x5dd35b(0x187)],{status:_0x4b8014}=_0x49afd5['query'];if(!_0x3cf2e4)return _0x1c2823['status'](0x190)[_0x5dd35b(0x161)](_0x5dd35b(0x181));const _0x3c1ad9=await(0x0,ShowTicketService_1['default'])(_0x3cf2e4,_0x1a6aa8);if(!_0x3c1ad9)return _0x1c2823[_0x5dd35b(0x158)](0x194)[_0x5dd35b(0x161)](_0x5dd35b(0x171));let _0x3fa3b1=(0x0,wbot_1[_0x5dd35b(0x190)])(_0x3c1ad9['whatsappId']);return _0x4b8014==_0x5dd35b(0x1a8)?await(0x0,SendPresenceStatus_1['SendTypingStatus'])(_0x3fa3b1,_0x3c1ad9[_0x5dd35b(0x16c)][_0x5dd35b(0x159)]||_0x3c1ad9[_0x5dd35b(0x16c)]['number']+'@'+(_0x3c1ad9[_0x5dd35b(0x173)]?_0x5dd35b(0x194):_0x3c1ad9[_0x5dd35b(0x16c)][_0x5dd35b(0x1a6)][_0x5dd35b(0x172)]>0xd?_0x5dd35b(0x15d):'s.whatsapp.net')):await(0x0,SendPresenceStatus_1[_0x5dd35b(0x167)])(_0x3fa3b1,_0x3c1ad9[_0x5dd35b(0x16c)][_0x5dd35b(0x159)]||_0x3c1ad9[_0x5dd35b(0x16c)]['number']+'@'+(_0x3c1ad9[_0x5dd35b(0x173)]?_0x5dd35b(0x194):_0x3c1ad9[_0x5dd35b(0x16c)]['number'][_0x5dd35b(0x172)]>0xd?'lid':_0x5dd35b(0x156))),_0x1c2823[_0x5dd35b(0x158)](0xc8)[_0x5dd35b(0x161)](_0x5dd35b(0x14c)+_0x4b8014+_0x5dd35b(0x15a));};exports[a24_0x2bf8a1(0x1ab)]=typing;const forward=async(_0x576180,_0x4af083)=>{const _0x520797=a24_0x2bf8a1,{contactId:_0x363f27,ticketId:_0x4bf298,messageId:_0x21a4c3,queueId:_0x4aa9e4}=_0x576180[_0x520797(0x1a0)],{companyId:_0x43891c}=_0x576180[_0x520797(0x187)],_0x5b4993=await User_1[_0x520797(0x1a1)]['findByPk'](_0x576180['user']['id'],{'include':[{'model':Queue_1['default'],'as':_0x520797(0x14b)}]});if(_0x4aa9e4&&_0x5b4993[_0x520797(0x174)]!==_0x520797(0x15e)&&!_0x5b4993[_0x520797(0x14b)][_0x520797(0x1aa)](_0x1ebfdf=>_0x1ebfdf['id']===_0x4aa9e4))throw new AppError_1[(_0x520797(0x1a1))](_0x520797(0x1b7),0x193);const _0x1810ea=await Message_1[_0x520797(0x1a1)]['findOne']({'where':{'id':_0x21a4c3,'ticketId':_0x4bf298},'include':[{'model':Ticket_1[_0x520797(0x1a1)],'as':_0x520797(0x1b3),'include':[{'model':Whatsapp_1['default'],'as':_0x520797(0x1b9)}]},{'model':Contact_1[_0x520797(0x1a1)],'as':'contact'}]});if(!_0x1810ea)throw new AppError_1[(_0x520797(0x1a1))]('ERR_MESSAGE_NOT_FOUND',0x194);const _0x22e8ab=await Contact_1[_0x520797(0x1a1)][_0x520797(0x191)](_0x363f27);if(!_0x22e8ab)throw new AppError_1[(_0x520797(0x1a1))](_0x520797(0x16a),0x194);let _0x331e1c=null;if(_0x4aa9e4){_0x331e1c=await Queue_1['default'][_0x520797(0x191)](_0x4aa9e4);if(!_0x331e1c)throw new AppError_1[(_0x520797(0x1a1))](_0x520797(0x195),0x194);if(_0x331e1c[_0x520797(0x1a2)]!==_0x43891c)throw new AppError_1[(_0x520797(0x1a1))](_0x520797(0x179),0x193);}if(_0x1810ea[_0x520797(0x1a2)]!==_0x43891c||_0x22e8ab['companyId']!==_0x43891c)throw new AppError_1[(_0x520797(0x1a1))](_0x520797(0x179),0x193);return await(0x0,ForwardMessageService_1['default'])(_0x5b4993,_0x1810ea,_0x22e8ab,_0x331e1c),_0x4af083[_0x520797(0x161)]();};exports[a24_0x2bf8a1(0x16f)]=forward;const send=async(_0x246cb8,_0x599962)=>{const _0x961bf8=a24_0x2bf8a1,{whatsappId:_0x41c783}=_0x246cb8[_0x961bf8(0x1b6)],_0x298317=_0x246cb8[_0x961bf8(0x1a0)],_0x5966fb=_0x246cb8[_0x961bf8(0x18f)];if(_0x298317[_0x961bf8(0x1a6)]===undefined)throw new AppError_1[(_0x961bf8(0x1a1))](_0x961bf8(0x198),0x190);const _0x2346f5=await Whatsapp_1[_0x961bf8(0x1a1)][_0x961bf8(0x191)](_0x41c783);if(!_0x2346f5)throw new AppError_1['default'](_0x961bf8(0x19c),0x194);try{let {number:_0x422e90}=_0x298317;const {body:_0x1caffe,linkPreview:_0x368e25}=_0x298317,_0x119fd9=!!_0x298317[_0x961bf8(0x151)];if(!_0x422e90[_0x961bf8(0x163)]('@')){const _0x1283e5=_0x298317[_0x961bf8(0x1a6)],{companyId:_0x33084d}=_0x2346f5,_0x3d63ee=await(0x0,CheckNumber_1[_0x961bf8(0x1a1)])(_0x1283e5,_0x33084d,_0x2346f5);_0x422e90=_0x3d63ee[_0x961bf8(0x149)][_0x961bf8(0x18c)](/\D/g,'');}return _0x5966fb?await Promise[_0x961bf8(0x155)](_0x5966fb[_0x961bf8(0x17d)](async _0x5d7c29=>{const _0x12b4ef=_0x961bf8;await _0x246cb8['app'][_0x12b4ef(0x192)](_0x12b4ef(0x14b))['messageQueue'][_0x12b4ef(0x157)](_0x12b4ef(0x180),{'whatsappId':_0x41c783,'data':{'number':_0x422e90,'body':_0x5d7c29['originalname'],'mediaPath':_0x5d7c29['path'],'saveOnTicket':_0x119fd9}},{'removeOnComplete':!![],'attempts':0x3});})):_0x246cb8[_0x961bf8(0x168)][_0x961bf8(0x192)]('queues')[_0x961bf8(0x147)][_0x961bf8(0x157)](_0x961bf8(0x180),{'whatsappId':_0x41c783,'data':{'number':_0x422e90,'body':_0x1caffe,'linkPreview':_0x368e25,'saveOnTicket':_0x119fd9}},{'removeOnComplete':![],'attempts':0x3}),_0x599962[_0x961bf8(0x161)]({'mensagem':'Message\x20added\x20to\x20queue'});}catch(_0x2b8827){const _0x5b7df9={'errType':typeof _0x2b8827,'serialized':JSON[_0x961bf8(0x17c)](_0x2b8827),'err':_0x2b8827};_0x2b8827?.[_0x961bf8(0x1b0)]?console['error'](_0x5b7df9,'MessageController.send:\x20'+_0x2b8827[_0x961bf8(0x1b0)]):logger_1[_0x961bf8(0x146)][_0x961bf8(0x15b)](_0x5b7df9,_0x961bf8(0x1a5));throw new AppError_1[(_0x961bf8(0x1a1))](_0x961bf8(0x1b1),0x1f4);}};exports[a24_0x2bf8a1(0x161)]=send;