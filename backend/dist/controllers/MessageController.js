function a30_0x58ff(_0x2f6f14,_0x35443e){const _0x48f340=a30_0x536a();return a30_0x58ff=function(_0x284d63,_0x693e5e){_0x284d63=_0x284d63-0xb2;let _0x536a7e=_0x48f340[_0x284d63];return _0x536a7e;},a30_0x58ff(_0x2f6f14,_0x35443e);}const a30_0x3c7a7f=a30_0x58ff;(function(_0x20fa04,_0x498995){const _0x4a8f12=a30_0x58ff,_0x578eca=_0x20fa04();while(!![]){try{const _0x114e83=-parseInt(_0x4a8f12(0x104))/0x1*(-parseInt(_0x4a8f12(0xc9))/0x2)+parseInt(_0x4a8f12(0xc8))/0x3+-parseInt(_0x4a8f12(0xef))/0x4+parseInt(_0x4a8f12(0xe6))/0x5+-parseInt(_0x4a8f12(0x106))/0x6*(parseInt(_0x4a8f12(0xe9))/0x7)+parseInt(_0x4a8f12(0xc5))/0x8*(parseInt(_0x4a8f12(0xc1))/0x9)+-parseInt(_0x4a8f12(0xfb))/0xa*(parseInt(_0x4a8f12(0x111))/0xb);if(_0x114e83===_0x498995)break;else _0x578eca['push'](_0x578eca['shift']());}catch(_0x37b14d){_0x578eca['push'](_0x578eca['shift']());}}}(a30_0x536a,0x78477));const a30_0x693e5e=(function(){let _0x597851=!![];return function(_0xfd8250,_0x4b7cfb){const _0x62d9b0=_0x597851?function(){const _0x368959=a30_0x58ff;if(_0x4b7cfb){const _0xbff3c0=_0x4b7cfb[_0x368959(0x105)](_0xfd8250,arguments);return _0x4b7cfb=null,_0xbff3c0;}}:function(){};return _0x597851=![],_0x62d9b0;};}()),a30_0x284d63=a30_0x693e5e(this,function(){const _0x2b6888=a30_0x58ff;return a30_0x284d63['toString']()[_0x2b6888(0xf6)](_0x2b6888(0xe4))[_0x2b6888(0x11e)]()['constructor'](a30_0x284d63)['search'](_0x2b6888(0xe4));});a30_0x284d63();'use strict';var __importDefault=this&&this[a30_0x3c7a7f(0x113)]||function(_0x266987){const _0x4721c1=a30_0x3c7a7f;return _0x266987&&_0x266987[_0x4721c1(0xcf)]?_0x266987:{'default':_0x266987};};Object[a30_0x3c7a7f(0xd1)](exports,a30_0x3c7a7f(0xcf),{'value':!![]}),exports[a30_0x3c7a7f(0x115)]=exports[a30_0x3c7a7f(0x110)]=exports[a30_0x3c7a7f(0x101)]=exports[a30_0x3c7a7f(0xbc)]=exports[a30_0x3c7a7f(0xd9)]=exports[a30_0x3c7a7f(0x117)]=exports[a30_0x3c7a7f(0xf0)]=exports[a30_0x3c7a7f(0xfe)]=exports[a30_0x3c7a7f(0xd5)]=void 0x0;const fs_1=__importDefault(require('fs')),AppError_1=__importDefault(require(a30_0x3c7a7f(0xf3))),SetTicketMessagesAsRead_1=__importDefault(require('../helpers/SetTicketMessagesAsRead')),socket_1=require(a30_0x3c7a7f(0x116)),Queue_1=__importDefault(require('../models/Queue')),User_1=__importDefault(require('../models/User')),Whatsapp_1=__importDefault(require('../models/Whatsapp')),ListMessagesService_1=__importDefault(require(a30_0x3c7a7f(0xc4))),ShowTicketService_1=__importDefault(require(a30_0x3c7a7f(0xbf))),DeleteWhatsAppMessage_1=__importDefault(require('../services/WbotServices/DeleteWhatsAppMessage')),SendWhatsAppMedia_1=__importDefault(require('../services/WbotServices/SendWhatsAppMedia')),SendWhatsAppMessage_1=__importDefault(require(a30_0x3c7a7f(0x102))),CheckNumber_1=__importDefault(require('../services/WbotServices/CheckNumber')),EditWhatsAppMessage_1=__importDefault(require(a30_0x3c7a7f(0xe5))),ListAllMessagesService_1=__importDefault(require('../services/MessageServices/ListAllMessagesService')),validator_1=require('validator'),logger_1=require(a30_0x3c7a7f(0xbb)),Message_1=__importDefault(require(a30_0x3c7a7f(0xce))),Contact_1=__importDefault(require('../models/Contact')),Ticket_1=__importDefault(require(a30_0x3c7a7f(0xf8))),ForwardMessageService_1=__importDefault(require('../services/MessageServices/ForwardMessageService')),wbot_1=require(a30_0x3c7a7f(0xc3)),VerifyHandlers_1=require(a30_0x3c7a7f(0xbd)),SendPresenceStatus_1=require('../helpers/SendPresenceStatus'),index=async(_0x2c3b23,_0x1b194c)=>{const _0x145ec0=a30_0x3c7a7f,{ticketId:_0x4d97d8}=_0x2c3b23[_0x145ec0(0xba)],{pageNumber:_0x299b69,markAsRead:_0xf27636}=_0x2c3b23['query'],{companyId:_0x411e33,profile:_0x524670}=_0x2c3b23[_0x145ec0(0xb6)],_0x757647=[];if(_0x524670!==_0x145ec0(0xf4)){const _0x1c5de4=await User_1[_0x145ec0(0xda)][_0x145ec0(0x10c)](_0x2c3b23[_0x145ec0(0xb6)]['id'],{'include':[{'model':Queue_1[_0x145ec0(0xda)],'as':_0x145ec0(0x120)}]});_0x1c5de4[_0x145ec0(0x120)][_0x145ec0(0xf5)](_0x4b2a0c=>{const _0x215e14=_0x145ec0;_0x757647[_0x215e14(0x107)](_0x4b2a0c['id']);});}const {count:_0x4972d0,messages:_0x16263b,ticket:_0x501fe6,hasMore:_0x20b0ca}=await(0x0,ListMessagesService_1[_0x145ec0(0xda)])({'pageNumber':_0x299b69,'ticketId':_0x4d97d8,'companyId':_0x411e33,'queues':_0x757647});return _0x501fe6[_0x145ec0(0x11f)]===_0x145ec0(0xc2)&&_0xf27636==='true'&&(0x0,SetTicketMessagesAsRead_1[_0x145ec0(0xda)])(_0x501fe6),_0x1b194c[_0x145ec0(0x114)]({'count':_0x4972d0,'messages':_0x16263b,'ticket':_0x501fe6,'hasMore':_0x20b0ca});};exports['index']=index;const store=async(_0x217563,_0x59da96)=>{const _0x40eeaa=a30_0x3c7a7f,{ticketId:_0x46f4ed}=_0x217563['params'],{body:_0xe01e35,quotedMsg:_0x325234}=_0x217563[_0x40eeaa(0x119)],_0x52e908=_0x217563[_0x40eeaa(0xc6)],{companyId:_0x4b6df6}=_0x217563[_0x40eeaa(0xb6)],_0x4c5b3=Number(_0x217563[_0x40eeaa(0xb6)]['id'])||null,_0x531b5b=await(0x0,ShowTicketService_1[_0x40eeaa(0xda)])(_0x46f4ed,_0x4b6df6),{channel:_0x22f7d7}=_0x531b5b;_0x22f7d7===_0x40eeaa(0xc2)&&(0x0,SetTicketMessagesAsRead_1[_0x40eeaa(0xda)])(_0x531b5b);if(_0x52e908)_0x22f7d7===_0x40eeaa(0xc2)&&await Promise['all'](_0x52e908[_0x40eeaa(0xeb)](async _0x8c4e2a=>{const _0x24b209=_0x40eeaa;await(0x0,SendWhatsAppMedia_1[_0x24b209(0xda)])({'media':_0x8c4e2a,'ticket':_0x531b5b}),fs_1['default'][_0x24b209(0xfc)](_0x8c4e2a[_0x24b209(0xec)]);}));else _0x22f7d7===_0x40eeaa(0xc2)&&await(0x0,SendWhatsAppMessage_1[_0x40eeaa(0xda)])({'body':_0xe01e35,'ticket':_0x531b5b,'userId':_0x4c5b3,'quotedMsg':_0x325234});return _0x59da96[_0x40eeaa(0x115)]();};exports[a30_0x3c7a7f(0xfe)]=store;const getAll=async(_0x2a0cd3,_0x4d5eb7)=>{const _0x4160bb=a30_0x3c7a7f,_0x4b7243=_0x2a0cd3[_0x4160bb(0xb9)][_0x4160bb(0xd0)],_0x4c7ffb=_0x2a0cd3[_0x4160bb(0xb9)][_0x4160bb(0xe2)],_0x40e6d6=(0x0,validator_1[_0x4160bb(0xf2)])(_0x2a0cd3[_0x4160bb(0xb9)][_0x4160bb(0xfa)]),{companyId:_0x7b95fa}=_0x2a0cd3[_0x4160bb(0xb6)],{count:_0x4fb225}=await(0x0,ListAllMessagesService_1['default'])({'companyId':_0x7b95fa,'fromMe':_0x40e6d6,'dateStart':_0x4b7243,'dateEnd':_0x4c7ffb});return _0x4d5eb7[_0x4160bb(0x114)]({'count':_0x4fb225});};exports[a30_0x3c7a7f(0xf0)]=getAll;const react=async(_0xbffb23,_0x4a0f0f)=>{const _0x270eb6=a30_0x3c7a7f,{messageId:_0x4da3c7}=_0xbffb23[_0x270eb6(0xba)],{companyId:_0xc17433}=_0xbffb23['user'],_0x265fac=Number(_0xbffb23[_0x270eb6(0xb6)]['id'])||null,{ticketId:_0x398fc9,emoji:_0x1a7d76}=_0xbffb23[_0x270eb6(0x119)],_0x8797d6=await Message_1[_0x270eb6(0xda)]['findOne']({'where':{'id':_0x4da3c7,'ticketId':_0x398fc9}});if(!_0x8797d6)throw new AppError_1[(_0x270eb6(0xda))]('ERR_MESSAGE_NOT_FOUND',0x194);const _0x56aa77=await(0x0,ShowTicketService_1['default'])(_0x398fc9,_0xc17433),_0xd4b781=await(0x0,wbot_1['getWbot'])(_0x56aa77[_0x270eb6(0xe8)]);if(!_0xd4b781)throw new AppError_1[(_0x270eb6(0xda))](_0x270eb6(0x11c),0x1f4);const _0x3983d5=JSON[_0x270eb6(0x10e)](_0x8797d6[_0x270eb6(0xd7)]),_0x1b36f6=await _0xd4b781['sendMessage'](_0x56aa77['contact'][_0x270eb6(0x11a)]||_0x56aa77[_0x270eb6(0xcc)][_0x270eb6(0x108)]+(_0x56aa77[_0x270eb6(0xde)]?_0x270eb6(0x10d):_0x56aa77[_0x270eb6(0xcc)]['number'][_0x270eb6(0xdc)]>0xd?_0x270eb6(0xb7):'@s.whatsapp.net'),{'react':{'text':_0x1a7d76,'key':_0x3983d5['key']}});if(!_0x1b36f6)throw new AppError_1[(_0x270eb6(0xda))]('ERR_WHATSAPP_MESSAGE_NOT_SENT',0x1f4);return await(0x0,VerifyHandlers_1[_0x270eb6(0xe1)])(_0x1b36f6,_0x56aa77,_0x56aa77[_0x270eb6(0xcc)]),_0x4a0f0f['send']();};exports['react']=react;function a30_0x536a(){const _0x3de912=['app','stringify','typing','../services/WbotServices/SendWhatsAppMessage','all','13sqobDp','apply','708864VMfFlU','push','number','Ticket\x20not\x20found','SendTypingStatus','replace','findByPk','@g.us','parse','-appMessage','forward','37004CukkKc','find','__importDefault','json','send','../libs/socket','react','getWbot','body','remoteJid','message','ERR_WHATSAPP_NOT_FOUND','saveOnTicket','toString','channel','queues','ERR_CONTACT_NOT_FOUND','add','Message\x20added\x20to\x20queue','SendPausedStatus','user','@lid','ERR_ACCESS_DENIED','query','params','../utils/logger','remove','../services/WbotServices/VerifyHandlers','logger','../services/TicketServices/ShowTicketService','TicketId\x20is\x20required','468rLHQdo','whatsapp','../libs/wbot','../services/MessageServices/ListMessagesService','98128KRAIZQ','files','SendMessage','2285706CoWYTX','8754HZJMXS','ERR_QUEUE_NOT_FOUND','getIO','contact','findOne','../models/Message','__esModule','dateStart','defineProperty','messageQueue','get','ERR_INTERNAL_ERROR','index','ERR_MESSAGE_NOT_FOUND','dataJson','Status\x20','edit','default','s.whatsapp.net','length','jid','isGroup','\x20enviado\x20com\x20sucesso','status','verifyMessage','dateEnd','ticketId','(((.+)+)+)+$','../services/WbotServices/EditWhatsAppMessage','1660505wsIvau','true','whatsappId','28UftgoE','MessageController.send:\x20Failed\x20to\x20put\x20message\x20on\x20queue','map','path','error','g.us','1544708iFYTxB','getAll','lid','toBoolean','../errors/AppError','admin','forEach','search','update','../models/Ticket','companyId','fromMe','1300mGzVSM','unlinkSync','profile','store'];a30_0x536a=function(){return _0x3de912;};return a30_0x536a();}const edit=async(_0x206d73,_0x3b568a)=>{const _0x2b1847=a30_0x3c7a7f,{messageId:_0x5a9c40}=_0x206d73['params'],{companyId:_0x2c5dd2}=_0x206d73[_0x2b1847(0xb6)],_0x37a8ec=Number(_0x206d73[_0x2b1847(0xb6)]['id'])||null,{body:_0x191169}=_0x206d73[_0x2b1847(0x119)],{ticketId:_0x22c86a,message:_0x165448}=await(0x0,EditWhatsAppMessage_1[_0x2b1847(0xda)])({'messageId':_0x5a9c40,'companyId':_0x2c5dd2,'userId':_0x37a8ec,'body':_0x191169}),_0x559608=(0x0,socket_1[_0x2b1847(0xcb)])();return _0x559608['to'](_0x22c86a[_0x2b1847(0x11e)]())['emit']('company-'+_0x2c5dd2+_0x2b1847(0x10f),{'action':_0x2b1847(0xf7),'message':_0x165448}),_0x3b568a['send']();};exports[a30_0x3c7a7f(0xd9)]=edit;const remove=async(_0x424a11,_0x4cd226)=>{const _0x314c2c=a30_0x3c7a7f,{messageId:_0x1d43f9}=_0x424a11[_0x314c2c(0xba)],{companyId:_0x4d11b4}=_0x424a11[_0x314c2c(0xb6)],_0xa743e5=await(0x0,DeleteWhatsAppMessage_1[_0x314c2c(0xda)])(_0x1d43f9),_0x3c3b29=(0x0,socket_1[_0x314c2c(0xcb)])();return _0x3c3b29['to'](_0xa743e5[_0x314c2c(0xe3)]['toString']())['emit']('company-'+_0x4d11b4+_0x314c2c(0x10f),{'action':'update','message':_0xa743e5}),_0x4cd226[_0x314c2c(0x115)]();};exports[a30_0x3c7a7f(0xbc)]=remove;const typing=async(_0x37aebf,_0x389030)=>{const _0x3f900e=a30_0x3c7a7f,{ticketId:_0x3467ca}=_0x37aebf['params'],{companyId:_0x5913ea}=_0x37aebf[_0x3f900e(0xb6)],{status:_0x18c3f0}=_0x37aebf['query'];if(!_0x3467ca)return _0x389030['status'](0x190)['send'](_0x3f900e(0xc0));const _0x2c0d72=await(0x0,ShowTicketService_1[_0x3f900e(0xda)])(_0x3467ca,_0x5913ea);if(!_0x2c0d72)return _0x389030[_0x3f900e(0xe0)](0x194)[_0x3f900e(0x115)](_0x3f900e(0x109));let _0x56d076=(0x0,wbot_1[_0x3f900e(0x118)])(_0x2c0d72[_0x3f900e(0xe8)]);return _0x18c3f0==_0x3f900e(0xe7)?await(0x0,SendPresenceStatus_1[_0x3f900e(0x10a)])(_0x56d076,_0x2c0d72[_0x3f900e(0xcc)][_0x3f900e(0x11a)]||_0x2c0d72[_0x3f900e(0xcc)][_0x3f900e(0x108)]+'@'+(_0x2c0d72[_0x3f900e(0xde)]?_0x3f900e(0xee):_0x2c0d72[_0x3f900e(0xcc)][_0x3f900e(0x108)]['length']>0xd?'lid':'s.whatsapp.net')):await(0x0,SendPresenceStatus_1[_0x3f900e(0xb5)])(_0x56d076,_0x2c0d72[_0x3f900e(0xcc)][_0x3f900e(0x11a)]||_0x2c0d72[_0x3f900e(0xcc)][_0x3f900e(0x108)]+'@'+(_0x2c0d72[_0x3f900e(0xde)]?'g.us':_0x2c0d72[_0x3f900e(0xcc)][_0x3f900e(0x108)]['length']>0xd?_0x3f900e(0xf1):_0x3f900e(0xdb))),_0x389030['status'](0xc8)[_0x3f900e(0x115)](_0x3f900e(0xd8)+_0x18c3f0+_0x3f900e(0xdf));};exports[a30_0x3c7a7f(0x101)]=typing;const forward=async(_0x5733aa,_0x5dc362)=>{const _0x3ec20d=a30_0x3c7a7f,{contactId:_0x2df141,ticketId:_0x3af30a,messageId:_0x3268e0,queueId:_0x2d5ce6}=_0x5733aa[_0x3ec20d(0x119)],{companyId:_0xcc1326}=_0x5733aa[_0x3ec20d(0xb6)],_0x4345ed=await User_1['default'][_0x3ec20d(0x10c)](_0x5733aa[_0x3ec20d(0xb6)]['id'],{'include':[{'model':Queue_1[_0x3ec20d(0xda)],'as':_0x3ec20d(0x120)}]});if(_0x2d5ce6&&_0x4345ed[_0x3ec20d(0xfd)]!==_0x3ec20d(0xf4)&&!_0x4345ed[_0x3ec20d(0x120)][_0x3ec20d(0x112)](_0x4c254a=>_0x4c254a['id']===_0x2d5ce6))throw new AppError_1[(_0x3ec20d(0xda))]('ERR_FORBIDDEN',0x193);const _0xa3e19a=await Message_1[_0x3ec20d(0xda)][_0x3ec20d(0xcd)]({'where':{'id':_0x3268e0,'ticketId':_0x3af30a},'include':[{'model':Ticket_1[_0x3ec20d(0xda)],'as':'ticket','include':[{'model':Whatsapp_1[_0x3ec20d(0xda)],'as':_0x3ec20d(0xc2)}]},{'model':Contact_1[_0x3ec20d(0xda)],'as':'contact'}]});if(!_0xa3e19a)throw new AppError_1[(_0x3ec20d(0xda))](_0x3ec20d(0xd6),0x194);const _0x163876=await Contact_1[_0x3ec20d(0xda)]['findByPk'](_0x2df141);if(!_0x163876)throw new AppError_1['default'](_0x3ec20d(0xb2),0x194);let _0x2c0395=null;if(_0x2d5ce6){_0x2c0395=await Queue_1[_0x3ec20d(0xda)]['findByPk'](_0x2d5ce6);if(!_0x2c0395)throw new AppError_1[(_0x3ec20d(0xda))](_0x3ec20d(0xca),0x194);if(_0x2c0395[_0x3ec20d(0xf9)]!==_0xcc1326)throw new AppError_1[(_0x3ec20d(0xda))](_0x3ec20d(0xb8),0x193);}if(_0xa3e19a[_0x3ec20d(0xf9)]!==_0xcc1326||_0x163876[_0x3ec20d(0xf9)]!==_0xcc1326)throw new AppError_1[(_0x3ec20d(0xda))](_0x3ec20d(0xb8),0x193);return await(0x0,ForwardMessageService_1[_0x3ec20d(0xda)])(_0x4345ed,_0xa3e19a,_0x163876,_0x2c0395),_0x5dc362[_0x3ec20d(0x115)]();};exports[a30_0x3c7a7f(0x110)]=forward;const send=async(_0x6ea6d7,_0x5071e1)=>{const _0x3b0984=a30_0x3c7a7f,{whatsappId:_0x3eda98}=_0x6ea6d7[_0x3b0984(0xba)],_0x13c18b=_0x6ea6d7[_0x3b0984(0x119)],_0x49302a=_0x6ea6d7[_0x3b0984(0xc6)];if(_0x13c18b[_0x3b0984(0x108)]===undefined)throw new AppError_1[(_0x3b0984(0xda))]('ERR_SYNTAX',0x190);const _0x4dfb76=await Whatsapp_1[_0x3b0984(0xda)][_0x3b0984(0x10c)](_0x3eda98);if(!_0x4dfb76)throw new AppError_1[(_0x3b0984(0xda))](_0x3b0984(0x11c),0x194);try{let {number:_0x4ad43a}=_0x13c18b;const {body:_0xd1932e,linkPreview:_0x29601b}=_0x13c18b,_0xe61420=!!_0x13c18b[_0x3b0984(0x11d)];if(!_0x4ad43a['includes']('@')){const _0x5744e2=_0x13c18b[_0x3b0984(0x108)],{companyId:_0x1e335f}=_0x4dfb76,_0x380a10=await(0x0,CheckNumber_1[_0x3b0984(0xda)])(_0x5744e2,_0x1e335f,_0x4dfb76);_0x4ad43a=_0x380a10[_0x3b0984(0xdd)][_0x3b0984(0x10b)](/\D/g,'');}return _0x49302a?await Promise[_0x3b0984(0x103)](_0x49302a[_0x3b0984(0xeb)](async _0x16084a=>{const _0x3c6285=_0x3b0984;await _0x6ea6d7['app'][_0x3c6285(0xd3)](_0x3c6285(0x120))['messageQueue']['add'](_0x3c6285(0xc7),{'whatsappId':_0x3eda98,'data':{'number':_0x4ad43a,'body':_0x16084a['originalname'],'mediaPath':_0x16084a[_0x3c6285(0xec)],'saveOnTicket':_0xe61420}},{'removeOnComplete':!![],'attempts':0x3});})):_0x6ea6d7[_0x3b0984(0xff)][_0x3b0984(0xd3)]('queues')[_0x3b0984(0xd2)][_0x3b0984(0xb3)]('SendMessage',{'whatsappId':_0x3eda98,'data':{'number':_0x4ad43a,'body':_0xd1932e,'linkPreview':_0x29601b,'saveOnTicket':_0xe61420}},{'removeOnComplete':![],'attempts':0x3}),_0x5071e1[_0x3b0984(0x115)]({'mensagem':_0x3b0984(0xb4)});}catch(_0x3092ba){const _0x435ab3={'errType':typeof _0x3092ba,'serialized':JSON[_0x3b0984(0x100)](_0x3092ba),'err':_0x3092ba};_0x3092ba?.[_0x3b0984(0x11b)]?console[_0x3b0984(0xed)](_0x435ab3,'MessageController.send:\x20'+_0x3092ba[_0x3b0984(0x11b)]):logger_1[_0x3b0984(0xbe)][_0x3b0984(0xed)](_0x435ab3,_0x3b0984(0xea));throw new AppError_1[(_0x3b0984(0xda))](_0x3b0984(0xd4),0x1f4);}};exports[a30_0x3c7a7f(0x115)]=send;