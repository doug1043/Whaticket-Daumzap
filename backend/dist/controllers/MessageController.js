const a24_0x1230ed=a24_0x42bb;(function(_0x17d459,_0x4db10a){const _0x8b19cb=a24_0x42bb,_0x3919d0=_0x17d459();while(!![]){try{const _0x3b3b5e=parseInt(_0x8b19cb(0x21d))/0x1+-parseInt(_0x8b19cb(0x20d))/0x2*(parseInt(_0x8b19cb(0x1d4))/0x3)+-parseInt(_0x8b19cb(0x235))/0x4+-parseInt(_0x8b19cb(0x1d5))/0x5*(-parseInt(_0x8b19cb(0x1df))/0x6)+parseInt(_0x8b19cb(0x1d0))/0x7+-parseInt(_0x8b19cb(0x1f6))/0x8*(parseInt(_0x8b19cb(0x231))/0x9)+parseInt(_0x8b19cb(0x1fc))/0xa*(parseInt(_0x8b19cb(0x202))/0xb);if(_0x3b3b5e===_0x4db10a)break;else _0x3919d0['push'](_0x3919d0['shift']());}catch(_0x479af4){_0x3919d0['push'](_0x3919d0['shift']());}}}(a24_0x43e2,0xa1cb2));const a24_0x20ca71=(function(){let _0x46947a=!![];return function(_0x17ae96,_0x20427a){const _0x250a34=_0x46947a?function(){const _0x536f4b=a24_0x42bb;if(_0x20427a){const _0x3fad8c=_0x20427a[_0x536f4b(0x1c9)](_0x17ae96,arguments);return _0x20427a=null,_0x3fad8c;}}:function(){};return _0x46947a=![],_0x250a34;};}()),a24_0x4489b0=a24_0x20ca71(this,function(){const _0x1d624f=a24_0x42bb;return a24_0x4489b0[_0x1d624f(0x220)]()[_0x1d624f(0x22d)](_0x1d624f(0x1d1))[_0x1d624f(0x220)]()[_0x1d624f(0x1c5)](a24_0x4489b0)[_0x1d624f(0x22d)](_0x1d624f(0x1d1));});a24_0x4489b0();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x54869c){return _0x54869c&&_0x54869c['__esModule']?_0x54869c:{'default':_0x54869c};};Object[a24_0x1230ed(0x203)](exports,'__esModule',{'value':!![]}),exports[a24_0x1230ed(0x236)]=exports[a24_0x1230ed(0x20b)]=exports[a24_0x1230ed(0x1e6)]=exports['remove']=exports[a24_0x1230ed(0x22b)]=exports[a24_0x1230ed(0x1f9)]=exports['getAll']=exports['store']=exports[a24_0x1230ed(0x234)]=void 0x0;const fs_1=__importDefault(require('fs')),AppError_1=__importDefault(require('../errors/AppError')),SetTicketMessagesAsRead_1=__importDefault(require(a24_0x1230ed(0x215))),socket_1=require(a24_0x1230ed(0x1f8)),Queue_1=__importDefault(require(a24_0x1230ed(0x1f7))),User_1=__importDefault(require(a24_0x1230ed(0x1d8))),Whatsapp_1=__importDefault(require(a24_0x1230ed(0x1dd))),ListMessagesService_1=__importDefault(require(a24_0x1230ed(0x210))),ShowTicketService_1=__importDefault(require(a24_0x1230ed(0x201))),DeleteWhatsAppMessage_1=__importDefault(require('../services/WbotServices/DeleteWhatsAppMessage')),SendWhatsAppMedia_1=__importDefault(require('../services/WbotServices/SendWhatsAppMedia')),SendWhatsAppMessage_1=__importDefault(require(a24_0x1230ed(0x223))),CheckNumber_1=__importDefault(require(a24_0x1230ed(0x22c))),EditWhatsAppMessage_1=__importDefault(require(a24_0x1230ed(0x1e1))),ListAllMessagesService_1=__importDefault(require('../services/MessageServices/ListAllMessagesService')),validator_1=require(a24_0x1230ed(0x1d7)),logger_1=require('../utils/logger'),Message_1=__importDefault(require(a24_0x1230ed(0x217))),Contact_1=__importDefault(require(a24_0x1230ed(0x22f))),Ticket_1=__importDefault(require(a24_0x1230ed(0x1f1))),ForwardMessageService_1=__importDefault(require(a24_0x1230ed(0x1e9))),wbot_1=require(a24_0x1230ed(0x1ec)),VerifyHandlers_1=require('../services/WbotServices/VerifyHandlers'),SendPresenceStatus_1=require(a24_0x1230ed(0x21e)),index=async(_0x1fef6a,_0xec04ae)=>{const _0x4231d1=a24_0x1230ed,{ticketId:_0x7e6aa3}=_0x1fef6a[_0x4231d1(0x226)],{pageNumber:_0x47c061,markAsRead:_0x2f1cc6}=_0x1fef6a['query'],{companyId:_0xfd950b,profile:_0x2348fe}=_0x1fef6a[_0x4231d1(0x208)],_0x5d75d4=[];if(_0x2348fe!==_0x4231d1(0x1f3)){const _0x2a30f9=await User_1[_0x4231d1(0x1da)][_0x4231d1(0x1ca)](_0x1fef6a[_0x4231d1(0x208)]['id'],{'include':[{'model':Queue_1[_0x4231d1(0x1da)],'as':'queues'}]});_0x2a30f9['queues'][_0x4231d1(0x1d3)](_0x410304=>{const _0x17823b=_0x4231d1;_0x5d75d4[_0x17823b(0x1e5)](_0x410304['id']);});}const {count:_0x4c34ce,messages:_0x47c839,ticket:_0xa54d4a,hasMore:_0x3e5e5e}=await(0x0,ListMessagesService_1[_0x4231d1(0x1da)])({'pageNumber':_0x47c061,'ticketId':_0x7e6aa3,'companyId':_0xfd950b,'queues':_0x5d75d4});return _0xa54d4a[_0x4231d1(0x206)]===_0x4231d1(0x221)&&_0x2f1cc6===_0x4231d1(0x1d2)&&(0x0,SetTicketMessagesAsRead_1['default'])(_0xa54d4a),_0xec04ae[_0x4231d1(0x1eb)]({'count':_0x4c34ce,'messages':_0x47c839,'ticket':_0xa54d4a,'hasMore':_0x3e5e5e});};exports[a24_0x1230ed(0x234)]=index;const store=async(_0x2e4c19,_0x4a11ae)=>{const _0x498ccf=a24_0x1230ed,{ticketId:_0x4ae3ac}=_0x2e4c19[_0x498ccf(0x226)],{body:_0x587370,quotedMsg:_0x32ef48}=_0x2e4c19[_0x498ccf(0x1db)],_0x157fed=_0x2e4c19[_0x498ccf(0x1ce)],{companyId:_0x4388a7}=_0x2e4c19[_0x498ccf(0x208)],_0x46a5a2=Number(_0x2e4c19['user']['id'])||null,_0x49928b=await(0x0,ShowTicketService_1['default'])(_0x4ae3ac,_0x4388a7),{channel:_0x28fe92}=_0x49928b;_0x28fe92===_0x498ccf(0x221)&&(0x0,SetTicketMessagesAsRead_1[_0x498ccf(0x1da)])(_0x49928b);if(_0x157fed)_0x28fe92===_0x498ccf(0x221)&&await Promise[_0x498ccf(0x1ff)](_0x157fed[_0x498ccf(0x216)](async _0xef194a=>{const _0x40e201=_0x498ccf;await(0x0,SendWhatsAppMedia_1[_0x40e201(0x1da)])({'media':_0xef194a,'ticket':_0x49928b}),fs_1[_0x40e201(0x1da)][_0x40e201(0x1e2)](_0xef194a[_0x40e201(0x1ed)]);}));else _0x28fe92===_0x498ccf(0x221)&&await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x587370,'ticket':_0x49928b,'userId':_0x46a5a2,'quotedMsg':_0x32ef48});return _0x4a11ae[_0x498ccf(0x236)]();};exports['store']=store;function a24_0x43e2(){const _0xed0837=['ERR_CONTACT_NOT_FOUND','16TRLXeN','../models/Queue','../libs/socket','react','ERR_QUEUE_NOT_FOUND','toBoolean','2672290SdTuAe','-appMessage','includes','all','findOne','../services/TicketServices/ShowTicketService','77OBSvBx','defineProperty','ERR_WHATSAPP_NOT_FOUND','message','channel','lid','user','Status\x20','SendMessage','forward','s.whatsapp.net','4ESWxkN','whatsappId','remove','../services/MessageServices/ListMessagesService','SendTypingStatus','status','companyId','jid','../helpers/SetTicketMessagesAsRead','map','../models/Message','originalname','query','update','@g.us','emit','541895YlPxcB','../helpers/SendPresenceStatus','ERR_WHATSAPP_MESSAGE_NOT_SENT','toString','whatsapp','messageQueue','../services/WbotServices/SendWhatsAppMessage','ERR_SYNTAX','remoteJid','params','MessageController.send:\x20Failed\x20to\x20put\x20message\x20on\x20queue','ERR_MESSAGE_NOT_FOUND','getAll','dataJson','edit','../services/WbotServices/CheckNumber','search','\x20enviado\x20com\x20sucesso','../models/Contact','queues','5222673XejAuX','profile','contact','index','4860352iZWWzy','send','dateStart','fromMe','constructor','find','getWbot','MessageController.send:\x20','apply','findByPk','app','sendMessage','TicketId\x20is\x20required','files','verifyMessage','7225743jbVfBZ','(((.+)+)+)+$','true','forEach','694938BfAAZJ','1445kHORSP','logger','validator','../models/User','ERR_INTERNAL_ERROR','default','body','isGroup','../models/Whatsapp','@s.whatsapp.net','1182BidSsa','get','../services/WbotServices/EditWhatsAppMessage','unlinkSync','getIO','ERR_ACCESS_DENIED','push','typing','parse','length','../services/MessageServices/ForwardMessageService','dateEnd','json','../libs/wbot','path','ticketId','SendPausedStatus','error','../models/Ticket','number','admin','add'];a24_0x43e2=function(){return _0xed0837;};return a24_0x43e2();}const getAll=async(_0xf75d49,_0x420b95)=>{const _0x2f75e6=a24_0x1230ed,_0x4fdc28=_0xf75d49[_0x2f75e6(0x219)][_0x2f75e6(0x237)],_0x39f8e3=_0xf75d49['query'][_0x2f75e6(0x1ea)],_0x11d2f9=(0x0,validator_1[_0x2f75e6(0x1fb)])(_0xf75d49['query'][_0x2f75e6(0x238)]),{companyId:_0x57ff34}=_0xf75d49['user'],{count:_0x432871}=await(0x0,ListAllMessagesService_1[_0x2f75e6(0x1da)])({'companyId':_0x57ff34,'fromMe':_0x11d2f9,'dateStart':_0x4fdc28,'dateEnd':_0x39f8e3});return _0x420b95[_0x2f75e6(0x1eb)]({'count':_0x432871});};exports[a24_0x1230ed(0x229)]=getAll;const react=async(_0x542f24,_0xe2d5cd)=>{const _0x408133=a24_0x1230ed,{messageId:_0x519bd0}=_0x542f24['params'],{companyId:_0x2322c1}=_0x542f24[_0x408133(0x208)],_0x20d38f=Number(_0x542f24[_0x408133(0x208)]['id'])||null,{ticketId:_0x543341,emoji:_0x9f5f81}=_0x542f24[_0x408133(0x1db)],_0x688ba3=await Message_1[_0x408133(0x1da)][_0x408133(0x200)]({'where':{'id':_0x519bd0,'ticketId':_0x543341}});if(!_0x688ba3)throw new AppError_1[(_0x408133(0x1da))](_0x408133(0x228),0x194);const _0x2febd5=await(0x0,ShowTicketService_1['default'])(_0x543341,_0x2322c1),_0xa1eb37=await(0x0,wbot_1[_0x408133(0x1c7)])(_0x2febd5[_0x408133(0x20e)]);if(!_0xa1eb37)throw new AppError_1[(_0x408133(0x1da))]('ERR_WHATSAPP_NOT_FOUND',0x1f4);const _0x1065b1=JSON[_0x408133(0x1e7)](_0x688ba3[_0x408133(0x22a)]),_0x63f6a2=await _0xa1eb37[_0x408133(0x1cc)](_0x2febd5[_0x408133(0x233)]['remoteJid']||_0x2febd5[_0x408133(0x233)]['number']+(_0x2febd5[_0x408133(0x1dc)]?_0x408133(0x21b):_0x2febd5[_0x408133(0x233)][_0x408133(0x1f2)][_0x408133(0x1e8)]>0xd?'@lid':_0x408133(0x1de)),{'react':{'text':_0x9f5f81,'key':_0x1065b1['key']}});if(!_0x63f6a2)throw new AppError_1['default'](_0x408133(0x21f),0x1f4);return await(0x0,VerifyHandlers_1[_0x408133(0x1cf)])(_0x63f6a2,_0x2febd5,_0x2febd5[_0x408133(0x233)]),_0xe2d5cd['send']();};exports[a24_0x1230ed(0x1f9)]=react;const edit=async(_0x5758b8,_0x4095ce)=>{const _0x435dc9=a24_0x1230ed,{messageId:_0x5b3e1b}=_0x5758b8[_0x435dc9(0x226)],{companyId:_0x49bf07}=_0x5758b8[_0x435dc9(0x208)],_0x1cb2e5=Number(_0x5758b8[_0x435dc9(0x208)]['id'])||null,{body:_0x598632}=_0x5758b8[_0x435dc9(0x1db)],{ticketId:_0x1942c5,message:_0x1ee475}=await(0x0,EditWhatsAppMessage_1[_0x435dc9(0x1da)])({'messageId':_0x5b3e1b,'companyId':_0x49bf07,'userId':_0x1cb2e5,'body':_0x598632}),_0x3c9ba6=(0x0,socket_1['getIO'])();return _0x3c9ba6['to'](_0x1942c5[_0x435dc9(0x220)]())[_0x435dc9(0x21c)]('company-'+_0x49bf07+_0x435dc9(0x1fd),{'action':_0x435dc9(0x21a),'message':_0x1ee475}),_0x4095ce[_0x435dc9(0x236)]();};function a24_0x42bb(_0xdbf3b7,_0x340459){const _0x410fc3=a24_0x43e2();return a24_0x42bb=function(_0x4489b0,_0x20ca71){_0x4489b0=_0x4489b0-0x1c5;let _0x43e29c=_0x410fc3[_0x4489b0];return _0x43e29c;},a24_0x42bb(_0xdbf3b7,_0x340459);}exports[a24_0x1230ed(0x22b)]=edit;const remove=async(_0x5eb050,_0x3c53d7)=>{const _0xf9cf=a24_0x1230ed,{messageId:_0x15dfc0}=_0x5eb050[_0xf9cf(0x226)],{companyId:_0x4e945b}=_0x5eb050['user'],_0x364380=await(0x0,DeleteWhatsAppMessage_1[_0xf9cf(0x1da)])(_0x15dfc0),_0x4d5a29=(0x0,socket_1[_0xf9cf(0x1e3)])();return _0x4d5a29['to'](_0x364380[_0xf9cf(0x1ee)][_0xf9cf(0x220)]())['emit']('company-'+_0x4e945b+'-appMessage',{'action':'update','message':_0x364380}),_0x3c53d7['send']();};exports[a24_0x1230ed(0x20f)]=remove;const typing=async(_0x3ce348,_0xd4fbfb)=>{const _0x5ccaeb=a24_0x1230ed,{ticketId:_0x3d7cc2}=_0x3ce348[_0x5ccaeb(0x226)],{companyId:_0x120f10}=_0x3ce348[_0x5ccaeb(0x208)],{status:_0xde92f}=_0x3ce348[_0x5ccaeb(0x219)];if(!_0x3d7cc2)return _0xd4fbfb[_0x5ccaeb(0x212)](0x190)[_0x5ccaeb(0x236)](_0x5ccaeb(0x1cd));const _0x16766b=await(0x0,ShowTicketService_1[_0x5ccaeb(0x1da)])(_0x3d7cc2,_0x120f10);if(!_0x16766b)return _0xd4fbfb[_0x5ccaeb(0x212)](0x194)[_0x5ccaeb(0x236)]('Ticket\x20not\x20found');let _0x111f1c=(0x0,wbot_1[_0x5ccaeb(0x1c7)])(_0x16766b[_0x5ccaeb(0x20e)]);return _0xde92f==_0x5ccaeb(0x1d2)?await(0x0,SendPresenceStatus_1[_0x5ccaeb(0x211)])(_0x111f1c,_0x16766b['contact'][_0x5ccaeb(0x225)]||_0x16766b['contact']['number']+'@'+(_0x16766b['isGroup']?'g.us':_0x16766b[_0x5ccaeb(0x233)][_0x5ccaeb(0x1f2)][_0x5ccaeb(0x1e8)]>0xd?_0x5ccaeb(0x207):_0x5ccaeb(0x20c))):await(0x0,SendPresenceStatus_1[_0x5ccaeb(0x1ef)])(_0x111f1c,_0x16766b['contact'][_0x5ccaeb(0x225)]||_0x16766b[_0x5ccaeb(0x233)]['number']+'@'+(_0x16766b[_0x5ccaeb(0x1dc)]?'g.us':_0x16766b['contact']['number']['length']>0xd?_0x5ccaeb(0x207):'s.whatsapp.net')),_0xd4fbfb[_0x5ccaeb(0x212)](0xc8)[_0x5ccaeb(0x236)](_0x5ccaeb(0x209)+_0xde92f+_0x5ccaeb(0x22e));};exports['typing']=typing;const forward=async(_0x4c3e3a,_0x5ec0ca)=>{const _0x5af74f=a24_0x1230ed,{contactId:_0x323b68,ticketId:_0x534081,messageId:_0x28791e,queueId:_0x10cd0d}=_0x4c3e3a[_0x5af74f(0x1db)],{companyId:_0xba436b}=_0x4c3e3a[_0x5af74f(0x208)],_0xd6ae07=await User_1[_0x5af74f(0x1da)]['findByPk'](_0x4c3e3a[_0x5af74f(0x208)]['id'],{'include':[{'model':Queue_1['default'],'as':_0x5af74f(0x230)}]});if(_0x10cd0d&&_0xd6ae07[_0x5af74f(0x232)]!==_0x5af74f(0x1f3)&&!_0xd6ae07[_0x5af74f(0x230)][_0x5af74f(0x1c6)](_0x3db26e=>_0x3db26e['id']===_0x10cd0d))throw new AppError_1['default']('ERR_FORBIDDEN',0x193);const _0x28b8df=await Message_1[_0x5af74f(0x1da)][_0x5af74f(0x200)]({'where':{'id':_0x28791e,'ticketId':_0x534081},'include':[{'model':Ticket_1[_0x5af74f(0x1da)],'as':'ticket','include':[{'model':Whatsapp_1[_0x5af74f(0x1da)],'as':_0x5af74f(0x221)}]},{'model':Contact_1[_0x5af74f(0x1da)],'as':_0x5af74f(0x233)}]});if(!_0x28b8df)throw new AppError_1[(_0x5af74f(0x1da))](_0x5af74f(0x228),0x194);const _0x3913d3=await Contact_1['default']['findByPk'](_0x323b68);if(!_0x3913d3)throw new AppError_1[(_0x5af74f(0x1da))](_0x5af74f(0x1f5),0x194);let _0x5a2fde=null;if(_0x10cd0d){_0x5a2fde=await Queue_1[_0x5af74f(0x1da)][_0x5af74f(0x1ca)](_0x10cd0d);if(!_0x5a2fde)throw new AppError_1[(_0x5af74f(0x1da))](_0x5af74f(0x1fa),0x194);if(_0x5a2fde['companyId']!==_0xba436b)throw new AppError_1[(_0x5af74f(0x1da))](_0x5af74f(0x1e4),0x193);}if(_0x28b8df['companyId']!==_0xba436b||_0x3913d3[_0x5af74f(0x213)]!==_0xba436b)throw new AppError_1['default'](_0x5af74f(0x1e4),0x193);return await(0x0,ForwardMessageService_1['default'])(_0xd6ae07,_0x28b8df,_0x3913d3,_0x5a2fde),_0x5ec0ca[_0x5af74f(0x236)]();};exports[a24_0x1230ed(0x20b)]=forward;const send=async(_0xbb26f8,_0x1d0cd9)=>{const _0x35da37=a24_0x1230ed,{whatsappId:_0x578340}=_0xbb26f8[_0x35da37(0x226)],_0x14d485=_0xbb26f8['body'],_0x2ab24e=_0xbb26f8[_0x35da37(0x1ce)];if(_0x14d485[_0x35da37(0x1f2)]===undefined)throw new AppError_1[(_0x35da37(0x1da))](_0x35da37(0x224),0x190);const _0x49a65d=await Whatsapp_1[_0x35da37(0x1da)]['findByPk'](_0x578340);if(!_0x49a65d)throw new AppError_1[(_0x35da37(0x1da))](_0x35da37(0x204),0x194);try{let {number:_0x4148a7}=_0x14d485;const {body:_0x1f08f1,linkPreview:_0x4f722c}=_0x14d485,_0x19cd24=!!_0x14d485['saveOnTicket'];if(!_0x4148a7[_0x35da37(0x1fe)]('@')){const _0x24dba9=_0x14d485['number'],{companyId:_0x51d9fa}=_0x49a65d,_0x21df74=await(0x0,CheckNumber_1[_0x35da37(0x1da)])(_0x24dba9,_0x51d9fa,_0x49a65d);_0x4148a7=_0x21df74[_0x35da37(0x214)]['replace'](/\D/g,'');}return _0x2ab24e?await Promise['all'](_0x2ab24e['map'](async _0x1c09cb=>{const _0x4c3248=_0x35da37;await _0xbb26f8[_0x4c3248(0x1cb)][_0x4c3248(0x1e0)]('queues')[_0x4c3248(0x222)][_0x4c3248(0x1f4)](_0x4c3248(0x20a),{'whatsappId':_0x578340,'data':{'number':_0x4148a7,'body':_0x1c09cb[_0x4c3248(0x218)],'mediaPath':_0x1c09cb[_0x4c3248(0x1ed)],'saveOnTicket':_0x19cd24}},{'removeOnComplete':!![],'attempts':0x3});})):_0xbb26f8['app'][_0x35da37(0x1e0)](_0x35da37(0x230))[_0x35da37(0x222)][_0x35da37(0x1f4)](_0x35da37(0x20a),{'whatsappId':_0x578340,'data':{'number':_0x4148a7,'body':_0x1f08f1,'linkPreview':_0x4f722c,'saveOnTicket':_0x19cd24}},{'removeOnComplete':![],'attempts':0x3}),_0x1d0cd9[_0x35da37(0x236)]({'mensagem':'Message\x20added\x20to\x20queue'});}catch(_0x9568b3){const _0x8aa56c={'errType':typeof _0x9568b3,'serialized':JSON['stringify'](_0x9568b3),'err':_0x9568b3};_0x9568b3?.[_0x35da37(0x205)]?console[_0x35da37(0x1f0)](_0x8aa56c,_0x35da37(0x1c8)+_0x9568b3[_0x35da37(0x205)]):logger_1[_0x35da37(0x1d6)][_0x35da37(0x1f0)](_0x8aa56c,_0x35da37(0x227));throw new AppError_1[(_0x35da37(0x1da))](_0x35da37(0x1d9),0x1f4);}};exports['send']=send;