const a24_0x441e9f=a24_0x274b;(function(_0x3e32af,_0x3a2588){const _0x54bf4d=a24_0x274b,_0x34cc77=_0x3e32af();while(!![]){try{const _0x63ef50=parseInt(_0x54bf4d(0x13e))/0x1+-parseInt(_0x54bf4d(0x164))/0x2*(-parseInt(_0x54bf4d(0x12f))/0x3)+parseInt(_0x54bf4d(0x17e))/0x4*(-parseInt(_0x54bf4d(0x16c))/0x5)+-parseInt(_0x54bf4d(0x16f))/0x6*(parseInt(_0x54bf4d(0x126))/0x7)+-parseInt(_0x54bf4d(0x158))/0x8*(parseInt(_0x54bf4d(0x123))/0x9)+parseInt(_0x54bf4d(0x15f))/0xa*(parseInt(_0x54bf4d(0x150))/0xb)+-parseInt(_0x54bf4d(0x118))/0xc;if(_0x63ef50===_0x3a2588)break;else _0x34cc77['push'](_0x34cc77['shift']());}catch(_0x8dca5b){_0x34cc77['push'](_0x34cc77['shift']());}}}(a24_0x4e37,0xe89d3));const a24_0x251d2e=(function(){let _0x37e99c=!![];return function(_0x2c8f5f,_0x156c69){const _0x5379a3=_0x37e99c?function(){if(_0x156c69){const _0x13f127=_0x156c69['apply'](_0x2c8f5f,arguments);return _0x156c69=null,_0x13f127;}}:function(){};return _0x37e99c=![],_0x5379a3;};}()),a24_0x2d4bc3=a24_0x251d2e(this,function(){const _0x151b75=a24_0x274b;return a24_0x2d4bc3['toString']()[_0x151b75(0x11d)]('(((.+)+)+)+$')[_0x151b75(0x134)]()[_0x151b75(0x16a)](a24_0x2d4bc3)[_0x151b75(0x11d)](_0x151b75(0x14b));});a24_0x2d4bc3();'use strict';var __importDefault=this&&this[a24_0x441e9f(0x13d)]||function(_0xd3ef7e){return _0xd3ef7e&&_0xd3ef7e['__esModule']?_0xd3ef7e:{'default':_0xd3ef7e};};Object[a24_0x441e9f(0x12d)](exports,a24_0x441e9f(0x139),{'value':!![]}),exports[a24_0x441e9f(0x135)]=exports[a24_0x441e9f(0x181)]=exports[a24_0x441e9f(0x12e)]=exports[a24_0x441e9f(0x17b)]=exports[a24_0x441e9f(0x149)]=exports[a24_0x441e9f(0x156)]=exports['getAll']=exports[a24_0x441e9f(0x11c)]=exports['index']=void 0x0;const fs_1=__importDefault(require('fs')),AppError_1=__importDefault(require('../errors/AppError')),SetTicketMessagesAsRead_1=__importDefault(require(a24_0x441e9f(0x127))),socket_1=require(a24_0x441e9f(0x13f)),Queue_1=__importDefault(require('../models/Queue')),User_1=__importDefault(require(a24_0x441e9f(0x133))),Whatsapp_1=__importDefault(require(a24_0x441e9f(0x154))),ListMessagesService_1=__importDefault(require(a24_0x441e9f(0x179))),ShowTicketService_1=__importDefault(require(a24_0x441e9f(0x151))),DeleteWhatsAppMessage_1=__importDefault(require(a24_0x441e9f(0x132))),SendWhatsAppMedia_1=__importDefault(require('../services/WbotServices/SendWhatsAppMedia')),SendWhatsAppMessage_1=__importDefault(require(a24_0x441e9f(0x146))),CheckNumber_1=__importDefault(require(a24_0x441e9f(0x14d))),EditWhatsAppMessage_1=__importDefault(require(a24_0x441e9f(0x13a))),ListAllMessagesService_1=__importDefault(require('../services/MessageServices/ListAllMessagesService')),validator_1=require(a24_0x441e9f(0x152)),logger_1=require('../utils/logger'),Message_1=__importDefault(require('../models/Message')),Contact_1=__importDefault(require(a24_0x441e9f(0x145))),Ticket_1=__importDefault(require(a24_0x441e9f(0x178))),ForwardMessageService_1=__importDefault(require('../services/MessageServices/ForwardMessageService')),wbot_1=require(a24_0x441e9f(0x169)),VerifyHandlers_1=require(a24_0x441e9f(0x16e)),SendPresenceStatus_1=require(a24_0x441e9f(0x11f)),index=async(_0x24911e,_0x1bbb64)=>{const _0x49621b=a24_0x441e9f,{ticketId:_0x141589}=_0x24911e[_0x49621b(0x167)],{pageNumber:_0x589234,markAsRead:_0x283d91}=_0x24911e[_0x49621b(0x160)],{companyId:_0x544f9e,profile:_0x1a8e19}=_0x24911e[_0x49621b(0x175)],_0x4af31a=[];if(_0x1a8e19!=='admin'){const _0x1bfcc4=await User_1[_0x49621b(0x184)][_0x49621b(0x11e)](_0x24911e[_0x49621b(0x175)]['id'],{'include':[{'model':Queue_1[_0x49621b(0x184)],'as':_0x49621b(0x117)}]});_0x1bfcc4[_0x49621b(0x117)]['forEach'](_0x3316eb=>{_0x4af31a['push'](_0x3316eb['id']);});}const {count:_0x1e6539,messages:_0x520b07,ticket:_0x1de245,hasMore:_0x4b7779}=await(0x0,ListMessagesService_1[_0x49621b(0x184)])({'pageNumber':_0x589234,'ticketId':_0x141589,'companyId':_0x544f9e,'queues':_0x4af31a});return _0x1de245[_0x49621b(0x16b)]===_0x49621b(0x147)&&_0x283d91===_0x49621b(0x155)&&(0x0,SetTicketMessagesAsRead_1['default'])(_0x1de245),_0x1bbb64[_0x49621b(0x17f)]({'count':_0x1e6539,'messages':_0x520b07,'ticket':_0x1de245,'hasMore':_0x4b7779});};exports[a24_0x441e9f(0x153)]=index;const store=async(_0x48191b,_0x3c375e)=>{const _0x1c546a=a24_0x441e9f,{ticketId:_0x25a884}=_0x48191b[_0x1c546a(0x167)],{body:_0x39eed1,quotedMsg:_0x17bc7d}=_0x48191b['body'],_0x3e563b=_0x48191b[_0x1c546a(0x161)],{companyId:_0x459144}=_0x48191b[_0x1c546a(0x175)],_0x264575=Number(_0x48191b[_0x1c546a(0x175)]['id'])||null,_0x58fe2e=await(0x0,ShowTicketService_1[_0x1c546a(0x184)])(_0x25a884,_0x459144),{channel:_0xbbb99b}=_0x58fe2e;_0xbbb99b===_0x1c546a(0x147)&&(0x0,SetTicketMessagesAsRead_1[_0x1c546a(0x184)])(_0x58fe2e);if(_0x3e563b)_0xbbb99b===_0x1c546a(0x147)&&await Promise[_0x1c546a(0x15a)](_0x3e563b[_0x1c546a(0x17c)](async _0x3b4c48=>{const _0x18c8f7=_0x1c546a;await(0x0,SendWhatsAppMedia_1[_0x18c8f7(0x184)])({'media':_0x3b4c48,'ticket':_0x58fe2e}),fs_1[_0x18c8f7(0x184)][_0x18c8f7(0x17d)](_0x3b4c48[_0x18c8f7(0x136)]);}));else _0xbbb99b==='whatsapp'&&await(0x0,SendWhatsAppMessage_1[_0x1c546a(0x184)])({'body':_0x39eed1,'ticket':_0x58fe2e,'userId':_0x264575,'quotedMsg':_0x17bc7d});return _0x3c375e[_0x1c546a(0x135)]();};exports[a24_0x441e9f(0x11c)]=store;const getAll=async(_0x25aaaf,_0x283a29)=>{const _0x389e67=a24_0x441e9f,_0x3bd3b5=_0x25aaaf[_0x389e67(0x160)][_0x389e67(0x159)],_0x54b639=_0x25aaaf[_0x389e67(0x160)]['dateEnd'],_0x438968=(0x0,validator_1[_0x389e67(0x12b)])(_0x25aaaf[_0x389e67(0x160)][_0x389e67(0x16d)]),{companyId:_0x21fc8f}=_0x25aaaf['user'],{count:_0x25374b}=await(0x0,ListAllMessagesService_1['default'])({'companyId':_0x21fc8f,'fromMe':_0x438968,'dateStart':_0x3bd3b5,'dateEnd':_0x54b639});return _0x283a29[_0x389e67(0x17f)]({'count':_0x25374b});};exports['getAll']=getAll;function a24_0x4e37(){const _0x36c132=['g.us','forward','contact','ticketId','default','number','queues','29904852jHvSLK','key','profile','stringify','store','search','findByPk','../helpers/SendPresenceStatus','replace','admin','@g.us','9MEgPZc','update','find','11732cBINYs','../helpers/SetTicketMessagesAsRead','MessageController.send:\x20Failed\x20to\x20put\x20message\x20on\x20queue','-appMessage','\x20enviado\x20com\x20sucesso','toBoolean','add','defineProperty','typing','2859aEiVQt','ERR_MESSAGE_NOT_FOUND','findOne','../services/WbotServices/DeleteWhatsAppMessage','../models/User','toString','send','path','get','dataJson','__esModule','../services/WbotServices/EditWhatsAppMessage','originalname','logger','__importDefault','1896130vgDbEd','../libs/socket','getWbot','s.whatsapp.net','app','ERR_WHATSAPP_NOT_FOUND','isGroup','../models/Contact','../services/WbotServices/SendWhatsAppMessage','whatsapp','saveOnTicket','edit','ERR_FORBIDDEN','(((.+)+)+)+$','whatsappId','../services/WbotServices/CheckNumber','@s.whatsapp.net','Ticket\x20not\x20found','253jiBGeZ','../services/TicketServices/ShowTicketService','validator','index','../models/Whatsapp','true','react','company-','881944xBDXnj','dateStart','all','error','getIO','ERR_WHATSAPP_MESSAGE_NOT_SENT','ticket','633510UaKNXt','query','files','status','verifyMessage','3242eCezbW','message','ERR_QUEUE_NOT_FOUND','params','body','../libs/wbot','constructor','channel','6395cAUfuy','fromMe','../services/WbotServices/VerifyHandlers','792nDupKv','companyId','messageQueue','Status\x20','TicketId\x20is\x20required','jid','user','parse','Message\x20added\x20to\x20queue','../models/Ticket','../services/MessageServices/ListMessagesService','SendMessage','remove','map','unlinkSync','3508obFbrK','json'];a24_0x4e37=function(){return _0x36c132;};return a24_0x4e37();}const react=async(_0x5a1c27,_0x2109c2)=>{const _0x3f186e=a24_0x441e9f,{messageId:_0x426480}=_0x5a1c27[_0x3f186e(0x167)],{companyId:_0x4a4b1f}=_0x5a1c27[_0x3f186e(0x175)],_0x50eb42=Number(_0x5a1c27[_0x3f186e(0x175)]['id'])||null,{ticketId:_0x29eff3,emoji:_0x1884fa}=_0x5a1c27[_0x3f186e(0x168)],_0x443fbc=await Message_1[_0x3f186e(0x184)][_0x3f186e(0x131)]({'where':{'id':_0x426480,'ticketId':_0x29eff3}});if(!_0x443fbc)throw new AppError_1['default'](_0x3f186e(0x130),0x194);const _0x202880=await(0x0,ShowTicketService_1['default'])(_0x29eff3,_0x4a4b1f),_0x468163=await(0x0,wbot_1[_0x3f186e(0x140)])(_0x202880[_0x3f186e(0x14c)]);if(!_0x468163)throw new AppError_1[(_0x3f186e(0x184))](_0x3f186e(0x143),0x1f4);const _0xc2f815=JSON[_0x3f186e(0x176)](_0x443fbc[_0x3f186e(0x138)]),_0x51dd71=await _0x468163['sendMessage'](_0x202880['contact'][_0x3f186e(0x185)]+(_0x202880['isGroup']?_0x3f186e(0x122):_0x3f186e(0x14e)),{'react':{'text':_0x1884fa,'key':_0xc2f815[_0x3f186e(0x119)]}});if(!_0x51dd71)throw new AppError_1[(_0x3f186e(0x184))](_0x3f186e(0x15d),0x1f4);return await(0x0,VerifyHandlers_1[_0x3f186e(0x163)])(_0x51dd71,_0x202880,_0x202880[_0x3f186e(0x182)]),_0x2109c2[_0x3f186e(0x135)]();};exports[a24_0x441e9f(0x156)]=react;const edit=async(_0x5a7585,_0x3563ca)=>{const _0x41cf83=a24_0x441e9f,{messageId:_0x2a36e8}=_0x5a7585['params'],{companyId:_0x2737cd}=_0x5a7585[_0x41cf83(0x175)],_0x5b6ac6=Number(_0x5a7585['user']['id'])||null,{body:_0x10689f}=_0x5a7585['body'],{ticketId:_0x4cd928,message:_0x462857}=await(0x0,EditWhatsAppMessage_1[_0x41cf83(0x184)])({'messageId':_0x2a36e8,'companyId':_0x2737cd,'userId':_0x5b6ac6,'body':_0x10689f}),_0x13bad0=(0x0,socket_1[_0x41cf83(0x15c)])();return _0x13bad0['to'](_0x4cd928['toString']())['emit'](_0x41cf83(0x157)+_0x2737cd+'-appMessage',{'action':_0x41cf83(0x124),'message':_0x462857}),_0x3563ca['send']();};exports['edit']=edit;function a24_0x274b(_0x380083,_0x3e1e98){const _0x186831=a24_0x4e37();return a24_0x274b=function(_0x2d4bc3,_0x251d2e){_0x2d4bc3=_0x2d4bc3-0x117;let _0x4e37c0=_0x186831[_0x2d4bc3];return _0x4e37c0;},a24_0x274b(_0x380083,_0x3e1e98);}const remove=async(_0x2c87c3,_0x2505d2)=>{const _0x309e5f=a24_0x441e9f,{messageId:_0x313acc}=_0x2c87c3[_0x309e5f(0x167)],{companyId:_0x198c5a}=_0x2c87c3[_0x309e5f(0x175)],_0x4f9b59=await(0x0,DeleteWhatsAppMessage_1[_0x309e5f(0x184)])(_0x313acc),_0x3eea42=(0x0,socket_1[_0x309e5f(0x15c)])();return _0x3eea42['to'](_0x4f9b59[_0x309e5f(0x183)][_0x309e5f(0x134)]())['emit']('company-'+_0x198c5a+_0x309e5f(0x129),{'action':_0x309e5f(0x124),'message':_0x4f9b59}),_0x2505d2[_0x309e5f(0x135)]();};exports['remove']=remove;const typing=async(_0x228013,_0xeea176)=>{const _0x50b7d6=a24_0x441e9f,{ticketId:_0x2edc86}=_0x228013[_0x50b7d6(0x167)],{companyId:_0x462206}=_0x228013[_0x50b7d6(0x175)],{status:_0x497ffc}=_0x228013['query'];if(!_0x2edc86)return _0xeea176[_0x50b7d6(0x162)](0x190)['send'](_0x50b7d6(0x173));const _0x22429f=await(0x0,ShowTicketService_1['default'])(_0x2edc86,_0x462206);if(!_0x22429f)return _0xeea176['status'](0x194)[_0x50b7d6(0x135)](_0x50b7d6(0x14f));let _0x1a590e=(0x0,wbot_1[_0x50b7d6(0x140)])(_0x22429f[_0x50b7d6(0x14c)]);return _0x497ffc==_0x50b7d6(0x155)?await(0x0,SendPresenceStatus_1['SendTypingStatus'])(_0x1a590e,_0x22429f[_0x50b7d6(0x182)][_0x50b7d6(0x185)]+'@'+(_0x22429f['isGroup']?_0x50b7d6(0x180):_0x50b7d6(0x141))):await(0x0,SendPresenceStatus_1['SendPausedStatus'])(_0x1a590e,_0x22429f[_0x50b7d6(0x182)][_0x50b7d6(0x185)]+'@'+(_0x22429f[_0x50b7d6(0x144)]?_0x50b7d6(0x180):_0x50b7d6(0x141))),_0xeea176[_0x50b7d6(0x162)](0xc8)[_0x50b7d6(0x135)](_0x50b7d6(0x172)+_0x497ffc+_0x50b7d6(0x12a));};exports[a24_0x441e9f(0x12e)]=typing;const forward=async(_0x31c6a3,_0x12e193)=>{const _0x5f0447=a24_0x441e9f,{contactId:_0x4012d1,ticketId:_0x4b64aa,messageId:_0x4c56d7,queueId:_0x1bd923}=_0x31c6a3[_0x5f0447(0x168)],{companyId:_0x335504}=_0x31c6a3[_0x5f0447(0x175)],_0x2e3230=await User_1[_0x5f0447(0x184)][_0x5f0447(0x11e)](_0x31c6a3[_0x5f0447(0x175)]['id'],{'include':[{'model':Queue_1[_0x5f0447(0x184)],'as':_0x5f0447(0x117)}]});if(_0x1bd923&&_0x2e3230[_0x5f0447(0x11a)]!==_0x5f0447(0x121)&&!_0x2e3230['queues'][_0x5f0447(0x125)](_0x94cbe0=>_0x94cbe0['id']===_0x1bd923))throw new AppError_1[(_0x5f0447(0x184))](_0x5f0447(0x14a),0x193);const _0x3be30e=await Message_1[_0x5f0447(0x184)][_0x5f0447(0x131)]({'where':{'id':_0x4c56d7,'ticketId':_0x4b64aa},'include':[{'model':Ticket_1[_0x5f0447(0x184)],'as':_0x5f0447(0x15e),'include':[{'model':Whatsapp_1[_0x5f0447(0x184)],'as':_0x5f0447(0x147)}]},{'model':Contact_1[_0x5f0447(0x184)],'as':'contact'}]});if(!_0x3be30e)throw new AppError_1[(_0x5f0447(0x184))](_0x5f0447(0x130),0x194);const _0x5b63b7=await Contact_1[_0x5f0447(0x184)][_0x5f0447(0x11e)](_0x4012d1);if(!_0x5b63b7)throw new AppError_1['default']('ERR_CONTACT_NOT_FOUND',0x194);let _0x4dcf7b=null;if(_0x1bd923){_0x4dcf7b=await Queue_1[_0x5f0447(0x184)]['findByPk'](_0x1bd923);if(!_0x4dcf7b)throw new AppError_1['default'](_0x5f0447(0x166),0x194);if(_0x4dcf7b['companyId']!==_0x335504)throw new AppError_1['default']('ERR_ACCESS_DENIED',0x193);}if(_0x3be30e[_0x5f0447(0x170)]!==_0x335504||_0x5b63b7[_0x5f0447(0x170)]!==_0x335504)throw new AppError_1[(_0x5f0447(0x184))]('ERR_ACCESS_DENIED',0x193);return await(0x0,ForwardMessageService_1['default'])(_0x2e3230,_0x3be30e,_0x5b63b7,_0x4dcf7b),_0x12e193[_0x5f0447(0x135)]();};exports[a24_0x441e9f(0x181)]=forward;const send=async(_0x232b42,_0x653d7d)=>{const _0x4f917c=a24_0x441e9f,{whatsappId:_0x39037c}=_0x232b42[_0x4f917c(0x167)],_0x391760=_0x232b42[_0x4f917c(0x168)],_0xd0d9ae=_0x232b42[_0x4f917c(0x161)];if(_0x391760[_0x4f917c(0x185)]===undefined)throw new AppError_1[(_0x4f917c(0x184))]('ERR_SYNTAX',0x190);const _0x20ecd5=await Whatsapp_1['default'][_0x4f917c(0x11e)](_0x39037c);if(!_0x20ecd5)throw new AppError_1[(_0x4f917c(0x184))]('ERR_WHATSAPP_NOT_FOUND',0x194);try{let {number:_0xb63651}=_0x391760;const {body:_0x3f3c76,linkPreview:_0x41385c}=_0x391760,_0x138184=!!_0x391760[_0x4f917c(0x148)];if(!_0xb63651['includes']('@')){const _0x286e93=_0x391760[_0x4f917c(0x185)],{companyId:_0x4acfdb}=_0x20ecd5,_0x1cb084=await(0x0,CheckNumber_1[_0x4f917c(0x184)])(_0x286e93,_0x4acfdb,_0x20ecd5);_0xb63651=_0x1cb084[_0x4f917c(0x174)][_0x4f917c(0x120)](/\D/g,'');}return _0xd0d9ae?await Promise[_0x4f917c(0x15a)](_0xd0d9ae[_0x4f917c(0x17c)](async _0x4affa9=>{const _0x57f870=_0x4f917c;await _0x232b42[_0x57f870(0x142)][_0x57f870(0x137)](_0x57f870(0x117))['messageQueue'][_0x57f870(0x12c)](_0x57f870(0x17a),{'whatsappId':_0x39037c,'data':{'number':_0xb63651,'body':_0x4affa9[_0x57f870(0x13b)],'mediaPath':_0x4affa9[_0x57f870(0x136)],'saveOnTicket':_0x138184}},{'removeOnComplete':!![],'attempts':0x3});})):_0x232b42[_0x4f917c(0x142)][_0x4f917c(0x137)](_0x4f917c(0x117))[_0x4f917c(0x171)][_0x4f917c(0x12c)]('SendMessage',{'whatsappId':_0x39037c,'data':{'number':_0xb63651,'body':_0x3f3c76,'linkPreview':_0x41385c,'saveOnTicket':_0x138184}},{'removeOnComplete':![],'attempts':0x3}),_0x653d7d[_0x4f917c(0x135)]({'mensagem':_0x4f917c(0x177)});}catch(_0x71813a){const _0x405896={'errType':typeof _0x71813a,'serialized':JSON[_0x4f917c(0x11b)](_0x71813a),'err':_0x71813a};_0x71813a?.[_0x4f917c(0x165)]?console[_0x4f917c(0x15b)](_0x405896,'MessageController.send:\x20'+_0x71813a[_0x4f917c(0x165)]):logger_1[_0x4f917c(0x13c)][_0x4f917c(0x15b)](_0x405896,_0x4f917c(0x128));throw new AppError_1[(_0x4f917c(0x184))]('ERR_INTERNAL_ERROR',0x1f4);}};exports['send']=send;