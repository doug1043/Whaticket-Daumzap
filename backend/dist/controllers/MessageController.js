const a24_0x3fae9f=a24_0x5277;(function(_0x3be3a2,_0x236bab){const _0x489c7d=a24_0x5277,_0x122efe=_0x3be3a2();while(!![]){try{const _0x76d814=-parseInt(_0x489c7d(0x15f))/0x1+parseInt(_0x489c7d(0x17e))/0x2+parseInt(_0x489c7d(0x157))/0x3+-parseInt(_0x489c7d(0x142))/0x4+-parseInt(_0x489c7d(0x18f))/0x5+parseInt(_0x489c7d(0x186))/0x6+parseInt(_0x489c7d(0x158))/0x7;if(_0x76d814===_0x236bab)break;else _0x122efe['push'](_0x122efe['shift']());}catch(_0x459472){_0x122efe['push'](_0x122efe['shift']());}}}(a24_0x3e4a,0x40dbc));function a24_0x3e4a(){const _0x5eafaf=['add','remove','MessageController.send:\x20Failed\x20to\x20put\x20message\x20on\x20queue','293320eCZxYK','ERR_MESSAGE_NOT_FOUND','true','params','ERR_SYNTAX','fromMe','ERR_ACCESS_DENIED','getWbot','emit','companyId','s.whatsapp.net','profile','index','../services/TicketServices/ShowTicketService','../libs/wbot','../models/Message','channel','findOne','ERR_WHATSAPP_NOT_FOUND','typing','ERR_QUEUE_NOT_FOUND','108987oEkxyZ','3335115DxnQGi','TicketId\x20is\x20required','g.us','user','map','ticket','../models/Contact','143482lhqHxr','@g.us','../libs/socket','../utils/logger','status','path','contact','find','MessageController.send:\x20','../services/WbotServices/CheckNumber','search','default','json','query','\x20enviado\x20com\x20sucesso','admin','../models/Whatsapp','get','findByPk','logger','message','getIO','number','dateStart','edit','body','files','toBoolean','../services/MessageServices/ForwardMessageService','../services/WbotServices/VerifyHandlers','error','213982sPwEmy','includes','saveOnTicket','stringify','parse','update','sendMessage','SendTypingStatus','629634MYvpRf','company-','forward','Message\x20added\x20to\x20queue','toString','apply','SendMessage','getAll','jid','1211160sUlkQQ','__importDefault','react','key','(((.+)+)+)+$','Ticket\x20not\x20found','whatsapp','../services/WbotServices/SendWhatsAppMedia','../helpers/SetTicketMessagesAsRead','app','send','dataJson','verifyMessage','SendPausedStatus','isGroup','../services/MessageServices/ListMessagesService','queues','ticketId','defineProperty','ERR_INTERNAL_ERROR','../errors/AppError','whatsappId','../helpers/SendPresenceStatus','ERR_FORBIDDEN','-appMessage','all','Status\x20','store','messageQueue'];a24_0x3e4a=function(){return _0x5eafaf;};return a24_0x3e4a();}const a24_0x55f564=(function(){let _0x58515d=!![];return function(_0x4929da,_0x2dcdd3){const _0x205e87=_0x58515d?function(){const _0x260065=a24_0x5277;if(_0x2dcdd3){const _0xc1816f=_0x2dcdd3[_0x260065(0x18b)](_0x4929da,arguments);return _0x2dcdd3=null,_0xc1816f;}}:function(){};return _0x58515d=![],_0x205e87;};}()),a24_0x318fc0=a24_0x55f564(this,function(){const _0x57b8ec=a24_0x5277;return a24_0x318fc0[_0x57b8ec(0x18a)]()[_0x57b8ec(0x169)](_0x57b8ec(0x193))[_0x57b8ec(0x18a)]()['constructor'](a24_0x318fc0)[_0x57b8ec(0x169)](_0x57b8ec(0x193));});a24_0x318fc0();'use strict';var __importDefault=this&&this[a24_0x3fae9f(0x190)]||function(_0x3ad632){return _0x3ad632&&_0x3ad632['__esModule']?_0x3ad632:{'default':_0x3ad632};};Object[a24_0x3fae9f(0x1a1)](exports,'__esModule',{'value':!![]}),exports[a24_0x3fae9f(0x199)]=exports[a24_0x3fae9f(0x188)]=exports[a24_0x3fae9f(0x155)]=exports[a24_0x3fae9f(0x140)]=exports[a24_0x3fae9f(0x177)]=exports['react']=exports[a24_0x3fae9f(0x18d)]=exports[a24_0x3fae9f(0x1aa)]=exports[a24_0x3fae9f(0x14e)]=void 0x0;const fs_1=__importDefault(require('fs')),AppError_1=__importDefault(require(a24_0x3fae9f(0x1a3))),SetTicketMessagesAsRead_1=__importDefault(require(a24_0x3fae9f(0x197))),socket_1=require(a24_0x3fae9f(0x161)),Queue_1=__importDefault(require('../models/Queue')),User_1=__importDefault(require('../models/User')),Whatsapp_1=__importDefault(require(a24_0x3fae9f(0x16f))),ListMessagesService_1=__importDefault(require(a24_0x3fae9f(0x19e))),ShowTicketService_1=__importDefault(require(a24_0x3fae9f(0x14f))),DeleteWhatsAppMessage_1=__importDefault(require('../services/WbotServices/DeleteWhatsAppMessage')),SendWhatsAppMedia_1=__importDefault(require(a24_0x3fae9f(0x196))),SendWhatsAppMessage_1=__importDefault(require('../services/WbotServices/SendWhatsAppMessage')),CheckNumber_1=__importDefault(require(a24_0x3fae9f(0x168))),EditWhatsAppMessage_1=__importDefault(require('../services/WbotServices/EditWhatsAppMessage')),ListAllMessagesService_1=__importDefault(require('../services/MessageServices/ListAllMessagesService')),validator_1=require('validator'),logger_1=require(a24_0x3fae9f(0x162)),Message_1=__importDefault(require(a24_0x3fae9f(0x151))),Contact_1=__importDefault(require(a24_0x3fae9f(0x15e))),Ticket_1=__importDefault(require('../models/Ticket')),ForwardMessageService_1=__importDefault(require(a24_0x3fae9f(0x17b))),wbot_1=require(a24_0x3fae9f(0x150)),VerifyHandlers_1=require(a24_0x3fae9f(0x17c)),SendPresenceStatus_1=require(a24_0x3fae9f(0x1a5)),index=async(_0x4f97d8,_0x4c18c3)=>{const _0x2c7a9a=a24_0x3fae9f,{ticketId:_0x4b0e93}=_0x4f97d8[_0x2c7a9a(0x145)],{pageNumber:_0x55b623,markAsRead:_0x523d4b}=_0x4f97d8[_0x2c7a9a(0x16c)],{companyId:_0x68fed2,profile:_0x1fccd0}=_0x4f97d8[_0x2c7a9a(0x15b)],_0x38e895=[];if(_0x1fccd0!==_0x2c7a9a(0x16e)){const _0x2f172b=await User_1[_0x2c7a9a(0x16a)][_0x2c7a9a(0x171)](_0x4f97d8[_0x2c7a9a(0x15b)]['id'],{'include':[{'model':Queue_1['default'],'as':_0x2c7a9a(0x19f)}]});_0x2f172b[_0x2c7a9a(0x19f)]['forEach'](_0x1402c1=>{_0x38e895['push'](_0x1402c1['id']);});}const {count:_0x29824f,messages:_0x4f8ba5,ticket:_0x18522b,hasMore:_0xa9faca}=await(0x0,ListMessagesService_1[_0x2c7a9a(0x16a)])({'pageNumber':_0x55b623,'ticketId':_0x4b0e93,'companyId':_0x68fed2,'queues':_0x38e895});return _0x18522b[_0x2c7a9a(0x152)]==='whatsapp'&&_0x523d4b===_0x2c7a9a(0x144)&&(0x0,SetTicketMessagesAsRead_1[_0x2c7a9a(0x16a)])(_0x18522b),_0x4c18c3['json']({'count':_0x29824f,'messages':_0x4f8ba5,'ticket':_0x18522b,'hasMore':_0xa9faca});};exports[a24_0x3fae9f(0x14e)]=index;const store=async(_0xe241f1,_0x3b3cf3)=>{const _0x367063=a24_0x3fae9f,{ticketId:_0x55a34b}=_0xe241f1[_0x367063(0x145)],{body:_0x21a3c0,quotedMsg:_0x5dfe05}=_0xe241f1[_0x367063(0x178)],_0x208acb=_0xe241f1[_0x367063(0x179)],{companyId:_0x42a06e}=_0xe241f1[_0x367063(0x15b)],_0x2f8857=Number(_0xe241f1[_0x367063(0x15b)]['id'])||null,_0x4e1ea2=await(0x0,ShowTicketService_1['default'])(_0x55a34b,_0x42a06e),{channel:_0x102121}=_0x4e1ea2;_0x102121==='whatsapp'&&(0x0,SetTicketMessagesAsRead_1[_0x367063(0x16a)])(_0x4e1ea2);if(_0x208acb)_0x102121==='whatsapp'&&await Promise[_0x367063(0x1a8)](_0x208acb['map'](async _0x56380f=>{const _0x427280=_0x367063;await(0x0,SendWhatsAppMedia_1[_0x427280(0x16a)])({'media':_0x56380f,'ticket':_0x4e1ea2}),fs_1[_0x427280(0x16a)]['unlinkSync'](_0x56380f[_0x427280(0x164)]);}));else _0x102121==='whatsapp'&&await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x21a3c0,'ticket':_0x4e1ea2,'userId':_0x2f8857,'quotedMsg':_0x5dfe05});return _0x3b3cf3[_0x367063(0x199)]();};exports['store']=store;const getAll=async(_0x17f6b6,_0x5988c6)=>{const _0x436573=a24_0x3fae9f,_0x371e35=_0x17f6b6[_0x436573(0x16c)][_0x436573(0x176)],_0x512399=_0x17f6b6[_0x436573(0x16c)]['dateEnd'],_0x5d0f7d=(0x0,validator_1[_0x436573(0x17a)])(_0x17f6b6[_0x436573(0x16c)][_0x436573(0x147)]),{companyId:_0x836848}=_0x17f6b6[_0x436573(0x15b)],{count:_0x638f32}=await(0x0,ListAllMessagesService_1['default'])({'companyId':_0x836848,'fromMe':_0x5d0f7d,'dateStart':_0x371e35,'dateEnd':_0x512399});return _0x5988c6[_0x436573(0x16b)]({'count':_0x638f32});};exports['getAll']=getAll;const react=async(_0x33350a,_0x22ac15)=>{const _0x3352e6=a24_0x3fae9f,{messageId:_0x5ab900}=_0x33350a[_0x3352e6(0x145)],{companyId:_0x1eb82d}=_0x33350a['user'],_0x30176f=Number(_0x33350a[_0x3352e6(0x15b)]['id'])||null,{ticketId:_0x218518,emoji:_0x741a0d}=_0x33350a['body'],_0x3104ca=await Message_1['default'][_0x3352e6(0x153)]({'where':{'id':_0x5ab900,'ticketId':_0x218518}});if(!_0x3104ca)throw new AppError_1[(_0x3352e6(0x16a))]('ERR_MESSAGE_NOT_FOUND',0x194);const _0x37b477=await(0x0,ShowTicketService_1[_0x3352e6(0x16a)])(_0x218518,_0x1eb82d),_0x128675=await(0x0,wbot_1['getWbot'])(_0x37b477[_0x3352e6(0x1a4)]);if(!_0x128675)throw new AppError_1[(_0x3352e6(0x16a))](_0x3352e6(0x154),0x1f4);const _0x2f33de=JSON[_0x3352e6(0x182)](_0x3104ca[_0x3352e6(0x19a)]),_0x117475=await _0x128675[_0x3352e6(0x184)](_0x37b477[_0x3352e6(0x165)]['number']+(_0x37b477[_0x3352e6(0x19d)]?_0x3352e6(0x160):'@s.whatsapp.net'),{'react':{'text':_0x741a0d,'key':_0x2f33de[_0x3352e6(0x192)]}});if(!_0x117475)throw new AppError_1[(_0x3352e6(0x16a))]('ERR_WHATSAPP_MESSAGE_NOT_SENT',0x1f4);return await(0x0,VerifyHandlers_1[_0x3352e6(0x19b)])(_0x117475,_0x37b477,_0x37b477[_0x3352e6(0x165)]),_0x22ac15['send']();};exports[a24_0x3fae9f(0x191)]=react;const edit=async(_0x1e2c93,_0x297069)=>{const _0x574a5c=a24_0x3fae9f,{messageId:_0x177bb5}=_0x1e2c93[_0x574a5c(0x145)],{companyId:_0x2d9833}=_0x1e2c93[_0x574a5c(0x15b)],_0x3194b3=Number(_0x1e2c93[_0x574a5c(0x15b)]['id'])||null,{body:_0x5ec1f4}=_0x1e2c93['body'],{ticketId:_0x2c9364,message:_0x315fbf}=await(0x0,EditWhatsAppMessage_1['default'])({'messageId':_0x177bb5,'companyId':_0x2d9833,'userId':_0x3194b3,'body':_0x5ec1f4}),_0x144145=(0x0,socket_1[_0x574a5c(0x174)])();return _0x144145['to'](_0x2c9364[_0x574a5c(0x18a)]())[_0x574a5c(0x14a)](_0x574a5c(0x187)+_0x2d9833+_0x574a5c(0x1a7),{'action':_0x574a5c(0x183),'message':_0x315fbf}),_0x297069[_0x574a5c(0x199)]();};exports[a24_0x3fae9f(0x177)]=edit;const remove=async(_0xa09890,_0x486875)=>{const _0x3b710e=a24_0x3fae9f,{messageId:_0x20846d}=_0xa09890[_0x3b710e(0x145)],{companyId:_0x4299e0}=_0xa09890[_0x3b710e(0x15b)],_0x3e0dc4=await(0x0,DeleteWhatsAppMessage_1[_0x3b710e(0x16a)])(_0x20846d),_0x1bf905=(0x0,socket_1[_0x3b710e(0x174)])();return _0x1bf905['to'](_0x3e0dc4[_0x3b710e(0x1a0)]['toString']())[_0x3b710e(0x14a)]('company-'+_0x4299e0+_0x3b710e(0x1a7),{'action':_0x3b710e(0x183),'message':_0x3e0dc4}),_0x486875[_0x3b710e(0x199)]();};exports[a24_0x3fae9f(0x140)]=remove;const typing=async(_0xf74d4b,_0x465183)=>{const _0x96992=a24_0x3fae9f,{ticketId:_0x3f4d60}=_0xf74d4b[_0x96992(0x145)],{companyId:_0x48ae18}=_0xf74d4b[_0x96992(0x15b)],{status:_0x21f934}=_0xf74d4b[_0x96992(0x16c)];if(!_0x3f4d60)return _0x465183[_0x96992(0x163)](0x190)['send'](_0x96992(0x159));const _0x4f286d=await(0x0,ShowTicketService_1['default'])(_0x3f4d60,_0x48ae18);if(!_0x4f286d)return _0x465183[_0x96992(0x163)](0x194)[_0x96992(0x199)](_0x96992(0x194));let _0x1b8f6c=(0x0,wbot_1[_0x96992(0x149)])(_0x4f286d[_0x96992(0x1a4)]);return _0x21f934==_0x96992(0x144)?await(0x0,SendPresenceStatus_1[_0x96992(0x185)])(_0x1b8f6c,_0x4f286d[_0x96992(0x165)][_0x96992(0x175)]+'@'+(_0x4f286d[_0x96992(0x19d)]?_0x96992(0x15a):_0x96992(0x14c))):await(0x0,SendPresenceStatus_1[_0x96992(0x19c)])(_0x1b8f6c,_0x4f286d[_0x96992(0x165)][_0x96992(0x175)]+'@'+(_0x4f286d[_0x96992(0x19d)]?_0x96992(0x15a):_0x96992(0x14c))),_0x465183[_0x96992(0x163)](0xc8)[_0x96992(0x199)](_0x96992(0x1a9)+_0x21f934+_0x96992(0x16d));};exports[a24_0x3fae9f(0x155)]=typing;const forward=async(_0x1a85f8,_0x10a175)=>{const _0xc3691f=a24_0x3fae9f,{contactId:_0x2f62e7,ticketId:_0x474af0,messageId:_0x6f2418,queueId:_0x5e7b45}=_0x1a85f8['body'],{companyId:_0x1dac32}=_0x1a85f8[_0xc3691f(0x15b)],_0x390948=await User_1[_0xc3691f(0x16a)][_0xc3691f(0x171)](_0x1a85f8[_0xc3691f(0x15b)]['id'],{'include':[{'model':Queue_1['default'],'as':'queues'}]});if(_0x5e7b45&&_0x390948[_0xc3691f(0x14d)]!==_0xc3691f(0x16e)&&!_0x390948[_0xc3691f(0x19f)][_0xc3691f(0x166)](_0x595085=>_0x595085['id']===_0x5e7b45))throw new AppError_1['default'](_0xc3691f(0x1a6),0x193);const _0x839508=await Message_1[_0xc3691f(0x16a)]['findOne']({'where':{'id':_0x6f2418,'ticketId':_0x474af0},'include':[{'model':Ticket_1[_0xc3691f(0x16a)],'as':_0xc3691f(0x15d),'include':[{'model':Whatsapp_1[_0xc3691f(0x16a)],'as':_0xc3691f(0x195)}]},{'model':Contact_1[_0xc3691f(0x16a)],'as':_0xc3691f(0x165)}]});if(!_0x839508)throw new AppError_1[(_0xc3691f(0x16a))](_0xc3691f(0x143),0x194);const _0x124dcf=await Contact_1[_0xc3691f(0x16a)][_0xc3691f(0x171)](_0x2f62e7);if(!_0x124dcf)throw new AppError_1[(_0xc3691f(0x16a))]('ERR_CONTACT_NOT_FOUND',0x194);let _0x35f586=null;if(_0x5e7b45){_0x35f586=await Queue_1['default']['findByPk'](_0x5e7b45);if(!_0x35f586)throw new AppError_1[(_0xc3691f(0x16a))](_0xc3691f(0x156),0x194);if(_0x35f586[_0xc3691f(0x14b)]!==_0x1dac32)throw new AppError_1[(_0xc3691f(0x16a))](_0xc3691f(0x148),0x193);}if(_0x839508[_0xc3691f(0x14b)]!==_0x1dac32||_0x124dcf[_0xc3691f(0x14b)]!==_0x1dac32)throw new AppError_1[(_0xc3691f(0x16a))](_0xc3691f(0x148),0x193);return await(0x0,ForwardMessageService_1[_0xc3691f(0x16a)])(_0x390948,_0x839508,_0x124dcf,_0x35f586),_0x10a175[_0xc3691f(0x199)]();};exports[a24_0x3fae9f(0x188)]=forward;function a24_0x5277(_0x42bba6,_0x11f91e){const _0x596230=a24_0x3e4a();return a24_0x5277=function(_0x318fc0,_0x55f564){_0x318fc0=_0x318fc0-0x13f;let _0x3e4a49=_0x596230[_0x318fc0];return _0x3e4a49;},a24_0x5277(_0x42bba6,_0x11f91e);}const send=async(_0x5e20ca,_0x1d019d)=>{const _0x42be7d=a24_0x3fae9f,{whatsappId:_0x307610}=_0x5e20ca['params'],_0x5a128c=_0x5e20ca['body'],_0x59ccc0=_0x5e20ca[_0x42be7d(0x179)];if(_0x5a128c[_0x42be7d(0x175)]===undefined)throw new AppError_1[(_0x42be7d(0x16a))](_0x42be7d(0x146),0x190);const _0x458204=await Whatsapp_1[_0x42be7d(0x16a)][_0x42be7d(0x171)](_0x307610);if(!_0x458204)throw new AppError_1['default'](_0x42be7d(0x154),0x194);try{let {number:_0xd5e7af}=_0x5a128c;const {body:_0x10bcd2,linkPreview:_0x12a3f4}=_0x5a128c,_0x41567d=!!_0x5a128c[_0x42be7d(0x180)];if(!_0xd5e7af[_0x42be7d(0x17f)]('@')){const _0x3fd8d0=_0x5a128c[_0x42be7d(0x175)],{companyId:_0x74703f}=_0x458204,_0x163d93=await(0x0,CheckNumber_1['default'])(_0x3fd8d0,_0x74703f,_0x458204);_0xd5e7af=_0x163d93[_0x42be7d(0x18e)]['replace'](/\D/g,'');}return _0x59ccc0?await Promise['all'](_0x59ccc0[_0x42be7d(0x15c)](async _0x18791a=>{const _0x57ffb=_0x42be7d;await _0x5e20ca[_0x57ffb(0x198)][_0x57ffb(0x170)]('queues')[_0x57ffb(0x1ab)][_0x57ffb(0x13f)](_0x57ffb(0x18c),{'whatsappId':_0x307610,'data':{'number':_0xd5e7af,'body':_0x18791a['originalname'],'mediaPath':_0x18791a[_0x57ffb(0x164)],'saveOnTicket':_0x41567d}},{'removeOnComplete':!![],'attempts':0x3});})):_0x5e20ca[_0x42be7d(0x198)]['get'](_0x42be7d(0x19f))[_0x42be7d(0x1ab)][_0x42be7d(0x13f)](_0x42be7d(0x18c),{'whatsappId':_0x307610,'data':{'number':_0xd5e7af,'body':_0x10bcd2,'linkPreview':_0x12a3f4,'saveOnTicket':_0x41567d}},{'removeOnComplete':![],'attempts':0x3}),_0x1d019d[_0x42be7d(0x199)]({'mensagem':_0x42be7d(0x189)});}catch(_0x467bef){const _0x3d7480={'errType':typeof _0x467bef,'serialized':JSON[_0x42be7d(0x181)](_0x467bef),'err':_0x467bef};_0x467bef?.['message']?console[_0x42be7d(0x17d)](_0x3d7480,_0x42be7d(0x167)+_0x467bef[_0x42be7d(0x173)]):logger_1[_0x42be7d(0x172)][_0x42be7d(0x17d)](_0x3d7480,_0x42be7d(0x141));throw new AppError_1['default'](_0x42be7d(0x1a2),0x1f4);}};exports[a24_0x3fae9f(0x199)]=send;