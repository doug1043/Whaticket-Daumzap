const a24_0x6845f0=a24_0x3559;(function(_0x262e08,_0x495ac6){const _0x11a0b0=a24_0x3559,_0x2bf151=_0x262e08();while(!![]){try{const _0x4f05c5=-parseInt(_0x11a0b0(0x1b8))/0x1+parseInt(_0x11a0b0(0x18d))/0x2+parseInt(_0x11a0b0(0x197))/0x3+parseInt(_0x11a0b0(0x199))/0x4*(parseInt(_0x11a0b0(0x1df))/0x5)+parseInt(_0x11a0b0(0x196))/0x6*(-parseInt(_0x11a0b0(0x1d7))/0x7)+parseInt(_0x11a0b0(0x1a4))/0x8+parseInt(_0x11a0b0(0x1f0))/0x9*(parseInt(_0x11a0b0(0x1d1))/0xa);if(_0x4f05c5===_0x495ac6)break;else _0x2bf151['push'](_0x2bf151['shift']());}catch(_0x411b17){_0x2bf151['push'](_0x2bf151['shift']());}}}(a24_0x5151,0xf34dc));const a24_0x3b7e30=(function(){let _0xbd19ed=!![];return function(_0x4b7743,_0x471b5f){const _0x211caa=_0xbd19ed?function(){const _0x21f72b=a24_0x3559;if(_0x471b5f){const _0x4aecd0=_0x471b5f[_0x21f72b(0x1bb)](_0x4b7743,arguments);return _0x471b5f=null,_0x4aecd0;}}:function(){};return _0xbd19ed=![],_0x211caa;};}()),a24_0x39cb96=a24_0x3b7e30(this,function(){const _0x23efb9=a24_0x3559;return a24_0x39cb96['toString']()[_0x23efb9(0x1d0)](_0x23efb9(0x1ee))['toString']()[_0x23efb9(0x1d5)](a24_0x39cb96)[_0x23efb9(0x1d0)]('(((.+)+)+)+$');});a24_0x39cb96();'use strict';var __importDefault=this&&this[a24_0x6845f0(0x1f5)]||function(_0x1be9c1){const _0x27dab4=a24_0x6845f0;return _0x1be9c1&&_0x1be9c1[_0x27dab4(0x1a7)]?_0x1be9c1:{'default':_0x1be9c1};};Object[a24_0x6845f0(0x194)](exports,a24_0x6845f0(0x1a7),{'value':!![]}),exports['send']=exports[a24_0x6845f0(0x1e4)]=exports[a24_0x6845f0(0x1c2)]=exports['remove']=exports['edit']=exports[a24_0x6845f0(0x1a2)]=exports[a24_0x6845f0(0x1a8)]=exports[a24_0x6845f0(0x190)]=exports['index']=void 0x0;const fs_1=__importDefault(require('fs')),AppError_1=__importDefault(require(a24_0x6845f0(0x19f))),SetTicketMessagesAsRead_1=__importDefault(require(a24_0x6845f0(0x1c9))),socket_1=require(a24_0x6845f0(0x1f3)),Queue_1=__importDefault(require(a24_0x6845f0(0x1ca))),User_1=__importDefault(require(a24_0x6845f0(0x1b4))),Whatsapp_1=__importDefault(require('../models/Whatsapp')),ListMessagesService_1=__importDefault(require(a24_0x6845f0(0x1c6))),ShowTicketService_1=__importDefault(require(a24_0x6845f0(0x1af))),DeleteWhatsAppMessage_1=__importDefault(require(a24_0x6845f0(0x1cf))),SendWhatsAppMedia_1=__importDefault(require(a24_0x6845f0(0x1a0))),SendWhatsAppMessage_1=__importDefault(require('../services/WbotServices/SendWhatsAppMessage')),CheckNumber_1=__importDefault(require(a24_0x6845f0(0x1c7))),EditWhatsAppMessage_1=__importDefault(require(a24_0x6845f0(0x1a1))),ListAllMessagesService_1=__importDefault(require('../services/MessageServices/ListAllMessagesService')),validator_1=require(a24_0x6845f0(0x1b5)),logger_1=require('../utils/logger'),Message_1=__importDefault(require(a24_0x6845f0(0x1e0))),Contact_1=__importDefault(require(a24_0x6845f0(0x1e1))),Ticket_1=__importDefault(require('../models/Ticket')),ForwardMessageService_1=__importDefault(require(a24_0x6845f0(0x1b3))),wbot_1=require(a24_0x6845f0(0x1f7)),VerifyHandlers_1=require(a24_0x6845f0(0x1c8)),SendPresenceStatus_1=require(a24_0x6845f0(0x19b)),index=async(_0x46b99f,_0x50d057)=>{const _0x4878b4=a24_0x6845f0,{ticketId:_0x292c64}=_0x46b99f['params'],{pageNumber:_0x807d4d,markAsRead:_0x5e69c4}=_0x46b99f[_0x4878b4(0x1b2)],{companyId:_0x4c36e6,profile:_0xd5dc91}=_0x46b99f[_0x4878b4(0x1c5)],_0x5bf516=[];if(_0xd5dc91!==_0x4878b4(0x1a9)){const _0x3713ce=await User_1[_0x4878b4(0x1f6)]['findByPk'](_0x46b99f[_0x4878b4(0x1c5)]['id'],{'include':[{'model':Queue_1['default'],'as':_0x4878b4(0x1d8)}]});_0x3713ce['queues'][_0x4878b4(0x1ec)](_0x4bd6f2=>{_0x5bf516['push'](_0x4bd6f2['id']);});}const {count:_0x40fa36,messages:_0xa1b123,ticket:_0x561dcb,hasMore:_0x12bbdb}=await(0x0,ListMessagesService_1[_0x4878b4(0x1f6)])({'pageNumber':_0x807d4d,'ticketId':_0x292c64,'companyId':_0x4c36e6,'queues':_0x5bf516});return _0x561dcb[_0x4878b4(0x1fa)]===_0x4878b4(0x1ed)&&_0x5e69c4===_0x4878b4(0x1dd)&&(0x0,SetTicketMessagesAsRead_1[_0x4878b4(0x1f6)])(_0x561dcb),_0x50d057[_0x4878b4(0x1de)]({'count':_0x40fa36,'messages':_0xa1b123,'ticket':_0x561dcb,'hasMore':_0x12bbdb});};exports[a24_0x6845f0(0x1c1)]=index;const store=async(_0x25f29e,_0xa392c1)=>{const _0x5c7731=a24_0x6845f0,{ticketId:_0x27e226}=_0x25f29e['params'],{body:_0x4ef8e2,quotedMsg:_0x9a72d8}=_0x25f29e[_0x5c7731(0x195)],_0x32d727=_0x25f29e[_0x5c7731(0x1a6)],{companyId:_0x2c899b}=_0x25f29e['user'],_0x47c69b=Number(_0x25f29e['user']['id'])||null,_0x5c5dbc=await(0x0,ShowTicketService_1[_0x5c7731(0x1f6)])(_0x27e226,_0x2c899b),{channel:_0x174736}=_0x5c5dbc;_0x174736===_0x5c7731(0x1ed)&&(0x0,SetTicketMessagesAsRead_1['default'])(_0x5c5dbc);if(_0x32d727)_0x174736==='whatsapp'&&await Promise[_0x5c7731(0x1f4)](_0x32d727[_0x5c7731(0x18b)](async _0x1f0f48=>{const _0x498e3e=_0x5c7731;await(0x0,SendWhatsAppMedia_1[_0x498e3e(0x1f6)])({'media':_0x1f0f48,'ticket':_0x5c5dbc}),fs_1['default'][_0x498e3e(0x1cd)](_0x1f0f48['path']);}));else _0x174736===_0x5c7731(0x1ed)&&await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x4ef8e2,'ticket':_0x5c5dbc,'userId':_0x47c69b,'quotedMsg':_0x9a72d8});return _0xa392c1[_0x5c7731(0x1ab)]();};exports[a24_0x6845f0(0x190)]=store;const getAll=async(_0x57190d,_0x5e90b3)=>{const _0x54e57e=a24_0x6845f0,_0x2ba8ba=_0x57190d[_0x54e57e(0x1b2)]['dateStart'],_0x187379=_0x57190d[_0x54e57e(0x1b2)][_0x54e57e(0x1cb)],_0x2034f4=(0x0,validator_1[_0x54e57e(0x1ac)])(_0x57190d[_0x54e57e(0x1b2)]['fromMe']),{companyId:_0x652488}=_0x57190d['user'],{count:_0x2e936f}=await(0x0,ListAllMessagesService_1[_0x54e57e(0x1f6)])({'companyId':_0x652488,'fromMe':_0x2034f4,'dateStart':_0x2ba8ba,'dateEnd':_0x187379});return _0x5e90b3[_0x54e57e(0x1de)]({'count':_0x2e936f});};function a24_0x3559(_0x247765,_0x559fe5){const _0x119337=a24_0x5151();return a24_0x3559=function(_0x39cb96,_0x3b7e30){_0x39cb96=_0x39cb96-0x18b;let _0x51518e=_0x119337[_0x39cb96];return _0x51518e;},a24_0x3559(_0x247765,_0x559fe5);}exports['getAll']=getAll;const react=async(_0x5a8a50,_0x56d7ac)=>{const _0x326100=a24_0x6845f0,{messageId:_0x24327e}=_0x5a8a50[_0x326100(0x18f)],{companyId:_0x76335a}=_0x5a8a50[_0x326100(0x1c5)],_0x5ec7b0=Number(_0x5a8a50[_0x326100(0x1c5)]['id'])||null,{ticketId:_0x32cafb,emoji:_0x160e18}=_0x5a8a50[_0x326100(0x195)],_0xebf90b=await Message_1['default'][_0x326100(0x1a5)]({'where':{'id':_0x24327e,'ticketId':_0x32cafb}});if(!_0xebf90b)throw new AppError_1[(_0x326100(0x1f6))]('ERR_MESSAGE_NOT_FOUND',0x194);const _0xaaa2dd=await(0x0,ShowTicketService_1[_0x326100(0x1f6)])(_0x32cafb,_0x76335a),_0x2f3d6e=await(0x0,wbot_1[_0x326100(0x1d3)])(_0xaaa2dd[_0x326100(0x19e)]);if(!_0x2f3d6e)throw new AppError_1['default'](_0x326100(0x1e5),0x1f4);const _0xec5683=JSON[_0x326100(0x18e)](_0xebf90b['dataJson']),_0x528293=await _0x2f3d6e[_0x326100(0x1ce)](_0xaaa2dd[_0x326100(0x19a)][_0x326100(0x1c0)]+(_0xaaa2dd[_0x326100(0x1d9)]?_0x326100(0x1f2):_0x326100(0x1ef)),{'react':{'text':_0x160e18,'key':_0xec5683[_0x326100(0x1e7)]}});if(!_0x528293)throw new AppError_1[(_0x326100(0x1f6))](_0x326100(0x1cc),0x1f4);return await(0x0,VerifyHandlers_1[_0x326100(0x1c3)])(_0x528293,_0xaaa2dd,_0xaaa2dd[_0x326100(0x19a)]),_0x56d7ac[_0x326100(0x1ab)]();};exports['react']=react;const edit=async(_0x28af92,_0x4a4171)=>{const _0xb7873=a24_0x6845f0,{messageId:_0x343657}=_0x28af92[_0xb7873(0x18f)],{companyId:_0x2ca652}=_0x28af92[_0xb7873(0x1c5)],_0x51f45d=Number(_0x28af92[_0xb7873(0x1c5)]['id'])||null,{body:_0x277eeb}=_0x28af92[_0xb7873(0x195)],{ticketId:_0x392270,message:_0x3e4f27}=await(0x0,EditWhatsAppMessage_1[_0xb7873(0x1f6)])({'messageId':_0x343657,'companyId':_0x2ca652,'userId':_0x51f45d,'body':_0x277eeb}),_0x399bbd=(0x0,socket_1[_0xb7873(0x1ea)])();return _0x399bbd['to'](_0x392270[_0xb7873(0x1d6)]())[_0xb7873(0x19c)](_0xb7873(0x1eb)+_0x2ca652+_0xb7873(0x1fb),{'action':'update','message':_0x3e4f27}),_0x4a4171['send']();};exports[a24_0x6845f0(0x1b6)]=edit;const remove=async(_0x492594,_0x2d1a28)=>{const _0x25b671=a24_0x6845f0,{messageId:_0x297fdc}=_0x492594['params'],{companyId:_0x5f5033}=_0x492594[_0x25b671(0x1c5)],_0x58df28=await(0x0,DeleteWhatsAppMessage_1[_0x25b671(0x1f6)])(_0x297fdc),_0x3878cc=(0x0,socket_1[_0x25b671(0x1ea)])();return _0x3878cc['to'](_0x58df28['ticketId']['toString']())[_0x25b671(0x19c)]('company-'+_0x5f5033+'-appMessage',{'action':_0x25b671(0x1be),'message':_0x58df28}),_0x2d1a28[_0x25b671(0x1ab)]();};exports[a24_0x6845f0(0x19d)]=remove;function a24_0x5151(){const _0x1bab86=['SendMessage','number','index','typing','verifyMessage','findByPk','user','../services/MessageServices/ListMessagesService','../services/WbotServices/CheckNumber','../services/WbotServices/VerifyHandlers','../helpers/SetTicketMessagesAsRead','../models/Queue','dateEnd','ERR_WHATSAPP_MESSAGE_NOT_SENT','unlinkSync','sendMessage','../services/WbotServices/DeleteWhatsAppMessage','search','20tAYgzW','path','getWbot','ERR_FORBIDDEN','constructor','toString','3612700GdIRqy','queues','isGroup','ticket','find','ERR_CONTACT_NOT_FOUND','true','json','295190eLBfeB','../models/Message','../models/Contact','SendPausedStatus','profile','forward','ERR_WHATSAPP_NOT_FOUND','ERR_ACCESS_DENIED','key','s.whatsapp.net','message','getIO','company-','forEach','whatsapp','(((.+)+)+)+$','@s.whatsapp.net','5951403TQlvOU','messageQueue','@g.us','../libs/socket','all','__importDefault','default','../libs/wbot','includes','\x20enviado\x20com\x20sucesso','channel','-appMessage','map','Status\x20','977526KSeHtN','parse','params','store','status','error','g.us','defineProperty','body','18tsHqXl','2274294lVBZfo','jid','88uBNMwg','contact','../helpers/SendPresenceStatus','emit','remove','whatsappId','../errors/AppError','../services/WbotServices/SendWhatsAppMedia','../services/WbotServices/EditWhatsAppMessage','react','companyId','4701784fEoubV','findOne','files','__esModule','getAll','admin','Ticket\x20not\x20found','send','toBoolean','logger','originalname','../services/TicketServices/ShowTicketService','add','ERR_SYNTAX','query','../services/MessageServices/ForwardMessageService','../models/User','validator','edit','Message\x20added\x20to\x20queue','1911082VwPWpR','MessageController.send:\x20Failed\x20to\x20put\x20message\x20on\x20queue','ERR_MESSAGE_NOT_FOUND','apply','SendTypingStatus','saveOnTicket','update'];a24_0x5151=function(){return _0x1bab86;};return a24_0x5151();}const typing=async(_0x58c601,_0x5b20ec)=>{const _0x18034a=a24_0x6845f0,{ticketId:_0x262830}=_0x58c601[_0x18034a(0x18f)],{companyId:_0x56d42e}=_0x58c601[_0x18034a(0x1c5)],{status:_0x21489b}=_0x58c601[_0x18034a(0x1b2)];if(!_0x262830)return _0x5b20ec[_0x18034a(0x191)](0x190)['send']('TicketId\x20is\x20required');const _0x17ee1b=await(0x0,ShowTicketService_1[_0x18034a(0x1f6)])(_0x262830,_0x56d42e);if(!_0x17ee1b)return _0x5b20ec['status'](0x194)[_0x18034a(0x1ab)](_0x18034a(0x1aa));let _0x439e57=(0x0,wbot_1[_0x18034a(0x1d3)])(_0x17ee1b[_0x18034a(0x19e)]);return _0x21489b==_0x18034a(0x1dd)?await(0x0,SendPresenceStatus_1[_0x18034a(0x1bc)])(_0x439e57,_0x17ee1b[_0x18034a(0x19a)][_0x18034a(0x1c0)]+'@'+(_0x17ee1b[_0x18034a(0x1d9)]?_0x18034a(0x193):'s.whatsapp.net')):await(0x0,SendPresenceStatus_1[_0x18034a(0x1e2)])(_0x439e57,_0x17ee1b[_0x18034a(0x19a)][_0x18034a(0x1c0)]+'@'+(_0x17ee1b[_0x18034a(0x1d9)]?_0x18034a(0x193):_0x18034a(0x1e8))),_0x5b20ec[_0x18034a(0x191)](0xc8)['send'](_0x18034a(0x18c)+_0x21489b+_0x18034a(0x1f9));};exports['typing']=typing;const forward=async(_0x400c95,_0x49303b)=>{const _0x399c9a=a24_0x6845f0,{contactId:_0x55183c,ticketId:_0x3c2c47,messageId:_0x285228,queueId:_0x5d3183}=_0x400c95[_0x399c9a(0x195)],{companyId:_0x38f877}=_0x400c95['user'],_0x2e6d2c=await User_1[_0x399c9a(0x1f6)][_0x399c9a(0x1c4)](_0x400c95[_0x399c9a(0x1c5)]['id'],{'include':[{'model':Queue_1[_0x399c9a(0x1f6)],'as':_0x399c9a(0x1d8)}]});if(_0x5d3183&&_0x2e6d2c[_0x399c9a(0x1e3)]!==_0x399c9a(0x1a9)&&!_0x2e6d2c[_0x399c9a(0x1d8)][_0x399c9a(0x1db)](_0x495dec=>_0x495dec['id']===_0x5d3183))throw new AppError_1['default'](_0x399c9a(0x1d4),0x193);const _0x1077a1=await Message_1[_0x399c9a(0x1f6)][_0x399c9a(0x1a5)]({'where':{'id':_0x285228,'ticketId':_0x3c2c47},'include':[{'model':Ticket_1['default'],'as':_0x399c9a(0x1da),'include':[{'model':Whatsapp_1[_0x399c9a(0x1f6)],'as':_0x399c9a(0x1ed)}]},{'model':Contact_1[_0x399c9a(0x1f6)],'as':'contact'}]});if(!_0x1077a1)throw new AppError_1[(_0x399c9a(0x1f6))](_0x399c9a(0x1ba),0x194);const _0x4dc8fc=await Contact_1[_0x399c9a(0x1f6)][_0x399c9a(0x1c4)](_0x55183c);if(!_0x4dc8fc)throw new AppError_1[(_0x399c9a(0x1f6))](_0x399c9a(0x1dc),0x194);let _0x437696=null;if(_0x5d3183){_0x437696=await Queue_1['default']['findByPk'](_0x5d3183);if(!_0x437696)throw new AppError_1['default']('ERR_QUEUE_NOT_FOUND',0x194);if(_0x437696[_0x399c9a(0x1a3)]!==_0x38f877)throw new AppError_1['default'](_0x399c9a(0x1e6),0x193);}if(_0x1077a1[_0x399c9a(0x1a3)]!==_0x38f877||_0x4dc8fc[_0x399c9a(0x1a3)]!==_0x38f877)throw new AppError_1[(_0x399c9a(0x1f6))](_0x399c9a(0x1e6),0x193);return await(0x0,ForwardMessageService_1[_0x399c9a(0x1f6)])(_0x2e6d2c,_0x1077a1,_0x4dc8fc,_0x437696),_0x49303b['send']();};exports[a24_0x6845f0(0x1e4)]=forward;const send=async(_0x718f52,_0x219570)=>{const _0x51e46e=a24_0x6845f0,{whatsappId:_0x25caff}=_0x718f52[_0x51e46e(0x18f)],_0x22b112=_0x718f52[_0x51e46e(0x195)],_0xfee994=_0x718f52[_0x51e46e(0x1a6)];if(_0x22b112[_0x51e46e(0x1c0)]===undefined)throw new AppError_1[(_0x51e46e(0x1f6))](_0x51e46e(0x1b1),0x190);const _0x4000c7=await Whatsapp_1['default']['findByPk'](_0x25caff);if(!_0x4000c7)throw new AppError_1['default'](_0x51e46e(0x1e5),0x194);try{let {number:_0x5ec531}=_0x22b112;const {body:_0x1ec852,linkPreview:_0x329572}=_0x22b112,_0x1cfd6c=!!_0x22b112[_0x51e46e(0x1bd)];if(!_0x5ec531[_0x51e46e(0x1f8)]('@')){const _0x8d935d=_0x22b112[_0x51e46e(0x1c0)],{companyId:_0x3ed1ff}=_0x4000c7,_0x35b44d=await(0x0,CheckNumber_1[_0x51e46e(0x1f6)])(_0x8d935d,_0x3ed1ff,_0x4000c7);_0x5ec531=_0x35b44d[_0x51e46e(0x198)]['replace'](/\D/g,'');}return _0xfee994?await Promise['all'](_0xfee994[_0x51e46e(0x18b)](async _0x4604fb=>{const _0x3d160b=_0x51e46e;await _0x718f52['app']['get']('queues')[_0x3d160b(0x1f1)][_0x3d160b(0x1b0)]('SendMessage',{'whatsappId':_0x25caff,'data':{'number':_0x5ec531,'body':_0x4604fb[_0x3d160b(0x1ae)],'mediaPath':_0x4604fb[_0x3d160b(0x1d2)],'saveOnTicket':_0x1cfd6c}},{'removeOnComplete':!![],'attempts':0x3});})):_0x718f52['app']['get'](_0x51e46e(0x1d8))['messageQueue'][_0x51e46e(0x1b0)](_0x51e46e(0x1bf),{'whatsappId':_0x25caff,'data':{'number':_0x5ec531,'body':_0x1ec852,'linkPreview':_0x329572,'saveOnTicket':_0x1cfd6c}},{'removeOnComplete':![],'attempts':0x3}),_0x219570[_0x51e46e(0x1ab)]({'mensagem':_0x51e46e(0x1b7)});}catch(_0x520ec6){const _0x42f6a0={'errType':typeof _0x520ec6,'serialized':JSON['stringify'](_0x520ec6),'err':_0x520ec6};_0x520ec6?.[_0x51e46e(0x1e9)]?console[_0x51e46e(0x192)](_0x42f6a0,'MessageController.send:\x20'+_0x520ec6[_0x51e46e(0x1e9)]):logger_1[_0x51e46e(0x1ad)][_0x51e46e(0x192)](_0x42f6a0,_0x51e46e(0x1b9));throw new AppError_1[(_0x51e46e(0x1f6))]('ERR_INTERNAL_ERROR',0x1f4);}};exports[a24_0x6845f0(0x1ab)]=send;