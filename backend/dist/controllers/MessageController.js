const a24_0xa5fe9=a24_0xd584;(function(_0x2cd392,_0x92d0fa){const _0x461212=a24_0xd584,_0x25a1be=_0x2cd392();while(!![]){try{const _0x11d1fc=-parseInt(_0x461212(0xe9))/0x1+parseInt(_0x461212(0x10d))/0x2+parseInt(_0x461212(0x128))/0x3+-parseInt(_0x461212(0x111))/0x4+-parseInt(_0x461212(0xdb))/0x5+parseInt(_0x461212(0xe2))/0x6*(-parseInt(_0x461212(0xe5))/0x7)+parseInt(_0x461212(0x11f))/0x8*(parseInt(_0x461212(0xe1))/0x9);if(_0x11d1fc===_0x92d0fa)break;else _0x25a1be['push'](_0x25a1be['shift']());}catch(_0x593d51){_0x25a1be['push'](_0x25a1be['shift']());}}}(a24_0xc66f,0x7109c));const a24_0x443a8c=(function(){let _0x461572=!![];return function(_0x4b628b,_0x5e89a1){const _0x54ed4a=_0x461572?function(){const _0x52318d=a24_0xd584;if(_0x5e89a1){const _0x622ba7=_0x5e89a1[_0x52318d(0x110)](_0x4b628b,arguments);return _0x5e89a1=null,_0x622ba7;}}:function(){};return _0x461572=![],_0x54ed4a;};}()),a24_0x454a91=a24_0x443a8c(this,function(){const _0x4c05ed=a24_0xd584;return a24_0x454a91[_0x4c05ed(0x105)]()[_0x4c05ed(0x116)](_0x4c05ed(0xf2))['toString']()[_0x4c05ed(0x106)](a24_0x454a91)[_0x4c05ed(0x116)](_0x4c05ed(0xf2));});a24_0x454a91();'use strict';function a24_0xd584(_0x1944fd,_0x1d24d9){const _0x4502a1=a24_0xc66f();return a24_0xd584=function(_0x454a91,_0x443a8c){_0x454a91=_0x454a91-0xd7;let _0xc66fce=_0x4502a1[_0x454a91];return _0xc66fce;},a24_0xd584(_0x1944fd,_0x1d24d9);}var __importDefault=this&&this['__importDefault']||function(_0x3b5740){return _0x3b5740&&_0x3b5740['__esModule']?_0x3b5740:{'default':_0x3b5740};};Object[a24_0xa5fe9(0x115)](exports,'__esModule',{'value':!![]}),exports[a24_0xa5fe9(0x144)]=exports['forward']=exports[a24_0xa5fe9(0x102)]=exports[a24_0xa5fe9(0xfb)]=exports[a24_0xa5fe9(0xd7)]=exports['react']=exports[a24_0xa5fe9(0xde)]=exports[a24_0xa5fe9(0x129)]=exports[a24_0xa5fe9(0x133)]=void 0x0;const fs_1=__importDefault(require('fs')),AppError_1=__importDefault(require(a24_0xa5fe9(0xe6))),SetTicketMessagesAsRead_1=__importDefault(require(a24_0xa5fe9(0x101))),socket_1=require('../libs/socket'),Queue_1=__importDefault(require(a24_0xa5fe9(0xf4))),User_1=__importDefault(require(a24_0xa5fe9(0x109))),Whatsapp_1=__importDefault(require('../models/Whatsapp')),ListMessagesService_1=__importDefault(require('../services/MessageServices/ListMessagesService')),ShowTicketService_1=__importDefault(require(a24_0xa5fe9(0x123))),DeleteWhatsAppMessage_1=__importDefault(require(a24_0xa5fe9(0xf6))),SendWhatsAppMedia_1=__importDefault(require('../services/WbotServices/SendWhatsAppMedia')),SendWhatsAppMessage_1=__importDefault(require(a24_0xa5fe9(0x13b))),CheckNumber_1=__importDefault(require(a24_0xa5fe9(0x12d))),EditWhatsAppMessage_1=__importDefault(require(a24_0xa5fe9(0xe3))),ListAllMessagesService_1=__importDefault(require(a24_0xa5fe9(0x10a))),validator_1=require(a24_0xa5fe9(0x112)),logger_1=require(a24_0xa5fe9(0x121)),Message_1=__importDefault(require(a24_0xa5fe9(0xef))),Contact_1=__importDefault(require(a24_0xa5fe9(0x118))),Ticket_1=__importDefault(require('../models/Ticket')),ForwardMessageService_1=__importDefault(require(a24_0xa5fe9(0xee))),wbot_1=require(a24_0xa5fe9(0xe8)),VerifyHandlers_1=require(a24_0xa5fe9(0xf0)),SendPresenceStatus_1=require(a24_0xa5fe9(0x10f)),index=async(_0x4562d8,_0x443ed1)=>{const _0x313937=a24_0xa5fe9,{ticketId:_0x11dba5}=_0x4562d8['params'],{pageNumber:_0x42cd32,markAsRead:_0x38b0d1}=_0x4562d8[_0x313937(0x10e)],{companyId:_0x99495c,profile:_0x49ad57}=_0x4562d8[_0x313937(0x13e)],_0x361d0c=[];if(_0x49ad57!==_0x313937(0xfa)){const _0x1b4756=await User_1['default']['findByPk'](_0x4562d8[_0x313937(0x13e)]['id'],{'include':[{'model':Queue_1[_0x313937(0x136)],'as':'queues'}]});_0x1b4756[_0x313937(0x13a)][_0x313937(0xe7)](_0x3c007c=>{const _0x5e5edf=_0x313937;_0x361d0c[_0x5e5edf(0xda)](_0x3c007c['id']);});}const {count:_0x33f715,messages:_0x46adc4,ticket:_0x13f3fd,hasMore:_0x2b488c}=await(0x0,ListMessagesService_1[_0x313937(0x136)])({'pageNumber':_0x42cd32,'ticketId':_0x11dba5,'companyId':_0x99495c,'queues':_0x361d0c});return _0x13f3fd[_0x313937(0x12f)]===_0x313937(0xfd)&&_0x38b0d1===_0x313937(0x11e)&&(0x0,SetTicketMessagesAsRead_1[_0x313937(0x136)])(_0x13f3fd),_0x443ed1[_0x313937(0x108)]({'count':_0x33f715,'messages':_0x46adc4,'ticket':_0x13f3fd,'hasMore':_0x2b488c});};exports['index']=index;const store=async(_0x45d6bc,_0x362c9e)=>{const _0x143e9a=a24_0xa5fe9,{ticketId:_0x1ec31d}=_0x45d6bc[_0x143e9a(0xfe)],{body:_0x5b0bac,quotedMsg:_0x53aecd}=_0x45d6bc[_0x143e9a(0x12c)],_0x4808e4=_0x45d6bc[_0x143e9a(0x132)],{companyId:_0x2cdccc}=_0x45d6bc[_0x143e9a(0x13e)],_0x1541c7=Number(_0x45d6bc['user']['id'])||null,_0x19c914=await(0x0,ShowTicketService_1[_0x143e9a(0x136)])(_0x1ec31d,_0x2cdccc),{channel:_0x4f1153}=_0x19c914;_0x4f1153===_0x143e9a(0xfd)&&(0x0,SetTicketMessagesAsRead_1[_0x143e9a(0x136)])(_0x19c914);if(_0x4808e4)_0x4f1153===_0x143e9a(0xfd)&&await Promise[_0x143e9a(0x127)](_0x4808e4[_0x143e9a(0x117)](async _0x4ed048=>{const _0x14c8c7=_0x143e9a;await(0x0,SendWhatsAppMedia_1[_0x14c8c7(0x136)])({'media':_0x4ed048,'ticket':_0x19c914}),fs_1['default'][_0x14c8c7(0xe0)](_0x4ed048['path']);}));else _0x4f1153===_0x143e9a(0xfd)&&await(0x0,SendWhatsAppMessage_1[_0x143e9a(0x136)])({'body':_0x5b0bac,'ticket':_0x19c914,'userId':_0x1541c7,'quotedMsg':_0x53aecd});return _0x362c9e[_0x143e9a(0x144)]();};exports[a24_0xa5fe9(0x129)]=store;const getAll=async(_0x222856,_0x4bb8ba)=>{const _0x1ff85b=a24_0xa5fe9,_0x213eb4=_0x222856[_0x1ff85b(0x10e)][_0x1ff85b(0xf5)],_0xc52c95=_0x222856[_0x1ff85b(0x10e)][_0x1ff85b(0xff)],_0x50664f=(0x0,validator_1[_0x1ff85b(0xec)])(_0x222856[_0x1ff85b(0x10e)]['fromMe']),{companyId:_0x1838ea}=_0x222856[_0x1ff85b(0x13e)],{count:_0x376256}=await(0x0,ListAllMessagesService_1[_0x1ff85b(0x136)])({'companyId':_0x1838ea,'fromMe':_0x50664f,'dateStart':_0x213eb4,'dateEnd':_0xc52c95});return _0x4bb8ba[_0x1ff85b(0x108)]({'count':_0x376256});};exports[a24_0xa5fe9(0xde)]=getAll;const react=async(_0x39eda1,_0x24b6a0)=>{const _0xda931=a24_0xa5fe9,{messageId:_0x29d908}=_0x39eda1[_0xda931(0xfe)],{companyId:_0x3f84fc}=_0x39eda1[_0xda931(0x13e)],_0x8b6d7d=Number(_0x39eda1[_0xda931(0x13e)]['id'])||null,{ticketId:_0xa692d6,emoji:_0x12e2fc}=_0x39eda1[_0xda931(0x12c)],_0x1e55fb=await Message_1[_0xda931(0x136)][_0xda931(0xf1)]({'where':{'id':_0x29d908,'ticketId':_0xa692d6}});if(!_0x1e55fb)throw new AppError_1['default']('ERR_MESSAGE_NOT_FOUND',0x194);const _0x24a7c0=await(0x0,ShowTicketService_1[_0xda931(0x136)])(_0xa692d6,_0x3f84fc),_0x2570f6=await(0x0,wbot_1[_0xda931(0x13d)])(_0x24a7c0[_0xda931(0xf8)]);if(!_0x2570f6)throw new AppError_1['default'](_0xda931(0x131),0x1f4);const _0x3817ed=JSON[_0xda931(0x12e)](_0x1e55fb[_0xda931(0x139)]),_0x1f1807=await _0x2570f6[_0xda931(0xdc)](_0x24a7c0[_0xda931(0x114)][_0xda931(0x119)]+(_0x24a7c0[_0xda931(0x104)]?'@g.us':_0xda931(0x126)),{'react':{'text':_0x12e2fc,'key':_0x3817ed[_0xda931(0x130)]}});if(!_0x1f1807)throw new AppError_1['default'](_0xda931(0xe4),0x1f4);return await(0x0,VerifyHandlers_1[_0xda931(0x125)])(_0x1f1807,_0x24a7c0,_0x24a7c0[_0xda931(0x114)]),_0x24b6a0[_0xda931(0x144)]();};exports[a24_0xa5fe9(0x124)]=react;const edit=async(_0xa4a785,_0x23c310)=>{const _0x4ec369=a24_0xa5fe9,{messageId:_0x1d59fb}=_0xa4a785['params'],{companyId:_0x11340b}=_0xa4a785[_0x4ec369(0x13e)],_0x2d06fa=Number(_0xa4a785[_0x4ec369(0x13e)]['id'])||null,{body:_0x36cbe2}=_0xa4a785[_0x4ec369(0x12c)],{ticketId:_0x27a103,message:_0x5d6cea}=await(0x0,EditWhatsAppMessage_1[_0x4ec369(0x136)])({'messageId':_0x1d59fb,'companyId':_0x11340b,'userId':_0x2d06fa,'body':_0x36cbe2}),_0x3e321a=(0x0,socket_1[_0x4ec369(0x135)])();return _0x3e321a['to'](_0x27a103[_0x4ec369(0x105)]())['emit']('company-'+_0x11340b+_0x4ec369(0xfc),{'action':_0x4ec369(0xf9),'message':_0x5d6cea}),_0x23c310[_0x4ec369(0x144)]();};exports['edit']=edit;const remove=async(_0x39ab18,_0x317886)=>{const _0x3fb79b=a24_0xa5fe9,{messageId:_0x394c0a}=_0x39ab18['params'],{companyId:_0x13dc04}=_0x39ab18[_0x3fb79b(0x13e)],_0x5ba2f8=await(0x0,DeleteWhatsAppMessage_1['default'])(_0x394c0a),_0x32f565=(0x0,socket_1[_0x3fb79b(0x135)])();return _0x32f565['to'](_0x5ba2f8[_0x3fb79b(0xd8)]['toString']())[_0x3fb79b(0xed)]('company-'+_0x13dc04+_0x3fb79b(0xfc),{'action':_0x3fb79b(0xf9),'message':_0x5ba2f8}),_0x317886[_0x3fb79b(0x144)]();};exports[a24_0xa5fe9(0xfb)]=remove;const typing=async(_0x11927b,_0x2cfa9f)=>{const _0x1b6286=a24_0xa5fe9,{ticketId:_0x434f55}=_0x11927b[_0x1b6286(0xfe)],{companyId:_0x2bf6ee}=_0x11927b['user'],{status:_0x489473}=_0x11927b[_0x1b6286(0x10e)];if(!_0x434f55)return _0x2cfa9f[_0x1b6286(0x11a)](0x190)[_0x1b6286(0x144)](_0x1b6286(0x11d));const _0x5a3124=await(0x0,ShowTicketService_1[_0x1b6286(0x136)])(_0x434f55,_0x2bf6ee);if(!_0x5a3124)return _0x2cfa9f[_0x1b6286(0x11a)](0x194)[_0x1b6286(0x144)](_0x1b6286(0x100));let _0x2cbb82=(0x0,wbot_1[_0x1b6286(0x13d)])(_0x5a3124['whatsappId']);return _0x489473==_0x1b6286(0x11e)?await(0x0,SendPresenceStatus_1['SendTypingStatus'])(_0x2cbb82,_0x5a3124[_0x1b6286(0x114)][_0x1b6286(0x119)]+'@'+(_0x5a3124['isGroup']?'g.us':_0x1b6286(0x137))):await(0x0,SendPresenceStatus_1[_0x1b6286(0x134)])(_0x2cbb82,_0x5a3124['contact']['number']+'@'+(_0x5a3124[_0x1b6286(0x104)]?_0x1b6286(0x103):_0x1b6286(0x137))),_0x2cfa9f[_0x1b6286(0x11a)](0xc8)[_0x1b6286(0x144)]('Status\x20'+_0x489473+_0x1b6286(0xdf));};exports[a24_0xa5fe9(0x102)]=typing;const forward=async(_0x4d8c3e,_0x4eb5ac)=>{const _0x3d28e3=a24_0xa5fe9,{contactId:_0x4e00a9,ticketId:_0x592e6c,messageId:_0x4bb08f,queueId:_0x1b0734}=_0x4d8c3e[_0x3d28e3(0x12c)],{companyId:_0x124d5f}=_0x4d8c3e[_0x3d28e3(0x13e)],_0x1eeb04=await User_1[_0x3d28e3(0x136)][_0x3d28e3(0x107)](_0x4d8c3e[_0x3d28e3(0x13e)]['id'],{'include':[{'model':Queue_1[_0x3d28e3(0x136)],'as':_0x3d28e3(0x13a)}]});if(_0x1b0734&&_0x1eeb04[_0x3d28e3(0x13f)]!==_0x3d28e3(0xfa)&&!_0x1eeb04[_0x3d28e3(0x13a)][_0x3d28e3(0x13c)](_0x39b5d0=>_0x39b5d0['id']===_0x1b0734))throw new AppError_1[(_0x3d28e3(0x136))](_0x3d28e3(0xeb),0x193);const _0x230212=await Message_1[_0x3d28e3(0x136)][_0x3d28e3(0xf1)]({'where':{'id':_0x4bb08f,'ticketId':_0x592e6c},'include':[{'model':Ticket_1[_0x3d28e3(0x136)],'as':_0x3d28e3(0x11c),'include':[{'model':Whatsapp_1['default'],'as':_0x3d28e3(0xfd)}]},{'model':Contact_1[_0x3d28e3(0x136)],'as':_0x3d28e3(0x114)}]});if(!_0x230212)throw new AppError_1['default'](_0x3d28e3(0x10c),0x194);const _0x3fbd05=await Contact_1[_0x3d28e3(0x136)][_0x3d28e3(0x107)](_0x4e00a9);if(!_0x3fbd05)throw new AppError_1[(_0x3d28e3(0x136))]('ERR_CONTACT_NOT_FOUND',0x194);let _0x56abe2=null;if(_0x1b0734){_0x56abe2=await Queue_1['default']['findByPk'](_0x1b0734);if(!_0x56abe2)throw new AppError_1['default'](_0x3d28e3(0x143),0x194);if(_0x56abe2[_0x3d28e3(0x12a)]!==_0x124d5f)throw new AppError_1[(_0x3d28e3(0x136))](_0x3d28e3(0x10b),0x193);}if(_0x230212['companyId']!==_0x124d5f||_0x3fbd05['companyId']!==_0x124d5f)throw new AppError_1[(_0x3d28e3(0x136))](_0x3d28e3(0x10b),0x193);return await(0x0,ForwardMessageService_1[_0x3d28e3(0x136)])(_0x1eeb04,_0x230212,_0x3fbd05,_0x56abe2),_0x4eb5ac['send']();};function a24_0xc66f(){const _0x4406aa=['typing','g.us','isGroup','toString','constructor','findByPk','json','../models/User','../services/MessageServices/ListAllMessagesService','ERR_ACCESS_DENIED','ERR_MESSAGE_NOT_FOUND','1052654vlPYwM','query','../helpers/SendPresenceStatus','apply','986420rMnAPD','validator','error','contact','defineProperty','search','map','../models/Contact','number','status','forward','ticket','TicketId\x20is\x20required','true','8EeMPUm','message','../utils/logger','add','../services/TicketServices/ShowTicketService','react','verifyMessage','@s.whatsapp.net','all','1742751gTSstV','store','companyId','SendMessage','body','../services/WbotServices/CheckNumber','parse','channel','key','ERR_WHATSAPP_NOT_FOUND','files','index','SendPausedStatus','getIO','default','s.whatsapp.net','jid','dataJson','queues','../services/WbotServices/SendWhatsAppMessage','find','getWbot','user','profile','app','includes','MessageController.send:\x20','ERR_QUEUE_NOT_FOUND','send','edit','ticketId','replace','push','1323585AjTuNu','sendMessage','stringify','getAll','\x20enviado\x20com\x20sucesso','unlinkSync','1107423nEFXJJ','2406MNQRCS','../services/WbotServices/EditWhatsAppMessage','ERR_WHATSAPP_MESSAGE_NOT_SENT','707yLwoLq','../errors/AppError','forEach','../libs/wbot','215464dursuY','logger','ERR_FORBIDDEN','toBoolean','emit','../services/MessageServices/ForwardMessageService','../models/Message','../services/WbotServices/VerifyHandlers','findOne','(((.+)+)+)+$','get','../models/Queue','dateStart','../services/WbotServices/DeleteWhatsAppMessage','messageQueue','whatsappId','update','admin','remove','-appMessage','whatsapp','params','dateEnd','Ticket\x20not\x20found','../helpers/SetTicketMessagesAsRead'];a24_0xc66f=function(){return _0x4406aa;};return a24_0xc66f();}exports[a24_0xa5fe9(0x11b)]=forward;const send=async(_0x111ccf,_0x3cd10a)=>{const _0x4d7903=a24_0xa5fe9,{whatsappId:_0x4d6840}=_0x111ccf[_0x4d7903(0xfe)],_0x218a3d=_0x111ccf['body'],_0x7bd464=_0x111ccf[_0x4d7903(0x132)];if(_0x218a3d[_0x4d7903(0x119)]===undefined)throw new AppError_1[(_0x4d7903(0x136))]('ERR_SYNTAX',0x190);const _0x4f0d48=await Whatsapp_1['default'][_0x4d7903(0x107)](_0x4d6840);if(!_0x4f0d48)throw new AppError_1[(_0x4d7903(0x136))](_0x4d7903(0x131),0x194);try{let {number:_0x32c7b5}=_0x218a3d;const {body:_0x30617c,linkPreview:_0x48fdc4}=_0x218a3d,_0x1a500e=!!_0x218a3d['saveOnTicket'];if(!_0x32c7b5[_0x4d7903(0x141)]('@')){const _0xd5085c=_0x218a3d[_0x4d7903(0x119)],{companyId:_0x2b8b79}=_0x4f0d48,_0x173fb4=await(0x0,CheckNumber_1['default'])(_0xd5085c,_0x2b8b79,_0x4f0d48);_0x32c7b5=_0x173fb4[_0x4d7903(0x138)][_0x4d7903(0xd9)](/\D/g,'');}return _0x7bd464?await Promise[_0x4d7903(0x127)](_0x7bd464[_0x4d7903(0x117)](async _0x24fb11=>{const _0x506fc3=_0x4d7903;await _0x111ccf[_0x506fc3(0x140)][_0x506fc3(0xf3)](_0x506fc3(0x13a))['messageQueue']['add'](_0x506fc3(0x12b),{'whatsappId':_0x4d6840,'data':{'number':_0x32c7b5,'body':_0x24fb11['originalname'],'mediaPath':_0x24fb11['path'],'saveOnTicket':_0x1a500e}},{'removeOnComplete':!![],'attempts':0x3});})):_0x111ccf['app'][_0x4d7903(0xf3)](_0x4d7903(0x13a))[_0x4d7903(0xf7)][_0x4d7903(0x122)]('SendMessage',{'whatsappId':_0x4d6840,'data':{'number':_0x32c7b5,'body':_0x30617c,'linkPreview':_0x48fdc4,'saveOnTicket':_0x1a500e}},{'removeOnComplete':![],'attempts':0x3}),_0x3cd10a[_0x4d7903(0x144)]({'mensagem':'Message\x20added\x20to\x20queue'});}catch(_0x149fec){const _0x22c916={'errType':typeof _0x149fec,'serialized':JSON[_0x4d7903(0xdd)](_0x149fec),'err':_0x149fec};_0x149fec?.['message']?console[_0x4d7903(0x113)](_0x22c916,_0x4d7903(0x142)+_0x149fec[_0x4d7903(0x120)]):logger_1[_0x4d7903(0xea)][_0x4d7903(0x113)](_0x22c916,'MessageController.send:\x20Failed\x20to\x20put\x20message\x20on\x20queue');throw new AppError_1[(_0x4d7903(0x136))]('ERR_INTERNAL_ERROR',0x1f4);}};exports[a24_0xa5fe9(0x144)]=send;