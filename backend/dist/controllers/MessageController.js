const a30_0x2c4d8d=a30_0x376b;(function(_0x2cb9ca,_0x4cf786){const _0x1a9138=a30_0x376b,_0x293d5b=_0x2cb9ca();while(!![]){try{const _0x196c59=-parseInt(_0x1a9138(0xce))/0x1+parseInt(_0x1a9138(0x113))/0x2+parseInt(_0x1a9138(0xc3))/0x3*(-parseInt(_0x1a9138(0xf6))/0x4)+-parseInt(_0x1a9138(0xef))/0x5*(-parseInt(_0x1a9138(0xbe))/0x6)+-parseInt(_0x1a9138(0xea))/0x7*(parseInt(_0x1a9138(0xe3))/0x8)+parseInt(_0x1a9138(0xf4))/0x9+-parseInt(_0x1a9138(0xa7))/0xa*(-parseInt(_0x1a9138(0xe4))/0xb);if(_0x196c59===_0x4cf786)break;else _0x293d5b['push'](_0x293d5b['shift']());}catch(_0x4d9aae){_0x293d5b['push'](_0x293d5b['shift']());}}}(a30_0x2447,0x620ef));function a30_0x376b(_0x6fee0c,_0x46b2dc){const _0x28d435=a30_0x2447();return a30_0x376b=function(_0x243ec5,_0x3a5d5b){_0x243ec5=_0x243ec5-0xa6;let _0x24470c=_0x28d435[_0x243ec5];return _0x24470c;},a30_0x376b(_0x6fee0c,_0x46b2dc);}const a30_0x3a5d5b=(function(){let _0x148712=!![];return function(_0x3e6367,_0x211343){const _0x101f19=_0x148712?function(){const _0x1c3776=a30_0x376b;if(_0x211343){const _0x2fa690=_0x211343[_0x1c3776(0xf3)](_0x3e6367,arguments);return _0x211343=null,_0x2fa690;}}:function(){};return _0x148712=![],_0x101f19;};}()),a30_0x243ec5=a30_0x3a5d5b(this,function(){const _0x49f251=a30_0x376b;return a30_0x243ec5[_0x49f251(0xd4)]()[_0x49f251(0xab)](_0x49f251(0xc7))[_0x49f251(0xd4)]()['constructor'](a30_0x243ec5)[_0x49f251(0xab)](_0x49f251(0xc7));});a30_0x243ec5();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x22913f){const _0x193d05=a30_0x376b;return _0x22913f&&_0x22913f[_0x193d05(0x10f)]?_0x22913f:{'default':_0x22913f};};Object[a30_0x2c4d8d(0xa6)](exports,a30_0x2c4d8d(0x10f),{'value':!![]}),exports[a30_0x2c4d8d(0xad)]=exports[a30_0x2c4d8d(0x103)]=exports[a30_0x2c4d8d(0xbd)]=exports[a30_0x2c4d8d(0xcb)]=exports['edit']=exports['react']=exports[a30_0x2c4d8d(0xe7)]=exports[a30_0x2c4d8d(0xac)]=exports[a30_0x2c4d8d(0xc5)]=void 0x0;function a30_0x2447(){const _0x57cc97=['company-','79205MqQFpm','TicketId\x20is\x20required','push','true','apply','2376585nalnDG','ERR_WHATSAPP_MESSAGE_NOT_SENT','20ClMVXx','-appMessage','update','SendMessage','../services/MessageServices/ListMessagesService','body','isGroup','Message\x20added\x20to\x20queue','findByPk','../services/WbotServices/DeleteWhatsAppMessage','admin','../models/Queue','saveOnTicket','forward','../models/Message','../services/WbotServices/SendWhatsAppMessage','../models/Whatsapp','react','contact','getWbot','sendMessage','@lid','../services/WbotServices/EditWhatsAppMessage','g.us','dateStart','__esModule','files','\x20enviado\x20com\x20sucesso','ticket','635146BGnzZa','ERR_MESSAGE_NOT_FOUND','replace','defineProperty','112570JrMFFx','@g.us','lid','SendPausedStatus','search','store','send','companyId','find','verifyMessage','queues','findOne','all','remoteJid','fromMe','ticketId','app','forEach','originalname','../libs/socket','s.whatsapp.net','profile','typing','288ZgnBOc','stringify','parse','length','whatsappId','258273usiIRa','number','index','query','(((.+)+)+)+$','../helpers/SetTicketMessagesAsRead','getIO','Ticket\x20not\x20found','remove','../services/MessageServices/ListAllMessagesService','../models/Ticket','64403jirAwO','../services/MessageServices/ForwardMessageService','message','@s.whatsapp.net','messageQueue','json','toString','add','ERR_SYNTAX','user','params','validator','whatsapp','ERR_WHATSAPP_NOT_FOUND','default','error','key','map','../errors/AppError','includes','ERR_ACCESS_DENIED','4920oIUBPK','22siCRWJ','ERR_CONTACT_NOT_FOUND','ERR_FORBIDDEN','getAll','toBoolean','SendTypingStatus','5327PgZQYc','status','dateEnd','get'];a30_0x2447=function(){return _0x57cc97;};return a30_0x2447();}const fs_1=__importDefault(require('fs')),AppError_1=__importDefault(require(a30_0x2c4d8d(0xe0))),SetTicketMessagesAsRead_1=__importDefault(require(a30_0x2c4d8d(0xc8))),socket_1=require(a30_0x2c4d8d(0xba)),Queue_1=__importDefault(require(a30_0x2c4d8d(0x101))),User_1=__importDefault(require('../models/User')),Whatsapp_1=__importDefault(require(a30_0x2c4d8d(0x106))),ListMessagesService_1=__importDefault(require(a30_0x2c4d8d(0xfa))),ShowTicketService_1=__importDefault(require('../services/TicketServices/ShowTicketService')),DeleteWhatsAppMessage_1=__importDefault(require(a30_0x2c4d8d(0xff))),SendWhatsAppMedia_1=__importDefault(require('../services/WbotServices/SendWhatsAppMedia')),SendWhatsAppMessage_1=__importDefault(require(a30_0x2c4d8d(0x105))),CheckNumber_1=__importDefault(require('../services/WbotServices/CheckNumber')),EditWhatsAppMessage_1=__importDefault(require(a30_0x2c4d8d(0x10c))),ListAllMessagesService_1=__importDefault(require(a30_0x2c4d8d(0xcc))),validator_1=require(a30_0x2c4d8d(0xd9)),logger_1=require('../utils/logger'),Message_1=__importDefault(require(a30_0x2c4d8d(0x104))),Contact_1=__importDefault(require('../models/Contact')),Ticket_1=__importDefault(require(a30_0x2c4d8d(0xcd))),ForwardMessageService_1=__importDefault(require(a30_0x2c4d8d(0xcf))),wbot_1=require('../libs/wbot'),VerifyHandlers_1=require('../services/WbotServices/VerifyHandlers'),SendPresenceStatus_1=require('../helpers/SendPresenceStatus'),index=async(_0x4968b2,_0x36281c)=>{const _0x918ef=a30_0x2c4d8d,{ticketId:_0x40b550}=_0x4968b2[_0x918ef(0xd8)],{pageNumber:_0x17cb8b,markAsRead:_0x4226bd}=_0x4968b2[_0x918ef(0xc6)],{companyId:_0x344627,profile:_0x14c18e}=_0x4968b2[_0x918ef(0xd7)],_0x260d87=[];if(_0x14c18e!==_0x918ef(0x100)){const _0x298f3a=await User_1[_0x918ef(0xdc)][_0x918ef(0xfe)](_0x4968b2[_0x918ef(0xd7)]['id'],{'include':[{'model':Queue_1['default'],'as':_0x918ef(0xb1)}]});_0x298f3a['queues'][_0x918ef(0xb8)](_0x51bec6=>{const _0x3ab1a6=_0x918ef;_0x260d87[_0x3ab1a6(0xf1)](_0x51bec6['id']);});}const {count:_0xd4d5bb,messages:_0x3d15b1,ticket:_0x4bcbf6,hasMore:_0x5c510f}=await(0x0,ListMessagesService_1['default'])({'pageNumber':_0x17cb8b,'ticketId':_0x40b550,'companyId':_0x344627,'queues':_0x260d87});return _0x4bcbf6['channel']===_0x918ef(0xda)&&_0x4226bd==='true'&&(0x0,SetTicketMessagesAsRead_1[_0x918ef(0xdc)])(_0x4bcbf6),_0x36281c[_0x918ef(0xd3)]({'count':_0xd4d5bb,'messages':_0x3d15b1,'ticket':_0x4bcbf6,'hasMore':_0x5c510f});};exports[a30_0x2c4d8d(0xc5)]=index;const store=async(_0x4fa717,_0x490f52)=>{const _0x2d53a3=a30_0x2c4d8d,{ticketId:_0xc9ba78}=_0x4fa717[_0x2d53a3(0xd8)],{body:_0xcb41c2,quotedMsg:_0x37acdb}=_0x4fa717[_0x2d53a3(0xfb)],_0x1856d7=_0x4fa717[_0x2d53a3(0x110)],{companyId:_0x25505a}=_0x4fa717[_0x2d53a3(0xd7)],_0x37d3c9=Number(_0x4fa717[_0x2d53a3(0xd7)]['id'])||null,_0x5f214a=await(0x0,ShowTicketService_1[_0x2d53a3(0xdc)])(_0xc9ba78,_0x25505a),{channel:_0x542bcd}=_0x5f214a;_0x542bcd===_0x2d53a3(0xda)&&(0x0,SetTicketMessagesAsRead_1['default'])(_0x5f214a);if(_0x1856d7)_0x542bcd===_0x2d53a3(0xda)&&await Promise[_0x2d53a3(0xb3)](_0x1856d7[_0x2d53a3(0xdf)](async _0x5b03fa=>{const _0x15e5e6=_0x2d53a3;await(0x0,SendWhatsAppMedia_1[_0x15e5e6(0xdc)])({'media':_0x5b03fa,'ticket':_0x5f214a}),fs_1[_0x15e5e6(0xdc)]['unlinkSync'](_0x5b03fa['path']);}));else _0x542bcd===_0x2d53a3(0xda)&&await(0x0,SendWhatsAppMessage_1['default'])({'body':_0xcb41c2,'ticket':_0x5f214a,'userId':_0x37d3c9,'quotedMsg':_0x37acdb});return _0x490f52['send']();};exports[a30_0x2c4d8d(0xac)]=store;const getAll=async(_0x322d5e,_0x277270)=>{const _0x16d209=a30_0x2c4d8d,_0x3b35f6=_0x322d5e[_0x16d209(0xc6)][_0x16d209(0x10e)],_0x3aa8c6=_0x322d5e['query'][_0x16d209(0xec)],_0x289d53=(0x0,validator_1[_0x16d209(0xe8)])(_0x322d5e['query'][_0x16d209(0xb5)]),{companyId:_0x366cf5}=_0x322d5e['user'],{count:_0x35814f}=await(0x0,ListAllMessagesService_1[_0x16d209(0xdc)])({'companyId':_0x366cf5,'fromMe':_0x289d53,'dateStart':_0x3b35f6,'dateEnd':_0x3aa8c6});return _0x277270['json']({'count':_0x35814f});};exports[a30_0x2c4d8d(0xe7)]=getAll;const react=async(_0x35f641,_0x232157)=>{const _0x17f7fa=a30_0x2c4d8d,{messageId:_0xefd7d2}=_0x35f641[_0x17f7fa(0xd8)],{companyId:_0xd19080}=_0x35f641['user'],_0x2d24dc=Number(_0x35f641[_0x17f7fa(0xd7)]['id'])||null,{ticketId:_0x2ce4f5,emoji:_0x1f5fae}=_0x35f641[_0x17f7fa(0xfb)],_0x5b4ba3=await Message_1['default']['findOne']({'where':{'id':_0xefd7d2,'ticketId':_0x2ce4f5}});if(!_0x5b4ba3)throw new AppError_1[(_0x17f7fa(0xdc))]('ERR_MESSAGE_NOT_FOUND',0x194);const _0x3a7c95=await(0x0,ShowTicketService_1['default'])(_0x2ce4f5,_0xd19080),_0x363488=await(0x0,wbot_1[_0x17f7fa(0x109)])(_0x3a7c95[_0x17f7fa(0xc2)]);if(!_0x363488)throw new AppError_1[(_0x17f7fa(0xdc))](_0x17f7fa(0xdb),0x1f4);const _0x2f84f0=JSON[_0x17f7fa(0xc0)](_0x5b4ba3['dataJson']),_0x1c526f=await _0x363488[_0x17f7fa(0x10a)](_0x3a7c95[_0x17f7fa(0x108)][_0x17f7fa(0xb4)]||_0x3a7c95['contact'][_0x17f7fa(0xc4)]+(_0x3a7c95[_0x17f7fa(0xfc)]?_0x17f7fa(0xa8):_0x3a7c95[_0x17f7fa(0x108)]['number'][_0x17f7fa(0xc1)]>0xd?_0x17f7fa(0x10b):_0x17f7fa(0xd1)),{'react':{'text':_0x1f5fae,'key':_0x2f84f0[_0x17f7fa(0xde)]}});if(!_0x1c526f)throw new AppError_1[(_0x17f7fa(0xdc))](_0x17f7fa(0xf5),0x1f4);return await(0x0,VerifyHandlers_1[_0x17f7fa(0xb0)])(_0x1c526f,_0x3a7c95,_0x3a7c95['contact']),_0x232157[_0x17f7fa(0xad)]();};exports[a30_0x2c4d8d(0x107)]=react;const edit=async(_0x214f53,_0x17c06c)=>{const _0x4759db=a30_0x2c4d8d,{messageId:_0x52c34e}=_0x214f53[_0x4759db(0xd8)],{companyId:_0x50dbf1}=_0x214f53[_0x4759db(0xd7)],_0x2f8b9b=Number(_0x214f53['user']['id'])||null,{body:_0x1d8294}=_0x214f53[_0x4759db(0xfb)],{ticketId:_0x5324f0,message:_0x37ba64}=await(0x0,EditWhatsAppMessage_1[_0x4759db(0xdc)])({'messageId':_0x52c34e,'companyId':_0x50dbf1,'userId':_0x2f8b9b,'body':_0x1d8294}),_0x7f07ad=(0x0,socket_1[_0x4759db(0xc9)])();return _0x7f07ad['to'](_0x5324f0[_0x4759db(0xd4)]())['emit'](_0x4759db(0xee)+_0x50dbf1+_0x4759db(0xf7),{'action':_0x4759db(0xf8),'message':_0x37ba64}),_0x17c06c[_0x4759db(0xad)]();};exports['edit']=edit;const remove=async(_0x3da328,_0x41b82c)=>{const _0x40e974=a30_0x2c4d8d,{messageId:_0x228325}=_0x3da328['params'],{companyId:_0x40f9bf}=_0x3da328[_0x40e974(0xd7)],_0x4e4ea3=await(0x0,DeleteWhatsAppMessage_1[_0x40e974(0xdc)])(_0x228325),_0x27fc7f=(0x0,socket_1[_0x40e974(0xc9)])();return _0x27fc7f['to'](_0x4e4ea3[_0x40e974(0xb6)][_0x40e974(0xd4)]())['emit'](_0x40e974(0xee)+_0x40f9bf+_0x40e974(0xf7),{'action':_0x40e974(0xf8),'message':_0x4e4ea3}),_0x41b82c[_0x40e974(0xad)]();};exports['remove']=remove;const typing=async(_0x809dc9,_0x203238)=>{const _0x273dcf=a30_0x2c4d8d,{ticketId:_0x260d8e}=_0x809dc9[_0x273dcf(0xd8)],{companyId:_0x27621b}=_0x809dc9['user'],{status:_0x470269}=_0x809dc9[_0x273dcf(0xc6)];if(!_0x260d8e)return _0x203238['status'](0x190)[_0x273dcf(0xad)](_0x273dcf(0xf0));const _0x25abc7=await(0x0,ShowTicketService_1[_0x273dcf(0xdc)])(_0x260d8e,_0x27621b);if(!_0x25abc7)return _0x203238[_0x273dcf(0xeb)](0x194)[_0x273dcf(0xad)](_0x273dcf(0xca));let _0xded929=(0x0,wbot_1['getWbot'])(_0x25abc7[_0x273dcf(0xc2)]);return _0x470269==_0x273dcf(0xf2)?await(0x0,SendPresenceStatus_1[_0x273dcf(0xe9)])(_0xded929,_0x25abc7[_0x273dcf(0x108)][_0x273dcf(0xb4)]||_0x25abc7[_0x273dcf(0x108)][_0x273dcf(0xc4)]+'@'+(_0x25abc7[_0x273dcf(0xfc)]?_0x273dcf(0x10d):_0x25abc7['contact'][_0x273dcf(0xc4)][_0x273dcf(0xc1)]>0xd?_0x273dcf(0xa9):_0x273dcf(0xbb))):await(0x0,SendPresenceStatus_1[_0x273dcf(0xaa)])(_0xded929,_0x25abc7[_0x273dcf(0x108)][_0x273dcf(0xb4)]||_0x25abc7[_0x273dcf(0x108)][_0x273dcf(0xc4)]+'@'+(_0x25abc7['isGroup']?_0x273dcf(0x10d):_0x25abc7[_0x273dcf(0x108)][_0x273dcf(0xc4)][_0x273dcf(0xc1)]>0xd?_0x273dcf(0xa9):_0x273dcf(0xbb))),_0x203238['status'](0xc8)[_0x273dcf(0xad)]('Status\x20'+_0x470269+_0x273dcf(0x111));};exports[a30_0x2c4d8d(0xbd)]=typing;const forward=async(_0xa2d09,_0x3bd812)=>{const _0x2b40a0=a30_0x2c4d8d,{contactId:_0x127be9,ticketId:_0x4bb126,messageId:_0x298b1a,queueId:_0x1df936}=_0xa2d09['body'],{companyId:_0x209674}=_0xa2d09[_0x2b40a0(0xd7)],_0x4697f2=await User_1[_0x2b40a0(0xdc)][_0x2b40a0(0xfe)](_0xa2d09[_0x2b40a0(0xd7)]['id'],{'include':[{'model':Queue_1[_0x2b40a0(0xdc)],'as':_0x2b40a0(0xb1)}]});if(_0x1df936&&_0x4697f2[_0x2b40a0(0xbc)]!==_0x2b40a0(0x100)&&!_0x4697f2['queues'][_0x2b40a0(0xaf)](_0x60a619=>_0x60a619['id']===_0x1df936))throw new AppError_1[(_0x2b40a0(0xdc))](_0x2b40a0(0xe6),0x193);const _0x325575=await Message_1[_0x2b40a0(0xdc)][_0x2b40a0(0xb2)]({'where':{'id':_0x298b1a,'ticketId':_0x4bb126},'include':[{'model':Ticket_1['default'],'as':_0x2b40a0(0x112),'include':[{'model':Whatsapp_1[_0x2b40a0(0xdc)],'as':_0x2b40a0(0xda)}]},{'model':Contact_1[_0x2b40a0(0xdc)],'as':_0x2b40a0(0x108)}]});if(!_0x325575)throw new AppError_1[(_0x2b40a0(0xdc))](_0x2b40a0(0x114),0x194);const _0x5bf0e0=await Contact_1[_0x2b40a0(0xdc)]['findByPk'](_0x127be9);if(!_0x5bf0e0)throw new AppError_1[(_0x2b40a0(0xdc))](_0x2b40a0(0xe5),0x194);let _0x20046c=null;if(_0x1df936){_0x20046c=await Queue_1[_0x2b40a0(0xdc)][_0x2b40a0(0xfe)](_0x1df936);if(!_0x20046c)throw new AppError_1[(_0x2b40a0(0xdc))]('ERR_QUEUE_NOT_FOUND',0x194);if(_0x20046c[_0x2b40a0(0xae)]!==_0x209674)throw new AppError_1['default']('ERR_ACCESS_DENIED',0x193);}if(_0x325575['companyId']!==_0x209674||_0x5bf0e0[_0x2b40a0(0xae)]!==_0x209674)throw new AppError_1[(_0x2b40a0(0xdc))](_0x2b40a0(0xe2),0x193);return await(0x0,ForwardMessageService_1[_0x2b40a0(0xdc)])(_0x4697f2,_0x325575,_0x5bf0e0,_0x20046c),_0x3bd812[_0x2b40a0(0xad)]();};exports[a30_0x2c4d8d(0x103)]=forward;const send=async(_0x46f41f,_0x628825)=>{const _0xfc8b9=a30_0x2c4d8d,{whatsappId:_0x3ac178}=_0x46f41f[_0xfc8b9(0xd8)],_0x4bf78f=_0x46f41f[_0xfc8b9(0xfb)],_0xc354f3=_0x46f41f[_0xfc8b9(0x110)];if(_0x4bf78f['number']===undefined)throw new AppError_1[(_0xfc8b9(0xdc))](_0xfc8b9(0xd6),0x190);const _0x4f87ea=await Whatsapp_1[_0xfc8b9(0xdc)][_0xfc8b9(0xfe)](_0x3ac178);if(!_0x4f87ea)throw new AppError_1['default'](_0xfc8b9(0xdb),0x194);try{let {number:_0x43097f}=_0x4bf78f;const {body:_0x5d7eeb,linkPreview:_0x23b1d4}=_0x4bf78f,_0x3a6fb4=!!_0x4bf78f[_0xfc8b9(0x102)];if(!_0x43097f[_0xfc8b9(0xe1)]('@')){const _0xb87559=_0x4bf78f[_0xfc8b9(0xc4)],{companyId:_0x3523e8}=_0x4f87ea,_0x5739ca=await(0x0,CheckNumber_1[_0xfc8b9(0xdc)])(_0xb87559,_0x3523e8,_0x4f87ea);_0x43097f=_0x5739ca['jid'][_0xfc8b9(0x115)](/\D/g,'');}return _0xc354f3?await Promise[_0xfc8b9(0xb3)](_0xc354f3['map'](async _0x23e039=>{const _0x297cc6=_0xfc8b9;await _0x46f41f[_0x297cc6(0xb7)][_0x297cc6(0xed)](_0x297cc6(0xb1))['messageQueue'][_0x297cc6(0xd5)](_0x297cc6(0xf9),{'whatsappId':_0x3ac178,'data':{'number':_0x43097f,'body':_0x23e039[_0x297cc6(0xb9)],'mediaPath':_0x23e039['path'],'saveOnTicket':_0x3a6fb4}},{'removeOnComplete':!![],'attempts':0x3});})):_0x46f41f[_0xfc8b9(0xb7)][_0xfc8b9(0xed)](_0xfc8b9(0xb1))[_0xfc8b9(0xd2)][_0xfc8b9(0xd5)](_0xfc8b9(0xf9),{'whatsappId':_0x3ac178,'data':{'number':_0x43097f,'body':_0x5d7eeb,'linkPreview':_0x23b1d4,'saveOnTicket':_0x3a6fb4}},{'removeOnComplete':![],'attempts':0x3}),_0x628825[_0xfc8b9(0xad)]({'mensagem':_0xfc8b9(0xfd)});}catch(_0x4708ac){const _0x2d48fc={'errType':typeof _0x4708ac,'serialized':JSON[_0xfc8b9(0xbf)](_0x4708ac),'err':_0x4708ac};_0x4708ac?.[_0xfc8b9(0xd0)]?console['error'](_0x2d48fc,'MessageController.send:\x20'+_0x4708ac['message']):logger_1['logger'][_0xfc8b9(0xdd)](_0x2d48fc,'MessageController.send:\x20Failed\x20to\x20put\x20message\x20on\x20queue');throw new AppError_1[(_0xfc8b9(0xdc))]('ERR_INTERNAL_ERROR',0x1f4);}};exports[a30_0x2c4d8d(0xad)]=send;