const a24_0x9c8421=a24_0x2e9d;(function(_0x256275,_0x4b1bb8){const _0x241f9a=a24_0x2e9d,_0x477e67=_0x256275();while(!![]){try{const _0x412498=-parseInt(_0x241f9a(0x249))/0x1*(parseInt(_0x241f9a(0x1e7))/0x2)+-parseInt(_0x241f9a(0x241))/0x3*(-parseInt(_0x241f9a(0x207))/0x4)+-parseInt(_0x241f9a(0x1e0))/0x5*(-parseInt(_0x241f9a(0x230))/0x6)+parseInt(_0x241f9a(0x20e))/0x7+parseInt(_0x241f9a(0x248))/0x8+parseInt(_0x241f9a(0x22c))/0x9+-parseInt(_0x241f9a(0x244))/0xa;if(_0x412498===_0x4b1bb8)break;else _0x477e67['push'](_0x477e67['shift']());}catch(_0x4ba7bf){_0x477e67['push'](_0x477e67['shift']());}}}(a24_0x240d,0x9807a));const a24_0x151376=(function(){let _0x3157cc=!![];return function(_0x506d2e,_0x53f594){const _0x1249dd=_0x3157cc?function(){if(_0x53f594){const _0x1c2c2f=_0x53f594['apply'](_0x506d2e,arguments);return _0x53f594=null,_0x1c2c2f;}}:function(){};return _0x3157cc=![],_0x1249dd;};}()),a24_0x45883d=a24_0x151376(this,function(){const _0xf2e747=a24_0x2e9d;return a24_0x45883d['toString']()['search'](_0xf2e747(0x1e8))[_0xf2e747(0x1df)]()[_0xf2e747(0x21d)](a24_0x45883d)['search'](_0xf2e747(0x1e8));});a24_0x45883d();function a24_0x240d(){const _0xebe9f7=['user','add','ticketId','query','constructor','s.whatsapp.net','status','error','message','ERR_CONTACT_NOT_FOUND','SendPausedStatus','findOne','getWbot','../services/WbotServices/SendWhatsAppMedia','body','files','ERR_SYNTAX','forward','default','270603opPfIg','../models/Message','react','../models/User','1734KkoIRr','params','store','\x20enviado\x20com\x20sucesso','../models/Whatsapp','../services/MessageServices/ListAllMessagesService','profile','../services/MessageServices/ListMessagesService','../services/WbotServices/SendWhatsAppMessage','whatsapp','app','validator','__esModule','SendTypingStatus','replace','stringify','number','418038SMrXNx','forEach','contact','3357020osYPeN','edit','../services/WbotServices/DeleteWhatsAppMessage','fromMe','7294856Pkljmp','2TkZuIG','-appMessage','find','ERR_QUEUE_NOT_FOUND','../utils/logger','TicketId\x20is\x20required','saveOnTicket','toString','7990itAzVN','ticket','dateEnd','send','channel','SendMessage','getIO','1093706dYWXud','(((.+)+)+)+$','Status\x20','all','messageQueue','index','findByPk','admin','update','map','MessageController.send:\x20Failed\x20to\x20put\x20message\x20on\x20queue','includes','emit','ERR_WHATSAPP_NOT_FOUND','../models/Contact','ERR_FORBIDDEN','Message\x20added\x20to\x20queue','companyId','whatsappId','../helpers/SetTicketMessagesAsRead','ERR_ACCESS_DENIED','../libs/socket','typing','../errors/AppError','unlinkSync','remove','logger','../models/Queue','true','parse','__importDefault','json','16wDZqtD','defineProperty','../models/Ticket','@s.whatsapp.net','toBoolean','../services/TicketServices/ShowTicketService','../services/WbotServices/EditWhatsAppMessage','636944YffdvD','../helpers/SendPresenceStatus','path','../libs/wbot','jid','get','../services/MessageServices/ForwardMessageService','company-','isGroup','queues','getAll'];a24_0x240d=function(){return _0xebe9f7;};return a24_0x240d();}'use strict';var __importDefault=this&&this[a24_0x9c8421(0x205)]||function(_0x1fbefb){const _0x397e47=a24_0x9c8421;return _0x1fbefb&&_0x1fbefb[_0x397e47(0x23c)]?_0x1fbefb:{'default':_0x1fbefb};};Object[a24_0x9c8421(0x208)](exports,a24_0x9c8421(0x23c),{'value':!![]}),exports[a24_0x9c8421(0x1e3)]=exports[a24_0x9c8421(0x22a)]=exports[a24_0x9c8421(0x1fd)]=exports[a24_0x9c8421(0x200)]=exports[a24_0x9c8421(0x245)]=exports[a24_0x9c8421(0x22e)]=exports[a24_0x9c8421(0x218)]=exports[a24_0x9c8421(0x232)]=exports['index']=void 0x0;const fs_1=__importDefault(require('fs')),AppError_1=__importDefault(require(a24_0x9c8421(0x1fe))),SetTicketMessagesAsRead_1=__importDefault(require(a24_0x9c8421(0x1fa))),socket_1=require(a24_0x9c8421(0x1fc)),Queue_1=__importDefault(require(a24_0x9c8421(0x202))),User_1=__importDefault(require(a24_0x9c8421(0x22f))),Whatsapp_1=__importDefault(require(a24_0x9c8421(0x234))),ListMessagesService_1=__importDefault(require(a24_0x9c8421(0x237))),ShowTicketService_1=__importDefault(require(a24_0x9c8421(0x20c))),DeleteWhatsAppMessage_1=__importDefault(require(a24_0x9c8421(0x246))),SendWhatsAppMedia_1=__importDefault(require(a24_0x9c8421(0x226))),SendWhatsAppMessage_1=__importDefault(require(a24_0x9c8421(0x238))),CheckNumber_1=__importDefault(require('../services/WbotServices/CheckNumber')),EditWhatsAppMessage_1=__importDefault(require(a24_0x9c8421(0x20d))),ListAllMessagesService_1=__importDefault(require(a24_0x9c8421(0x235))),validator_1=require(a24_0x9c8421(0x23b)),logger_1=require(a24_0x9c8421(0x1dc)),Message_1=__importDefault(require(a24_0x9c8421(0x22d))),Contact_1=__importDefault(require(a24_0x9c8421(0x1f5))),Ticket_1=__importDefault(require(a24_0x9c8421(0x209))),ForwardMessageService_1=__importDefault(require(a24_0x9c8421(0x214))),wbot_1=require(a24_0x9c8421(0x211)),VerifyHandlers_1=require('../services/WbotServices/VerifyHandlers'),SendPresenceStatus_1=require(a24_0x9c8421(0x20f)),index=async(_0x516bde,_0xf78a67)=>{const _0x5a077a=a24_0x9c8421,{ticketId:_0x3b6e18}=_0x516bde[_0x5a077a(0x231)],{pageNumber:_0x39ddc4,markAsRead:_0x1ed6a6}=_0x516bde[_0x5a077a(0x21c)],{companyId:_0x17b4a5,profile:_0x12fdef}=_0x516bde[_0x5a077a(0x219)],_0x5e9237=[];if(_0x12fdef!==_0x5a077a(0x1ee)){const _0x985126=await User_1[_0x5a077a(0x22b)][_0x5a077a(0x1ed)](_0x516bde[_0x5a077a(0x219)]['id'],{'include':[{'model':Queue_1[_0x5a077a(0x22b)],'as':_0x5a077a(0x217)}]});_0x985126[_0x5a077a(0x217)][_0x5a077a(0x242)](_0x4f6567=>{_0x5e9237['push'](_0x4f6567['id']);});}const {count:_0x491e1b,messages:_0x2d0380,ticket:_0x5aa701,hasMore:_0x146618}=await(0x0,ListMessagesService_1[_0x5a077a(0x22b)])({'pageNumber':_0x39ddc4,'ticketId':_0x3b6e18,'companyId':_0x17b4a5,'queues':_0x5e9237});return _0x5aa701[_0x5a077a(0x1e4)]==='whatsapp'&&_0x1ed6a6===_0x5a077a(0x203)&&(0x0,SetTicketMessagesAsRead_1[_0x5a077a(0x22b)])(_0x5aa701),_0xf78a67['json']({'count':_0x491e1b,'messages':_0x2d0380,'ticket':_0x5aa701,'hasMore':_0x146618});};exports[a24_0x9c8421(0x1ec)]=index;const store=async(_0x50732f,_0x647d62)=>{const _0x4d1d15=a24_0x9c8421,{ticketId:_0x17b314}=_0x50732f[_0x4d1d15(0x231)],{body:_0x473ea6,quotedMsg:_0x3fcde0}=_0x50732f['body'],_0xe7be9b=_0x50732f[_0x4d1d15(0x228)],{companyId:_0x5214d4}=_0x50732f[_0x4d1d15(0x219)],_0x197893=Number(_0x50732f[_0x4d1d15(0x219)]['id'])||null,_0x5880c2=await(0x0,ShowTicketService_1[_0x4d1d15(0x22b)])(_0x17b314,_0x5214d4),{channel:_0x257011}=_0x5880c2;_0x257011===_0x4d1d15(0x239)&&(0x0,SetTicketMessagesAsRead_1[_0x4d1d15(0x22b)])(_0x5880c2);if(_0xe7be9b)_0x257011===_0x4d1d15(0x239)&&await Promise[_0x4d1d15(0x1ea)](_0xe7be9b[_0x4d1d15(0x1f0)](async _0x45237e=>{const _0xf720d3=_0x4d1d15;await(0x0,SendWhatsAppMedia_1['default'])({'media':_0x45237e,'ticket':_0x5880c2}),fs_1[_0xf720d3(0x22b)][_0xf720d3(0x1ff)](_0x45237e[_0xf720d3(0x210)]);}));else _0x257011===_0x4d1d15(0x239)&&await(0x0,SendWhatsAppMessage_1[_0x4d1d15(0x22b)])({'body':_0x473ea6,'ticket':_0x5880c2,'userId':_0x197893,'quotedMsg':_0x3fcde0});return _0x647d62[_0x4d1d15(0x1e3)]();};exports['store']=store;const getAll=async(_0x539ff5,_0x3dbe4f)=>{const _0x1e03f8=a24_0x9c8421,_0x3964d5=_0x539ff5[_0x1e03f8(0x21c)]['dateStart'],_0x21a5d6=_0x539ff5[_0x1e03f8(0x21c)][_0x1e03f8(0x1e2)],_0x26610f=(0x0,validator_1[_0x1e03f8(0x20b)])(_0x539ff5[_0x1e03f8(0x21c)][_0x1e03f8(0x247)]),{companyId:_0x346923}=_0x539ff5[_0x1e03f8(0x219)],{count:_0x20ea23}=await(0x0,ListAllMessagesService_1['default'])({'companyId':_0x346923,'fromMe':_0x26610f,'dateStart':_0x3964d5,'dateEnd':_0x21a5d6});return _0x3dbe4f[_0x1e03f8(0x206)]({'count':_0x20ea23});};exports[a24_0x9c8421(0x218)]=getAll;const react=async(_0x268d1d,_0x495c0d)=>{const _0x1d7c82=a24_0x9c8421,{messageId:_0x5b00e5}=_0x268d1d[_0x1d7c82(0x231)],{companyId:_0x3bbe52}=_0x268d1d[_0x1d7c82(0x219)],_0xde9cd2=Number(_0x268d1d[_0x1d7c82(0x219)]['id'])||null,{ticketId:_0x51773f,emoji:_0x5d4db8}=_0x268d1d[_0x1d7c82(0x227)],_0x580496=await Message_1[_0x1d7c82(0x22b)][_0x1d7c82(0x224)]({'where':{'id':_0x5b00e5,'ticketId':_0x51773f}});if(!_0x580496)throw new AppError_1['default']('ERR_MESSAGE_NOT_FOUND',0x194);const _0x402fef=await(0x0,ShowTicketService_1[_0x1d7c82(0x22b)])(_0x51773f,_0x3bbe52),_0x45bbb6=await(0x0,wbot_1[_0x1d7c82(0x225)])(_0x402fef[_0x1d7c82(0x1f9)]);if(!_0x45bbb6)throw new AppError_1[(_0x1d7c82(0x22b))](_0x1d7c82(0x1f4),0x1f4);const _0x55f020=JSON[_0x1d7c82(0x204)](_0x580496['dataJson']),_0xc8105=await _0x45bbb6['sendMessage'](_0x402fef[_0x1d7c82(0x243)]['number']+(_0x402fef['isGroup']?'@g.us':_0x1d7c82(0x20a)),{'react':{'text':_0x5d4db8,'key':_0x55f020['key']}});if(!_0xc8105)throw new AppError_1['default']('ERR_WHATSAPP_MESSAGE_NOT_SENT',0x1f4);return await(0x0,VerifyHandlers_1['verifyMessage'])(_0xc8105,_0x402fef,_0x402fef[_0x1d7c82(0x243)]),_0x495c0d[_0x1d7c82(0x1e3)]();};exports[a24_0x9c8421(0x22e)]=react;const edit=async(_0x22a503,_0x1c812e)=>{const _0x256bb4=a24_0x9c8421,{messageId:_0x1b4d8d}=_0x22a503[_0x256bb4(0x231)],{companyId:_0x325921}=_0x22a503['user'],_0x3781a8=Number(_0x22a503['user']['id'])||null,{body:_0x2913b9}=_0x22a503['body'],{ticketId:_0x446b0d,message:_0x2ff0af}=await(0x0,EditWhatsAppMessage_1[_0x256bb4(0x22b)])({'messageId':_0x1b4d8d,'companyId':_0x325921,'userId':_0x3781a8,'body':_0x2913b9}),_0x54fb39=(0x0,socket_1[_0x256bb4(0x1e6)])();return _0x54fb39['to'](_0x446b0d['toString']())[_0x256bb4(0x1f3)]('company-'+_0x325921+'-appMessage',{'action':_0x256bb4(0x1ef),'message':_0x2ff0af}),_0x1c812e[_0x256bb4(0x1e3)]();};exports['edit']=edit;const remove=async(_0x3f17e8,_0x1d83c6)=>{const _0xb16b29=a24_0x9c8421,{messageId:_0x291721}=_0x3f17e8[_0xb16b29(0x231)],{companyId:_0x2602c6}=_0x3f17e8[_0xb16b29(0x219)],_0xaa2283=await(0x0,DeleteWhatsAppMessage_1[_0xb16b29(0x22b)])(_0x291721),_0x5769ef=(0x0,socket_1[_0xb16b29(0x1e6)])();return _0x5769ef['to'](_0xaa2283[_0xb16b29(0x21b)][_0xb16b29(0x1df)]())[_0xb16b29(0x1f3)](_0xb16b29(0x215)+_0x2602c6+_0xb16b29(0x1d9),{'action':_0xb16b29(0x1ef),'message':_0xaa2283}),_0x1d83c6[_0xb16b29(0x1e3)]();};exports[a24_0x9c8421(0x200)]=remove;function a24_0x2e9d(_0x44c802,_0x444bfd){const _0x147455=a24_0x240d();return a24_0x2e9d=function(_0x45883d,_0x151376){_0x45883d=_0x45883d-0x1d9;let _0x240d91=_0x147455[_0x45883d];return _0x240d91;},a24_0x2e9d(_0x44c802,_0x444bfd);}const typing=async(_0xd5bc1c,_0x5714c0)=>{const _0x29b2c7=a24_0x9c8421,{ticketId:_0x2c19f9}=_0xd5bc1c[_0x29b2c7(0x231)],{companyId:_0x3adc46}=_0xd5bc1c[_0x29b2c7(0x219)],{status:_0x4aa8da}=_0xd5bc1c[_0x29b2c7(0x21c)];if(!_0x2c19f9)return _0x5714c0['status'](0x190)['send'](_0x29b2c7(0x1dd));const _0x3a90d3=await(0x0,ShowTicketService_1[_0x29b2c7(0x22b)])(_0x2c19f9,_0x3adc46);if(!_0x3a90d3)return _0x5714c0['status'](0x194)[_0x29b2c7(0x1e3)]('Ticket\x20not\x20found');let _0x202e68=(0x0,wbot_1['getWbot'])(_0x3a90d3[_0x29b2c7(0x1f9)]);return _0x4aa8da==_0x29b2c7(0x203)?await(0x0,SendPresenceStatus_1[_0x29b2c7(0x23d)])(_0x202e68,_0x3a90d3[_0x29b2c7(0x243)][_0x29b2c7(0x240)]+'@'+(_0x3a90d3[_0x29b2c7(0x216)]?'g.us':_0x29b2c7(0x21e))):await(0x0,SendPresenceStatus_1[_0x29b2c7(0x223)])(_0x202e68,_0x3a90d3[_0x29b2c7(0x243)][_0x29b2c7(0x240)]+'@'+(_0x3a90d3[_0x29b2c7(0x216)]?'g.us':'s.whatsapp.net')),_0x5714c0[_0x29b2c7(0x21f)](0xc8)['send'](_0x29b2c7(0x1e9)+_0x4aa8da+_0x29b2c7(0x233));};exports['typing']=typing;const forward=async(_0x5841d3,_0x430bd7)=>{const _0x17c6e0=a24_0x9c8421,{contactId:_0x779306,ticketId:_0x3dbea3,messageId:_0x2d1100,queueId:_0x388346}=_0x5841d3[_0x17c6e0(0x227)],{companyId:_0x2d9ecd}=_0x5841d3[_0x17c6e0(0x219)],_0x5b7724=await User_1['default'][_0x17c6e0(0x1ed)](_0x5841d3['user']['id'],{'include':[{'model':Queue_1[_0x17c6e0(0x22b)],'as':_0x17c6e0(0x217)}]});if(_0x388346&&_0x5b7724[_0x17c6e0(0x236)]!==_0x17c6e0(0x1ee)&&!_0x5b7724[_0x17c6e0(0x217)][_0x17c6e0(0x1da)](_0x336b07=>_0x336b07['id']===_0x388346))throw new AppError_1['default'](_0x17c6e0(0x1f6),0x193);const _0x4c2a46=await Message_1[_0x17c6e0(0x22b)][_0x17c6e0(0x224)]({'where':{'id':_0x2d1100,'ticketId':_0x3dbea3},'include':[{'model':Ticket_1[_0x17c6e0(0x22b)],'as':_0x17c6e0(0x1e1),'include':[{'model':Whatsapp_1[_0x17c6e0(0x22b)],'as':'whatsapp'}]},{'model':Contact_1[_0x17c6e0(0x22b)],'as':_0x17c6e0(0x243)}]});if(!_0x4c2a46)throw new AppError_1[(_0x17c6e0(0x22b))]('ERR_MESSAGE_NOT_FOUND',0x194);const _0xaefc3c=await Contact_1[_0x17c6e0(0x22b)]['findByPk'](_0x779306);if(!_0xaefc3c)throw new AppError_1[(_0x17c6e0(0x22b))](_0x17c6e0(0x222),0x194);let _0x521900=null;if(_0x388346){_0x521900=await Queue_1[_0x17c6e0(0x22b)][_0x17c6e0(0x1ed)](_0x388346);if(!_0x521900)throw new AppError_1[(_0x17c6e0(0x22b))](_0x17c6e0(0x1db),0x194);if(_0x521900[_0x17c6e0(0x1f8)]!==_0x2d9ecd)throw new AppError_1[(_0x17c6e0(0x22b))](_0x17c6e0(0x1fb),0x193);}if(_0x4c2a46[_0x17c6e0(0x1f8)]!==_0x2d9ecd||_0xaefc3c[_0x17c6e0(0x1f8)]!==_0x2d9ecd)throw new AppError_1[(_0x17c6e0(0x22b))](_0x17c6e0(0x1fb),0x193);return await(0x0,ForwardMessageService_1[_0x17c6e0(0x22b)])(_0x5b7724,_0x4c2a46,_0xaefc3c,_0x521900),_0x430bd7[_0x17c6e0(0x1e3)]();};exports[a24_0x9c8421(0x22a)]=forward;const send=async(_0x47aeda,_0x5b6144)=>{const _0x261f7f=a24_0x9c8421,{whatsappId:_0x4fd3ec}=_0x47aeda[_0x261f7f(0x231)],_0x21b7be=_0x47aeda[_0x261f7f(0x227)],_0x342deb=_0x47aeda[_0x261f7f(0x228)];if(_0x21b7be[_0x261f7f(0x240)]===undefined)throw new AppError_1[(_0x261f7f(0x22b))](_0x261f7f(0x229),0x190);const _0x4a22ad=await Whatsapp_1['default'][_0x261f7f(0x1ed)](_0x4fd3ec);if(!_0x4a22ad)throw new AppError_1[(_0x261f7f(0x22b))]('ERR_WHATSAPP_NOT_FOUND',0x194);try{let {number:_0x365cff}=_0x21b7be;const {body:_0x893666,linkPreview:_0x55c47a}=_0x21b7be,_0x34869a=!!_0x21b7be[_0x261f7f(0x1de)];if(!_0x365cff[_0x261f7f(0x1f2)]('@')){const _0x582673=_0x21b7be[_0x261f7f(0x240)],{companyId:_0x38650b}=_0x4a22ad,_0x1a7e3b=await(0x0,CheckNumber_1[_0x261f7f(0x22b)])(_0x582673,_0x38650b,_0x4a22ad);_0x365cff=_0x1a7e3b[_0x261f7f(0x212)][_0x261f7f(0x23e)](/\D/g,'');}return _0x342deb?await Promise[_0x261f7f(0x1ea)](_0x342deb[_0x261f7f(0x1f0)](async _0x5e3d57=>{const _0x11b1d6=_0x261f7f;await _0x47aeda['app'][_0x11b1d6(0x213)](_0x11b1d6(0x217))[_0x11b1d6(0x1eb)][_0x11b1d6(0x21a)](_0x11b1d6(0x1e5),{'whatsappId':_0x4fd3ec,'data':{'number':_0x365cff,'body':_0x5e3d57['originalname'],'mediaPath':_0x5e3d57[_0x11b1d6(0x210)],'saveOnTicket':_0x34869a}},{'removeOnComplete':!![],'attempts':0x3});})):_0x47aeda[_0x261f7f(0x23a)][_0x261f7f(0x213)](_0x261f7f(0x217))[_0x261f7f(0x1eb)][_0x261f7f(0x21a)](_0x261f7f(0x1e5),{'whatsappId':_0x4fd3ec,'data':{'number':_0x365cff,'body':_0x893666,'linkPreview':_0x55c47a,'saveOnTicket':_0x34869a}},{'removeOnComplete':![],'attempts':0x3}),_0x5b6144[_0x261f7f(0x1e3)]({'mensagem':_0x261f7f(0x1f7)});}catch(_0x2df2e1){const _0x2bc89c={'errType':typeof _0x2df2e1,'serialized':JSON[_0x261f7f(0x23f)](_0x2df2e1),'err':_0x2df2e1};_0x2df2e1?.[_0x261f7f(0x221)]?console[_0x261f7f(0x220)](_0x2bc89c,'MessageController.send:\x20'+_0x2df2e1['message']):logger_1[_0x261f7f(0x201)][_0x261f7f(0x220)](_0x2bc89c,_0x261f7f(0x1f1));throw new AppError_1[(_0x261f7f(0x22b))]('ERR_INTERNAL_ERROR',0x1f4);}};exports[a24_0x9c8421(0x1e3)]=send;