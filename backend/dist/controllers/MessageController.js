const a30_0x3593bf=a30_0x1894;function a30_0x1894(_0xe08991,_0x12422e){const _0x288f91=a30_0xb7f9();return a30_0x1894=function(_0x45f954,_0x5d94c0){_0x45f954=_0x45f954-0xc9;let _0xb7f98a=_0x288f91[_0x45f954];return _0xb7f98a;},a30_0x1894(_0xe08991,_0x12422e);}(function(_0x3a852f,_0x3ea75c){const _0x4262d8=a30_0x1894,_0x285129=_0x3a852f();while(!![]){try{const _0x2c1a8f=-parseInt(_0x4262d8(0x10f))/0x1*(parseInt(_0x4262d8(0x101))/0x2)+-parseInt(_0x4262d8(0xed))/0x3*(-parseInt(_0x4262d8(0x11c))/0x4)+parseInt(_0x4262d8(0x137))/0x5*(-parseInt(_0x4262d8(0x112))/0x6)+-parseInt(_0x4262d8(0xf4))/0x7+-parseInt(_0x4262d8(0x123))/0x8*(-parseInt(_0x4262d8(0xd0))/0x9)+parseInt(_0x4262d8(0xd7))/0xa*(-parseInt(_0x4262d8(0xca))/0xb)+-parseInt(_0x4262d8(0x102))/0xc*(-parseInt(_0x4262d8(0x12c))/0xd);if(_0x2c1a8f===_0x3ea75c)break;else _0x285129['push'](_0x285129['shift']());}catch(_0x313ed8){_0x285129['push'](_0x285129['shift']());}}}(a30_0xb7f9,0x5fbf5));const a30_0x5d94c0=(function(){let _0x31393d=!![];return function(_0x27cc9e,_0x46c073){const _0x3e85ac=_0x31393d?function(){const _0x472582=a30_0x1894;if(_0x46c073){const _0x2ad425=_0x46c073[_0x472582(0x120)](_0x27cc9e,arguments);return _0x46c073=null,_0x2ad425;}}:function(){};return _0x31393d=![],_0x3e85ac;};}()),a30_0x45f954=a30_0x5d94c0(this,function(){const _0x1fe1ba=a30_0x1894;return a30_0x45f954[_0x1fe1ba(0xe3)]()[_0x1fe1ba(0xe9)](_0x1fe1ba(0x12d))['toString']()[_0x1fe1ba(0xd9)](a30_0x45f954)['search'](_0x1fe1ba(0x12d));});a30_0x45f954();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x539f92){const _0x30e822=a30_0x1894;return _0x539f92&&_0x539f92[_0x30e822(0xcb)]?_0x539f92:{'default':_0x539f92};};Object[a30_0x3593bf(0xcf)](exports,a30_0x3593bf(0xcb),{'value':!![]}),exports[a30_0x3593bf(0x10e)]=exports[a30_0x3593bf(0x138)]=exports[a30_0x3593bf(0xcd)]=exports['remove']=exports[a30_0x3593bf(0x10a)]=exports[a30_0x3593bf(0xdc)]=exports[a30_0x3593bf(0xfc)]=exports[a30_0x3593bf(0x134)]=exports['index']=void 0x0;const fs_1=__importDefault(require('fs')),AppError_1=__importDefault(require('../errors/AppError')),SetTicketMessagesAsRead_1=__importDefault(require('../helpers/SetTicketMessagesAsRead')),socket_1=require(a30_0x3593bf(0xf2)),Queue_1=__importDefault(require(a30_0x3593bf(0xee))),User_1=__importDefault(require(a30_0x3593bf(0x126))),Whatsapp_1=__importDefault(require(a30_0x3593bf(0xe5))),ListMessagesService_1=__importDefault(require(a30_0x3593bf(0xf3))),ShowTicketService_1=__importDefault(require(a30_0x3593bf(0xd4))),DeleteWhatsAppMessage_1=__importDefault(require(a30_0x3593bf(0x104))),SendWhatsAppMedia_1=__importDefault(require('../services/WbotServices/SendWhatsAppMedia')),SendWhatsAppMessage_1=__importDefault(require(a30_0x3593bf(0xe6))),CheckNumber_1=__importDefault(require(a30_0x3593bf(0x107))),EditWhatsAppMessage_1=__importDefault(require(a30_0x3593bf(0xff))),ListAllMessagesService_1=__importDefault(require(a30_0x3593bf(0xf7))),validator_1=require(a30_0x3593bf(0xd5)),logger_1=require(a30_0x3593bf(0x109)),Message_1=__importDefault(require(a30_0x3593bf(0xdd))),Contact_1=__importDefault(require('../models/Contact')),Ticket_1=__importDefault(require(a30_0x3593bf(0xdf))),ForwardMessageService_1=__importDefault(require(a30_0x3593bf(0x135))),wbot_1=require(a30_0x3593bf(0xf1)),VerifyHandlers_1=require(a30_0x3593bf(0xf9)),SendPresenceStatus_1=require('../helpers/SendPresenceStatus'),index=async(_0x32993a,_0x422f0d)=>{const _0x5ff769=a30_0x3593bf,{ticketId:_0x235394}=_0x32993a['params'],{pageNumber:_0x1ae828,markAsRead:_0x4b12dc}=_0x32993a[_0x5ff769(0x12f)],{companyId:_0x4483ee,profile:_0x238eaf}=_0x32993a[_0x5ff769(0x132)],_0x4b8441=[];if(_0x238eaf!==_0x5ff769(0xe1)){const _0x25c77c=await User_1[_0x5ff769(0x136)][_0x5ff769(0x122)](_0x32993a[_0x5ff769(0x132)]['id'],{'include':[{'model':Queue_1[_0x5ff769(0x136)],'as':_0x5ff769(0x10c)}]});_0x25c77c['queues'][_0x5ff769(0xdb)](_0xc1db7=>{const _0x2d730a=_0x5ff769;_0x4b8441[_0x2d730a(0x133)](_0xc1db7['id']);});}const {count:_0x3aa5c,messages:_0x558e27,ticket:_0x794264,hasMore:_0x99996e}=await(0x0,ListMessagesService_1[_0x5ff769(0x136)])({'pageNumber':_0x1ae828,'ticketId':_0x235394,'companyId':_0x4483ee,'queues':_0x4b8441});return _0x794264[_0x5ff769(0x13d)]===_0x5ff769(0xcc)&&_0x4b12dc===_0x5ff769(0x129)&&(0x0,SetTicketMessagesAsRead_1[_0x5ff769(0x136)])(_0x794264),_0x422f0d['json']({'count':_0x3aa5c,'messages':_0x558e27,'ticket':_0x794264,'hasMore':_0x99996e});};exports['index']=index;const store=async(_0x949fec,_0x4cded2)=>{const _0x34a339=a30_0x3593bf,{ticketId:_0x417229}=_0x949fec[_0x34a339(0x12a)],{body:_0x5ed5bc,quotedMsg:_0x4e2456}=_0x949fec['body'],_0x3793f0=_0x949fec['files'],{companyId:_0x2c7af9}=_0x949fec[_0x34a339(0x132)],_0x3d21ce=Number(_0x949fec[_0x34a339(0x132)]['id'])||null,_0x5a7912=await(0x0,ShowTicketService_1['default'])(_0x417229,_0x2c7af9),{channel:_0x260362}=_0x5a7912;_0x260362==='whatsapp'&&(0x0,SetTicketMessagesAsRead_1['default'])(_0x5a7912);if(_0x3793f0)_0x260362===_0x34a339(0xcc)&&await Promise[_0x34a339(0x10b)](_0x3793f0[_0x34a339(0x130)](async _0x45dfd5=>{const _0x53c3cf=_0x34a339;await(0x0,SendWhatsAppMedia_1['default'])({'media':_0x45dfd5,'ticket':_0x5a7912}),fs_1[_0x53c3cf(0x136)][_0x53c3cf(0xef)](_0x45dfd5['path']);}));else _0x260362==='whatsapp'&&await(0x0,SendWhatsAppMessage_1[_0x34a339(0x136)])({'body':_0x5ed5bc,'ticket':_0x5a7912,'userId':_0x3d21ce,'quotedMsg':_0x4e2456});return _0x4cded2[_0x34a339(0x10e)]();};exports[a30_0x3593bf(0x134)]=store;const getAll=async(_0x5d041f,_0x49d559)=>{const _0x58749a=a30_0x3593bf,_0x37c4cd=_0x5d041f[_0x58749a(0x12f)][_0x58749a(0x11f)],_0x36cd96=_0x5d041f[_0x58749a(0x12f)]['dateEnd'],_0x1041d3=(0x0,validator_1[_0x58749a(0x113)])(_0x5d041f[_0x58749a(0x12f)][_0x58749a(0x13e)]),{companyId:_0x464557}=_0x5d041f[_0x58749a(0x132)],{count:_0x26eb72}=await(0x0,ListAllMessagesService_1[_0x58749a(0x136)])({'companyId':_0x464557,'fromMe':_0x1041d3,'dateStart':_0x37c4cd,'dateEnd':_0x36cd96});return _0x49d559[_0x58749a(0x103)]({'count':_0x26eb72});};exports[a30_0x3593bf(0xfc)]=getAll;const react=async(_0x2e65c3,_0x478c2b)=>{const _0x23e636=a30_0x3593bf,{messageId:_0x2c04ea}=_0x2e65c3[_0x23e636(0x12a)],{companyId:_0x16dc17}=_0x2e65c3[_0x23e636(0x132)],_0xb3743d=Number(_0x2e65c3['user']['id'])||null,{ticketId:_0x1eaaf5,emoji:_0x449935}=_0x2e65c3['body'],_0x329f1d=await Message_1[_0x23e636(0x136)][_0x23e636(0x114)]({'where':{'id':_0x2c04ea,'ticketId':_0x1eaaf5}});if(!_0x329f1d)throw new AppError_1[(_0x23e636(0x136))](_0x23e636(0x11d),0x194);const _0x57b07a=await(0x0,ShowTicketService_1[_0x23e636(0x136)])(_0x1eaaf5,_0x16dc17),_0x2b1555=await(0x0,wbot_1[_0x23e636(0xfa)])(_0x57b07a[_0x23e636(0x100)]);if(!_0x2b1555)throw new AppError_1[(_0x23e636(0x136))](_0x23e636(0x111),0x1f4);const _0x238e76=JSON[_0x23e636(0xe2)](_0x329f1d[_0x23e636(0xd8)]),_0x509788=await _0x2b1555[_0x23e636(0xce)](_0x57b07a[_0x23e636(0x11a)]['remoteJid']||_0x57b07a[_0x23e636(0x11a)]['number']+(_0x57b07a[_0x23e636(0x127)]?_0x23e636(0xc9):_0x57b07a[_0x23e636(0x11a)]['number']['length']>0xd?_0x23e636(0x11e):_0x23e636(0xfd)),{'react':{'text':_0x449935,'key':_0x238e76[_0x23e636(0x110)]}});if(!_0x509788)throw new AppError_1[(_0x23e636(0x136))](_0x23e636(0xd6),0x1f4);return await(0x0,VerifyHandlers_1[_0x23e636(0xe0)])(_0x509788,_0x57b07a,_0x57b07a['contact']),_0x478c2b[_0x23e636(0x10e)]();};exports[a30_0x3593bf(0xdc)]=react;const edit=async(_0x37c499,_0x3f642e)=>{const _0x3577a2=a30_0x3593bf,{messageId:_0x374b17}=_0x37c499[_0x3577a2(0x12a)],{companyId:_0x6ef115}=_0x37c499[_0x3577a2(0x132)],_0x29ba50=Number(_0x37c499[_0x3577a2(0x132)]['id'])||null,{body:_0x784262}=_0x37c499['body'],{ticketId:_0x377c4a,message:_0x11f49e}=await(0x0,EditWhatsAppMessage_1['default'])({'messageId':_0x374b17,'companyId':_0x6ef115,'userId':_0x29ba50,'body':_0x784262}),_0x14ddab=(0x0,socket_1['getIO'])();return _0x14ddab['to'](_0x377c4a[_0x3577a2(0xe3)]())[_0x3577a2(0x10d)]('company-'+_0x6ef115+'-appMessage',{'action':_0x3577a2(0x131),'message':_0x11f49e}),_0x3f642e[_0x3577a2(0x10e)]();};exports[a30_0x3593bf(0x10a)]=edit;const remove=async(_0x4d67b5,_0x5eb042)=>{const _0x5d4657=a30_0x3593bf,{messageId:_0x401b00}=_0x4d67b5['params'],{companyId:_0x13b653}=_0x4d67b5['user'],_0x3d34fb=await(0x0,DeleteWhatsAppMessage_1[_0x5d4657(0x136)])(_0x401b00),_0x2ba1be=(0x0,socket_1[_0x5d4657(0x106)])();return _0x2ba1be['to'](_0x3d34fb[_0x5d4657(0x118)][_0x5d4657(0xe3)]())[_0x5d4657(0x10d)]('company-'+_0x13b653+_0x5d4657(0x139),{'action':_0x5d4657(0x131),'message':_0x3d34fb}),_0x5eb042[_0x5d4657(0x10e)]();};exports[a30_0x3593bf(0x125)]=remove;const typing=async(_0x14487c,_0x28db45)=>{const _0x335349=a30_0x3593bf,{ticketId:_0xb1514e}=_0x14487c[_0x335349(0x12a)],{companyId:_0x458359}=_0x14487c['user'],{status:_0x20879f}=_0x14487c[_0x335349(0x12f)];if(!_0xb1514e)return _0x28db45[_0x335349(0xf0)](0x190)[_0x335349(0x10e)](_0x335349(0x121));const _0x205907=await(0x0,ShowTicketService_1[_0x335349(0x136)])(_0xb1514e,_0x458359);if(!_0x205907)return _0x28db45[_0x335349(0xf0)](0x194)[_0x335349(0x10e)](_0x335349(0x115));let _0x37b649=(0x0,wbot_1[_0x335349(0xfa)])(_0x205907[_0x335349(0x100)]);return _0x20879f==_0x335349(0x129)?await(0x0,SendPresenceStatus_1['SendTypingStatus'])(_0x37b649,_0x205907['contact'][_0x335349(0x119)]||_0x205907['contact'][_0x335349(0xd3)]+'@'+(_0x205907[_0x335349(0x127)]?_0x335349(0xd2):_0x205907['contact'][_0x335349(0xd3)][_0x335349(0x105)]>0xd?_0x335349(0xe7):'s.whatsapp.net')):await(0x0,SendPresenceStatus_1[_0x335349(0xf8)])(_0x37b649,_0x205907[_0x335349(0x11a)][_0x335349(0x119)]||_0x205907[_0x335349(0x11a)][_0x335349(0xd3)]+'@'+(_0x205907['isGroup']?_0x335349(0xd2):_0x205907[_0x335349(0x11a)][_0x335349(0xd3)][_0x335349(0x105)]>0xd?_0x335349(0xe7):'s.whatsapp.net')),_0x28db45[_0x335349(0xf0)](0xc8)['send'](_0x335349(0x13c)+_0x20879f+_0x335349(0x12e));};exports[a30_0x3593bf(0xcd)]=typing;const forward=async(_0x501167,_0x26d418)=>{const _0x3d903d=a30_0x3593bf,{contactId:_0x1f0c80,ticketId:_0x3b10d2,messageId:_0xebd3fb,queueId:_0x264851}=_0x501167[_0x3d903d(0xfe)],{companyId:_0x5e8e06}=_0x501167['user'],_0x1096fb=await User_1[_0x3d903d(0x136)][_0x3d903d(0x122)](_0x501167['user']['id'],{'include':[{'model':Queue_1['default'],'as':_0x3d903d(0x10c)}]});if(_0x264851&&_0x1096fb[_0x3d903d(0xeb)]!=='admin'&&!_0x1096fb[_0x3d903d(0x10c)][_0x3d903d(0x13b)](_0x5df89d=>_0x5df89d['id']===_0x264851))throw new AppError_1[(_0x3d903d(0x136))](_0x3d903d(0xde),0x193);const _0x154883=await Message_1['default'][_0x3d903d(0x114)]({'where':{'id':_0xebd3fb,'ticketId':_0x3b10d2},'include':[{'model':Ticket_1[_0x3d903d(0x136)],'as':_0x3d903d(0xea),'include':[{'model':Whatsapp_1['default'],'as':_0x3d903d(0xcc)}]},{'model':Contact_1[_0x3d903d(0x136)],'as':'contact'}]});if(!_0x154883)throw new AppError_1[(_0x3d903d(0x136))](_0x3d903d(0x11d),0x194);const _0x315369=await Contact_1['default'][_0x3d903d(0x122)](_0x1f0c80);if(!_0x315369)throw new AppError_1[(_0x3d903d(0x136))](_0x3d903d(0x13a),0x194);let _0x241894=null;if(_0x264851){_0x241894=await Queue_1[_0x3d903d(0x136)][_0x3d903d(0x122)](_0x264851);if(!_0x241894)throw new AppError_1[(_0x3d903d(0x136))](_0x3d903d(0xe4),0x194);if(_0x241894[_0x3d903d(0xe8)]!==_0x5e8e06)throw new AppError_1[(_0x3d903d(0x136))]('ERR_ACCESS_DENIED',0x193);}if(_0x154883[_0x3d903d(0xe8)]!==_0x5e8e06||_0x315369[_0x3d903d(0xe8)]!==_0x5e8e06)throw new AppError_1[(_0x3d903d(0x136))](_0x3d903d(0xec),0x193);return await(0x0,ForwardMessageService_1['default'])(_0x1096fb,_0x154883,_0x315369,_0x241894),_0x26d418[_0x3d903d(0x10e)]();};function a30_0xb7f9(){const _0x44eff1=['forEach','react','../models/Message','ERR_FORBIDDEN','../models/Ticket','verifyMessage','admin','parse','toString','ERR_QUEUE_NOT_FOUND','../models/Whatsapp','../services/WbotServices/SendWhatsAppMessage','lid','companyId','search','ticket','profile','ERR_ACCESS_DENIED','6gprcRO','../models/Queue','unlinkSync','status','../libs/wbot','../libs/socket','../services/MessageServices/ListMessagesService','1267028qfbfne','app','messageQueue','../services/MessageServices/ListAllMessagesService','SendPausedStatus','../services/WbotServices/VerifyHandlers','getWbot','includes','getAll','@s.whatsapp.net','body','../services/WbotServices/EditWhatsAppMessage','whatsappId','2nKjCmW','5254728PdiZfs','json','../services/WbotServices/DeleteWhatsAppMessage','length','getIO','../services/WbotServices/CheckNumber','MessageController.send:\x20','../utils/logger','edit','all','queues','emit','send','21542LhpoAj','key','ERR_WHATSAPP_NOT_FOUND','6KOYdQa','toBoolean','findOne','Ticket\x20not\x20found','message','SendMessage','ticketId','remoteJid','contact','stringify','616304pBxMVF','ERR_MESSAGE_NOT_FOUND','@lid','dateStart','apply','TicketId\x20is\x20required','findByPk','46624xLqMgL','MessageController.send:\x20Failed\x20to\x20put\x20message\x20on\x20queue','remove','../models/User','isGroup','ERR_SYNTAX','true','params','get','26ssDcjb','(((.+)+)+)+$','\x20enviado\x20com\x20sucesso','query','map','update','user','push','store','../services/MessageServices/ForwardMessageService','default','2702810eViyMO','forward','-appMessage','ERR_CONTACT_NOT_FOUND','find','Status\x20','channel','fromMe','error','@g.us','791593qCzwCk','__esModule','whatsapp','typing','sendMessage','defineProperty','36GFEXmh','path','g.us','number','../services/TicketServices/ShowTicketService','validator','ERR_WHATSAPP_MESSAGE_NOT_SENT','10UhTzJB','dataJson','constructor','add'];a30_0xb7f9=function(){return _0x44eff1;};return a30_0xb7f9();}exports[a30_0x3593bf(0x138)]=forward;const send=async(_0x1dfb25,_0x2fb36c)=>{const _0x41305d=a30_0x3593bf,{whatsappId:_0x2821d9}=_0x1dfb25['params'],_0x212930=_0x1dfb25[_0x41305d(0xfe)],_0x43d323=_0x1dfb25['files'];if(_0x212930[_0x41305d(0xd3)]===undefined)throw new AppError_1[(_0x41305d(0x136))](_0x41305d(0x128),0x190);const _0x1e4755=await Whatsapp_1[_0x41305d(0x136)]['findByPk'](_0x2821d9);if(!_0x1e4755)throw new AppError_1[(_0x41305d(0x136))](_0x41305d(0x111),0x194);try{let {number:_0x53b98e}=_0x212930;const {body:_0x36702b,linkPreview:_0x2f68b1}=_0x212930,_0x2c24f0=!!_0x212930['saveOnTicket'];if(!_0x53b98e[_0x41305d(0xfb)]('@')){const _0x541f53=_0x212930[_0x41305d(0xd3)],{companyId:_0x1d7dc8}=_0x1e4755,_0x5cefdb=await(0x0,CheckNumber_1[_0x41305d(0x136)])(_0x541f53,_0x1d7dc8,_0x1e4755);_0x53b98e=_0x5cefdb['jid']['replace'](/\D/g,'');}return _0x43d323?await Promise['all'](_0x43d323[_0x41305d(0x130)](async _0x26513e=>{const _0x30325a=_0x41305d;await _0x1dfb25['app'][_0x30325a(0x12b)]('queues')[_0x30325a(0xf6)][_0x30325a(0xda)](_0x30325a(0x117),{'whatsappId':_0x2821d9,'data':{'number':_0x53b98e,'body':_0x26513e['originalname'],'mediaPath':_0x26513e[_0x30325a(0xd1)],'saveOnTicket':_0x2c24f0}},{'removeOnComplete':!![],'attempts':0x3});})):_0x1dfb25[_0x41305d(0xf5)]['get'](_0x41305d(0x10c))[_0x41305d(0xf6)][_0x41305d(0xda)](_0x41305d(0x117),{'whatsappId':_0x2821d9,'data':{'number':_0x53b98e,'body':_0x36702b,'linkPreview':_0x2f68b1,'saveOnTicket':_0x2c24f0}},{'removeOnComplete':![],'attempts':0x3}),_0x2fb36c['send']({'mensagem':'Message\x20added\x20to\x20queue'});}catch(_0x48f7d9){const _0x46a6e0={'errType':typeof _0x48f7d9,'serialized':JSON[_0x41305d(0x11b)](_0x48f7d9),'err':_0x48f7d9};_0x48f7d9?.[_0x41305d(0x116)]?console[_0x41305d(0x13f)](_0x46a6e0,_0x41305d(0x108)+_0x48f7d9['message']):logger_1['logger']['error'](_0x46a6e0,_0x41305d(0x124));throw new AppError_1[(_0x41305d(0x136))]('ERR_INTERNAL_ERROR',0x1f4);}};exports[a30_0x3593bf(0x10e)]=send;