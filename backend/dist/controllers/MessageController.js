const a24_0x58b027=a24_0x1caf;(function(_0x3548d6,_0x4dfe5b){const _0x2f622f=a24_0x1caf,_0x5228d7=_0x3548d6();while(!![]){try{const _0x8210c1=-parseInt(_0x2f622f(0xb0))/0x1+-parseInt(_0x2f622f(0x90))/0x2*(-parseInt(_0x2f622f(0x89))/0x3)+-parseInt(_0x2f622f(0xe1))/0x4*(parseInt(_0x2f622f(0xb8))/0x5)+parseInt(_0x2f622f(0x9a))/0x6*(-parseInt(_0x2f622f(0xd3))/0x7)+parseInt(_0x2f622f(0x9c))/0x8*(-parseInt(_0x2f622f(0xc2))/0x9)+parseInt(_0x2f622f(0x91))/0xa*(parseInt(_0x2f622f(0xbb))/0xb)+parseInt(_0x2f622f(0xb7))/0xc;if(_0x8210c1===_0x4dfe5b)break;else _0x5228d7['push'](_0x5228d7['shift']());}catch(_0x427722){_0x5228d7['push'](_0x5228d7['shift']());}}}(a24_0x145a,0x73864));const a24_0x5ea65f=(function(){let _0x34d47d=!![];return function(_0x3b9626,_0x232b76){const _0x4cd6ca=_0x34d47d?function(){if(_0x232b76){const _0x145587=_0x232b76['apply'](_0x3b9626,arguments);return _0x232b76=null,_0x145587;}}:function(){};return _0x34d47d=![],_0x4cd6ca;};}()),a24_0x5631d4=a24_0x5ea65f(this,function(){const _0x5a88c4=a24_0x1caf;return a24_0x5631d4[_0x5a88c4(0xe6)]()[_0x5a88c4(0xc0)](_0x5a88c4(0xe5))[_0x5a88c4(0xe6)]()[_0x5a88c4(0xcd)](a24_0x5631d4)[_0x5a88c4(0xc0)](_0x5a88c4(0xe5));});a24_0x5631d4();'use strict';var __importDefault=this&&this[a24_0x58b027(0xb3)]||function(_0x164ab9){const _0x1f841c=a24_0x58b027;return _0x164ab9&&_0x164ab9[_0x1f841c(0xd6)]?_0x164ab9:{'default':_0x164ab9};};Object[a24_0x58b027(0xb9)](exports,a24_0x58b027(0xd6),{'value':!![]}),exports[a24_0x58b027(0xb4)]=exports[a24_0x58b027(0xe4)]=exports['typing']=exports[a24_0x58b027(0xce)]=exports['edit']=exports[a24_0x58b027(0xcc)]=exports[a24_0x58b027(0xd2)]=exports['store']=exports[a24_0x58b027(0xcf)]=void 0x0;const fs_1=__importDefault(require('fs')),AppError_1=__importDefault(require(a24_0x58b027(0xb5))),SetTicketMessagesAsRead_1=__importDefault(require(a24_0x58b027(0x86))),socket_1=require(a24_0x58b027(0xbf)),Queue_1=__importDefault(require(a24_0x58b027(0xec))),User_1=__importDefault(require('../models/User')),Whatsapp_1=__importDefault(require('../models/Whatsapp')),ListMessagesService_1=__importDefault(require(a24_0x58b027(0xd1))),ShowTicketService_1=__importDefault(require('../services/TicketServices/ShowTicketService')),DeleteWhatsAppMessage_1=__importDefault(require('../services/WbotServices/DeleteWhatsAppMessage')),SendWhatsAppMedia_1=__importDefault(require(a24_0x58b027(0xbe))),SendWhatsAppMessage_1=__importDefault(require(a24_0x58b027(0xc6))),CheckNumber_1=__importDefault(require('../services/WbotServices/CheckNumber')),EditWhatsAppMessage_1=__importDefault(require('../services/WbotServices/EditWhatsAppMessage')),ListAllMessagesService_1=__importDefault(require(a24_0x58b027(0xdf))),validator_1=require('validator'),logger_1=require(a24_0x58b027(0xab)),Message_1=__importDefault(require(a24_0x58b027(0xda))),Contact_1=__importDefault(require(a24_0x58b027(0x95))),Ticket_1=__importDefault(require(a24_0x58b027(0xe3))),ForwardMessageService_1=__importDefault(require('../services/MessageServices/ForwardMessageService')),wbot_1=require(a24_0x58b027(0x81)),VerifyHandlers_1=require('../services/WbotServices/VerifyHandlers'),SendPresenceStatus_1=require(a24_0x58b027(0xed)),index=async(_0x43e56b,_0x24238d)=>{const _0x24a740=a24_0x58b027,{ticketId:_0x52620e}=_0x43e56b[_0x24a740(0xa8)],{pageNumber:_0x137052,markAsRead:_0x59aa40}=_0x43e56b[_0x24a740(0x9d)],{companyId:_0xe4eb7f,profile:_0x2c0d6f}=_0x43e56b[_0x24a740(0xe7)],_0x43f579=[];if(_0x2c0d6f!==_0x24a740(0xbc)){const _0x12e63e=await User_1[_0x24a740(0xd7)][_0x24a740(0xc3)](_0x43e56b[_0x24a740(0xe7)]['id'],{'include':[{'model':Queue_1[_0x24a740(0xd7)],'as':_0x24a740(0xa0)}]});_0x12e63e[_0x24a740(0xa0)][_0x24a740(0x9b)](_0x1696f9=>{const _0x5bd13a=_0x24a740;_0x43f579[_0x5bd13a(0xc8)](_0x1696f9['id']);});}const {count:_0x15b5bd,messages:_0x4ec10e,ticket:_0x456e70,hasMore:_0x2bf80b}=await(0x0,ListMessagesService_1[_0x24a740(0xd7)])({'pageNumber':_0x137052,'ticketId':_0x52620e,'companyId':_0xe4eb7f,'queues':_0x43f579});return _0x456e70['channel']===_0x24a740(0x8d)&&_0x59aa40==='true'&&(0x0,SetTicketMessagesAsRead_1['default'])(_0x456e70),_0x24238d[_0x24a740(0x9f)]({'count':_0x15b5bd,'messages':_0x4ec10e,'ticket':_0x456e70,'hasMore':_0x2bf80b});};exports['index']=index;function a24_0x1caf(_0x2a34bc,_0x4d3f25){const _0x25a3cb=a24_0x145a();return a24_0x1caf=function(_0x5631d4,_0x5ea65f){_0x5631d4=_0x5631d4-0x80;let _0x145ad2=_0x25a3cb[_0x5631d4];return _0x145ad2;},a24_0x1caf(_0x2a34bc,_0x4d3f25);}const store=async(_0xcbc0f9,_0x9aef7e)=>{const _0x5e17fa=a24_0x58b027,{ticketId:_0x3d04b3}=_0xcbc0f9[_0x5e17fa(0xa8)],{body:_0x3d4545,quotedMsg:_0x4215b9}=_0xcbc0f9[_0x5e17fa(0xa2)],_0x2b635d=_0xcbc0f9['files'],{companyId:_0x1fd93d}=_0xcbc0f9[_0x5e17fa(0xe7)],_0x4a6caf=Number(_0xcbc0f9['user']['id'])||null,_0x2438b8=await(0x0,ShowTicketService_1[_0x5e17fa(0xd7)])(_0x3d04b3,_0x1fd93d),{channel:_0x38a02e}=_0x2438b8;_0x38a02e===_0x5e17fa(0x8d)&&(0x0,SetTicketMessagesAsRead_1[_0x5e17fa(0xd7)])(_0x2438b8);if(_0x2b635d)_0x38a02e===_0x5e17fa(0x8d)&&await Promise[_0x5e17fa(0x87)](_0x2b635d[_0x5e17fa(0xde)](async _0x143f90=>{const _0x504e8b=_0x5e17fa;await(0x0,SendWhatsAppMedia_1['default'])({'media':_0x143f90,'ticket':_0x2438b8}),fs_1[_0x504e8b(0xd7)][_0x504e8b(0xea)](_0x143f90['path']);}));else _0x38a02e===_0x5e17fa(0x8d)&&await(0x0,SendWhatsAppMessage_1[_0x5e17fa(0xd7)])({'body':_0x3d4545,'ticket':_0x2438b8,'userId':_0x4a6caf,'quotedMsg':_0x4215b9});return _0x9aef7e[_0x5e17fa(0xb4)]();};exports[a24_0x58b027(0xd5)]=store;const getAll=async(_0x17e314,_0x1a8aa9)=>{const _0x4ba402=a24_0x58b027,_0xf52ef7=_0x17e314[_0x4ba402(0x9d)][_0x4ba402(0xad)],_0x4a4123=_0x17e314[_0x4ba402(0x9d)][_0x4ba402(0xcb)],_0x10283e=(0x0,validator_1[_0x4ba402(0xa5)])(_0x17e314[_0x4ba402(0x9d)][_0x4ba402(0xaf)]),{companyId:_0x4f244b}=_0x17e314[_0x4ba402(0xe7)],{count:_0x5b8609}=await(0x0,ListAllMessagesService_1['default'])({'companyId':_0x4f244b,'fromMe':_0x10283e,'dateStart':_0xf52ef7,'dateEnd':_0x4a4123});return _0x1a8aa9[_0x4ba402(0x9f)]({'count':_0x5b8609});};function a24_0x145a(){const _0x327301=['send','../errors/AppError','TicketId\x20is\x20required','30414420ntTRlj','15rvPjyC','defineProperty','get','5253545aKYkNC','admin','lid','../services/WbotServices/SendWhatsAppMedia','../libs/socket','search','Message\x20added\x20to\x20queue','2632347ekInJG','findByPk','length','messageQueue','../services/WbotServices/SendWhatsAppMessage','isGroup','push','s.whatsapp.net','ERR_FORBIDDEN','dateEnd','react','constructor','remove','index','@lid','../services/MessageServices/ListMessagesService','getAll','12887EyoWIo','ERR_WHATSAPP_MESSAGE_NOT_SENT','store','__esModule','default','ticket','companyId','../models/Message','stringify','@g.us','findOne','map','../services/MessageServices/ListAllMessagesService','typing','675368IKzphw','remoteJid','../models/Ticket','forward','(((.+)+)+)+$','toString','user','originalname','@s.whatsapp.net','unlinkSync','ERR_ACCESS_DENIED','../models/Queue','../helpers/SendPresenceStatus','ticketId','app','path','ERR_WHATSAPP_NOT_FOUND','../libs/wbot','SendPausedStatus','emit','contact','includes','../helpers/SetTicketMessagesAsRead','all','files','12VNksjc','true','replace','SendMessage','whatsapp','key','-appMessage','139342utCrwm','10ieVAdC','logger','getWbot','SendTypingStatus','../models/Contact','MessageController.send:\x20Failed\x20to\x20put\x20message\x20on\x20queue','add','message','number','2598JnHFJZ','forEach','16gUCZBq','query','jid','json','queues','getIO','body','error','ERR_SYNTAX','toBoolean','ERR_QUEUE_NOT_FOUND','company-','params','parse','saveOnTicket','../utils/logger','ERR_MESSAGE_NOT_FOUND','dateStart','status','fromMe','928981sHzuQo','verifyMessage','ERR_CONTACT_NOT_FOUND','__importDefault'];a24_0x145a=function(){return _0x327301;};return a24_0x145a();}exports[a24_0x58b027(0xd2)]=getAll;const react=async(_0x4d252c,_0x5b3888)=>{const _0x4d0c1e=a24_0x58b027,{messageId:_0x3d7562}=_0x4d252c[_0x4d0c1e(0xa8)],{companyId:_0x527e1e}=_0x4d252c[_0x4d0c1e(0xe7)],_0x1e3912=Number(_0x4d252c[_0x4d0c1e(0xe7)]['id'])||null,{ticketId:_0xb3a18d,emoji:_0x5b4b97}=_0x4d252c[_0x4d0c1e(0xa2)],_0x2c37cc=await Message_1[_0x4d0c1e(0xd7)][_0x4d0c1e(0xdd)]({'where':{'id':_0x3d7562,'ticketId':_0xb3a18d}});if(!_0x2c37cc)throw new AppError_1['default'](_0x4d0c1e(0xac),0x194);const _0x333795=await(0x0,ShowTicketService_1[_0x4d0c1e(0xd7)])(_0xb3a18d,_0x527e1e),_0x10e27d=await(0x0,wbot_1[_0x4d0c1e(0x93)])(_0x333795['whatsappId']);if(!_0x10e27d)throw new AppError_1[(_0x4d0c1e(0xd7))](_0x4d0c1e(0x80),0x1f4);const _0x5ca6d4=JSON[_0x4d0c1e(0xa9)](_0x2c37cc['dataJson']),_0x4a7a77=await _0x10e27d['sendMessage'](_0x333795[_0x4d0c1e(0x84)]['remoteJid']||_0x333795[_0x4d0c1e(0x84)][_0x4d0c1e(0x99)]+(_0x333795['isGroup']?_0x4d0c1e(0xdc):_0x333795[_0x4d0c1e(0x84)][_0x4d0c1e(0x99)][_0x4d0c1e(0xc4)]>0xd?_0x4d0c1e(0xd0):_0x4d0c1e(0xe9)),{'react':{'text':_0x5b4b97,'key':_0x5ca6d4[_0x4d0c1e(0x8e)]}});if(!_0x4a7a77)throw new AppError_1[(_0x4d0c1e(0xd7))](_0x4d0c1e(0xd4),0x1f4);return await(0x0,VerifyHandlers_1[_0x4d0c1e(0xb1)])(_0x4a7a77,_0x333795,_0x333795[_0x4d0c1e(0x84)]),_0x5b3888[_0x4d0c1e(0xb4)]();};exports[a24_0x58b027(0xcc)]=react;const edit=async(_0x141989,_0x4fb249)=>{const _0x33edfc=a24_0x58b027,{messageId:_0x2b9094}=_0x141989[_0x33edfc(0xa8)],{companyId:_0x3dbf3c}=_0x141989['user'],_0x200f16=Number(_0x141989['user']['id'])||null,{body:_0x691afd}=_0x141989[_0x33edfc(0xa2)],{ticketId:_0x4c340f,message:_0x32baa8}=await(0x0,EditWhatsAppMessage_1['default'])({'messageId':_0x2b9094,'companyId':_0x3dbf3c,'userId':_0x200f16,'body':_0x691afd}),_0x527174=(0x0,socket_1[_0x33edfc(0xa1)])();return _0x527174['to'](_0x4c340f[_0x33edfc(0xe6)]())[_0x33edfc(0x83)](_0x33edfc(0xa7)+_0x3dbf3c+_0x33edfc(0x8f),{'action':'update','message':_0x32baa8}),_0x4fb249['send']();};exports['edit']=edit;const remove=async(_0x2bb8bb,_0x43a30f)=>{const _0x3aeb2c=a24_0x58b027,{messageId:_0x32a4f1}=_0x2bb8bb['params'],{companyId:_0x75915d}=_0x2bb8bb[_0x3aeb2c(0xe7)],_0x4c24cc=await(0x0,DeleteWhatsAppMessage_1[_0x3aeb2c(0xd7)])(_0x32a4f1),_0x56b098=(0x0,socket_1[_0x3aeb2c(0xa1)])();return _0x56b098['to'](_0x4c24cc[_0x3aeb2c(0xee)][_0x3aeb2c(0xe6)]())[_0x3aeb2c(0x83)](_0x3aeb2c(0xa7)+_0x75915d+_0x3aeb2c(0x8f),{'action':'update','message':_0x4c24cc}),_0x43a30f[_0x3aeb2c(0xb4)]();};exports[a24_0x58b027(0xce)]=remove;const typing=async(_0x25b686,_0x300cfd)=>{const _0xf7a513=a24_0x58b027,{ticketId:_0x4811f4}=_0x25b686['params'],{companyId:_0x3def58}=_0x25b686[_0xf7a513(0xe7)],{status:_0x36af7e}=_0x25b686['query'];if(!_0x4811f4)return _0x300cfd[_0xf7a513(0xae)](0x190)[_0xf7a513(0xb4)](_0xf7a513(0xb6));const _0xd05268=await(0x0,ShowTicketService_1[_0xf7a513(0xd7)])(_0x4811f4,_0x3def58);if(!_0xd05268)return _0x300cfd['status'](0x194)[_0xf7a513(0xb4)]('Ticket\x20not\x20found');let _0x2e5f9d=(0x0,wbot_1[_0xf7a513(0x93)])(_0xd05268['whatsappId']);return _0x36af7e==_0xf7a513(0x8a)?await(0x0,SendPresenceStatus_1[_0xf7a513(0x94)])(_0x2e5f9d,_0xd05268['contact'][_0xf7a513(0xe2)]||_0xd05268[_0xf7a513(0x84)]['number']+'@'+(_0xd05268[_0xf7a513(0xc7)]?'g.us':_0xd05268['contact'][_0xf7a513(0x99)]['length']>0xd?_0xf7a513(0xbd):'s.whatsapp.net')):await(0x0,SendPresenceStatus_1[_0xf7a513(0x82)])(_0x2e5f9d,_0xd05268[_0xf7a513(0x84)][_0xf7a513(0xe2)]||_0xd05268[_0xf7a513(0x84)][_0xf7a513(0x99)]+'@'+(_0xd05268[_0xf7a513(0xc7)]?'g.us':_0xd05268[_0xf7a513(0x84)][_0xf7a513(0x99)][_0xf7a513(0xc4)]>0xd?'lid':_0xf7a513(0xc9))),_0x300cfd[_0xf7a513(0xae)](0xc8)[_0xf7a513(0xb4)]('Status\x20'+_0x36af7e+'\x20enviado\x20com\x20sucesso');};exports[a24_0x58b027(0xe0)]=typing;const forward=async(_0xc07e10,_0x5d141b)=>{const _0x100ce4=a24_0x58b027,{contactId:_0x1f014e,ticketId:_0x430162,messageId:_0x517469,queueId:_0x501716}=_0xc07e10['body'],{companyId:_0x30b664}=_0xc07e10[_0x100ce4(0xe7)],_0x56a1c2=await User_1[_0x100ce4(0xd7)][_0x100ce4(0xc3)](_0xc07e10[_0x100ce4(0xe7)]['id'],{'include':[{'model':Queue_1[_0x100ce4(0xd7)],'as':_0x100ce4(0xa0)}]});if(_0x501716&&_0x56a1c2['profile']!==_0x100ce4(0xbc)&&!_0x56a1c2[_0x100ce4(0xa0)]['find'](_0x48c1f1=>_0x48c1f1['id']===_0x501716))throw new AppError_1['default'](_0x100ce4(0xca),0x193);const _0x15702a=await Message_1[_0x100ce4(0xd7)]['findOne']({'where':{'id':_0x517469,'ticketId':_0x430162},'include':[{'model':Ticket_1[_0x100ce4(0xd7)],'as':_0x100ce4(0xd8),'include':[{'model':Whatsapp_1[_0x100ce4(0xd7)],'as':_0x100ce4(0x8d)}]},{'model':Contact_1[_0x100ce4(0xd7)],'as':_0x100ce4(0x84)}]});if(!_0x15702a)throw new AppError_1[(_0x100ce4(0xd7))](_0x100ce4(0xac),0x194);const _0xeebb2=await Contact_1[_0x100ce4(0xd7)][_0x100ce4(0xc3)](_0x1f014e);if(!_0xeebb2)throw new AppError_1['default'](_0x100ce4(0xb2),0x194);let _0x51ee7b=null;if(_0x501716){_0x51ee7b=await Queue_1[_0x100ce4(0xd7)][_0x100ce4(0xc3)](_0x501716);if(!_0x51ee7b)throw new AppError_1[(_0x100ce4(0xd7))](_0x100ce4(0xa6),0x194);if(_0x51ee7b[_0x100ce4(0xd9)]!==_0x30b664)throw new AppError_1[(_0x100ce4(0xd7))]('ERR_ACCESS_DENIED',0x193);}if(_0x15702a['companyId']!==_0x30b664||_0xeebb2['companyId']!==_0x30b664)throw new AppError_1[(_0x100ce4(0xd7))](_0x100ce4(0xeb),0x193);return await(0x0,ForwardMessageService_1[_0x100ce4(0xd7)])(_0x56a1c2,_0x15702a,_0xeebb2,_0x51ee7b),_0x5d141b['send']();};exports['forward']=forward;const send=async(_0x6cccfb,_0x19e71b)=>{const _0x520196=a24_0x58b027,{whatsappId:_0x538f05}=_0x6cccfb[_0x520196(0xa8)],_0x547808=_0x6cccfb['body'],_0x3b0d7c=_0x6cccfb[_0x520196(0x88)];if(_0x547808[_0x520196(0x99)]===undefined)throw new AppError_1[(_0x520196(0xd7))](_0x520196(0xa4),0x190);const _0x3185ce=await Whatsapp_1[_0x520196(0xd7)][_0x520196(0xc3)](_0x538f05);if(!_0x3185ce)throw new AppError_1[(_0x520196(0xd7))]('ERR_WHATSAPP_NOT_FOUND',0x194);try{let {number:_0x5191a4}=_0x547808;const {body:_0x1f8baa,linkPreview:_0x47e50b}=_0x547808,_0xf01057=!!_0x547808[_0x520196(0xaa)];if(!_0x5191a4[_0x520196(0x85)]('@')){const _0x41803a=_0x547808[_0x520196(0x99)],{companyId:_0x1263f8}=_0x3185ce,_0x3f9e31=await(0x0,CheckNumber_1[_0x520196(0xd7)])(_0x41803a,_0x1263f8,_0x3185ce);_0x5191a4=_0x3f9e31[_0x520196(0x9e)][_0x520196(0x8b)](/\D/g,'');}return _0x3b0d7c?await Promise['all'](_0x3b0d7c['map'](async _0x1a2316=>{const _0x1d9c86=_0x520196;await _0x6cccfb[_0x1d9c86(0xef)][_0x1d9c86(0xba)](_0x1d9c86(0xa0))[_0x1d9c86(0xc5)][_0x1d9c86(0x97)](_0x1d9c86(0x8c),{'whatsappId':_0x538f05,'data':{'number':_0x5191a4,'body':_0x1a2316[_0x1d9c86(0xe8)],'mediaPath':_0x1a2316[_0x1d9c86(0xf0)],'saveOnTicket':_0xf01057}},{'removeOnComplete':!![],'attempts':0x3});})):_0x6cccfb['app'][_0x520196(0xba)]('queues')['messageQueue'][_0x520196(0x97)]('SendMessage',{'whatsappId':_0x538f05,'data':{'number':_0x5191a4,'body':_0x1f8baa,'linkPreview':_0x47e50b,'saveOnTicket':_0xf01057}},{'removeOnComplete':![],'attempts':0x3}),_0x19e71b[_0x520196(0xb4)]({'mensagem':_0x520196(0xc1)});}catch(_0x1c7974){const _0x4a9c70={'errType':typeof _0x1c7974,'serialized':JSON[_0x520196(0xdb)](_0x1c7974),'err':_0x1c7974};_0x1c7974?.['message']?console[_0x520196(0xa3)](_0x4a9c70,'MessageController.send:\x20'+_0x1c7974[_0x520196(0x98)]):logger_1[_0x520196(0x92)][_0x520196(0xa3)](_0x4a9c70,_0x520196(0x96));throw new AppError_1['default']('ERR_INTERNAL_ERROR',0x1f4);}};exports[a24_0x58b027(0xb4)]=send;