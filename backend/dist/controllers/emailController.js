const a18_0x154a17=a18_0x4fc4;function a18_0x34b1(){const _0x10f239=['Erro\x20ao\x20enviar\x20e-mail:','subject','findAll','sequelize','defineProperty','default','hour','status','createLogger','824906ldCTyA','2189595kPDdNp','printf','488616qhfQvA','listarEmailsEnviados','../models/Email','message','Erro\x20ao\x20agendar\x20o\x20envio\x20de\x20e-mail:','info','__esModule','schedule','toDate','toString','SendMail','../services/EmailService/EmailService','update','combine','Console','E-mail\x20enviado\x20com\x20sucesso','error','sender','toISOString','161MtmBFJ','1hZEttr','timestamp','user','lte','transports','listarEmailsAgendados','json',',\x20erro:\x20','(((.+)+)+)+$','enviarEmail','body','Erro\x20ao\x20listar\x20e-mails\x20enviados:','agendarEnvioEmail','*/30\x20*\x20*\x20*\x20*\x20*','Erro\x20ao\x20agendar\x20o\x20envio\x20de\x20e-mail','search','A\x20data\x20de\x20envio\x20deve\x20ser\x20no\x20futuro','6450650ymRVsm','36agtuJb','companyId','120018nGxNWy','create','Erro\x20ao\x20listar\x20e-mails\x20agendados:','node-cron','constructor','E-mail\x20agendado\x20com\x20sucesso','Erro\x20ao\x20listar\x20e-mails\x20enviados','E-mail\x20agendado\x20enviado\x20com\x20sucesso\x20para:\x20','40461SlbJka','email','2344851FcWemr','winston','format'];a18_0x34b1=function(){return _0x10f239;};return a18_0x34b1();}(function(_0x55ba5e,_0x240b4b){const _0x139865=a18_0x4fc4,_0x1b74de=_0x55ba5e();while(!![]){try{const _0x20c55a=-parseInt(_0x139865(0x1c6))/0x1*(-parseInt(_0x139865(0x1f0))/0x2)+parseInt(_0x139865(0x1e2))/0x3*(parseInt(_0x139865(0x1d8))/0x4)+-parseInt(_0x139865(0x1f1))/0x5+parseInt(_0x139865(0x1da))/0x6*(parseInt(_0x139865(0x1c5))/0x7)+parseInt(_0x139865(0x1f3))/0x8+parseInt(_0x139865(0x1e4))/0x9+-parseInt(_0x139865(0x1d7))/0xa;if(_0x20c55a===_0x240b4b)break;else _0x1b74de['push'](_0x1b74de['shift']());}catch(_0x27d1b4){_0x1b74de['push'](_0x1b74de['shift']());}}}(a18_0x34b1,0x38c59));const a18_0x190aad=(function(){let _0x3c006e=!![];return function(_0x4c7d62,_0xe6feea){const _0x5d80aa=_0x3c006e?function(){if(_0xe6feea){const _0x3766f9=_0xe6feea['apply'](_0x4c7d62,arguments);return _0xe6feea=null,_0x3766f9;}}:function(){};return _0x3c006e=![],_0x5d80aa;};}()),a18_0x19084e=a18_0x190aad(this,function(){const _0x28a34a=a18_0x4fc4;return a18_0x19084e[_0x28a34a(0x1fc)]()[_0x28a34a(0x1d5)](_0x28a34a(0x1ce))[_0x28a34a(0x1fc)]()[_0x28a34a(0x1de)](a18_0x19084e)[_0x28a34a(0x1d5)](_0x28a34a(0x1ce));});a18_0x19084e();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x402367){const _0x142871=a18_0x4fc4;return _0x402367&&_0x402367[_0x142871(0x1f9)]?_0x402367:{'default':_0x402367};};Object[a18_0x154a17(0x1eb)](exports,a18_0x154a17(0x1f9),{'value':!![]}),exports[a18_0x154a17(0x1d2)]=exports['listarEmailsAgendados']=exports['listarEmailsEnviados']=exports[a18_0x154a17(0x1cf)]=void 0x0;const EmailService_1=require(a18_0x154a17(0x1fe)),Email_1=__importDefault(require(a18_0x154a17(0x1f5))),moment_1=__importDefault(require('moment')),node_cron_1=__importDefault(require(a18_0x154a17(0x1dd))),sequelize_1=require(a18_0x154a17(0x1ea)),winston_1=__importDefault(require(a18_0x154a17(0x1e5))),logger=winston_1[a18_0x154a17(0x1ec)][a18_0x154a17(0x1ef)]({'level':a18_0x154a17(0x1f8),'format':winston_1[a18_0x154a17(0x1ec)]['format'][a18_0x154a17(0x200)](winston_1[a18_0x154a17(0x1ec)]['format'][a18_0x154a17(0x1c7)](),winston_1['default'][a18_0x154a17(0x1e6)][a18_0x154a17(0x1f2)](({timestamp:_0x3f9e57,level:_0x2c760e,message:_0x528346})=>{return _0x3f9e57+'\x20'+_0x2c760e+':\x20'+_0x528346;})),'transports':[new winston_1[(a18_0x154a17(0x1ec))][(a18_0x154a17(0x1ca))][(a18_0x154a17(0x201))]()]}),enviarEmail=async(_0x5d1c81,_0x177db3)=>{const _0x2371b7=a18_0x154a17;try{const _0x243e7d=_0x5d1c81[_0x2371b7(0x1c8)][_0x2371b7(0x1d9)],{email:_0x4c171f,tokenSenha:_0x21b38f,assunto:_0x1059fb,mensagem:_0x28413f}=_0x5d1c81[_0x2371b7(0x1d0)],_0x155a5b=(0x0,moment_1[_0x2371b7(0x1ec)])()['add'](0x1,_0x2371b7(0x1ed))[_0x2371b7(0x1e6)]('YYYY-MM-DDTHH:mm'),_0x5318dd=await(0x0,EmailService_1[_0x2371b7(0x1fd)])(_0x243e7d,_0x4c171f,_0x21b38f,_0x1059fb,_0x28413f,_0x155a5b);if(_0x5318dd[_0x2371b7(0x203)])return _0x177db3[_0x2371b7(0x1ee)](0x1f4)[_0x2371b7(0x1cc)]({'error':_0x5318dd[_0x2371b7(0x203)]});_0x177db3[_0x2371b7(0x1ee)](0xc8)['json']({'message':_0x2371b7(0x202)});}catch(_0x42d41b){console[_0x2371b7(0x203)](_0x2371b7(0x1e7),_0x42d41b),_0x177db3['status'](0x1f4)[_0x2371b7(0x1cc)]({'error':'Erro\x20ao\x20enviar\x20e-mail'});}};exports[a18_0x154a17(0x1cf)]=enviarEmail;function a18_0x4fc4(_0xf43c96,_0x1a6b3a){const _0x256105=a18_0x34b1();return a18_0x4fc4=function(_0x19084e,_0x190aad){_0x19084e=_0x19084e-0x1c3;let _0x34b12e=_0x256105[_0x19084e];return _0x34b12e;},a18_0x4fc4(_0xf43c96,_0x1a6b3a);}const listarEmailsEnviados=async(_0x13408c,_0x57783e)=>{const _0x3de083=a18_0x154a17;try{const _0x1e6993=await Email_1[_0x3de083(0x1ec)]['findAll']({'where':{'companyId':_0x13408c[_0x3de083(0x1c8)][_0x3de083(0x1d9)],'scheduled':null,'sendAt':null}});_0x57783e[_0x3de083(0x1ee)](0xc8)[_0x3de083(0x1cc)](_0x1e6993);}catch(_0x363c5d){console[_0x3de083(0x203)](_0x3de083(0x1d1),_0x363c5d),_0x57783e[_0x3de083(0x1ee)](0x1f4)[_0x3de083(0x1cc)]({'error':_0x3de083(0x1e0)});}};exports[a18_0x154a17(0x1f4)]=listarEmailsEnviados;const listarEmailsAgendados=async(_0x20f01e,_0x4e5371)=>{const _0x3ccb6b=a18_0x154a17;try{const _0x2864c7=await Email_1[_0x3ccb6b(0x1ec)][_0x3ccb6b(0x1e9)]({'where':{'companyId':_0x20f01e['user']['companyId'],'scheduled':!![],'sendAt':{[sequelize_1['Op']['not']]:null}}});_0x4e5371[_0x3ccb6b(0x1ee)](0xc8)[_0x3ccb6b(0x1cc)](_0x2864c7);}catch(_0x361a60){console['error'](_0x3ccb6b(0x1dc),_0x361a60),_0x4e5371[_0x3ccb6b(0x1ee)](0x1f4)[_0x3ccb6b(0x1cc)]({'error':'Erro\x20ao\x20listar\x20e-mails\x20agendados'});}};exports[a18_0x154a17(0x1cb)]=listarEmailsAgendados;const agendarEnvioEmail=async(_0x510ffa,_0xb70447)=>{const _0x1973d5=a18_0x154a17;try{const _0x50c6d4=_0x510ffa['user'][_0x1973d5(0x1d9)],{recipient:_0x3c6224,subject:_0x5bdb5b,message:_0x183e00,sendAt:_0x5ab7e4}=_0x510ffa[_0x1973d5(0x1d0)],_0x58eb6c=new Date(_0x5ab7e4);if(_0x58eb6c<=new Date())return _0xb70447[_0x1973d5(0x1ee)](0x190)[_0x1973d5(0x1cc)]({'error':_0x1973d5(0x1d6)});await Email_1['default'][_0x1973d5(0x1db)]({'sender':_0x510ffa[_0x1973d5(0x1d0)][_0x1973d5(0x1e3)],'subject':_0x510ffa[_0x1973d5(0x1d0)]['assunto'],'message':_0x510ffa['body']['mensagem'],'companyId':_0x50c6d4,'scheduled':!![],'sendAt':new Date(_0x5ab7e4)}),_0xb70447['status'](0xc8)[_0x1973d5(0x1cc)]({'message':_0x1973d5(0x1df)});}catch(_0x1a4e2a){console[_0x1973d5(0x203)](_0x1973d5(0x1f7),_0x1a4e2a),_0xb70447[_0x1973d5(0x1ee)](0x1f4)[_0x1973d5(0x1cc)]({'error':_0x1973d5(0x1d4)});}};exports[a18_0x154a17(0x1d2)]=agendarEnvioEmail;const enviarAgendamentosPendentes=async()=>{const _0x229d23=a18_0x154a17;try{const _0x585d85=(0x0,moment_1[_0x229d23(0x1ec)])(),_0x23e639=await Email_1[_0x229d23(0x1ec)][_0x229d23(0x1e9)]({'where':{'scheduled':!![],'sendAt':{[sequelize_1['Op'][_0x229d23(0x1c9)]]:_0x585d85[_0x229d23(0x1fb)]()}}});for(const _0x479dd6 of _0x23e639){const _0x318c32=await(0x0,EmailService_1[_0x229d23(0x1fd)])(_0x479dd6[_0x229d23(0x1d9)],_0x479dd6[_0x229d23(0x1c3)],'',_0x479dd6[_0x229d23(0x1e8)],_0x479dd6[_0x229d23(0x1f6)],_0x479dd6['sendAt'][_0x229d23(0x1c4)](),'');!_0x318c32[_0x229d23(0x203)]?(await _0x479dd6[_0x229d23(0x1ff)]({'scheduled':![]}),logger[_0x229d23(0x1f8)](_0x229d23(0x1e1)+_0x479dd6[_0x229d23(0x1c3)])):logger['error']('Erro\x20ao\x20enviar\x20e-mail\x20agendado\x20para:\x20'+_0x479dd6['sender']+_0x229d23(0x1cd)+_0x318c32[_0x229d23(0x203)]);}}catch(_0x428afb){logger[_0x229d23(0x203)]('Erro\x20ao\x20enviar\x20agendamentos\x20pendentes:',_0x428afb);}};node_cron_1[a18_0x154a17(0x1ec)][a18_0x154a17(0x1fa)](a18_0x154a17(0x1d3),enviarAgendamentosPendentes);