const a18_0x5b2c0e=a18_0x5383;(function(_0x499a30,_0x502749){const _0x59b605=a18_0x5383,_0x4aa9ca=_0x499a30();while(!![]){try{const _0x30a37a=parseInt(_0x59b605(0x15a))/0x1+-parseInt(_0x59b605(0x148))/0x2+parseInt(_0x59b605(0x138))/0x3+parseInt(_0x59b605(0x137))/0x4*(-parseInt(_0x59b605(0x136))/0x5)+parseInt(_0x59b605(0x141))/0x6+-parseInt(_0x59b605(0x14c))/0x7+-parseInt(_0x59b605(0x12f))/0x8*(-parseInt(_0x59b605(0x133))/0x9);if(_0x30a37a===_0x502749)break;else _0x4aa9ca['push'](_0x4aa9ca['shift']());}catch(_0x31b90b){_0x4aa9ca['push'](_0x4aa9ca['shift']());}}}(a18_0x391c,0xdc8b6));const a18_0x3a7251=(function(){let _0x209577=!![];return function(_0x3c00c1,_0x5a7260){const _0x51ad8d=_0x209577?function(){const _0x125b32=a18_0x5383;if(_0x5a7260){const _0x19ee4a=_0x5a7260[_0x125b32(0x143)](_0x3c00c1,arguments);return _0x5a7260=null,_0x19ee4a;}}:function(){};return _0x209577=![],_0x51ad8d;};}()),a18_0x58d553=a18_0x3a7251(this,function(){const _0x5c1b79=a18_0x5383;return a18_0x58d553[_0x5c1b79(0x139)]()[_0x5c1b79(0x125)](_0x5c1b79(0x129))['toString']()[_0x5c1b79(0x163)](a18_0x58d553)[_0x5c1b79(0x125)](_0x5c1b79(0x129));});a18_0x58d553();'use strict';var __importDefault=this&&this[a18_0x5b2c0e(0x156)]||function(_0x53403b){return _0x53403b&&_0x53403b['__esModule']?_0x53403b:{'default':_0x53403b};};Object[a18_0x5b2c0e(0x145)](exports,a18_0x5b2c0e(0x130),{'value':!![]}),exports['agendarEnvioEmail']=exports[a18_0x5b2c0e(0x14b)]=exports[a18_0x5b2c0e(0x157)]=exports[a18_0x5b2c0e(0x155)]=void 0x0;const EmailService_1=require(a18_0x5b2c0e(0x15b)),Email_1=__importDefault(require(a18_0x5b2c0e(0x150))),moment_1=__importDefault(require('moment')),node_cron_1=__importDefault(require('node-cron')),sequelize_1=require(a18_0x5b2c0e(0x146)),winston_1=__importDefault(require(a18_0x5b2c0e(0x13b))),logger=winston_1[a18_0x5b2c0e(0x142)][a18_0x5b2c0e(0x12a)]({'level':a18_0x5b2c0e(0x161),'format':winston_1[a18_0x5b2c0e(0x142)]['format']['combine'](winston_1['default'][a18_0x5b2c0e(0x152)][a18_0x5b2c0e(0x14a)](),winston_1[a18_0x5b2c0e(0x142)][a18_0x5b2c0e(0x152)][a18_0x5b2c0e(0x123)](({timestamp:_0x51eddb,level:_0x5430b3,message:_0x465dc5})=>{return _0x51eddb+'\x20'+_0x5430b3+':\x20'+_0x465dc5;})),'transports':[new winston_1[(a18_0x5b2c0e(0x142))]['transports']['Console']()]}),enviarEmail=async(_0x53bd57,_0x51130e)=>{const _0x5ae15f=a18_0x5b2c0e;try{const _0x559c7e=_0x53bd57[_0x5ae15f(0x13e)][_0x5ae15f(0x12c)],{email:_0x2a4ee7,tokenSenha:_0xfd9ead,assunto:_0x1983eb,mensagem:_0x135795}=_0x53bd57[_0x5ae15f(0x14f)],_0x5d61e8=(0x0,moment_1[_0x5ae15f(0x142)])()[_0x5ae15f(0x15f)](0x1,_0x5ae15f(0x13d))[_0x5ae15f(0x152)](_0x5ae15f(0x13f)),_0x4b8061=await(0x0,EmailService_1[_0x5ae15f(0x162)])(_0x559c7e,_0x2a4ee7,_0xfd9ead,_0x1983eb,_0x135795,_0x5d61e8);if(_0x4b8061[_0x5ae15f(0x135)])return _0x51130e[_0x5ae15f(0x126)](0x1f4)[_0x5ae15f(0x15c)]({'error':_0x4b8061[_0x5ae15f(0x135)]});_0x51130e[_0x5ae15f(0x126)](0xc8)[_0x5ae15f(0x15c)]({'message':_0x5ae15f(0x159)});}catch(_0x43212b){console[_0x5ae15f(0x135)](_0x5ae15f(0x13c),_0x43212b),_0x51130e[_0x5ae15f(0x126)](0x1f4)[_0x5ae15f(0x15c)]({'error':_0x5ae15f(0x12b)});}};exports[a18_0x5b2c0e(0x155)]=enviarEmail;const listarEmailsEnviados=async(_0x1b918b,_0x1daf23)=>{const _0x467756=a18_0x5b2c0e;try{const _0x1de9cd=await Email_1['default'][_0x467756(0x12d)]({'where':{'companyId':_0x1b918b[_0x467756(0x13e)][_0x467756(0x12c)],'scheduled':null,'sendAt':null}});_0x1daf23[_0x467756(0x126)](0xc8)[_0x467756(0x15c)](_0x1de9cd);}catch(_0x43cfea){console[_0x467756(0x135)]('Erro\x20ao\x20listar\x20e-mails\x20enviados:',_0x43cfea),_0x1daf23[_0x467756(0x126)](0x1f4)[_0x467756(0x15c)]({'error':_0x467756(0x14d)});}};exports[a18_0x5b2c0e(0x157)]=listarEmailsEnviados;const listarEmailsAgendados=async(_0x323035,_0x1daa70)=>{const _0x3fc308=a18_0x5b2c0e;try{const _0x3f6c14=await Email_1[_0x3fc308(0x142)]['findAll']({'where':{'companyId':_0x323035[_0x3fc308(0x13e)][_0x3fc308(0x12c)],'scheduled':!![],'sendAt':{[sequelize_1['Op']['not']]:null}}});_0x1daa70[_0x3fc308(0x126)](0xc8)['json'](_0x3f6c14);}catch(_0x5cf967){console[_0x3fc308(0x135)](_0x3fc308(0x158),_0x5cf967),_0x1daa70['status'](0x1f4)[_0x3fc308(0x15c)]({'error':_0x3fc308(0x147)});}};exports[a18_0x5b2c0e(0x14b)]=listarEmailsAgendados;const agendarEnvioEmail=async(_0x28fd9e,_0x257ba2)=>{const _0x1a1fab=a18_0x5b2c0e;try{const _0x265f0e=_0x28fd9e['user']['companyId'],{recipient:_0x23f439,subject:_0x364317,message:_0x21ff8f,sendAt:_0x5f2434}=_0x28fd9e[_0x1a1fab(0x14f)],_0x3fb3e8=new Date(_0x5f2434);if(_0x3fb3e8<=new Date())return _0x257ba2['status'](0x190)['json']({'error':_0x1a1fab(0x122)});await Email_1[_0x1a1fab(0x142)][_0x1a1fab(0x124)]({'sender':_0x28fd9e['body'][_0x1a1fab(0x154)],'subject':_0x28fd9e[_0x1a1fab(0x14f)][_0x1a1fab(0x127)],'message':_0x28fd9e[_0x1a1fab(0x14f)][_0x1a1fab(0x12e)],'companyId':_0x265f0e,'scheduled':!![],'sendAt':new Date(_0x5f2434)}),_0x257ba2[_0x1a1fab(0x126)](0xc8)[_0x1a1fab(0x15c)]({'message':_0x1a1fab(0x13a)});}catch(_0x5882f2){console[_0x1a1fab(0x135)]('Erro\x20ao\x20agendar\x20o\x20envio\x20de\x20e-mail:',_0x5882f2),_0x257ba2[_0x1a1fab(0x126)](0x1f4)[_0x1a1fab(0x15c)]({'error':'Erro\x20ao\x20agendar\x20o\x20envio\x20de\x20e-mail'});}};exports[a18_0x5b2c0e(0x131)]=agendarEnvioEmail;function a18_0x5383(_0x135f6b,_0x5ebbed){const _0x351336=a18_0x391c();return a18_0x5383=function(_0x58d553,_0x3a7251){_0x58d553=_0x58d553-0x122;let _0x391c7e=_0x351336[_0x58d553];return _0x391c7e;},a18_0x5383(_0x135f6b,_0x5ebbed);}function a18_0x391c(){const _0x4cc32f=['sendAt','(((.+)+)+)+$','createLogger','Erro\x20ao\x20enviar\x20e-mail','companyId','findAll','mensagem','232648aSAZmE','__esModule','agendarEnvioEmail','schedule','747BAikHa','update','error','55VcHnoZ','69884KFraBl','308319YGTzMW','toString','E-mail\x20agendado\x20com\x20sucesso','winston','Erro\x20ao\x20enviar\x20e-mail:','hour','user','YYYY-MM-DDTHH:mm','toISOString','5948430FPaSgY','default','apply',',\x20erro:\x20','defineProperty','sequelize','Erro\x20ao\x20listar\x20e-mails\x20agendados','2400954RlpEHh','sender','timestamp','listarEmailsAgendados','9942373SKyHQI','Erro\x20ao\x20listar\x20e-mails\x20enviados','lte','body','../models/Email','Erro\x20ao\x20enviar\x20e-mail\x20agendado\x20para:\x20','format','subject','email','enviarEmail','__importDefault','listarEmailsEnviados','Erro\x20ao\x20listar\x20e-mails\x20agendados:','E-mail\x20enviado\x20com\x20sucesso','208446ApOgZd','../services/EmailService/EmailService','json','toDate','E-mail\x20agendado\x20enviado\x20com\x20sucesso\x20para:\x20','add','Erro\x20ao\x20enviar\x20agendamentos\x20pendentes:','info','SendMail','constructor','A\x20data\x20de\x20envio\x20deve\x20ser\x20no\x20futuro','printf','create','search','status','assunto'];a18_0x391c=function(){return _0x4cc32f;};return a18_0x391c();}const enviarAgendamentosPendentes=async()=>{const _0x55674c=a18_0x5b2c0e;try{const _0x147cee=(0x0,moment_1['default'])(),_0x385652=await Email_1['default'][_0x55674c(0x12d)]({'where':{'scheduled':!![],'sendAt':{[sequelize_1['Op'][_0x55674c(0x14e)]]:_0x147cee[_0x55674c(0x15d)]()}}});for(const _0x5db33e of _0x385652){const _0x1fb3bb=await(0x0,EmailService_1[_0x55674c(0x162)])(_0x5db33e[_0x55674c(0x12c)],_0x5db33e[_0x55674c(0x149)],'',_0x5db33e[_0x55674c(0x153)],_0x5db33e['message'],_0x5db33e[_0x55674c(0x128)][_0x55674c(0x140)](),'');!_0x1fb3bb[_0x55674c(0x135)]?(await _0x5db33e[_0x55674c(0x134)]({'scheduled':![]}),logger[_0x55674c(0x161)](_0x55674c(0x15e)+_0x5db33e['sender'])):logger[_0x55674c(0x135)](_0x55674c(0x151)+_0x5db33e['sender']+_0x55674c(0x144)+_0x1fb3bb[_0x55674c(0x135)]);}}catch(_0xd5ecfe){logger[_0x55674c(0x135)](_0x55674c(0x160),_0xd5ecfe);}};node_cron_1[a18_0x5b2c0e(0x142)][a18_0x5b2c0e(0x132)]('*/30\x20*\x20*\x20*\x20*\x20*',enviarAgendamentosPendentes);