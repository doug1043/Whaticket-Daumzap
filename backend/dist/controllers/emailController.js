const a17_0x123eff=a17_0x48b7;(function(_0x3ea8ee,_0x241b85){const _0x51efb8=a17_0x48b7,_0x4cce7c=_0x3ea8ee();while(!![]){try{const _0x417681=-parseInt(_0x51efb8(0x164))/0x1+-parseInt(_0x51efb8(0x189))/0x2+-parseInt(_0x51efb8(0x197))/0x3*(-parseInt(_0x51efb8(0x17b))/0x4)+-parseInt(_0x51efb8(0x178))/0x5+parseInt(_0x51efb8(0x161))/0x6+parseInt(_0x51efb8(0x182))/0x7*(parseInt(_0x51efb8(0x196))/0x8)+-parseInt(_0x51efb8(0x173))/0x9*(-parseInt(_0x51efb8(0x16c))/0xa);if(_0x417681===_0x241b85)break;else _0x4cce7c['push'](_0x4cce7c['shift']());}catch(_0x34b79f){_0x4cce7c['push'](_0x4cce7c['shift']());}}}(a17_0x305a,0x369af));const a17_0x2561a9=(function(){let _0x34d5b8=!![];return function(_0x5173d2,_0x5cc405){const _0x1f310c=_0x34d5b8?function(){const _0x3e2b4a=a17_0x48b7;if(_0x5cc405){const _0x2b2cbd=_0x5cc405[_0x3e2b4a(0x160)](_0x5173d2,arguments);return _0x5cc405=null,_0x2b2cbd;}}:function(){};return _0x34d5b8=![],_0x1f310c;};}()),a17_0x3ee9cf=a17_0x2561a9(this,function(){const _0x383850=a17_0x48b7;return a17_0x3ee9cf[_0x383850(0x163)]()[_0x383850(0x16f)]('(((.+)+)+)+$')[_0x383850(0x163)]()[_0x383850(0x18d)](a17_0x3ee9cf)[_0x383850(0x16f)](_0x383850(0x195));});a17_0x3ee9cf();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x44cdea){return _0x44cdea&&_0x44cdea['__esModule']?_0x44cdea:{'default':_0x44cdea};};Object['defineProperty'](exports,a17_0x123eff(0x15e),{'value':!![]}),exports[a17_0x123eff(0x175)]=exports[a17_0x123eff(0x188)]=exports[a17_0x123eff(0x181)]=exports[a17_0x123eff(0x16a)]=void 0x0;const EmailService_1=require(a17_0x123eff(0x16e)),Email_1=__importDefault(require(a17_0x123eff(0x17e))),moment_1=__importDefault(require(a17_0x123eff(0x16b))),node_cron_1=__importDefault(require('node-cron')),sequelize_1=require(a17_0x123eff(0x198)),winston_1=__importDefault(require(a17_0x123eff(0x190))),logger=winston_1[a17_0x123eff(0x185)]['createLogger']({'level':a17_0x123eff(0x166),'format':winston_1[a17_0x123eff(0x185)][a17_0x123eff(0x16d)]['combine'](winston_1['default'][a17_0x123eff(0x16d)]['timestamp'](),winston_1[a17_0x123eff(0x185)][a17_0x123eff(0x16d)][a17_0x123eff(0x191)](({timestamp:_0x348639,level:_0x10e68e,message:_0xd7d668})=>{return _0x348639+'\x20'+_0x10e68e+':\x20'+_0xd7d668;})),'transports':[new winston_1[(a17_0x123eff(0x185))]['transports'][(a17_0x123eff(0x168))]()]}),enviarEmail=async(_0x2dd689,_0x2974fd)=>{const _0x8e8a8e=a17_0x123eff;try{const _0x3f432d=_0x2dd689[_0x8e8a8e(0x184)][_0x8e8a8e(0x18f)],{email:_0x5a7702,tokenSenha:_0x4e7aaa,assunto:_0xbf949,mensagem:_0x4b510a}=_0x2dd689[_0x8e8a8e(0x180)],_0x1716fa=(0x0,moment_1['default'])()[_0x8e8a8e(0x183)](0x1,'hour')[_0x8e8a8e(0x16d)](_0x8e8a8e(0x15d)),_0x120943=await(0x0,EmailService_1['SendMail'])(_0x3f432d,_0x5a7702,_0x4e7aaa,_0xbf949,_0x4b510a,_0x1716fa);if(_0x120943[_0x8e8a8e(0x171)])return _0x2974fd[_0x8e8a8e(0x17c)](0x1f4)['json']({'error':_0x120943[_0x8e8a8e(0x171)]});_0x2974fd[_0x8e8a8e(0x17c)](0xc8)['json']({'message':_0x8e8a8e(0x15f)});}catch(_0xec2b57){console['error']('Erro\x20ao\x20enviar\x20e-mail:',_0xec2b57),_0x2974fd[_0x8e8a8e(0x17c)](0x1f4)['json']({'error':_0x8e8a8e(0x193)});}};exports['enviarEmail']=enviarEmail;function a17_0x48b7(_0x57e2e7,_0x39340a){const _0x2ec22a=a17_0x305a();return a17_0x48b7=function(_0x3ee9cf,_0x2561a9){_0x3ee9cf=_0x3ee9cf-0x15a;let _0x305a5a=_0x2ec22a[_0x3ee9cf];return _0x305a5a;},a17_0x48b7(_0x57e2e7,_0x39340a);}const listarEmailsEnviados=async(_0x10fca5,_0x1bef16)=>{const _0x4bf2c5=a17_0x123eff;try{const _0x59da47=await Email_1[_0x4bf2c5(0x185)]['findAll']({'where':{'companyId':_0x10fca5['user'][_0x4bf2c5(0x18f)],'scheduled':null,'sendAt':null}});_0x1bef16[_0x4bf2c5(0x17c)](0xc8)[_0x4bf2c5(0x18a)](_0x59da47);}catch(_0x39e6c9){console['error']('Erro\x20ao\x20listar\x20e-mails\x20enviados:',_0x39e6c9),_0x1bef16[_0x4bf2c5(0x17c)](0x1f4)[_0x4bf2c5(0x18a)]({'error':'Erro\x20ao\x20listar\x20e-mails\x20enviados'});}};exports['listarEmailsEnviados']=listarEmailsEnviados;function a17_0x305a(){const _0x5e05e6=['listarEmailsAgendados','344696tvgcas','json','create','toISOString','constructor','Erro\x20ao\x20agendar\x20o\x20envio\x20de\x20e-mail','companyId','winston','printf','email','Erro\x20ao\x20enviar\x20e-mail','A\x20data\x20de\x20envio\x20deve\x20ser\x20no\x20futuro','(((.+)+)+)+$','4704PRAhfw','183scRfXy','sequelize','lte','Erro\x20ao\x20enviar\x20agendamentos\x20pendentes:','Erro\x20ao\x20enviar\x20e-mail\x20agendado\x20para:\x20','YYYY-MM-DDTHH:mm','__esModule','E-mail\x20enviado\x20com\x20sucesso','apply','2027568uDFYhE','update','toString','340531NbNSYK','sender','info','SendMail','Console','message','enviarEmail','moment','690jVdCAk','format','../services/EmailService/EmailService','search','Erro\x20ao\x20agendar\x20o\x20envio\x20de\x20e-mail:','error','sendAt','32985beAJkJ','not','agendarEnvioEmail',',\x20erro:\x20','Erro\x20ao\x20listar\x20e-mails\x20agendados','1458540lUNVho','Erro\x20ao\x20listar\x20e-mails\x20agendados:','assunto','6244iwmwHs','status','findAll','../models/Email','*/30\x20*\x20*\x20*\x20*\x20*','body','listarEmailsEnviados','4074CJvxrh','add','user','default','subject','schedule'];a17_0x305a=function(){return _0x5e05e6;};return a17_0x305a();}const listarEmailsAgendados=async(_0x12d7c9,_0x2e4406)=>{const _0x5a72dd=a17_0x123eff;try{const _0x2eef9e=await Email_1['default']['findAll']({'where':{'companyId':_0x12d7c9[_0x5a72dd(0x184)]['companyId'],'scheduled':!![],'sendAt':{[sequelize_1['Op'][_0x5a72dd(0x174)]]:null}}});_0x2e4406['status'](0xc8)[_0x5a72dd(0x18a)](_0x2eef9e);}catch(_0x290f90){console[_0x5a72dd(0x171)](_0x5a72dd(0x179),_0x290f90),_0x2e4406['status'](0x1f4)[_0x5a72dd(0x18a)]({'error':_0x5a72dd(0x177)});}};exports[a17_0x123eff(0x188)]=listarEmailsAgendados;const agendarEnvioEmail=async(_0x168f38,_0x5570d0)=>{const _0x51e1b5=a17_0x123eff;try{const _0x33bbf8=_0x168f38[_0x51e1b5(0x184)]['companyId'],{recipient:_0x206179,subject:_0x1f374f,message:_0xab94eb,sendAt:_0x103314}=_0x168f38[_0x51e1b5(0x180)],_0x847814=new Date(_0x103314);if(_0x847814<=new Date())return _0x5570d0[_0x51e1b5(0x17c)](0x190)['json']({'error':_0x51e1b5(0x194)});await Email_1['default'][_0x51e1b5(0x18b)]({'sender':_0x168f38[_0x51e1b5(0x180)][_0x51e1b5(0x192)],'subject':_0x168f38[_0x51e1b5(0x180)][_0x51e1b5(0x17a)],'message':_0x168f38[_0x51e1b5(0x180)]['mensagem'],'companyId':_0x33bbf8,'scheduled':!![],'sendAt':new Date(_0x103314)}),_0x5570d0[_0x51e1b5(0x17c)](0xc8)['json']({'message':'E-mail\x20agendado\x20com\x20sucesso'});}catch(_0x913a15){console[_0x51e1b5(0x171)](_0x51e1b5(0x170),_0x913a15),_0x5570d0[_0x51e1b5(0x17c)](0x1f4)[_0x51e1b5(0x18a)]({'error':_0x51e1b5(0x18e)});}};exports[a17_0x123eff(0x175)]=agendarEnvioEmail;const enviarAgendamentosPendentes=async()=>{const _0x273bfa=a17_0x123eff;try{const _0x34b7e1=(0x0,moment_1[_0x273bfa(0x185)])(),_0x4d8b86=await Email_1[_0x273bfa(0x185)][_0x273bfa(0x17d)]({'where':{'scheduled':!![],'sendAt':{[sequelize_1['Op'][_0x273bfa(0x15a)]]:_0x34b7e1['toDate']()}}});for(const _0x1c1b05 of _0x4d8b86){const _0x49a7a7=await(0x0,EmailService_1[_0x273bfa(0x167)])(_0x1c1b05[_0x273bfa(0x18f)],_0x1c1b05['sender'],'',_0x1c1b05[_0x273bfa(0x186)],_0x1c1b05[_0x273bfa(0x169)],_0x1c1b05[_0x273bfa(0x172)][_0x273bfa(0x18c)](),'');!_0x49a7a7[_0x273bfa(0x171)]?(await _0x1c1b05[_0x273bfa(0x162)]({'scheduled':![]}),logger['info']('E-mail\x20agendado\x20enviado\x20com\x20sucesso\x20para:\x20'+_0x1c1b05[_0x273bfa(0x165)])):logger[_0x273bfa(0x171)](_0x273bfa(0x15c)+_0x1c1b05['sender']+_0x273bfa(0x176)+_0x49a7a7['error']);}}catch(_0x12aa94){logger[_0x273bfa(0x171)](_0x273bfa(0x15b),_0x12aa94);}};node_cron_1[a17_0x123eff(0x185)][a17_0x123eff(0x187)](a17_0x123eff(0x17f),enviarAgendamentosPendentes);