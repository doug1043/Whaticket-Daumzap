const a17_0x4d3938=a17_0x35a6;(function(_0x135086,_0x18d832){const _0x3af916=a17_0x35a6,_0xacb7b4=_0x135086();while(!![]){try{const _0x7fc46a=-parseInt(_0x3af916(0xb2))/0x1*(parseInt(_0x3af916(0xc1))/0x2)+-parseInt(_0x3af916(0xce))/0x3*(parseInt(_0x3af916(0xa9))/0x4)+parseInt(_0x3af916(0xb8))/0x5*(parseInt(_0x3af916(0xd0))/0x6)+-parseInt(_0x3af916(0xad))/0x7*(parseInt(_0x3af916(0xc6))/0x8)+parseInt(_0x3af916(0xd1))/0x9*(parseInt(_0x3af916(0xc3))/0xa)+-parseInt(_0x3af916(0xab))/0xb*(-parseInt(_0x3af916(0xa5))/0xc)+parseInt(_0x3af916(0x96))/0xd;if(_0x7fc46a===_0x18d832)break;else _0xacb7b4['push'](_0xacb7b4['shift']());}catch(_0x25a2cd){_0xacb7b4['push'](_0xacb7b4['shift']());}}}(a17_0xc4da,0xb778d));const a17_0x117188=(function(){let _0x33c922=!![];return function(_0x34072f,_0x224797){const _0x2e0f8e=_0x33c922?function(){if(_0x224797){const _0x1436aa=_0x224797['apply'](_0x34072f,arguments);return _0x224797=null,_0x1436aa;}}:function(){};return _0x33c922=![],_0x2e0f8e;};}()),a17_0x1be367=a17_0x117188(this,function(){const _0x18f0ff=a17_0x35a6;return a17_0x1be367[_0x18f0ff(0x9a)]()[_0x18f0ff(0xd5)](_0x18f0ff(0xd9))['toString']()[_0x18f0ff(0xb9)](a17_0x1be367)[_0x18f0ff(0xd5)](_0x18f0ff(0xd9));});a17_0x1be367();'use strict';function a17_0x35a6(_0x5527e9,_0x355b4d){const _0x4ab4b4=a17_0xc4da();return a17_0x35a6=function(_0x1be367,_0x117188){_0x1be367=_0x1be367-0x96;let _0xc4da31=_0x4ab4b4[_0x1be367];return _0xc4da31;},a17_0x35a6(_0x5527e9,_0x355b4d);}var __importDefault=this&&this[a17_0x4d3938(0xa7)]||function(_0x1b79a9){return _0x1b79a9&&_0x1b79a9['__esModule']?_0x1b79a9:{'default':_0x1b79a9};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a17_0x4d3938(0xcb)]=exports['listarEmailsAgendados']=exports[a17_0x4d3938(0xba)]=exports[a17_0x4d3938(0xae)]=void 0x0;const EmailService_1=require('../services/EmailService/EmailService'),Email_1=__importDefault(require(a17_0x4d3938(0xa6))),moment_1=__importDefault(require(a17_0x4d3938(0xd8))),node_cron_1=__importDefault(require(a17_0x4d3938(0xd3))),sequelize_1=require(a17_0x4d3938(0xa0)),winston_1=__importDefault(require(a17_0x4d3938(0xc9))),logger=winston_1[a17_0x4d3938(0xca)][a17_0x4d3938(0xb3)]({'level':a17_0x4d3938(0xc2),'format':winston_1[a17_0x4d3938(0xca)][a17_0x4d3938(0x9c)][a17_0x4d3938(0xa1)](winston_1[a17_0x4d3938(0xca)][a17_0x4d3938(0x9c)][a17_0x4d3938(0xbb)](),winston_1[a17_0x4d3938(0xca)][a17_0x4d3938(0x9c)][a17_0x4d3938(0xaf)](({timestamp:_0x539261,level:_0x16644,message:_0x1b1b3f})=>{return _0x539261+'\x20'+_0x16644+':\x20'+_0x1b1b3f;})),'transports':[new winston_1[(a17_0x4d3938(0xca))][(a17_0x4d3938(0xb0))]['Console']()]}),enviarEmail=async(_0x143ec2,_0x9f74b1)=>{const _0x18983f=a17_0x4d3938;try{const _0x270e3b=_0x143ec2[_0x18983f(0xa4)][_0x18983f(0xbf)],{email:_0x1395bf,tokenSenha:_0x3d7440,assunto:_0xd6a708,mensagem:_0x4bf959}=_0x143ec2[_0x18983f(0xbe)],_0x490468=(0x0,moment_1[_0x18983f(0xca)])()[_0x18983f(0xb7)](0x1,_0x18983f(0xbd))[_0x18983f(0x9c)](_0x18983f(0xa2)),_0xbc1879=await(0x0,EmailService_1[_0x18983f(0xb4)])(_0x270e3b,_0x1395bf,_0x3d7440,_0xd6a708,_0x4bf959,_0x490468);if(_0xbc1879[_0x18983f(0xaa)])return _0x9f74b1[_0x18983f(0xc7)](0x1f4)[_0x18983f(0xc4)]({'error':_0xbc1879[_0x18983f(0xaa)]});_0x9f74b1[_0x18983f(0xc7)](0xc8)['json']({'message':_0x18983f(0xc0)});}catch(_0x2c5c2b){console[_0x18983f(0xaa)](_0x18983f(0x99),_0x2c5c2b),_0x9f74b1[_0x18983f(0xc7)](0x1f4)[_0x18983f(0xc4)]({'error':_0x18983f(0xa3)});}};exports[a17_0x4d3938(0xae)]=enviarEmail;function a17_0xc4da(){const _0x124c6c=['5jrOQXa','constructor','listarEmailsEnviados','timestamp','Erro\x20ao\x20agendar\x20o\x20envio\x20de\x20e-mail:','hour','body','companyId','E-mail\x20enviado\x20com\x20sucesso','213692NjgZkB','info','224470ouuUOq','json','Erro\x20ao\x20agendar\x20o\x20envio\x20de\x20e-mail','3891640dxJrGv','status','Erro\x20ao\x20enviar\x20e-mail\x20agendado\x20para:\x20','winston','default','agendarEnvioEmail','message','sendAt','3ELyAoF','Erro\x20ao\x20listar\x20e-mails\x20agendados','8411076JoeVmR','27BcZBJi','Erro\x20ao\x20enviar\x20agendamentos\x20pendentes:','node-cron','email','search','subject','listarEmailsAgendados','moment','(((.+)+)+)+$','7344714XCIHGt','*/30\x20*\x20*\x20*\x20*\x20*','sender','Erro\x20ao\x20enviar\x20e-mail:','toString','E-mail\x20agendado\x20com\x20sucesso','format','assunto','mensagem','findAll','sequelize','combine','YYYY-MM-DDTHH:mm','Erro\x20ao\x20enviar\x20e-mail','user','12ptmhyc','../models/Email','__importDefault','schedule','4449448aBARbb','error','7003601OUwaqi','create','7kPATQn','enviarEmail','printf','transports','Erro\x20ao\x20listar\x20e-mails\x20enviados','3JXxpJJ','createLogger','SendMail','A\x20data\x20de\x20envio\x20deve\x20ser\x20no\x20futuro','update','add'];a17_0xc4da=function(){return _0x124c6c;};return a17_0xc4da();}const listarEmailsEnviados=async(_0x3bcb3c,_0x5a56ea)=>{const _0x433097=a17_0x4d3938;try{const _0x3058d1=await Email_1[_0x433097(0xca)]['findAll']({'where':{'companyId':_0x3bcb3c[_0x433097(0xa4)][_0x433097(0xbf)],'scheduled':null,'sendAt':null}});_0x5a56ea['status'](0xc8)[_0x433097(0xc4)](_0x3058d1);}catch(_0x3a035e){console[_0x433097(0xaa)]('Erro\x20ao\x20listar\x20e-mails\x20enviados:',_0x3a035e),_0x5a56ea['status'](0x1f4)[_0x433097(0xc4)]({'error':_0x433097(0xb1)});}};exports[a17_0x4d3938(0xba)]=listarEmailsEnviados;const listarEmailsAgendados=async(_0x58ab8c,_0x182693)=>{const _0x13f023=a17_0x4d3938;try{const _0x5441c8=await Email_1[_0x13f023(0xca)][_0x13f023(0x9f)]({'where':{'companyId':_0x58ab8c[_0x13f023(0xa4)][_0x13f023(0xbf)],'scheduled':!![],'sendAt':{[sequelize_1['Op']['not']]:null}}});_0x182693['status'](0xc8)[_0x13f023(0xc4)](_0x5441c8);}catch(_0x68e22d){console[_0x13f023(0xaa)]('Erro\x20ao\x20listar\x20e-mails\x20agendados:',_0x68e22d),_0x182693[_0x13f023(0xc7)](0x1f4)['json']({'error':_0x13f023(0xcf)});}};exports[a17_0x4d3938(0xd7)]=listarEmailsAgendados;const agendarEnvioEmail=async(_0x1272b4,_0x48117f)=>{const _0x38e130=a17_0x4d3938;try{const _0x4d0b9a=_0x1272b4[_0x38e130(0xa4)][_0x38e130(0xbf)],{recipient:_0x25921a,subject:_0x468a62,message:_0x244b48,sendAt:_0x24f29b}=_0x1272b4[_0x38e130(0xbe)],_0x386059=new Date(_0x24f29b);if(_0x386059<=new Date())return _0x48117f[_0x38e130(0xc7)](0x190)[_0x38e130(0xc4)]({'error':_0x38e130(0xb5)});await Email_1[_0x38e130(0xca)][_0x38e130(0xac)]({'sender':_0x1272b4[_0x38e130(0xbe)][_0x38e130(0xd4)],'subject':_0x1272b4['body'][_0x38e130(0x9d)],'message':_0x1272b4[_0x38e130(0xbe)][_0x38e130(0x9e)],'companyId':_0x4d0b9a,'scheduled':!![],'sendAt':new Date(_0x24f29b)}),_0x48117f[_0x38e130(0xc7)](0xc8)[_0x38e130(0xc4)]({'message':_0x38e130(0x9b)});}catch(_0x422150){console[_0x38e130(0xaa)](_0x38e130(0xbc),_0x422150),_0x48117f[_0x38e130(0xc7)](0x1f4)[_0x38e130(0xc4)]({'error':_0x38e130(0xc5)});}};exports[a17_0x4d3938(0xcb)]=agendarEnvioEmail;const enviarAgendamentosPendentes=async()=>{const _0x35a7e4=a17_0x4d3938;try{const _0x1ca869=(0x0,moment_1[_0x35a7e4(0xca)])(),_0x289dad=await Email_1['default']['findAll']({'where':{'scheduled':!![],'sendAt':{[sequelize_1['Op']['lte']]:_0x1ca869['toDate']()}}});for(const _0xc6b830 of _0x289dad){const _0x2fc4ae=await(0x0,EmailService_1['SendMail'])(_0xc6b830[_0x35a7e4(0xbf)],_0xc6b830[_0x35a7e4(0x98)],'',_0xc6b830[_0x35a7e4(0xd6)],_0xc6b830[_0x35a7e4(0xcc)],_0xc6b830[_0x35a7e4(0xcd)]['toISOString'](),'');!_0x2fc4ae[_0x35a7e4(0xaa)]?(await _0xc6b830[_0x35a7e4(0xb6)]({'scheduled':![]}),logger[_0x35a7e4(0xc2)]('E-mail\x20agendado\x20enviado\x20com\x20sucesso\x20para:\x20'+_0xc6b830[_0x35a7e4(0x98)])):logger['error'](_0x35a7e4(0xc8)+_0xc6b830[_0x35a7e4(0x98)]+',\x20erro:\x20'+_0x2fc4ae[_0x35a7e4(0xaa)]);}}catch(_0x3cea6d){logger[_0x35a7e4(0xaa)](_0x35a7e4(0xd2),_0x3cea6d);}};node_cron_1['default'][a17_0x4d3938(0xa8)](a17_0x4d3938(0x97),enviarAgendamentosPendentes);