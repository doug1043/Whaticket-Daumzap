const a20_0x1287be=a20_0x55ad;(function(_0xfc8c8b,_0x3aeb7b){const _0x4a0519=a20_0x55ad,_0x21cf8a=_0xfc8c8b();while(!![]){try{const _0x40b8f4=parseInt(_0x4a0519(0x191))/0x1*(-parseInt(_0x4a0519(0x178))/0x2)+parseInt(_0x4a0519(0x164))/0x3*(parseInt(_0x4a0519(0x1a0))/0x4)+parseInt(_0x4a0519(0x177))/0x5*(parseInt(_0x4a0519(0x16a))/0x6)+-parseInt(_0x4a0519(0x16f))/0x7*(-parseInt(_0x4a0519(0x16d))/0x8)+parseInt(_0x4a0519(0x167))/0x9+-parseInt(_0x4a0519(0x198))/0xa*(-parseInt(_0x4a0519(0x170))/0xb)+-parseInt(_0x4a0519(0x181))/0xc*(parseInt(_0x4a0519(0x19f))/0xd);if(_0x40b8f4===_0x3aeb7b)break;else _0x21cf8a['push'](_0x21cf8a['shift']());}catch(_0xf0e328){_0x21cf8a['push'](_0x21cf8a['shift']());}}}(a20_0x578c,0x4ee95));const a20_0x26d222=(function(){let _0x5c02b2=!![];return function(_0x5620c8,_0x4a1c87){const _0x5ba949=_0x5c02b2?function(){const _0x55ca15=a20_0x55ad;if(_0x4a1c87){const _0x40cf72=_0x4a1c87[_0x55ca15(0x190)](_0x5620c8,arguments);return _0x4a1c87=null,_0x40cf72;}}:function(){};return _0x5c02b2=![],_0x5ba949;};}()),a20_0x8e7d44=a20_0x26d222(this,function(){const _0x216b84=a20_0x55ad;return a20_0x8e7d44['toString']()['search']('(((.+)+)+)+$')[_0x216b84(0x1a5)]()['constructor'](a20_0x8e7d44)[_0x216b84(0x18a)]('(((.+)+)+)+$');});a20_0x8e7d44();'use strict';function a20_0x578c(){const _0x1717f1=['46111oSCjnA','assunto','email','listarEmailsEnviados','__esModule','json','sender','10NZGsld','E-mail\x20agendado\x20enviado\x20com\x20sucesso\x20para:\x20','../services/EmailService/EmailService','lte','Erro\x20ao\x20listar\x20e-mails\x20enviados','printf','toDate','4043dWLmEe','2428LaaaJF','mensagem','Erro\x20ao\x20enviar\x20e-mail:','../models/Email','default','toString','Erro\x20ao\x20listar\x20e-mails\x20agendados',',\x20erro:\x20','2181KGpHAD','listarEmailsAgendados','createLogger','1600848xciRoB','Console','format','248298gAopGh','user','toISOString','717848QpfJxy','update','21rSQedX','6061121YWscgF','*/30\x20*\x20*\x20*\x20*\x20*','agendarEnvioEmail','enviarEmail','Erro\x20ao\x20listar\x20e-mails\x20enviados:','__importDefault','hour','40mjGGdq','18bThmSY','combine','timestamp','SendMail','sendAt','winston','E-mail\x20agendado\x20com\x20sucesso','create','E-mail\x20enviado\x20com\x20sucesso','39828KHnhJS','body','A\x20data\x20de\x20envio\x20deve\x20ser\x20no\x20futuro','info','Erro\x20ao\x20enviar\x20e-mail','schedule','Erro\x20ao\x20enviar\x20e-mail\x20agendado\x20para:\x20','findAll','Erro\x20ao\x20agendar\x20o\x20envio\x20de\x20e-mail','search','companyId','message','Erro\x20ao\x20enviar\x20agendamentos\x20pendentes:','error','status','apply'];a20_0x578c=function(){return _0x1717f1;};return a20_0x578c();}var __importDefault=this&&this[a20_0x1287be(0x175)]||function(_0x4578c0){const _0x4927f6=a20_0x1287be;return _0x4578c0&&_0x4578c0[_0x4927f6(0x195)]?_0x4578c0:{'default':_0x4578c0};};Object['defineProperty'](exports,a20_0x1287be(0x195),{'value':!![]}),exports[a20_0x1287be(0x172)]=exports[a20_0x1287be(0x165)]=exports[a20_0x1287be(0x194)]=exports['enviarEmail']=void 0x0;const EmailService_1=require(a20_0x1287be(0x19a)),Email_1=__importDefault(require(a20_0x1287be(0x1a3))),moment_1=__importDefault(require('moment')),node_cron_1=__importDefault(require('node-cron')),sequelize_1=require('sequelize'),winston_1=__importDefault(require(a20_0x1287be(0x17d))),logger=winston_1[a20_0x1287be(0x1a4)][a20_0x1287be(0x166)]({'level':a20_0x1287be(0x184),'format':winston_1[a20_0x1287be(0x1a4)][a20_0x1287be(0x169)][a20_0x1287be(0x179)](winston_1['default'][a20_0x1287be(0x169)][a20_0x1287be(0x17a)](),winston_1[a20_0x1287be(0x1a4)][a20_0x1287be(0x169)][a20_0x1287be(0x19d)](({timestamp:_0x1b6f39,level:_0xca85bd,message:_0x1e166a})=>{return _0x1b6f39+'\x20'+_0xca85bd+':\x20'+_0x1e166a;})),'transports':[new winston_1['default']['transports'][(a20_0x1287be(0x168))]()]}),enviarEmail=async(_0x1a12e0,_0x1062b4)=>{const _0x446ff7=a20_0x1287be;try{const _0x2f7ed=_0x1a12e0['user'][_0x446ff7(0x18b)],{email:_0x5d65e9,tokenSenha:_0x99e0a8,assunto:_0x4b413b,mensagem:_0x2b289b}=_0x1a12e0[_0x446ff7(0x182)],_0x2122f9=(0x0,moment_1['default'])()['add'](0x1,_0x446ff7(0x176))[_0x446ff7(0x169)]('YYYY-MM-DDTHH:mm'),_0x4d1f8b=await(0x0,EmailService_1[_0x446ff7(0x17b)])(_0x2f7ed,_0x5d65e9,_0x99e0a8,_0x4b413b,_0x2b289b,_0x2122f9);if(_0x4d1f8b[_0x446ff7(0x18e)])return _0x1062b4[_0x446ff7(0x18f)](0x1f4)[_0x446ff7(0x196)]({'error':_0x4d1f8b[_0x446ff7(0x18e)]});_0x1062b4[_0x446ff7(0x18f)](0xc8)['json']({'message':_0x446ff7(0x180)});}catch(_0x4eaad8){console[_0x446ff7(0x18e)](_0x446ff7(0x1a2),_0x4eaad8),_0x1062b4['status'](0x1f4)[_0x446ff7(0x196)]({'error':_0x446ff7(0x185)});}};exports[a20_0x1287be(0x173)]=enviarEmail;const listarEmailsEnviados=async(_0x3dfc43,_0x647fcf)=>{const _0x343556=a20_0x1287be;try{const _0x5f2515=await Email_1[_0x343556(0x1a4)][_0x343556(0x188)]({'where':{'companyId':_0x3dfc43[_0x343556(0x16b)][_0x343556(0x18b)],'scheduled':null,'sendAt':null}});_0x647fcf[_0x343556(0x18f)](0xc8)[_0x343556(0x196)](_0x5f2515);}catch(_0x3f8af7){console[_0x343556(0x18e)](_0x343556(0x174),_0x3f8af7),_0x647fcf[_0x343556(0x18f)](0x1f4)['json']({'error':_0x343556(0x19c)});}};exports[a20_0x1287be(0x194)]=listarEmailsEnviados;const listarEmailsAgendados=async(_0x54ff6b,_0x4532b1)=>{const _0x21a5a5=a20_0x1287be;try{const _0x2455dc=await Email_1['default'][_0x21a5a5(0x188)]({'where':{'companyId':_0x54ff6b[_0x21a5a5(0x16b)][_0x21a5a5(0x18b)],'scheduled':!![],'sendAt':{[sequelize_1['Op']['not']]:null}}});_0x4532b1[_0x21a5a5(0x18f)](0xc8)[_0x21a5a5(0x196)](_0x2455dc);}catch(_0x1741cc){console[_0x21a5a5(0x18e)]('Erro\x20ao\x20listar\x20e-mails\x20agendados:',_0x1741cc),_0x4532b1[_0x21a5a5(0x18f)](0x1f4)[_0x21a5a5(0x196)]({'error':_0x21a5a5(0x1a6)});}};exports[a20_0x1287be(0x165)]=listarEmailsAgendados;const agendarEnvioEmail=async(_0x35b06b,_0x1b5b57)=>{const _0x25bc3c=a20_0x1287be;try{const _0x173ea2=_0x35b06b[_0x25bc3c(0x16b)]['companyId'],{recipient:_0xd74ce3,subject:_0x5814cc,message:_0x41eb03,sendAt:_0x4a758c}=_0x35b06b['body'],_0xf8f2af=new Date(_0x4a758c);if(_0xf8f2af<=new Date())return _0x1b5b57['status'](0x190)[_0x25bc3c(0x196)]({'error':_0x25bc3c(0x183)});await Email_1[_0x25bc3c(0x1a4)][_0x25bc3c(0x17f)]({'sender':_0x35b06b['body'][_0x25bc3c(0x193)],'subject':_0x35b06b[_0x25bc3c(0x182)][_0x25bc3c(0x192)],'message':_0x35b06b[_0x25bc3c(0x182)][_0x25bc3c(0x1a1)],'companyId':_0x173ea2,'scheduled':!![],'sendAt':new Date(_0x4a758c)}),_0x1b5b57[_0x25bc3c(0x18f)](0xc8)['json']({'message':_0x25bc3c(0x17e)});}catch(_0x2f43da){console[_0x25bc3c(0x18e)]('Erro\x20ao\x20agendar\x20o\x20envio\x20de\x20e-mail:',_0x2f43da),_0x1b5b57[_0x25bc3c(0x18f)](0x1f4)[_0x25bc3c(0x196)]({'error':_0x25bc3c(0x189)});}};exports['agendarEnvioEmail']=agendarEnvioEmail;function a20_0x55ad(_0x42dc8a,_0x232385){const _0x4cb915=a20_0x578c();return a20_0x55ad=function(_0x8e7d44,_0x26d222){_0x8e7d44=_0x8e7d44-0x164;let _0x578cf6=_0x4cb915[_0x8e7d44];return _0x578cf6;},a20_0x55ad(_0x42dc8a,_0x232385);}const enviarAgendamentosPendentes=async()=>{const _0x2bff25=a20_0x1287be;try{const _0x3d40d7=(0x0,moment_1[_0x2bff25(0x1a4)])(),_0x108426=await Email_1[_0x2bff25(0x1a4)]['findAll']({'where':{'scheduled':!![],'sendAt':{[sequelize_1['Op'][_0x2bff25(0x19b)]]:_0x3d40d7[_0x2bff25(0x19e)]()}}});for(const _0x151e36 of _0x108426){const _0x4aa520=await(0x0,EmailService_1[_0x2bff25(0x17b)])(_0x151e36[_0x2bff25(0x18b)],_0x151e36[_0x2bff25(0x197)],'',_0x151e36['subject'],_0x151e36[_0x2bff25(0x18c)],_0x151e36[_0x2bff25(0x17c)][_0x2bff25(0x16c)](),'');!_0x4aa520['error']?(await _0x151e36[_0x2bff25(0x16e)]({'scheduled':![]}),logger[_0x2bff25(0x184)](_0x2bff25(0x199)+_0x151e36[_0x2bff25(0x197)])):logger[_0x2bff25(0x18e)](_0x2bff25(0x187)+_0x151e36[_0x2bff25(0x197)]+_0x2bff25(0x1a7)+_0x4aa520[_0x2bff25(0x18e)]);}}catch(_0x558ff2){logger['error'](_0x2bff25(0x18d),_0x558ff2);}};node_cron_1[a20_0x1287be(0x1a4)][a20_0x1287be(0x186)](a20_0x1287be(0x171),enviarAgendamentosPendentes);