const a17_0x1508ba=a17_0x2ac2;function a17_0x36c0(){const _0x153dd1=['9ONRwkt','schedule','status','Erro\x20ao\x20listar\x20e-mails\x20agendados','4tDNWHd','sendAt','E-mail\x20agendado\x20com\x20sucesso','YYYY-MM-DDTHH:mm','Console','sender','mensagem','3026721JMhhlU','json','winston','hour','info','__esModule','findAll','enviarEmail','2537542iwhHZH','createLogger','179084AlJBRh','timestamp','Erro\x20ao\x20listar\x20e-mails\x20enviados:','listarEmailsEnviados',',\x20erro:\x20','*/30\x20*\x20*\x20*\x20*\x20*','6692392WDfyGb','6AcXSGc','email','combine','user','body','companyId','Erro\x20ao\x20listar\x20e-mails\x20agendados:','SendMail','agendarEnvioEmail','Erro\x20ao\x20enviar\x20e-mail:','A\x20data\x20de\x20envio\x20deve\x20ser\x20no\x20futuro','2032224ZLspLL','lte','constructor','(((.+)+)+)+$','subject','listarEmailsAgendados','update','node-cron','1401840aSLoir','Erro\x20ao\x20listar\x20e-mails\x20enviados','transports','88NDAyuR','3133745vOzRTr','6FViTzk','toISOString','search','Erro\x20ao\x20enviar\x20agendamentos\x20pendentes:','not','toDate','E-mail\x20enviado\x20com\x20sucesso','error','format','defineProperty','E-mail\x20agendado\x20enviado\x20com\x20sucesso\x20para:\x20','create','Erro\x20ao\x20agendar\x20o\x20envio\x20de\x20e-mail','default'];a17_0x36c0=function(){return _0x153dd1;};return a17_0x36c0();}(function(_0xc509d9,_0x7f8f0e){const _0x42980b=a17_0x2ac2,_0x47fdf7=_0xc509d9();while(!![]){try{const _0x2049f0=parseInt(_0x42980b(0x13d))/0x1*(-parseInt(_0x42980b(0x136))/0x2)+-parseInt(_0x42980b(0x16e))/0x3+parseInt(_0x42980b(0x167))/0x4*(-parseInt(_0x42980b(0x154))/0x5)+-parseInt(_0x42980b(0x155))/0x6*(-parseInt(_0x42980b(0x176))/0x7)+-parseInt(_0x42980b(0x13c))/0x8*(-parseInt(_0x42980b(0x163))/0x9)+parseInt(_0x42980b(0x150))/0xa+parseInt(_0x42980b(0x153))/0xb*(parseInt(_0x42980b(0x148))/0xc);if(_0x2049f0===_0x7f8f0e)break;else _0x47fdf7['push'](_0x47fdf7['shift']());}catch(_0x2cd49c){_0x47fdf7['push'](_0x47fdf7['shift']());}}}(a17_0x36c0,0x7f3bb));const a17_0x487df9=(function(){let _0x3f006f=!![];return function(_0xec7bed,_0x1bff45){const _0x42b536=_0x3f006f?function(){if(_0x1bff45){const _0x2d0db9=_0x1bff45['apply'](_0xec7bed,arguments);return _0x1bff45=null,_0x2d0db9;}}:function(){};return _0x3f006f=![],_0x42b536;};}()),a17_0x200f78=a17_0x487df9(this,function(){const _0x188979=a17_0x2ac2;return a17_0x200f78['toString']()[_0x188979(0x157)](_0x188979(0x14b))['toString']()[_0x188979(0x14a)](a17_0x200f78)[_0x188979(0x157)](_0x188979(0x14b));});a17_0x200f78();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x3a63bb){const _0x5dbdf0=a17_0x2ac2;return _0x3a63bb&&_0x3a63bb[_0x5dbdf0(0x173)]?_0x3a63bb:{'default':_0x3a63bb};};Object[a17_0x1508ba(0x15e)](exports,a17_0x1508ba(0x173),{'value':!![]}),exports['agendarEnvioEmail']=exports['listarEmailsAgendados']=exports[a17_0x1508ba(0x139)]=exports[a17_0x1508ba(0x175)]=void 0x0;const EmailService_1=require('../services/EmailService/EmailService'),Email_1=__importDefault(require('../models/Email')),moment_1=__importDefault(require('moment')),node_cron_1=__importDefault(require(a17_0x1508ba(0x14f))),sequelize_1=require('sequelize'),winston_1=__importDefault(require(a17_0x1508ba(0x170))),logger=winston_1['default'][a17_0x1508ba(0x135)]({'level':'info','format':winston_1[a17_0x1508ba(0x162)][a17_0x1508ba(0x15d)][a17_0x1508ba(0x13f)](winston_1[a17_0x1508ba(0x162)][a17_0x1508ba(0x15d)][a17_0x1508ba(0x137)](),winston_1[a17_0x1508ba(0x162)][a17_0x1508ba(0x15d)]['printf'](({timestamp:_0x52eb5c,level:_0xa6eb78,message:_0x21cbce})=>{return _0x52eb5c+'\x20'+_0xa6eb78+':\x20'+_0x21cbce;})),'transports':[new winston_1[(a17_0x1508ba(0x162))][(a17_0x1508ba(0x152))][(a17_0x1508ba(0x16b))]()]}),enviarEmail=async(_0x16ab6b,_0x28e20c)=>{const _0x59f5d3=a17_0x1508ba;try{const _0x5b5e50=_0x16ab6b['user'][_0x59f5d3(0x142)],{email:_0x548e94,tokenSenha:_0x37271f,assunto:_0xe3b1d1,mensagem:_0x3dc004}=_0x16ab6b[_0x59f5d3(0x141)],_0x5df5c7=(0x0,moment_1[_0x59f5d3(0x162)])()['add'](0x1,_0x59f5d3(0x171))[_0x59f5d3(0x15d)](_0x59f5d3(0x16a)),_0x35a95f=await(0x0,EmailService_1[_0x59f5d3(0x144)])(_0x5b5e50,_0x548e94,_0x37271f,_0xe3b1d1,_0x3dc004,_0x5df5c7);if(_0x35a95f['error'])return _0x28e20c[_0x59f5d3(0x165)](0x1f4)[_0x59f5d3(0x16f)]({'error':_0x35a95f[_0x59f5d3(0x15c)]});_0x28e20c['status'](0xc8)[_0x59f5d3(0x16f)]({'message':_0x59f5d3(0x15b)});}catch(_0x34debb){console[_0x59f5d3(0x15c)](_0x59f5d3(0x146),_0x34debb),_0x28e20c['status'](0x1f4)[_0x59f5d3(0x16f)]({'error':'Erro\x20ao\x20enviar\x20e-mail'});}};exports[a17_0x1508ba(0x175)]=enviarEmail;const listarEmailsEnviados=async(_0x13f5a4,_0x48324f)=>{const _0x5248fa=a17_0x1508ba;try{const _0x16ddc9=await Email_1[_0x5248fa(0x162)][_0x5248fa(0x174)]({'where':{'companyId':_0x13f5a4['user']['companyId'],'scheduled':null,'sendAt':null}});_0x48324f['status'](0xc8)[_0x5248fa(0x16f)](_0x16ddc9);}catch(_0x2b04ca){console[_0x5248fa(0x15c)](_0x5248fa(0x138),_0x2b04ca),_0x48324f[_0x5248fa(0x165)](0x1f4)[_0x5248fa(0x16f)]({'error':_0x5248fa(0x151)});}};exports[a17_0x1508ba(0x139)]=listarEmailsEnviados;const listarEmailsAgendados=async(_0x367937,_0x25fdd9)=>{const _0x2de0ea=a17_0x1508ba;try{const _0x11c429=await Email_1['default'][_0x2de0ea(0x174)]({'where':{'companyId':_0x367937[_0x2de0ea(0x140)]['companyId'],'scheduled':!![],'sendAt':{[sequelize_1['Op'][_0x2de0ea(0x159)]]:null}}});_0x25fdd9['status'](0xc8)[_0x2de0ea(0x16f)](_0x11c429);}catch(_0x2edb1b){console[_0x2de0ea(0x15c)](_0x2de0ea(0x143),_0x2edb1b),_0x25fdd9['status'](0x1f4)[_0x2de0ea(0x16f)]({'error':_0x2de0ea(0x166)});}};exports[a17_0x1508ba(0x14d)]=listarEmailsAgendados;function a17_0x2ac2(_0x2769d6,_0x1a8033){const _0x52f1d3=a17_0x36c0();return a17_0x2ac2=function(_0x200f78,_0x487df9){_0x200f78=_0x200f78-0x135;let _0x36c0bc=_0x52f1d3[_0x200f78];return _0x36c0bc;},a17_0x2ac2(_0x2769d6,_0x1a8033);}const agendarEnvioEmail=async(_0x4343ed,_0x522470)=>{const _0x49522f=a17_0x1508ba;try{const _0x355f79=_0x4343ed['user'][_0x49522f(0x142)],{recipient:_0xcaf884,subject:_0x79b97a,message:_0x3d5710,sendAt:_0xa7e634}=_0x4343ed[_0x49522f(0x141)],_0x362476=new Date(_0xa7e634);if(_0x362476<=new Date())return _0x522470['status'](0x190)[_0x49522f(0x16f)]({'error':_0x49522f(0x147)});await Email_1[_0x49522f(0x162)][_0x49522f(0x160)]({'sender':_0x4343ed[_0x49522f(0x141)][_0x49522f(0x13e)],'subject':_0x4343ed['body']['assunto'],'message':_0x4343ed[_0x49522f(0x141)][_0x49522f(0x16d)],'companyId':_0x355f79,'scheduled':!![],'sendAt':new Date(_0xa7e634)}),_0x522470[_0x49522f(0x165)](0xc8)[_0x49522f(0x16f)]({'message':_0x49522f(0x169)});}catch(_0x36bc7b){console[_0x49522f(0x15c)]('Erro\x20ao\x20agendar\x20o\x20envio\x20de\x20e-mail:',_0x36bc7b),_0x522470['status'](0x1f4)[_0x49522f(0x16f)]({'error':_0x49522f(0x161)});}};exports[a17_0x1508ba(0x145)]=agendarEnvioEmail;const enviarAgendamentosPendentes=async()=>{const _0x391b4b=a17_0x1508ba;try{const _0x38ffd0=(0x0,moment_1[_0x391b4b(0x162)])(),_0x376910=await Email_1[_0x391b4b(0x162)][_0x391b4b(0x174)]({'where':{'scheduled':!![],'sendAt':{[sequelize_1['Op'][_0x391b4b(0x149)]]:_0x38ffd0[_0x391b4b(0x15a)]()}}});for(const _0x5aba7a of _0x376910){const _0x1b6db5=await(0x0,EmailService_1[_0x391b4b(0x144)])(_0x5aba7a[_0x391b4b(0x142)],_0x5aba7a[_0x391b4b(0x16c)],'',_0x5aba7a[_0x391b4b(0x14c)],_0x5aba7a['message'],_0x5aba7a[_0x391b4b(0x168)][_0x391b4b(0x156)](),'');!_0x1b6db5[_0x391b4b(0x15c)]?(await _0x5aba7a[_0x391b4b(0x14e)]({'scheduled':![]}),logger[_0x391b4b(0x172)](_0x391b4b(0x15f)+_0x5aba7a[_0x391b4b(0x16c)])):logger[_0x391b4b(0x15c)]('Erro\x20ao\x20enviar\x20e-mail\x20agendado\x20para:\x20'+_0x5aba7a[_0x391b4b(0x16c)]+_0x391b4b(0x13a)+_0x1b6db5[_0x391b4b(0x15c)]);}}catch(_0x350850){logger['error'](_0x391b4b(0x158),_0x350850);}};node_cron_1['default'][a17_0x1508ba(0x164)](a17_0x1508ba(0x13b),enviarAgendamentosPendentes);