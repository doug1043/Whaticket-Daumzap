const a18_0x3394d6=a18_0x344e;(function(_0x4d6fae,_0x45df36){const _0x5906a5=a18_0x344e,_0x867896=_0x4d6fae();while(!![]){try{const _0x11bc9f=parseInt(_0x5906a5(0x12e))/0x1+parseInt(_0x5906a5(0x128))/0x2+parseInt(_0x5906a5(0x158))/0x3+parseInt(_0x5906a5(0x135))/0x4*(-parseInt(_0x5906a5(0x137))/0x5)+-parseInt(_0x5906a5(0x13f))/0x6*(parseInt(_0x5906a5(0x14e))/0x7)+parseInt(_0x5906a5(0x12a))/0x8*(-parseInt(_0x5906a5(0x140))/0x9)+parseInt(_0x5906a5(0x151))/0xa;if(_0x11bc9f===_0x45df36)break;else _0x867896['push'](_0x867896['shift']());}catch(_0x136270){_0x867896['push'](_0x867896['shift']());}}}(a18_0x100d,0x1d3af));const a18_0x1af59b=(function(){let _0x5eb299=!![];return function(_0x529c47,_0x135453){const _0x58689b=_0x5eb299?function(){const _0x18224a=a18_0x344e;if(_0x135453){const _0x590f38=_0x135453[_0x18224a(0x154)](_0x529c47,arguments);return _0x135453=null,_0x590f38;}}:function(){};return _0x5eb299=![],_0x58689b;};}()),a18_0x2bdcd1=a18_0x1af59b(this,function(){const _0x2ae047=a18_0x344e;return a18_0x2bdcd1[_0x2ae047(0x127)]()[_0x2ae047(0x13e)]('(((.+)+)+)+$')[_0x2ae047(0x127)]()['constructor'](a18_0x2bdcd1)[_0x2ae047(0x13e)](_0x2ae047(0x159));});a18_0x2bdcd1();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x44be0a){const _0x1cf01e=a18_0x344e;return _0x44be0a&&_0x44be0a[_0x1cf01e(0x136)]?_0x44be0a:{'default':_0x44be0a};};Object[a18_0x3394d6(0x149)](exports,a18_0x3394d6(0x136),{'value':!![]}),exports[a18_0x3394d6(0x14b)]=exports[a18_0x3394d6(0x155)]=exports[a18_0x3394d6(0x157)]=exports['enviarEmail']=void 0x0;const EmailService_1=require(a18_0x3394d6(0x152)),Email_1=__importDefault(require('../models/Email')),moment_1=__importDefault(require('moment')),node_cron_1=__importDefault(require('node-cron')),sequelize_1=require('sequelize'),winston_1=__importDefault(require(a18_0x3394d6(0x139))),logger=winston_1[a18_0x3394d6(0x12f)][a18_0x3394d6(0x156)]({'level':a18_0x3394d6(0x133),'format':winston_1['default']['format'][a18_0x3394d6(0x143)](winston_1[a18_0x3394d6(0x12f)]['format'][a18_0x3394d6(0x11e)](),winston_1[a18_0x3394d6(0x12f)][a18_0x3394d6(0x15a)][a18_0x3394d6(0x14f)](({timestamp:_0x426e59,level:_0xb4126d,message:_0x1d4f59})=>{return _0x426e59+'\x20'+_0xb4126d+':\x20'+_0x1d4f59;})),'transports':[new winston_1['default']['transports']['Console']()]}),enviarEmail=async(_0x4e5c93,_0x1a0d0c)=>{const _0x425ac0=a18_0x3394d6;try{const _0x54e959=_0x4e5c93['user'][_0x425ac0(0x120)],{email:_0x65ff0,tokenSenha:_0x3987ce,assunto:_0x53012e,mensagem:_0x30fb02}=_0x4e5c93[_0x425ac0(0x14d)],_0x282de7=(0x0,moment_1[_0x425ac0(0x12f)])()[_0x425ac0(0x13a)](0x1,_0x425ac0(0x130))[_0x425ac0(0x15a)]('YYYY-MM-DDTHH:mm'),_0x474bbd=await(0x0,EmailService_1[_0x425ac0(0x141)])(_0x54e959,_0x65ff0,_0x3987ce,_0x53012e,_0x30fb02,_0x282de7);if(_0x474bbd[_0x425ac0(0x144)])return _0x1a0d0c[_0x425ac0(0x13c)](0x1f4)[_0x425ac0(0x125)]({'error':_0x474bbd[_0x425ac0(0x144)]});_0x1a0d0c['status'](0xc8)[_0x425ac0(0x125)]({'message':'E-mail\x20enviado\x20com\x20sucesso'});}catch(_0xaa6d74){console[_0x425ac0(0x144)](_0x425ac0(0x132),_0xaa6d74),_0x1a0d0c['status'](0x1f4)[_0x425ac0(0x125)]({'error':_0x425ac0(0x12c)});}};exports[a18_0x3394d6(0x142)]=enviarEmail;const listarEmailsEnviados=async(_0x309213,_0x1b19a9)=>{const _0x15a14b=a18_0x3394d6;try{const _0x54b9aa=await Email_1['default'][_0x15a14b(0x147)]({'where':{'companyId':_0x309213[_0x15a14b(0x14c)][_0x15a14b(0x120)],'scheduled':null,'sendAt':null}});_0x1b19a9['status'](0xc8)['json'](_0x54b9aa);}catch(_0x4bf997){console[_0x15a14b(0x144)](_0x15a14b(0x134),_0x4bf997),_0x1b19a9[_0x15a14b(0x13c)](0x1f4)[_0x15a14b(0x125)]({'error':_0x15a14b(0x131)});}};exports[a18_0x3394d6(0x157)]=listarEmailsEnviados;const listarEmailsAgendados=async(_0x43a4b2,_0x149d7d)=>{const _0x2e581c=a18_0x3394d6;try{const _0x3ef692=await Email_1[_0x2e581c(0x12f)][_0x2e581c(0x147)]({'where':{'companyId':_0x43a4b2[_0x2e581c(0x14c)][_0x2e581c(0x120)],'scheduled':!![],'sendAt':{[sequelize_1['Op'][_0x2e581c(0x124)]]:null}}});_0x149d7d[_0x2e581c(0x13c)](0xc8)[_0x2e581c(0x125)](_0x3ef692);}catch(_0x2e173c){console[_0x2e581c(0x144)](_0x2e581c(0x123),_0x2e173c),_0x149d7d[_0x2e581c(0x13c)](0x1f4)['json']({'error':_0x2e581c(0x150)});}};exports[a18_0x3394d6(0x155)]=listarEmailsAgendados;function a18_0x344e(_0x12cebd,_0x7e9dc8){const _0xb18e00=a18_0x100d();return a18_0x344e=function(_0x2bdcd1,_0x1af59b){_0x2bdcd1=_0x2bdcd1-0x11e;let _0x100d7f=_0xb18e00[_0x2bdcd1];return _0x100d7f;},a18_0x344e(_0x12cebd,_0x7e9dc8);}const agendarEnvioEmail=async(_0x26806c,_0x22c66a)=>{const _0xb2ead0=a18_0x3394d6;try{const _0x2f1d87=_0x26806c['user'][_0xb2ead0(0x120)],{recipient:_0xabb689,subject:_0x3ded5d,message:_0x33d1d6,sendAt:_0x5a804a}=_0x26806c[_0xb2ead0(0x14d)],_0x3f3cf9=new Date(_0x5a804a);if(_0x3f3cf9<=new Date())return _0x22c66a[_0xb2ead0(0x13c)](0x190)[_0xb2ead0(0x125)]({'error':_0xb2ead0(0x126)});await Email_1[_0xb2ead0(0x12f)][_0xb2ead0(0x13b)]({'sender':_0x26806c[_0xb2ead0(0x14d)][_0xb2ead0(0x12d)],'subject':_0x26806c[_0xb2ead0(0x14d)][_0xb2ead0(0x14a)],'message':_0x26806c[_0xb2ead0(0x14d)]['mensagem'],'companyId':_0x2f1d87,'scheduled':!![],'sendAt':new Date(_0x5a804a)}),_0x22c66a['status'](0xc8)[_0xb2ead0(0x125)]({'message':_0xb2ead0(0x146)});}catch(_0x3d5ba2){console[_0xb2ead0(0x144)]('Erro\x20ao\x20agendar\x20o\x20envio\x20de\x20e-mail:',_0x3d5ba2),_0x22c66a[_0xb2ead0(0x13c)](0x1f4)['json']({'error':_0xb2ead0(0x121)});}};exports[a18_0x3394d6(0x14b)]=agendarEnvioEmail;const enviarAgendamentosPendentes=async()=>{const _0x481e66=a18_0x3394d6;try{const _0x51049a=(0x0,moment_1['default'])(),_0x2b1ad7=await Email_1['default'][_0x481e66(0x147)]({'where':{'scheduled':!![],'sendAt':{[sequelize_1['Op']['lte']]:_0x51049a['toDate']()}}});for(const _0x494063 of _0x2b1ad7){const _0x366a69=await(0x0,EmailService_1['SendMail'])(_0x494063[_0x481e66(0x120)],_0x494063[_0x481e66(0x138)],'',_0x494063[_0x481e66(0x148)],_0x494063[_0x481e66(0x12b)],_0x494063[_0x481e66(0x13d)][_0x481e66(0x11f)](),'');!_0x366a69[_0x481e66(0x144)]?(await _0x494063[_0x481e66(0x122)]({'scheduled':![]}),logger['info']('E-mail\x20agendado\x20enviado\x20com\x20sucesso\x20para:\x20'+_0x494063[_0x481e66(0x138)])):logger['error']('Erro\x20ao\x20enviar\x20e-mail\x20agendado\x20para:\x20'+_0x494063[_0x481e66(0x138)]+_0x481e66(0x153)+_0x366a69['error']);}}catch(_0x5cc84e){logger[_0x481e66(0x144)](_0x481e66(0x129),_0x5cc84e);}};function a18_0x100d(){const _0x11102f=['579906qMvyOW','(((.+)+)+)+$','format','timestamp','toISOString','companyId','Erro\x20ao\x20agendar\x20o\x20envio\x20de\x20e-mail','update','Erro\x20ao\x20listar\x20e-mails\x20agendados:','not','json','A\x20data\x20de\x20envio\x20deve\x20ser\x20no\x20futuro','toString','472856NgbhJv','Erro\x20ao\x20enviar\x20agendamentos\x20pendentes:','2416MeZzNC','message','Erro\x20ao\x20enviar\x20e-mail','email','12362SnCFXu','default','hour','Erro\x20ao\x20listar\x20e-mails\x20enviados','Erro\x20ao\x20enviar\x20e-mail:','info','Erro\x20ao\x20listar\x20e-mails\x20enviados:','40972LXyBJv','__esModule','45OesJyr','sender','winston','add','create','status','sendAt','search','102246RughuE','6471mvGhbY','SendMail','enviarEmail','combine','error','*/30\x20*\x20*\x20*\x20*\x20*','E-mail\x20agendado\x20com\x20sucesso','findAll','subject','defineProperty','assunto','agendarEnvioEmail','user','body','91Vwxynx','printf','Erro\x20ao\x20listar\x20e-mails\x20agendados','2084930uUsQlc','../services/EmailService/EmailService',',\x20erro:\x20','apply','listarEmailsAgendados','createLogger','listarEmailsEnviados'];a18_0x100d=function(){return _0x11102f;};return a18_0x100d();}node_cron_1[a18_0x3394d6(0x12f)]['schedule'](a18_0x3394d6(0x145),enviarAgendamentosPendentes);