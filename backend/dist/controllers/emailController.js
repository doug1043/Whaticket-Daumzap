const a17_0x178a2a=a17_0x2602;(function(_0x11d7ba,_0x109e2d){const _0x475740=a17_0x2602,_0x185190=_0x11d7ba();while(!![]){try{const _0x5d9cc6=parseInt(_0x475740(0x8f))/0x1*(parseInt(_0x475740(0xab))/0x2)+parseInt(_0x475740(0x94))/0x3+-parseInt(_0x475740(0xa3))/0x4+-parseInt(_0x475740(0xa2))/0x5+-parseInt(_0x475740(0x7d))/0x6+parseInt(_0x475740(0x84))/0x7*(parseInt(_0x475740(0x7a))/0x8)+parseInt(_0x475740(0x8b))/0x9;if(_0x5d9cc6===_0x109e2d)break;else _0x185190['push'](_0x185190['shift']());}catch(_0x3dab2f){_0x185190['push'](_0x185190['shift']());}}}(a17_0x4769,0xca6a9));const a17_0x36b7bb=(function(){let _0x2d56a5=!![];return function(_0xe53936,_0x3336b9){const _0x12884f=_0x2d56a5?function(){const _0x361e98=a17_0x2602;if(_0x3336b9){const _0x442d63=_0x3336b9[_0x361e98(0xb4)](_0xe53936,arguments);return _0x3336b9=null,_0x442d63;}}:function(){};return _0x2d56a5=![],_0x12884f;};}()),a17_0x53b817=a17_0x36b7bb(this,function(){const _0x16019f=a17_0x2602;return a17_0x53b817[_0x16019f(0x9b)]()[_0x16019f(0x8a)](_0x16019f(0x7b))[_0x16019f(0x9b)]()['constructor'](a17_0x53b817)['search'](_0x16019f(0x7b));});a17_0x53b817();'use strict';var __importDefault=this&&this[a17_0x178a2a(0xaf)]||function(_0x1baa57){const _0x221c46=a17_0x178a2a;return _0x1baa57&&_0x1baa57[_0x221c46(0x89)]?_0x1baa57:{'default':_0x1baa57};};Object[a17_0x178a2a(0x7c)](exports,a17_0x178a2a(0x89),{'value':!![]}),exports[a17_0x178a2a(0x92)]=exports[a17_0x178a2a(0x96)]=exports[a17_0x178a2a(0x86)]=exports[a17_0x178a2a(0x8d)]=void 0x0;function a17_0x4769(){const _0x1bf0d3=['Erro\x20ao\x20enviar\x20agendamentos\x20pendentes:','49478dcXCqC','Erro\x20ao\x20enviar\x20e-mail:','lte','E-mail\x20agendado\x20enviado\x20com\x20sucesso\x20para:\x20','__importDefault','user','SendMail','Erro\x20ao\x20agendar\x20o\x20envio\x20de\x20e-mail:','A\x20data\x20de\x20envio\x20deve\x20ser\x20no\x20futuro','apply','moment','Erro\x20ao\x20listar\x20e-mails\x20enviados:','createLogger','Erro\x20ao\x20agendar\x20o\x20envio\x20de\x20e-mail','Erro\x20ao\x20listar\x20e-mails\x20agendados','24CTZPar','(((.+)+)+)+$','defineProperty','7366542dFKNPa','printf','sequelize','toISOString','message','Erro\x20ao\x20enviar\x20e-mail','email','3118423AuKdhJ','error','listarEmailsEnviados',',\x20erro:\x20','Erro\x20ao\x20enviar\x20e-mail\x20agendado\x20para:\x20','__esModule','search','18710424lfqUlz','body','enviarEmail','combine','1zFSAvV','add','../models/Email','agendarEnvioEmail','subject','2962728cMRqfR','default','listarEmailsAgendados','mensagem','status','format','../services/EmailService/EmailService','toString','node-cron','companyId','json','sendAt','sender','info','3808480kVAqcA','6436672csQGRM','update','winston','findAll','create','hour','transports'];a17_0x4769=function(){return _0x1bf0d3;};return a17_0x4769();}function a17_0x2602(_0x433126,_0x17490b){const _0x3df129=a17_0x4769();return a17_0x2602=function(_0x53b817,_0x36b7bb){_0x53b817=_0x53b817-0x76;let _0x4769c7=_0x3df129[_0x53b817];return _0x4769c7;},a17_0x2602(_0x433126,_0x17490b);}const EmailService_1=require(a17_0x178a2a(0x9a)),Email_1=__importDefault(require(a17_0x178a2a(0x91))),moment_1=__importDefault(require(a17_0x178a2a(0xb5))),node_cron_1=__importDefault(require(a17_0x178a2a(0x9c))),sequelize_1=require(a17_0x178a2a(0x7f)),winston_1=__importDefault(require(a17_0x178a2a(0xa5))),logger=winston_1[a17_0x178a2a(0x95)][a17_0x178a2a(0x77)]({'level':a17_0x178a2a(0xa1),'format':winston_1['default'][a17_0x178a2a(0x99)][a17_0x178a2a(0x8e)](winston_1[a17_0x178a2a(0x95)][a17_0x178a2a(0x99)]['timestamp'](),winston_1[a17_0x178a2a(0x95)][a17_0x178a2a(0x99)][a17_0x178a2a(0x7e)](({timestamp:_0x16bbc1,level:_0x2e5454,message:_0x43b665})=>{return _0x16bbc1+'\x20'+_0x2e5454+':\x20'+_0x43b665;})),'transports':[new winston_1[(a17_0x178a2a(0x95))][(a17_0x178a2a(0xa9))]['Console']()]}),enviarEmail=async(_0x553f4d,_0x5cc991)=>{const _0x10ab29=a17_0x178a2a;try{const _0x48eaf7=_0x553f4d[_0x10ab29(0xb0)][_0x10ab29(0x9d)],{email:_0x2ffe17,tokenSenha:_0x539a29,assunto:_0x3e8a7d,mensagem:_0x16739a}=_0x553f4d[_0x10ab29(0x8c)],_0x4edc07=(0x0,moment_1[_0x10ab29(0x95)])()[_0x10ab29(0x90)](0x1,_0x10ab29(0xa8))[_0x10ab29(0x99)]('YYYY-MM-DDTHH:mm'),_0x327b72=await(0x0,EmailService_1[_0x10ab29(0xb1)])(_0x48eaf7,_0x2ffe17,_0x539a29,_0x3e8a7d,_0x16739a,_0x4edc07);if(_0x327b72[_0x10ab29(0x85)])return _0x5cc991['status'](0x1f4)[_0x10ab29(0x9e)]({'error':_0x327b72[_0x10ab29(0x85)]});_0x5cc991['status'](0xc8)[_0x10ab29(0x9e)]({'message':'E-mail\x20enviado\x20com\x20sucesso'});}catch(_0x5947b1){console[_0x10ab29(0x85)](_0x10ab29(0xac),_0x5947b1),_0x5cc991[_0x10ab29(0x98)](0x1f4)[_0x10ab29(0x9e)]({'error':_0x10ab29(0x82)});}};exports[a17_0x178a2a(0x8d)]=enviarEmail;const listarEmailsEnviados=async(_0x466c92,_0x2a9b91)=>{const _0x4759e6=a17_0x178a2a;try{const _0x11bf39=await Email_1[_0x4759e6(0x95)][_0x4759e6(0xa6)]({'where':{'companyId':_0x466c92[_0x4759e6(0xb0)]['companyId'],'scheduled':null,'sendAt':null}});_0x2a9b91[_0x4759e6(0x98)](0xc8)[_0x4759e6(0x9e)](_0x11bf39);}catch(_0x58d1e2){console[_0x4759e6(0x85)](_0x4759e6(0x76),_0x58d1e2),_0x2a9b91['status'](0x1f4)[_0x4759e6(0x9e)]({'error':'Erro\x20ao\x20listar\x20e-mails\x20enviados'});}};exports[a17_0x178a2a(0x86)]=listarEmailsEnviados;const listarEmailsAgendados=async(_0x37a301,_0x2cf45a)=>{const _0x39fdfa=a17_0x178a2a;try{const _0x1abccb=await Email_1['default'][_0x39fdfa(0xa6)]({'where':{'companyId':_0x37a301['user'][_0x39fdfa(0x9d)],'scheduled':!![],'sendAt':{[sequelize_1['Op']['not']]:null}}});_0x2cf45a[_0x39fdfa(0x98)](0xc8)['json'](_0x1abccb);}catch(_0x75f2a4){console[_0x39fdfa(0x85)]('Erro\x20ao\x20listar\x20e-mails\x20agendados:',_0x75f2a4),_0x2cf45a[_0x39fdfa(0x98)](0x1f4)[_0x39fdfa(0x9e)]({'error':_0x39fdfa(0x79)});}};exports[a17_0x178a2a(0x96)]=listarEmailsAgendados;const agendarEnvioEmail=async(_0xc06de6,_0x5cd179)=>{const _0x31e5a1=a17_0x178a2a;try{const _0x50939d=_0xc06de6['user']['companyId'],{recipient:_0x53416c,subject:_0x2a5883,message:_0x3d8e1c,sendAt:_0x1cf10d}=_0xc06de6[_0x31e5a1(0x8c)],_0x1f9fa0=new Date(_0x1cf10d);if(_0x1f9fa0<=new Date())return _0x5cd179[_0x31e5a1(0x98)](0x190)[_0x31e5a1(0x9e)]({'error':_0x31e5a1(0xb3)});await Email_1[_0x31e5a1(0x95)][_0x31e5a1(0xa7)]({'sender':_0xc06de6['body'][_0x31e5a1(0x83)],'subject':_0xc06de6[_0x31e5a1(0x8c)]['assunto'],'message':_0xc06de6[_0x31e5a1(0x8c)][_0x31e5a1(0x97)],'companyId':_0x50939d,'scheduled':!![],'sendAt':new Date(_0x1cf10d)}),_0x5cd179[_0x31e5a1(0x98)](0xc8)['json']({'message':'E-mail\x20agendado\x20com\x20sucesso'});}catch(_0x54a1bb){console[_0x31e5a1(0x85)](_0x31e5a1(0xb2),_0x54a1bb),_0x5cd179['status'](0x1f4)[_0x31e5a1(0x9e)]({'error':_0x31e5a1(0x78)});}};exports[a17_0x178a2a(0x92)]=agendarEnvioEmail;const enviarAgendamentosPendentes=async()=>{const _0x52599a=a17_0x178a2a;try{const _0x1c8628=(0x0,moment_1['default'])(),_0x2a3a49=await Email_1[_0x52599a(0x95)][_0x52599a(0xa6)]({'where':{'scheduled':!![],'sendAt':{[sequelize_1['Op'][_0x52599a(0xad)]]:_0x1c8628['toDate']()}}});for(const _0x13959e of _0x2a3a49){const _0x4402ec=await(0x0,EmailService_1[_0x52599a(0xb1)])(_0x13959e[_0x52599a(0x9d)],_0x13959e[_0x52599a(0xa0)],'',_0x13959e[_0x52599a(0x93)],_0x13959e[_0x52599a(0x81)],_0x13959e[_0x52599a(0x9f)][_0x52599a(0x80)](),'');!_0x4402ec[_0x52599a(0x85)]?(await _0x13959e[_0x52599a(0xa4)]({'scheduled':![]}),logger[_0x52599a(0xa1)](_0x52599a(0xae)+_0x13959e['sender'])):logger[_0x52599a(0x85)](_0x52599a(0x88)+_0x13959e[_0x52599a(0xa0)]+_0x52599a(0x87)+_0x4402ec[_0x52599a(0x85)]);}}catch(_0x35d004){logger[_0x52599a(0x85)](_0x52599a(0xaa),_0x35d004);}};node_cron_1[a17_0x178a2a(0x95)]['schedule']('*/30\x20*\x20*\x20*\x20*\x20*',enviarAgendamentosPendentes);