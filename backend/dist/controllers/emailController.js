const a20_0x11b5a9=a20_0x1eec;(function(_0x4e73d0,_0x1a7739){const _0x56241d=a20_0x1eec,_0x29f6cb=_0x4e73d0();while(!![]){try{const _0x4703b1=-parseInt(_0x56241d(0xf5))/0x1+parseInt(_0x56241d(0xf4))/0x2*(-parseInt(_0x56241d(0x105))/0x3)+-parseInt(_0x56241d(0xeb))/0x4*(parseInt(_0x56241d(0x110))/0x5)+parseInt(_0x56241d(0xec))/0x6*(-parseInt(_0x56241d(0x101))/0x7)+parseInt(_0x56241d(0xfa))/0x8*(-parseInt(_0x56241d(0x104))/0x9)+parseInt(_0x56241d(0x108))/0xa+parseInt(_0x56241d(0x10d))/0xb;if(_0x4703b1===_0x1a7739)break;else _0x29f6cb['push'](_0x29f6cb['shift']());}catch(_0x24a722){_0x29f6cb['push'](_0x29f6cb['shift']());}}}(a20_0x14b1,0x72bfe));const a20_0x5b8b1e=(function(){let _0xf10884=!![];return function(_0x43224e,_0x24c588){const _0x41d0f2=_0xf10884?function(){const _0x4fe491=a20_0x1eec;if(_0x24c588){const _0x2924a1=_0x24c588[_0x4fe491(0x115)](_0x43224e,arguments);return _0x24c588=null,_0x2924a1;}}:function(){};return _0xf10884=![],_0x41d0f2;};}()),a20_0x20f295=a20_0x5b8b1e(this,function(){const _0x146455=a20_0x1eec;return a20_0x20f295[_0x146455(0xe4)]()['search'](_0x146455(0xe8))[_0x146455(0xe4)]()['constructor'](a20_0x20f295)[_0x146455(0x120)](_0x146455(0xe8));});a20_0x20f295();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x56979e){const _0x16e916=a20_0x1eec;return _0x56979e&&_0x56979e[_0x16e916(0xf6)]?_0x56979e:{'default':_0x56979e};};Object['defineProperty'](exports,a20_0x11b5a9(0xf6),{'value':!![]}),exports['agendarEnvioEmail']=exports[a20_0x11b5a9(0xe6)]=exports[a20_0x11b5a9(0x10c)]=exports[a20_0x11b5a9(0xf3)]=void 0x0;const EmailService_1=require('../services/EmailService/EmailService'),Email_1=__importDefault(require(a20_0x11b5a9(0x117))),moment_1=__importDefault(require(a20_0x11b5a9(0xea))),node_cron_1=__importDefault(require(a20_0x11b5a9(0xff))),sequelize_1=require('sequelize'),winston_1=__importDefault(require(a20_0x11b5a9(0xe2))),logger=winston_1[a20_0x11b5a9(0x119)][a20_0x11b5a9(0x114)]({'level':'info','format':winston_1[a20_0x11b5a9(0x119)][a20_0x11b5a9(0x112)][a20_0x11b5a9(0x11d)](winston_1['default'][a20_0x11b5a9(0x112)]['timestamp'](),winston_1[a20_0x11b5a9(0x119)][a20_0x11b5a9(0x112)][a20_0x11b5a9(0xf2)](({timestamp:_0x20cb3b,level:_0x1daec1,message:_0x55ac65})=>{return _0x20cb3b+'\x20'+_0x1daec1+':\x20'+_0x55ac65;})),'transports':[new winston_1['default'][(a20_0x11b5a9(0xe9))][(a20_0x11b5a9(0xfc))]()]}),enviarEmail=async(_0x4818ba,_0x51c39e)=>{const _0x1e10a9=a20_0x11b5a9;try{const _0x1f6954=_0x4818ba['user']['companyId'],{email:_0x597a1,tokenSenha:_0x20bf36,assunto:_0x340b86,mensagem:_0x6f6fd7}=_0x4818ba[_0x1e10a9(0x100)],_0x5b004a=(0x0,moment_1[_0x1e10a9(0x119)])()[_0x1e10a9(0x109)](0x1,_0x1e10a9(0xe0))[_0x1e10a9(0x112)]('YYYY-MM-DDTHH:mm'),_0x9d6a48=await(0x0,EmailService_1[_0x1e10a9(0x118)])(_0x1f6954,_0x597a1,_0x20bf36,_0x340b86,_0x6f6fd7,_0x5b004a);if(_0x9d6a48[_0x1e10a9(0x113)])return _0x51c39e['status'](0x1f4)['json']({'error':_0x9d6a48[_0x1e10a9(0x113)]});_0x51c39e[_0x1e10a9(0x107)](0xc8)[_0x1e10a9(0x10a)]({'message':_0x1e10a9(0x102)});}catch(_0x3bf6c1){console[_0x1e10a9(0x113)]('Erro\x20ao\x20enviar\x20e-mail:',_0x3bf6c1),_0x51c39e[_0x1e10a9(0x107)](0x1f4)[_0x1e10a9(0x10a)]({'error':'Erro\x20ao\x20enviar\x20e-mail'});}};exports[a20_0x11b5a9(0xf3)]=enviarEmail;const listarEmailsEnviados=async(_0x43a625,_0x464520)=>{const _0x1129b7=a20_0x11b5a9;try{const _0x44ade9=await Email_1[_0x1129b7(0x119)][_0x1129b7(0xe7)]({'where':{'companyId':_0x43a625[_0x1129b7(0xfb)]['companyId'],'scheduled':null,'sendAt':null}});_0x464520[_0x1129b7(0x107)](0xc8)[_0x1129b7(0x10a)](_0x44ade9);}catch(_0x357eb5){console[_0x1129b7(0x113)](_0x1129b7(0xe5),_0x357eb5),_0x464520[_0x1129b7(0x107)](0x1f4)['json']({'error':'Erro\x20ao\x20listar\x20e-mails\x20enviados'});}};exports[a20_0x11b5a9(0x10c)]=listarEmailsEnviados;const listarEmailsAgendados=async(_0x45d320,_0x212d05)=>{const _0x35aa61=a20_0x11b5a9;try{const _0x305e10=await Email_1[_0x35aa61(0x119)][_0x35aa61(0xe7)]({'where':{'companyId':_0x45d320['user'][_0x35aa61(0xf7)],'scheduled':!![],'sendAt':{[sequelize_1['Op']['not']]:null}}});_0x212d05['status'](0xc8)[_0x35aa61(0x10a)](_0x305e10);}catch(_0x3ad62f){console[_0x35aa61(0x113)](_0x35aa61(0x11e),_0x3ad62f),_0x212d05[_0x35aa61(0x107)](0x1f4)[_0x35aa61(0x10a)]({'error':_0x35aa61(0xe3)});}};exports[a20_0x11b5a9(0xe6)]=listarEmailsAgendados;const agendarEnvioEmail=async(_0x23fdd7,_0x5a6673)=>{const _0x566eb6=a20_0x11b5a9;try{const _0x3c8005=_0x23fdd7['user'][_0x566eb6(0xf7)],{recipient:_0x507573,subject:_0x5ec89a,message:_0x44f8a6,sendAt:_0x59f873}=_0x23fdd7[_0x566eb6(0x100)],_0x29ef36=new Date(_0x59f873);if(_0x29ef36<=new Date())return _0x5a6673[_0x566eb6(0x107)](0x190)['json']({'error':_0x566eb6(0xf8)});await Email_1[_0x566eb6(0x119)][_0x566eb6(0xee)]({'sender':_0x23fdd7[_0x566eb6(0x100)][_0x566eb6(0x11c)],'subject':_0x23fdd7[_0x566eb6(0x100)][_0x566eb6(0x11a)],'message':_0x23fdd7['body'][_0x566eb6(0x11b)],'companyId':_0x3c8005,'scheduled':!![],'sendAt':new Date(_0x59f873)}),_0x5a6673['status'](0xc8)[_0x566eb6(0x10a)]({'message':_0x566eb6(0xf0)});}catch(_0x3d7b90){console[_0x566eb6(0x113)](_0x566eb6(0x111),_0x3d7b90),_0x5a6673[_0x566eb6(0x107)](0x1f4)[_0x566eb6(0x10a)]({'error':'Erro\x20ao\x20agendar\x20o\x20envio\x20de\x20e-mail'});}};function a20_0x1eec(_0x3c15f1,_0x36af96){const _0x5abef9=a20_0x14b1();return a20_0x1eec=function(_0x20f295,_0x5b8b1e){_0x20f295=_0x20f295-0xe0;let _0x14b1aa=_0x5abef9[_0x20f295];return _0x14b1aa;},a20_0x1eec(_0x3c15f1,_0x36af96);}function a20_0x14b1(){const _0x2a9a41=['schedule','../models/Email','SendMail','default','assunto','mensagem','email','combine','Erro\x20ao\x20listar\x20e-mails\x20agendados:',',\x20erro:\x20','search','hour','toDate','winston','Erro\x20ao\x20listar\x20e-mails\x20agendados','toString','Erro\x20ao\x20listar\x20e-mails\x20enviados:','listarEmailsAgendados','findAll','(((.+)+)+)+$','transports','moment','6496kaCwSI','534pciQct','*/30\x20*\x20*\x20*\x20*\x20*','create','message','E-mail\x20agendado\x20com\x20sucesso','update','printf','enviarEmail','2JaPpQM','900730bvYeIZ','__esModule','companyId','A\x20data\x20de\x20envio\x20deve\x20ser\x20no\x20futuro','lte','194304wWdnYd','user','Console','Erro\x20ao\x20enviar\x20agendamentos\x20pendentes:','sendAt','node-cron','body','1799fbQXOe','E-mail\x20enviado\x20com\x20sucesso','agendarEnvioEmail','81yXwuEu','1873623HrIrMn','toISOString','status','1665420SMTkhw','add','json','sender','listarEmailsEnviados','33097680bjcskU','Erro\x20ao\x20enviar\x20e-mail\x20agendado\x20para:\x20','info','2890aMOYik','Erro\x20ao\x20agendar\x20o\x20envio\x20de\x20e-mail:','format','error','createLogger','apply'];a20_0x14b1=function(){return _0x2a9a41;};return a20_0x14b1();}exports[a20_0x11b5a9(0x103)]=agendarEnvioEmail;const enviarAgendamentosPendentes=async()=>{const _0x5cb614=a20_0x11b5a9;try{const _0x208176=(0x0,moment_1[_0x5cb614(0x119)])(),_0x266df0=await Email_1[_0x5cb614(0x119)][_0x5cb614(0xe7)]({'where':{'scheduled':!![],'sendAt':{[sequelize_1['Op'][_0x5cb614(0xf9)]]:_0x208176[_0x5cb614(0xe1)]()}}});for(const _0x331bd6 of _0x266df0){const _0x5cbd4e=await(0x0,EmailService_1[_0x5cb614(0x118)])(_0x331bd6[_0x5cb614(0xf7)],_0x331bd6[_0x5cb614(0x10b)],'',_0x331bd6['subject'],_0x331bd6[_0x5cb614(0xef)],_0x331bd6[_0x5cb614(0xfe)][_0x5cb614(0x106)](),'');!_0x5cbd4e['error']?(await _0x331bd6[_0x5cb614(0xf1)]({'scheduled':![]}),logger[_0x5cb614(0x10f)]('E-mail\x20agendado\x20enviado\x20com\x20sucesso\x20para:\x20'+_0x331bd6['sender'])):logger['error'](_0x5cb614(0x10e)+_0x331bd6[_0x5cb614(0x10b)]+_0x5cb614(0x11f)+_0x5cbd4e[_0x5cb614(0x113)]);}}catch(_0x4a4322){logger[_0x5cb614(0x113)](_0x5cb614(0xfd),_0x4a4322);}};node_cron_1[a20_0x11b5a9(0x119)][a20_0x11b5a9(0x116)](a20_0x11b5a9(0xed),enviarAgendamentosPendentes);