const a18_0x131f6c=a18_0x5ddf;(function(_0x479a17,_0x38105e){const _0x35183a=a18_0x5ddf,_0x573e92=_0x479a17();while(!![]){try{const _0xb75a56=-parseInt(_0x35183a(0x1ff))/0x1+parseInt(_0x35183a(0x1e8))/0x2+-parseInt(_0x35183a(0x1fd))/0x3+-parseInt(_0x35183a(0x207))/0x4+parseInt(_0x35183a(0x1e4))/0x5+parseInt(_0x35183a(0x1e5))/0x6*(-parseInt(_0x35183a(0x1eb))/0x7)+parseInt(_0x35183a(0x1e6))/0x8*(parseInt(_0x35183a(0x209))/0x9);if(_0xb75a56===_0x38105e)break;else _0x573e92['push'](_0x573e92['shift']());}catch(_0x1cf2d9){_0x573e92['push'](_0x573e92['shift']());}}}(a18_0x2368,0xd91c1));const a18_0x160dc8=(function(){let _0x3c7975=!![];return function(_0x2c81df,_0x49b33b){const _0x5b55d6=_0x3c7975?function(){const _0x20bea7=a18_0x5ddf;if(_0x49b33b){const _0x454b2f=_0x49b33b[_0x20bea7(0x1d3)](_0x2c81df,arguments);return _0x49b33b=null,_0x454b2f;}}:function(){};return _0x3c7975=![],_0x5b55d6;};}()),a18_0x3c31b2=a18_0x160dc8(this,function(){const _0x4c3f6a=a18_0x5ddf;return a18_0x3c31b2[_0x4c3f6a(0x201)]()[_0x4c3f6a(0x1d6)](_0x4c3f6a(0x1f0))[_0x4c3f6a(0x201)]()['constructor'](a18_0x3c31b2)[_0x4c3f6a(0x1d6)](_0x4c3f6a(0x1f0));});a18_0x3c31b2();'use strict';var __importDefault=this&&this[a18_0x131f6c(0x1d2)]||function(_0xebc311){const _0x401dec=a18_0x131f6c;return _0xebc311&&_0xebc311[_0x401dec(0x203)]?_0xebc311:{'default':_0xebc311};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['agendarEnvioEmail']=exports[a18_0x131f6c(0x1d1)]=exports[a18_0x131f6c(0x1f2)]=exports['enviarEmail']=void 0x0;function a18_0x5ddf(_0x5894e2,_0x3567c1){const _0x1baa1e=a18_0x2368();return a18_0x5ddf=function(_0x3c31b2,_0x160dc8){_0x3c31b2=_0x3c31b2-0x1ce;let _0x23684f=_0x1baa1e[_0x3c31b2];return _0x23684f;},a18_0x5ddf(_0x5894e2,_0x3567c1);}const EmailService_1=require(a18_0x131f6c(0x1f7)),Email_1=__importDefault(require(a18_0x131f6c(0x1cf))),moment_1=__importDefault(require(a18_0x131f6c(0x1d0))),node_cron_1=__importDefault(require(a18_0x131f6c(0x1e3))),sequelize_1=require('sequelize'),winston_1=__importDefault(require(a18_0x131f6c(0x1da))),logger=winston_1[a18_0x131f6c(0x204)][a18_0x131f6c(0x1db)]({'level':a18_0x131f6c(0x202),'format':winston_1[a18_0x131f6c(0x204)][a18_0x131f6c(0x1ea)][a18_0x131f6c(0x1fa)](winston_1['default'][a18_0x131f6c(0x1ea)][a18_0x131f6c(0x206)](),winston_1[a18_0x131f6c(0x204)][a18_0x131f6c(0x1ea)][a18_0x131f6c(0x1ee)](({timestamp:_0x238277,level:_0x282d4e,message:_0x4f9c3a})=>{return _0x238277+'\x20'+_0x282d4e+':\x20'+_0x4f9c3a;})),'transports':[new winston_1['default'][(a18_0x131f6c(0x1d9))][(a18_0x131f6c(0x1f5))]()]}),enviarEmail=async(_0x5ed146,_0x439165)=>{const _0x297354=a18_0x131f6c;try{const _0x519615=_0x5ed146[_0x297354(0x1ec)][_0x297354(0x200)],{email:_0x3b03c1,tokenSenha:_0xde5765,assunto:_0x26046b,mensagem:_0x5bd091}=_0x5ed146[_0x297354(0x1ce)],_0x61c816=(0x0,moment_1['default'])()[_0x297354(0x1e7)](0x1,_0x297354(0x1df))[_0x297354(0x1ea)](_0x297354(0x1e0)),_0x109d41=await(0x0,EmailService_1[_0x297354(0x1d4)])(_0x519615,_0x3b03c1,_0xde5765,_0x26046b,_0x5bd091,_0x61c816);if(_0x109d41[_0x297354(0x1f8)])return _0x439165['status'](0x1f4)[_0x297354(0x1dc)]({'error':_0x109d41[_0x297354(0x1f8)]});_0x439165[_0x297354(0x1e1)](0xc8)[_0x297354(0x1dc)]({'message':'E-mail\x20enviado\x20com\x20sucesso'});}catch(_0x1fa7da){console[_0x297354(0x1f8)]('Erro\x20ao\x20enviar\x20e-mail:',_0x1fa7da),_0x439165[_0x297354(0x1e1)](0x1f4)[_0x297354(0x1dc)]({'error':_0x297354(0x1fc)});}};exports['enviarEmail']=enviarEmail;const listarEmailsEnviados=async(_0x262fb6,_0x25d93d)=>{const _0x18f7ef=a18_0x131f6c;try{const _0x2089a2=await Email_1[_0x18f7ef(0x204)][_0x18f7ef(0x1fe)]({'where':{'companyId':_0x262fb6['user'][_0x18f7ef(0x200)],'scheduled':null,'sendAt':null}});_0x25d93d['status'](0xc8)[_0x18f7ef(0x1dc)](_0x2089a2);}catch(_0x1f2f09){console[_0x18f7ef(0x1f8)]('Erro\x20ao\x20listar\x20e-mails\x20enviados:',_0x1f2f09),_0x25d93d['status'](0x1f4)['json']({'error':'Erro\x20ao\x20listar\x20e-mails\x20enviados'});}};function a18_0x2368(){const _0x2194b2=['3661176RiyZAA','findAll','454853CwLmhX','companyId','toString','info','__esModule','default','mensagem','timestamp','174644VVGLIW','Erro\x20ao\x20agendar\x20o\x20envio\x20de\x20e-mail:','11810538lpJBxQ','body','../models/Email','moment','listarEmailsAgendados','__importDefault','apply','SendMail','schedule','search','agendarEnvioEmail','Erro\x20ao\x20enviar\x20agendamentos\x20pendentes:','transports','winston','createLogger','json','sendAt','toDate','hour','YYYY-MM-DDTHH:mm','status','*/30\x20*\x20*\x20*\x20*\x20*','node-cron','6299620DMEdup','228qeTxtl','16IwEJBQ','add','317918vMEzSW','Erro\x20ao\x20listar\x20e-mails\x20agendados','format','264390ejUyvR','user','lte','printf','subject','(((.+)+)+)+$','not','listarEmailsEnviados','Erro\x20ao\x20agendar\x20o\x20envio\x20de\x20e-mail','create','Console','sender','../services/EmailService/EmailService','error','assunto','combine','A\x20data\x20de\x20envio\x20deve\x20ser\x20no\x20futuro','Erro\x20ao\x20enviar\x20e-mail'];a18_0x2368=function(){return _0x2194b2;};return a18_0x2368();}exports['listarEmailsEnviados']=listarEmailsEnviados;const listarEmailsAgendados=async(_0x179df7,_0x289a72)=>{const _0x108fb1=a18_0x131f6c;try{const _0x40aa9a=await Email_1[_0x108fb1(0x204)]['findAll']({'where':{'companyId':_0x179df7[_0x108fb1(0x1ec)][_0x108fb1(0x200)],'scheduled':!![],'sendAt':{[sequelize_1['Op'][_0x108fb1(0x1f1)]]:null}}});_0x289a72[_0x108fb1(0x1e1)](0xc8)['json'](_0x40aa9a);}catch(_0x137226){console['error']('Erro\x20ao\x20listar\x20e-mails\x20agendados:',_0x137226),_0x289a72[_0x108fb1(0x1e1)](0x1f4)[_0x108fb1(0x1dc)]({'error':_0x108fb1(0x1e9)});}};exports[a18_0x131f6c(0x1d1)]=listarEmailsAgendados;const agendarEnvioEmail=async(_0x48ec5c,_0x1558ae)=>{const _0x37204b=a18_0x131f6c;try{const _0x39a437=_0x48ec5c['user'][_0x37204b(0x200)],{recipient:_0x1e87b8,subject:_0x184b6b,message:_0x1a7249,sendAt:_0x162fb1}=_0x48ec5c[_0x37204b(0x1ce)],_0x375e8d=new Date(_0x162fb1);if(_0x375e8d<=new Date())return _0x1558ae[_0x37204b(0x1e1)](0x190)[_0x37204b(0x1dc)]({'error':_0x37204b(0x1fb)});await Email_1[_0x37204b(0x204)][_0x37204b(0x1f4)]({'sender':_0x48ec5c[_0x37204b(0x1ce)]['email'],'subject':_0x48ec5c[_0x37204b(0x1ce)][_0x37204b(0x1f9)],'message':_0x48ec5c[_0x37204b(0x1ce)][_0x37204b(0x205)],'companyId':_0x39a437,'scheduled':!![],'sendAt':new Date(_0x162fb1)}),_0x1558ae['status'](0xc8)[_0x37204b(0x1dc)]({'message':'E-mail\x20agendado\x20com\x20sucesso'});}catch(_0x4a887c){console[_0x37204b(0x1f8)](_0x37204b(0x208),_0x4a887c),_0x1558ae[_0x37204b(0x1e1)](0x1f4)[_0x37204b(0x1dc)]({'error':_0x37204b(0x1f3)});}};exports[a18_0x131f6c(0x1d7)]=agendarEnvioEmail;const enviarAgendamentosPendentes=async()=>{const _0x23b741=a18_0x131f6c;try{const _0x18f0ae=(0x0,moment_1['default'])(),_0x3ce738=await Email_1[_0x23b741(0x204)][_0x23b741(0x1fe)]({'where':{'scheduled':!![],'sendAt':{[sequelize_1['Op'][_0x23b741(0x1ed)]]:_0x18f0ae[_0x23b741(0x1de)]()}}});for(const _0x410a28 of _0x3ce738){const _0x2a5c3d=await(0x0,EmailService_1['SendMail'])(_0x410a28['companyId'],_0x410a28[_0x23b741(0x1f6)],'',_0x410a28[_0x23b741(0x1ef)],_0x410a28['message'],_0x410a28[_0x23b741(0x1dd)]['toISOString'](),'');!_0x2a5c3d[_0x23b741(0x1f8)]?(await _0x410a28['update']({'scheduled':![]}),logger[_0x23b741(0x202)]('E-mail\x20agendado\x20enviado\x20com\x20sucesso\x20para:\x20'+_0x410a28[_0x23b741(0x1f6)])):logger[_0x23b741(0x1f8)]('Erro\x20ao\x20enviar\x20e-mail\x20agendado\x20para:\x20'+_0x410a28['sender']+',\x20erro:\x20'+_0x2a5c3d['error']);}}catch(_0x30861c){logger[_0x23b741(0x1f8)](_0x23b741(0x1d8),_0x30861c);}};node_cron_1[a18_0x131f6c(0x204)][a18_0x131f6c(0x1d5)](a18_0x131f6c(0x1e2),enviarAgendamentosPendentes);