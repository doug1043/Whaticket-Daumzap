const a18_0x137789=a18_0x1c1d;(function(_0x16da66,_0x7d1d23){const _0x314e73=a18_0x1c1d,_0x34db6d=_0x16da66();while(!![]){try{const _0x2675ce=parseInt(_0x314e73(0x1d9))/0x1*(parseInt(_0x314e73(0x1d8))/0x2)+parseInt(_0x314e73(0x1ea))/0x3+-parseInt(_0x314e73(0x1db))/0x4*(-parseInt(_0x314e73(0x1d6))/0x5)+parseInt(_0x314e73(0x1de))/0x6+-parseInt(_0x314e73(0x1cf))/0x7*(parseInt(_0x314e73(0x1eb))/0x8)+parseInt(_0x314e73(0x1ca))/0x9*(-parseInt(_0x314e73(0x1d0))/0xa)+-parseInt(_0x314e73(0x1e0))/0xb;if(_0x2675ce===_0x7d1d23)break;else _0x34db6d['push'](_0x34db6d['shift']());}catch(_0xfcc5c6){_0x34db6d['push'](_0x34db6d['shift']());}}}(a18_0x34fd,0xcaed7));const a18_0x5f3387=(function(){let _0x1f3212=!![];return function(_0x56662c,_0x1e6352){const _0x5d9aa8=_0x1f3212?function(){if(_0x1e6352){const _0x13077d=_0x1e6352['apply'](_0x56662c,arguments);return _0x1e6352=null,_0x13077d;}}:function(){};return _0x1f3212=![],_0x5d9aa8;};}()),a18_0x29ce2f=a18_0x5f3387(this,function(){const _0x2a977a=a18_0x1c1d;return a18_0x29ce2f[_0x2a977a(0x1ba)]()[_0x2a977a(0x1b7)](_0x2a977a(0x1bb))['toString']()['constructor'](a18_0x29ce2f)['search'](_0x2a977a(0x1bb));});function a18_0x1c1d(_0x1f7fc1,_0x57db01){const _0x1e25e4=a18_0x34fd();return a18_0x1c1d=function(_0x29ce2f,_0x5f3387){_0x29ce2f=_0x29ce2f-0x1b6;let _0x34fde2=_0x1e25e4[_0x29ce2f];return _0x34fde2;},a18_0x1c1d(_0x1f7fc1,_0x57db01);}a18_0x29ce2f();'use strict';var __importDefault=this&&this[a18_0x137789(0x1da)]||function(_0x3edb97){return _0x3edb97&&_0x3edb97['__esModule']?_0x3edb97:{'default':_0x3edb97};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a18_0x137789(0x1be)]=exports[a18_0x137789(0x1e6)]=exports[a18_0x137789(0x1b6)]=exports[a18_0x137789(0x1e3)]=void 0x0;const EmailService_1=require(a18_0x137789(0x1dc)),Email_1=__importDefault(require(a18_0x137789(0x1dd))),moment_1=__importDefault(require('moment')),node_cron_1=__importDefault(require(a18_0x137789(0x1c4))),sequelize_1=require(a18_0x137789(0x1c2)),winston_1=__importDefault(require('winston')),logger=winston_1[a18_0x137789(0x1f0)][a18_0x137789(0x1ce)]({'level':'info','format':winston_1[a18_0x137789(0x1f0)][a18_0x137789(0x1c8)][a18_0x137789(0x1d5)](winston_1[a18_0x137789(0x1f0)][a18_0x137789(0x1c8)][a18_0x137789(0x1f1)](),winston_1['default'][a18_0x137789(0x1c8)][a18_0x137789(0x1d3)](({timestamp:_0x5e80a3,level:_0x2a60e4,message:_0x4b784e})=>{return _0x5e80a3+'\x20'+_0x2a60e4+':\x20'+_0x4b784e;})),'transports':[new winston_1[(a18_0x137789(0x1f0))][(a18_0x137789(0x1c5))]['Console']()]}),enviarEmail=async(_0x4976c5,_0xd98817)=>{const _0x35ffd2=a18_0x137789;try{const _0x222990=_0x4976c5[_0x35ffd2(0x1c9)][_0x35ffd2(0x1e8)],{email:_0x211823,tokenSenha:_0x3b8981,assunto:_0x562854,mensagem:_0x339ea0}=_0x4976c5[_0x35ffd2(0x1cc)],_0xb3ae6a=(0x0,moment_1[_0x35ffd2(0x1f0)])()[_0x35ffd2(0x1bd)](0x1,_0x35ffd2(0x1e4))['format']('YYYY-MM-DDTHH:mm'),_0x58252f=await(0x0,EmailService_1[_0x35ffd2(0x1d7)])(_0x222990,_0x211823,_0x3b8981,_0x562854,_0x339ea0,_0xb3ae6a);if(_0x58252f['error'])return _0xd98817[_0x35ffd2(0x1e2)](0x1f4)[_0x35ffd2(0x1bc)]({'error':_0x58252f[_0x35ffd2(0x1b8)]});_0xd98817[_0x35ffd2(0x1e2)](0xc8)[_0x35ffd2(0x1bc)]({'message':'E-mail\x20enviado\x20com\x20sucesso'});}catch(_0x1a33cb){console[_0x35ffd2(0x1b8)](_0x35ffd2(0x1ec),_0x1a33cb),_0xd98817[_0x35ffd2(0x1e2)](0x1f4)[_0x35ffd2(0x1bc)]({'error':_0x35ffd2(0x1f2)});}};exports['enviarEmail']=enviarEmail;const listarEmailsEnviados=async(_0x26ba9c,_0x3b7731)=>{const _0x3ac230=a18_0x137789;try{const _0x3a1b28=await Email_1[_0x3ac230(0x1f0)]['findAll']({'where':{'companyId':_0x26ba9c['user'][_0x3ac230(0x1e8)],'scheduled':null,'sendAt':null}});_0x3b7731[_0x3ac230(0x1e2)](0xc8)['json'](_0x3a1b28);}catch(_0x404c02){console[_0x3ac230(0x1b8)]('Erro\x20ao\x20listar\x20e-mails\x20enviados:',_0x404c02),_0x3b7731[_0x3ac230(0x1e2)](0x1f4)[_0x3ac230(0x1bc)]({'error':'Erro\x20ao\x20listar\x20e-mails\x20enviados'});}};exports[a18_0x137789(0x1b6)]=listarEmailsEnviados;const listarEmailsAgendados=async(_0x5ce13c,_0x5acb20)=>{const _0x3e64a3=a18_0x137789;try{const _0x3e4da8=await Email_1[_0x3e64a3(0x1f0)][_0x3e64a3(0x1e5)]({'where':{'companyId':_0x5ce13c[_0x3e64a3(0x1c9)][_0x3e64a3(0x1e8)],'scheduled':!![],'sendAt':{[sequelize_1['Op'][_0x3e64a3(0x1ee)]]:null}}});_0x5acb20['status'](0xc8)[_0x3e64a3(0x1bc)](_0x3e4da8);}catch(_0x112b39){console[_0x3e64a3(0x1b8)](_0x3e64a3(0x1c6),_0x112b39),_0x5acb20['status'](0x1f4)[_0x3e64a3(0x1bc)]({'error':_0x3e64a3(0x1d1)});}};exports[a18_0x137789(0x1e6)]=listarEmailsAgendados;function a18_0x34fd(){const _0x183423=['2yKfQcd','574375qxNUEm','__importDefault','4wAEnYr','../services/EmailService/EmailService','../models/Email','6546894cMTOdo','update','2697244LApakS','subject','status','enviarEmail','hour','findAll','listarEmailsAgendados','*/30\x20*\x20*\x20*\x20*\x20*','companyId','toISOString','1161021UMTnTs','8CsvIIG','Erro\x20ao\x20enviar\x20e-mail:','Erro\x20ao\x20agendar\x20o\x20envio\x20de\x20e-mail:','not','toDate','default','timestamp','Erro\x20ao\x20enviar\x20e-mail','listarEmailsEnviados','search','error','lte','toString','(((.+)+)+)+$','json','add','agendarEnvioEmail','assunto','create','mensagem','sequelize','email','node-cron','transports','Erro\x20ao\x20listar\x20e-mails\x20agendados:','message','format','user','9843030BJfRqO',',\x20erro:\x20','body','Erro\x20ao\x20enviar\x20agendamentos\x20pendentes:','createLogger','8148364PrVWby','10LaibvM','Erro\x20ao\x20listar\x20e-mails\x20agendados','sender','printf','A\x20data\x20de\x20envio\x20deve\x20ser\x20no\x20futuro','combine','6407930NWzndg','SendMail'];a18_0x34fd=function(){return _0x183423;};return a18_0x34fd();}const agendarEnvioEmail=async(_0x2fb60f,_0x134573)=>{const _0x3acec8=a18_0x137789;try{const _0x16226d=_0x2fb60f[_0x3acec8(0x1c9)][_0x3acec8(0x1e8)],{recipient:_0x5af3c9,subject:_0x380fa8,message:_0x589b4f,sendAt:_0x5b6764}=_0x2fb60f[_0x3acec8(0x1cc)],_0x2c619c=new Date(_0x5b6764);if(_0x2c619c<=new Date())return _0x134573[_0x3acec8(0x1e2)](0x190)[_0x3acec8(0x1bc)]({'error':_0x3acec8(0x1d4)});await Email_1['default'][_0x3acec8(0x1c0)]({'sender':_0x2fb60f[_0x3acec8(0x1cc)][_0x3acec8(0x1c3)],'subject':_0x2fb60f[_0x3acec8(0x1cc)][_0x3acec8(0x1bf)],'message':_0x2fb60f[_0x3acec8(0x1cc)][_0x3acec8(0x1c1)],'companyId':_0x16226d,'scheduled':!![],'sendAt':new Date(_0x5b6764)}),_0x134573['status'](0xc8)[_0x3acec8(0x1bc)]({'message':'E-mail\x20agendado\x20com\x20sucesso'});}catch(_0x5c52fa){console['error'](_0x3acec8(0x1ed),_0x5c52fa),_0x134573[_0x3acec8(0x1e2)](0x1f4)[_0x3acec8(0x1bc)]({'error':'Erro\x20ao\x20agendar\x20o\x20envio\x20de\x20e-mail'});}};exports[a18_0x137789(0x1be)]=agendarEnvioEmail;const enviarAgendamentosPendentes=async()=>{const _0x4eb3e3=a18_0x137789;try{const _0x373eac=(0x0,moment_1[_0x4eb3e3(0x1f0)])(),_0x24cadd=await Email_1[_0x4eb3e3(0x1f0)]['findAll']({'where':{'scheduled':!![],'sendAt':{[sequelize_1['Op'][_0x4eb3e3(0x1b9)]]:_0x373eac[_0x4eb3e3(0x1ef)]()}}});for(const _0x63ac6c of _0x24cadd){const _0x16a5a6=await(0x0,EmailService_1['SendMail'])(_0x63ac6c['companyId'],_0x63ac6c['sender'],'',_0x63ac6c[_0x4eb3e3(0x1e1)],_0x63ac6c[_0x4eb3e3(0x1c7)],_0x63ac6c['sendAt'][_0x4eb3e3(0x1e9)](),'');!_0x16a5a6[_0x4eb3e3(0x1b8)]?(await _0x63ac6c[_0x4eb3e3(0x1df)]({'scheduled':![]}),logger['info']('E-mail\x20agendado\x20enviado\x20com\x20sucesso\x20para:\x20'+_0x63ac6c[_0x4eb3e3(0x1d2)])):logger[_0x4eb3e3(0x1b8)]('Erro\x20ao\x20enviar\x20e-mail\x20agendado\x20para:\x20'+_0x63ac6c[_0x4eb3e3(0x1d2)]+_0x4eb3e3(0x1cb)+_0x16a5a6[_0x4eb3e3(0x1b8)]);}}catch(_0x4043e3){logger[_0x4eb3e3(0x1b8)](_0x4eb3e3(0x1cd),_0x4043e3);}};node_cron_1[a18_0x137789(0x1f0)]['schedule'](a18_0x137789(0x1e7),enviarAgendamentosPendentes);