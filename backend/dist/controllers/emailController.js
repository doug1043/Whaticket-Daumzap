const a20_0x29b37a=a20_0x542a;(function(_0x180116,_0x3571f8){const _0x255eed=a20_0x542a,_0x247f2e=_0x180116();while(!![]){try{const _0x44a93c=-parseInt(_0x255eed(0xa7))/0x1*(parseInt(_0x255eed(0xe6))/0x2)+parseInt(_0x255eed(0xcb))/0x3*(parseInt(_0x255eed(0xaf))/0x4)+parseInt(_0x255eed(0xa9))/0x5+parseInt(_0x255eed(0xd5))/0x6*(-parseInt(_0x255eed(0xbd))/0x7)+-parseInt(_0x255eed(0xcc))/0x8+parseInt(_0x255eed(0xb3))/0x9+-parseInt(_0x255eed(0xb6))/0xa*(-parseInt(_0x255eed(0xb5))/0xb);if(_0x44a93c===_0x3571f8)break;else _0x247f2e['push'](_0x247f2e['shift']());}catch(_0x3122b0){_0x247f2e['push'](_0x247f2e['shift']());}}}(a20_0x5c56,0x33fc8));const a20_0x4aa28f=(function(){let _0x4bead4=!![];return function(_0x22e44e,_0xce6041){const _0x4b7b6b=_0x4bead4?function(){const _0x38dc62=a20_0x542a;if(_0xce6041){const _0x1e3d49=_0xce6041[_0x38dc62(0xad)](_0x22e44e,arguments);return _0xce6041=null,_0x1e3d49;}}:function(){};return _0x4bead4=![],_0x4b7b6b;};}()),a20_0x54f8cc=a20_0x4aa28f(this,function(){const _0x52b301=a20_0x542a;return a20_0x54f8cc[_0x52b301(0xb0)]()['search']('(((.+)+)+)+$')[_0x52b301(0xb0)]()[_0x52b301(0xb2)](a20_0x54f8cc)[_0x52b301(0xbe)]('(((.+)+)+)+$');});function a20_0x5c56(){const _0x435486=['__importDefault','E-mail\x20agendado\x20enviado\x20com\x20sucesso\x20para:\x20','Erro\x20ao\x20enviar\x20e-mail','Erro\x20ao\x20processar\x20agendamento\x20','defineProperty','DESC','success','error','Erro\x20ao\x20listar\x20e-mails\x20agendados','update','body','Erro\x20ao\x20testar\x20conexão\x20SMTP','default','14PsiSoD','agendarEnvioEmail','4649PYtQXh','info','1822895bVWaxV','message','Erro\x20ao\x20processar\x20agendamentos\x20pendentes','../models/Email','apply','sequelize','635348btGOui','toString','sender','constructor','3663441wWVDZy','not','297UBNxgB','25370jvgOIT','Email,\x20assunto\x20e\x20mensagem\x20são\x20obrigatórios','findOne','Agendamento\x20cancelado\x20com\x20sucesso','../services/EmailService/EmailService','cancelarAgendamento','companyId','2751595FkLqpK','search','*\x20*\x20*\x20*\x20*','json','sendAt','params','__esModule','findAll','listarEmailsAgendados','A\x20data\x20de\x20envio\x20deve\x20ser\x20no\x20futuro','length','status','Erro\x20ao\x20listar\x20e-mails\x20enviados','enviarEmail','3zJxHeJ','2883200GPIVuO','SendMail','logger','Erro\x20ao\x20enviar\x20e-mail\x20agendado\x20para\x20','Email,\x20assunto,\x20mensagem\x20e\x20data\x20de\x20envio\x20são\x20obrigatórios','testarConexaoSMTP','TestSMTPConnection','Erro\x20ao\x20agendar\x20o\x20envio\x20de\x20e-mail','listarEmailsEnviados','6YCLpVP','user','\x20agendamentos\x20de\x20email\x20pendentes','E-mail\x20enviado\x20com\x20sucesso'];a20_0x5c56=function(){return _0x435486;};return a20_0x5c56();}a20_0x54f8cc();'use strict';var __importDefault=this&&this[a20_0x29b37a(0xd9)]||function(_0x398aeb){const _0x30b0b8=a20_0x29b37a;return _0x398aeb&&_0x398aeb[_0x30b0b8(0xc3)]?_0x398aeb:{'default':_0x398aeb};};Object[a20_0x29b37a(0xdd)](exports,'__esModule',{'value':!![]}),exports['cancelarAgendamento']=exports['agendarEnvioEmail']=exports[a20_0x29b37a(0xc5)]=exports[a20_0x29b37a(0xd4)]=exports['testarConexaoSMTP']=exports[a20_0x29b37a(0xca)]=void 0x0;const EmailService_1=require(a20_0x29b37a(0xba)),Email_1=__importDefault(require(a20_0x29b37a(0xac))),node_cron_1=__importDefault(require('node-cron')),sequelize_1=require(a20_0x29b37a(0xae)),logger_1=require('../utils/logger'),enviarEmail=async(_0x513221,_0x3aa063)=>{const _0xe09f38=a20_0x29b37a;try{const _0x2417ce=_0x513221[_0xe09f38(0xd6)][_0xe09f38(0xbc)],{email:_0x5099e4,assunto:_0x431bc2,mensagem:_0x39a8e8}=_0x513221[_0xe09f38(0xe3)];if(!_0x5099e4||!_0x431bc2||!_0x39a8e8)return _0x3aa063['status'](0x190)[_0xe09f38(0xc0)]({'error':_0xe09f38(0xb7)});const _0x2b380d=await(0x0,EmailService_1[_0xe09f38(0xcd)])(_0x2417ce,_0x5099e4,'',_0x431bc2,_0x39a8e8);if(_0x2b380d[_0xe09f38(0xe0)])return _0x3aa063[_0xe09f38(0xc8)](0x1f4)[_0xe09f38(0xc0)]({'error':_0x2b380d[_0xe09f38(0xe0)]});return _0x3aa063['status'](0xc8)[_0xe09f38(0xc0)]({'message':_0xe09f38(0xd8)});}catch(_0x2ede45){return logger_1[_0xe09f38(0xce)]['error']({'err':_0x2ede45},_0xe09f38(0xdb)),_0x3aa063[_0xe09f38(0xc8)](0x1f4)[_0xe09f38(0xc0)]({'error':_0xe09f38(0xdb)});}};exports[a20_0x29b37a(0xca)]=enviarEmail;const testarConexaoSMTP=async(_0x398eb4,_0x4cc24a)=>{const _0x3e2a1a=a20_0x29b37a;try{const _0x36084c=_0x398eb4[_0x3e2a1a(0xd6)][_0x3e2a1a(0xbc)],_0x23d5b8=await(0x0,EmailService_1[_0x3e2a1a(0xd2)])(_0x36084c);if(_0x23d5b8[_0x3e2a1a(0xe0)])return _0x4cc24a[_0x3e2a1a(0xc8)](0x190)[_0x3e2a1a(0xc0)]({'error':_0x23d5b8[_0x3e2a1a(0xe0)]});return _0x4cc24a[_0x3e2a1a(0xc8)](0xc8)[_0x3e2a1a(0xc0)]({'message':_0x23d5b8[_0x3e2a1a(0xaa)]});}catch(_0x29d3c5){return logger_1[_0x3e2a1a(0xce)]['error']({'err':_0x29d3c5},_0x3e2a1a(0xe4)),_0x4cc24a[_0x3e2a1a(0xc8)](0x1f4)[_0x3e2a1a(0xc0)]({'error':'Erro\x20ao\x20testar\x20conexão\x20SMTP'});}};exports[a20_0x29b37a(0xd1)]=testarConexaoSMTP;const listarEmailsEnviados=async(_0x10e50c,_0x5e80a3)=>{const _0x5bdc62=a20_0x29b37a;try{const _0x2969c2=await Email_1[_0x5bdc62(0xe5)]['findAll']({'where':{'companyId':_0x10e50c[_0x5bdc62(0xd6)][_0x5bdc62(0xbc)],'scheduled':{[sequelize_1['Op']['or']]:[null,![]]}},'order':[['createdAt',_0x5bdc62(0xde)]],'limit':0x64});return _0x5e80a3[_0x5bdc62(0xc8)](0xc8)[_0x5bdc62(0xc0)](_0x2969c2);}catch(_0x566c03){return logger_1[_0x5bdc62(0xce)][_0x5bdc62(0xe0)]({'err':_0x566c03},_0x5bdc62(0xc9)),_0x5e80a3[_0x5bdc62(0xc8)](0x1f4)[_0x5bdc62(0xc0)]({'error':_0x5bdc62(0xc9)});}};exports['listarEmailsEnviados']=listarEmailsEnviados;const listarEmailsAgendados=async(_0xd4b544,_0x4168)=>{const _0x1a6fd7=a20_0x29b37a;try{const _0x41661f=await Email_1[_0x1a6fd7(0xe5)][_0x1a6fd7(0xc4)]({'where':{'companyId':_0xd4b544['user']['companyId'],'scheduled':!![],'sendAt':{[sequelize_1['Op'][_0x1a6fd7(0xb4)]]:null}},'order':[[_0x1a6fd7(0xc1),'ASC']]});return _0x4168[_0x1a6fd7(0xc8)](0xc8)[_0x1a6fd7(0xc0)](_0x41661f);}catch(_0x3c13a6){return logger_1[_0x1a6fd7(0xce)][_0x1a6fd7(0xe0)]({'err':_0x3c13a6},_0x1a6fd7(0xe1)),_0x4168[_0x1a6fd7(0xc8)](0x1f4)[_0x1a6fd7(0xc0)]({'error':_0x1a6fd7(0xe1)});}};exports[a20_0x29b37a(0xc5)]=listarEmailsAgendados;const agendarEnvioEmail=async(_0x3c593a,_0x1701e9)=>{const _0xefdae0=a20_0x29b37a;try{const _0x144a00=_0x3c593a[_0xefdae0(0xd6)]['companyId'],{email:_0x3d4745,assunto:_0x3813f6,mensagem:_0x520025,sendAt:_0x392bb5}=_0x3c593a[_0xefdae0(0xe3)];if(!_0x3d4745||!_0x3813f6||!_0x520025||!_0x392bb5)return _0x1701e9[_0xefdae0(0xc8)](0x190)[_0xefdae0(0xc0)]({'error':_0xefdae0(0xd0)});const _0x4edf34=new Date(_0x392bb5);if(_0x4edf34<=new Date())return _0x1701e9['status'](0x190)[_0xefdae0(0xc0)]({'error':_0xefdae0(0xc6)});const _0x5a802c=await Email_1[_0xefdae0(0xe5)]['create']({'sender':_0x3d4745,'subject':_0x3813f6,'message':_0x520025,'companyId':_0x144a00,'scheduled':!![],'sendAt':_0x4edf34});return _0x1701e9[_0xefdae0(0xc8)](0xc8)[_0xefdae0(0xc0)]({'message':'E-mail\x20agendado\x20com\x20sucesso','id':_0x5a802c['id'],'sendAt':_0x4edf34});}catch(_0xecb5ef){return logger_1['logger'][_0xefdae0(0xe0)]({'err':_0xecb5ef},'Erro\x20ao\x20agendar\x20o\x20envio\x20de\x20e-mail'),_0x1701e9[_0xefdae0(0xc8)](0x1f4)['json']({'error':_0xefdae0(0xd3)});}};exports[a20_0x29b37a(0xe7)]=agendarEnvioEmail;const cancelarAgendamento=async(_0x3c1aeb,_0x4acc74)=>{const _0x1337f7=a20_0x29b37a;try{const {id:_0x355ac3}=_0x3c1aeb[_0x1337f7(0xc2)],_0x5404d7=_0x3c1aeb['user']['companyId'],_0x8bc142=await Email_1[_0x1337f7(0xe5)][_0x1337f7(0xb8)]({'where':{'id':_0x355ac3,'companyId':_0x5404d7,'scheduled':!![]}});if(!_0x8bc142)return _0x4acc74[_0x1337f7(0xc8)](0x194)[_0x1337f7(0xc0)]({'error':'Agendamento\x20não\x20encontrado'});return await _0x8bc142['destroy'](),_0x4acc74[_0x1337f7(0xc8)](0xc8)[_0x1337f7(0xc0)]({'message':_0x1337f7(0xb9)});}catch(_0x544348){return logger_1[_0x1337f7(0xce)]['error']({'err':_0x544348},'Erro\x20ao\x20cancelar\x20agendamento'),_0x4acc74['status'](0x1f4)['json']({'error':'Erro\x20ao\x20cancelar\x20agendamento'});}};exports[a20_0x29b37a(0xbb)]=cancelarAgendamento;function a20_0x542a(_0x53a57a,_0x32059b){const _0x3ea0cb=a20_0x5c56();return a20_0x542a=function(_0x54f8cc,_0x4aa28f){_0x54f8cc=_0x54f8cc-0xa7;let _0x5c56f4=_0x3ea0cb[_0x54f8cc];return _0x5c56f4;},a20_0x542a(_0x53a57a,_0x32059b);}const enviarAgendamentosPendentes=async()=>{const _0x329e68=a20_0x29b37a;try{const _0x34dd08=new Date(),_0x14d354=await Email_1[_0x329e68(0xe5)]['findAll']({'where':{'scheduled':!![],'sendAt':{[sequelize_1['Op']['lte']]:_0x34dd08}}});if(_0x14d354[_0x329e68(0xc7)]===0x0)return;logger_1[_0x329e68(0xce)][_0x329e68(0xa8)]('Processando\x20'+_0x14d354['length']+_0x329e68(0xd7));for(const _0x1b05e1 of _0x14d354){try{const _0x28482e=await(0x0,EmailService_1['SendMail'])(_0x1b05e1['companyId'],_0x1b05e1['sender'],'',_0x1b05e1['subject'],_0x1b05e1[_0x329e68(0xaa)]);_0x28482e[_0x329e68(0xdf)]?(await _0x1b05e1[_0x329e68(0xe2)]({'scheduled':![]}),logger_1[_0x329e68(0xce)][_0x329e68(0xa8)](_0x329e68(0xda)+_0x1b05e1[_0x329e68(0xb1)])):logger_1[_0x329e68(0xce)]['error'](_0x329e68(0xcf)+_0x1b05e1[_0x329e68(0xb1)]+':\x20'+_0x28482e[_0x329e68(0xe0)]);}catch(_0x164f0d){logger_1['logger'][_0x329e68(0xe0)](_0x329e68(0xdc)+_0x1b05e1['id']+':\x20'+_0x164f0d);}}}catch(_0x469f19){logger_1[_0x329e68(0xce)]['error']({'err':_0x469f19},_0x329e68(0xab));}};node_cron_1[a20_0x29b37a(0xe5)]['schedule'](a20_0x29b37a(0xbf),enviarAgendamentosPendentes);