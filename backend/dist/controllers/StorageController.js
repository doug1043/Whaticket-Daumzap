const a42_0x5928be=a42_0x5a48;(function(_0x35285c,_0x32e5a4){const _0x3c6e56=a42_0x5a48,_0x83f52d=_0x35285c();while(!![]){try{const _0x36e104=-parseInt(_0x3c6e56(0xe8))/0x1*(parseInt(_0x3c6e56(0xe4))/0x2)+parseInt(_0x3c6e56(0xfc))/0x3+-parseInt(_0x3c6e56(0xd0))/0x4+-parseInt(_0x3c6e56(0xf2))/0x5+parseInt(_0x3c6e56(0xd2))/0x6+parseInt(_0x3c6e56(0xdd))/0x7*(-parseInt(_0x3c6e56(0xf0))/0x8)+-parseInt(_0x3c6e56(0xe0))/0x9*(-parseInt(_0x3c6e56(0xfa))/0xa);if(_0x36e104===_0x32e5a4)break;else _0x83f52d['push'](_0x83f52d['shift']());}catch(_0xedff1c){_0x83f52d['push'](_0x83f52d['shift']());}}}(a42_0x2310,0x6be18));const a42_0x7d3ce6=(function(){let _0x471fa9=!![];return function(_0x2c4c01,_0x4e5db8){const _0x109236=_0x471fa9?function(){if(_0x4e5db8){const _0x411ead=_0x4e5db8['apply'](_0x2c4c01,arguments);return _0x4e5db8=null,_0x411ead;}}:function(){};return _0x471fa9=![],_0x109236;};}()),a42_0x509c08=a42_0x7d3ce6(this,function(){const _0x172692=a42_0x5a48;return a42_0x509c08[_0x172692(0xda)]()[_0x172692(0xec)]('(((.+)+)+)+$')[_0x172692(0xda)]()[_0x172692(0xd5)](a42_0x509c08)['search']('(((.+)+)+)+$');});a42_0x509c08();'use strict';function a42_0x2310(){const _0x30792c=['status','Erro\x20ao\x20limpar\x20pasta','Parâmetros\x20incompletos','Erro\x20ao\x20verificar\x20permissão\x20de\x20upload:','user','findOrCreate','20320VXqsGl','getMinioSettings','404415wUEMCa','saveMinioSettings','initializeCompanyStorage','Erro\x20ao\x20obter\x20uso\x20de\x20armazenamento:','canUpload','testMinioConnection','minioEndpoint','json','default','Erro\x20ao\x20salvar\x20configurações','1902728UkhKIV','findAll','1810938pfIGBo','Pasta\x20não\x20especificada','Erro\x20ao\x20obter\x20informações\x20de\x20armazenamento','constructor','Erro\x20ao\x20limpar\x20pasta:','minioBucket','minioUseSSL','body','toString','includes','key','29162SkXbQQ','forEach','minioSecretKey','8361upqhDL','error','Erro\x20ao\x20inicializar\x20armazenamento\x20da\x20empresa:','9000','2nsspfN','true','update','minioAccessKey','636723cjFkCU','value','Erro\x20ao\x20obter\x20configurações\x20MinIO:','clearFolder','search','../errors/AppError','createCompanyStorage','checkUploadPermission','1216XRyQeG','minioPort','684195kqnRnf','getStorageUsage'];a42_0x2310=function(){return _0x30792c;};return a42_0x2310();}var __importDefault=this&&this['__importDefault']||function(_0x2f45ff){return _0x2f45ff&&_0x2f45ff['__esModule']?_0x2f45ff:{'default':_0x2f45ff};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['initializeCompanyStorage']=exports[a42_0x5928be(0xfb)]=exports[a42_0x5928be(0xfd)]=exports[a42_0x5928be(0xcb)]=exports[a42_0x5928be(0xef)]=exports[a42_0x5928be(0xeb)]=exports[a42_0x5928be(0xf3)]=void 0x0;function a42_0x5a48(_0x4e872f,_0x18c10f){const _0x1818f4=a42_0x2310();return a42_0x5a48=function(_0x509c08,_0x7d3ce6){_0x509c08=_0x509c08-0xc9;let _0x2310e5=_0x1818f4[_0x509c08];return _0x2310e5;},a42_0x5a48(_0x4e872f,_0x18c10f);}const StorageService_1=__importDefault(require('../services/StorageService/StorageService')),AppError_1=__importDefault(require(a42_0x5928be(0xed))),Setting_1=__importDefault(require('../models/Setting')),getStorageUsage=async(_0x1d9f09,_0x18cdd0)=>{const _0x2d5fe1=a42_0x5928be,{companyId:_0x3be190}=_0x1d9f09[_0x2d5fe1(0xf8)];try{const _0x4004d1=await StorageService_1[_0x2d5fe1(0xce)][_0x2d5fe1(0xf3)](_0x3be190);return _0x18cdd0['status'](0xc8)[_0x2d5fe1(0xcd)](_0x4004d1);}catch(_0x3a9195){console[_0x2d5fe1(0xe1)](_0x2d5fe1(0xc9),_0x3a9195);throw new AppError_1[(_0x2d5fe1(0xce))](_0x2d5fe1(0xd4),0x1f4);}};exports[a42_0x5928be(0xf3)]=getStorageUsage;const clearFolder=async(_0x18fc40,_0x49cfe5)=>{const _0x4109a2=a42_0x5928be,{companyId:_0x5a7a59}=_0x18fc40[_0x4109a2(0xf8)],{folder:_0x1468c3}=_0x18fc40['params'];if(!_0x1468c3)throw new AppError_1[(_0x4109a2(0xce))](_0x4109a2(0xd3),0x190);try{const _0x1230b1=await StorageService_1[_0x4109a2(0xce)][_0x4109a2(0xeb)](_0x5a7a59,_0x1468c3);return _0x49cfe5['status'](0xc8)[_0x4109a2(0xcd)](_0x1230b1);}catch(_0x2b496b){console[_0x4109a2(0xe1)](_0x4109a2(0xd6),_0x2b496b);throw new AppError_1['default'](_0x4109a2(0xf5),0x1f4);}};exports[a42_0x5928be(0xeb)]=clearFolder;const checkUploadPermission=async(_0x57cec9,_0x89ad5e)=>{const _0x41fbd3=a42_0x5928be,{companyId:_0x14d271}=_0x57cec9['user'],{fileSize:_0x2bc42a}=_0x57cec9['query'],_0x3bfa4e=parseInt(String(_0x2bc42a)||'0',0xa);try{const _0x5550b6=await StorageService_1[_0x41fbd3(0xce)][_0x41fbd3(0xca)](_0x14d271,_0x3bfa4e),_0x3878e7=await StorageService_1[_0x41fbd3(0xce)][_0x41fbd3(0xf3)](_0x14d271);return _0x89ad5e[_0x41fbd3(0xf4)](0xc8)[_0x41fbd3(0xcd)]({'canUpload':_0x5550b6,..._0x3878e7});}catch(_0x58ec7f){console[_0x41fbd3(0xe1)](_0x41fbd3(0xf7),_0x58ec7f);throw new AppError_1[(_0x41fbd3(0xce))]('Erro\x20ao\x20verificar\x20permissão\x20de\x20upload',0x1f4);}};exports[a42_0x5928be(0xef)]=checkUploadPermission;const testMinioConnection=async(_0x20f5fd,_0x911dd2)=>{const _0x50e6a8=a42_0x5928be,{endPoint:_0x5dfdeb,port:_0x46c506,useSSL:_0xfab886,accessKey:_0x5f12bb,secretKey:_0x3e9496,bucket:_0x566853}=_0x20f5fd[_0x50e6a8(0xd9)];if(!_0x5dfdeb||!_0x5f12bb||!_0x3e9496||!_0x566853)throw new AppError_1['default'](_0x50e6a8(0xf6),0x190);try{const _0x3e0346=await StorageService_1['default'][_0x50e6a8(0xcb)]({'endPoint':_0x5dfdeb,'port':parseInt(_0x46c506||_0x50e6a8(0xe3),0xa),'useSSL':_0xfab886===!![]||_0xfab886===_0x50e6a8(0xe5),'accessKey':_0x5f12bb,'secretKey':_0x3e9496,'bucket':_0x566853});return _0x911dd2[_0x50e6a8(0xf4)](0xc8)['json'](_0x3e0346);}catch(_0x37b585){return console[_0x50e6a8(0xe1)]('Erro\x20ao\x20testar\x20conexão\x20MinIO:',_0x37b585),_0x911dd2[_0x50e6a8(0xf4)](0xc8)[_0x50e6a8(0xcd)]({'success':![],'message':String(_0x37b585)});}};exports[a42_0x5928be(0xcb)]=testMinioConnection;const saveMinioSettings=async(_0x3c9c1e,_0x4d4530)=>{const _0x4f7535=a42_0x5928be,{companyId:_0x21c1f4}=_0x3c9c1e[_0x4f7535(0xf8)],{endPoint:_0x5c7575,port:_0x33cae2,useSSL:_0x32b0a3,accessKey:_0x22b75f,secretKey:_0x13dc2f,bucket:_0x364ea1}=_0x3c9c1e[_0x4f7535(0xd9)];try{const _0x581af8=[{'key':_0x4f7535(0xcc),'value':_0x5c7575||''},{'key':_0x4f7535(0xf1),'value':String(_0x33cae2||_0x4f7535(0xe3))},{'key':'minioUseSSL','value':String(_0x32b0a3===!![]||_0x32b0a3===_0x4f7535(0xe5))},{'key':_0x4f7535(0xe7),'value':_0x22b75f||''},{'key':_0x4f7535(0xdf),'value':_0x13dc2f||''},{'key':_0x4f7535(0xd7),'value':_0x364ea1||''}];for(const _0x22dc62 of _0x581af8){const [_0x1f63db]=await Setting_1['default'][_0x4f7535(0xf9)]({'where':{'companyId':_0x21c1f4,'key':_0x22dc62[_0x4f7535(0xdc)]},'defaults':{'companyId':_0x21c1f4,'key':_0x22dc62[_0x4f7535(0xdc)],'value':_0x22dc62[_0x4f7535(0xe9)]}});_0x1f63db&&await _0x1f63db[_0x4f7535(0xe6)]({'value':_0x22dc62[_0x4f7535(0xe9)]});}return _0x5c7575&&_0x22b75f&&_0x13dc2f&&_0x364ea1&&await StorageService_1[_0x4f7535(0xce)]['createCompanyStorage'](_0x21c1f4),_0x4d4530[_0x4f7535(0xf4)](0xc8)[_0x4f7535(0xcd)]({'success':!![]});}catch(_0x40e0d9){console[_0x4f7535(0xe1)]('Erro\x20ao\x20salvar\x20configurações\x20MinIO:',_0x40e0d9);throw new AppError_1[(_0x4f7535(0xce))](_0x4f7535(0xcf),0x1f4);}};exports[a42_0x5928be(0xfd)]=saveMinioSettings;const getMinioSettings=async(_0x59f88e,_0x23404d)=>{const _0xc5a7a6=a42_0x5928be,{companyId:_0x22567d}=_0x59f88e['user'];try{const _0x33e976=await Setting_1[_0xc5a7a6(0xce)][_0xc5a7a6(0xd1)]({'where':{'companyId':_0x22567d},'attributes':[_0xc5a7a6(0xdc),_0xc5a7a6(0xe9)]}),_0x3ed8ea={},_0x1bb364=[_0xc5a7a6(0xcc),_0xc5a7a6(0xf1),_0xc5a7a6(0xd8),'minioAccessKey',_0xc5a7a6(0xdf),'minioBucket'];return _0x33e976[_0xc5a7a6(0xde)](_0x450115=>{const _0xc793b1=_0xc5a7a6;_0x1bb364[_0xc793b1(0xdb)](_0x450115[_0xc793b1(0xdc)])&&(_0x3ed8ea[_0x450115['key']]=_0x450115['value']);}),_0x23404d[_0xc5a7a6(0xf4)](0xc8)[_0xc5a7a6(0xcd)](_0x3ed8ea);}catch(_0x4d2d75){console[_0xc5a7a6(0xe1)](_0xc5a7a6(0xea),_0x4d2d75);throw new AppError_1[(_0xc5a7a6(0xce))]('Erro\x20ao\x20obter\x20configurações',0x1f4);}};exports[a42_0x5928be(0xfb)]=getMinioSettings;const initializeCompanyStorage=async _0xb5c09f=>{const _0x1aa68c=a42_0x5928be;try{await StorageService_1['default'][_0x1aa68c(0xee)](_0xb5c09f);}catch(_0x1e7573){console[_0x1aa68c(0xe1)](_0x1aa68c(0xe2),_0x1e7573);}};exports[a42_0x5928be(0xfe)]=initializeCompanyStorage;