const a308_0x1d5dcb=a308_0x37ce;(function(_0xa10354,_0x14675d){const _0x5c4713=a308_0x37ce,_0x4595bd=_0xa10354();while(!![]){try{const _0x5ddf82=parseInt(_0x5c4713(0x105))/0x1+parseInt(_0x5c4713(0x175))/0x2+parseInt(_0x5c4713(0xef))/0x3*(-parseInt(_0x5c4713(0x140))/0x4)+-parseInt(_0x5c4713(0x142))/0x5*(-parseInt(_0x5c4713(0xe3))/0x6)+-parseInt(_0x5c4713(0x137))/0x7*(parseInt(_0x5c4713(0x124))/0x8)+parseInt(_0x5c4713(0x148))/0x9+-parseInt(_0x5c4713(0x141))/0xa*(parseInt(_0x5c4713(0x132))/0xb);if(_0x5ddf82===_0x14675d)break;else _0x4595bd['push'](_0x4595bd['shift']());}catch(_0x41a38d){_0x4595bd['push'](_0x4595bd['shift']());}}}(a308_0x5781,0xf2041));const a308_0x31a8ec=(function(){let _0x56b225=!![];return function(_0x3c1ac1,_0x31e32c){const _0x4927fd=_0x56b225?function(){const _0x33489a=a308_0x37ce;if(_0x31e32c){const _0x5e32fc=_0x31e32c[_0x33489a(0xee)](_0x3c1ac1,arguments);return _0x31e32c=null,_0x5e32fc;}}:function(){};return _0x56b225=![],_0x4927fd;};}()),a308_0x49e2c2=a308_0x31a8ec(this,function(){const _0x15ac04=a308_0x37ce;return a308_0x49e2c2[_0x15ac04(0x169)]()[_0x15ac04(0x158)]('(((.+)+)+)+$')['toString']()[_0x15ac04(0x11a)](a308_0x49e2c2)[_0x15ac04(0x158)](_0x15ac04(0x171));});a308_0x49e2c2();'use strict';var __createBinding=this&&this[a308_0x1d5dcb(0x14b)]||(Object['create']?function(_0x516ec7,_0x23af28,_0x199b33,_0x25338c){const _0x5416b5=a308_0x1d5dcb;if(_0x25338c===undefined)_0x25338c=_0x199b33;var _0x3d9969=Object['getOwnPropertyDescriptor'](_0x23af28,_0x199b33);(!_0x3d9969||('get'in _0x3d9969?!_0x23af28['__esModule']:_0x3d9969['writable']||_0x3d9969[_0x5416b5(0xe1)]))&&(_0x3d9969={'enumerable':!![],'get':function(){return _0x23af28[_0x199b33];}}),Object[_0x5416b5(0x16b)](_0x516ec7,_0x25338c,_0x3d9969);}:function(_0x513698,_0x59f750,_0x2c5834,_0x24a120){if(_0x24a120===undefined)_0x24a120=_0x2c5834;_0x513698[_0x24a120]=_0x59f750[_0x2c5834];}),__setModuleDefault=this&&this[a308_0x1d5dcb(0x14e)]||(Object[a308_0x1d5dcb(0x15a)]?function(_0x2ea044,_0x58804d){const _0x3bfdec=a308_0x1d5dcb;Object['defineProperty'](_0x2ea044,_0x3bfdec(0x139),{'enumerable':!![],'value':_0x58804d});}:function(_0x2fde15,_0x16bdcc){const _0xf527d9=a308_0x1d5dcb;_0x2fde15[_0xf527d9(0x139)]=_0x16bdcc;}),__importStar=this&&this[a308_0x1d5dcb(0xe5)]||function(_0x3e4a19){const _0x1d14f4=a308_0x1d5dcb;if(_0x3e4a19&&_0x3e4a19['__esModule'])return _0x3e4a19;var _0x2ab179={};if(_0x3e4a19!=null){for(var _0x5965f3 in _0x3e4a19)if(_0x5965f3!==_0x1d14f4(0x139)&&Object[_0x1d14f4(0x15e)][_0x1d14f4(0x109)]['call'](_0x3e4a19,_0x5965f3))__createBinding(_0x2ab179,_0x3e4a19,_0x5965f3);}return __setModuleDefault(_0x2ab179,_0x3e4a19),_0x2ab179;},__importDefault=this&&this[a308_0x1d5dcb(0x16e)]||function(_0x1ea4d8){const _0x5b8e4a=a308_0x1d5dcb;return _0x1ea4d8&&_0x1ea4d8[_0x5b8e4a(0xfa)]?_0x1ea4d8:{'default':_0x1ea4d8};};function a308_0x37ce(_0x3320fb,_0xd0c768){const _0x350ca1=a308_0x5781();return a308_0x37ce=function(_0x49e2c2,_0x31a8ec){_0x49e2c2=_0x49e2c2-0xdd;let _0x578169=_0x350ca1[_0x49e2c2];return _0x578169;},a308_0x37ce(_0x3320fb,_0xd0c768);}Object[a308_0x1d5dcb(0x16b)](exports,a308_0x1d5dcb(0xfa),{'value':!![]}),exports[a308_0x1d5dcb(0xf7)]=exports[a308_0x1d5dcb(0x168)]=exports[a308_0x1d5dcb(0xdf)]=exports['parseToMilliseconds']=exports['campaignQueue']=exports[a308_0x1d5dcb(0x130)]=exports[a308_0x1d5dcb(0x167)]=exports[a308_0x1d5dcb(0x13f)]=exports[a308_0x1d5dcb(0xf0)]=exports[a308_0x1d5dcb(0xf9)]=void 0x0;const Sentry=__importStar(require('@sentry/node')),bullmq_1=require(a308_0x1d5dcb(0x12f)),SendMessage_1=require(a308_0x1d5dcb(0x116)),Whatsapp_1=__importDefault(require(a308_0x1d5dcb(0xe4))),logger_1=require(a308_0x1d5dcb(0x118)),moment_1=__importDefault(require('moment')),Contact_1=__importDefault(require(a308_0x1d5dcb(0x15f))),sequelize_1=require('sequelize'),socket_1=require('./libs/socket'),User_1=__importDefault(require(a308_0x1d5dcb(0x12c))),Company_1=__importDefault(require('./models/Company')),Plan_1=__importDefault(require('./models/Plan')),Ticket_1=__importDefault(require(a308_0x1d5dcb(0xde))),wbotClosedTickets_1=require(a308_0x1d5dcb(0x145)),Invoices_1=__importDefault(require('./models/Invoices')),wbotMessageListener_1=require(a308_0x1d5dcb(0x15b)),wbot_1=require(a308_0x1d5dcb(0xfb)),MarkDeleteWhatsAppMessage_1=__importDefault(require('./services/WbotServices/MarkDeleteWhatsAppMessage')),ioredis_1=__importDefault(require(a308_0x1d5dcb(0xed))),campaingJob_1=__importDefault(require('./workers/campaingJob')),scheduledMessageJob_1=__importDefault(require(a308_0x1d5dcb(0x154))),connection={'port':parseInt(process[a308_0x1d5dcb(0xeb)][a308_0x1d5dcb(0x16a)]),'host':process[a308_0x1d5dcb(0xeb)][a308_0x1d5dcb(0x138)]||a308_0x1d5dcb(0xfd),'password':process[a308_0x1d5dcb(0xeb)][a308_0x1d5dcb(0x16d)]},limiterMax=process[a308_0x1d5dcb(0xeb)][a308_0x1d5dcb(0x134)]||0x1,limiterDuration=process[a308_0x1d5dcb(0xeb)][a308_0x1d5dcb(0x16f)]||0xbb8,redis=new ioredis_1[(a308_0x1d5dcb(0x139))](process[a308_0x1d5dcb(0xeb)]['REDIS_URI']);exports[a308_0x1d5dcb(0xf9)]=new bullmq_1[(a308_0x1d5dcb(0xfe))](a308_0x1d5dcb(0x11c),{'connection':connection}),exports['generalMonitor']=new bullmq_1[(a308_0x1d5dcb(0xfe))]('GeneralMonitor',{'connection':connection}),exports[a308_0x1d5dcb(0x13f)]=new bullmq_1[(a308_0x1d5dcb(0xfe))](a308_0x1d5dcb(0x13d),{'connection':connection}),exports['queueMonitor']=new bullmq_1[(a308_0x1d5dcb(0xfe))](a308_0x1d5dcb(0xe7),{'connection':connection}),exports[a308_0x1d5dcb(0x130)]=new bullmq_1[(a308_0x1d5dcb(0xfe))](a308_0x1d5dcb(0xf3),{'connection':connection}),exports[a308_0x1d5dcb(0x112)]=new bullmq_1[(a308_0x1d5dcb(0xfe))](a308_0x1d5dcb(0xf8),{'connection':connection});async function handleVerifyQueueOld(_0x846d3e){const _0x5fcb03=a308_0x1d5dcb;logger_1[_0x5fcb03(0x135)]['info'](_0x5fcb03(0x10e));try{const _0x38dc62=await Company_1[_0x5fcb03(0x139)][_0x5fcb03(0x163)]({'attributes':['id',_0x5fcb03(0x15c)],'where':{'status':!![],'dueDate':{[sequelize_1['Op']['gt']]:sequelize_1[_0x5fcb03(0x143)][_0x5fcb03(0x121)](_0x5fcb03(0x157))}},'include':[{'model':Whatsapp_1[_0x5fcb03(0x139)],'attributes':['id',_0x5fcb03(0x15c),_0x5fcb03(0x16c),_0x5fcb03(0x146),_0x5fcb03(0x119)],'where':{'timeSendQueue':{[sequelize_1['Op']['gt']]:0x0}}}]});_0x38dc62[_0x5fcb03(0x147)](async _0x39cbba=>{_0x39cbba['whatsapps']['map'](async _0x509f88=>{const _0x31ef80=a308_0x37ce;if(_0x509f88[_0x31ef80(0x16c)]===_0x31ef80(0x156)){var _0x4c8eae=_0x39cbba['id'];const _0x59e1fc=_0x509f88['timeSendQueue']?_0x509f88['timeSendQueue']:0x0,_0x537848=_0x509f88['sendIdQueue'],_0x18321f=_0x59e1fc,_0x13a02f=_0x537848,_0x1d4272=_0x18321f;if(_0x59e1fc>0x0){if(!isNaN(_0x13a02f)&&Number[_0x31ef80(0x14f)](_0x13a02f)&&!isNaN(_0x1d4272)&&Number[_0x31ef80(0x14f)](_0x1d4272)){const _0x6187f5=(0x0,moment_1['default'])()[_0x31ef80(0x10f)](_0x1d4272,_0x31ef80(0x170))[_0x31ef80(0x173)]()[_0x31ef80(0x101)](),{count:_0x5e492c,rows:_0x2e33a1}=await Ticket_1[_0x31ef80(0x139)][_0x31ef80(0x152)]({'where':{'status':'pending','queueId':null,'companyId':_0x4c8eae,'whatsappId':_0x509f88['id'],'updatedAt':{[sequelize_1['Op']['lt']]:_0x6187f5}},'include':[{'model':Contact_1[_0x31ef80(0x139)],'as':_0x31ef80(0x131),'attributes':['id','name',_0x31ef80(0x10a),'email',_0x31ef80(0x10d)],'include':['extraInfo']}]});_0x5e492c>0x0?_0x2e33a1[_0x31ef80(0x147)](async _0x4ad55a=>{const _0x5acb32=_0x31ef80;await _0x4ad55a[_0x5acb32(0x103)]({'queueId':_0x13a02f}),await _0x4ad55a[_0x5acb32(0x11b)]();const _0x10d123=(0x0,socket_1[_0x5acb32(0x162)])();_0x10d123['to'](_0x5acb32(0x164)+_0x4ad55a['companyId']+'-'+_0x4ad55a[_0x5acb32(0x16c)])['to'](_0x5acb32(0x164)+_0x4ad55a[_0x5acb32(0x110)]+'-notification')['to'](_0x4ad55a['id'][_0x5acb32(0x169)]())[_0x5acb32(0x104)]('company-'+_0x4c8eae+_0x5acb32(0x160),{'action':_0x5acb32(0x103),'ticket':_0x4ad55a,'ticketId':_0x4ad55a['id']}),logger_1[_0x5acb32(0x135)][_0x5acb32(0x12d)](_0x5acb32(0xf6)+_0x4ad55a['id']+_0x5acb32(0x10b)+_0x4c8eae);}):logger_1[_0x31ef80(0x135)][_0x31ef80(0x12d)]('Nenhum\x20atendimento\x20perdido\x20encontrado\x20-\x20Empresa:\x20'+_0x4c8eae);}else logger_1[_0x31ef80(0x135)][_0x31ef80(0x12d)](_0x31ef80(0xf4)+_0x4c8eae);}}});});}catch(_0x5de638){Sentry['captureException'](_0x5de638),logger_1[_0x5fcb03(0x135)]['error']('SearchForQueue\x20->\x20VerifyQueue:\x20error'+_0x5de638);throw _0x5de638;}};async function handleVerifyQueue(_0x2bf71a){const _0x35ee7c=a308_0x1d5dcb;logger_1[_0x35ee7c(0x135)]['info'](_0x35ee7c(0x10e));try{const _0x2692f9=await Company_1['default']['findAll']({'attributes':['id','name'],'where':{'status':!![],'dueDate':{[sequelize_1['Op']['gt']]:sequelize_1[_0x35ee7c(0x143)][_0x35ee7c(0x121)]('CURRENT_DATE')}},'include':[{'model':Whatsapp_1['default'],'attributes':['id',_0x35ee7c(0x15c),_0x35ee7c(0x16c),_0x35ee7c(0x146),_0x35ee7c(0x119)],'where':{'timeSendQueue':{[sequelize_1['Op']['gt']]:0x0}}}]});_0x2692f9['map'](async _0x25d73c=>{const _0x24b713=_0x35ee7c;_0x25d73c[_0x24b713(0xff)][_0x24b713(0x147)](async _0x31c1e8=>{const _0xc3a02c=_0x24b713;if(_0x31c1e8[_0xc3a02c(0x16c)]===_0xc3a02c(0x156)){const _0x11dc6a=_0x25d73c['id'],_0x52bdcf=_0x31c1e8[_0xc3a02c(0x146)]?_0x31c1e8[_0xc3a02c(0x146)]:0x0,_0x267d0e=_0x31c1e8[_0xc3a02c(0x119)],_0x1064d3=_0x52bdcf,_0x2c40db=_0x267d0e,_0x22c0a3=_0x1064d3;if(_0x52bdcf>0x0&&!isNaN(_0x2c40db)&&Number['isInteger'](_0x2c40db)&&!isNaN(_0x22c0a3)&&Number['isInteger'](_0x22c0a3)){const _0x1941d5=(0x0,moment_1[_0xc3a02c(0x139)])()[_0xc3a02c(0x10f)](_0x22c0a3,'minutes')[_0xc3a02c(0x173)]()['format'](),{count:_0x2acc44,rows:_0x11ff51}=await Ticket_1[_0xc3a02c(0x139)]['findAndCountAll']({'where':{'status':_0xc3a02c(0x150),'queueId':null,'companyId':_0x11dc6a,'whatsappId':_0x31c1e8['id'],'updatedAt':{[sequelize_1['Op']['lt']]:_0x1941d5}},'include':[{'model':Contact_1[_0xc3a02c(0x139)],'as':_0xc3a02c(0x131),'attributes':['id',_0xc3a02c(0x15c),_0xc3a02c(0x10a),_0xc3a02c(0x115),_0xc3a02c(0x10d)],'include':['extraInfo']}]});_0x2acc44>0x0?_0x11ff51[_0xc3a02c(0x147)](async _0x5550cc=>{const _0x2b02a9=_0xc3a02c;await _0x5550cc[_0x2b02a9(0x103)]({'queueId':_0x2c40db}),await _0x5550cc[_0x2b02a9(0x11b)]();const _0x389d4a=(0x0,socket_1[_0x2b02a9(0x162)])();_0x389d4a['to'](_0x2b02a9(0x164)+_0x5550cc[_0x2b02a9(0x110)]+'-'+_0x5550cc[_0x2b02a9(0x16c)])['to'](_0x2b02a9(0x164)+_0x5550cc['companyId']+_0x2b02a9(0x123))['to'](_0x5550cc['id'][_0x2b02a9(0x169)]())[_0x2b02a9(0x104)](_0x2b02a9(0x164)+_0x11dc6a+_0x2b02a9(0x160),{'action':_0x2b02a9(0x103),'ticket':_0x5550cc,'ticketId':_0x5550cc['id']}),logger_1[_0x2b02a9(0x135)][_0x2b02a9(0x12d)](_0x2b02a9(0xf6)+_0x5550cc['id']+'\x20-\x20Empresa:\x20'+_0x11dc6a);}):logger_1[_0xc3a02c(0x135)]['info'](_0xc3a02c(0x155)+_0x11dc6a);}else logger_1[_0xc3a02c(0x135)][_0xc3a02c(0x12d)]('Condição\x20não\x20respeitada\x20-\x20Empresa:\x20'+_0x11dc6a);}});});}catch(_0x2a3192){console[_0x35ee7c(0x13e)](_0x2a3192);}}async function handleCloseTicketsAutomatic(){const _0x479004=a308_0x1d5dcb,_0x3b54c6=await Company_1[_0x479004(0x139)]['findAll']({'where':{'status':!![]}});_0x3b54c6[_0x479004(0x147)](async _0x3d0143=>{const _0x4ef138=_0x479004;try{const _0x42bb01=_0x3d0143['id'];await(0x0,wbotClosedTickets_1[_0x4ef138(0x165)])(_0x42bb01);}catch(_0x36fff6){Sentry[_0x4ef138(0x111)](_0x36fff6),logger_1[_0x4ef138(0x135)]['error']('ClosedAllOpenTickets\x20->\x20Verify:\x20error',_0x36fff6[_0x4ef138(0x13b)]);throw _0x36fff6;}});}async function messageUpdateJob(_0x2fe0bc){const _0x1c40f0=a308_0x1d5dcb,{data:_0x389989}=_0x2fe0bc;var _0x438836=_0x389989[_0x1c40f0(0x110)],_0x38a662=_0x389989[_0x1c40f0(0x106)],_0x746b49=_0x389989[_0x1c40f0(0x122)];const _0x12989e=(0x0,wbot_1['getWbot'])(_0x389989[_0x1c40f0(0x122)]);for(const _0x233aad of _0x38a662){await _0x12989e[_0x1c40f0(0x177)]([_0x233aad[_0x1c40f0(0x125)]]);const _0xaecb85={..._0x38a662};_0xaecb85['0']?.[_0x1c40f0(0x103)][_0x1c40f0(0xf1)]===0x1&&_0xaecb85['0']?.[_0x1c40f0(0x125)][_0x1c40f0(0x120)]!==_0x1c40f0(0x102)&&await(0x0,MarkDeleteWhatsAppMessage_1[_0x1c40f0(0x139)])(_0xaecb85['0']?.[_0x1c40f0(0x125)][_0x1c40f0(0x120)],null,_0xaecb85['0']?.[_0x1c40f0(0x125)]['id'],_0x438836),await(0x0,wbotMessageListener_1['handleMsgAck'])(_0x233aad,_0x233aad['update'][_0x1c40f0(0x16c)]);}}async function handleMessageJob(_0x43ad6f){const _0xf233c7=a308_0x1d5dcb,{data:_0x37c266}=_0x43ad6f;var _0x3b9383=_0x37c266[_0xf233c7(0x11e)],_0x3f5d78=_0x37c266[_0xf233c7(0x110)];const _0x473e9f=(0x0,wbot_1['getWbot'])(_0x37c266[_0xf233c7(0x122)]);for(const _0x1943d4 of _0x3b9383){await(0x0,wbotMessageListener_1[_0xf233c7(0xec)])(_0x1943d4,_0x473e9f,_0x3f5d78),await(0x0,wbotMessageListener_1['verifyRecentCampaign'])(_0x1943d4,_0x3f5d78),await(0x0,wbotMessageListener_1[_0xf233c7(0x159)])(_0x1943d4,_0x3f5d78),_0x1943d4[_0xf233c7(0x125)][_0xf233c7(0x120)]?.[_0xf233c7(0x12e)](_0xf233c7(0x128))&&await(0x0,wbotMessageListener_1[_0xf233c7(0x176)])(_0x1943d4,0x2);}}async function handleSendMessage(_0x513658){const _0x466851=a308_0x1d5dcb;console[_0x466851(0xf2)](_0x466851(0x117));try{const {data:_0x3a7c0e}=_0x513658,_0x4293f2=await Whatsapp_1[_0x466851(0x139)][_0x466851(0x136)](_0x3a7c0e['whatsappId']);if(_0x4293f2==null)throw new sequelize_1[(_0x466851(0x108))](_0x466851(0x113));const _0x6c0b2b=_0x3a7c0e[_0x466851(0x14d)];await(0x0,SendMessage_1[_0x466851(0xe2)])(_0x4293f2,_0x6c0b2b);}catch(_0x5ee154){Sentry[_0x466851(0x111)](_0x5ee154),logger_1[_0x466851(0x135)][_0x466851(0x13e)](_0x466851(0x13c),_0x5ee154['message']);throw _0x5ee154;}}function parseToMilliseconds(_0x2a756a){return _0x2a756a*0x3e8;}exports[a308_0x1d5dcb(0x133)]=parseToMilliseconds;async function sleep(_0x4ee8ec){const _0x4065b8=a308_0x1d5dcb;return logger_1['logger'][_0x4065b8(0x12d)]('Sleep\x20de\x20'+_0x4ee8ec+'\x20segundos\x20iniciado:\x20'+(0x0,moment_1['default'])()[_0x4065b8(0x101)]('HH:mm:ss')),new Promise(_0x33cf22=>{setTimeout(()=>{const _0x499b62=a308_0x37ce;logger_1['logger']['info'](_0x499b62(0x153)+_0x4ee8ec+_0x499b62(0xe9)+(0x0,moment_1[_0x499b62(0x139)])()['format'](_0x499b62(0x11f))),_0x33cf22(!![]);},parseToMilliseconds(_0x4ee8ec));});}exports[a308_0x1d5dcb(0xdf)]=sleep;function randomValue(_0x2dbc28,_0x183146){const _0xbc1cb2=a308_0x1d5dcb;return Math['floor'](Math[_0xbc1cb2(0x144)]()*_0x183146)+_0x2dbc28;}function a308_0x5781(){const _0x1eab1b=['\x20-\x20Empresa:\x20','getMinutes','profilePicUrl','Buscando\x20atendimentos\x20perdidos\x20nas\x20filas','subtract','companyId','captureException','campaignQueue','Whatsapp\x20não\x20identificado','Iniciando\x20processamento\x20de\x20filas','email','./helpers/SendMessage','HANDLE\x20SEND\x20MESSAGE','./utils/logger','sendIdQueue','constructor','reload','UserMonitor','DD/MM/yyyy','messages','HH:mm:ss','remoteJid','literal','whatsappId','-notification','8iInEIK','key','open','count','@g.us','asDays','Job\x20','InvoiceCreate','./models/User','info','endsWith','bullmq','scheduleMonitor','contact','6314YMlisN','parseToMilliseconds','REDIS_OPT_LIMITER_MAX','logger','findByPk','10802414SGWtsQ','REDIS_HOST','default','VerifyCampaigns','message','MessageQueue\x20->\x20SendMessage:\x20error','MessageQueue','error','messageQueue','20WYqpKd','30300Rwhmyz','5IsMbPd','Sequelize','random','./services/WbotServices/wbotClosedTickets','timeSendQueue','map','9559602WPtywq','setMinutes','diff','__createBinding','planId','data','__setModuleDefault','isInteger','pending','add','findAndCountAll','Sleep\x20de\x20','./workers/scheduledMessageJob','Nenhum\x20atendimento\x20perdido\x20encontrado\x20-\x20Empresa:\x20','CONNECTED','CURRENT_DATE','search','verifyCampaignMessageAndCloseTicket','create','./services/WbotServices/wbotMessageListener','name','completed','prototype','./models/Contact','-ticket','\x20completed','getIO','findAll','company-','ClosedAllOpenTickets','VerifyLoginStatus','queueMonitor','randomValue','toString','REDIS_PORT','defineProperty','status','REDIS_PASSWORD','__importDefault','REDIS_OPT_LIMITER_DURATION','minutes','(((.+)+)+)+$','like','utc','duration','889876wEPzxD','handleMsgAck','readMessages','handle\x20login','./models/Ticket','sleep','CloseTicketsAutomatic','configurable','SendMessage','8058738FhCDwB','./models/Whatsapp','__importStar','\x20failed\x20with\x20error:\x20','QueueMonitor','setHours','\x20segundos\x20finalizado:\x20','MessageUpdateJob','env','handleMessage','ioredis','apply','105555oTnZAQ','generalMonitor','messageStubType','log','ScheduleMonitor','Condição\x20não\x20respeitada\x20-\x20Empresa:\x20','YYYY-MM-DD','Atendimento\x20Perdido:\x20','startQueueProcess','CampaignQueue','userMonitor','__esModule','./libs/wbot','Worker','127.0.0.1','Queue','whatsapps','value','format','status@broadcast','update','emit','1599405gFcixz','messageUpdate','VerifyQueueStatus','Error','hasOwnProperty','number'];a308_0x5781=function(){return _0x1eab1b;};return a308_0x5781();}exports[a308_0x1d5dcb(0x168)]=randomValue;async function handleLoginStatus(){const _0x496b86=a308_0x1d5dcb;console['log'](_0x496b86(0xdd));const _0x87c75a=new Date();_0x87c75a[_0x496b86(0x149)](_0x87c75a[_0x496b86(0x10c)]()-0x5),await User_1[_0x496b86(0x139)][_0x496b86(0x103)]({'online':![]},{'where':{'updatedAt':{[sequelize_1['Op']['lt']]:_0x87c75a},'online':!![]}});}async function handleInvoiceCreate(){const _0x58c67c=a308_0x1d5dcb;logger_1[_0x58c67c(0x135)][_0x58c67c(0x12d)]('Iniciando\x20geração\x20de\x20boletos');const _0x3f2d57=await Company_1[_0x58c67c(0x139)]['findAll']({'where':{'status':!![]}});_0x3f2d57['map'](async _0x15548f=>{const _0x434b8d=_0x58c67c,{dueDate:_0x2e2f6b}=_0x15548f,_0x2b0033=new Date(_0x2e2f6b)[_0x434b8d(0xe8)](0x0,0x0,0x0,0x0),_0x109dcf=new Date(_0x2e2f6b)[_0x434b8d(0xe8)](0x17,0x3b,0x3b,0x3e7),_0x1f05b2=(0x0,moment_1[_0x434b8d(0x139)])((0x0,moment_1[_0x434b8d(0x139)])())[_0x434b8d(0x101)](_0x434b8d(0x11d)),_0x1d180c=(0x0,moment_1['default'])(_0x2e2f6b)[_0x434b8d(0x101)]('DD/MM/yyyy'),_0x137f34=(0x0,moment_1['default'])(_0x1d180c,_0x434b8d(0x11d))[_0x434b8d(0x14a)]((0x0,moment_1['default'])(_0x1f05b2,_0x434b8d(0x11d))),_0x3d1eb9=moment_1[_0x434b8d(0x139)][_0x434b8d(0x174)](_0x137f34)[_0x434b8d(0x129)]();if(_0x3d1eb9<0x14){const _0x4a0a33=await Plan_1['default'][_0x434b8d(0x136)](_0x15548f[_0x434b8d(0x14c)]);let _0x1269c9=await Invoices_1[_0x434b8d(0x139)][_0x434b8d(0x127)]({'where':{'companyId':_0x15548f['id'],'dueDate':{[sequelize_1['Op'][_0x434b8d(0x172)]]:(0x0,moment_1[_0x434b8d(0x139)])(_0x2e2f6b)[_0x434b8d(0x101)]('YYYY-MM-DD')}}});if(+_0x1269c9===0x0){const _0x5cb12e=(0x0,moment_1[_0x434b8d(0x139)])()[_0x434b8d(0x101)]();await Invoices_1[_0x434b8d(0x139)]['create']({'detail':_0x4a0a33['name'],'status':_0x434b8d(0x126),'value':_0x4a0a33[_0x434b8d(0x100)],'updatedAt':_0x5cb12e,'createdAt':_0x5cb12e,'dueDate':(0x0,moment_1[_0x434b8d(0x139)])(_0x2e2f6b)['format'](_0x434b8d(0xf5)),'companyId':_0x15548f['id']});}}});}async function startQueueProcess(){const _0x5961ee=a308_0x1d5dcb;logger_1[_0x5961ee(0x135)][_0x5961ee(0x12d)](_0x5961ee(0x114)),await exports[_0x5961ee(0xf9)][_0x5961ee(0x151)]('VerifyLoginStatus',{},{'repeat':{'every':0xea60*0x5,'key':_0x5961ee(0x166)},'removeOnComplete':!![],'removeOnFail':!![]});const _0x5c2798=new bullmq_1[(_0x5961ee(0xfc))](exports[_0x5961ee(0xf9)][_0x5961ee(0x15c)],handleLoginStatus,{'connection':connection,'removeOnFail':{'count':0x0}});_0x5c2798['on']('completed',async _0x4bc16a=>{const _0x2a50c6=_0x5961ee;logger_1['logger'][_0x2a50c6(0x12d)](_0x2a50c6(0x12a)+_0x4bc16a['name']+_0x2a50c6(0x161));}),await exports[_0x5961ee(0xf0)][_0x5961ee(0x151)]('CloseTicketsAutomatic',{},{'repeat':{'every':0x3c*0x3e8*0x5,'key':_0x5961ee(0xe0)},'removeOnComplete':!![],'removeOnFail':!![]}),await exports[_0x5961ee(0xf0)][_0x5961ee(0x151)](_0x5961ee(0x12b),{},{'repeat':{'every':0x3c*0x3e8*0x1e,'key':_0x5961ee(0x12b)},'removeOnComplete':!![],'removeOnFail':!![]});const _0x6841a7=new bullmq_1[(_0x5961ee(0xfc))](exports[_0x5961ee(0xf0)]['name'],async _0x4f9d0e=>{const _0x462f6a=_0x5961ee;if(_0x4f9d0e[_0x462f6a(0x15c)]==_0x462f6a(0xe0))await handleCloseTicketsAutomatic();else _0x4f9d0e['name']==_0x462f6a(0x12b)&&await handleInvoiceCreate();},{'connection':connection,'removeOnFail':{'count':0x0}});await exports[_0x5961ee(0x112)][_0x5961ee(0x151)](_0x5961ee(0x13a),{},{'repeat':{'every':0x3c*0x3e8*0x5,'key':_0x5961ee(0x13a)},'removeOnComplete':!![],'removeOnFail':!![]}),new campaingJob_1[(_0x5961ee(0x139))](exports[_0x5961ee(0x112)][_0x5961ee(0x15c)],connection);const _0x1f01ab=new bullmq_1['Worker'](exports[_0x5961ee(0x13f)]['name'],async _0x4f8d4b=>{const _0x48dd6d=_0x5961ee;if(_0x4f8d4b[_0x48dd6d(0x15c)]=='HandleMessageJob')await handleMessageJob(_0x4f8d4b);else{if(_0x4f8d4b[_0x48dd6d(0x15c)]==_0x48dd6d(0xea))await messageUpdateJob(_0x4f8d4b);else _0x4f8d4b[_0x48dd6d(0x15c)]==_0x48dd6d(0xe2)&&await handleSendMessage(_0x4f8d4b);}},{'connection':connection,'concurrency':0x64,'removeOnFail':{'count':0x0}});_0x1f01ab['on']('completed',async _0x18580b=>{const _0x18ce9c=_0x5961ee;logger_1[_0x18ce9c(0x135)][_0x18ce9c(0x12d)](_0x18ce9c(0x12a)+_0x18580b[_0x18ce9c(0x15c)]+_0x18ce9c(0x161));}),_0x1f01ab['on']('failed',async(_0x565a69,_0x5b4b8a)=>{const _0x24763e=_0x5961ee;logger_1['logger']['error'](_0x24763e(0x12a)+_0x565a69['name']+_0x24763e(0xe6)+_0x5b4b8a[_0x24763e(0x13b)]);}),await exports[_0x5961ee(0x167)][_0x5961ee(0x151)](_0x5961ee(0x107),{},{'repeat':{'every':0x3c*0x3e8*0x2,'key':_0x5961ee(0x107)},'removeOnComplete':!![],'removeOnFail':!![]});const _0x3d7877=new bullmq_1['Worker'](exports[_0x5961ee(0x167)][_0x5961ee(0x15c)],async _0x176179=>{const _0x259098=_0x5961ee;_0x176179['name']==_0x259098(0x107)&&await handleVerifyQueue(_0x176179);},{'connection':connection,'removeOnFail':{'count':0x0}});_0x3d7877['on'](_0x5961ee(0x15d),async _0x418573=>{const _0x363998=_0x5961ee;logger_1[_0x363998(0x135)]['info'](_0x363998(0x12a)+_0x418573['id']+_0x363998(0x161));});let _0x5d65e1=new scheduledMessageJob_1[(_0x5961ee(0x139))](exports[_0x5961ee(0x130)],connection);await _0x5d65e1['getQueue']()['add']('VerifySchedules',{},{'repeat':{'every':0xea60*0x5,'key':'verify'},'removeOnComplete':!![],'removeOnFail':!![]});}exports[a308_0x1d5dcb(0xf7)]=startQueueProcess;