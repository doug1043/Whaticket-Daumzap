'use strict';const a426_0x19cb1a=a426_0x3a1e;(function(_0x3a8bee,_0x27c255){const _0x1db7d7=a426_0x3a1e,_0x54dba1=_0x3a8bee();while(!![]){try{const _0x581c00=parseInt(_0x1db7d7(0x232))/0x1*(parseInt(_0x1db7d7(0x280))/0x2)+-parseInt(_0x1db7d7(0x2f7))/0x3+-parseInt(_0x1db7d7(0x27a))/0x4+parseInt(_0x1db7d7(0x21c))/0x5*(-parseInt(_0x1db7d7(0x1bd))/0x6)+parseInt(_0x1db7d7(0x248))/0x7+parseInt(_0x1db7d7(0x1f3))/0x8+parseInt(_0x1db7d7(0x2da))/0x9;if(_0x581c00===_0x27c255)break;else _0x54dba1['push'](_0x54dba1['shift']());}catch(_0x28d865){_0x54dba1['push'](_0x54dba1['shift']());}}}(a426_0x124e,0xe3952));var __createBinding=this&&this[a426_0x19cb1a(0x28e)]||(Object['create']?function(_0x3c766b,_0x3cca1c,_0x49372f,_0x3f2622){const _0x4c3a82=a426_0x19cb1a;if(_0x3f2622===undefined)_0x3f2622=_0x49372f;var _0x5b27ce=Object[_0x4c3a82(0x29a)](_0x3cca1c,_0x49372f);(!_0x5b27ce||(_0x4c3a82(0x21d)in _0x5b27ce?!_0x3cca1c[_0x4c3a82(0x295)]:_0x5b27ce[_0x4c3a82(0x1f4)]||_0x5b27ce[_0x4c3a82(0x2ef)]))&&(_0x5b27ce={'enumerable':!![],'get':function(){return _0x3cca1c[_0x49372f];}}),Object[_0x4c3a82(0x253)](_0x3c766b,_0x3f2622,_0x5b27ce);}:function(_0x518983,_0x1ada9f,_0x268726,_0x36dd6f){if(_0x36dd6f===undefined)_0x36dd6f=_0x268726;_0x518983[_0x36dd6f]=_0x1ada9f[_0x268726];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a426_0x19cb1a(0x215)]?function(_0x2f24e0,_0x1bbad0){const _0x39e7a3=a426_0x19cb1a;Object['defineProperty'](_0x2f24e0,_0x39e7a3(0x1d0),{'enumerable':!![],'value':_0x1bbad0});}:function(_0x3127a0,_0x2be890){const _0x388626=a426_0x19cb1a;_0x3127a0[_0x388626(0x1d0)]=_0x2be890;}),__importStar=this&&this[a426_0x19cb1a(0x233)]||(function(){const _0x1d8f3a=(function(){let _0x32e49c=!![];return function(_0x2d2110,_0x21b347){const _0x454bd5=_0x32e49c?function(){const _0xf9f7fa=a426_0x3a1e;if(_0x21b347){const _0x2f928b=_0x21b347[_0xf9f7fa(0x24b)](_0x2d2110,arguments);return _0x21b347=null,_0x2f928b;}}:function(){};return _0x32e49c=![],_0x454bd5;};}()),_0x1973dd=_0x1d8f3a(this,function(){const _0x5e23e4=a426_0x3a1e;return _0x1973dd[_0x5e23e4(0x242)]()['search']('(((.+)+)+)+$')['toString']()[_0x5e23e4(0x2eb)](_0x1973dd)[_0x5e23e4(0x2e8)](_0x5e23e4(0x201));});_0x1973dd();var _0x2c3983=function(_0x21c137){const _0x3de2db=a426_0x3a1e;return _0x2c3983=Object[_0x3de2db(0x2d6)]||function(_0x38f757){const _0x1cf4e6=_0x3de2db;var _0x57a5f5=[];for(var _0x3f8f9f in _0x38f757)if(Object[_0x1cf4e6(0x26e)][_0x1cf4e6(0x2ee)][_0x1cf4e6(0x22b)](_0x38f757,_0x3f8f9f))_0x57a5f5[_0x57a5f5[_0x1cf4e6(0x2d3)]]=_0x3f8f9f;return _0x57a5f5;},_0x2c3983(_0x21c137);};return function(_0x300623){const _0x242a2c=a426_0x3a1e;if(_0x300623&&_0x300623[_0x242a2c(0x295)])return _0x300623;var _0x3e9ddb={};if(_0x300623!=null){for(var _0x4f2341=_0x2c3983(_0x300623),_0x34dc8a=0x0;_0x34dc8a<_0x4f2341['length'];_0x34dc8a++)if(_0x4f2341[_0x34dc8a]!==_0x242a2c(0x1d0))__createBinding(_0x3e9ddb,_0x300623,_0x4f2341[_0x34dc8a]);}return __setModuleDefault(_0x3e9ddb,_0x300623),_0x3e9ddb;};}()),__importDefault=this&&this[a426_0x19cb1a(0x1d4)]||function(_0x5b45b4){const _0x276419=a426_0x19cb1a;return _0x5b45b4&&_0x5b45b4[_0x276419(0x295)]?_0x5b45b4:{'default':_0x5b45b4};};Object['defineProperty'](exports,a426_0x19cb1a(0x295),{'value':!![]}),exports[a426_0x19cb1a(0x2d7)]=exports[a426_0x19cb1a(0x1d1)]=exports[a426_0x19cb1a(0x254)]=exports[a426_0x19cb1a(0x311)]=exports[a426_0x19cb1a(0x1df)]=exports[a426_0x19cb1a(0x23c)]=exports[a426_0x19cb1a(0x229)]=exports[a426_0x19cb1a(0x2b8)]=void 0x0,exports[a426_0x19cb1a(0x274)]=handleWhatsappAutoRestart,exports[a426_0x19cb1a(0x256)]=parseToMilliseconds,exports[a426_0x19cb1a(0x296)]=sleep,exports[a426_0x19cb1a(0x305)]=randomValue,exports[a426_0x19cb1a(0x29d)]=startQueueProcess;const Sentry=__importStar(require(a426_0x19cb1a(0x21f))),bull_1=__importDefault(require('bull')),moment_1=__importDefault(require(a426_0x19cb1a(0x21b))),sequelize_1=require(a426_0x19cb1a(0x2f9)),lodash_1=require(a426_0x19cb1a(0x283)),path_1=__importDefault(require(a426_0x19cb1a(0x226))),fs_1=__importDefault(require('fs')),cron_1=require(a426_0x19cb1a(0x1ed)),SendMessage_1=require(a426_0x19cb1a(0x236)),Whatsapp_1=__importDefault(require('./models/Whatsapp')),logger_1=require(a426_0x19cb1a(0x2a7)),Schedule_1=__importDefault(require('./models/Schedule')),Contact_1=__importDefault(require(a426_0x19cb1a(0x1cd))),GetDefaultWhatsApp_1=__importDefault(require(a426_0x19cb1a(0x2a4))),Campaign_1=__importDefault(require('./models/Campaign')),ContactList_1=__importDefault(require(a426_0x19cb1a(0x1ca))),ContactListItem_1=__importDefault(require(a426_0x19cb1a(0x1a0))),CampaignSetting_1=__importDefault(require(a426_0x19cb1a(0x1a8))),CampaignShipping_1=__importDefault(require(a426_0x19cb1a(0x22f))),CampaignLog_1=__importDefault(require('./models/CampaignLog')),TagLog_1=__importDefault(require(a426_0x19cb1a(0x26d))),GetWhatsappWbot_1=__importDefault(require(a426_0x19cb1a(0x1a6))),database_1=__importDefault(require(a426_0x19cb1a(0x1c1))),SendWhatsAppMedia_1=require('./services/WbotServices/SendWhatsAppMedia'),socket_1=require(a426_0x19cb1a(0x212)),User_1=__importDefault(require(a426_0x19cb1a(0x1f1))),Company_1=__importDefault(require(a426_0x19cb1a(0x30d))),Plan_1=__importDefault(require(a426_0x19cb1a(0x2ce))),wbotMessageListener_1=require(a426_0x19cb1a(0x1ac)),ShowService_1=__importDefault(require(a426_0x19cb1a(0x277))),Mustache_1=__importDefault(require(a426_0x19cb1a(0x2a1))),Ticket_1=__importDefault(require('./models/Ticket')),SendWhatsAppMessage_1=__importDefault(require(a426_0x19cb1a(0x19e))),wbot_1=require(a426_0x19cb1a(0x245)),StartWhatsAppSession_1=require(a426_0x19cb1a(0x2c1)),Message_1=__importDefault(require(a426_0x19cb1a(0x1e6))),connection=process[a426_0x19cb1a(0x273)][a426_0x19cb1a(0x234)]||'',limiterMax=process[a426_0x19cb1a(0x273)]['REDIS_OPT_LIMITER_MAX']||0x1,limiterDuration=process[a426_0x19cb1a(0x273)][a426_0x19cb1a(0x30c)]||0xbb8;exports[a426_0x19cb1a(0x2b8)]=new bull_1[(a426_0x19cb1a(0x1d0))](a426_0x19cb1a(0x28d),connection),exports[a426_0x19cb1a(0x229)]=new bull_1[(a426_0x19cb1a(0x1d0))](a426_0x19cb1a(0x251),connection,{'limiter':{'max':limiterMax,'duration':limiterDuration}}),exports[a426_0x19cb1a(0x23c)]=new bull_1[(a426_0x19cb1a(0x1d0))](a426_0x19cb1a(0x289),connection),exports[a426_0x19cb1a(0x1df)]=new bull_1['default'](a426_0x19cb1a(0x266),connection),exports[a426_0x19cb1a(0x311)]=new bull_1[(a426_0x19cb1a(0x1d0))](a426_0x19cb1a(0x2f0),connection);async function handleWhatsappAutoRestart(){const _0x574af3=a426_0x19cb1a;try{const _0x272f12=await Whatsapp_1[_0x574af3(0x1d0)][_0x574af3(0x24c)]({'where':{'automaticRestart':!![],'status':_0x574af3(0x2ea)}}),_0x3f83ff=new Date();for(const _0x418e41 of _0x272f12){const _0x252836=_0x418e41[_0x574af3(0x263)]||_0x418e41[_0x574af3(0x1f6)]||_0x418e41[_0x574af3(0x200)];shouldRestart(_0x3f83ff,_0x252836,_0x418e41[_0x574af3(0x307)])&&(logger_1[_0x574af3(0x2ab)][_0x574af3(0x207)]('Reiniciando\x20conexÃ£o\x20WhatsApp\x20'+_0x418e41[_0x574af3(0x260)]+'\x20(ID:\x20'+_0x418e41['id']+')\x20de\x20acordo\x20com\x20o\x20perÃ­odo\x20('+_0x418e41[_0x574af3(0x307)]+')'),await(0x0,wbot_1['removeWbot'])(_0x418e41['id'],![]),await new Promise(_0x470dc6=>setTimeout(_0x470dc6,0xbb8)),await(0x0,StartWhatsAppSession_1[_0x574af3(0x1fa)])(_0x418e41,_0x418e41[_0x574af3(0x243)]),await _0x418e41[_0x574af3(0x210)]({'lastRestartAt':new Date()}));}}catch(_0x4eb05e){logger_1[_0x574af3(0x2ab)][_0x574af3(0x30f)](_0x574af3(0x312)+_0x4eb05e[_0x574af3(0x1c6)]);}}exports[a426_0x19cb1a(0x254)]=new bull_1[(a426_0x19cb1a(0x1d0))](a426_0x19cb1a(0x1e8),connection),exports['whatsappRestartQueue']=new bull_1[(a426_0x19cb1a(0x1d0))](a426_0x19cb1a(0x259),connection);function shouldRestart(_0x2ce1d2,_0x5004b9,_0x115c27){const _0x386012=a426_0x19cb1a;if(_0x115c27===_0x386012(0x309))return(0x0,moment_1['default'])(_0x2ce1d2)[_0x386012(0x237)]((0x0,moment_1['default'])(_0x5004b9),_0x386012(0x2b2))>=0x1;if(_0x115c27==='semanalmente')return(0x0,moment_1[_0x386012(0x1d0)])(_0x2ce1d2)[_0x386012(0x237)]((0x0,moment_1[_0x386012(0x1d0)])(_0x5004b9),_0x386012(0x244))>=0x1;if(_0x115c27===_0x386012(0x26f))return(0x0,moment_1[_0x386012(0x1d0)])(_0x2ce1d2)[_0x386012(0x237)]((0x0,moment_1[_0x386012(0x1d0)])(_0x5004b9),'months')>=0x1;return![];}async function handleVerifyTicketExpiration(){const _0x5d3db1=a426_0x19cb1a;try{const _0x7ad11e=await database_1[_0x5d3db1(0x1d0)][_0x5d3db1(0x291)](_0x5d3db1(0x19a),{'type':sequelize_1[_0x5d3db1(0x25e)][_0x5d3db1(0x30a)]});for(const _0x4ef015 of _0x7ad11e){const _0xa8bdc0=await Ticket_1[_0x5d3db1(0x1d0)]['findAll']({'where':{'status':{[sequelize_1['Op']['in']]:[_0x5d3db1(0x1af),'pending']},'whatsappId':_0x4ef015['id'],'companyId':_0x4ef015[_0x5d3db1(0x243)]},'include':[{'model':Contact_1['default'],'as':_0x5d3db1(0x247)},{'model':Message_1[_0x5d3db1(0x1d0)],'as':_0x5d3db1(0x1f0),'separate':!![],'order':[[_0x5d3db1(0x200),_0x5d3db1(0x1c9)]],'limit':0x1}]}),_0x207c33=(0x0,moment_1[_0x5d3db1(0x1d0)])();for(const _0x1fa612 of _0xa8bdc0){const _0x48d5c0=_0x1fa612[_0x5d3db1(0x1f0)]&&_0x1fa612[_0x5d3db1(0x1f0)]['length']>0x0?_0x1fa612[_0x5d3db1(0x1f0)][0x0]:null;if(!_0x48d5c0)continue;let _0x1bca4d=![];if(_0x4ef015[_0x5d3db1(0x1f5)]==='agent')_0x1bca4d=_0x48d5c0[_0x5d3db1(0x24f)]===!![];else _0x4ef015[_0x5d3db1(0x1f5)]===_0x5d3db1(0x26a)?_0x1bca4d=_0x48d5c0[_0x5d3db1(0x24f)]===![]:_0x1bca4d=!![];if(!_0x1bca4d)continue;const _0x318e2b=(0x0,moment_1['default'])(),_0x305397=(0x0,moment_1[_0x5d3db1(0x1d0)])(_0x48d5c0['createdAt']),_0x43b81c=_0x318e2b[_0x5d3db1(0x237)](_0x305397,'minutes'),_0x5d0ff2=_0x4ef015[_0x5d3db1(0x262)]>0x0&&_0x4ef015[_0x5d3db1(0x27f)];if(_0x5d0ff2){if(!_0x1fa612[_0x5d3db1(0x29b)]&&!_0x1fa612[_0x5d3db1(0x2a8)]){if(_0x43b81c>=_0x4ef015[_0x5d3db1(0x262)])try{const _0x2824df=(0x0,wbot_1[_0x5d3db1(0x2d4)])(_0x4ef015['id']);_0x2824df&&_0x2824df[_0x5d3db1(0x19d)]?(await(0x0,SendWhatsAppMessage_1['default'])({'ticket':_0x1fa612,'body':_0x4ef015[_0x5d3db1(0x27f)]}),await _0x1fa612[_0x5d3db1(0x210)]({'ticketsWithWarning':!![],'warningSentAt':new Date()},{'silent':!![]}),logger_1[_0x5d3db1(0x2ab)]['info'](_0x5d3db1(0x2f2)+_0x1fa612['id']+_0x5d3db1(0x22c)+_0x43b81c+_0x5d3db1(0x1c3))):logger_1['logger']['debug']('WhatsApp\x20#'+_0x4ef015['id']+_0x5d3db1(0x202)+_0x1fa612['id']+'.');}catch(_0x2a6bb7){Sentry['captureException'](_0x2a6bb7),logger_1[_0x5d3db1(0x2ab)][_0x5d3db1(0x30f)](_0x5d3db1(0x29c)+_0x2a6bb7[_0x5d3db1(0x1c6)]);}}else{if(_0x1fa612[_0x5d3db1(0x2a8)]){const _0x4e3b03=(0x0,moment_1[_0x5d3db1(0x1d0)])(_0x1fa612[_0x5d3db1(0x2a8)]),_0x3518c0=_0x318e2b[_0x5d3db1(0x237)](_0x4e3b03,_0x5d3db1(0x2cc));if(_0x3518c0>=_0x4ef015[_0x5d3db1(0x22a)])try{if(_0x4ef015[_0x5d3db1(0x24d)])try{const _0x10104e=(0x0,wbot_1[_0x5d3db1(0x2d4)])(_0x4ef015['id']);_0x10104e&&_0x10104e[_0x5d3db1(0x19d)]?(await(0x0,SendWhatsAppMessage_1['default'])({'ticket':_0x1fa612,'body':_0x4ef015[_0x5d3db1(0x24d)]}),await new Promise(_0x198fab=>setTimeout(_0x198fab,0x3e8))):logger_1['logger'][_0x5d3db1(0x29f)](_0x5d3db1(0x1d5)+_0x4ef015['id']+_0x5d3db1(0x1d2)+_0x1fa612['id']+'.');}catch(_0x2a86ca){logger_1[_0x5d3db1(0x2ab)][_0x5d3db1(0x1d8)]('Erro\x20ao\x20enviar\x20mensagem\x20de\x20encerramento\x20para\x20ticket\x20#'+_0x1fa612['id']+':\x20'+_0x2a86ca[_0x5d3db1(0x1c6)]);}const _0x177c8c=_0x1fa612[_0x5d3db1(0x1b9)];await _0x1fa612[_0x5d3db1(0x210)]({'status':'closed','amountUsedBotQueues':0x0,'ticketsWithWarning':![],'warningSentAt':null});const _0x582fde=(0x0,socket_1['getIO'])();if(_0x177c8c==='open')_0x582fde['to']('company-'+_0x1fa612[_0x5d3db1(0x243)]+_0x5d3db1(0x302))['to'](_0x5d3db1(0x211)+_0x1fa612['queueId']+_0x5d3db1(0x302))[_0x5d3db1(0x24a)](_0x5d3db1(0x2fb)+_0x1fa612['companyId']+_0x5d3db1(0x304),{'action':_0x5d3db1(0x210),'ticket':{..._0x1fa612[_0x5d3db1(0x2fa)],'status':_0x5d3db1(0x1b6)}});else _0x177c8c===_0x5d3db1(0x252)&&_0x582fde['to'](_0x5d3db1(0x2fb)+_0x1fa612['companyId']+_0x5d3db1(0x278))['emit']('company-'+_0x1fa612[_0x5d3db1(0x243)]+_0x5d3db1(0x304),{'action':_0x5d3db1(0x210),'ticket':{..._0x1fa612[_0x5d3db1(0x2fa)],'status':_0x5d3db1(0x1b6)}});logger_1[_0x5d3db1(0x2ab)]['info'](_0x5d3db1(0x28c)+_0x1fa612['id']+_0x5d3db1(0x214)+_0x3518c0+_0x5d3db1(0x1ef)+_0x43b81c+_0x5d3db1(0x281));}catch(_0x2ae434){Sentry[_0x5d3db1(0x2ff)](_0x2ae434),logger_1[_0x5d3db1(0x2ab)]['error'](_0x5d3db1(0x2ed)+_0x1fa612['id']+':\x20'+_0x2ae434[_0x5d3db1(0x1c6)]);}}}}else{if(_0x43b81c>=_0x4ef015[_0x5d3db1(0x22a)])try{if(_0x4ef015[_0x5d3db1(0x24d)])try{const _0x441248=(0x0,wbot_1[_0x5d3db1(0x2d4)])(_0x4ef015['id']);_0x441248&&_0x441248[_0x5d3db1(0x19d)]?(await(0x0,SendWhatsAppMessage_1[_0x5d3db1(0x1d0)])({'ticket':_0x1fa612,'body':_0x4ef015[_0x5d3db1(0x24d)]}),await new Promise(_0x486c09=>setTimeout(_0x486c09,0x3e8))):logger_1[_0x5d3db1(0x2ab)][_0x5d3db1(0x29f)](_0x5d3db1(0x1d5)+_0x4ef015['id']+_0x5d3db1(0x1d2)+_0x1fa612['id']+'.');}catch(_0x69ec32){logger_1[_0x5d3db1(0x2ab)][_0x5d3db1(0x1d8)](_0x5d3db1(0x2f8)+_0x1fa612['id']+':\x20'+_0x69ec32[_0x5d3db1(0x1c6)]);}const _0x3d1ab4=_0x1fa612[_0x5d3db1(0x1b9)];await _0x1fa612[_0x5d3db1(0x210)]({'status':_0x5d3db1(0x1b6),'amountUsedBotQueues':0x0,'ticketsWithWarning':![],'warningSentAt':null});const _0x4b32be=(0x0,socket_1[_0x5d3db1(0x2a5)])();if(_0x3d1ab4===_0x5d3db1(0x1af))_0x4b32be['to']('company-'+_0x1fa612['companyId']+_0x5d3db1(0x302))['to'](_0x5d3db1(0x211)+_0x1fa612[_0x5d3db1(0x1db)]+_0x5d3db1(0x302))[_0x5d3db1(0x24a)](_0x5d3db1(0x2fb)+_0x1fa612['companyId']+_0x5d3db1(0x304),{'action':'update','ticket':{..._0x1fa612['dataValues'],'status':'closed'}});else _0x3d1ab4===_0x5d3db1(0x252)&&_0x4b32be['to'](_0x5d3db1(0x2fb)+_0x1fa612[_0x5d3db1(0x243)]+_0x5d3db1(0x278))[_0x5d3db1(0x24a)](_0x5d3db1(0x2fb)+_0x1fa612[_0x5d3db1(0x243)]+_0x5d3db1(0x304),{'action':_0x5d3db1(0x210),'ticket':{..._0x1fa612[_0x5d3db1(0x2fa)],'status':_0x5d3db1(0x1b6)}});_0x4b32be['to'](_0x5d3db1(0x2fb)+_0x1fa612['companyId']+'-closed')[_0x5d3db1(0x24a)](_0x5d3db1(0x2fb)+_0x1fa612[_0x5d3db1(0x243)]+_0x5d3db1(0x304),{'action':_0x5d3db1(0x210),'ticket':{..._0x1fa612['dataValues'],'status':_0x5d3db1(0x1b6)}}),logger_1['logger'][_0x5d3db1(0x207)](_0x5d3db1(0x28c)+_0x1fa612['id']+'\x20fechado\x20por\x20inatividade\x20apÃ³s\x20'+_0x43b81c+_0x5d3db1(0x1b1)+_0x4ef015['expiresTicket']+_0x5d3db1(0x1bf));}catch(_0x5e1046){Sentry[_0x5d3db1(0x2ff)](_0x5e1046),logger_1[_0x5d3db1(0x2ab)][_0x5d3db1(0x30f)](_0x5d3db1(0x2ed)+_0x1fa612['id']+':\x20'+_0x5e1046[_0x5d3db1(0x1c6)]);}}}}}catch(_0x1a12df){Sentry['captureException'](_0x1a12df),logger_1['logger'][_0x5d3db1(0x30f)]({'error':_0x1a12df},_0x5d3db1(0x20e));}}exports['campaignQueue']=new bull_1[(a426_0x19cb1a(0x1d0))]('CampaignQueue',connection);async function handleSendMessage(_0x1dcf53){const _0x3e3d4e=a426_0x19cb1a;try{const {data:_0x29098b}=_0x1dcf53,_0xb4bc9f=await Whatsapp_1[_0x3e3d4e(0x1d0)][_0x3e3d4e(0x249)](_0x29098b[_0x3e3d4e(0x1ae)]);if(_0xb4bc9f==null)throw Error(_0x3e3d4e(0x2cf));const _0x1f7883=_0x29098b['data'];await(0x0,SendMessage_1[_0x3e3d4e(0x27b)])(_0xb4bc9f,_0x1f7883);}catch(_0x4653af){Sentry[_0x3e3d4e(0x2ff)](_0x4653af),logger_1['logger']['error']({'error':_0x4653af},'MessageQueue\x20->\x20SendMessage:\x20error');throw _0x4653af;}}async function handleVerifySchedules(){const _0x8eafae=a426_0x19cb1a;try{const {count:_0x149990,rows:_0x3e35d9}=await Schedule_1[_0x8eafae(0x1d0)][_0x8eafae(0x255)]({'where':{'status':_0x8eafae(0x1c5),'sentAt':null,'sendAt':{[sequelize_1['Op'][_0x8eafae(0x2ec)]]:(0x0,moment_1[_0x8eafae(0x1d0)])()[_0x8eafae(0x23d)](0x1,'hour')[_0x8eafae(0x1a4)](_0x8eafae(0x217)),[sequelize_1['Op'][_0x8eafae(0x2d9)]]:(0x0,moment_1['default'])()['add'](0x1e,_0x8eafae(0x2bc))[_0x8eafae(0x1a4)](_0x8eafae(0x217))}},'include':[{'model':Contact_1[_0x8eafae(0x1d0)],'as':_0x8eafae(0x247)}]});_0x149990>0x0&&_0x3e35d9[_0x8eafae(0x1eb)](async _0x480299=>{const _0x53a3e6=_0x8eafae;await _0x480299['update']({'status':_0x53a3e6(0x258)}),exports[_0x53a3e6(0x1df)][_0x53a3e6(0x1d3)](_0x53a3e6(0x27b),{'schedule':_0x480299},{'delay':0x9c40}),logger_1['logger'][_0x53a3e6(0x207)]('Disparo\x20agendado\x20para:\x20'+_0x480299[_0x53a3e6(0x247)][_0x53a3e6(0x260)]);});}catch(_0xe2223e){Sentry[_0x8eafae(0x2ff)](_0xe2223e),logger_1[_0x8eafae(0x2ab)][_0x8eafae(0x30f)]({'error':_0xe2223e},_0x8eafae(0x1bb));throw _0xe2223e;}}function a426_0x3a1e(_0x32144a,_0x46af15){const _0x440d76=a426_0x124e();return a426_0x3a1e=function(_0x526869,_0x1dbc86){_0x526869=_0x526869-0x19a;let _0x124e58=_0x440d76[_0x526869];return _0x124e58;},a426_0x3a1e(_0x32144a,_0x46af15);}async function handleSendScheduledMessage(_0x42b2b4){const _0x9096e6=a426_0x19cb1a,{data:{schedule:_0x35d4e3}}=_0x42b2b4;let _0x2132a4=null;try{_0x2132a4=await Schedule_1[_0x9096e6(0x1d0)][_0x9096e6(0x249)](_0x35d4e3['id'],{'include':[{'model':Contact_1['default'],'as':_0x9096e6(0x247)}]});if(!_0x2132a4){logger_1[_0x9096e6(0x2ab)][_0x9096e6(0x207)]('Agendamento\x20'+_0x35d4e3['id']+_0x9096e6(0x1b0));return;}if(_0x2132a4[_0x9096e6(0x1b9)]===_0x9096e6(0x2ad)||_0x2132a4[_0x9096e6(0x224)]){logger_1[_0x9096e6(0x2ab)][_0x9096e6(0x207)](_0x9096e6(0x23e)+_0x35d4e3['id']+_0x9096e6(0x308));return;}}catch(_0x2b911c){Sentry[_0x9096e6(0x2ff)](_0x2b911c),logger_1[_0x9096e6(0x2ab)]['info'](_0x9096e6(0x2ae)+_0x35d4e3['id']);return;}try{const _0x27c5e9=await(0x0,GetDefaultWhatsApp_1[_0x9096e6(0x1d0)])(_0x2132a4['companyId']),_0x2629a9=await(0x0,GetWhatsappWbot_1['default'])(_0x27c5e9),_0x30f4e5=_0x2132a4['contact'][_0x9096e6(0x264)]['toString'](),_0x153274=_0x30f4e5['includes']('@')?_0x30f4e5:_0x30f4e5+'@'+(_0x30f4e5[_0x9096e6(0x2d3)]>0xd?_0x9096e6(0x1c8):_0x9096e6(0x250)),_0x5c29dc={'contact':_0x2132a4[_0x9096e6(0x247)],'queue':null,'company':null,'user':null,'whatsapp':_0x27c5e9},_0x2b0f1b=(0x0,Mustache_1['default'])(_0x2132a4[_0x9096e6(0x2db)],_0x5c29dc),_0x681916=await(0x0,SendMessage_1['SendMessage'])(_0x27c5e9,{'number':_0x2132a4[_0x9096e6(0x247)][_0x9096e6(0x264)],'body':_0x2b0f1b});if(_0x2132a4[_0x9096e6(0x2e1)]){const _0x2df2b9=_0x2132a4['mediaPath'];let _0x404c9b={};if(_0x2df2b9['startsWith'](_0x9096e6(0x2c3))||_0x2df2b9['startsWith'](_0x9096e6(0x23f))){const _0x40660a=require(_0x9096e6(0x1fd)),_0x335281=require('mime-types'),_0xe177d2=await _0x40660a({'url':_0x2df2b9,'method':'GET','responseType':'arraybuffer'}),_0x6c1c7=_0x335281[_0x9096e6(0x221)](_0xe177d2[_0x9096e6(0x2a0)][_0x9096e6(0x2b9)])||_0x9096e6(0x290),_0x48f3a5='temp_schedule_'+Date[_0x9096e6(0x271)]()+'.'+_0x6c1c7,_0x334b1c=path_1[_0x9096e6(0x1d0)][_0x9096e6(0x1dd)](_0x9096e6(0x20d),_0x48f3a5);fs_1[_0x9096e6(0x1d0)][_0x9096e6(0x225)](_0x334b1c,_0xe177d2[_0x9096e6(0x2f3)]),_0x404c9b=await(0x0,SendWhatsAppMedia_1[_0x9096e6(0x2ba)])(_0x2132a4[_0x9096e6(0x1e2)]||_0x48f3a5,_0x334b1c),Object[_0x9096e6(0x1b4)](_0x404c9b)[_0x9096e6(0x2d3)]&&await _0x2629a9[_0x9096e6(0x219)](_0x153274,{..._0x404c9b}),setTimeout(()=>{const _0x114c56=_0x9096e6;try{fs_1[_0x114c56(0x1d0)][_0x114c56(0x1de)](_0x334b1c);}catch(_0xa03245){}},0x1388);}else{let _0x4219a2=path_1['default'][_0x9096e6(0x1dd)](_0x9096e6(0x20d),_0x2df2b9);!fs_1['default'][_0x9096e6(0x1f2)](_0x4219a2)&&(_0x4219a2=path_1[_0x9096e6(0x1d0)][_0x9096e6(0x1dd)](_0x9096e6(0x20d),_0x9096e6(0x1b3),_0x2df2b9)),fs_1[_0x9096e6(0x1d0)][_0x9096e6(0x1f2)](_0x4219a2)&&(_0x404c9b=await(0x0,SendWhatsAppMedia_1[_0x9096e6(0x2ba)])(_0x2132a4['mediaName'],_0x4219a2),Object[_0x9096e6(0x1b4)](_0x404c9b)[_0x9096e6(0x2d3)]&&await _0x2629a9[_0x9096e6(0x219)](_0x153274,{..._0x404c9b}));}}_0x2132a4[_0x9096e6(0x2d1)]&&(0x0,wbotMessageListener_1[_0x9096e6(0x2c7)])(_0x681916,await(0x0,GetWhatsappWbot_1[_0x9096e6(0x1d0)])(_0x27c5e9),_0x2132a4[_0x9096e6(0x243)]);await _0x2132a4[_0x9096e6(0x210)]({'sentAt':new Date(),'status':_0x9096e6(0x2ad)}),logger_1[_0x9096e6(0x2ab)][_0x9096e6(0x207)]('Mensagem\x20agendada\x20enviada\x20para:\x20'+_0x2132a4[_0x9096e6(0x247)][_0x9096e6(0x260)]);_0x2132a4[_0x9096e6(0x23b)]&&await createTagLog(_0x2132a4[_0x9096e6(0x23b)],_0x2132a4[_0x9096e6(0x243)],'send',{'contact':_0x2132a4[_0x9096e6(0x247)][_0x9096e6(0x260)],'phoneNumber':_0x2132a4['contact'][_0x9096e6(0x264)],'message':_0x2b0f1b,'metadata':{'sentAt':new Date(),'messageId':_0x681916[_0x9096e6(0x2d2)]['id']}});if(_0x2132a4['daysR']&&_0x2132a4['daysR']>0x0){const _0x1b6cc9=new Date(_0x2132a4['sendAt']);_0x1b6cc9[_0x9096e6(0x2a2)](_0x1b6cc9['getDate']()+_0x2132a4[_0x9096e6(0x2e9)]),logger_1[_0x9096e6(0x2ab)]['info'](_0x9096e6(0x24e)+_0x2132a4[_0x9096e6(0x2e9)]+_0x9096e6(0x1ee)+_0x1b6cc9[_0x9096e6(0x1cf)]());try{await Schedule_1[_0x9096e6(0x1d0)][_0x9096e6(0x215)]({'body':_0x2132a4[_0x9096e6(0x2db)],'sendAt':_0x1b6cc9,'contactId':_0x2132a4[_0x9096e6(0x20f)],'companyId':_0x2132a4[_0x9096e6(0x243)],'userId':_0x2132a4[_0x9096e6(0x19f)],'saveMessage':_0x2132a4['saveMessage'],'status':'PENDENTE','campId':_0x2132a4[_0x9096e6(0x23b)],'daysR':_0x2132a4[_0x9096e6(0x2e9)],'mediaPath':_0x2132a4[_0x9096e6(0x2e1)],'mediaName':_0x2132a4[_0x9096e6(0x1e2)]}),logger_1[_0x9096e6(0x2ab)]['info'](_0x9096e6(0x1ad)+_0x1b6cc9['toISOString']());}catch(_0x3361e8){logger_1['logger'][_0x9096e6(0x30f)](_0x9096e6(0x261)+_0x3361e8);}}exports[_0x9096e6(0x1df)][_0x9096e6(0x293)](0x3a98,_0x9096e6(0x301));}catch(_0x3c1fe3){Sentry[_0x9096e6(0x2ff)](_0x3c1fe3),await _0x2132a4?.[_0x9096e6(0x210)]({'status':'ERRO'});_0x2132a4?.['campId']&&await createTagLog(_0x2132a4[_0x9096e6(0x23b)],_0x2132a4[_0x9096e6(0x243)],_0x9096e6(0x30f),{'contact':_0x2132a4[_0x9096e6(0x247)]?.[_0x9096e6(0x260)],'phoneNumber':_0x2132a4[_0x9096e6(0x247)]?.[_0x9096e6(0x264)],'message':_0x2132a4[_0x9096e6(0x2db)],'metadata':{'error':_0x3c1fe3[_0x9096e6(0x1c6)]}});logger_1[_0x9096e6(0x2ab)]['error']({'error':_0x3c1fe3},_0x9096e6(0x239));throw _0x3c1fe3;}}async function handleVerifyCampaigns(){const _0x24d8e0=a426_0x19cb1a;logger_1[_0x24d8e0(0x2ab)][_0x24d8e0(0x207)](_0x24d8e0(0x2f1));const _0x22b870=await database_1['default'][_0x24d8e0(0x291)](_0x24d8e0(0x1da),{'type':sequelize_1[_0x24d8e0(0x25e)][_0x24d8e0(0x30a)]});_0x22b870[_0x24d8e0(0x2d3)]?(logger_1[_0x24d8e0(0x2ab)][_0x24d8e0(0x207)](_0x24d8e0(0x1b2)+_0x22b870[_0x24d8e0(0x2d3)]),_0x22b870[_0x24d8e0(0x1c0)](_0x4ecd54=>{const _0x19a080=_0x24d8e0;logger_1[_0x19a080(0x2ab)][_0x19a080(0x207)]('\x20\x20ðŸ“‹\x20Campanha\x20ID='+_0x4ecd54['id']+',\x20Agendada\x20para:\x20'+_0x4ecd54['scheduledAt']);})):logger_1[_0x24d8e0(0x2ab)][_0x24d8e0(0x207)](_0x24d8e0(0x21a)),_0x22b870[_0x24d8e0(0x1c0)](async _0x33eea0=>{const _0x56bef5=_0x24d8e0;try{const _0x44f36f=await exports[_0x56bef5(0x2d7)][_0x56bef5(0x29e)]([_0x56bef5(0x213),_0x56bef5(0x282),_0x56bef5(0x2e5)]),_0x304389=_0x44f36f[_0x56bef5(0x23a)](_0x29adad=>_0x29adad&&_0x29adad['data']&&_0x29adad[_0x56bef5(0x260)]===_0x56bef5(0x2d0)&&_0x29adad[_0x56bef5(0x2f3)]['id']===_0x33eea0['id']);if(_0x304389){logger_1['logger'][_0x56bef5(0x207)](_0x56bef5(0x30e)+_0x33eea0['id']+_0x56bef5(0x2d5));return;}const _0x5eabfb=(0x0,moment_1[_0x56bef5(0x1d0)])(),_0x399c9c=(0x0,moment_1[_0x56bef5(0x1d0)])(_0x33eea0['scheduledAt']),_0xb3547c=_0x399c9c[_0x56bef5(0x237)](_0x5eabfb,_0x56bef5(0x265));_0xb3547c<0x0&&logger_1['logger'][_0x56bef5(0x1d8)](_0x56bef5(0x206)+_0x33eea0['id']+'\x20estÃ¡\x20atrasada!\x20Executando\x20imediatamente...'),logger_1[_0x56bef5(0x2ab)]['info'](_0x56bef5(0x2b5)+_0x33eea0['id']+_0x56bef5(0x303)+_0xb3547c+_0x56bef5(0x1f9)+(_0xb3547c/0x3e8)[_0x56bef5(0x2ac)](0x1)+'s)'),await exports[_0x56bef5(0x2d7)][_0x56bef5(0x1d3)](_0x56bef5(0x2d0),{'id':_0x33eea0['id'],'delay':Math[_0x56bef5(0x1d6)](0x0,_0xb3547c)},{'removeOnComplete':!![]});}catch(_0x4c8198){Sentry['captureException'](_0x4c8198),logger_1[_0x56bef5(0x2ab)]['error']('âŒ\x20Erro\x20ao\x20processar\x20campanha\x20'+_0x33eea0['id']+':\x20'+_0x4c8198[_0x56bef5(0x1c6)]),logger_1[_0x56bef5(0x2ab)][_0x56bef5(0x30f)]('Stack:\x20'+_0x4c8198[_0x56bef5(0x246)]);}});}async function getCampaign(_0x388afc){const _0x1bed7b=a426_0x19cb1a;return Campaign_1[_0x1bed7b(0x1d0)]['findByPk'](_0x388afc,{'include':[{'model':ContactList_1['default'],'as':_0x1bed7b(0x2c9),'attributes':['id','name'],'include':[{'model':ContactListItem_1[_0x1bed7b(0x1d0)],'as':_0x1bed7b(0x1e5),'attributes':['id',_0x1bed7b(0x260),_0x1bed7b(0x264),_0x1bed7b(0x1ce),_0x1bed7b(0x2bd)],'where':{'isWhatsappValid':!![]}}]},{'model':Whatsapp_1[_0x1bed7b(0x1d0)],'as':_0x1bed7b(0x2df),'attributes':['id',_0x1bed7b(0x260)]},{'model':CampaignShipping_1['default'],'as':_0x1bed7b(0x300),'include':[{'model':ContactListItem_1[_0x1bed7b(0x1d0)],'as':_0x1bed7b(0x247)}]}]});}async function getSettings(_0x4a3416){const _0x24a7af=a426_0x19cb1a,_0x1afd17=await CampaignSetting_1[_0x24a7af(0x1d0)][_0x24a7af(0x24c)]({'where':{'companyId':_0x4a3416[_0x24a7af(0x243)]},'attributes':[_0x24a7af(0x2d2),_0x24a7af(0x203)]});let _0x445ccb=0x14,_0x355879=0x14,_0x4b3d6b=0x3c,_0x5a000d=[];return _0x1afd17['forEach'](_0x1f3f13=>{const _0x20aeec=_0x24a7af;_0x1f3f13[_0x20aeec(0x2d2)]===_0x20aeec(0x238)&&(_0x445ccb=JSON[_0x20aeec(0x1b5)](_0x1f3f13['value'])),_0x1f3f13[_0x20aeec(0x2d2)]==='longerIntervalAfter'&&(_0x355879=JSON['parse'](_0x1f3f13['value'])),_0x1f3f13[_0x20aeec(0x2d2)]==='greaterInterval'&&(_0x4b3d6b=JSON[_0x20aeec(0x1b5)](_0x1f3f13['value'])),_0x1f3f13['key']===_0x20aeec(0x2e4)&&(_0x5a000d=JSON[_0x20aeec(0x1b5)](_0x1f3f13[_0x20aeec(0x203)]));}),{'messageInterval':_0x445ccb,'longerIntervalAfter':_0x355879,'greaterInterval':_0x4b3d6b,'variables':_0x5a000d};}function parseToMilliseconds(_0x363392){return _0x363392*0x3e8;}async function sleep(_0x23aa4d){const _0x1bd92b=a426_0x19cb1a;return logger_1[_0x1bd92b(0x2ab)][_0x1bd92b(0x207)](_0x1bd92b(0x28f)+_0x23aa4d+_0x1bd92b(0x269)+(0x0,moment_1[_0x1bd92b(0x1d0)])()['format'](_0x1bd92b(0x1ff))),new Promise(_0x68bb2f=>{setTimeout(()=>{const _0x59e516=a426_0x3a1e;logger_1['logger'][_0x59e516(0x207)](_0x59e516(0x28f)+_0x23aa4d+_0x59e516(0x1f8)+(0x0,moment_1['default'])()[_0x59e516(0x1a4)](_0x59e516(0x1ff))),_0x68bb2f(!![]);},parseToMilliseconds(_0x23aa4d));});}function a426_0x124e(){const _0x158e26=['variables','active','confirmationMessage3','Campanha\x20enviada\x20para:\x20Campanha=','search','daysR','CONNECTED','constructor','gte','Erro\x20ao\x20encerrar\x20ticket\x20#','hasOwnProperty','configurable','TicketInactiveWarning','ðŸ”\x20Verificando\x20campanhas\x20programadas...','Aviso\x20de\x20inatividade\x20enviado\x20para\x20o\x20ticket\x20#','data','\x20possui\x20','UsuÃ¡rio\x20passado\x20para\x20offline:\x20','message5','2037159OUDDVF','Erro\x20ao\x20enviar\x20mensagem\x20de\x20encerramento\x20para\x20ticket\x20#','sequelize','dataValues','company-','{email}','\x20(vencimento:\x20','ðŸ§ª\x20MODO\x20TESTE\x20ATIVADO\x20-\x20Simulando\x20envio:\x20Campanha=','captureException','shipping','completed','-open',',\x20Delay=','-ticket','randomValue','DISCONNECTED','period','\x20jÃ¡\x20foi\x20enviado','diariamente','SELECT','confirmationRequestedAt','REDIS_OPT_LIMITER_DURATION','./models/Company','â­ï¸\x20\x20Campanha\x20ID=','error','\x20iniciada!\x20Status:\x20EM_ANDAMENTO','ticketInactiveWarningQueue','Erro\x20ao\x20reiniciar\x20conexÃµes\x20WhatsApp\x20periodicamente:\x20','temp_campaign_','SELECT\x20id,\x20\x22expiresTicket\x22,\x20\x22companyId\x22,\x20\x22whenExpireTicket\x22,\x0a\x20\x20\x20\x22expiresInactiveMessage\x22,\x20\x22inactiveMessage\x22,\x20\x22inactiveMessageTime\x22\x0a\x20\x20\x20FROM\x20\x22Whatsapps\x22\x20WHERE\x20\x22expiresTicket\x22\x20>\x200','\x20conexÃµes\x20da\x20empresa\x20','toDate','user','./services/WbotServices/SendWhatsAppMessage','userId','./models/ContactListItem','[Assinaturas]\x20Processando\x20empresa\x20','replace','Verify','format','Campaign\x20not\x20found','./helpers/GetWhatsappWbot','save','./models/CampaignSetting','\x20contatos\x20vÃ¡lidos','Iniciando\x20processamento\x20de\x20filas','ðŸ“Š\x20Progresso\x20Campanha\x20ID=','./services/WbotServices/wbotMessageListener','PrÃ³ximo\x20agendamento\x20criado\x20com\x20sucesso\x20para\x20','whatsappId','open','\x20nÃ£o\x20encontrado\x20ou\x20jÃ¡\x20foi\x20processado','\x20minutos\x20(configurado:\x20','âœ…\x20Campanhas\x20PROGRAMADAS\x20encontradas:\x20','media','keys','parse','closed','\x20nÃ£o\x20possui\x20lista\x20de\x20contatos\x20vinculada!','\x27,\x20\x27','status','âœ…\x20Campanha\x20ID=','SendScheduledMessage\x20->\x20Verify:\x20error','qrcode','444nryELh','valids','\x20minutos).','forEach','./database','\x27,\x20','\x20minutos\x20de\x20inatividade','DispatchCampaign','PENDENTE','message','[Assinaturas]\x20Verificando\x20empresas\x20com\x20assinatura\x20expirada...','lid','DESC','./models/ContactList','confirmationMessage2','GET','./models/Contact','email','toISOString','default','whatsappRestartQueue','\x20nÃ£o\x20conectado.\x20Pulando\x20envio\x20de\x20mensagem\x20para\x20ticket\x20#','add','__importDefault','WhatsApp\x20#','max','confirmationRequested','warn','*/20\x20*\x20*\x20*\x20*\x20*','select\x20id,\x20\x22scheduledAt\x22\x20from\x20\x22Campaigns\x22\x20c\x0a\x20\x20\x20\x20where\x20\x22scheduledAt\x22\x20between\x20now()\x20-\x20\x275\x20minutes\x27::interval\x20and\x20now()\x20+\x20\x271\x20hour\x27::interval\x20\x0a\x20\x20\x20\x20and\x20status\x20=\x20\x27PROGRAMADA\x27','queueId','startsWith','resolve','unlinkSync','sendScheduledMessages','\x27,\x20\x27open\x27,\x20\x27','findOrCreate','mediaName',',\x20Nome=\x22','\x20AND\x20\x22dueDate\x22::text\x20LIKE\x20\x27','contacts','./models/Message','[Assinaturas]\x20Erro\x20ao\x20desconectar\x20WhatsApp\x20','TicketMonitor','includes','-campaign-log','map','asDays','cron','\x20dias):\x20','\x20minutos\x20desde\x20o\x20aviso\x20(total:\x20','messages','./models/User','existsSync','11663728bHogxz','writable','whenExpireTicket','updatedAt','greaterInterval','\x20segundos\x20finalizado:\x20','ms\x20(','StartWhatsAppSession','{nome}','ðŸš€\x20Campanha\x20ID=','axios','removeWbot','HH:mm:ss','createdAt','(((.+)+)+)+$','\x20nÃ£o\x20conectado.\x20Pulando\x20envio\x20de\x20aviso\x20para\x20ticket\x20#','value','DD/MM/yyyy','campaignId','âš ï¸\x20\x20Campanha\x20ID=','info','[Assinaturas]\x20ConexÃ£o\x20','[Assinaturas]\x20Erro\x20ao\x20verificar\x20assinaturas:\x20','then','metadata','FINALIZADA','public','TicketMonitor\x20->\x20VerifyTicketExpiration:\x20erro','contactId','update','queue-','./libs/socket','waiting','\x20encerrado\x20por\x20inatividade\x20apÃ³s\x20','create','INSERT','YYYY-MM-DD\x20HH:mm:ss','[Assinaturas]\x20Nenhuma\x20empresa\x20com\x20assinatura\x20expirada\x20encontrada.','sendMessage','â„¹ï¸\x20\x20Nenhuma\x20campanha\x20programada\x20para\x20a\x20prÃ³xima\x20hora','moment','42630Xclhhm','get','-campaign','@sentry/node','s\x20(','extension','Erro\x20ao\x20criar\x20log\x20de\x20tag:\x20','EM_ANDAMENTO','sentAt','writeFileSync','path','startOf','-tag-log','messageQueue','expiresTicket','call','\x20apÃ³s\x20','{numero}','%\x27;','./models/CampaignShipping','simulation','OPENING','61LstYAM','__importStar','REDIS_URI','[Assinaturas]\x20Desconectando\x20','./helpers/SendMessage','diff','messageInterval','SendScheduledMessage\x20->\x20SendMessage:\x20error','some','campId','scheduleMonitor','subtract','Agendamento\x20','https://','*/5\x20*\x20*\x20*\x20*\x20*','confirmationMessage','toString','companyId','weeks','./libs/wbot','stack','contact','8063909qEfVlk','findByPk','emit','apply','findAll','expiresInactiveMessage','Criando\x20prÃ³ximo\x20agendamento\x20(repetiÃ§Ã£o\x20a\x20cada\x20','fromMe','s.whatsapp.net','MessageQueue','pending','defineProperty','ticketMonitor','findAndCountAll','parseToMilliseconds','VerifyLoginStatus','AGENDADA','WhatsappRestartQueue','deliveredAt','VerifyCampaignsDaatabase',';Contato=','message4','QueryTypes','dueDate','name','Erro\x20ao\x20criar\x20prÃ³ximo\x20agendamento:\x20','inactiveMessageTime','lastRestartAt','number','milliseconds','SendSacheduledMessages',')\x20desconectada.','isNil','\x20segundos\x20iniciado:\x20','customer','isEmpty','*\x20*\x20*\x20*\x20*','./models/TagLog','prototype','mensalmente','CronJob','now','DispatchConfirmedCampaign','env','handleWhatsappAutoRestart','yyyy-MM-DD','isArray','./services/CampaignService/ShowService','-pending','send','5230660KOZLLR','SendMessage','push','-mainchannel','planId','inactiveMessage','11498gTKTcQ','\x20minutos\x20desde\x20a\x20Ãºltima\x20mensagem)','delayed','lodash','message1','duration','position','confirmationMessage5','mime-types','ScheduleMonitor','confirmed','INSERT\x20INTO\x20\x22Invoices\x22\x20(detail,\x20status,\x20value,\x20\x22updatedAt\x22,\x20\x22createdAt\x22,\x20\x22dueDate\x22,\x20\x22companyId\x22)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20VALUES\x20(\x27','Ticket\x20#','UserMonitor','__createBinding','Sleep\x20de\x20','bin','query','\x20nÃ£o\x20encontrada!','clean','process','__esModule','sleep','testMode','\x22\x20nÃ£o\x20possui\x20contatos\x20vÃ¡lidos!','[Assinaturas]\x20VerificaÃ§Ã£o\x20de\x20assinaturas\x20concluÃ­da.','getOwnPropertyDescriptor','ticketsWithWarning','Erro\x20ao\x20enviar\x20aviso\x20de\x20inatividade:\x20','startQueueProcess','getJobs','debug','headers','./helpers/Mustache','setDate','message3','./helpers/GetDefaultWhatsApp','getIO','0\x20*\x20*\x20*\x20*','./utils/logger','warningSentAt','@s.whatsapp.net','\x20contatos\x20foram\x20processados.','logger','toFixed','ENVIADA','Erro\x20ao\x20tentar\x20consultar\x20agendamento:\x20','mycount','SELECT\x20COUNT(*)\x20mycount\x20FROM\x20\x22Invoices\x22\x20WHERE\x20\x22companyId\x22\x20=\x20','phoneNumber','days','confirmation','[Assinaturas]\x20Encontradas\x20','ðŸ“¤\x20Campanha\x20enviada\x20para\x20a\x20fila:\x20ID=','complete','AutoRestart','userMonitor','content-type','getMessageOptions','random','seconds','isWhatsappValid','âŒ\x20Erro\x20ao\x20processar\x20campanha:\x20','delivered','processing','./services/WbotServices/StartWhatsAppSession','Disparo\x20de\x20campanha\x20solicitado:\x20Campanha=','http://',';Registro=','confirmationMessage1','ðŸ“‹\x20Processando\x20campanha:\x20ID=','handleMessage','\x20-\x20Lista\x20\x22','contactList','set','VerifyTicketExpiration','minutes','message2','./models/Plan','Whatsapp\x20nÃ£o\x20identificado','ProcessCampaign','saveMessage','key','length','getWbot','\x20jÃ¡\x20estÃ¡\x20na\x20fila,\x20pulando...','getOwnPropertyNames','campaignQueue','\x20FINALIZADA!\x20Todos\x20os\x20','lte','5302602EqeqIw','body','start','0\x20*\x20*\x20*\x20*\x20*','floor','whatsapp','toJSON','mediaPath','confirmationMessage4','longerIntervalAfter'];a426_0x124e=function(){return _0x158e26;};return a426_0x124e();}function getCampaignValidMessages(_0x359a7e){const _0x317c6f=a426_0x19cb1a,_0x55980e=[];return!(0x0,lodash_1['isEmpty'])(_0x359a7e['message1'])&&!(0x0,lodash_1[_0x317c6f(0x268)])(_0x359a7e[_0x317c6f(0x284)])&&_0x55980e[_0x317c6f(0x27c)](_0x359a7e[_0x317c6f(0x284)]),!(0x0,lodash_1[_0x317c6f(0x26b)])(_0x359a7e[_0x317c6f(0x2cd)])&&!(0x0,lodash_1[_0x317c6f(0x268)])(_0x359a7e['message2'])&&_0x55980e[_0x317c6f(0x27c)](_0x359a7e[_0x317c6f(0x2cd)]),!(0x0,lodash_1['isEmpty'])(_0x359a7e[_0x317c6f(0x2a3)])&&!(0x0,lodash_1[_0x317c6f(0x268)])(_0x359a7e[_0x317c6f(0x2a3)])&&_0x55980e[_0x317c6f(0x27c)](_0x359a7e['message3']),!(0x0,lodash_1[_0x317c6f(0x26b)])(_0x359a7e[_0x317c6f(0x25d)])&&!(0x0,lodash_1['isNil'])(_0x359a7e[_0x317c6f(0x25d)])&&_0x55980e['push'](_0x359a7e[_0x317c6f(0x25d)]),!(0x0,lodash_1[_0x317c6f(0x26b)])(_0x359a7e[_0x317c6f(0x2f6)])&&!(0x0,lodash_1[_0x317c6f(0x268)])(_0x359a7e[_0x317c6f(0x2f6)])&&_0x55980e['push'](_0x359a7e[_0x317c6f(0x2f6)]),_0x55980e;}function getCampaignValidConfirmationMessages(_0x3852c0){const _0x59d247=a426_0x19cb1a,_0x36ab50=[];return!(0x0,lodash_1[_0x59d247(0x26b)])(_0x3852c0[_0x59d247(0x2c5)])&&!(0x0,lodash_1[_0x59d247(0x268)])(_0x3852c0['confirmationMessage1'])&&_0x36ab50[_0x59d247(0x27c)](_0x3852c0['confirmationMessage1']),!(0x0,lodash_1['isEmpty'])(_0x3852c0[_0x59d247(0x1cb)])&&!(0x0,lodash_1[_0x59d247(0x268)])(_0x3852c0[_0x59d247(0x1cb)])&&_0x36ab50['push'](_0x3852c0[_0x59d247(0x1cb)]),!(0x0,lodash_1[_0x59d247(0x26b)])(_0x3852c0[_0x59d247(0x2e6)])&&!(0x0,lodash_1[_0x59d247(0x268)])(_0x3852c0['confirmationMessage3'])&&_0x36ab50[_0x59d247(0x27c)](_0x3852c0[_0x59d247(0x2e6)]),!(0x0,lodash_1[_0x59d247(0x26b)])(_0x3852c0['confirmationMessage4'])&&!(0x0,lodash_1['isNil'])(_0x3852c0[_0x59d247(0x2e2)])&&_0x36ab50[_0x59d247(0x27c)](_0x3852c0['confirmationMessage4']),!(0x0,lodash_1['isEmpty'])(_0x3852c0[_0x59d247(0x287)])&&!(0x0,lodash_1[_0x59d247(0x268)])(_0x3852c0[_0x59d247(0x287)])&&_0x36ab50[_0x59d247(0x27c)](_0x3852c0[_0x59d247(0x287)]),_0x36ab50;}function getProcessedMessage(_0xdd545c,_0x5b291d,_0x4f581f){const _0x3a0b25=a426_0x19cb1a;let _0x5c13b7=_0xdd545c;return _0x5c13b7[_0x3a0b25(0x1e9)](_0x3a0b25(0x1fb))&&(_0x5c13b7=_0x5c13b7[_0x3a0b25(0x1a2)](/{nome}/g,_0x4f581f[_0x3a0b25(0x260)])),_0x5c13b7[_0x3a0b25(0x1e9)](_0x3a0b25(0x2fc))&&(_0x5c13b7=_0x5c13b7[_0x3a0b25(0x1a2)](/{email}/g,_0x4f581f[_0x3a0b25(0x1ce)])),_0x5c13b7['includes'](_0x3a0b25(0x22d))&&(_0x5c13b7=_0x5c13b7[_0x3a0b25(0x1a2)](/{numero}/g,_0x4f581f['number'])),_0x5b291d[_0x3a0b25(0x1c0)](_0x3094b5=>{const _0x371211=_0x3a0b25;if(_0x5c13b7[_0x371211(0x1e9)]('{'+_0x3094b5[_0x371211(0x2d2)]+'}')){const _0x12abe8=new RegExp('{'+_0x3094b5[_0x371211(0x2d2)]+'}','g');_0x5c13b7=_0x5c13b7[_0x371211(0x1a2)](_0x12abe8,_0x3094b5[_0x371211(0x203)]);}}),_0x5c13b7;}function randomValue(_0x46906f,_0x3b9b4f){const _0x17d0de=a426_0x19cb1a;return Math[_0x17d0de(0x2de)](Math[_0x17d0de(0x2bb)]()*_0x3b9b4f)+_0x46906f;}async function createTagLog(_0x5763c2,_0x29a555,_0x45cda6,_0x4cd52d={}){const _0x11d9ca=a426_0x19cb1a;try{const _0x2796c2=await TagLog_1[_0x11d9ca(0x1d0)][_0x11d9ca(0x215)]({'tagId':_0x5763c2,'type':_0x45cda6,'contact':_0x4cd52d['contact']||null,'phoneNumber':_0x4cd52d[_0x11d9ca(0x2b1)]||null,'message':_0x4cd52d[_0x11d9ca(0x1c6)]||null,'metadata':_0x4cd52d[_0x11d9ca(0x20b)]||null}),_0x3e56ad=(0x0,socket_1[_0x11d9ca(0x2a5)])();return _0x3e56ad[_0x11d9ca(0x24a)](_0x11d9ca(0x2fb)+_0x29a555+_0x11d9ca(0x228),{'action':_0x11d9ca(0x215),'tagId':_0x5763c2,'log':_0x2796c2['toJSON']()}),_0x2796c2;}catch(_0x1d79e9){logger_1[_0x11d9ca(0x2ab)][_0x11d9ca(0x30f)](_0x11d9ca(0x222)+_0x1d79e9);}}async function createCampaignLog(_0x2672a9,_0x44c60f,_0x1d315e,_0x68d76a={}){const _0x428f71=a426_0x19cb1a;try{const _0x3eaf8d=await CampaignLog_1[_0x428f71(0x1d0)][_0x428f71(0x215)]({'campaignId':_0x2672a9,'type':_0x1d315e,'contact':_0x68d76a['contact']||null,'phoneNumber':_0x68d76a['phoneNumber']||null,'position':_0x68d76a[_0x428f71(0x286)]||null,'message':_0x68d76a[_0x428f71(0x1c6)]||null,'metadata':_0x68d76a['metadata']||null}),_0x2f9be3=(0x0,socket_1['getIO'])();return _0x2f9be3[_0x428f71(0x24a)](_0x428f71(0x2fb)+_0x44c60f+_0x428f71(0x1ea),{'action':_0x428f71(0x215),'campaignId':_0x2672a9,'log':_0x3eaf8d['toJSON']()}),_0x3eaf8d;}catch(_0x1138d6){logger_1[_0x428f71(0x2ab)][_0x428f71(0x30f)]('Erro\x20ao\x20criar\x20log\x20de\x20campanha:\x20'+_0x1138d6);}}async function verifyAndFinalizeCampaign(_0x4c37c7){const _0x3e33e9=a426_0x19cb1a,_0x4fd11f=await(0x0,ShowService_1[_0x3e33e9(0x1d0)])(_0x4c37c7['id']);_0x4fd11f[_0x3e33e9(0x1be)]===_0x4fd11f[_0x3e33e9(0x2bf)]?(await _0x4c37c7['update']({'status':_0x3e33e9(0x20c),'completedAt':(0x0,moment_1[_0x3e33e9(0x1d0)])()}),logger_1[_0x3e33e9(0x2ab)][_0x3e33e9(0x207)]('ðŸ\x20Campanha\x20ID='+_0x4c37c7['id']+_0x3e33e9(0x2d8)+_0x4fd11f['delivered']+_0x3e33e9(0x2aa)),await createCampaignLog(_0x4c37c7['id'],_0x4c37c7[_0x3e33e9(0x243)],_0x3e33e9(0x2b6),{'metadata':{'totalProcessed':_0x4fd11f[_0x3e33e9(0x2bf)],'totalValid':_0x4fd11f['valids'],'confirmationRequested':_0x4fd11f[_0x3e33e9(0x1d7)],'confirmed':_0x4fd11f[_0x3e33e9(0x28a)]}})):logger_1[_0x3e33e9(0x2ab)][_0x3e33e9(0x207)](_0x3e33e9(0x1ab)+_0x4c37c7['id']+':\x20'+_0x4fd11f[_0x3e33e9(0x2bf)]+'/'+_0x4fd11f[_0x3e33e9(0x1be)]+'\x20enviados');const _0x468b28=await Campaign_1[_0x3e33e9(0x1d0)]['findByPk'](_0x4c37c7['id'],{'include':[{'model':ContactList_1[_0x3e33e9(0x1d0)],'attributes':['id',_0x3e33e9(0x260)]},{'model':Whatsapp_1[_0x3e33e9(0x1d0)],'attributes':['id',_0x3e33e9(0x260)]}]}),_0x13cda2=(0x0,socket_1[_0x3e33e9(0x2a5)])();_0x13cda2[_0x3e33e9(0x24a)](_0x3e33e9(0x2fb)+_0x4c37c7[_0x3e33e9(0x243)]+'-campaign',{'action':'update','record':{..._0x468b28[_0x3e33e9(0x2e0)](),'statistics':{'valids':_0x4fd11f['valids'],'delivered':_0x4fd11f['delivered'],'confirmationRequested':_0x4fd11f[_0x3e33e9(0x1d7)],'confirmed':_0x4fd11f['confirmed']}}});}async function prepareContact(_0x8236b9,_0x57b2f7,_0x256777,_0x315a28,_0xddeb,_0x21c041){const _0x15c279=a426_0x19cb1a,_0x39d9ab={};_0x39d9ab[_0x15c279(0x264)]=_0x256777[_0x15c279(0x264)],_0x39d9ab['contactId']=_0x256777['id'],_0x39d9ab[_0x15c279(0x205)]=_0x8236b9['id'];if(_0xddeb[_0x15c279(0x2d3)]){const _0x5289ad=randomValue(0x0,_0xddeb[_0x15c279(0x2d3)]),_0x5e70a7=getProcessedMessage(_0xddeb[_0x5289ad],_0x57b2f7,_0x256777);_0x39d9ab[_0x15c279(0x1c6)]=''+_0x5e70a7;}if(_0x8236b9[_0x15c279(0x2b3)]){if(_0x21c041['length']){const _0x771f00=randomValue(0x0,_0x21c041[_0x15c279(0x2d3)]),_0x3ab89d=getProcessedMessage(_0x21c041[_0x771f00],_0x57b2f7,_0x256777);_0x39d9ab[_0x15c279(0x241)]=''+_0x3ab89d;}}const [_0x3dfdd3,_0x9a3865]=await CampaignShipping_1[_0x15c279(0x1d0)][_0x15c279(0x1e1)]({'where':{'campaignId':_0x39d9ab[_0x15c279(0x205)],'contactId':_0x39d9ab[_0x15c279(0x20f)]},'defaults':_0x39d9ab});!_0x9a3865&&_0x3dfdd3[_0x15c279(0x25a)]===null&&_0x3dfdd3[_0x15c279(0x30b)]===null&&(_0x3dfdd3[_0x15c279(0x2ca)](_0x39d9ab),await _0x3dfdd3[_0x15c279(0x1a7)]());if(_0x3dfdd3[_0x15c279(0x25a)]===null&&_0x3dfdd3[_0x15c279(0x30b)]===null){const _0x480403=await exports['campaignQueue']['add']('DispatchCampaign',{'campaignId':_0x8236b9['id'],'campaignShippingId':_0x3dfdd3['id'],'contactListItemId':_0x256777['id']},{'delay':_0x315a28});await _0x3dfdd3['update']({'jobId':''+_0x480403['id']});}}async function handleProcessCampaign(_0x139936){const _0x306fe7=a426_0x19cb1a;try{const {id:_0xc7962d}=_0x139936[_0x306fe7(0x2f3)];let {delay:_0x2caaab}=_0x139936[_0x306fe7(0x2f3)];const _0x14c73b=await getCampaign(_0xc7962d);if(!_0x14c73b){logger_1['logger'][_0x306fe7(0x30f)]('âŒ\x20Campanha\x20ID='+_0xc7962d+_0x306fe7(0x292));return;}logger_1['logger']['info'](_0x306fe7(0x2c6)+_0x14c73b['id']+_0x306fe7(0x1e3)+_0x14c73b[_0x306fe7(0x260)]+'\x22');if(!_0x14c73b[_0x306fe7(0x2c9)]){logger_1['logger']['error']('âŒ\x20Campanha\x20ID='+_0xc7962d+_0x306fe7(0x1b7));return;}if(!_0x14c73b[_0x306fe7(0x2df)]){logger_1[_0x306fe7(0x2ab)][_0x306fe7(0x30f)]('âŒ\x20Campanha\x20ID='+_0xc7962d+'\x20nÃ£o\x20possui\x20WhatsApp\x20vinculado!');return;}const _0x29979d=await getSettings(_0x14c73b);if(_0x14c73b){const {contacts:_0x4ed0b6}=_0x14c73b[_0x306fe7(0x2c9)];if(!_0x4ed0b6||_0x4ed0b6[_0x306fe7(0x2d3)]===0x0){logger_1['logger'][_0x306fe7(0x30f)]('âŒ\x20Campanha\x20ID='+_0xc7962d+_0x306fe7(0x2c8)+_0x14c73b['contactList'][_0x306fe7(0x260)]+_0x306fe7(0x298));return;}logger_1[_0x306fe7(0x2ab)][_0x306fe7(0x207)](_0x306fe7(0x1ba)+_0xc7962d+_0x306fe7(0x2f4)+_0x4ed0b6[_0x306fe7(0x2d3)]+_0x306fe7(0x1a9)),await createCampaignLog(_0x14c73b['id'],_0x14c73b['companyId'],_0x306fe7(0x2c0),{'metadata':{'totalContacts':_0x4ed0b6[_0x306fe7(0x2d3)],'messageInterval':_0x29979d[_0x306fe7(0x238)],'longerIntervalAfter':_0x29979d[_0x306fe7(0x2e3)],'greaterInterval':_0x29979d[_0x306fe7(0x1f7)]}});const _0x3bd87e=getCampaignValidMessages(_0x14c73b),_0x2aff97=_0x14c73b['confirmation']?getCampaignValidConfirmationMessages(_0x14c73b):null;if((0x0,lodash_1[_0x306fe7(0x276)])(_0x4ed0b6)){let _0xc0a62c=0x0;_0x4ed0b6[_0x306fe7(0x1c0)](_0x991059=>{const _0x38646c=_0x306fe7;prepareContact(_0x14c73b,_0x29979d[_0x38646c(0x2e4)],_0x991059,_0x2caaab,_0x3bd87e,_0x2aff97)[_0x38646c(0x20a)](()=>{const _0x16da24=_0x38646c,_0x3c3871=(_0x2caaab/0x3e8)[_0x16da24(0x2ac)](0x1);logger_1[_0x16da24(0x2ab)]['info']('ðŸ“¤\x20Job\x20criado\x20na\x20fila:\x20Campanha='+_0x14c73b['id']+';Contato='+_0x991059[_0x16da24(0x260)]+';Delay='+_0x3c3871+_0x16da24(0x220)+_0x2caaab+'ms)');}),_0xc0a62c+=0x1,_0xc0a62c%_0x29979d[_0x38646c(0x2e3)]===0x0?_0x2caaab+=parseToMilliseconds(_0x29979d[_0x38646c(0x1f7)]):_0x2caaab+=parseToMilliseconds(randomValue(0x0,_0x29979d[_0x38646c(0x238)]));}),await _0x14c73b['update']({'status':_0x306fe7(0x223)}),logger_1['logger'][_0x306fe7(0x207)](_0x306fe7(0x1fc)+_0xc7962d+_0x306fe7(0x310)),await createCampaignLog(_0x14c73b['id'],_0x14c73b[_0x306fe7(0x243)],_0x306fe7(0x2dc),{'metadata':{'status':_0x306fe7(0x223),'totalJobs':_0x4ed0b6[_0x306fe7(0x2d3)]}});const _0x3d9d00=(0x0,socket_1[_0x306fe7(0x2a5)])();_0x3d9d00[_0x306fe7(0x24a)](_0x306fe7(0x2fb)+_0x14c73b['companyId']+_0x306fe7(0x21e),{'action':_0x306fe7(0x210),'record':_0x14c73b});}}}catch(_0x35368a){Sentry[_0x306fe7(0x2ff)](_0x35368a),logger_1[_0x306fe7(0x2ab)][_0x306fe7(0x30f)](_0x306fe7(0x2be)+_0x35368a['message']),logger_1[_0x306fe7(0x2ab)]['error'](_0x35368a[_0x306fe7(0x246)]);}}async function handleDispatchCampaign(_0x3214b3){const _0x5f539f=a426_0x19cb1a;try{const {data:_0x4472fb}=_0x3214b3,{campaignShippingId:_0x29848f,campaignId:_0x4ff644}=_0x4472fb,_0x102dc9=await Campaign_1[_0x5f539f(0x1d0)][_0x5f539f(0x249)](_0x4ff644,{'include':[{'model':Whatsapp_1[_0x5f539f(0x1d0)],'as':_0x5f539f(0x2df)}]});if(!_0x102dc9){logger_1['logger'][_0x5f539f(0x30f)]({'data':_0x4472fb},_0x5f539f(0x1a5));return;}const _0x271e63=await(0x0,GetWhatsappWbot_1[_0x5f539f(0x1d0)])(_0x102dc9['whatsapp']);logger_1[_0x5f539f(0x2ab)][_0x5f539f(0x207)](_0x5f539f(0x2c2)+_0x4ff644+_0x5f539f(0x2c4)+_0x29848f);const _0x12d63b=await CampaignShipping_1[_0x5f539f(0x1d0)][_0x5f539f(0x249)](_0x29848f,{'include':[{'model':ContactListItem_1[_0x5f539f(0x1d0)],'as':'contact'}]});if(_0x102dc9[_0x5f539f(0x297)]){logger_1[_0x5f539f(0x2ab)][_0x5f539f(0x1d8)](_0x5f539f(0x2fe)+_0x4ff644+_0x5f539f(0x25c)+_0x12d63b[_0x5f539f(0x247)][_0x5f539f(0x260)]+';NÃºmero='+_0x12d63b[_0x5f539f(0x264)]);const _0x4b73f2=await getSettings(_0x102dc9),_0x195632=await CampaignShipping_1[_0x5f539f(0x1d0)]['count']({'where':{'campaignId':_0x102dc9['id'],'deliveredAt':{[sequelize_1['Op']['ne']]:null}}});await createCampaignLog(_0x102dc9['id'],_0x102dc9[_0x5f539f(0x243)],_0x5f539f(0x230),{'contact':_0x12d63b[_0x5f539f(0x247)][_0x5f539f(0x260)],'phoneNumber':_0x12d63b[_0x5f539f(0x264)],'position':_0x195632+0x1,'message':_0x12d63b['message'],'metadata':{'confirmationRequested':_0x102dc9[_0x5f539f(0x2b3)]&&_0x12d63b[_0x5f539f(0x2b3)]===null,'confirmationMessage':_0x12d63b['confirmationMessage'],'mediaPath':_0x102dc9[_0x5f539f(0x2e1)],'mediaName':_0x102dc9['mediaName'],'settings':{'messageInterval':_0x4b73f2[_0x5f539f(0x238)],'longerIntervalAfter':_0x4b73f2[_0x5f539f(0x2e3)],'greaterInterval':_0x4b73f2[_0x5f539f(0x1f7)]}}}),_0x102dc9[_0x5f539f(0x2b3)]&&_0x12d63b[_0x5f539f(0x2b3)]===null?await _0x12d63b[_0x5f539f(0x210)]({'confirmationRequestedAt':(0x0,moment_1[_0x5f539f(0x1d0)])()}):await _0x12d63b[_0x5f539f(0x210)]({'deliveredAt':(0x0,moment_1[_0x5f539f(0x1d0)])()}),logger_1[_0x5f539f(0x2ab)]['info']('ðŸ§ª\x20SimulaÃ§Ã£o\x20concluÃ­da:\x20Campanha='+_0x4ff644+_0x5f539f(0x25c)+_0x12d63b['contact'][_0x5f539f(0x260)]);}else{const _0xc92411=_0x12d63b[_0x5f539f(0x264)]+_0x5f539f(0x2a9),_0x3124d1=await(0x0,GetWhatsappWbot_1[_0x5f539f(0x1d0)])(_0x102dc9[_0x5f539f(0x2df)]);if(_0x102dc9['confirmation']&&_0x12d63b[_0x5f539f(0x2b3)]===null)await _0x3124d1[_0x5f539f(0x219)](_0xc92411,{'text':_0x12d63b['confirmationMessage']}),await _0x12d63b['update']({'confirmationRequestedAt':(0x0,moment_1['default'])()}),await createCampaignLog(_0x102dc9['id'],_0x102dc9['companyId'],_0x5f539f(0x279),{'contact':_0x12d63b[_0x5f539f(0x247)][_0x5f539f(0x260)],'phoneNumber':_0x12d63b[_0x5f539f(0x264)],'message':_0x12d63b[_0x5f539f(0x241)],'metadata':{'type':_0x5f539f(0x2b3),'messageId':null}});else{await _0x3124d1[_0x5f539f(0x219)](_0xc92411,{'text':_0x12d63b[_0x5f539f(0x1c6)]});if(_0x102dc9[_0x5f539f(0x2e1)]){const _0x2a98cc=_0x102dc9['mediaPath'];let _0x438971={};if(_0x2a98cc['startsWith'](_0x5f539f(0x2c3))||_0x2a98cc[_0x5f539f(0x1dc)]('https://')){const _0x510c72=require(_0x5f539f(0x1fd)),_0x5e7535=require(_0x5f539f(0x288)),_0x1fb942=await _0x510c72({'url':_0x2a98cc,'method':_0x5f539f(0x1cc),'responseType':'arraybuffer'}),_0x119d98=_0x5e7535[_0x5f539f(0x221)](_0x1fb942[_0x5f539f(0x2a0)]['content-type'])||_0x5f539f(0x290),_0x28eea1=_0x5f539f(0x313)+Date[_0x5f539f(0x271)]()+'.'+_0x119d98,_0x246e99=path_1[_0x5f539f(0x1d0)][_0x5f539f(0x1dd)](_0x5f539f(0x20d),_0x28eea1);fs_1[_0x5f539f(0x1d0)][_0x5f539f(0x225)](_0x246e99,_0x1fb942[_0x5f539f(0x2f3)]),_0x438971=await(0x0,SendWhatsAppMedia_1[_0x5f539f(0x2ba)])(_0x102dc9['mediaName']||_0x28eea1,_0x246e99),setTimeout(()=>fs_1[_0x5f539f(0x1d0)][_0x5f539f(0x1de)](_0x246e99),0x1388);}else{const _0x1fe4b3=path_1[_0x5f539f(0x1d0)][_0x5f539f(0x1dd)](_0x5f539f(0x20d),_0x2a98cc);fs_1[_0x5f539f(0x1d0)]['existsSync'](_0x1fe4b3)&&(_0x438971=await(0x0,SendWhatsAppMedia_1[_0x5f539f(0x2ba)])(_0x102dc9[_0x5f539f(0x1e2)],_0x1fe4b3));}Object[_0x5f539f(0x1b4)](_0x438971)[_0x5f539f(0x2d3)]&&await _0x3124d1[_0x5f539f(0x219)](_0xc92411,{..._0x438971});}await _0x12d63b[_0x5f539f(0x210)]({'deliveredAt':(0x0,moment_1[_0x5f539f(0x1d0)])()}),await createCampaignLog(_0x102dc9['id'],_0x102dc9[_0x5f539f(0x243)],'send',{'contact':_0x12d63b[_0x5f539f(0x247)][_0x5f539f(0x260)],'phoneNumber':_0x12d63b[_0x5f539f(0x264)],'message':_0x12d63b['message'],'metadata':{'type':'message','hasMedia':!!_0x102dc9[_0x5f539f(0x2e1)],'mediaName':_0x102dc9['mediaName']}});}logger_1[_0x5f539f(0x2ab)]['info'](_0x5f539f(0x2e7)+_0x4ff644+_0x5f539f(0x25c)+_0x12d63b[_0x5f539f(0x247)]['name']);}await verifyAndFinalizeCampaign(_0x102dc9);}catch(_0x464289){Sentry[_0x5f539f(0x2ff)](_0x464289),logger_1[_0x5f539f(0x2ab)][_0x5f539f(0x30f)](_0x464289[_0x5f539f(0x1c6)]);}}async function handleLoginStatus(){const _0xdfec89=a426_0x19cb1a,_0x57647f=await database_1[_0xdfec89(0x1d0)]['query']('select\x20id\x20from\x20\x22Users\x22\x20where\x20\x22updatedAt\x22\x20<\x20now()\x20-\x20\x275\x20minutes\x27::interval\x20and\x20online\x20=\x20true',{'type':sequelize_1['QueryTypes'][_0xdfec89(0x30a)]});_0x57647f[_0xdfec89(0x1c0)](async _0x20dcf9=>{const _0x31f5a1=_0xdfec89;try{const _0x31ca57=await User_1[_0x31f5a1(0x1d0)][_0x31f5a1(0x249)](_0x20dcf9['id']);await _0x31ca57[_0x31f5a1(0x210)]({'online':![]}),logger_1[_0x31f5a1(0x2ab)][_0x31f5a1(0x207)](_0x31f5a1(0x2f5)+_0x20dcf9['id']);}catch(_0x2ec7c2){Sentry[_0x31f5a1(0x2ff)](_0x2ec7c2);}});}async function handleInvoiceCreate(){const _0x265440=a426_0x19cb1a,_0x2ddc98=new cron_1[(_0x265440(0x270))](_0x265440(0x2dd),async()=>{const _0x453f62=_0x265440,_0x398527=await Company_1['default'][_0x453f62(0x24c)]();_0x398527['map'](async _0x4a63a9=>{const _0x5bfc37=_0x453f62,{dueDate:_0x259db5}=_0x4a63a9,_0x508600=(0x0,moment_1[_0x5bfc37(0x1d0)])(_0x259db5)[_0x5bfc37(0x1a4)](),_0x346c30=(0x0,moment_1[_0x5bfc37(0x1d0)])()[_0x5bfc37(0x1a4)](),_0x5a127b=(0x0,moment_1['default'])((0x0,moment_1[_0x5bfc37(0x1d0)])())[_0x5bfc37(0x1a4)](_0x5bfc37(0x204)),_0x1d6030=(0x0,moment_1[_0x5bfc37(0x1d0)])(_0x259db5)[_0x5bfc37(0x1a4)](_0x5bfc37(0x204)),_0x50f5c6=(0x0,moment_1['default'])(_0x1d6030,'DD/MM/yyyy')[_0x5bfc37(0x237)]((0x0,moment_1[_0x5bfc37(0x1d0)])(_0x5a127b,_0x5bfc37(0x204))),_0x8a3185=moment_1[_0x5bfc37(0x1d0)][_0x5bfc37(0x285)](_0x50f5c6)[_0x5bfc37(0x1ec)]();if(_0x8a3185<0x14){const _0x409143=await Plan_1[_0x5bfc37(0x1d0)]['findByPk'](_0x4a63a9[_0x5bfc37(0x27e)]),_0x280147=_0x5bfc37(0x2b0)+_0x4a63a9['id']+_0x5bfc37(0x1e4)+(0x0,moment_1[_0x5bfc37(0x1d0)])(_0x259db5)['format'](_0x5bfc37(0x275))+_0x5bfc37(0x22e),_0xeeb15f=await database_1[_0x5bfc37(0x1d0)][_0x5bfc37(0x291)](_0x280147,{'type':sequelize_1['QueryTypes'][_0x5bfc37(0x30a)]});if(+_0xeeb15f[0x0][_0x5bfc37(0x2af)]===0x0){const _0x514a65=_0x5bfc37(0x28b)+_0x409143[_0x5bfc37(0x260)]+_0x5bfc37(0x1e0)+_0x409143[_0x5bfc37(0x203)]+_0x5bfc37(0x1b8)+_0x346c30+'\x27,\x20\x27'+_0x346c30+'\x27,\x20\x27'+_0x508600+_0x5bfc37(0x1c2)+_0x4a63a9['id']+');';await database_1['default']['query'](_0x514a65,{'type':sequelize_1[_0x5bfc37(0x25e)][_0x5bfc37(0x216)]});}}});});_0x2ddc98[_0x265440(0x2dc)]();}async function handleExpiredSubscriptions(){const _0x279651=a426_0x19cb1a,_0x588c09=new cron_1[(_0x279651(0x270))]('0\x20*\x20*\x20*\x20*',async()=>{const _0xafeac1=_0x279651;logger_1['logger']['info'](_0xafeac1(0x1c7));try{const _0x4a0c86=(0x0,moment_1['default'])()[_0xafeac1(0x227)]('day'),_0x363fee=await Company_1['default'][_0xafeac1(0x24c)]({'where':{'status':!![],'dueDate':{[sequelize_1['Op']['lt']]:_0x4a0c86[_0xafeac1(0x19c)]()}}});if(_0x363fee['length']===0x0){logger_1['logger']['info'](_0xafeac1(0x218));return;}logger_1['logger'][_0xafeac1(0x207)](_0xafeac1(0x2b4)+_0x363fee['length']+'\x20empresas\x20com\x20assinatura\x20expirada.');for(const _0x5f2f12 of _0x363fee){logger_1[_0xafeac1(0x2ab)]['info'](_0xafeac1(0x1a1)+_0x5f2f12['id']+'\x20-\x20'+_0x5f2f12[_0xafeac1(0x260)]+_0xafeac1(0x2fd)+(0x0,moment_1['default'])(_0x5f2f12[_0xafeac1(0x25f)])['format']('DD/MM/YYYY')+')');const _0x3ee7bf=await Whatsapp_1[_0xafeac1(0x1d0)][_0xafeac1(0x24c)]({'where':{'companyId':_0x5f2f12['id'],'status':{[sequelize_1['Op']['in']]:[_0xafeac1(0x2ea),_0xafeac1(0x231),_0xafeac1(0x1bc),'PAIRING','TIMEOUT']}}});if(_0x3ee7bf[_0xafeac1(0x2d3)]>0x0){logger_1['logger'][_0xafeac1(0x207)](_0xafeac1(0x235)+_0x3ee7bf[_0xafeac1(0x2d3)]+_0xafeac1(0x19b)+_0x5f2f12[_0xafeac1(0x260)]);for(const _0x18ead9 of _0x3ee7bf){try{await(0x0,wbot_1[_0xafeac1(0x1fe)])(_0x18ead9['id'],![]),await _0x18ead9['update']({'status':_0xafeac1(0x306),'session':null}),logger_1['logger'][_0xafeac1(0x207)](_0xafeac1(0x208)+_0x18ead9[_0xafeac1(0x260)]+'\x20(ID:\x20'+_0x18ead9['id']+_0xafeac1(0x267));}catch(_0x4726dd){logger_1[_0xafeac1(0x2ab)][_0xafeac1(0x30f)](_0xafeac1(0x1e7)+_0x18ead9['id']+':\x20'+_0x4726dd);}}const _0x3e4b40=(0x0,socket_1['getIO'])();_0x3e4b40['to'](_0xafeac1(0x2fb)+_0x5f2f12['id']+_0xafeac1(0x27d))['emit']('company-'+_0x5f2f12['id']+'-whatsapp',{'action':_0xafeac1(0x210)});}}logger_1['logger'][_0xafeac1(0x207)](_0xafeac1(0x299));}catch(_0x241e86){logger_1[_0xafeac1(0x2ab)][_0xafeac1(0x30f)](_0xafeac1(0x209)+_0x241e86),Sentry['captureException'](_0x241e86);}});_0x588c09[_0x279651(0x2dc)]();}handleExpiredSubscriptions(),handleInvoiceCreate();async function startQueueProcess(){const _0x56e8da=a426_0x19cb1a;logger_1['logger'][_0x56e8da(0x207)](_0x56e8da(0x1aa)),exports[_0x56e8da(0x229)][_0x56e8da(0x294)](_0x56e8da(0x27b),handleSendMessage),exports[_0x56e8da(0x23c)][_0x56e8da(0x294)](_0x56e8da(0x1a3),handleVerifySchedules),exports[_0x56e8da(0x1df)]['process']('SendMessage',handleSendScheduledMessage),exports['campaignQueue'][_0x56e8da(0x294)](_0x56e8da(0x25b),handleVerifyCampaigns),exports['campaignQueue'][_0x56e8da(0x294)](_0x56e8da(0x2d0),handleProcessCampaign),exports[_0x56e8da(0x2d7)][_0x56e8da(0x294)](_0x56e8da(0x1c4),handleDispatchCampaign),exports['userMonitor'][_0x56e8da(0x294)](_0x56e8da(0x257),handleLoginStatus),exports[_0x56e8da(0x2d7)][_0x56e8da(0x294)](_0x56e8da(0x272),handleDispatchCampaign),exports[_0x56e8da(0x254)][_0x56e8da(0x294)](_0x56e8da(0x2cb),handleVerifyTicketExpiration),exports[_0x56e8da(0x1d1)][_0x56e8da(0x294)](_0x56e8da(0x2b7),handleWhatsappAutoRestart),exports[_0x56e8da(0x23c)][_0x56e8da(0x1d3)](_0x56e8da(0x1a3),{},{'repeat':{'cron':_0x56e8da(0x240)},'removeOnComplete':!![]}),exports['campaignQueue'][_0x56e8da(0x1d3)](_0x56e8da(0x25b),{},{'repeat':{'cron':_0x56e8da(0x1d9)},'removeOnComplete':!![]}),exports[_0x56e8da(0x2b8)][_0x56e8da(0x1d3)](_0x56e8da(0x257),{},{'repeat':{'cron':_0x56e8da(0x26c)},'removeOnComplete':!![]}),exports[_0x56e8da(0x254)]['add'](_0x56e8da(0x2cb),{},{'repeat':{'cron':'*/30\x20*\x20*\x20*\x20*\x20*'},'removeOnComplete':!![]}),exports['whatsappRestartQueue'][_0x56e8da(0x1d3)](_0x56e8da(0x2b7),{},{'repeat':{'cron':_0x56e8da(0x2a6)},'removeOnComplete':!![]});}