'use strict';const a425_0x408c32=a425_0x3e9c;function a425_0x3e9c(_0x26a5ed,_0x2bde4c){const _0x2769ee=a425_0x1387();return a425_0x3e9c=function(_0xde0951,_0x1a1441){_0xde0951=_0xde0951-0x1c0;let _0x138737=_0x2769ee[_0xde0951];return _0x138737;},a425_0x3e9c(_0x26a5ed,_0x2bde4c);}(function(_0x5912ed,_0xa60b9f){const _0x150de7=a425_0x3e9c,_0x59de24=_0x5912ed();while(!![]){try{const _0x644d01=-parseInt(_0x150de7(0x264))/0x1*(-parseInt(_0x150de7(0x1ea))/0x2)+-parseInt(_0x150de7(0x235))/0x3+parseInt(_0x150de7(0x1d8))/0x4*(parseInt(_0x150de7(0x260))/0x5)+parseInt(_0x150de7(0x209))/0x6+parseInt(_0x150de7(0x242))/0x7*(-parseInt(_0x150de7(0x256))/0x8)+parseInt(_0x150de7(0x1d0))/0x9+-parseInt(_0x150de7(0x26f))/0xa;if(_0x644d01===_0xa60b9f)break;else _0x59de24['push'](_0x59de24['shift']());}catch(_0x489a31){_0x59de24['push'](_0x59de24['shift']());}}}(a425_0x1387,0x82591));var __createBinding=this&&this['__createBinding']||(Object[a425_0x408c32(0x2de)]?function(_0x2121d6,_0x216981,_0x59197e,_0x41c581){const _0x1b2749=a425_0x408c32;if(_0x41c581===undefined)_0x41c581=_0x59197e;var _0x3e65c6=Object[_0x1b2749(0x280)](_0x216981,_0x59197e);(!_0x3e65c6||(_0x1b2749(0x1f6)in _0x3e65c6?!_0x216981[_0x1b2749(0x2f6)]:_0x3e65c6[_0x1b2749(0x23a)]||_0x3e65c6['configurable']))&&(_0x3e65c6={'enumerable':!![],'get':function(){return _0x216981[_0x59197e];}}),Object[_0x1b2749(0x267)](_0x2121d6,_0x41c581,_0x3e65c6);}:function(_0x658eb5,_0x2ffade,_0x31365c,_0x56603e){if(_0x56603e===undefined)_0x56603e=_0x31365c;_0x658eb5[_0x56603e]=_0x2ffade[_0x31365c];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x77982f,_0x18469a){const _0x2ae22f=a425_0x408c32;Object[_0x2ae22f(0x267)](_0x77982f,_0x2ae22f(0x2e3),{'enumerable':!![],'value':_0x18469a});}:function(_0x50b008,_0x2c6de4){const _0x3bedf2=a425_0x408c32;_0x50b008[_0x3bedf2(0x2e3)]=_0x2c6de4;}),__importStar=this&&this[a425_0x408c32(0x2b0)]||(function(){const _0x1e4535=(function(){let _0x75e2d6=!![];return function(_0x17765d,_0x52fc06){const _0x184040=_0x75e2d6?function(){if(_0x52fc06){const _0x307991=_0x52fc06['apply'](_0x17765d,arguments);return _0x52fc06=null,_0x307991;}}:function(){};return _0x75e2d6=![],_0x184040;};}()),_0xac3f1b=_0x1e4535(this,function(){const _0x47ae9e=a425_0x3e9c;return _0xac3f1b['toString']()[_0x47ae9e(0x252)](_0x47ae9e(0x274))['toString']()[_0x47ae9e(0x222)](_0xac3f1b)[_0x47ae9e(0x252)](_0x47ae9e(0x274));});_0xac3f1b();var _0xf672f9=function(_0x339e9f){const _0x4656ff=a425_0x3e9c;return _0xf672f9=Object[_0x4656ff(0x295)]||function(_0x936ba8){const _0x316862=_0x4656ff;var _0x49eab5=[];for(var _0x324126 in _0x936ba8)if(Object[_0x316862(0x20c)]['hasOwnProperty'][_0x316862(0x28a)](_0x936ba8,_0x324126))_0x49eab5[_0x49eab5['length']]=_0x324126;return _0x49eab5;},_0xf672f9(_0x339e9f);};return function(_0x190c32){const _0x32a2ce=a425_0x3e9c;if(_0x190c32&&_0x190c32[_0x32a2ce(0x2f6)])return _0x190c32;var _0x36bc95={};if(_0x190c32!=null){for(var _0x3f83a5=_0xf672f9(_0x190c32),_0x2ca5b9=0x0;_0x2ca5b9<_0x3f83a5[_0x32a2ce(0x232)];_0x2ca5b9++)if(_0x3f83a5[_0x2ca5b9]!=='default')__createBinding(_0x36bc95,_0x190c32,_0x3f83a5[_0x2ca5b9]);}return __setModuleDefault(_0x36bc95,_0x190c32),_0x36bc95;};}()),__importDefault=this&&this['__importDefault']||function(_0x335adf){return _0x335adf&&_0x335adf['__esModule']?_0x335adf:{'default':_0x335adf};};Object[a425_0x408c32(0x267)](exports,a425_0x408c32(0x2f6),{'value':!![]}),exports['campaignQueue']=exports[a425_0x408c32(0x2fe)]=exports['ticketMonitor']=exports['ticketInactiveWarningQueue']=exports['sendScheduledMessages']=exports['scheduleMonitor']=exports[a425_0x408c32(0x1cc)]=exports[a425_0x408c32(0x268)]=void 0x0,exports[a425_0x408c32(0x2ab)]=handleWhatsappAutoRestart,exports[a425_0x408c32(0x21f)]=parseToMilliseconds,exports[a425_0x408c32(0x25e)]=sleep,exports[a425_0x408c32(0x1e4)]=randomValue,exports[a425_0x408c32(0x294)]=startQueueProcess;const Sentry=__importStar(require('@sentry/node')),bull_1=__importDefault(require('bull')),moment_1=__importDefault(require('moment')),sequelize_1=require(a425_0x408c32(0x202)),lodash_1=require('lodash'),path_1=__importDefault(require(a425_0x408c32(0x221))),fs_1=__importDefault(require('fs')),cron_1=require(a425_0x408c32(0x2cf)),SendMessage_1=require('./helpers/SendMessage'),Whatsapp_1=__importDefault(require(a425_0x408c32(0x2d8))),logger_1=require('./utils/logger'),Schedule_1=__importDefault(require(a425_0x408c32(0x1f0))),Contact_1=__importDefault(require(a425_0x408c32(0x245))),GetDefaultWhatsApp_1=__importDefault(require(a425_0x408c32(0x2e0))),Campaign_1=__importDefault(require(a425_0x408c32(0x2b9))),ContactList_1=__importDefault(require('./models/ContactList')),ContactListItem_1=__importDefault(require('./models/ContactListItem')),CampaignSetting_1=__importDefault(require('./models/CampaignSetting')),CampaignShipping_1=__importDefault(require(a425_0x408c32(0x2e2))),CampaignLog_1=__importDefault(require(a425_0x408c32(0x253))),TagLog_1=__importDefault(require(a425_0x408c32(0x2ed))),GetWhatsappWbot_1=__importDefault(require('./helpers/GetWhatsappWbot')),database_1=__importDefault(require(a425_0x408c32(0x204))),SendWhatsAppMedia_1=require(a425_0x408c32(0x2f7)),socket_1=require(a425_0x408c32(0x205)),User_1=__importDefault(require(a425_0x408c32(0x237))),Company_1=__importDefault(require(a425_0x408c32(0x24d))),Plan_1=__importDefault(require('./models/Plan')),wbotMessageListener_1=require('./services/WbotServices/wbotMessageListener'),ShowService_1=__importDefault(require(a425_0x408c32(0x2c5))),Mustache_1=__importDefault(require('./helpers/Mustache')),Ticket_1=__importDefault(require(a425_0x408c32(0x2e8))),SendWhatsAppMessage_1=__importDefault(require('./services/WbotServices/SendWhatsAppMessage')),wbot_1=require(a425_0x408c32(0x2db)),StartWhatsAppSession_1=require(a425_0x408c32(0x21d)),Message_1=__importDefault(require(a425_0x408c32(0x1f2))),connection=process[a425_0x408c32(0x200)][a425_0x408c32(0x2bd)]||'',limiterMax=process[a425_0x408c32(0x200)][a425_0x408c32(0x21e)]||0x1,limiterDuration=process[a425_0x408c32(0x200)][a425_0x408c32(0x251)]||0xbb8;exports[a425_0x408c32(0x268)]=new bull_1[(a425_0x408c32(0x2e3))](a425_0x408c32(0x1cf),connection),exports['messageQueue']=new bull_1['default']('MessageQueue',connection,{'limiter':{'max':limiterMax,'duration':limiterDuration}}),exports[a425_0x408c32(0x1ca)]=new bull_1['default'](a425_0x408c32(0x216),connection),exports['sendScheduledMessages']=new bull_1[(a425_0x408c32(0x2e3))](a425_0x408c32(0x291),connection),exports['ticketInactiveWarningQueue']=new bull_1['default'](a425_0x408c32(0x2a2),connection);async function handleWhatsappAutoRestart(){const _0x505681=a425_0x408c32;try{const _0x3834e9=await Whatsapp_1[_0x505681(0x2e3)]['findAll']({'where':{'automaticRestart':!![],'status':_0x505681(0x24e)}}),_0x51231f=new Date();for(const _0x30184d of _0x3834e9){const _0x2c2456=_0x30184d[_0x505681(0x2a0)]||_0x30184d['updatedAt']||_0x30184d[_0x505681(0x2ee)];shouldRestart(_0x51231f,_0x2c2456,_0x30184d[_0x505681(0x2a3)])&&(logger_1[_0x505681(0x2b2)]['info'](_0x505681(0x1f1)+_0x30184d[_0x505681(0x1db)]+_0x505681(0x20d)+_0x30184d['id']+_0x505681(0x2f5)+_0x30184d[_0x505681(0x2a3)]+')'),await(0x0,wbot_1[_0x505681(0x258)])(_0x30184d['id'],![]),await new Promise(_0x19669a=>setTimeout(_0x19669a,0xbb8)),await(0x0,StartWhatsAppSession_1[_0x505681(0x2f4)])(_0x30184d,_0x30184d['companyId']),await _0x30184d[_0x505681(0x2dd)]({'lastRestartAt':new Date()}));}}catch(_0x3645b8){logger_1['logger'][_0x505681(0x265)](_0x505681(0x1c3)+_0x3645b8[_0x505681(0x2c1)]);}}exports[a425_0x408c32(0x250)]=new bull_1[(a425_0x408c32(0x2e3))](a425_0x408c32(0x20b),connection),exports[a425_0x408c32(0x2fe)]=new bull_1['default']('WhatsappRestartQueue',connection);function shouldRestart(_0xe6e41e,_0x23043b,_0x3fec80){const _0x1f8fd0=a425_0x408c32;if(_0x3fec80===_0x1f8fd0(0x2da))return(0x0,moment_1['default'])(_0xe6e41e)[_0x1f8fd0(0x272)]((0x0,moment_1['default'])(_0x23043b),'days')>=0x1;if(_0x3fec80===_0x1f8fd0(0x2bf))return(0x0,moment_1['default'])(_0xe6e41e)['diff']((0x0,moment_1[_0x1f8fd0(0x2e3)])(_0x23043b),_0x1f8fd0(0x238))>=0x1;if(_0x3fec80===_0x1f8fd0(0x25f))return(0x0,moment_1['default'])(_0xe6e41e)[_0x1f8fd0(0x272)]((0x0,moment_1['default'])(_0x23043b),_0x1f8fd0(0x1e6))>=0x1;return![];}async function handleVerifyTicketExpiration(){const _0x4a73e4=a425_0x408c32;try{const _0x596e9f=await database_1[_0x4a73e4(0x2e3)][_0x4a73e4(0x2b6)](_0x4a73e4(0x1c1),{'type':sequelize_1[_0x4a73e4(0x214)][_0x4a73e4(0x1dd)]});for(const _0x3b9503 of _0x596e9f){const _0x5d1269=await Ticket_1[_0x4a73e4(0x2e3)][_0x4a73e4(0x24b)]({'where':{'status':{[sequelize_1['Op']['in']]:[_0x4a73e4(0x217),_0x4a73e4(0x299)]},'whatsappId':_0x3b9503['id'],'companyId':_0x3b9503['companyId']},'include':[{'model':Contact_1[_0x4a73e4(0x2e3)],'as':_0x4a73e4(0x303)},{'model':Message_1[_0x4a73e4(0x2e3)],'as':_0x4a73e4(0x2e9),'separate':!![],'order':[[_0x4a73e4(0x2ee),'DESC']],'limit':0x1}]}),_0x5b7851=(0x0,moment_1['default'])();for(const _0x388791 of _0x5d1269){const _0x3a05f8=_0x388791[_0x4a73e4(0x2e9)]&&_0x388791[_0x4a73e4(0x2e9)][_0x4a73e4(0x232)]>0x0?_0x388791['messages'][0x0]:null;if(!_0x3a05f8)continue;let _0x576ce0=![];if(_0x3b9503[_0x4a73e4(0x25b)]===_0x4a73e4(0x243))_0x576ce0=_0x3a05f8['fromMe']===!![];else _0x3b9503[_0x4a73e4(0x25b)]==='customer'?_0x576ce0=_0x3a05f8[_0x4a73e4(0x1d3)]===![]:_0x576ce0=!![];if(!_0x576ce0)continue;const _0xc0b2db=(0x0,moment_1[_0x4a73e4(0x2e3)])(),_0x4ffdfa=(0x0,moment_1[_0x4a73e4(0x2e3)])(_0x3a05f8[_0x4a73e4(0x2ee)]),_0x249744=_0xc0b2db[_0x4a73e4(0x272)](_0x4ffdfa,'minutes'),_0x4750b6=_0x3b9503[_0x4a73e4(0x20f)]>0x0&&_0x3b9503[_0x4a73e4(0x2e4)];if(_0x4750b6){if(!_0x388791['ticketsWithWarning']&&!_0x388791['warningSentAt']){if(_0x249744>=_0x3b9503[_0x4a73e4(0x20f)])try{const _0x43b1cf=(0x0,wbot_1[_0x4a73e4(0x297)])(_0x3b9503['id']);_0x43b1cf&&_0x43b1cf['user']?(await(0x0,SendWhatsAppMessage_1[_0x4a73e4(0x2e3)])({'ticket':_0x388791,'body':_0x3b9503[_0x4a73e4(0x2e4)]}),await _0x388791[_0x4a73e4(0x2dd)]({'ticketsWithWarning':!![],'warningSentAt':new Date()},{'silent':!![]}),logger_1['logger'][_0x4a73e4(0x248)](_0x4a73e4(0x1c4)+_0x388791['id']+'\x20ap√≥s\x20'+_0x249744+_0x4a73e4(0x28e))):logger_1['logger'][_0x4a73e4(0x2aa)](_0x4a73e4(0x257)+_0x3b9503['id']+_0x4a73e4(0x279)+_0x388791['id']+'.');}catch(_0x11dbfe){Sentry[_0x4a73e4(0x27c)](_0x11dbfe),logger_1[_0x4a73e4(0x2b2)][_0x4a73e4(0x265)]('Erro\x20ao\x20enviar\x20aviso\x20de\x20inatividade:\x20'+_0x11dbfe[_0x4a73e4(0x2c1)]);}}else{if(_0x388791[_0x4a73e4(0x288)]){const _0x51cc45=(0x0,moment_1[_0x4a73e4(0x2e3)])(_0x388791['warningSentAt']),_0x52ee93=_0xc0b2db[_0x4a73e4(0x272)](_0x51cc45,_0x4a73e4(0x2af));if(_0x52ee93>=_0x3b9503[_0x4a73e4(0x2ae)])try{if(_0x3b9503['expiresInactiveMessage'])try{const _0x29e412=(0x0,wbot_1[_0x4a73e4(0x297)])(_0x3b9503['id']);_0x29e412&&_0x29e412['user']?(await(0x0,SendWhatsAppMessage_1[_0x4a73e4(0x2e3)])({'ticket':_0x388791,'body':_0x3b9503['expiresInactiveMessage']}),await new Promise(_0x148ee9=>setTimeout(_0x148ee9,0x3e8))):logger_1[_0x4a73e4(0x2b2)]['debug'](_0x4a73e4(0x257)+_0x3b9503['id']+_0x4a73e4(0x212)+_0x388791['id']+'.');}catch(_0x4073d1){logger_1['logger'][_0x4a73e4(0x2e5)]('Erro\x20ao\x20enviar\x20mensagem\x20de\x20encerramento\x20para\x20ticket\x20#'+_0x388791['id']+':\x20'+_0x4073d1[_0x4a73e4(0x2c1)]);}const _0x3671bf=_0x388791[_0x4a73e4(0x2bb)];await _0x388791[_0x4a73e4(0x2dd)]({'status':_0x4a73e4(0x2ce),'amountUsedBotQueues':0x0,'ticketsWithWarning':![],'warningSentAt':null});const _0x534303=(0x0,socket_1['getIO'])();if(_0x3671bf===_0x4a73e4(0x217))_0x534303['to'](_0x4a73e4(0x2cb)+_0x388791['companyId']+_0x4a73e4(0x1ef))['to']('queue-'+_0x388791['queueId']+'-open')[_0x4a73e4(0x301)](_0x4a73e4(0x2cb)+_0x388791[_0x4a73e4(0x2c6)]+_0x4a73e4(0x259),{'action':_0x4a73e4(0x2dd),'ticket':{..._0x388791['dataValues'],'status':_0x4a73e4(0x2ce)}});else _0x3671bf==='pending'&&_0x534303['to'](_0x4a73e4(0x2cb)+_0x388791[_0x4a73e4(0x2c6)]+_0x4a73e4(0x2c3))['emit'](_0x4a73e4(0x2cb)+_0x388791[_0x4a73e4(0x2c6)]+_0x4a73e4(0x259),{'action':'update','ticket':{..._0x388791[_0x4a73e4(0x1f5)],'status':'closed'}});logger_1[_0x4a73e4(0x2b2)][_0x4a73e4(0x248)](_0x4a73e4(0x23d)+_0x388791['id']+_0x4a73e4(0x2a8)+_0x52ee93+'\x20minutos\x20desde\x20o\x20aviso\x20(total:\x20'+_0x249744+_0x4a73e4(0x281));}catch(_0x319169){Sentry['captureException'](_0x319169),logger_1['logger'][_0x4a73e4(0x265)](_0x4a73e4(0x2d7)+_0x388791['id']+':\x20'+_0x319169[_0x4a73e4(0x2c1)]);}}}}else{if(_0x249744>=_0x3b9503[_0x4a73e4(0x2ae)])try{if(_0x3b9503[_0x4a73e4(0x244)])try{const _0x3e03a0=(0x0,wbot_1['getWbot'])(_0x3b9503['id']);_0x3e03a0&&_0x3e03a0['user']?(await(0x0,SendWhatsAppMessage_1[_0x4a73e4(0x2e3)])({'ticket':_0x388791,'body':_0x3b9503['expiresInactiveMessage']}),await new Promise(_0x4d7537=>setTimeout(_0x4d7537,0x3e8))):logger_1[_0x4a73e4(0x2b2)][_0x4a73e4(0x2aa)](_0x4a73e4(0x257)+_0x3b9503['id']+'\x20n√£o\x20conectado.\x20Pulando\x20envio\x20de\x20mensagem\x20para\x20ticket\x20#'+_0x388791['id']+'.');}catch(_0x585298){logger_1[_0x4a73e4(0x2b2)][_0x4a73e4(0x2e5)](_0x4a73e4(0x207)+_0x388791['id']+':\x20'+_0x585298[_0x4a73e4(0x2c1)]);}const _0x39fb37=_0x388791[_0x4a73e4(0x2bb)];await _0x388791[_0x4a73e4(0x2dd)]({'status':'closed','amountUsedBotQueues':0x0,'ticketsWithWarning':![],'warningSentAt':null});const _0x497c40=(0x0,socket_1['getIO'])();if(_0x39fb37===_0x4a73e4(0x217))_0x497c40['to'](_0x4a73e4(0x2cb)+_0x388791[_0x4a73e4(0x2c6)]+_0x4a73e4(0x1ef))['to'](_0x4a73e4(0x1de)+_0x388791['queueId']+'-open')[_0x4a73e4(0x301)]('company-'+_0x388791[_0x4a73e4(0x2c6)]+_0x4a73e4(0x259),{'action':_0x4a73e4(0x2dd),'ticket':{..._0x388791[_0x4a73e4(0x1f5)],'status':_0x4a73e4(0x2ce)}});else _0x39fb37==='pending'&&_0x497c40['to'](_0x4a73e4(0x2cb)+_0x388791[_0x4a73e4(0x2c6)]+_0x4a73e4(0x2c3))[_0x4a73e4(0x301)](_0x4a73e4(0x2cb)+_0x388791[_0x4a73e4(0x2c6)]+_0x4a73e4(0x259),{'action':'update','ticket':{..._0x388791[_0x4a73e4(0x1f5)],'status':_0x4a73e4(0x2ce)}});_0x497c40['to'](_0x4a73e4(0x2cb)+_0x388791[_0x4a73e4(0x2c6)]+_0x4a73e4(0x203))[_0x4a73e4(0x301)](_0x4a73e4(0x2cb)+_0x388791[_0x4a73e4(0x2c6)]+_0x4a73e4(0x259),{'action':_0x4a73e4(0x2dd),'ticket':{..._0x388791[_0x4a73e4(0x1f5)],'status':'closed'}}),logger_1[_0x4a73e4(0x2b2)][_0x4a73e4(0x248)](_0x4a73e4(0x23d)+_0x388791['id']+_0x4a73e4(0x300)+_0x249744+_0x4a73e4(0x1df)+_0x3b9503[_0x4a73e4(0x2ae)]+_0x4a73e4(0x2eb));}catch(_0x133dae){Sentry[_0x4a73e4(0x27c)](_0x133dae),logger_1[_0x4a73e4(0x2b2)][_0x4a73e4(0x265)](_0x4a73e4(0x2d7)+_0x388791['id']+':\x20'+_0x133dae[_0x4a73e4(0x2c1)]);}}}}}catch(_0x364713){Sentry[_0x4a73e4(0x27c)](_0x364713),logger_1[_0x4a73e4(0x2b2)][_0x4a73e4(0x265)]({'error':_0x364713},_0x4a73e4(0x23e));}}exports[a425_0x408c32(0x2f3)]=new bull_1[(a425_0x408c32(0x2e3))](a425_0x408c32(0x2a7),connection);async function handleSendMessage(_0x288733){const _0x251b10=a425_0x408c32;try{const {data:_0x37127d}=_0x288733,_0x54651b=await Whatsapp_1[_0x251b10(0x2e3)][_0x251b10(0x27d)](_0x37127d[_0x251b10(0x218)]);if(_0x54651b==null)throw Error('Whatsapp\x20n√£o\x20identificado');const _0x357fb9=_0x37127d['data'];await(0x0,SendMessage_1['SendMessage'])(_0x54651b,_0x357fb9);}catch(_0x5f27d7){Sentry[_0x251b10(0x27c)](_0x5f27d7),logger_1['logger']['error']({'error':_0x5f27d7},_0x251b10(0x296));throw _0x5f27d7;}}async function handleVerifySchedules(){const _0x111ed3=a425_0x408c32;try{const {count:_0x1050d4,rows:_0x38516a}=await Schedule_1[_0x111ed3(0x2e3)][_0x111ed3(0x2fd)]({'where':{'status':_0x111ed3(0x277),'sentAt':null,'sendAt':{[sequelize_1['Op'][_0x111ed3(0x2e7)]]:(0x0,moment_1[_0x111ed3(0x2e3)])()[_0x111ed3(0x27e)](0x1,_0x111ed3(0x20e))[_0x111ed3(0x278)]('YYYY-MM-DD\x20HH:mm:ss'),[sequelize_1['Op'][_0x111ed3(0x1d9)]]:(0x0,moment_1[_0x111ed3(0x2e3)])()[_0x111ed3(0x2e1)](0x1e,_0x111ed3(0x241))[_0x111ed3(0x278)](_0x111ed3(0x289))}},'include':[{'model':Contact_1[_0x111ed3(0x2e3)],'as':_0x111ed3(0x303)}]});_0x1050d4>0x0&&_0x38516a[_0x111ed3(0x27b)](async _0x5822fe=>{const _0x593ca8=_0x111ed3;await _0x5822fe['update']({'status':_0x593ca8(0x2d5)}),exports['sendScheduledMessages'][_0x593ca8(0x2e1)](_0x593ca8(0x1ed),{'schedule':_0x5822fe},{'delay':0x9c40}),logger_1[_0x593ca8(0x2b2)]['info']('Disparo\x20agendado\x20para:\x20'+_0x5822fe[_0x593ca8(0x303)][_0x593ca8(0x1db)]);});}catch(_0x55fded){Sentry[_0x111ed3(0x27c)](_0x55fded),logger_1[_0x111ed3(0x2b2)][_0x111ed3(0x265)]({'error':_0x55fded},_0x111ed3(0x2b5));throw _0x55fded;}}async function handleSendScheduledMessage(_0x2e4df5){const _0x1b4453=a425_0x408c32,{data:{schedule:_0x189446}}=_0x2e4df5;let _0x5c4e02=null;try{_0x5c4e02=await Schedule_1[_0x1b4453(0x2e3)][_0x1b4453(0x27d)](_0x189446['id'],{'include':[{'model':Contact_1[_0x1b4453(0x2e3)],'as':_0x1b4453(0x303)}]});if(!_0x5c4e02){logger_1[_0x1b4453(0x2b2)]['info'](_0x1b4453(0x2b8)+_0x189446['id']+_0x1b4453(0x1c7));return;}if(_0x5c4e02[_0x1b4453(0x2bb)]==='ENVIADA'||_0x5c4e02[_0x1b4453(0x285)]){logger_1['logger'][_0x1b4453(0x248)]('Agendamento\x20'+_0x189446['id']+'\x20j√°\x20foi\x20enviado');return;}}catch(_0x33cd6d){Sentry[_0x1b4453(0x27c)](_0x33cd6d),logger_1['logger'][_0x1b4453(0x248)]('Erro\x20ao\x20tentar\x20consultar\x20agendamento:\x20'+_0x189446['id']);return;}try{const _0x502f14=await(0x0,GetDefaultWhatsApp_1[_0x1b4453(0x2e3)])(_0x5c4e02[_0x1b4453(0x2c6)]),_0x586d0e=await(0x0,GetWhatsappWbot_1[_0x1b4453(0x2e3)])(_0x502f14),_0x1a5d5c=_0x5c4e02['contact'][_0x1b4453(0x270)][_0x1b4453(0x227)](),_0x4e58d1=_0x1a5d5c['includes']('@')?_0x1a5d5c:_0x1a5d5c+'@'+(_0x1a5d5c['length']>0xd?_0x1b4453(0x2c8):'s.whatsapp.net'),_0x2fe087={'contact':_0x5c4e02[_0x1b4453(0x303)],'queue':null,'company':null,'user':null,'whatsapp':_0x502f14},_0xdf830d=(0x0,Mustache_1[_0x1b4453(0x2e3)])(_0x5c4e02[_0x1b4453(0x290)],_0x2fe087),_0x37e347=await(0x0,SendMessage_1['SendMessage'])(_0x502f14,{'number':_0x5c4e02[_0x1b4453(0x303)][_0x1b4453(0x270)],'body':_0xdf830d});if(_0x5c4e02[_0x1b4453(0x228)]){const _0x4c2ca0=_0x5c4e02[_0x1b4453(0x228)];let _0x59a6d9={};if(_0x4c2ca0[_0x1b4453(0x306)](_0x1b4453(0x1cd))||_0x4c2ca0['startsWith'](_0x1b4453(0x1d6))){const _0x1b25d6=require(_0x1b4453(0x2a5)),_0x2d5ab7=require('mime-types'),_0x2de66f=await _0x1b25d6({'url':_0x4c2ca0,'method':_0x1b4453(0x2ba),'responseType':_0x1b4453(0x2d9)}),_0x53cc93=_0x2d5ab7[_0x1b4453(0x2fb)](_0x2de66f['headers'][_0x1b4453(0x276)])||_0x1b4453(0x305),_0xe770b4='temp_schedule_'+Date[_0x1b4453(0x1fa)]()+'.'+_0x53cc93,_0x4c6cbe=path_1[_0x1b4453(0x2e3)][_0x1b4453(0x1cb)](_0x1b4453(0x271),_0xe770b4);fs_1[_0x1b4453(0x2e3)]['writeFileSync'](_0x4c6cbe,_0x2de66f[_0x1b4453(0x1e7)]),_0x59a6d9=await(0x0,SendWhatsAppMedia_1['getMessageOptions'])(_0x5c4e02[_0x1b4453(0x25c)]||_0xe770b4,_0x4c6cbe),Object[_0x1b4453(0x2f2)](_0x59a6d9)[_0x1b4453(0x232)]&&await _0x586d0e[_0x1b4453(0x21c)](_0x4e58d1,{..._0x59a6d9}),setTimeout(()=>{const _0x3f9a10=_0x1b4453;try{fs_1[_0x3f9a10(0x2e3)][_0x3f9a10(0x1d1)](_0x4c6cbe);}catch(_0x57b859){}},0x1388);}else{let _0xbf57e3=path_1[_0x1b4453(0x2e3)][_0x1b4453(0x1cb)](_0x1b4453(0x271),_0x4c2ca0);!fs_1['default']['existsSync'](_0xbf57e3)&&(_0xbf57e3=path_1[_0x1b4453(0x2e3)][_0x1b4453(0x1cb)](_0x1b4453(0x271),'media',_0x4c2ca0)),fs_1[_0x1b4453(0x2e3)][_0x1b4453(0x2df)](_0xbf57e3)&&(_0x59a6d9=await(0x0,SendWhatsAppMedia_1['getMessageOptions'])(_0x5c4e02[_0x1b4453(0x25c)],_0xbf57e3),Object[_0x1b4453(0x2f2)](_0x59a6d9)[_0x1b4453(0x232)]&&await _0x586d0e['sendMessage'](_0x4e58d1,{..._0x59a6d9}));}}_0x5c4e02[_0x1b4453(0x29f)]&&(0x0,wbotMessageListener_1['handleMessage'])(_0x37e347,await(0x0,GetWhatsappWbot_1['default'])(_0x502f14),_0x5c4e02[_0x1b4453(0x2c6)]);await _0x5c4e02[_0x1b4453(0x2dd)]({'sentAt':new Date(),'status':'ENVIADA'}),logger_1[_0x1b4453(0x2b2)][_0x1b4453(0x248)](_0x1b4453(0x1f3)+_0x5c4e02['contact']['name']);_0x5c4e02[_0x1b4453(0x236)]&&await createTagLog(_0x5c4e02[_0x1b4453(0x236)],_0x5c4e02['companyId'],_0x1b4453(0x2fa),{'contact':_0x5c4e02[_0x1b4453(0x303)][_0x1b4453(0x1db)],'phoneNumber':_0x5c4e02[_0x1b4453(0x303)][_0x1b4453(0x270)],'message':_0xdf830d,'metadata':{'sentAt':new Date(),'messageId':_0x37e347[_0x1b4453(0x249)]['id']}});if(_0x5c4e02[_0x1b4453(0x22d)]&&_0x5c4e02[_0x1b4453(0x22d)]>0x0){const _0x1c7452=new Date(_0x5c4e02[_0x1b4453(0x24c)]);_0x1c7452[_0x1b4453(0x29b)](_0x1c7452[_0x1b4453(0x1fe)]()+_0x5c4e02['daysR']),logger_1['logger'][_0x1b4453(0x248)](_0x1b4453(0x24f)+_0x5c4e02[_0x1b4453(0x22d)]+_0x1b4453(0x254)+_0x1c7452[_0x1b4453(0x1f4)]());try{await Schedule_1[_0x1b4453(0x2e3)]['create']({'body':_0x5c4e02[_0x1b4453(0x290)],'sendAt':_0x1c7452,'contactId':_0x5c4e02[_0x1b4453(0x2a6)],'companyId':_0x5c4e02['companyId'],'userId':_0x5c4e02[_0x1b4453(0x230)],'saveMessage':_0x5c4e02[_0x1b4453(0x29f)],'status':_0x1b4453(0x277),'campId':_0x5c4e02[_0x1b4453(0x236)],'daysR':_0x5c4e02[_0x1b4453(0x22d)],'mediaPath':_0x5c4e02[_0x1b4453(0x228)],'mediaName':_0x5c4e02[_0x1b4453(0x25c)]}),logger_1['logger']['info']('Pr√≥ximo\x20agendamento\x20criado\x20com\x20sucesso\x20para\x20'+_0x1c7452[_0x1b4453(0x1f4)]());}catch(_0x197290){logger_1[_0x1b4453(0x2b2)][_0x1b4453(0x265)](_0x1b4453(0x261)+_0x197290);}}exports[_0x1b4453(0x247)][_0x1b4453(0x262)](0x3a98,'completed');}catch(_0xeef59b){Sentry['captureException'](_0xeef59b),await _0x5c4e02?.[_0x1b4453(0x2dd)]({'status':_0x1b4453(0x2ac)});_0x5c4e02?.[_0x1b4453(0x236)]&&await createTagLog(_0x5c4e02[_0x1b4453(0x236)],_0x5c4e02[_0x1b4453(0x2c6)],'error',{'contact':_0x5c4e02[_0x1b4453(0x303)]?.[_0x1b4453(0x1db)],'phoneNumber':_0x5c4e02[_0x1b4453(0x303)]?.[_0x1b4453(0x270)],'message':_0x5c4e02[_0x1b4453(0x290)],'metadata':{'error':_0xeef59b[_0x1b4453(0x2c1)]}});logger_1[_0x1b4453(0x2b2)]['error']({'error':_0xeef59b},_0x1b4453(0x219));throw _0xeef59b;}}async function handleVerifyCampaigns(){const _0x4fe47b=a425_0x408c32;logger_1['logger'][_0x4fe47b(0x248)](_0x4fe47b(0x1c2));const _0x589644=await database_1[_0x4fe47b(0x2e3)][_0x4fe47b(0x2b6)](_0x4fe47b(0x208),{'type':sequelize_1[_0x4fe47b(0x214)][_0x4fe47b(0x1dd)]});_0x589644[_0x4fe47b(0x232)]?(logger_1['logger'][_0x4fe47b(0x248)]('‚úÖ\x20Campanhas\x20PROGRAMADAS\x20encontradas:\x20'+_0x589644[_0x4fe47b(0x232)]),_0x589644[_0x4fe47b(0x1f7)](_0x1f01fb=>{const _0x127182=_0x4fe47b;logger_1[_0x127182(0x2b2)]['info'](_0x127182(0x226)+_0x1f01fb['id']+_0x127182(0x1fc)+_0x1f01fb[_0x127182(0x24a)]);})):logger_1['logger'][_0x4fe47b(0x248)](_0x4fe47b(0x1c9)),_0x589644[_0x4fe47b(0x1f7)](async _0x5b4803=>{const _0x4144f9=_0x4fe47b;try{const _0x13a8ad=await exports['campaignQueue'][_0x4144f9(0x2ec)]([_0x4144f9(0x25d),_0x4144f9(0x286),_0x4144f9(0x287)]),_0x9f31b=_0x13a8ad[_0x4144f9(0x213)](_0x1812bb=>_0x1812bb&&_0x1812bb[_0x4144f9(0x1e7)]&&_0x1812bb[_0x4144f9(0x1db)]===_0x4144f9(0x1c5)&&_0x1812bb[_0x4144f9(0x1e7)]['id']===_0x5b4803['id']);if(_0x9f31b){logger_1['logger'][_0x4144f9(0x248)]('‚è≠Ô∏è\x20\x20Campanha\x20ID='+_0x5b4803['id']+'\x20j√°\x20est√°\x20na\x20fila,\x20pulando...');return;}const _0x4f66c5=(0x0,moment_1[_0x4144f9(0x2e3)])(),_0xdbc7a1=(0x0,moment_1[_0x4144f9(0x2e3)])(_0x5b4803['scheduledAt']),_0x295e48=_0xdbc7a1[_0x4144f9(0x272)](_0x4f66c5,_0x4144f9(0x211));_0x295e48<0x0&&logger_1[_0x4144f9(0x2b2)][_0x4144f9(0x2e5)](_0x4144f9(0x26d)+_0x5b4803['id']+_0x4144f9(0x302)),logger_1['logger'][_0x4144f9(0x248)]('üì§\x20Campanha\x20enviada\x20para\x20a\x20fila:\x20ID='+_0x5b4803['id']+_0x4144f9(0x2e6)+_0x295e48+_0x4144f9(0x2bc)+(_0x295e48/0x3e8)[_0x4144f9(0x23b)](0x1)+'s)'),await exports['campaignQueue']['add'](_0x4144f9(0x1c5),{'id':_0x5b4803['id'],'delay':Math['max'](0x0,_0x295e48)},{'removeOnComplete':!![]});}catch(_0x19d1ad){Sentry[_0x4144f9(0x27c)](_0x19d1ad),logger_1[_0x4144f9(0x2b2)]['error']('‚ùå\x20Erro\x20ao\x20processar\x20campanha\x20'+_0x5b4803['id']+':\x20'+_0x19d1ad['message']),logger_1[_0x4144f9(0x2b2)][_0x4144f9(0x265)]('Stack:\x20'+_0x19d1ad[_0x4144f9(0x210)]);}});}async function getCampaign(_0x4bc03b){const _0x2bf7eb=a425_0x408c32;return Campaign_1[_0x2bf7eb(0x2e3)]['findByPk'](_0x4bc03b,{'include':[{'model':ContactList_1[_0x2bf7eb(0x2e3)],'as':'contactList','attributes':['id',_0x2bf7eb(0x1db)],'include':[{'model':ContactListItem_1[_0x2bf7eb(0x2e3)],'as':'contacts','attributes':['id','name',_0x2bf7eb(0x270),_0x2bf7eb(0x2c2),_0x2bf7eb(0x246)],'where':{'isWhatsappValid':!![]}}]},{'model':Whatsapp_1[_0x2bf7eb(0x2e3)],'as':'whatsapp','attributes':['id',_0x2bf7eb(0x1db)]},{'model':CampaignShipping_1[_0x2bf7eb(0x2e3)],'as':_0x2bf7eb(0x1c6),'include':[{'model':ContactListItem_1[_0x2bf7eb(0x2e3)],'as':'contact'}]}]});}async function getSettings(_0x23e097){const _0x225e9c=a425_0x408c32,_0xd6b0c7=await CampaignSetting_1['default'][_0x225e9c(0x24b)]({'where':{'companyId':_0x23e097[_0x225e9c(0x2c6)]},'attributes':[_0x225e9c(0x249),'value']});let _0x205b89=0x14,_0x2f91d1=0x14,_0x3c5302=0x3c,_0x56a49e=[];return _0xd6b0c7[_0x225e9c(0x1f7)](_0xfd36c1=>{const _0x31cec1=_0x225e9c;_0xfd36c1['key']===_0x31cec1(0x29d)&&(_0x205b89=JSON[_0x31cec1(0x1d7)](_0xfd36c1['value'])),_0xfd36c1[_0x31cec1(0x249)]==='longerIntervalAfter'&&(_0x2f91d1=JSON[_0x31cec1(0x1d7)](_0xfd36c1[_0x31cec1(0x21b)])),_0xfd36c1[_0x31cec1(0x249)]==='greaterInterval'&&(_0x3c5302=JSON[_0x31cec1(0x1d7)](_0xfd36c1[_0x31cec1(0x21b)])),_0xfd36c1[_0x31cec1(0x249)]===_0x31cec1(0x2a4)&&(_0x56a49e=JSON[_0x31cec1(0x1d7)](_0xfd36c1['value']));}),{'messageInterval':_0x205b89,'longerIntervalAfter':_0x2f91d1,'greaterInterval':_0x3c5302,'variables':_0x56a49e};}function parseToMilliseconds(_0x49b72a){return _0x49b72a*0x3e8;}async function sleep(_0x1c22c9){const _0x218bff=a425_0x408c32;return logger_1[_0x218bff(0x2b2)][_0x218bff(0x248)](_0x218bff(0x1e5)+_0x1c22c9+'\x20segundos\x20iniciado:\x20'+(0x0,moment_1[_0x218bff(0x2e3)])()['format'](_0x218bff(0x223))),new Promise(_0xa741ef=>{setTimeout(()=>{const _0x336dcb=a425_0x3e9c;logger_1[_0x336dcb(0x2b2)][_0x336dcb(0x248)](_0x336dcb(0x1e5)+_0x1c22c9+_0x336dcb(0x2d6)+(0x0,moment_1[_0x336dcb(0x2e3)])()['format'](_0x336dcb(0x223))),_0xa741ef(!![]);},parseToMilliseconds(_0x1c22c9));});}function getCampaignValidMessages(_0x566ce8){const _0x4b45dc=a425_0x408c32,_0xc8bc98=[];return!(0x0,lodash_1[_0x4b45dc(0x2be)])(_0x566ce8[_0x4b45dc(0x2ea)])&&!(0x0,lodash_1[_0x4b45dc(0x26c)])(_0x566ce8[_0x4b45dc(0x2ea)])&&_0xc8bc98[_0x4b45dc(0x28c)](_0x566ce8[_0x4b45dc(0x2ea)]),!(0x0,lodash_1[_0x4b45dc(0x2be)])(_0x566ce8[_0x4b45dc(0x1e9)])&&!(0x0,lodash_1['isNil'])(_0x566ce8[_0x4b45dc(0x1e9)])&&_0xc8bc98['push'](_0x566ce8[_0x4b45dc(0x1e9)]),!(0x0,lodash_1[_0x4b45dc(0x2be)])(_0x566ce8['message3'])&&!(0x0,lodash_1[_0x4b45dc(0x26c)])(_0x566ce8['message3'])&&_0xc8bc98[_0x4b45dc(0x28c)](_0x566ce8['message3']),!(0x0,lodash_1[_0x4b45dc(0x2be)])(_0x566ce8[_0x4b45dc(0x25a)])&&!(0x0,lodash_1[_0x4b45dc(0x26c)])(_0x566ce8[_0x4b45dc(0x25a)])&&_0xc8bc98[_0x4b45dc(0x28c)](_0x566ce8['message4']),!(0x0,lodash_1['isEmpty'])(_0x566ce8[_0x4b45dc(0x284)])&&!(0x0,lodash_1[_0x4b45dc(0x26c)])(_0x566ce8['message5'])&&_0xc8bc98[_0x4b45dc(0x28c)](_0x566ce8[_0x4b45dc(0x284)]),_0xc8bc98;}function getCampaignValidConfirmationMessages(_0x4404dc){const _0x3e3322=a425_0x408c32,_0x9105d2=[];return!(0x0,lodash_1[_0x3e3322(0x2be)])(_0x4404dc[_0x3e3322(0x266)])&&!(0x0,lodash_1[_0x3e3322(0x26c)])(_0x4404dc['confirmationMessage1'])&&_0x9105d2[_0x3e3322(0x28c)](_0x4404dc['confirmationMessage1']),!(0x0,lodash_1[_0x3e3322(0x2be)])(_0x4404dc[_0x3e3322(0x22c)])&&!(0x0,lodash_1[_0x3e3322(0x26c)])(_0x4404dc[_0x3e3322(0x22c)])&&_0x9105d2['push'](_0x4404dc[_0x3e3322(0x22c)]),!(0x0,lodash_1[_0x3e3322(0x2be)])(_0x4404dc['confirmationMessage3'])&&!(0x0,lodash_1[_0x3e3322(0x26c)])(_0x4404dc[_0x3e3322(0x273)])&&_0x9105d2[_0x3e3322(0x28c)](_0x4404dc[_0x3e3322(0x273)]),!(0x0,lodash_1[_0x3e3322(0x2be)])(_0x4404dc[_0x3e3322(0x275)])&&!(0x0,lodash_1['isNil'])(_0x4404dc[_0x3e3322(0x275)])&&_0x9105d2[_0x3e3322(0x28c)](_0x4404dc[_0x3e3322(0x275)]),!(0x0,lodash_1[_0x3e3322(0x2be)])(_0x4404dc['confirmationMessage5'])&&!(0x0,lodash_1['isNil'])(_0x4404dc[_0x3e3322(0x26b)])&&_0x9105d2[_0x3e3322(0x28c)](_0x4404dc[_0x3e3322(0x26b)]),_0x9105d2;}function a425_0x1387(){const _0x52931c=['5636088alTNFG','asDays','TicketMonitor','prototype','\x20(ID:\x20','hour','inactiveMessageTime','stack','milliseconds','\x20n√£o\x20conectado.\x20Pulando\x20envio\x20de\x20mensagem\x20para\x20ticket\x20#','some','QueryTypes','{nome}','ScheduleMonitor','open','whatsappId','SendScheduledMessage\x20->\x20SendMessage:\x20error','üì§\x20Job\x20criado\x20na\x20fila:\x20Campanha=','value','sendMessage','./services/WbotServices/StartWhatsAppSession','REDIS_OPT_LIMITER_MAX','parseToMilliseconds','\x20AND\x20\x22dueDate\x22::text\x20LIKE\x20\x27','path','constructor','HH:mm:ss','start','Disparo\x20de\x20campanha\x20solicitado:\x20Campanha=','\x20\x20üìã\x20Campanha\x20ID=','toString','mediaPath','üèÅ\x20Campanha\x20ID=','metadata','VerifyLoginStatus','confirmationMessage2','daysR','s\x20(','{email}','userId','process','length','*/20\x20*\x20*\x20*\x20*\x20*','Campaign\x20not\x20found','1405530cWEYiU','campId','./models/User','weeks','‚ùå\x20Campanha\x20ID=','writable','toFixed','then','Ticket\x20#','TicketMonitor\x20->\x20VerifyTicketExpiration:\x20erro','INSERT\x20INTO\x20\x22Invoices\x22\x20(detail,\x20status,\x20value,\x20\x22updatedAt\x22,\x20\x22createdAt\x22,\x20\x22dueDate\x22,\x20\x22companyId\x22)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20VALUES\x20(\x27','VerifyTicketExpiration','seconds','182609gdymsf','agent','expiresInactiveMessage','./models/Contact','isWhatsappValid','sendScheduledMessages','info','key','scheduledAt','findAll','sendAt','./models/Company','CONNECTED','Criando\x20pr√≥ximo\x20agendamento\x20(repeti√ß√£o\x20a\x20cada\x20','ticketMonitor','REDIS_OPT_LIMITER_DURATION','search','./models/CampaignLog','\x20dias):\x20','DispatchCampaign','72bDkoqb','WhatsApp\x20#','removeWbot','-ticket','message4','whenExpireTicket','mediaName','waiting','sleep','mensalmente','7895tBlbst','Erro\x20ao\x20criar\x20pr√≥ximo\x20agendamento:\x20','clean','phoneNumber','93331AVqnKS','error','confirmationMessage1','defineProperty','userMonitor','-campaign','\x22\x20n√£o\x20possui\x20contatos\x20v√°lidos!','confirmationMessage5','isNil','‚ö†Ô∏è\x20\x20Campanha\x20ID=','%\x27;','18622940UKCRUC','number','public','diff','confirmationMessage3','(((.+)+)+)+$','confirmationMessage4','content-type','PENDENTE','format','\x20n√£o\x20conectado.\x20Pulando\x20envio\x20de\x20aviso\x20para\x20ticket\x20#','INSERT','map','captureException','findByPk','subtract','*\x20*\x20*\x20*\x20*','getOwnPropertyDescriptor','\x20minutos\x20desde\x20a\x20√∫ltima\x20mensagem)','mycount','\x20possui\x20','message5','sentAt','delayed','active','warningSentAt','YYYY-MM-DD\x20HH:mm:ss','call','\x20n√£o\x20encontrada!','push','confirmed','\x20minutos\x20de\x20inatividade','\x20contatos\x20v√°lidos','body','SendSacheduledMessages','valids','toJSON','startQueueProcess','getOwnPropertyNames','MessageQueue\x20->\x20SendMessage:\x20error','getWbot','Erro\x20ao\x20criar\x20log\x20de\x20campanha:\x20','pending','AutoRestart','setDate','count','messageInterval','processing','saveMessage','lastRestartAt','headers','TicketInactiveWarning','period','variables','axios','contactId','CampaignQueue','\x20encerrado\x20por\x20inatividade\x20ap√≥s\x20','\x27,\x20\x27open\x27,\x20\x27','debug','handleWhatsappAutoRestart','ERRO','testMode','expiresTicket','minutes','__importStar','floor','logger','\x20n√£o\x20possui\x20lista\x20de\x20contatos\x20vinculada!','simulation','SendScheduledMessage\x20->\x20Verify:\x20error','query','ms)','Agendamento\x20','./models/Campaign','GET','status','ms\x20(','REDIS_URI','isEmpty','semanalmente','\x20FINALIZADA!\x20Todos\x20os\x20','message','email','-pending','confirmation','./services/CampaignService/ShowService','companyId','whatsapp','lid','mime-types','\x27,\x20','company-','@s.whatsapp.net','greaterInterval','closed','cron','isArray','longerIntervalAfter','DispatchConfirmedCampaign','\x20iniciada!\x20Status:\x20EM_ANDAMENTO','\x20-\x20Lista\x20\x22','AGENDADA','\x20segundos\x20finalizado:\x20','Erro\x20ao\x20encerrar\x20ticket\x20#','./models/Whatsapp','arraybuffer','diariamente','./libs/wbot','findOrCreate','update','create','existsSync','./helpers/GetDefaultWhatsApp','add','./models/CampaignShipping','default','inactiveMessage','warn',',\x20Delay=','gte','./models/Ticket','messages','message1','\x20minutos).','getJobs','./models/TagLog','createdAt','confirmationMessage','Verify','EM_ANDAMENTO','keys','campaignQueue','StartWhatsAppSession',')\x20de\x20acordo\x20com\x20o\x20per√≠odo\x20(','__esModule','./services/WbotServices/SendWhatsAppMedia','campaignId','delivered','send','extension','getIO','findAndCountAll','whatsappRestartQueue','Usu√°rio\x20passado\x20para\x20offline:\x20','\x20fechado\x20por\x20inatividade\x20ap√≥s\x20','emit','\x20est√°\x20atrasada!\x20Executando\x20imediatamente...','contact','confirmationRequestedAt','bin','startsWith',';Delay=','confirmationRequested','SELECT\x20id,\x20\x22expiresTicket\x22,\x20\x22companyId\x22,\x20\x22whenExpireTicket\x22,\x0a\x20\x20\x20\x22expiresInactiveMessage\x22,\x20\x22inactiveMessage\x22,\x20\x22inactiveMessageTime\x22\x0a\x20\x20\x20FROM\x20\x22Whatsapps\x22\x20WHERE\x20\x22expiresTicket\x22\x20>\x200','üîç\x20Verificando\x20campanhas\x20programadas...','Erro\x20ao\x20reiniciar\x20conex√µes\x20WhatsApp\x20periodicamente:\x20','Aviso\x20de\x20inatividade\x20enviado\x20para\x20o\x20ticket\x20#','ProcessCampaign','shipping','\x20n√£o\x20encontrado\x20ou\x20j√°\x20foi\x20processado',';Contato=','‚ÑπÔ∏è\x20\x20Nenhuma\x20campanha\x20programada\x20para\x20a\x20pr√≥xima\x20hora','scheduleMonitor','resolve','messageQueue','http://','Erro\x20ao\x20criar\x20log\x20de\x20tag:\x20','UserMonitor','8188155mjTskM','unlinkSync','replace','fromMe','-tag-log','writeFileSync','https://','parse','1276OucKau','lte','getMessageOptions','name','set','SELECT','queue-','\x20minutos\x20(configurado:\x20','‚ùå\x20Erro\x20ao\x20processar\x20campanha:\x20',',\x20Nome=\x22','üìã\x20Processando\x20campanha:\x20ID=','CronJob','randomValue','Sleep\x20de\x20','months','data','temp_campaign_','message2','16ygLnNF','VerifyCampaignsDaatabase','\x20contatos\x20foram\x20processados.','SendMessage','SELECT\x20COUNT(*)\x20mycount\x20FROM\x20\x22Invoices\x22\x20WHERE\x20\x22companyId\x22\x20=\x20','-open','./models/Schedule','Reiniciando\x20conex√£o\x20WhatsApp\x20','./models/Message','Mensagem\x20agendada\x20enviada\x20para:\x20','toISOString','dataValues','get','forEach','DD/MM/yyyy','planId','now','deliveredAt',',\x20Agendada\x20para:\x20','\x27,\x20\x27','getDate','random','env','contactList','sequelize','-closed','./database','./libs/socket','includes','Erro\x20ao\x20enviar\x20mensagem\x20de\x20encerramento\x20para\x20ticket\x20#','select\x20id,\x20\x22scheduledAt\x22\x20from\x20\x22Campaigns\x22\x20c\x0a\x20\x20\x20\x20where\x20\x22scheduledAt\x22\x20between\x20now()\x20-\x20\x275\x20minutes\x27::interval\x20and\x20now()\x20+\x20\x271\x20hour\x27::interval\x20\x0a\x20\x20\x20\x20and\x20status\x20=\x20\x27PROGRAMADA\x27'];a425_0x1387=function(){return _0x52931c;};return a425_0x1387();}function getProcessedMessage(_0x19191f,_0x1ab47f,_0x1aab1d){const _0x37e959=a425_0x408c32;let _0x29080d=_0x19191f;return _0x29080d['includes'](_0x37e959(0x215))&&(_0x29080d=_0x29080d['replace'](/{nome}/g,_0x1aab1d[_0x37e959(0x1db)])),_0x29080d[_0x37e959(0x206)](_0x37e959(0x22f))&&(_0x29080d=_0x29080d[_0x37e959(0x1d2)](/{email}/g,_0x1aab1d[_0x37e959(0x2c2)])),_0x29080d[_0x37e959(0x206)]('{numero}')&&(_0x29080d=_0x29080d[_0x37e959(0x1d2)](/{numero}/g,_0x1aab1d[_0x37e959(0x270)])),_0x1ab47f[_0x37e959(0x1f7)](_0x58cae1=>{const _0x5372b3=_0x37e959;if(_0x29080d['includes']('{'+_0x58cae1[_0x5372b3(0x249)]+'}')){const _0x33eaed=new RegExp('{'+_0x58cae1[_0x5372b3(0x249)]+'}','g');_0x29080d=_0x29080d['replace'](_0x33eaed,_0x58cae1[_0x5372b3(0x21b)]);}}),_0x29080d;}function randomValue(_0x1c0b57,_0x2d53e0){const _0x308f03=a425_0x408c32;return Math[_0x308f03(0x2b1)](Math[_0x308f03(0x1ff)]()*_0x2d53e0)+_0x1c0b57;}async function createTagLog(_0x5aeb11,_0x3481e7,_0x11c34c,_0x383de2={}){const _0xa4a8fa=a425_0x408c32;try{const _0x69a188=await TagLog_1['default'][_0xa4a8fa(0x2de)]({'tagId':_0x5aeb11,'type':_0x11c34c,'contact':_0x383de2[_0xa4a8fa(0x303)]||null,'phoneNumber':_0x383de2[_0xa4a8fa(0x263)]||null,'message':_0x383de2['message']||null,'metadata':_0x383de2[_0xa4a8fa(0x22a)]||null}),_0x55997b=(0x0,socket_1[_0xa4a8fa(0x2fc)])();return _0x55997b[_0xa4a8fa(0x301)](_0xa4a8fa(0x2cb)+_0x3481e7+_0xa4a8fa(0x1d4),{'action':'create','tagId':_0x5aeb11,'log':_0x69a188['toJSON']()}),_0x69a188;}catch(_0x214a3d){logger_1['logger']['error'](_0xa4a8fa(0x1ce)+_0x214a3d);}}async function createCampaignLog(_0x118d6c,_0x67723e,_0x380f06,_0x340585={}){const _0x15c672=a425_0x408c32;try{const _0x792d51=await CampaignLog_1[_0x15c672(0x2e3)][_0x15c672(0x2de)]({'campaignId':_0x118d6c,'type':_0x380f06,'contact':_0x340585[_0x15c672(0x303)]||null,'phoneNumber':_0x340585[_0x15c672(0x263)]||null,'position':_0x340585['position']||null,'message':_0x340585['message']||null,'metadata':_0x340585[_0x15c672(0x22a)]||null}),_0x16e303=(0x0,socket_1[_0x15c672(0x2fc)])();return _0x16e303['emit'](_0x15c672(0x2cb)+_0x67723e+'-campaign-log',{'action':_0x15c672(0x2de),'campaignId':_0x118d6c,'log':_0x792d51[_0x15c672(0x293)]()}),_0x792d51;}catch(_0x5505b1){logger_1['logger'][_0x15c672(0x265)](_0x15c672(0x298)+_0x5505b1);}}async function verifyAndFinalizeCampaign(_0x31dd32){const _0x2477da=a425_0x408c32,_0x114fe0=await(0x0,ShowService_1[_0x2477da(0x2e3)])(_0x31dd32['id']);_0x114fe0[_0x2477da(0x292)]===_0x114fe0[_0x2477da(0x2f9)]?(await _0x31dd32[_0x2477da(0x2dd)]({'status':'FINALIZADA','completedAt':(0x0,moment_1['default'])()}),logger_1[_0x2477da(0x2b2)]['info'](_0x2477da(0x229)+_0x31dd32['id']+_0x2477da(0x2c0)+_0x114fe0[_0x2477da(0x2f9)]+_0x2477da(0x1ec)),await createCampaignLog(_0x31dd32['id'],_0x31dd32[_0x2477da(0x2c6)],'complete',{'metadata':{'totalProcessed':_0x114fe0[_0x2477da(0x2f9)],'totalValid':_0x114fe0['valids'],'confirmationRequested':_0x114fe0[_0x2477da(0x1c0)],'confirmed':_0x114fe0['confirmed']}})):logger_1['logger'][_0x2477da(0x248)]('üìä\x20Progresso\x20Campanha\x20ID='+_0x31dd32['id']+':\x20'+_0x114fe0[_0x2477da(0x2f9)]+'/'+_0x114fe0['valids']+'\x20enviados');const _0x1aeff1=await Campaign_1[_0x2477da(0x2e3)][_0x2477da(0x27d)](_0x31dd32['id'],{'include':[{'model':ContactList_1[_0x2477da(0x2e3)],'attributes':['id',_0x2477da(0x1db)]},{'model':Whatsapp_1['default'],'attributes':['id',_0x2477da(0x1db)]}]}),_0x201060=(0x0,socket_1['getIO'])();_0x201060[_0x2477da(0x301)](_0x2477da(0x2cb)+_0x31dd32['companyId']+_0x2477da(0x269),{'action':_0x2477da(0x2dd),'record':{..._0x1aeff1['toJSON'](),'statistics':{'valids':_0x114fe0[_0x2477da(0x292)],'delivered':_0x114fe0[_0x2477da(0x2f9)],'confirmationRequested':_0x114fe0[_0x2477da(0x1c0)],'confirmed':_0x114fe0[_0x2477da(0x28d)]}}});}async function prepareContact(_0x4556f8,_0x58b63b,_0x1fab57,_0x56d288,_0x30f59f,_0x457b7a){const _0x71c9b8=a425_0x408c32,_0x285a57={};_0x285a57[_0x71c9b8(0x270)]=_0x1fab57['number'],_0x285a57[_0x71c9b8(0x2a6)]=_0x1fab57['id'],_0x285a57['campaignId']=_0x4556f8['id'];if(_0x30f59f['length']){const _0x590b4a=randomValue(0x0,_0x30f59f[_0x71c9b8(0x232)]),_0x858e0e=getProcessedMessage(_0x30f59f[_0x590b4a],_0x58b63b,_0x1fab57);_0x285a57[_0x71c9b8(0x2c1)]=''+_0x858e0e;}if(_0x4556f8['confirmation']){if(_0x457b7a[_0x71c9b8(0x232)]){const _0x211d80=randomValue(0x0,_0x457b7a[_0x71c9b8(0x232)]),_0x54a857=getProcessedMessage(_0x457b7a[_0x211d80],_0x58b63b,_0x1fab57);_0x285a57['confirmationMessage']=''+_0x54a857;}}const [_0x461ee3,_0x78a7fa]=await CampaignShipping_1[_0x71c9b8(0x2e3)][_0x71c9b8(0x2dc)]({'where':{'campaignId':_0x285a57[_0x71c9b8(0x2f8)],'contactId':_0x285a57[_0x71c9b8(0x2a6)]},'defaults':_0x285a57});!_0x78a7fa&&_0x461ee3[_0x71c9b8(0x1fb)]===null&&_0x461ee3[_0x71c9b8(0x304)]===null&&(_0x461ee3[_0x71c9b8(0x1dc)](_0x285a57),await _0x461ee3['save']());if(_0x461ee3[_0x71c9b8(0x1fb)]===null&&_0x461ee3['confirmationRequestedAt']===null){const _0x29f32e=await exports[_0x71c9b8(0x2f3)][_0x71c9b8(0x2e1)]('DispatchCampaign',{'campaignId':_0x4556f8['id'],'campaignShippingId':_0x461ee3['id'],'contactListItemId':_0x1fab57['id']},{'delay':_0x56d288});await _0x461ee3['update']({'jobId':''+_0x29f32e['id']});}}async function handleProcessCampaign(_0x2d23ec){const _0x338a30=a425_0x408c32;try{const {id:_0x2098ed}=_0x2d23ec[_0x338a30(0x1e7)];let {delay:_0x22d353}=_0x2d23ec[_0x338a30(0x1e7)];const _0x158db3=await getCampaign(_0x2098ed);if(!_0x158db3){logger_1[_0x338a30(0x2b2)][_0x338a30(0x265)](_0x338a30(0x239)+_0x2098ed+_0x338a30(0x28b));return;}logger_1['logger'][_0x338a30(0x248)](_0x338a30(0x1e2)+_0x158db3['id']+_0x338a30(0x1e1)+_0x158db3[_0x338a30(0x1db)]+'\x22');if(!_0x158db3[_0x338a30(0x201)]){logger_1['logger'][_0x338a30(0x265)](_0x338a30(0x239)+_0x2098ed+_0x338a30(0x2b3));return;}if(!_0x158db3[_0x338a30(0x2c7)]){logger_1['logger'][_0x338a30(0x265)](_0x338a30(0x239)+_0x2098ed+'\x20n√£o\x20possui\x20WhatsApp\x20vinculado!');return;}const _0x11356e=await getSettings(_0x158db3);if(_0x158db3){const {contacts:_0xb6c91b}=_0x158db3[_0x338a30(0x201)];if(!_0xb6c91b||_0xb6c91b['length']===0x0){logger_1[_0x338a30(0x2b2)][_0x338a30(0x265)](_0x338a30(0x239)+_0x2098ed+_0x338a30(0x2d4)+_0x158db3[_0x338a30(0x201)][_0x338a30(0x1db)]+_0x338a30(0x26a));return;}logger_1[_0x338a30(0x2b2)][_0x338a30(0x248)]('‚úÖ\x20Campanha\x20ID='+_0x2098ed+_0x338a30(0x283)+_0xb6c91b[_0x338a30(0x232)]+_0x338a30(0x28f)),await createCampaignLog(_0x158db3['id'],_0x158db3[_0x338a30(0x2c6)],_0x338a30(0x29e),{'metadata':{'totalContacts':_0xb6c91b['length'],'messageInterval':_0x11356e[_0x338a30(0x29d)],'longerIntervalAfter':_0x11356e['longerIntervalAfter'],'greaterInterval':_0x11356e[_0x338a30(0x2cd)]}});const _0x1f2c3c=getCampaignValidMessages(_0x158db3),_0x9d5a50=_0x158db3[_0x338a30(0x2c4)]?getCampaignValidConfirmationMessages(_0x158db3):null;if((0x0,lodash_1[_0x338a30(0x2d0)])(_0xb6c91b)){let _0x4a06aa=0x0;_0xb6c91b[_0x338a30(0x1f7)](_0x561ff2=>{const _0x53a096=_0x338a30;prepareContact(_0x158db3,_0x11356e['variables'],_0x561ff2,_0x22d353,_0x1f2c3c,_0x9d5a50)[_0x53a096(0x23c)](()=>{const _0x4e234f=_0x53a096,_0x3427f7=(_0x22d353/0x3e8)['toFixed'](0x1);logger_1[_0x4e234f(0x2b2)][_0x4e234f(0x248)](_0x4e234f(0x21a)+_0x158db3['id']+_0x4e234f(0x1c8)+_0x561ff2[_0x4e234f(0x1db)]+_0x4e234f(0x307)+_0x3427f7+_0x4e234f(0x22e)+_0x22d353+_0x4e234f(0x2b7));}),_0x4a06aa+=0x1,_0x4a06aa%_0x11356e[_0x53a096(0x2d1)]===0x0?_0x22d353+=parseToMilliseconds(_0x11356e[_0x53a096(0x2cd)]):_0x22d353+=parseToMilliseconds(randomValue(0x0,_0x11356e[_0x53a096(0x29d)]));}),await _0x158db3[_0x338a30(0x2dd)]({'status':_0x338a30(0x2f1)}),logger_1[_0x338a30(0x2b2)][_0x338a30(0x248)]('üöÄ\x20Campanha\x20ID='+_0x2098ed+_0x338a30(0x2d3)),await createCampaignLog(_0x158db3['id'],_0x158db3['companyId'],_0x338a30(0x224),{'metadata':{'status':'EM_ANDAMENTO','totalJobs':_0xb6c91b[_0x338a30(0x232)]}});const _0x5804d9=(0x0,socket_1[_0x338a30(0x2fc)])();_0x5804d9['emit']('company-'+_0x158db3[_0x338a30(0x2c6)]+_0x338a30(0x269),{'action':_0x338a30(0x2dd),'record':_0x158db3});}}}catch(_0x1c6dd5){Sentry[_0x338a30(0x27c)](_0x1c6dd5),logger_1[_0x338a30(0x2b2)][_0x338a30(0x265)](_0x338a30(0x1e0)+_0x1c6dd5[_0x338a30(0x2c1)]),logger_1[_0x338a30(0x2b2)][_0x338a30(0x265)](_0x1c6dd5['stack']);}}async function handleDispatchCampaign(_0x334cd1){const _0x64ed0b=a425_0x408c32;try{const {data:_0x368758}=_0x334cd1,{campaignShippingId:_0x5ab029,campaignId:_0x45b9d3}=_0x368758,_0x2c72b9=await Campaign_1[_0x64ed0b(0x2e3)]['findByPk'](_0x45b9d3,{'include':[{'model':Whatsapp_1[_0x64ed0b(0x2e3)],'as':_0x64ed0b(0x2c7)}]});if(!_0x2c72b9){logger_1[_0x64ed0b(0x2b2)][_0x64ed0b(0x265)]({'data':_0x368758},_0x64ed0b(0x234));return;}const _0x5a5a32=await(0x0,GetWhatsappWbot_1[_0x64ed0b(0x2e3)])(_0x2c72b9[_0x64ed0b(0x2c7)]);logger_1['logger'][_0x64ed0b(0x248)](_0x64ed0b(0x225)+_0x45b9d3+';Registro='+_0x5ab029);const _0x54d275=await CampaignShipping_1[_0x64ed0b(0x2e3)][_0x64ed0b(0x27d)](_0x5ab029,{'include':[{'model':ContactListItem_1[_0x64ed0b(0x2e3)],'as':_0x64ed0b(0x303)}]});if(_0x2c72b9[_0x64ed0b(0x2ad)]){logger_1[_0x64ed0b(0x2b2)][_0x64ed0b(0x2e5)]('üß™\x20MODO\x20TESTE\x20ATIVADO\x20-\x20Simulando\x20envio:\x20Campanha='+_0x45b9d3+_0x64ed0b(0x1c8)+_0x54d275[_0x64ed0b(0x303)][_0x64ed0b(0x1db)]+';N√∫mero='+_0x54d275['number']);const _0x2bd1f0=await getSettings(_0x2c72b9),_0x599cf2=await CampaignShipping_1['default'][_0x64ed0b(0x29c)]({'where':{'campaignId':_0x2c72b9['id'],'deliveredAt':{[sequelize_1['Op']['ne']]:null}}});await createCampaignLog(_0x2c72b9['id'],_0x2c72b9[_0x64ed0b(0x2c6)],_0x64ed0b(0x2b4),{'contact':_0x54d275[_0x64ed0b(0x303)][_0x64ed0b(0x1db)],'phoneNumber':_0x54d275['number'],'position':_0x599cf2+0x1,'message':_0x54d275['message'],'metadata':{'confirmationRequested':_0x2c72b9[_0x64ed0b(0x2c4)]&&_0x54d275[_0x64ed0b(0x2c4)]===null,'confirmationMessage':_0x54d275[_0x64ed0b(0x2ef)],'mediaPath':_0x2c72b9[_0x64ed0b(0x228)],'mediaName':_0x2c72b9[_0x64ed0b(0x25c)],'settings':{'messageInterval':_0x2bd1f0[_0x64ed0b(0x29d)],'longerIntervalAfter':_0x2bd1f0[_0x64ed0b(0x2d1)],'greaterInterval':_0x2bd1f0[_0x64ed0b(0x2cd)]}}}),_0x2c72b9[_0x64ed0b(0x2c4)]&&_0x54d275[_0x64ed0b(0x2c4)]===null?await _0x54d275[_0x64ed0b(0x2dd)]({'confirmationRequestedAt':(0x0,moment_1[_0x64ed0b(0x2e3)])()}):await _0x54d275[_0x64ed0b(0x2dd)]({'deliveredAt':(0x0,moment_1['default'])()}),logger_1['logger'][_0x64ed0b(0x248)]('üß™\x20Simula√ß√£o\x20conclu√≠da:\x20Campanha='+_0x45b9d3+_0x64ed0b(0x1c8)+_0x54d275[_0x64ed0b(0x303)][_0x64ed0b(0x1db)]);}else{const _0x5be306=_0x54d275[_0x64ed0b(0x270)]+_0x64ed0b(0x2cc),_0x364944=await(0x0,GetWhatsappWbot_1[_0x64ed0b(0x2e3)])(_0x2c72b9[_0x64ed0b(0x2c7)]);if(_0x2c72b9[_0x64ed0b(0x2c4)]&&_0x54d275[_0x64ed0b(0x2c4)]===null)await _0x364944[_0x64ed0b(0x21c)](_0x5be306,{'text':_0x54d275[_0x64ed0b(0x2ef)]}),await _0x54d275[_0x64ed0b(0x2dd)]({'confirmationRequestedAt':(0x0,moment_1[_0x64ed0b(0x2e3)])()}),await createCampaignLog(_0x2c72b9['id'],_0x2c72b9[_0x64ed0b(0x2c6)],_0x64ed0b(0x2fa),{'contact':_0x54d275['contact'][_0x64ed0b(0x1db)],'phoneNumber':_0x54d275[_0x64ed0b(0x270)],'message':_0x54d275[_0x64ed0b(0x2ef)],'metadata':{'type':_0x64ed0b(0x2c4),'messageId':null}});else{await _0x364944[_0x64ed0b(0x21c)](_0x5be306,{'text':_0x54d275[_0x64ed0b(0x2c1)]});if(_0x2c72b9[_0x64ed0b(0x228)]){const _0x31d496=_0x2c72b9['mediaPath'];let _0x473971={};if(_0x31d496[_0x64ed0b(0x306)](_0x64ed0b(0x1cd))||_0x31d496[_0x64ed0b(0x306)](_0x64ed0b(0x1d6))){const _0x5ff6f3=require(_0x64ed0b(0x2a5)),_0x4974c6=require(_0x64ed0b(0x2c9)),_0x4b0ced=await _0x5ff6f3({'url':_0x31d496,'method':_0x64ed0b(0x2ba),'responseType':_0x64ed0b(0x2d9)}),_0x3379d5=_0x4974c6['extension'](_0x4b0ced[_0x64ed0b(0x2a1)][_0x64ed0b(0x276)])||_0x64ed0b(0x305),_0x5667db=_0x64ed0b(0x1e8)+Date['now']()+'.'+_0x3379d5,_0x336348=path_1[_0x64ed0b(0x2e3)][_0x64ed0b(0x1cb)]('public',_0x5667db);fs_1[_0x64ed0b(0x2e3)][_0x64ed0b(0x1d5)](_0x336348,_0x4b0ced['data']),_0x473971=await(0x0,SendWhatsAppMedia_1['getMessageOptions'])(_0x2c72b9[_0x64ed0b(0x25c)]||_0x5667db,_0x336348),setTimeout(()=>fs_1['default'][_0x64ed0b(0x1d1)](_0x336348),0x1388);}else{const _0x5150da=path_1[_0x64ed0b(0x2e3)]['resolve'](_0x64ed0b(0x271),_0x31d496);fs_1['default'][_0x64ed0b(0x2df)](_0x5150da)&&(_0x473971=await(0x0,SendWhatsAppMedia_1[_0x64ed0b(0x1da)])(_0x2c72b9[_0x64ed0b(0x25c)],_0x5150da));}Object[_0x64ed0b(0x2f2)](_0x473971)['length']&&await _0x364944['sendMessage'](_0x5be306,{..._0x473971});}await _0x54d275[_0x64ed0b(0x2dd)]({'deliveredAt':(0x0,moment_1[_0x64ed0b(0x2e3)])()}),await createCampaignLog(_0x2c72b9['id'],_0x2c72b9['companyId'],_0x64ed0b(0x2fa),{'contact':_0x54d275[_0x64ed0b(0x303)][_0x64ed0b(0x1db)],'phoneNumber':_0x54d275[_0x64ed0b(0x270)],'message':_0x54d275[_0x64ed0b(0x2c1)],'metadata':{'type':_0x64ed0b(0x2c1),'hasMedia':!!_0x2c72b9[_0x64ed0b(0x228)],'mediaName':_0x2c72b9[_0x64ed0b(0x25c)]}});}logger_1[_0x64ed0b(0x2b2)]['info']('Campanha\x20enviada\x20para:\x20Campanha='+_0x45b9d3+_0x64ed0b(0x1c8)+_0x54d275[_0x64ed0b(0x303)]['name']);}await verifyAndFinalizeCampaign(_0x2c72b9);}catch(_0x3a4672){Sentry['captureException'](_0x3a4672),logger_1[_0x64ed0b(0x2b2)]['error'](_0x3a4672['message']);}}async function handleLoginStatus(){const _0x16ea7d=a425_0x408c32,_0x349a18=await database_1[_0x16ea7d(0x2e3)][_0x16ea7d(0x2b6)]('select\x20id\x20from\x20\x22Users\x22\x20where\x20\x22updatedAt\x22\x20<\x20now()\x20-\x20\x275\x20minutes\x27::interval\x20and\x20online\x20=\x20true',{'type':sequelize_1['QueryTypes'][_0x16ea7d(0x1dd)]});_0x349a18[_0x16ea7d(0x1f7)](async _0x10057d=>{const _0x2eb293=_0x16ea7d;try{const _0x6f2b7d=await User_1[_0x2eb293(0x2e3)]['findByPk'](_0x10057d['id']);await _0x6f2b7d['update']({'online':![]}),logger_1[_0x2eb293(0x2b2)]['info'](_0x2eb293(0x2ff)+_0x10057d['id']);}catch(_0x374084){Sentry[_0x2eb293(0x27c)](_0x374084);}});}async function handleInvoiceCreate(){const _0x27ca18=a425_0x408c32,_0x1e804f=new cron_1[(_0x27ca18(0x1e3))]('0\x20*\x20*\x20*\x20*\x20*',async()=>{const _0x4d7b77=_0x27ca18,_0x6413ff=await Company_1['default']['findAll']();_0x6413ff[_0x4d7b77(0x27b)](async _0x42f007=>{const _0x171e13=_0x4d7b77,{dueDate:_0x42781b}=_0x42f007,_0x20cf61=(0x0,moment_1[_0x171e13(0x2e3)])(_0x42781b)['format'](),_0x19495c=(0x0,moment_1[_0x171e13(0x2e3)])()[_0x171e13(0x278)](),_0x2b4de5=(0x0,moment_1[_0x171e13(0x2e3)])((0x0,moment_1[_0x171e13(0x2e3)])())[_0x171e13(0x278)](_0x171e13(0x1f8)),_0x426f42=(0x0,moment_1[_0x171e13(0x2e3)])(_0x42781b)[_0x171e13(0x278)](_0x171e13(0x1f8)),_0x5b3247=(0x0,moment_1['default'])(_0x426f42,'DD/MM/yyyy')[_0x171e13(0x272)]((0x0,moment_1[_0x171e13(0x2e3)])(_0x2b4de5,'DD/MM/yyyy')),_0x9077cb=moment_1['default']['duration'](_0x5b3247)[_0x171e13(0x20a)]();if(_0x9077cb<0x14){const _0x6c9029=await Plan_1[_0x171e13(0x2e3)][_0x171e13(0x27d)](_0x42f007[_0x171e13(0x1f9)]),_0x2be36e=_0x171e13(0x1ee)+_0x42f007['id']+_0x171e13(0x220)+(0x0,moment_1[_0x171e13(0x2e3)])(_0x42781b)[_0x171e13(0x278)]('yyyy-MM-DD')+_0x171e13(0x26e),_0xf2217d=await database_1['default'][_0x171e13(0x2b6)](_0x2be36e,{'type':sequelize_1['QueryTypes']['SELECT']});if(+_0xf2217d[0x0][_0x171e13(0x282)]===0x0){const _0x1817f4=_0x171e13(0x23f)+_0x6c9029['name']+_0x171e13(0x2a9)+_0x6c9029['value']+_0x171e13(0x1fd)+_0x19495c+_0x171e13(0x1fd)+_0x19495c+_0x171e13(0x1fd)+_0x20cf61+_0x171e13(0x2ca)+_0x42f007['id']+');';await database_1[_0x171e13(0x2e3)]['query'](_0x1817f4,{'type':sequelize_1['QueryTypes'][_0x171e13(0x27a)]});}}});});_0x1e804f[_0x27ca18(0x224)]();}handleInvoiceCreate();async function startQueueProcess(){const _0x7949e1=a425_0x408c32;logger_1[_0x7949e1(0x2b2)][_0x7949e1(0x248)]('Iniciando\x20processamento\x20de\x20filas'),exports[_0x7949e1(0x1cc)][_0x7949e1(0x231)]('SendMessage',handleSendMessage),exports[_0x7949e1(0x1ca)]['process'](_0x7949e1(0x2f0),handleVerifySchedules),exports[_0x7949e1(0x247)][_0x7949e1(0x231)](_0x7949e1(0x1ed),handleSendScheduledMessage),exports[_0x7949e1(0x2f3)][_0x7949e1(0x231)](_0x7949e1(0x1eb),handleVerifyCampaigns),exports[_0x7949e1(0x2f3)]['process'](_0x7949e1(0x1c5),handleProcessCampaign),exports['campaignQueue']['process'](_0x7949e1(0x255),handleDispatchCampaign),exports[_0x7949e1(0x268)]['process']('VerifyLoginStatus',handleLoginStatus),exports[_0x7949e1(0x2f3)][_0x7949e1(0x231)](_0x7949e1(0x2d2),handleDispatchCampaign),exports[_0x7949e1(0x250)][_0x7949e1(0x231)](_0x7949e1(0x240),handleVerifyTicketExpiration),exports[_0x7949e1(0x2fe)][_0x7949e1(0x231)](_0x7949e1(0x29a),handleWhatsappAutoRestart),exports[_0x7949e1(0x1ca)][_0x7949e1(0x2e1)](_0x7949e1(0x2f0),{},{'repeat':{'cron':'*/5\x20*\x20*\x20*\x20*\x20*'},'removeOnComplete':!![]}),exports[_0x7949e1(0x2f3)]['add']('VerifyCampaignsDaatabase',{},{'repeat':{'cron':_0x7949e1(0x233)},'removeOnComplete':!![]}),exports[_0x7949e1(0x268)][_0x7949e1(0x2e1)](_0x7949e1(0x22b),{},{'repeat':{'cron':_0x7949e1(0x27f)},'removeOnComplete':!![]}),exports['ticketMonitor']['add']('VerifyTicketExpiration',{},{'repeat':{'cron':'*/30\x20*\x20*\x20*\x20*\x20*'},'removeOnComplete':!![]}),exports[_0x7949e1(0x2fe)][_0x7949e1(0x2e1)](_0x7949e1(0x29a),{},{'repeat':{'cron':'0\x20*\x20*\x20*\x20*'},'removeOnComplete':!![]});}