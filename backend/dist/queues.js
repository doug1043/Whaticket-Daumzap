'use strict';const a340_0x95ff22=a340_0x599f;(function(_0x288a16,_0x519319){const _0x3c31eb=a340_0x599f,_0x3e384e=_0x288a16();while(!![]){try{const _0x43b621=-parseInt(_0x3c31eb(0xec))/0x1+-parseInt(_0x3c31eb(0xa3))/0x2+-parseInt(_0x3c31eb(0xf0))/0x3+-parseInt(_0x3c31eb(0x6e))/0x4+parseInt(_0x3c31eb(0xe5))/0x5*(parseInt(_0x3c31eb(0xfb))/0x6)+parseInt(_0x3c31eb(0x72))/0x7+-parseInt(_0x3c31eb(0xd4))/0x8*(-parseInt(_0x3c31eb(0xa1))/0x9);if(_0x43b621===_0x519319)break;else _0x3e384e['push'](_0x3e384e['shift']());}catch(_0x1f9bc5){_0x3e384e['push'](_0x3e384e['shift']());}}}(a340_0x2c97,0x54d3a));var __createBinding=this&&this[a340_0x95ff22(0x114)]||(Object[a340_0x95ff22(0x110)]?function(_0x4040e1,_0x1da9e3,_0x3ceb92,_0x59f48b){const _0x45204b=a340_0x95ff22;if(_0x59f48b===undefined)_0x59f48b=_0x3ceb92;var _0x2fcab3=Object[_0x45204b(0x8d)](_0x1da9e3,_0x3ceb92);(!_0x2fcab3||(_0x45204b(0xa5)in _0x2fcab3?!_0x1da9e3['__esModule']:_0x2fcab3['writable']||_0x2fcab3['configurable']))&&(_0x2fcab3={'enumerable':!![],'get':function(){return _0x1da9e3[_0x3ceb92];}}),Object[_0x45204b(0x122)](_0x4040e1,_0x59f48b,_0x2fcab3);}:function(_0x531bf0,_0x4ad2d4,_0x3d98cf,_0x475a2b){if(_0x475a2b===undefined)_0x475a2b=_0x3d98cf;_0x531bf0[_0x475a2b]=_0x4ad2d4[_0x3d98cf];}),__setModuleDefault=this&&this[a340_0x95ff22(0xdd)]||(Object[a340_0x95ff22(0x110)]?function(_0x299778,_0x3722c6){const _0x24a7fd=a340_0x95ff22;Object[_0x24a7fd(0x122)](_0x299778,_0x24a7fd(0xf1),{'enumerable':!![],'value':_0x3722c6});}:function(_0x5600f0,_0x1b3836){_0x5600f0['default']=_0x1b3836;}),__importStar=this&&this[a340_0x95ff22(0xaf)]||(function(){const _0x4e4d7b=(function(){let _0x4fca54=!![];return function(_0x104ad4,_0x4e2989){const _0x4cdaef=_0x4fca54?function(){const _0x471db4=a340_0x599f;if(_0x4e2989){const _0x3ee595=_0x4e2989[_0x471db4(0xbe)](_0x104ad4,arguments);return _0x4e2989=null,_0x3ee595;}}:function(){};return _0x4fca54=![],_0x4cdaef;};}()),_0x406517=_0x4e4d7b(this,function(){const _0x408ccc=a340_0x599f;return _0x406517[_0x408ccc(0xe2)]()['search'](_0x408ccc(0x111))[_0x408ccc(0xe2)]()[_0x408ccc(0x94)](_0x406517)[_0x408ccc(0xd1)](_0x408ccc(0x111));});_0x406517();var _0x307756=function(_0x454ed0){const _0x359040=a340_0x599f;return _0x307756=Object[_0x359040(0xee)]||function(_0x174967){const _0x229e27=_0x359040;var _0x34dfe6=[];for(var _0x33d476 in _0x174967)if(Object[_0x229e27(0x78)][_0x229e27(0xe9)]['call'](_0x174967,_0x33d476))_0x34dfe6[_0x34dfe6[_0x229e27(0xf2)]]=_0x33d476;return _0x34dfe6;},_0x307756(_0x454ed0);};return function(_0x532f41){const _0x3f3e11=a340_0x599f;if(_0x532f41&&_0x532f41['__esModule'])return _0x532f41;var _0x162233={};if(_0x532f41!=null){for(var _0x54188a=_0x307756(_0x532f41),_0x506335=0x0;_0x506335<_0x54188a[_0x3f3e11(0xf2)];_0x506335++)if(_0x54188a[_0x506335]!==_0x3f3e11(0xf1))__createBinding(_0x162233,_0x532f41,_0x54188a[_0x506335]);}return __setModuleDefault(_0x162233,_0x532f41),_0x162233;};}()),__importDefault=this&&this['__importDefault']||function(_0x536f35){return _0x536f35&&_0x536f35['__esModule']?_0x536f35:{'default':_0x536f35};};Object[a340_0x95ff22(0x122)](exports,a340_0x95ff22(0x11d),{'value':!![]}),exports[a340_0x95ff22(0xbb)]=exports[a340_0x95ff22(0x88)]=exports[a340_0x95ff22(0x127)]=exports['scheduleMonitor']=exports[a340_0x95ff22(0x90)]=exports[a340_0x95ff22(0xdc)]=void 0x0,exports['parseToMilliseconds']=parseToMilliseconds,exports['sleep']=sleep,exports[a340_0x95ff22(0xd0)]=randomValue,exports[a340_0x95ff22(0x130)]=startQueueProcess;const Sentry=__importStar(require('@sentry/node')),bull_1=__importDefault(require('bull')),moment_1=__importDefault(require(a340_0x95ff22(0x7b))),sequelize_1=require(a340_0x95ff22(0x76)),lodash_1=require('lodash'),path_1=__importDefault(require('path')),cron_1=require(a340_0x95ff22(0x12b)),SendMessage_1=require(a340_0x95ff22(0x86)),Whatsapp_1=__importDefault(require(a340_0x95ff22(0xab))),logger_1=require(a340_0x95ff22(0x128)),Schedule_1=__importDefault(require(a340_0x95ff22(0xce))),Contact_1=__importDefault(require('./models/Contact')),GetDefaultWhatsApp_1=__importDefault(require(a340_0x95ff22(0xdf))),Campaign_1=__importDefault(require('./models/Campaign')),ContactList_1=__importDefault(require('./models/ContactList')),ContactListItem_1=__importDefault(require(a340_0x95ff22(0x8b))),CampaignSetting_1=__importDefault(require(a340_0x95ff22(0x129))),CampaignShipping_1=__importDefault(require(a340_0x95ff22(0xd5))),GetWhatsappWbot_1=__importDefault(require('./helpers/GetWhatsappWbot')),database_1=__importDefault(require(a340_0x95ff22(0xe0))),SendWhatsAppMedia_1=require(a340_0x95ff22(0xc9)),socket_1=require(a340_0x95ff22(0xb5)),User_1=__importDefault(require('./models/User')),Company_1=__importDefault(require(a340_0x95ff22(0xa7))),Plan_1=__importDefault(require(a340_0x95ff22(0x117))),wbotMessageListener_1=require(a340_0x95ff22(0x9f)),ShowService_1=__importDefault(require(a340_0x95ff22(0x10d))),Ticket_1=__importDefault(require(a340_0x95ff22(0xe6))),connection=process[a340_0x95ff22(0xde)][a340_0x95ff22(0x82)]||'',limiterMax=process['env'][a340_0x95ff22(0xf8)]||0x1,limiterDuration=process[a340_0x95ff22(0xde)][a340_0x95ff22(0x92)]||0xbb8;exports[a340_0x95ff22(0xdc)]=new bull_1['default'](a340_0x95ff22(0xba),connection),exports[a340_0x95ff22(0x90)]=new bull_1[(a340_0x95ff22(0xf1))]('MessageQueue',connection,{'limiter':{'max':limiterMax,'duration':limiterDuration}}),exports[a340_0x95ff22(0xf9)]=new bull_1[(a340_0x95ff22(0xf1))](a340_0x95ff22(0x118),connection),exports[a340_0x95ff22(0x127)]=new bull_1[(a340_0x95ff22(0xf1))]('SendSacheduledMessages',connection),exports[a340_0x95ff22(0x88)]=new bull_1[(a340_0x95ff22(0xf1))](a340_0x95ff22(0x84),connection);async function handleVerifyTicketExpiration(){const _0x546f43=a340_0x95ff22;try{const _0x1cb880=await database_1[_0x546f43(0xf1)][_0x546f43(0xc4)](_0x546f43(0x11a),{'type':sequelize_1[_0x546f43(0x115)]['SELECT']});for(const _0x351022 of _0x1cb880){const _0xd6f3fd=await Ticket_1['default'][_0x546f43(0x96)]({'where':{'status':{[sequelize_1['Op']['in']]:[_0x546f43(0xc1),'pending']},'whatsappId':_0x351022['id'],'companyId':_0x351022[_0x546f43(0x83)],'createdAt':{[sequelize_1['Op']['lt']]:(0x0,moment_1[_0x546f43(0xf1)])()['subtract'](_0x351022[_0x546f43(0x80)],_0x546f43(0xad))[_0x546f43(0x11b)]()}}});for(const _0x1ffc00 of _0xd6f3fd){logger_1['logger']['info'](_0x546f43(0xcb)+_0x1ffc00['id']+_0x546f43(0xfe)+_0x351022[_0x546f43(0x80)]+_0x546f43(0x7c)),await _0x1ffc00[_0x546f43(0xf3)]({'status':_0x546f43(0x121),'amountUsedBotQueues':0x0});const _0x32d909=(0x0,socket_1[_0x546f43(0x11e)])();_0x32d909['to']('company-'+_0x1ffc00[_0x546f43(0x83)]+'-'+_0x1ffc00[_0x546f43(0xea)])['to'](_0x546f43(0x98)+_0x1ffc00[_0x546f43(0x124)]+'-'+_0x1ffc00[_0x546f43(0xea)])[_0x546f43(0xa2)](_0x546f43(0x100)+_0x1ffc00[_0x546f43(0x83)]+_0x546f43(0xd2),{'action':'update','ticket':_0x1ffc00});}_0xd6f3fd[_0x546f43(0xf2)]>0x0&&logger_1['logger']['info'](_0x546f43(0x108)+_0xd6f3fd[_0x546f43(0xf2)]+'\x20expired\x20tickets\x20for\x20company\x20'+_0x351022['companyId']);}}catch(_0x3df04c){Sentry[_0x546f43(0xa8)](_0x3df04c),logger_1['logger']['error']('TicketMonitor\x20->\x20VerifyTicketExpiration:\x20error',_0x3df04c[_0x546f43(0x10e)]);}}exports[a340_0x95ff22(0xbb)]=new bull_1[(a340_0x95ff22(0xf1))](a340_0x95ff22(0xae),connection);function a340_0x2c97(){const _0x47262d=['search','-ticket','add','9392otGQim','./models/CampaignShipping','format','planId','YYYY-MM-DD\x20HH:mm:ss','Campanha\x20enviada\x20para:\x20Campanha=','message1','longerIntervalAfter','userMonitor','__setModuleDefault','env','./helpers/GetDefaultWhatsApp','./database','data','toString','confirmationMessage2','key','967885hvustY','./models/Ticket','number','message2','hasOwnProperty','status','DispatchConfirmedCampaign','299461PNVjfQ','parse','getOwnPropertyNames','push','1400418UfXGzJ','default','length','update','includes','save','Verify',',\x20Delay\x20Inicial=','REDIS_OPT_LIMITER_MAX','scheduleMonitor','lte','6KpniBg','-campaign','completed','\x20after\x20','duration','company-','shipping',';Contato=','messageInterval','map','*/5\x20*\x20*\x20*\x20*\x20*','INSERT\x20INTO\x20\x22Invoices\x22\x20(detail,\x20status,\x20value,\x20\x22updatedAt\x22,\x20\x22createdAt\x22,\x20\x22dueDate\x22,\x20\x22companyId\x22)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20VALUES\x20(\x27','Whatsapp\x20não\x20identificado','Closed\x20','replace','EM_ANDAMENTO','name','resolve','./services/CampaignService/ShowService','message','handleMessage','create','(((.+)+)+)+$','Campanha\x20enviada\x20para\x20a\x20fila\x20de\x20processamento:\x20Campanha=','logger','__createBinding','QueryTypes','contactId','./models/Plan','ScheduleMonitor','campaignId','SELECT\x20id,\x20\x22expiresTicket\x22,\x20\x22companyId\x22\x20FROM\x20\x22Whatsapps\x22\x20WHERE\x20\x22expiresTicket\x22\x20>\x200','toDate','{nome}','__esModule','getIO','HH:mm:ss','message4','closed','defineProperty','milliseconds','queueId','*\x20*\x20*\x20*\x20*','VerifyTicketExpiration','sendScheduledMessages','./utils/logger','./models/CampaignSetting','greaterInterval','cron','findOrCreate','mediaPath','process','floor','startQueueProcess','ENVIADA','*/20\x20*\x20*\x20*\x20*\x20*','VerifyCampaignsDaatabase','keys','Mensagem\x20agendada\x20enviada\x20para:\x20','865564dPLNyk','forEach','diff','\x27,\x20\x27','4738629TmSYnF','delivered','SendMessage','@s.whatsapp.net','sequelize','gte','prototype','SELECT','SendScheduledMessage\x20->\x20Verify:\x20error','moment','\x20minutes','findAndCountAll','contactList','AGENDADA','expiresTicket','Registro\x20enviado\x20pra\x20fila\x20de\x20disparo:\x20Campanha=','REDIS_URI','companyId','TicketMonitor','confirmationMessage5','./helpers/SendMessage','{numero}','ticketMonitor','sendMessage','PENDENTE','./models/ContactListItem','saveMessage','getOwnPropertyDescriptor','whatsappId','value','messageQueue','ProcessCampaign','REDIS_OPT_LIMITER_DURATION','Campanhas\x20encontradas:\x20','constructor','contacts','findAll','Sleep\x20de\x20','queue-','DispatchCampaign','\x20AND\x20\x22dueDate\x22::text\x20LIKE\x20\x27','SendScheduledMessage\x20->\x20SendMessage:\x20error','confirmationRequestedAt','confirmationMessage1','select\x20id\x20from\x20\x22Users\x22\x20where\x20\x22updatedAt\x22\x20<\x20now()\x20-\x20\x275\x20minutes\x27::interval\x20and\x20online\x20=\x20true','./services/WbotServices/wbotMessageListener','confirmationMessage','4941aFNapF','emit','369884PHDtMx','confirmationMessage4','get',';Registro=','./models/Company','captureException','findByPk','message3','./models/Whatsapp','INSERT','minutes','CampaignQueue','__importStar','error','isNil','info','ERRO','set','./libs/socket','email','contact','valids','isArray','UserMonitor','campaignQueue','CronJob','confirmation','apply','whatsapp','%\x27;','open','isEmpty','MessageQueue\x20->\x20SendMessage:\x20error','query','body','confirmationMessage3','VerifyLoginStatus','DD/MM/yyyy','./services/WbotServices/SendWhatsAppMedia',';Delay=','Closing\x20expired\x20ticket\x20#','isWhatsappValid','deliveredAt','./models/Schedule','getMessageOptions','randomValue'];a340_0x2c97=function(){return _0x47262d;};return a340_0x2c97();}async function handleSendMessage(_0x3ed5b9){const _0x338619=a340_0x95ff22;try{const {data:_0x5792b6}=_0x3ed5b9,_0x22d841=await Whatsapp_1[_0x338619(0xf1)]['findByPk'](_0x5792b6[_0x338619(0x8e)]);if(_0x22d841==null)throw Error(_0x338619(0x107));const _0x1ff898=_0x5792b6[_0x338619(0xe1)];await(0x0,SendMessage_1[_0x338619(0x74)])(_0x22d841,_0x1ff898);}catch(_0x2e0643){Sentry[_0x338619(0xa8)](_0x2e0643),logger_1['logger']['error'](_0x338619(0xc3),_0x2e0643['message']);throw _0x2e0643;}}async function handleVerifySchedules(){const _0x480909=a340_0x95ff22;try{const {count:_0x3c8432,rows:_0x142973}=await Schedule_1[_0x480909(0xf1)][_0x480909(0x7d)]({'where':{'status':_0x480909(0x8a),'sentAt':null,'sendAt':{[sequelize_1['Op'][_0x480909(0x77)]]:(0x0,moment_1['default'])()[_0x480909(0xd6)](_0x480909(0xd8)),[sequelize_1['Op'][_0x480909(0xfa)]]:(0x0,moment_1['default'])()[_0x480909(0xd3)]('30','seconds')[_0x480909(0xd6)]('YYYY-MM-DD\x20HH:mm:ss')}},'include':[{'model':Contact_1['default'],'as':_0x480909(0xb7)}]});_0x3c8432>0x0&&_0x142973[_0x480909(0x104)](async _0x4c1471=>{const _0x10f477=_0x480909;await _0x4c1471[_0x10f477(0xf3)]({'status':_0x10f477(0x7f)}),exports[_0x10f477(0x127)][_0x10f477(0xd3)](_0x10f477(0x74),{'schedule':_0x4c1471},{'delay':0x9c40}),logger_1[_0x10f477(0x113)]['info']('Disparo\x20agendado\x20para:\x20'+_0x4c1471['contact']['name']);});}catch(_0x230a09){Sentry['captureException'](_0x230a09),logger_1[_0x480909(0x113)][_0x480909(0xb0)](_0x480909(0x7a),_0x230a09[_0x480909(0x10e)]);throw _0x230a09;}}async function handleSendScheduledMessage(_0x495ac7){const _0x5328e7=a340_0x95ff22,{data:{schedule:_0x1f4bd7}}=_0x495ac7;let _0x350f69=null;try{_0x350f69=await Schedule_1[_0x5328e7(0xf1)][_0x5328e7(0xa9)](_0x1f4bd7['id']);}catch(_0x405364){Sentry[_0x5328e7(0xa8)](_0x405364),logger_1[_0x5328e7(0x113)][_0x5328e7(0xb2)]('Erro\x20ao\x20tentar\x20consultar\x20agendamento:\x20'+_0x1f4bd7['id']);}try{const _0x20a960=await(0x0,GetDefaultWhatsApp_1[_0x5328e7(0xf1)])(_0x1f4bd7[_0x5328e7(0x83)]),_0x4b19b0=await(0x0,SendMessage_1[_0x5328e7(0x74)])(_0x20a960,{'number':_0x1f4bd7[_0x5328e7(0xb7)][_0x5328e7(0xe7)],'body':_0x1f4bd7[_0x5328e7(0xc5)]});_0x1f4bd7[_0x5328e7(0x8c)]&&(0x0,wbotMessageListener_1[_0x5328e7(0x10f)])(_0x4b19b0,await(0x0,GetWhatsappWbot_1[_0x5328e7(0xf1)])(_0x20a960),_0x1f4bd7['companyId']),await _0x350f69?.['update']({'sentAt':new Date(),'status':_0x5328e7(0x131)}),logger_1['logger'][_0x5328e7(0xb2)](_0x5328e7(0x6d)+_0x1f4bd7[_0x5328e7(0xb7)][_0x5328e7(0x10b)]),exports[_0x5328e7(0x127)]['clean'](0x3a98,_0x5328e7(0xfd));}catch(_0x3081d5){Sentry['captureException'](_0x3081d5),await _0x350f69?.[_0x5328e7(0xf3)]({'status':_0x5328e7(0xb3)}),logger_1[_0x5328e7(0x113)][_0x5328e7(0xb0)](_0x5328e7(0x9b),_0x3081d5[_0x5328e7(0x10e)]);throw _0x3081d5;}}async function handleVerifyCampaigns(){const _0x1b6562=a340_0x95ff22,_0x10a7fc=await database_1['default'][_0x1b6562(0xc4)]('select\x20id,\x20\x22scheduledAt\x22\x20from\x20\x22Campaigns\x22\x20c\x0a\x20\x20\x20\x20where\x20\x22scheduledAt\x22\x20between\x20now()\x20and\x20now()\x20+\x20\x271\x20hour\x27::interval\x20and\x20status\x20=\x20\x27PROGRAMADA\x27',{'type':sequelize_1[_0x1b6562(0x115)][_0x1b6562(0x79)]});_0x10a7fc[_0x1b6562(0xf2)]&&logger_1[_0x1b6562(0x113)][_0x1b6562(0xb2)](_0x1b6562(0x93)+_0x10a7fc['length']),_0x10a7fc['forEach'](_0x3a0174=>{const _0x1df994=_0x1b6562;try{const _0x43fc8e=(0x0,moment_1['default'])(),_0x3fab06=(0x0,moment_1[_0x1df994(0xf1)])(_0x3a0174['scheduledAt']),_0x4b652e=_0x3fab06[_0x1df994(0x70)](_0x43fc8e,_0x1df994(0x123));logger_1[_0x1df994(0x113)][_0x1df994(0xb2)](_0x1df994(0x112)+_0x3a0174['id']+_0x1df994(0xf7)+_0x4b652e),exports['campaignQueue']['add'](_0x1df994(0x91),{'id':_0x3a0174['id'],'delay':_0x4b652e},{'removeOnComplete':!![]});}catch(_0x10209b){Sentry['captureException'](_0x10209b);}});}async function getCampaign(_0x1c0c9c){const _0x5e3a00=a340_0x95ff22;return Campaign_1['default'][_0x5e3a00(0xa9)](_0x1c0c9c,{'include':[{'model':ContactList_1[_0x5e3a00(0xf1)],'as':_0x5e3a00(0x7e),'attributes':['id',_0x5e3a00(0x10b)],'include':[{'model':ContactListItem_1[_0x5e3a00(0xf1)],'as':_0x5e3a00(0x95),'attributes':['id',_0x5e3a00(0x10b),_0x5e3a00(0xe7),_0x5e3a00(0xb6),_0x5e3a00(0xcc)],'where':{'isWhatsappValid':!![]}}]},{'model':Whatsapp_1[_0x5e3a00(0xf1)],'as':_0x5e3a00(0xbf),'attributes':['id',_0x5e3a00(0x10b)]},{'model':CampaignShipping_1[_0x5e3a00(0xf1)],'as':_0x5e3a00(0x101),'include':[{'model':ContactListItem_1[_0x5e3a00(0xf1)],'as':_0x5e3a00(0xb7)}]}]});}async function getSettings(_0x35345d){const _0x5793d8=a340_0x95ff22,_0x62190=await CampaignSetting_1[_0x5793d8(0xf1)][_0x5793d8(0x96)]({'where':{'companyId':_0x35345d[_0x5793d8(0x83)]},'attributes':[_0x5793d8(0xe4),_0x5793d8(0x8f)]});let _0x1d5885=0x14,_0x9c1833=0x14,_0x293760=0x3c,_0x3b15a9=[];return _0x62190[_0x5793d8(0x6f)](_0x50189a=>{const _0x9f7f75=_0x5793d8;_0x50189a['key']===_0x9f7f75(0x103)&&(_0x1d5885=JSON[_0x9f7f75(0xed)](_0x50189a['value'])),_0x50189a[_0x9f7f75(0xe4)]===_0x9f7f75(0xdb)&&(_0x9c1833=JSON[_0x9f7f75(0xed)](_0x50189a[_0x9f7f75(0x8f)])),_0x50189a[_0x9f7f75(0xe4)]===_0x9f7f75(0x12a)&&(_0x293760=JSON['parse'](_0x50189a[_0x9f7f75(0x8f)])),_0x50189a[_0x9f7f75(0xe4)]==='variables'&&(_0x3b15a9=JSON[_0x9f7f75(0xed)](_0x50189a[_0x9f7f75(0x8f)]));}),{'messageInterval':_0x1d5885,'longerIntervalAfter':_0x9c1833,'greaterInterval':_0x293760,'variables':_0x3b15a9};}function parseToMilliseconds(_0x2ef051){return _0x2ef051*0x3e8;}function a340_0x599f(_0x25bc69,_0x1ff42a){const _0x34e9f5=a340_0x2c97();return a340_0x599f=function(_0x34d9b9,_0x227d8b){_0x34d9b9=_0x34d9b9-0x6d;let _0x2c9716=_0x34e9f5[_0x34d9b9];return _0x2c9716;},a340_0x599f(_0x25bc69,_0x1ff42a);}async function sleep(_0x1bda21){const _0x26789f=a340_0x95ff22;return logger_1['logger'][_0x26789f(0xb2)](_0x26789f(0x97)+_0x1bda21+'\x20segundos\x20iniciado:\x20'+(0x0,moment_1[_0x26789f(0xf1)])()['format'](_0x26789f(0x11f))),new Promise(_0x356012=>{setTimeout(()=>{const _0x4292fb=a340_0x599f;logger_1[_0x4292fb(0x113)][_0x4292fb(0xb2)](_0x4292fb(0x97)+_0x1bda21+'\x20segundos\x20finalizado:\x20'+(0x0,moment_1[_0x4292fb(0xf1)])()['format'](_0x4292fb(0x11f))),_0x356012(!![]);},parseToMilliseconds(_0x1bda21));});}function getCampaignValidMessages(_0xb6946f){const _0x5ad775=a340_0x95ff22,_0x3ff4cf=[];return!(0x0,lodash_1[_0x5ad775(0xc2)])(_0xb6946f[_0x5ad775(0xda)])&&!(0x0,lodash_1['isNil'])(_0xb6946f[_0x5ad775(0xda)])&&_0x3ff4cf[_0x5ad775(0xef)](_0xb6946f[_0x5ad775(0xda)]),!(0x0,lodash_1[_0x5ad775(0xc2)])(_0xb6946f[_0x5ad775(0xe8)])&&!(0x0,lodash_1['isNil'])(_0xb6946f[_0x5ad775(0xe8)])&&_0x3ff4cf['push'](_0xb6946f[_0x5ad775(0xe8)]),!(0x0,lodash_1['isEmpty'])(_0xb6946f[_0x5ad775(0xaa)])&&!(0x0,lodash_1['isNil'])(_0xb6946f['message3'])&&_0x3ff4cf[_0x5ad775(0xef)](_0xb6946f[_0x5ad775(0xaa)]),!(0x0,lodash_1[_0x5ad775(0xc2)])(_0xb6946f[_0x5ad775(0x120)])&&!(0x0,lodash_1['isNil'])(_0xb6946f['message4'])&&_0x3ff4cf['push'](_0xb6946f[_0x5ad775(0x120)]),!(0x0,lodash_1['isEmpty'])(_0xb6946f['message5'])&&!(0x0,lodash_1[_0x5ad775(0xb1)])(_0xb6946f['message5'])&&_0x3ff4cf[_0x5ad775(0xef)](_0xb6946f['message5']),_0x3ff4cf;}function getCampaignValidConfirmationMessages(_0xe92e1d){const _0x3b251e=a340_0x95ff22,_0x1fb369=[];return!(0x0,lodash_1[_0x3b251e(0xc2)])(_0xe92e1d['confirmationMessage1'])&&!(0x0,lodash_1[_0x3b251e(0xb1)])(_0xe92e1d['confirmationMessage1'])&&_0x1fb369[_0x3b251e(0xef)](_0xe92e1d[_0x3b251e(0x9d)]),!(0x0,lodash_1['isEmpty'])(_0xe92e1d[_0x3b251e(0xe3)])&&!(0x0,lodash_1[_0x3b251e(0xb1)])(_0xe92e1d[_0x3b251e(0xe3)])&&_0x1fb369[_0x3b251e(0xef)](_0xe92e1d['confirmationMessage2']),!(0x0,lodash_1[_0x3b251e(0xc2)])(_0xe92e1d[_0x3b251e(0xc6)])&&!(0x0,lodash_1[_0x3b251e(0xb1)])(_0xe92e1d[_0x3b251e(0xc6)])&&_0x1fb369[_0x3b251e(0xef)](_0xe92e1d[_0x3b251e(0xc6)]),!(0x0,lodash_1[_0x3b251e(0xc2)])(_0xe92e1d[_0x3b251e(0xa4)])&&!(0x0,lodash_1[_0x3b251e(0xb1)])(_0xe92e1d[_0x3b251e(0xa4)])&&_0x1fb369[_0x3b251e(0xef)](_0xe92e1d[_0x3b251e(0xa4)]),!(0x0,lodash_1[_0x3b251e(0xc2)])(_0xe92e1d[_0x3b251e(0x85)])&&!(0x0,lodash_1[_0x3b251e(0xb1)])(_0xe92e1d[_0x3b251e(0x85)])&&_0x1fb369[_0x3b251e(0xef)](_0xe92e1d[_0x3b251e(0x85)]),_0x1fb369;}function getProcessedMessage(_0x55a6c2,_0x4b1adb,_0x10d632){const _0x2f135f=a340_0x95ff22;let _0x418db0=_0x55a6c2;return _0x418db0[_0x2f135f(0xf4)](_0x2f135f(0x11c))&&(_0x418db0=_0x418db0[_0x2f135f(0x109)](/{nome}/g,_0x10d632[_0x2f135f(0x10b)])),_0x418db0[_0x2f135f(0xf4)]('{email}')&&(_0x418db0=_0x418db0[_0x2f135f(0x109)](/{email}/g,_0x10d632[_0x2f135f(0xb6)])),_0x418db0[_0x2f135f(0xf4)](_0x2f135f(0x87))&&(_0x418db0=_0x418db0[_0x2f135f(0x109)](/{numero}/g,_0x10d632['number'])),_0x4b1adb[_0x2f135f(0x6f)](_0x2edeef=>{const _0x10a9e2=_0x2f135f;if(_0x418db0[_0x10a9e2(0xf4)]('{'+_0x2edeef[_0x10a9e2(0xe4)]+'}')){const _0x28e6db=new RegExp('{'+_0x2edeef[_0x10a9e2(0xe4)]+'}','g');_0x418db0=_0x418db0[_0x10a9e2(0x109)](_0x28e6db,_0x2edeef[_0x10a9e2(0x8f)]);}}),_0x418db0;}function randomValue(_0x5cb35f,_0x324a8b){const _0x35ca7a=a340_0x95ff22;return Math[_0x35ca7a(0x12f)](Math['random']()*_0x324a8b)+_0x5cb35f;}async function verifyAndFinalizeCampaign(_0x336d49){const _0x47eca4=a340_0x95ff22,_0x3426d7=await(0x0,ShowService_1[_0x47eca4(0xf1)])(_0x336d49['id']);_0x3426d7[_0x47eca4(0xb8)]===_0x3426d7[_0x47eca4(0x73)]&&await _0x336d49[_0x47eca4(0xf3)]({'status':'FINALIZADA','completedAt':(0x0,moment_1[_0x47eca4(0xf1)])()});const _0x8a9a72=(0x0,socket_1[_0x47eca4(0x11e)])();_0x8a9a72[_0x47eca4(0xa2)](_0x47eca4(0x100)+_0x336d49[_0x47eca4(0x83)]+_0x47eca4(0xfc),_0x3426d7);}async function prepareContact(_0x2e0675,_0x26c49a,_0x13c4cb,_0xf059d9,_0x2ff54f,_0x438ad8){const _0x65a2e9=a340_0x95ff22,_0x395769={};_0x395769[_0x65a2e9(0xe7)]=_0x13c4cb[_0x65a2e9(0xe7)],_0x395769[_0x65a2e9(0x116)]=_0x13c4cb['id'],_0x395769[_0x65a2e9(0x119)]=_0x2e0675['id'];if(_0x2ff54f['length']){const _0x249787=randomValue(0x0,_0x2ff54f['length']),_0x4d9193=getProcessedMessage(_0x2ff54f[_0x249787],_0x26c49a,_0x13c4cb);_0x395769[_0x65a2e9(0x10e)]=''+_0x4d9193;}if(_0x2e0675[_0x65a2e9(0xbd)]){if(_0x438ad8['length']){const _0x49b192=randomValue(0x0,_0x438ad8['length']),_0x1e2798=getProcessedMessage(_0x438ad8[_0x49b192],_0x26c49a,_0x13c4cb);_0x395769[_0x65a2e9(0xa0)]=''+_0x1e2798;}}const [_0x529ca1,_0x5b115e]=await CampaignShipping_1[_0x65a2e9(0xf1)][_0x65a2e9(0x12c)]({'where':{'campaignId':_0x395769[_0x65a2e9(0x119)],'contactId':_0x395769['contactId']},'defaults':_0x395769});!_0x5b115e&&_0x529ca1[_0x65a2e9(0xcd)]===null&&_0x529ca1[_0x65a2e9(0x9c)]===null&&(_0x529ca1[_0x65a2e9(0xb4)](_0x395769),await _0x529ca1[_0x65a2e9(0xf5)]());if(_0x529ca1[_0x65a2e9(0xcd)]===null&&_0x529ca1[_0x65a2e9(0x9c)]===null){const _0x1de01a=await exports['campaignQueue'][_0x65a2e9(0xd3)](_0x65a2e9(0x99),{'campaignId':_0x2e0675['id'],'campaignShippingId':_0x529ca1['id'],'contactListItemId':_0x13c4cb['id']},{'delay':_0xf059d9});await _0x529ca1[_0x65a2e9(0xf3)]({'jobId':''+_0x1de01a['id']});}}async function handleProcessCampaign(_0x1d4969){const _0x3606b0=a340_0x95ff22;try{const {id:_0x29f1e4}=_0x1d4969[_0x3606b0(0xe1)];let {delay:_0x2e2042}=_0x1d4969[_0x3606b0(0xe1)];const _0x340be5=await getCampaign(_0x29f1e4),_0x2c6cc6=await getSettings(_0x340be5);if(_0x340be5){const {contacts:_0x1f045f}=_0x340be5['contactList'],_0x1cb43f=getCampaignValidMessages(_0x340be5),_0x5f02d8=_0x340be5['confirmation']?getCampaignValidConfirmationMessages(_0x340be5):null;if((0x0,lodash_1[_0x3606b0(0xb9)])(_0x1f045f)){let _0x1ad8e3=0x0;_0x1f045f[_0x3606b0(0x6f)](_0x2aa5bd=>{const _0x112ce0=_0x3606b0;prepareContact(_0x340be5,_0x2c6cc6['variables'],_0x2aa5bd,_0x2e2042,_0x1cb43f,_0x5f02d8)['then'](()=>{const _0x1b5f4c=a340_0x599f;logger_1[_0x1b5f4c(0x113)]['info'](_0x1b5f4c(0x81)+_0x340be5['id']+_0x1b5f4c(0x102)+_0x2aa5bd[_0x1b5f4c(0x10b)]+_0x1b5f4c(0xca)+_0x2e2042);}),_0x1ad8e3+=0x1,_0x1ad8e3%_0x2c6cc6['longerIntervalAfter']===0x0?_0x2e2042+=parseToMilliseconds(_0x2c6cc6[_0x112ce0(0x12a)]):_0x2e2042+=parseToMilliseconds(randomValue(0x0,_0x2c6cc6[_0x112ce0(0x103)]));}),await _0x340be5[_0x3606b0(0xf3)]({'status':_0x3606b0(0x10a)});}}}catch(_0x3288a4){Sentry[_0x3606b0(0xa8)](_0x3288a4);}}async function handleDispatchCampaign(_0x611674){const _0x5eb9a5=a340_0x95ff22;try{const {data:_0xc5cec9}=_0x611674,{campaignShippingId:_0x26ba00,campaignId:_0x1c3a0}=_0xc5cec9,_0x171651=await Campaign_1[_0x5eb9a5(0xf1)][_0x5eb9a5(0xa9)](_0x1c3a0,{'include':[{'model':Whatsapp_1['default'],'as':_0x5eb9a5(0xbf)}]});if(!_0x171651){logger_1['logger'][_0x5eb9a5(0xb0)]({'data':_0xc5cec9},'Campaign\x20not\x20found');return;}const _0x2ae17d=await(0x0,GetWhatsappWbot_1[_0x5eb9a5(0xf1)])(_0x171651[_0x5eb9a5(0xbf)]);logger_1['logger'][_0x5eb9a5(0xb2)]('Disparo\x20de\x20campanha\x20solicitado:\x20Campanha='+_0x1c3a0+_0x5eb9a5(0xa6)+_0x26ba00);const _0x4ff378=await CampaignShipping_1[_0x5eb9a5(0xf1)][_0x5eb9a5(0xa9)](_0x26ba00,{'include':[{'model':ContactListItem_1[_0x5eb9a5(0xf1)],'as':_0x5eb9a5(0xb7)}]}),_0x5b40ad=_0x4ff378[_0x5eb9a5(0xe7)]+_0x5eb9a5(0x75);if(_0x171651[_0x5eb9a5(0xbd)]&&_0x4ff378[_0x5eb9a5(0xbd)]===null)await _0x2ae17d['sendMessage'](_0x5b40ad,{'text':_0x4ff378[_0x5eb9a5(0xa0)]}),await _0x4ff378[_0x5eb9a5(0xf3)]({'confirmationRequestedAt':(0x0,moment_1['default'])()});else{await _0x2ae17d[_0x5eb9a5(0x89)](_0x5b40ad,{'text':_0x4ff378[_0x5eb9a5(0x10e)]});if(_0x171651[_0x5eb9a5(0x12d)]){const _0xa49cdd=path_1[_0x5eb9a5(0xf1)][_0x5eb9a5(0x10c)]('public',_0x171651['mediaPath']),_0x435b7b=await(0x0,SendWhatsAppMedia_1[_0x5eb9a5(0xcf)])(_0x171651['mediaName'],_0xa49cdd);Object[_0x5eb9a5(0x134)](_0x435b7b)[_0x5eb9a5(0xf2)]&&await _0x2ae17d['sendMessage'](_0x5b40ad,{..._0x435b7b});}await _0x4ff378[_0x5eb9a5(0xf3)]({'deliveredAt':(0x0,moment_1[_0x5eb9a5(0xf1)])()});}await verifyAndFinalizeCampaign(_0x171651);const _0xca9457=(0x0,socket_1[_0x5eb9a5(0x11e)])();_0xca9457[_0x5eb9a5(0xa2)](_0x5eb9a5(0x100)+_0x171651[_0x5eb9a5(0x83)]+_0x5eb9a5(0xfc),{'action':_0x5eb9a5(0xf3),'record':_0x171651}),logger_1[_0x5eb9a5(0x113)][_0x5eb9a5(0xb2)](_0x5eb9a5(0xd9)+_0x1c3a0+_0x5eb9a5(0x102)+_0x4ff378['contact']['name']);}catch(_0x27e3bb){Sentry['captureException'](_0x27e3bb),logger_1[_0x5eb9a5(0x113)][_0x5eb9a5(0xb0)](_0x27e3bb[_0x5eb9a5(0x10e)]);}}async function handleLoginStatus(){const _0x1106d1=a340_0x95ff22,_0x2e37c3=await database_1[_0x1106d1(0xf1)][_0x1106d1(0xc4)](_0x1106d1(0x9e),{'type':sequelize_1[_0x1106d1(0x115)][_0x1106d1(0x79)]});_0x2e37c3[_0x1106d1(0x6f)](async _0x37d57a=>{const _0x21ef1e=_0x1106d1;try{const _0x76f185=await User_1[_0x21ef1e(0xf1)][_0x21ef1e(0xa9)](_0x37d57a['id']);await _0x76f185[_0x21ef1e(0xf3)]({'online':![]}),logger_1[_0x21ef1e(0x113)][_0x21ef1e(0xb2)]('Usuário\x20passado\x20para\x20offline:\x20'+_0x37d57a['id']);}catch(_0x54c7d7){Sentry[_0x21ef1e(0xa8)](_0x54c7d7);}});}async function handleInvoiceCreate(){const _0x5d2bff=a340_0x95ff22,_0x4b105c=new cron_1[(_0x5d2bff(0xbc))]('0\x20*\x20*\x20*\x20*\x20*',async()=>{const _0x40e8f2=_0x5d2bff,_0x3c3b82=await Company_1[_0x40e8f2(0xf1)][_0x40e8f2(0x96)]();_0x3c3b82[_0x40e8f2(0x104)](async _0x216777=>{const _0xdbd73b=_0x40e8f2,{dueDate:_0x42c3ee}=_0x216777,_0xafb153=(0x0,moment_1[_0xdbd73b(0xf1)])(_0x42c3ee)[_0xdbd73b(0xd6)](),_0x4d34ff=(0x0,moment_1[_0xdbd73b(0xf1)])()[_0xdbd73b(0xd6)](),_0x42c188=(0x0,moment_1[_0xdbd73b(0xf1)])((0x0,moment_1[_0xdbd73b(0xf1)])())[_0xdbd73b(0xd6)]('DD/MM/yyyy'),_0x47d088=(0x0,moment_1[_0xdbd73b(0xf1)])(_0x42c3ee)[_0xdbd73b(0xd6)](_0xdbd73b(0xc8)),_0x4f61a7=(0x0,moment_1[_0xdbd73b(0xf1)])(_0x47d088,'DD/MM/yyyy')[_0xdbd73b(0x70)]((0x0,moment_1[_0xdbd73b(0xf1)])(_0x42c188,_0xdbd73b(0xc8))),_0x6a1070=moment_1[_0xdbd73b(0xf1)][_0xdbd73b(0xff)](_0x4f61a7)['asDays']();if(_0x6a1070<0x14){const _0x283cfe=await Plan_1[_0xdbd73b(0xf1)][_0xdbd73b(0xa9)](_0x216777[_0xdbd73b(0xd7)]),_0x48746a='SELECT\x20COUNT(*)\x20mycount\x20FROM\x20\x22Invoices\x22\x20WHERE\x20\x22companyId\x22\x20=\x20'+_0x216777['id']+_0xdbd73b(0x9a)+(0x0,moment_1[_0xdbd73b(0xf1)])(_0x42c3ee)['format']('yyyy-MM-DD')+_0xdbd73b(0xc0),_0x2569af=await database_1['default'][_0xdbd73b(0xc4)](_0x48746a,{'type':sequelize_1[_0xdbd73b(0x115)][_0xdbd73b(0x79)]});if(+_0x2569af[0x0]['mycount']===0x0){const _0x4e5eb5=_0xdbd73b(0x106)+_0x283cfe[_0xdbd73b(0x10b)]+'\x27,\x20\x27open\x27,\x20\x27'+_0x283cfe[_0xdbd73b(0x8f)]+'\x27,\x20\x27'+_0x4d34ff+'\x27,\x20\x27'+_0x4d34ff+_0xdbd73b(0x71)+_0xafb153+'\x27,\x20'+_0x216777['id']+');';await database_1[_0xdbd73b(0xf1)][_0xdbd73b(0xc4)](_0x4e5eb5,{'type':sequelize_1[_0xdbd73b(0x115)][_0xdbd73b(0xac)]});}}});});_0x4b105c['start']();}handleInvoiceCreate();async function startQueueProcess(){const _0x32c314=a340_0x95ff22;logger_1['logger']['info']('Iniciando\x20processamento\x20de\x20filas'),exports[_0x32c314(0x90)][_0x32c314(0x12e)]('SendMessage',handleSendMessage),exports['scheduleMonitor'][_0x32c314(0x12e)](_0x32c314(0xf6),handleVerifySchedules),exports[_0x32c314(0x127)][_0x32c314(0x12e)](_0x32c314(0x74),handleSendScheduledMessage),exports[_0x32c314(0xbb)]['process'](_0x32c314(0x133),handleVerifyCampaigns),exports[_0x32c314(0xbb)][_0x32c314(0x12e)](_0x32c314(0x91),handleProcessCampaign),exports['campaignQueue'][_0x32c314(0x12e)](_0x32c314(0x99),handleDispatchCampaign),exports[_0x32c314(0xdc)][_0x32c314(0x12e)]('VerifyLoginStatus',handleLoginStatus),exports[_0x32c314(0xbb)][_0x32c314(0x12e)](_0x32c314(0xeb),handleDispatchCampaign),exports[_0x32c314(0x88)][_0x32c314(0x12e)](_0x32c314(0x126),handleVerifyTicketExpiration),exports[_0x32c314(0xf9)][_0x32c314(0xd3)](_0x32c314(0xf6),{},{'repeat':{'cron':_0x32c314(0x105)},'removeOnComplete':!![]}),exports[_0x32c314(0xbb)][_0x32c314(0xd3)](_0x32c314(0x133),{},{'repeat':{'cron':_0x32c314(0x132)},'removeOnComplete':!![]}),exports[_0x32c314(0xdc)][_0x32c314(0xd3)](_0x32c314(0xc7),{},{'repeat':{'cron':_0x32c314(0x125)},'removeOnComplete':!![]}),exports[_0x32c314(0x88)]['add']('VerifyTicketExpiration',{},{'repeat':{'cron':_0x32c314(0x125)},'removeOnComplete':!![]});}