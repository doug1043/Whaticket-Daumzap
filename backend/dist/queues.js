'use strict';const a426_0x4f6aed=a426_0x32cf;(function(_0x238d87,_0x5759ed){const _0x2a3c0b=a426_0x32cf,_0x3f68a1=_0x238d87();while(!![]){try{const _0x511a33=parseInt(_0x2a3c0b(0x166))/0x1*(-parseInt(_0x2a3c0b(0x1a8))/0x2)+parseInt(_0x2a3c0b(0xaf))/0x3+-parseInt(_0x2a3c0b(0xc1))/0x4*(parseInt(_0x2a3c0b(0xc3))/0x5)+parseInt(_0x2a3c0b(0x157))/0x6*(parseInt(_0x2a3c0b(0x1a2))/0x7)+parseInt(_0x2a3c0b(0x1da))/0x8*(-parseInt(_0x2a3c0b(0x1de))/0x9)+parseInt(_0x2a3c0b(0x16e))/0xa*(parseInt(_0x2a3c0b(0x1df))/0xb)+parseInt(_0x2a3c0b(0x98))/0xc;if(_0x511a33===_0x5759ed)break;else _0x3f68a1['push'](_0x3f68a1['shift']());}catch(_0x1b5543){_0x3f68a1['push'](_0x3f68a1['shift']());}}}(a426_0xd408,0x6c4cf));var __createBinding=this&&this[a426_0x4f6aed(0x154)]||(Object[a426_0x4f6aed(0x1b1)]?function(_0x15f6f9,_0x1f49f4,_0x4af31a,_0x3d7352){const _0x15d8a2=a426_0x4f6aed;if(_0x3d7352===undefined)_0x3d7352=_0x4af31a;var _0x777fff=Object['getOwnPropertyDescriptor'](_0x1f49f4,_0x4af31a);(!_0x777fff||(_0x15d8a2(0xe7)in _0x777fff?!_0x1f49f4['__esModule']:_0x777fff[_0x15d8a2(0x9a)]||_0x777fff['configurable']))&&(_0x777fff={'enumerable':!![],'get':function(){return _0x1f49f4[_0x4af31a];}}),Object[_0x15d8a2(0xa9)](_0x15f6f9,_0x3d7352,_0x777fff);}:function(_0x333a64,_0x531704,_0x2d998b,_0x39a919){if(_0x39a919===undefined)_0x39a919=_0x2d998b;_0x333a64[_0x39a919]=_0x531704[_0x2d998b];}),__setModuleDefault=this&&this[a426_0x4f6aed(0x17e)]||(Object[a426_0x4f6aed(0x1b1)]?function(_0xd46787,_0x51a35d){const _0x2aaa78=a426_0x4f6aed;Object[_0x2aaa78(0xa9)](_0xd46787,_0x2aaa78(0xb4),{'enumerable':!![],'value':_0x51a35d});}:function(_0x1d52d1,_0x2ccbee){const _0x6d9282=a426_0x4f6aed;_0x1d52d1[_0x6d9282(0xb4)]=_0x2ccbee;}),__importStar=this&&this[a426_0x4f6aed(0x89)]||(function(){const _0xd27edd=(function(){let _0x4615b4=!![];return function(_0x1f9cf3,_0x4d0149){const _0x8d0f3c=_0x4615b4?function(){const _0x11b7e6=a426_0x32cf;if(_0x4d0149){const _0xca785b=_0x4d0149[_0x11b7e6(0xa5)](_0x1f9cf3,arguments);return _0x4d0149=null,_0xca785b;}}:function(){};return _0x4615b4=![],_0x8d0f3c;};}()),_0x29833f=_0xd27edd(this,function(){const _0x234819=a426_0x32cf;return _0x29833f[_0x234819(0xe0)]()[_0x234819(0xa6)](_0x234819(0x1a1))[_0x234819(0xe0)]()[_0x234819(0x1d4)](_0x29833f)[_0x234819(0xa6)](_0x234819(0x1a1));});_0x29833f();var _0x25941a=function(_0x17b700){const _0x242283=a426_0x32cf;return _0x25941a=Object[_0x242283(0x149)]||function(_0x121ea7){const _0x467603=_0x242283;var _0x52405d=[];for(var _0x4ee0d4 in _0x121ea7)if(Object[_0x467603(0x130)][_0x467603(0x123)][_0x467603(0xd0)](_0x121ea7,_0x4ee0d4))_0x52405d[_0x52405d[_0x467603(0x163)]]=_0x4ee0d4;return _0x52405d;},_0x25941a(_0x17b700);};return function(_0x1e0fb2){const _0x3203d3=a426_0x32cf;if(_0x1e0fb2&&_0x1e0fb2['__esModule'])return _0x1e0fb2;var _0x2ecacf={};if(_0x1e0fb2!=null){for(var _0x32a6e5=_0x25941a(_0x1e0fb2),_0x3ea1f9=0x0;_0x3ea1f9<_0x32a6e5[_0x3203d3(0x163)];_0x3ea1f9++)if(_0x32a6e5[_0x3ea1f9]!==_0x3203d3(0xb4))__createBinding(_0x2ecacf,_0x1e0fb2,_0x32a6e5[_0x3ea1f9]);}return __setModuleDefault(_0x2ecacf,_0x1e0fb2),_0x2ecacf;};}()),__importDefault=this&&this[a426_0x4f6aed(0x1c5)]||function(_0x484615){const _0xaaf450=a426_0x4f6aed;return _0x484615&&_0x484615[_0xaaf450(0xe4)]?_0x484615:{'default':_0x484615};};function a426_0x32cf(_0x1c7e93,_0x8340ef){const _0x13a3c4=a426_0xd408();return a426_0x32cf=function(_0x353ff6,_0xf5ac42){_0x353ff6=_0x353ff6-0x7c;let _0xd40853=_0x13a3c4[_0x353ff6];return _0xd40853;},a426_0x32cf(_0x1c7e93,_0x8340ef);}Object[a426_0x4f6aed(0xa9)](exports,'__esModule',{'value':!![]}),exports[a426_0x4f6aed(0x173)]=exports['whatsappRestartQueue']=exports['ticketMonitor']=exports[a426_0x4f6aed(0xfb)]=exports[a426_0x4f6aed(0xbe)]=exports[a426_0x4f6aed(0xaa)]=exports[a426_0x4f6aed(0xdf)]=exports[a426_0x4f6aed(0x1a4)]=void 0x0,exports[a426_0x4f6aed(0x122)]=handleWhatsappAutoRestart,exports[a426_0x4f6aed(0xee)]=parseToMilliseconds,exports[a426_0x4f6aed(0x1bf)]=sleep,exports[a426_0x4f6aed(0x1b5)]=randomValue,exports['startQueueProcess']=startQueueProcess;const Sentry=__importStar(require(a426_0x4f6aed(0x83))),bull_1=__importDefault(require(a426_0x4f6aed(0x13a))),moment_1=__importDefault(require('moment')),sequelize_1=require(a426_0x4f6aed(0xd3)),lodash_1=require(a426_0x4f6aed(0x1cc)),path_1=__importDefault(require('path')),fs_1=__importDefault(require('fs')),cron_1=require(a426_0x4f6aed(0x16d)),SendMessage_1=require(a426_0x4f6aed(0x138)),Whatsapp_1=__importDefault(require(a426_0x4f6aed(0xcf))),logger_1=require(a426_0x4f6aed(0xf4)),Schedule_1=__importDefault(require(a426_0x4f6aed(0x124))),Contact_1=__importDefault(require(a426_0x4f6aed(0x132))),GetDefaultWhatsApp_1=__importDefault(require(a426_0x4f6aed(0x1c7))),Campaign_1=__importDefault(require(a426_0x4f6aed(0x14a))),ContactList_1=__importDefault(require(a426_0x4f6aed(0xd2))),ContactListItem_1=__importDefault(require(a426_0x4f6aed(0x1ad))),CampaignSetting_1=__importDefault(require(a426_0x4f6aed(0xec))),CampaignShipping_1=__importDefault(require(a426_0x4f6aed(0x175))),CampaignLog_1=__importDefault(require('./models/CampaignLog')),TagLog_1=__importDefault(require(a426_0x4f6aed(0x182))),GetWhatsappWbot_1=__importDefault(require('./helpers/GetWhatsappWbot')),database_1=__importDefault(require('./database')),SendWhatsAppMedia_1=require(a426_0x4f6aed(0x1c1)),socket_1=require(a426_0x4f6aed(0x156)),User_1=__importDefault(require('./models/User')),Company_1=__importDefault(require('./models/Company')),Plan_1=__importDefault(require(a426_0x4f6aed(0x92))),wbotMessageListener_1=require('./services/WbotServices/wbotMessageListener'),ShowService_1=__importDefault(require('./services/CampaignService/ShowService')),Mustache_1=__importDefault(require(a426_0x4f6aed(0x176))),Ticket_1=__importDefault(require('./models/Ticket')),SendWhatsAppMessage_1=__importDefault(require(a426_0x4f6aed(0x121))),wbot_1=require(a426_0x4f6aed(0xc9)),StartWhatsAppSession_1=require(a426_0x4f6aed(0x11b)),Message_1=__importDefault(require(a426_0x4f6aed(0x1b6))),connection=process[a426_0x4f6aed(0xd4)][a426_0x4f6aed(0xa8)]||'',limiterMax=process[a426_0x4f6aed(0xd4)][a426_0x4f6aed(0xce)]||0x1,limiterDuration=process[a426_0x4f6aed(0xd4)]['REDIS_OPT_LIMITER_DURATION']||0xbb8;exports['userMonitor']=new bull_1['default'](a426_0x4f6aed(0x1aa),connection),exports[a426_0x4f6aed(0xdf)]=new bull_1['default'](a426_0x4f6aed(0xf0),connection,{'limiter':{'max':limiterMax,'duration':limiterDuration}}),exports[a426_0x4f6aed(0xaa)]=new bull_1[(a426_0x4f6aed(0xb4))]('ScheduleMonitor',connection),exports[a426_0x4f6aed(0xbe)]=new bull_1[(a426_0x4f6aed(0xb4))]('SendSacheduledMessages',connection),exports['ticketInactiveWarningQueue']=new bull_1[(a426_0x4f6aed(0xb4))](a426_0x4f6aed(0xbf),connection);async function handleWhatsappAutoRestart(){const _0x35899b=a426_0x4f6aed;try{const _0x394d28=await Whatsapp_1[_0x35899b(0xb4)]['findAll']({'where':{'automaticRestart':!![],'status':'CONNECTED'}}),_0x10ac6d=new Date();for(const _0x58cdfa of _0x394d28){const _0x2344fb=_0x58cdfa[_0x35899b(0xa3)]||_0x58cdfa[_0x35899b(0xa0)]||_0x58cdfa['createdAt'];shouldRestart(_0x10ac6d,_0x2344fb,_0x58cdfa[_0x35899b(0xf5)])&&(logger_1['logger'][_0x35899b(0xbc)](_0x35899b(0x136)+_0x58cdfa[_0x35899b(0x15e)]+_0x35899b(0x104)+_0x58cdfa['id']+_0x35899b(0x1cb)+_0x58cdfa[_0x35899b(0xf5)]+')'),await(0x0,wbot_1[_0x35899b(0xae)])(_0x58cdfa['id'],![]),await new Promise(_0x8d57be=>setTimeout(_0x8d57be,0xbb8)),await(0x0,StartWhatsAppSession_1[_0x35899b(0x13d)])(_0x58cdfa,_0x58cdfa[_0x35899b(0x11d)]),await _0x58cdfa[_0x35899b(0x15c)]({'lastRestartAt':new Date()}));}}catch(_0x1e0067){logger_1[_0x35899b(0x97)][_0x35899b(0x1ae)](_0x35899b(0x114)+_0x1e0067['message']);}}exports[a426_0x4f6aed(0xd6)]=new bull_1['default']('TicketMonitor',connection),exports[a426_0x4f6aed(0x8d)]=new bull_1[(a426_0x4f6aed(0xb4))](a426_0x4f6aed(0x7e),connection);function shouldRestart(_0x5d0443,_0x67f617,_0x5be0f1){const _0x3726dd=a426_0x4f6aed;if(_0x5be0f1===_0x3726dd(0xda))return(0x0,moment_1[_0x3726dd(0xb4)])(_0x5d0443)[_0x3726dd(0x14d)]((0x0,moment_1[_0x3726dd(0xb4)])(_0x67f617),_0x3726dd(0x117))>=0x1;if(_0x5be0f1==='semanalmente')return(0x0,moment_1[_0x3726dd(0xb4)])(_0x5d0443)[_0x3726dd(0x14d)]((0x0,moment_1[_0x3726dd(0xb4)])(_0x67f617),_0x3726dd(0x129))>=0x1;if(_0x5be0f1===_0x3726dd(0xc6))return(0x0,moment_1['default'])(_0x5d0443)['diff']((0x0,moment_1[_0x3726dd(0xb4)])(_0x67f617),_0x3726dd(0x148))>=0x1;return![];}async function handleVerifyTicketExpiration(){const _0xaa6535=a426_0x4f6aed;try{const _0x8c1687=await database_1[_0xaa6535(0xb4)][_0xaa6535(0x1af)](_0xaa6535(0x18b),{'type':sequelize_1[_0xaa6535(0x199)][_0xaa6535(0x12d)]});for(const _0x31c687 of _0x8c1687){const _0x28f4fe=await Ticket_1[_0xaa6535(0xb4)][_0xaa6535(0x8b)]({'where':{'status':{[sequelize_1['Op']['in']]:[_0xaa6535(0x7d),_0xaa6535(0x191)]},'whatsappId':_0x31c687['id'],'companyId':_0x31c687[_0xaa6535(0x11d)]},'include':[{'model':Contact_1[_0xaa6535(0xb4)],'as':_0xaa6535(0x183)},{'model':Message_1[_0xaa6535(0xb4)],'as':_0xaa6535(0x1c8),'separate':!![],'order':[[_0xaa6535(0xb5),_0xaa6535(0x9b)]],'limit':0x1}]}),_0xb0585=(0x0,moment_1[_0xaa6535(0xb4)])();for(const _0x2f40c8 of _0x28f4fe){const _0x4cbc77=_0x2f40c8['messages']&&_0x2f40c8[_0xaa6535(0x1c8)]['length']>0x0?_0x2f40c8[_0xaa6535(0x1c8)][0x0]:null;if(!_0x4cbc77)continue;let _0x5b3e94=![];if(_0x31c687[_0xaa6535(0x13e)]===_0xaa6535(0xc2))_0x5b3e94=_0x4cbc77[_0xaa6535(0x18e)]===!![];else _0x31c687[_0xaa6535(0x13e)]==='customer'?_0x5b3e94=_0x4cbc77[_0xaa6535(0x18e)]===![]:_0x5b3e94=!![];if(!_0x5b3e94)continue;const _0x8baf13=(0x0,moment_1['default'])(),_0x4fd70e=(0x0,moment_1['default'])(_0x4cbc77[_0xaa6535(0xb5)]),_0x378f43=_0x8baf13['diff'](_0x4fd70e,_0xaa6535(0x8c)),_0x3cb7ae=_0x31c687[_0xaa6535(0x160)]>0x0&&_0x31c687['inactiveMessage'];if(_0x3cb7ae){if(!_0x2f40c8[_0xaa6535(0x12e)]&&!_0x2f40c8[_0xaa6535(0x127)]){if(_0x378f43>=_0x31c687[_0xaa6535(0x160)])try{const _0x585004=(0x0,wbot_1[_0xaa6535(0x16c)])(_0x31c687['id']);_0x585004&&_0x585004['user']?(await(0x0,SendWhatsAppMessage_1[_0xaa6535(0xb4)])({'ticket':_0x2f40c8,'body':_0x31c687[_0xaa6535(0xf8)]}),await _0x2f40c8['update']({'ticketsWithWarning':!![],'warningSentAt':new Date()},{'silent':!![]}),logger_1['logger'][_0xaa6535(0xbc)](_0xaa6535(0x1b3)+_0x2f40c8['id']+_0xaa6535(0x1e0)+_0x378f43+_0xaa6535(0x1bc))):logger_1[_0xaa6535(0x97)][_0xaa6535(0x17b)](_0xaa6535(0x180)+_0x31c687['id']+'\x20n√£o\x20conectado.\x20Pulando\x20envio\x20de\x20aviso\x20para\x20ticket\x20#'+_0x2f40c8['id']+'.');}catch(_0x337d8b){Sentry[_0xaa6535(0xde)](_0x337d8b),logger_1[_0xaa6535(0x97)][_0xaa6535(0x1ae)]('Erro\x20ao\x20enviar\x20aviso\x20de\x20inatividade:\x20'+_0x337d8b[_0xaa6535(0xf7)]);}}else{if(_0x2f40c8[_0xaa6535(0x127)]){const _0x5ec3cc=(0x0,moment_1[_0xaa6535(0xb4)])(_0x2f40c8[_0xaa6535(0x127)]),_0x3a9c18=_0x8baf13['diff'](_0x5ec3cc,_0xaa6535(0x8c));if(_0x3a9c18>=_0x31c687['expiresTicket'])try{if(_0x31c687[_0xaa6535(0x11c)])try{const _0x4398e1=(0x0,wbot_1[_0xaa6535(0x16c)])(_0x31c687['id']);_0x4398e1&&_0x4398e1[_0xaa6535(0x10d)]?(await(0x0,SendWhatsAppMessage_1[_0xaa6535(0xb4)])({'ticket':_0x2f40c8,'body':_0x31c687['expiresInactiveMessage']}),await new Promise(_0x24ff3b=>setTimeout(_0x24ff3b,0x3e8))):logger_1[_0xaa6535(0x97)]['debug'](_0xaa6535(0x180)+_0x31c687['id']+_0xaa6535(0x1d8)+_0x2f40c8['id']+'.');}catch(_0x1da96b){logger_1[_0xaa6535(0x97)]['warn']('Erro\x20ao\x20enviar\x20mensagem\x20de\x20encerramento\x20para\x20ticket\x20#'+_0x2f40c8['id']+':\x20'+_0x1da96b[_0xaa6535(0xf7)]);}const _0x429bdd=_0x2f40c8[_0xaa6535(0x1a6)];await _0x2f40c8[_0xaa6535(0x15c)]({'status':_0xaa6535(0x1c3),'amountUsedBotQueues':0x0,'ticketsWithWarning':![],'warningSentAt':null});const _0x5923a8=(0x0,socket_1[_0xaa6535(0xe9)])();if(_0x429bdd===_0xaa6535(0x7d))_0x5923a8['to']('company-'+_0x2f40c8[_0xaa6535(0x11d)]+'-open')['to']('queue-'+_0x2f40c8[_0xaa6535(0x1ab)]+_0xaa6535(0x164))[_0xaa6535(0xe2)](_0xaa6535(0xff)+_0x2f40c8[_0xaa6535(0x11d)]+_0xaa6535(0x13b),{'action':_0xaa6535(0x15c),'ticket':{..._0x2f40c8[_0xaa6535(0x1a3)],'status':_0xaa6535(0x1c3)}});else _0x429bdd===_0xaa6535(0x191)&&_0x5923a8['to']('company-'+_0x2f40c8[_0xaa6535(0x11d)]+_0xaa6535(0xb9))[_0xaa6535(0xe2)]('company-'+_0x2f40c8[_0xaa6535(0x11d)]+_0xaa6535(0x13b),{'action':_0xaa6535(0x15c),'ticket':{..._0x2f40c8['dataValues'],'status':_0xaa6535(0x1c3)}});logger_1[_0xaa6535(0x97)][_0xaa6535(0xbc)]('Ticket\x20#'+_0x2f40c8['id']+_0xaa6535(0x9f)+_0x3a9c18+_0xaa6535(0xab)+_0x378f43+'\x20minutos\x20desde\x20a\x20√∫ltima\x20mensagem)');}catch(_0x4c3055){Sentry['captureException'](_0x4c3055),logger_1['logger']['error'](_0xaa6535(0x1bd)+_0x2f40c8['id']+':\x20'+_0x4c3055[_0xaa6535(0xf7)]);}}}}else{if(_0x378f43>=_0x31c687['expiresTicket'])try{if(_0x31c687[_0xaa6535(0x11c)])try{const _0x234940=(0x0,wbot_1[_0xaa6535(0x16c)])(_0x31c687['id']);_0x234940&&_0x234940[_0xaa6535(0x10d)]?(await(0x0,SendWhatsAppMessage_1['default'])({'ticket':_0x2f40c8,'body':_0x31c687[_0xaa6535(0x11c)]}),await new Promise(_0x4f68f0=>setTimeout(_0x4f68f0,0x3e8))):logger_1[_0xaa6535(0x97)][_0xaa6535(0x17b)](_0xaa6535(0x180)+_0x31c687['id']+_0xaa6535(0x1d8)+_0x2f40c8['id']+'.');}catch(_0x28f190){logger_1[_0xaa6535(0x97)][_0xaa6535(0x16b)](_0xaa6535(0x174)+_0x2f40c8['id']+':\x20'+_0x28f190[_0xaa6535(0xf7)]);}const _0x172b20=_0x2f40c8[_0xaa6535(0x1a6)];await _0x2f40c8[_0xaa6535(0x15c)]({'status':_0xaa6535(0x1c3),'amountUsedBotQueues':0x0,'ticketsWithWarning':![],'warningSentAt':null});const _0x339136=(0x0,socket_1[_0xaa6535(0xe9)])();if(_0x172b20===_0xaa6535(0x7d))_0x339136['to'](_0xaa6535(0xff)+_0x2f40c8['companyId']+_0xaa6535(0x164))['to'](_0xaa6535(0x1e1)+_0x2f40c8[_0xaa6535(0x1ab)]+'-open')[_0xaa6535(0xe2)](_0xaa6535(0xff)+_0x2f40c8[_0xaa6535(0x11d)]+_0xaa6535(0x13b),{'action':_0xaa6535(0x15c),'ticket':{..._0x2f40c8[_0xaa6535(0x1a3)],'status':'closed'}});else _0x172b20===_0xaa6535(0x191)&&_0x339136['to'](_0xaa6535(0xff)+_0x2f40c8[_0xaa6535(0x11d)]+'-pending')[_0xaa6535(0xe2)](_0xaa6535(0xff)+_0x2f40c8['companyId']+_0xaa6535(0x13b),{'action':_0xaa6535(0x15c),'ticket':{..._0x2f40c8[_0xaa6535(0x1a3)],'status':_0xaa6535(0x1c3)}});_0x339136['to']('company-'+_0x2f40c8['companyId']+_0xaa6535(0x193))[_0xaa6535(0xe2)](_0xaa6535(0xff)+_0x2f40c8[_0xaa6535(0x11d)]+_0xaa6535(0x13b),{'action':_0xaa6535(0x15c),'ticket':{..._0x2f40c8[_0xaa6535(0x1a3)],'status':_0xaa6535(0x1c3)}}),logger_1[_0xaa6535(0x97)][_0xaa6535(0xbc)]('Ticket\x20#'+_0x2f40c8['id']+'\x20fechado\x20por\x20inatividade\x20ap√≥s\x20'+_0x378f43+_0xaa6535(0x13c)+_0x31c687[_0xaa6535(0x169)]+'\x20minutos).');}catch(_0x1a3b6a){Sentry[_0xaa6535(0xde)](_0x1a3b6a),logger_1[_0xaa6535(0x97)]['error'](_0xaa6535(0x1bd)+_0x2f40c8['id']+':\x20'+_0x1a3b6a['message']);}}}}}catch(_0x44adf3){Sentry[_0xaa6535(0xde)](_0x44adf3),logger_1[_0xaa6535(0x97)][_0xaa6535(0x1ae)]({'error':_0x44adf3},_0xaa6535(0xfa));}}exports[a426_0x4f6aed(0x173)]=new bull_1[(a426_0x4f6aed(0xb4))](a426_0x4f6aed(0x170),connection);function a426_0xd408(){const _0x48bb13=['Usu√°rio\x20passado\x20para\x20offline:\x20','info','campId','sendScheduledMessages','TicketInactiveWarning','planId','692qDzXQF','agent','13695KoInal','Stack:\x20','getMessageOptions','mensalmente','keys','findAndCountAll','./libs/wbot','format','active','select\x20id,\x20\x22scheduledAt\x22\x20from\x20\x22Campaigns\x22\x20c\x0a\x20\x20\x20\x20where\x20\x22scheduledAt\x22\x20between\x20now()\x20-\x20\x275\x20minutes\x27::interval\x20and\x20now()\x20+\x20\x271\x20hour\x27::interval\x20\x0a\x20\x20\x20\x20and\x20status\x20=\x20\x27PROGRAMADA\x27','https://','REDIS_OPT_LIMITER_MAX','./models/Whatsapp','call','delivered','./models/ContactList','sequelize','env','confirmationMessage4','ticketMonitor','\x20n√£o\x20possui\x20WhatsApp\x20vinculado!','\x20contatos\x20v√°lidos','\x20AND\x20\x22dueDate\x22::text\x20LIKE\x20\x27','diariamente','YYYY-MM-DD\x20HH:mm:ss','\x20(vencimento:\x20','\x27,\x20\x27open\x27,\x20\x27','captureException','messageQueue','toString','toJSON','emit','media','__esModule','http://','complete','get','\x27,\x20','getIO','sendMessage','-tag-log','./models/CampaignSetting','handleMessage','parseToMilliseconds','duration','MessageQueue','0\x20*\x20*\x20*\x20*\x20*','confirmationRequestedAt',';Delay=','./utils/logger','period','asDays','message','inactiveMessage','whatsappId','TicketMonitor\x20->\x20VerifyTicketExpiration:\x20erro','ticketInactiveWarningQueue','message5','email','gte','company-','now','message1','\x20contatos\x20foram\x20processados.','EM_ANDAMENTO','\x20(ID:\x20','s.whatsapp.net','campaignId','Campanha\x20enviada\x20para:\x20Campanha=','add','confirmationMessage2','testMode','‚ùå\x20Erro\x20ao\x20processar\x20campanha:\x20','findOrCreate','user','\x27,\x20\x27','saveMessage','[Assinaturas]\x20Conex√£o\x20','writeFileSync','lte','push','Erro\x20ao\x20reiniciar\x20conex√µes\x20WhatsApp\x20periodicamente:\x20','Erro\x20ao\x20tentar\x20consultar\x20agendamento:\x20','\x20iniciada!\x20Status:\x20EM_ANDAMENTO','days','-mainchannel','üöÄ\x20Campanha\x20ID=','AGENDADA','./services/WbotServices/StartWhatsAppSession','expiresInactiveMessage','companyId','toFixed','findByPk','set','./services/WbotServices/SendWhatsAppMessage','handleWhatsappAutoRestart','hasOwnProperty','./models/Schedule','processing','getDate','warningSentAt','DD/MM/yyyy','weeks','setDate','‚ö†Ô∏è\x20\x20Campanha\x20ID=','Whatsapp\x20n√£o\x20identificado','SELECT','ticketsWithWarning','[Assinaturas]\x20Erro\x20ao\x20desconectar\x20WhatsApp\x20','prototype','resolve','./models/Contact','[Assinaturas]\x20Encontradas\x20','day','DD/MM/YYYY','Reiniciando\x20conex√£o\x20WhatsApp\x20','isWhatsappValid','./helpers/SendMessage','isNil','bull','-ticket','\x20minutos\x20(configurado:\x20','StartWhatsAppSession','whenExpireTicket','then','Erro\x20ao\x20criar\x20log\x20de\x20tag:\x20','isEmpty','random','üìä\x20Progresso\x20Campanha\x20ID=','SELECT\x20COUNT(*)\x20mycount\x20FROM\x20\x22Invoices\x22\x20WHERE\x20\x22companyId\x22\x20=\x20','TIMEOUT','PAIRING','Erro\x20ao\x20criar\x20pr√≥ximo\x20agendamento:\x20','months','getOwnPropertyNames','./models/Campaign','confirmation','Sleep\x20de\x20','diff','forEach','value','üìã\x20Processando\x20campanha:\x20ID=','public','SendScheduledMessage\x20->\x20SendMessage:\x20error','\x20n√£o\x20possui\x20lista\x20de\x20contatos\x20vinculada!','__createBinding','toDate','./libs/socket','54702fEYKFv','confirmationMessage1','greaterInterval','VerifyCampaignsDaatabase','getJobs','update','confirmationRequested','name',')\x20desconectada.','inactiveMessageTime','mycount','axios','length','-open','@s.whatsapp.net','171HBAfmA','qrcode','select\x20id\x20from\x20\x22Users\x22\x20where\x20\x22updatedAt\x22\x20<\x20now()\x20-\x20\x275\x20minutes\x27::interval\x20and\x20online\x20=\x20true','expiresTicket','ProcessCampaign','warn','getWbot','cron','10tcLjmq','MessageQueue\x20->\x20SendMessage:\x20error','CampaignQueue','SendMessage','existsSync','campaignQueue','Erro\x20ao\x20enviar\x20mensagem\x20de\x20encerramento\x20para\x20ticket\x20#','./models/CampaignShipping','./helpers/Mustache','mime-types','‚ùå\x20Erro\x20ao\x20processar\x20campanha\x20','arraybuffer','valids','debug','deliveredAt','contactId','__setModuleDefault','some','WhatsApp\x20#','save','./models/TagLog','contact','map','*/30\x20*\x20*\x20*\x20*\x20*','simulation','[Assinaturas]\x20Verificando\x20empresas\x20com\x20assinatura\x20expirada...','*/20\x20*\x20*\x20*\x20*\x20*','‚ùå\x20Campanha\x20ID=','send','SELECT\x20id,\x20\x22expiresTicket\x22,\x20\x22companyId\x22,\x20\x22whenExpireTicket\x22,\x0a\x20\x20\x20\x22expiresInactiveMessage\x22,\x20\x22inactiveMessage\x22,\x20\x22inactiveMessageTime\x22\x0a\x20\x20\x20FROM\x20\x22Whatsapps\x22\x20WHERE\x20\x22expiresTicket\x22\x20>\x200','-whatsapp','shipping','fromMe','waiting','[Assinaturas]\x20Processando\x20empresa\x20','pending','contactList','-closed','üß™\x20Simula√ß√£o\x20conclu√≠da:\x20Campanha=','messageInterval','parse','hour',',\x20Agendada\x20para:\x20','QueryTypes','sentAt','CONNECTED','startsWith','message3','bin','Disparo\x20agendado\x20para:\x20','message4','(((.+)+)+)+$','84bBWmXy','dataValues','userMonitor','INSERT\x20INTO\x20\x22Invoices\x22\x20(detail,\x20status,\x20value,\x20\x22updatedAt\x22,\x20\x22createdAt\x22,\x20\x22dueDate\x22,\x20\x22companyId\x22)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20VALUES\x20(\x27','status','unlinkSync','8002dlYEec','ERRO','UserMonitor','queueId','scheduledAt','./models/ContactListItem','error','query','SendScheduledMessage\x20->\x20Verify:\x20error','create','Criando\x20pr√≥ximo\x20agendamento\x20(repeti√ß√£o\x20a\x20cada\x20','Aviso\x20de\x20inatividade\x20enviado\x20para\x20o\x20ticket\x20#','Verify','randomValue','./models/Message','body','start','\x20n√£o\x20encontrado\x20ou\x20j√°\x20foi\x20processado','confirmed','*/5\x20*\x20*\x20*\x20*\x20*','\x20minutos\x20de\x20inatividade','Erro\x20ao\x20encerrar\x20ticket\x20#','GET','sleep','message2','./services/WbotServices/SendWhatsAppMedia','üì§\x20Campanha\x20enviada\x20para\x20a\x20fila:\x20ID=','closed','DispatchConfirmedCampaign','__importDefault','‚úÖ\x20Campanhas\x20PROGRAMADAS\x20encontradas:\x20','./helpers/GetDefaultWhatsApp','messages','%\x27;','\x20conex√µes\x20da\x20empresa\x20',')\x20de\x20acordo\x20com\x20o\x20per√≠odo\x20(','lodash','toISOString','AutoRestart','headers','üîç\x20Verificando\x20campanhas\x20programadas...','floor','\x20j√°\x20est√°\x20na\x20fila,\x20pulando...','Disparo\x20de\x20campanha\x20solicitado:\x20Campanha=','constructor','CronJob','variables','metadata','\x20n√£o\x20conectado.\x20Pulando\x20envio\x20de\x20mensagem\x20para\x20ticket\x20#','üß™\x20MODO\x20TESTE\x20ATIVADO\x20-\x20Simulando\x20envio:\x20Campanha=','6920SJNlvc','longerIntervalAfter',';Contato=','extension','1251MfYpBq','9287806HIduHp','\x20ap√≥s\x20','queue-','Campaign\x20not\x20found','open','WhatsappRestartQueue','ENVIADA','üèÅ\x20Campanha\x20ID=','number','HH:mm:ss','@sentry/node','*\x20*\x20*\x20*\x20*','0\x20*\x20*\x20*\x20*','userId','\x20est√°\x20atrasada!\x20Executando\x20imediatamente...','VerifyLoginStatus','__importStar','[Assinaturas]\x20Erro\x20ao\x20verificar\x20assinaturas:\x20','findAll','minutes','whatsappRestartQueue','content-type','phoneNumber','confirmationMessage3','mediaName','./models/Plan','key','seconds','stack','‚ÑπÔ∏è\x20\x20Nenhuma\x20campanha\x20programada\x20para\x20a\x20pr√≥xima\x20hora','logger','1572408yxOQVK','Erro\x20ao\x20criar\x20log\x20de\x20campanha:\x20','writable','DESC','confirmationMessage','daysR','mediaPath','\x20encerrado\x20por\x20inatividade\x20ap√≥s\x20','updatedAt',',\x20Delay=','process','lastRestartAt','contacts','apply','search','includes','REDIS_URI','defineProperty','scheduleMonitor','\x20minutos\x20desde\x20o\x20aviso\x20(total:\x20','\x20segundos\x20finalizado:\x20','[Assinaturas]\x20Verifica√ß√£o\x20de\x20assinaturas\x20conclu√≠da.','removeWbot','1911204YIQKlp','PENDENTE','‚úÖ\x20Campanha\x20ID=','whatsapp','\x20FINALIZADA!\x20Todos\x20os\x20','default','createdAt','isArray','\x22\x20n√£o\x20possui\x20contatos\x20v√°lidos!','dueDate','-pending','data'];a426_0xd408=function(){return _0x48bb13;};return a426_0xd408();}async function handleSendMessage(_0x4dd1b2){const _0x5ad03a=a426_0x4f6aed;try{const {data:_0x2d428a}=_0x4dd1b2,_0x597a1b=await Whatsapp_1['default'][_0x5ad03a(0x11f)](_0x2d428a[_0x5ad03a(0xf9)]);if(_0x597a1b==null)throw Error(_0x5ad03a(0x12c));const _0x428513=_0x2d428a['data'];await(0x0,SendMessage_1[_0x5ad03a(0x171)])(_0x597a1b,_0x428513);}catch(_0x50931d){Sentry[_0x5ad03a(0xde)](_0x50931d),logger_1['logger'][_0x5ad03a(0x1ae)]({'error':_0x50931d},_0x5ad03a(0x16f));throw _0x50931d;}}async function handleVerifySchedules(){const _0x281aac=a426_0x4f6aed;try{const {count:_0x546f66,rows:_0x18801b}=await Schedule_1[_0x281aac(0xb4)][_0x281aac(0xc8)]({'where':{'status':_0x281aac(0xb0),'sentAt':null,'sendAt':{[sequelize_1['Op'][_0x281aac(0xfe)]]:(0x0,moment_1[_0x281aac(0xb4)])()['subtract'](0x1,_0x281aac(0x197))[_0x281aac(0xca)](_0x281aac(0xdb)),[sequelize_1['Op'][_0x281aac(0x112)]]:(0x0,moment_1[_0x281aac(0xb4)])()['add'](0x1e,_0x281aac(0x94))['format']('YYYY-MM-DD\x20HH:mm:ss')}},'include':[{'model':Contact_1[_0x281aac(0xb4)],'as':'contact'}]});_0x546f66>0x0&&_0x18801b[_0x281aac(0x184)](async _0x378e30=>{const _0x40484b=_0x281aac;await _0x378e30[_0x40484b(0x15c)]({'status':_0x40484b(0x11a)}),exports['sendScheduledMessages'][_0x40484b(0x108)]('SendMessage',{'schedule':_0x378e30},{'delay':0x9c40}),logger_1[_0x40484b(0x97)][_0x40484b(0xbc)](_0x40484b(0x19f)+_0x378e30[_0x40484b(0x183)]['name']);});}catch(_0x44fb51){Sentry['captureException'](_0x44fb51),logger_1['logger']['error']({'error':_0x44fb51},_0x281aac(0x1b0));throw _0x44fb51;}}async function handleSendScheduledMessage(_0x36a6c3){const _0x541b4d=a426_0x4f6aed,{data:{schedule:_0xdb767b}}=_0x36a6c3;let _0x4b40a5=null;try{_0x4b40a5=await Schedule_1['default']['findByPk'](_0xdb767b['id'],{'include':[{'model':Contact_1[_0x541b4d(0xb4)],'as':'contact'}]});if(!_0x4b40a5){logger_1[_0x541b4d(0x97)][_0x541b4d(0xbc)]('Agendamento\x20'+_0xdb767b['id']+_0x541b4d(0x1b9));return;}if(_0x4b40a5[_0x541b4d(0x1a6)]===_0x541b4d(0x7f)||_0x4b40a5[_0x541b4d(0x19a)]){logger_1[_0x541b4d(0x97)][_0x541b4d(0xbc)]('Agendamento\x20'+_0xdb767b['id']+'\x20j√°\x20foi\x20enviado');return;}}catch(_0x401021){Sentry[_0x541b4d(0xde)](_0x401021),logger_1[_0x541b4d(0x97)]['info'](_0x541b4d(0x115)+_0xdb767b['id']);return;}try{const _0x13a3f8=await(0x0,GetDefaultWhatsApp_1[_0x541b4d(0xb4)])(_0x4b40a5[_0x541b4d(0x11d)]),_0x18675f=await(0x0,GetWhatsappWbot_1[_0x541b4d(0xb4)])(_0x13a3f8),_0x42fa34=_0x4b40a5[_0x541b4d(0x183)][_0x541b4d(0x81)][_0x541b4d(0xe0)](),_0x132c12=_0x42fa34[_0x541b4d(0xa7)]('@')?_0x42fa34:_0x42fa34+'@'+(_0x42fa34[_0x541b4d(0x163)]>0xd?'lid':_0x541b4d(0x105)),_0x149476={'contact':_0x4b40a5[_0x541b4d(0x183)],'queue':null,'company':null,'user':null,'whatsapp':_0x13a3f8},_0x530d03=(0x0,Mustache_1['default'])(_0x4b40a5[_0x541b4d(0x1b7)],_0x149476),_0x19a114=await(0x0,SendMessage_1['SendMessage'])(_0x13a3f8,{'number':_0x4b40a5[_0x541b4d(0x183)]['number'],'body':_0x530d03});if(_0x4b40a5[_0x541b4d(0x9e)]){const _0x250820=_0x4b40a5[_0x541b4d(0x9e)];let _0x39237a={};if(_0x250820[_0x541b4d(0x19c)](_0x541b4d(0xe5))||_0x250820[_0x541b4d(0x19c)](_0x541b4d(0xcd))){const _0x3f4e1c=require(_0x541b4d(0x162)),_0x46adf6=require(_0x541b4d(0x177)),_0x2a4efa=await _0x3f4e1c({'url':_0x250820,'method':_0x541b4d(0x1be),'responseType':'arraybuffer'}),_0x4260dd=_0x46adf6[_0x541b4d(0x1dd)](_0x2a4efa[_0x541b4d(0x1cf)][_0x541b4d(0x8e)])||_0x541b4d(0x19e),_0x5c6385='temp_schedule_'+Date[_0x541b4d(0x100)]()+'.'+_0x4260dd,_0x4f93d1=path_1[_0x541b4d(0xb4)]['resolve']('public',_0x5c6385);fs_1[_0x541b4d(0xb4)]['writeFileSync'](_0x4f93d1,_0x2a4efa[_0x541b4d(0xba)]),_0x39237a=await(0x0,SendWhatsAppMedia_1[_0x541b4d(0xc5)])(_0x4b40a5['mediaName']||_0x5c6385,_0x4f93d1),Object[_0x541b4d(0xc7)](_0x39237a)[_0x541b4d(0x163)]&&await _0x18675f['sendMessage'](_0x132c12,{..._0x39237a}),setTimeout(()=>{const _0x15c05a=_0x541b4d;try{fs_1[_0x15c05a(0xb4)][_0x15c05a(0x1a7)](_0x4f93d1);}catch(_0xaf7250){}},0x1388);}else{let _0x1ec917=path_1[_0x541b4d(0xb4)][_0x541b4d(0x131)](_0x541b4d(0x151),_0x250820);!fs_1[_0x541b4d(0xb4)][_0x541b4d(0x172)](_0x1ec917)&&(_0x1ec917=path_1[_0x541b4d(0xb4)]['resolve']('public',_0x541b4d(0xe3),_0x250820)),fs_1[_0x541b4d(0xb4)][_0x541b4d(0x172)](_0x1ec917)&&(_0x39237a=await(0x0,SendWhatsAppMedia_1[_0x541b4d(0xc5)])(_0x4b40a5[_0x541b4d(0x91)],_0x1ec917),Object['keys'](_0x39237a)[_0x541b4d(0x163)]&&await _0x18675f[_0x541b4d(0xea)](_0x132c12,{..._0x39237a}));}}_0x4b40a5[_0x541b4d(0x10f)]&&(0x0,wbotMessageListener_1[_0x541b4d(0xed)])(_0x19a114,await(0x0,GetWhatsappWbot_1[_0x541b4d(0xb4)])(_0x13a3f8),_0x4b40a5[_0x541b4d(0x11d)]);await _0x4b40a5[_0x541b4d(0x15c)]({'sentAt':new Date(),'status':_0x541b4d(0x7f)}),logger_1[_0x541b4d(0x97)]['info']('Mensagem\x20agendada\x20enviada\x20para:\x20'+_0x4b40a5['contact'][_0x541b4d(0x15e)]);_0x4b40a5[_0x541b4d(0xbd)]&&await createTagLog(_0x4b40a5[_0x541b4d(0xbd)],_0x4b40a5[_0x541b4d(0x11d)],_0x541b4d(0x18a),{'contact':_0x4b40a5['contact'][_0x541b4d(0x15e)],'phoneNumber':_0x4b40a5[_0x541b4d(0x183)][_0x541b4d(0x81)],'message':_0x530d03,'metadata':{'sentAt':new Date(),'messageId':_0x19a114[_0x541b4d(0x93)]['id']}});if(_0x4b40a5[_0x541b4d(0x9d)]&&_0x4b40a5[_0x541b4d(0x9d)]>0x0){const _0x759585=new Date(_0x4b40a5['sendAt']);_0x759585[_0x541b4d(0x12a)](_0x759585[_0x541b4d(0x126)]()+_0x4b40a5[_0x541b4d(0x9d)]),logger_1[_0x541b4d(0x97)][_0x541b4d(0xbc)](_0x541b4d(0x1b2)+_0x4b40a5[_0x541b4d(0x9d)]+'\x20dias):\x20'+_0x759585[_0x541b4d(0x1cd)]());try{await Schedule_1['default'][_0x541b4d(0x1b1)]({'body':_0x4b40a5[_0x541b4d(0x1b7)],'sendAt':_0x759585,'contactId':_0x4b40a5[_0x541b4d(0x17d)],'companyId':_0x4b40a5[_0x541b4d(0x11d)],'userId':_0x4b40a5[_0x541b4d(0x86)],'saveMessage':_0x4b40a5['saveMessage'],'status':_0x541b4d(0xb0),'campId':_0x4b40a5['campId'],'daysR':_0x4b40a5[_0x541b4d(0x9d)],'mediaPath':_0x4b40a5[_0x541b4d(0x9e)],'mediaName':_0x4b40a5[_0x541b4d(0x91)]}),logger_1['logger']['info']('Pr√≥ximo\x20agendamento\x20criado\x20com\x20sucesso\x20para\x20'+_0x759585[_0x541b4d(0x1cd)]());}catch(_0x398b58){logger_1['logger']['error'](_0x541b4d(0x147)+_0x398b58);}}exports['sendScheduledMessages']['clean'](0x3a98,'completed');}catch(_0x308aa2){Sentry[_0x541b4d(0xde)](_0x308aa2),await _0x4b40a5?.[_0x541b4d(0x15c)]({'status':_0x541b4d(0x1a9)});_0x4b40a5?.[_0x541b4d(0xbd)]&&await createTagLog(_0x4b40a5[_0x541b4d(0xbd)],_0x4b40a5[_0x541b4d(0x11d)],'error',{'contact':_0x4b40a5[_0x541b4d(0x183)]?.[_0x541b4d(0x15e)],'phoneNumber':_0x4b40a5[_0x541b4d(0x183)]?.[_0x541b4d(0x81)],'message':_0x4b40a5['body'],'metadata':{'error':_0x308aa2[_0x541b4d(0xf7)]}});logger_1[_0x541b4d(0x97)][_0x541b4d(0x1ae)]({'error':_0x308aa2},_0x541b4d(0x152));throw _0x308aa2;}}async function handleVerifyCampaigns(){const _0x475ab9=a426_0x4f6aed;logger_1[_0x475ab9(0x97)][_0x475ab9(0xbc)](_0x475ab9(0x1d0));const _0xc4e591=await database_1[_0x475ab9(0xb4)][_0x475ab9(0x1af)](_0x475ab9(0xcc),{'type':sequelize_1[_0x475ab9(0x199)][_0x475ab9(0x12d)]});_0xc4e591[_0x475ab9(0x163)]?(logger_1[_0x475ab9(0x97)][_0x475ab9(0xbc)](_0x475ab9(0x1c6)+_0xc4e591['length']),_0xc4e591[_0x475ab9(0x14e)](_0x2c6417=>{const _0x53a5e4=_0x475ab9;logger_1[_0x53a5e4(0x97)][_0x53a5e4(0xbc)]('\x20\x20üìã\x20Campanha\x20ID='+_0x2c6417['id']+_0x53a5e4(0x198)+_0x2c6417[_0x53a5e4(0x1ac)]);})):logger_1[_0x475ab9(0x97)][_0x475ab9(0xbc)](_0x475ab9(0x96)),_0xc4e591[_0x475ab9(0x14e)](async _0x26c15c=>{const _0x5bf286=_0x475ab9;try{const _0x1f80af=await exports['campaignQueue'][_0x5bf286(0x15b)]([_0x5bf286(0x18f),'delayed',_0x5bf286(0xcb)]),_0x119c63=_0x1f80af[_0x5bf286(0x17f)](_0x2a7cfd=>_0x2a7cfd&&_0x2a7cfd[_0x5bf286(0xba)]&&_0x2a7cfd[_0x5bf286(0x15e)]===_0x5bf286(0x16a)&&_0x2a7cfd[_0x5bf286(0xba)]['id']===_0x26c15c['id']);if(_0x119c63){logger_1[_0x5bf286(0x97)][_0x5bf286(0xbc)]('‚è≠Ô∏è\x20\x20Campanha\x20ID='+_0x26c15c['id']+_0x5bf286(0x1d2));return;}const _0x39cfd8=(0x0,moment_1[_0x5bf286(0xb4)])(),_0x21b9f7=(0x0,moment_1[_0x5bf286(0xb4)])(_0x26c15c[_0x5bf286(0x1ac)]),_0x3fe9ef=_0x21b9f7[_0x5bf286(0x14d)](_0x39cfd8,'milliseconds');_0x3fe9ef<0x0&&logger_1[_0x5bf286(0x97)][_0x5bf286(0x16b)](_0x5bf286(0x12b)+_0x26c15c['id']+_0x5bf286(0x87)),logger_1[_0x5bf286(0x97)][_0x5bf286(0xbc)](_0x5bf286(0x1c2)+_0x26c15c['id']+_0x5bf286(0xa1)+_0x3fe9ef+'ms\x20('+(_0x3fe9ef/0x3e8)[_0x5bf286(0x11e)](0x1)+'s)'),await exports['campaignQueue']['add'](_0x5bf286(0x16a),{'id':_0x26c15c['id'],'delay':Math['max'](0x0,_0x3fe9ef)},{'removeOnComplete':!![]});}catch(_0x29d8fa){Sentry[_0x5bf286(0xde)](_0x29d8fa),logger_1[_0x5bf286(0x97)][_0x5bf286(0x1ae)](_0x5bf286(0x178)+_0x26c15c['id']+':\x20'+_0x29d8fa['message']),logger_1[_0x5bf286(0x97)][_0x5bf286(0x1ae)](_0x5bf286(0xc4)+_0x29d8fa[_0x5bf286(0x95)]);}});}async function getCampaign(_0x568f7d){const _0x1c1a81=a426_0x4f6aed;return Campaign_1[_0x1c1a81(0xb4)][_0x1c1a81(0x11f)](_0x568f7d,{'include':[{'model':ContactList_1['default'],'as':_0x1c1a81(0x192),'attributes':['id',_0x1c1a81(0x15e)],'include':[{'model':ContactListItem_1[_0x1c1a81(0xb4)],'as':_0x1c1a81(0xa4),'attributes':['id',_0x1c1a81(0x15e),_0x1c1a81(0x81),_0x1c1a81(0xfd),_0x1c1a81(0x137)],'where':{'isWhatsappValid':!![]}}]},{'model':Whatsapp_1['default'],'as':_0x1c1a81(0xb2),'attributes':['id',_0x1c1a81(0x15e)]},{'model':CampaignShipping_1[_0x1c1a81(0xb4)],'as':_0x1c1a81(0x18d),'include':[{'model':ContactListItem_1[_0x1c1a81(0xb4)],'as':_0x1c1a81(0x183)}]}]});}async function getSettings(_0x3dbd19){const _0x47a6d7=a426_0x4f6aed,_0x5af9a1=await CampaignSetting_1[_0x47a6d7(0xb4)][_0x47a6d7(0x8b)]({'where':{'companyId':_0x3dbd19[_0x47a6d7(0x11d)]},'attributes':[_0x47a6d7(0x93),_0x47a6d7(0x14f)]});let _0x3b35ea=0x14,_0x1fee08=0x14,_0x2a3e33=0x3c,_0x214e65=[];return _0x5af9a1[_0x47a6d7(0x14e)](_0x22fb49=>{const _0x39efca=_0x47a6d7;_0x22fb49[_0x39efca(0x93)]===_0x39efca(0x195)&&(_0x3b35ea=JSON['parse'](_0x22fb49[_0x39efca(0x14f)])),_0x22fb49[_0x39efca(0x93)]===_0x39efca(0x1db)&&(_0x1fee08=JSON[_0x39efca(0x196)](_0x22fb49[_0x39efca(0x14f)])),_0x22fb49[_0x39efca(0x93)]===_0x39efca(0x159)&&(_0x2a3e33=JSON[_0x39efca(0x196)](_0x22fb49[_0x39efca(0x14f)])),_0x22fb49['key']===_0x39efca(0x1d6)&&(_0x214e65=JSON[_0x39efca(0x196)](_0x22fb49[_0x39efca(0x14f)]));}),{'messageInterval':_0x3b35ea,'longerIntervalAfter':_0x1fee08,'greaterInterval':_0x2a3e33,'variables':_0x214e65};}function parseToMilliseconds(_0x3bb215){return _0x3bb215*0x3e8;}async function sleep(_0xc913be){const _0x2ffb01=a426_0x4f6aed;return logger_1[_0x2ffb01(0x97)][_0x2ffb01(0xbc)](_0x2ffb01(0x14c)+_0xc913be+'\x20segundos\x20iniciado:\x20'+(0x0,moment_1[_0x2ffb01(0xb4)])()[_0x2ffb01(0xca)](_0x2ffb01(0x82))),new Promise(_0x186f0e=>{setTimeout(()=>{const _0x1c3509=a426_0x32cf;logger_1[_0x1c3509(0x97)][_0x1c3509(0xbc)](_0x1c3509(0x14c)+_0xc913be+_0x1c3509(0xac)+(0x0,moment_1[_0x1c3509(0xb4)])()[_0x1c3509(0xca)](_0x1c3509(0x82))),_0x186f0e(!![]);},parseToMilliseconds(_0xc913be));});}function getCampaignValidMessages(_0x18daba){const _0x633a12=a426_0x4f6aed,_0x4d723c=[];return!(0x0,lodash_1['isEmpty'])(_0x18daba['message1'])&&!(0x0,lodash_1['isNil'])(_0x18daba[_0x633a12(0x101)])&&_0x4d723c[_0x633a12(0x113)](_0x18daba[_0x633a12(0x101)]),!(0x0,lodash_1['isEmpty'])(_0x18daba[_0x633a12(0x1c0)])&&!(0x0,lodash_1[_0x633a12(0x139)])(_0x18daba[_0x633a12(0x1c0)])&&_0x4d723c[_0x633a12(0x113)](_0x18daba[_0x633a12(0x1c0)]),!(0x0,lodash_1[_0x633a12(0x141)])(_0x18daba[_0x633a12(0x19d)])&&!(0x0,lodash_1[_0x633a12(0x139)])(_0x18daba[_0x633a12(0x19d)])&&_0x4d723c[_0x633a12(0x113)](_0x18daba[_0x633a12(0x19d)]),!(0x0,lodash_1['isEmpty'])(_0x18daba[_0x633a12(0x1a0)])&&!(0x0,lodash_1[_0x633a12(0x139)])(_0x18daba[_0x633a12(0x1a0)])&&_0x4d723c[_0x633a12(0x113)](_0x18daba[_0x633a12(0x1a0)]),!(0x0,lodash_1['isEmpty'])(_0x18daba[_0x633a12(0xfc)])&&!(0x0,lodash_1[_0x633a12(0x139)])(_0x18daba['message5'])&&_0x4d723c['push'](_0x18daba[_0x633a12(0xfc)]),_0x4d723c;}function getCampaignValidConfirmationMessages(_0x43698e){const _0x288b1e=a426_0x4f6aed,_0x500e5b=[];return!(0x0,lodash_1[_0x288b1e(0x141)])(_0x43698e[_0x288b1e(0x158)])&&!(0x0,lodash_1[_0x288b1e(0x139)])(_0x43698e[_0x288b1e(0x158)])&&_0x500e5b[_0x288b1e(0x113)](_0x43698e[_0x288b1e(0x158)]),!(0x0,lodash_1[_0x288b1e(0x141)])(_0x43698e[_0x288b1e(0x109)])&&!(0x0,lodash_1[_0x288b1e(0x139)])(_0x43698e[_0x288b1e(0x109)])&&_0x500e5b[_0x288b1e(0x113)](_0x43698e[_0x288b1e(0x109)]),!(0x0,lodash_1['isEmpty'])(_0x43698e['confirmationMessage3'])&&!(0x0,lodash_1['isNil'])(_0x43698e[_0x288b1e(0x90)])&&_0x500e5b[_0x288b1e(0x113)](_0x43698e[_0x288b1e(0x90)]),!(0x0,lodash_1[_0x288b1e(0x141)])(_0x43698e[_0x288b1e(0xd5)])&&!(0x0,lodash_1[_0x288b1e(0x139)])(_0x43698e['confirmationMessage4'])&&_0x500e5b['push'](_0x43698e['confirmationMessage4']),!(0x0,lodash_1[_0x288b1e(0x141)])(_0x43698e['confirmationMessage5'])&&!(0x0,lodash_1['isNil'])(_0x43698e['confirmationMessage5'])&&_0x500e5b[_0x288b1e(0x113)](_0x43698e['confirmationMessage5']),_0x500e5b;}function getProcessedMessage(_0x3d92af,_0x5e04be,_0x14d0bc){const _0x19a2c1=a426_0x4f6aed;let _0x46696d=_0x3d92af;return _0x46696d[_0x19a2c1(0xa7)]('{nome}')&&(_0x46696d=_0x46696d['replace'](/{nome}/g,_0x14d0bc['name'])),_0x46696d[_0x19a2c1(0xa7)]('{email}')&&(_0x46696d=_0x46696d['replace'](/{email}/g,_0x14d0bc['email'])),_0x46696d[_0x19a2c1(0xa7)]('{numero}')&&(_0x46696d=_0x46696d['replace'](/{numero}/g,_0x14d0bc[_0x19a2c1(0x81)])),_0x5e04be[_0x19a2c1(0x14e)](_0xd5d227=>{const _0x5de006=_0x19a2c1;if(_0x46696d[_0x5de006(0xa7)]('{'+_0xd5d227[_0x5de006(0x93)]+'}')){const _0x278fee=new RegExp('{'+_0xd5d227[_0x5de006(0x93)]+'}','g');_0x46696d=_0x46696d['replace'](_0x278fee,_0xd5d227[_0x5de006(0x14f)]);}}),_0x46696d;}function randomValue(_0x32741e,_0x4eec40){const _0x50220d=a426_0x4f6aed;return Math[_0x50220d(0x1d1)](Math[_0x50220d(0x142)]()*_0x4eec40)+_0x32741e;}async function createTagLog(_0x5de11d,_0x43a1cf,_0xc8e391,_0x311dd2={}){const _0x46f9d6=a426_0x4f6aed;try{const _0x13bca4=await TagLog_1[_0x46f9d6(0xb4)][_0x46f9d6(0x1b1)]({'tagId':_0x5de11d,'type':_0xc8e391,'contact':_0x311dd2[_0x46f9d6(0x183)]||null,'phoneNumber':_0x311dd2[_0x46f9d6(0x8f)]||null,'message':_0x311dd2['message']||null,'metadata':_0x311dd2[_0x46f9d6(0x1d7)]||null}),_0x2564ce=(0x0,socket_1['getIO'])();return _0x2564ce[_0x46f9d6(0xe2)](_0x46f9d6(0xff)+_0x43a1cf+_0x46f9d6(0xeb),{'action':_0x46f9d6(0x1b1),'tagId':_0x5de11d,'log':_0x13bca4['toJSON']()}),_0x13bca4;}catch(_0x4c4272){logger_1[_0x46f9d6(0x97)][_0x46f9d6(0x1ae)](_0x46f9d6(0x140)+_0x4c4272);}}async function createCampaignLog(_0x337c40,_0x340523,_0x3107d1,_0x1ea48b={}){const _0x85c24=a426_0x4f6aed;try{const _0x5b4263=await CampaignLog_1[_0x85c24(0xb4)][_0x85c24(0x1b1)]({'campaignId':_0x337c40,'type':_0x3107d1,'contact':_0x1ea48b[_0x85c24(0x183)]||null,'phoneNumber':_0x1ea48b[_0x85c24(0x8f)]||null,'position':_0x1ea48b['position']||null,'message':_0x1ea48b[_0x85c24(0xf7)]||null,'metadata':_0x1ea48b[_0x85c24(0x1d7)]||null}),_0x101639=(0x0,socket_1[_0x85c24(0xe9)])();return _0x101639['emit']('company-'+_0x340523+'-campaign-log',{'action':_0x85c24(0x1b1),'campaignId':_0x337c40,'log':_0x5b4263[_0x85c24(0xe1)]()}),_0x5b4263;}catch(_0x4feaf5){logger_1[_0x85c24(0x97)][_0x85c24(0x1ae)](_0x85c24(0x99)+_0x4feaf5);}}async function verifyAndFinalizeCampaign(_0x165210){const _0x345b41=a426_0x4f6aed,_0x388fcd=await(0x0,ShowService_1[_0x345b41(0xb4)])(_0x165210['id']);_0x388fcd[_0x345b41(0x17a)]===_0x388fcd[_0x345b41(0xd1)]?(await _0x165210[_0x345b41(0x15c)]({'status':'FINALIZADA','completedAt':(0x0,moment_1['default'])()}),logger_1[_0x345b41(0x97)]['info'](_0x345b41(0x80)+_0x165210['id']+_0x345b41(0xb3)+_0x388fcd[_0x345b41(0xd1)]+_0x345b41(0x102)),await createCampaignLog(_0x165210['id'],_0x165210['companyId'],_0x345b41(0xe6),{'metadata':{'totalProcessed':_0x388fcd[_0x345b41(0xd1)],'totalValid':_0x388fcd['valids'],'confirmationRequested':_0x388fcd['confirmationRequested'],'confirmed':_0x388fcd['confirmed']}})):logger_1[_0x345b41(0x97)][_0x345b41(0xbc)](_0x345b41(0x143)+_0x165210['id']+':\x20'+_0x388fcd[_0x345b41(0xd1)]+'/'+_0x388fcd[_0x345b41(0x17a)]+'\x20enviados');const _0x4c5f8a=await Campaign_1[_0x345b41(0xb4)][_0x345b41(0x11f)](_0x165210['id'],{'include':[{'model':ContactList_1[_0x345b41(0xb4)],'attributes':['id',_0x345b41(0x15e)]},{'model':Whatsapp_1[_0x345b41(0xb4)],'attributes':['id',_0x345b41(0x15e)]}]}),_0x39489e=(0x0,socket_1['getIO'])();_0x39489e['emit']('company-'+_0x165210[_0x345b41(0x11d)]+'-campaign',{'action':_0x345b41(0x15c),'record':{..._0x4c5f8a[_0x345b41(0xe1)](),'statistics':{'valids':_0x388fcd[_0x345b41(0x17a)],'delivered':_0x388fcd[_0x345b41(0xd1)],'confirmationRequested':_0x388fcd[_0x345b41(0x15d)],'confirmed':_0x388fcd[_0x345b41(0x1ba)]}}});}async function prepareContact(_0x180509,_0x144dda,_0x1c3cb8,_0x1d61e2,_0x12669a,_0x4b0dbb){const _0x573af1=a426_0x4f6aed,_0x26445b={};_0x26445b['number']=_0x1c3cb8[_0x573af1(0x81)],_0x26445b[_0x573af1(0x17d)]=_0x1c3cb8['id'],_0x26445b[_0x573af1(0x106)]=_0x180509['id'];if(_0x12669a['length']){const _0x46062d=randomValue(0x0,_0x12669a[_0x573af1(0x163)]),_0x3d549a=getProcessedMessage(_0x12669a[_0x46062d],_0x144dda,_0x1c3cb8);_0x26445b[_0x573af1(0xf7)]=''+_0x3d549a;}if(_0x180509[_0x573af1(0x14b)]){if(_0x4b0dbb[_0x573af1(0x163)]){const _0x46878e=randomValue(0x0,_0x4b0dbb[_0x573af1(0x163)]),_0x21df59=getProcessedMessage(_0x4b0dbb[_0x46878e],_0x144dda,_0x1c3cb8);_0x26445b[_0x573af1(0x9c)]=''+_0x21df59;}}const [_0x380f09,_0x164d1b]=await CampaignShipping_1[_0x573af1(0xb4)][_0x573af1(0x10c)]({'where':{'campaignId':_0x26445b[_0x573af1(0x106)],'contactId':_0x26445b['contactId']},'defaults':_0x26445b});!_0x164d1b&&_0x380f09[_0x573af1(0x17c)]===null&&_0x380f09[_0x573af1(0xf2)]===null&&(_0x380f09[_0x573af1(0x120)](_0x26445b),await _0x380f09[_0x573af1(0x181)]());if(_0x380f09[_0x573af1(0x17c)]===null&&_0x380f09['confirmationRequestedAt']===null){const _0x4a3537=await exports[_0x573af1(0x173)]['add']('DispatchCampaign',{'campaignId':_0x180509['id'],'campaignShippingId':_0x380f09['id'],'contactListItemId':_0x1c3cb8['id']},{'delay':_0x1d61e2});await _0x380f09[_0x573af1(0x15c)]({'jobId':''+_0x4a3537['id']});}}async function handleProcessCampaign(_0x48e3a5){const _0xb4e559=a426_0x4f6aed;try{const {id:_0x3b65ca}=_0x48e3a5[_0xb4e559(0xba)];let {delay:_0x309500}=_0x48e3a5['data'];const _0x4845d0=await getCampaign(_0x3b65ca);if(!_0x4845d0){logger_1['logger'][_0xb4e559(0x1ae)](_0xb4e559(0x189)+_0x3b65ca+'\x20n√£o\x20encontrada!');return;}logger_1[_0xb4e559(0x97)][_0xb4e559(0xbc)](_0xb4e559(0x150)+_0x4845d0['id']+',\x20Nome=\x22'+_0x4845d0[_0xb4e559(0x15e)]+'\x22');if(!_0x4845d0[_0xb4e559(0x192)]){logger_1[_0xb4e559(0x97)][_0xb4e559(0x1ae)](_0xb4e559(0x189)+_0x3b65ca+_0xb4e559(0x153));return;}if(!_0x4845d0[_0xb4e559(0xb2)]){logger_1['logger'][_0xb4e559(0x1ae)]('‚ùå\x20Campanha\x20ID='+_0x3b65ca+_0xb4e559(0xd7));return;}const _0x6eb923=await getSettings(_0x4845d0);if(_0x4845d0){const {contacts:_0x1eefba}=_0x4845d0[_0xb4e559(0x192)];if(!_0x1eefba||_0x1eefba[_0xb4e559(0x163)]===0x0){logger_1[_0xb4e559(0x97)][_0xb4e559(0x1ae)](_0xb4e559(0x189)+_0x3b65ca+'\x20-\x20Lista\x20\x22'+_0x4845d0[_0xb4e559(0x192)][_0xb4e559(0x15e)]+_0xb4e559(0xb7));return;}logger_1['logger'][_0xb4e559(0xbc)](_0xb4e559(0xb1)+_0x3b65ca+'\x20possui\x20'+_0x1eefba['length']+_0xb4e559(0xd8)),await createCampaignLog(_0x4845d0['id'],_0x4845d0[_0xb4e559(0x11d)],_0xb4e559(0x125),{'metadata':{'totalContacts':_0x1eefba[_0xb4e559(0x163)],'messageInterval':_0x6eb923[_0xb4e559(0x195)],'longerIntervalAfter':_0x6eb923[_0xb4e559(0x1db)],'greaterInterval':_0x6eb923[_0xb4e559(0x159)]}});const _0xdc92ee=getCampaignValidMessages(_0x4845d0),_0x507604=_0x4845d0['confirmation']?getCampaignValidConfirmationMessages(_0x4845d0):null;if((0x0,lodash_1[_0xb4e559(0xb6)])(_0x1eefba)){let _0x31e2f2=0x0;_0x1eefba[_0xb4e559(0x14e)](_0x544183=>{const _0x2846f5=_0xb4e559;prepareContact(_0x4845d0,_0x6eb923[_0x2846f5(0x1d6)],_0x544183,_0x309500,_0xdc92ee,_0x507604)[_0x2846f5(0x13f)](()=>{const _0x532271=_0x2846f5,_0x899813=(_0x309500/0x3e8)[_0x532271(0x11e)](0x1);logger_1['logger'][_0x532271(0xbc)]('üì§\x20Job\x20criado\x20na\x20fila:\x20Campanha='+_0x4845d0['id']+_0x532271(0x1dc)+_0x544183[_0x532271(0x15e)]+_0x532271(0xf3)+_0x899813+'s\x20('+_0x309500+'ms)');}),_0x31e2f2+=0x1,_0x31e2f2%_0x6eb923['longerIntervalAfter']===0x0?_0x309500+=parseToMilliseconds(_0x6eb923[_0x2846f5(0x159)]):_0x309500+=parseToMilliseconds(randomValue(0x0,_0x6eb923['messageInterval']));}),await _0x4845d0[_0xb4e559(0x15c)]({'status':_0xb4e559(0x103)}),logger_1['logger']['info'](_0xb4e559(0x119)+_0x3b65ca+_0xb4e559(0x116)),await createCampaignLog(_0x4845d0['id'],_0x4845d0[_0xb4e559(0x11d)],_0xb4e559(0x1b8),{'metadata':{'status':_0xb4e559(0x103),'totalJobs':_0x1eefba[_0xb4e559(0x163)]}});const _0x5963b6=(0x0,socket_1[_0xb4e559(0xe9)])();_0x5963b6['emit'](_0xb4e559(0xff)+_0x4845d0[_0xb4e559(0x11d)]+'-campaign',{'action':_0xb4e559(0x15c),'record':_0x4845d0});}}}catch(_0x5a2286){Sentry[_0xb4e559(0xde)](_0x5a2286),logger_1[_0xb4e559(0x97)][_0xb4e559(0x1ae)](_0xb4e559(0x10b)+_0x5a2286[_0xb4e559(0xf7)]),logger_1[_0xb4e559(0x97)][_0xb4e559(0x1ae)](_0x5a2286[_0xb4e559(0x95)]);}}async function handleDispatchCampaign(_0x1ba688){const _0x8ead4a=a426_0x4f6aed;try{const {data:_0x871370}=_0x1ba688,{campaignShippingId:_0x129163,campaignId:_0x5f1ef2}=_0x871370,_0x205d99=await Campaign_1['default'][_0x8ead4a(0x11f)](_0x5f1ef2,{'include':[{'model':Whatsapp_1[_0x8ead4a(0xb4)],'as':_0x8ead4a(0xb2)}]});if(!_0x205d99){logger_1[_0x8ead4a(0x97)]['error']({'data':_0x871370},_0x8ead4a(0x7c));return;}const _0x39be07=await(0x0,GetWhatsappWbot_1[_0x8ead4a(0xb4)])(_0x205d99['whatsapp']);logger_1['logger'][_0x8ead4a(0xbc)](_0x8ead4a(0x1d3)+_0x5f1ef2+';Registro='+_0x129163);const _0x5eca47=await CampaignShipping_1[_0x8ead4a(0xb4)][_0x8ead4a(0x11f)](_0x129163,{'include':[{'model':ContactListItem_1[_0x8ead4a(0xb4)],'as':_0x8ead4a(0x183)}]});if(_0x205d99[_0x8ead4a(0x10a)]){logger_1[_0x8ead4a(0x97)][_0x8ead4a(0x16b)](_0x8ead4a(0x1d9)+_0x5f1ef2+_0x8ead4a(0x1dc)+_0x5eca47[_0x8ead4a(0x183)][_0x8ead4a(0x15e)]+';N√∫mero='+_0x5eca47[_0x8ead4a(0x81)]);const _0x2a3713=await getSettings(_0x205d99),_0x4a2cea=await CampaignShipping_1[_0x8ead4a(0xb4)]['count']({'where':{'campaignId':_0x205d99['id'],'deliveredAt':{[sequelize_1['Op']['ne']]:null}}});await createCampaignLog(_0x205d99['id'],_0x205d99['companyId'],_0x8ead4a(0x186),{'contact':_0x5eca47[_0x8ead4a(0x183)][_0x8ead4a(0x15e)],'phoneNumber':_0x5eca47[_0x8ead4a(0x81)],'position':_0x4a2cea+0x1,'message':_0x5eca47[_0x8ead4a(0xf7)],'metadata':{'confirmationRequested':_0x205d99[_0x8ead4a(0x14b)]&&_0x5eca47[_0x8ead4a(0x14b)]===null,'confirmationMessage':_0x5eca47[_0x8ead4a(0x9c)],'mediaPath':_0x205d99['mediaPath'],'mediaName':_0x205d99['mediaName'],'settings':{'messageInterval':_0x2a3713[_0x8ead4a(0x195)],'longerIntervalAfter':_0x2a3713[_0x8ead4a(0x1db)],'greaterInterval':_0x2a3713[_0x8ead4a(0x159)]}}}),_0x205d99[_0x8ead4a(0x14b)]&&_0x5eca47[_0x8ead4a(0x14b)]===null?await _0x5eca47['update']({'confirmationRequestedAt':(0x0,moment_1['default'])()}):await _0x5eca47['update']({'deliveredAt':(0x0,moment_1[_0x8ead4a(0xb4)])()}),logger_1['logger'][_0x8ead4a(0xbc)](_0x8ead4a(0x194)+_0x5f1ef2+_0x8ead4a(0x1dc)+_0x5eca47['contact'][_0x8ead4a(0x15e)]);}else{const _0xd9e7e2=_0x5eca47['number']+_0x8ead4a(0x165),_0x567823=await(0x0,GetWhatsappWbot_1['default'])(_0x205d99[_0x8ead4a(0xb2)]);if(_0x205d99[_0x8ead4a(0x14b)]&&_0x5eca47[_0x8ead4a(0x14b)]===null)await _0x567823['sendMessage'](_0xd9e7e2,{'text':_0x5eca47[_0x8ead4a(0x9c)]}),await _0x5eca47[_0x8ead4a(0x15c)]({'confirmationRequestedAt':(0x0,moment_1[_0x8ead4a(0xb4)])()}),await createCampaignLog(_0x205d99['id'],_0x205d99['companyId'],_0x8ead4a(0x18a),{'contact':_0x5eca47['contact'][_0x8ead4a(0x15e)],'phoneNumber':_0x5eca47[_0x8ead4a(0x81)],'message':_0x5eca47[_0x8ead4a(0x9c)],'metadata':{'type':_0x8ead4a(0x14b),'messageId':null}});else{await _0x567823['sendMessage'](_0xd9e7e2,{'text':_0x5eca47[_0x8ead4a(0xf7)]});if(_0x205d99[_0x8ead4a(0x9e)]){const _0x48bb15=_0x205d99['mediaPath'];let _0x32a9e4={};if(_0x48bb15[_0x8ead4a(0x19c)](_0x8ead4a(0xe5))||_0x48bb15['startsWith'](_0x8ead4a(0xcd))){const _0x36557b=require(_0x8ead4a(0x162)),_0x5acab7=require(_0x8ead4a(0x177)),_0x2ee732=await _0x36557b({'url':_0x48bb15,'method':'GET','responseType':_0x8ead4a(0x179)}),_0xfedb66=_0x5acab7[_0x8ead4a(0x1dd)](_0x2ee732[_0x8ead4a(0x1cf)][_0x8ead4a(0x8e)])||_0x8ead4a(0x19e),_0x2a8dc0='temp_campaign_'+Date['now']()+'.'+_0xfedb66,_0x2ad6ee=path_1[_0x8ead4a(0xb4)]['resolve'](_0x8ead4a(0x151),_0x2a8dc0);fs_1[_0x8ead4a(0xb4)][_0x8ead4a(0x111)](_0x2ad6ee,_0x2ee732[_0x8ead4a(0xba)]),_0x32a9e4=await(0x0,SendWhatsAppMedia_1[_0x8ead4a(0xc5)])(_0x205d99[_0x8ead4a(0x91)]||_0x2a8dc0,_0x2ad6ee),setTimeout(()=>fs_1[_0x8ead4a(0xb4)][_0x8ead4a(0x1a7)](_0x2ad6ee),0x1388);}else{const _0x4b7d30=path_1[_0x8ead4a(0xb4)][_0x8ead4a(0x131)](_0x8ead4a(0x151),_0x48bb15);fs_1[_0x8ead4a(0xb4)][_0x8ead4a(0x172)](_0x4b7d30)&&(_0x32a9e4=await(0x0,SendWhatsAppMedia_1[_0x8ead4a(0xc5)])(_0x205d99[_0x8ead4a(0x91)],_0x4b7d30));}Object[_0x8ead4a(0xc7)](_0x32a9e4)[_0x8ead4a(0x163)]&&await _0x567823[_0x8ead4a(0xea)](_0xd9e7e2,{..._0x32a9e4});}await _0x5eca47[_0x8ead4a(0x15c)]({'deliveredAt':(0x0,moment_1['default'])()}),await createCampaignLog(_0x205d99['id'],_0x205d99[_0x8ead4a(0x11d)],_0x8ead4a(0x18a),{'contact':_0x5eca47[_0x8ead4a(0x183)]['name'],'phoneNumber':_0x5eca47[_0x8ead4a(0x81)],'message':_0x5eca47['message'],'metadata':{'type':'message','hasMedia':!!_0x205d99['mediaPath'],'mediaName':_0x205d99[_0x8ead4a(0x91)]}});}logger_1['logger']['info'](_0x8ead4a(0x107)+_0x5f1ef2+_0x8ead4a(0x1dc)+_0x5eca47[_0x8ead4a(0x183)][_0x8ead4a(0x15e)]);}await verifyAndFinalizeCampaign(_0x205d99);}catch(_0x2d297e){Sentry[_0x8ead4a(0xde)](_0x2d297e),logger_1[_0x8ead4a(0x97)][_0x8ead4a(0x1ae)](_0x2d297e['message']);}}async function handleLoginStatus(){const _0x13a21b=a426_0x4f6aed,_0x30409f=await database_1[_0x13a21b(0xb4)][_0x13a21b(0x1af)](_0x13a21b(0x168),{'type':sequelize_1[_0x13a21b(0x199)]['SELECT']});_0x30409f[_0x13a21b(0x14e)](async _0x13b0fc=>{const _0x7ee147=_0x13a21b;try{const _0x700abb=await User_1[_0x7ee147(0xb4)]['findByPk'](_0x13b0fc['id']);await _0x700abb['update']({'online':![]}),logger_1[_0x7ee147(0x97)][_0x7ee147(0xbc)](_0x7ee147(0xbb)+_0x13b0fc['id']);}catch(_0x58c1b3){Sentry['captureException'](_0x58c1b3);}});}async function handleInvoiceCreate(){const _0xa783cf=a426_0x4f6aed,_0x7c1396=new cron_1[(_0xa783cf(0x1d5))](_0xa783cf(0xf1),async()=>{const _0x19171e=_0xa783cf,_0x5868b1=await Company_1[_0x19171e(0xb4)]['findAll']();_0x5868b1[_0x19171e(0x184)](async _0x300c20=>{const _0x586a49=_0x19171e,{dueDate:_0x3167a8}=_0x300c20,_0x156cd2=(0x0,moment_1[_0x586a49(0xb4)])(_0x3167a8)[_0x586a49(0xca)](),_0x5cf8ae=(0x0,moment_1['default'])()[_0x586a49(0xca)](),_0x304731=(0x0,moment_1[_0x586a49(0xb4)])((0x0,moment_1[_0x586a49(0xb4)])())[_0x586a49(0xca)]('DD/MM/yyyy'),_0x636666=(0x0,moment_1['default'])(_0x3167a8)[_0x586a49(0xca)](_0x586a49(0x128)),_0x48c846=(0x0,moment_1[_0x586a49(0xb4)])(_0x636666,_0x586a49(0x128))['diff']((0x0,moment_1[_0x586a49(0xb4)])(_0x304731,_0x586a49(0x128))),_0x149e55=moment_1[_0x586a49(0xb4)][_0x586a49(0xef)](_0x48c846)[_0x586a49(0xf6)]();if(_0x149e55<0x14){const _0x4ea6fc=await Plan_1['default'][_0x586a49(0x11f)](_0x300c20[_0x586a49(0xc0)]),_0x3a73cc=_0x586a49(0x144)+_0x300c20['id']+_0x586a49(0xd9)+(0x0,moment_1[_0x586a49(0xb4)])(_0x3167a8)['format']('yyyy-MM-DD')+_0x586a49(0x1c9),_0x490ffe=await database_1['default']['query'](_0x3a73cc,{'type':sequelize_1[_0x586a49(0x199)][_0x586a49(0x12d)]});if(+_0x490ffe[0x0][_0x586a49(0x161)]===0x0){const _0x15ea26=_0x586a49(0x1a5)+_0x4ea6fc['name']+_0x586a49(0xdd)+_0x4ea6fc[_0x586a49(0x14f)]+'\x27,\x20\x27'+_0x5cf8ae+_0x586a49(0x10e)+_0x5cf8ae+_0x586a49(0x10e)+_0x156cd2+_0x586a49(0xe8)+_0x300c20['id']+');';await database_1[_0x586a49(0xb4)][_0x586a49(0x1af)](_0x15ea26,{'type':sequelize_1[_0x586a49(0x199)]['INSERT']});}}});});_0x7c1396['start']();}async function handleExpiredSubscriptions(){const _0x1dea10=a426_0x4f6aed,_0x1bd1cf=new cron_1[(_0x1dea10(0x1d5))](_0x1dea10(0x85),async()=>{const _0x5d6379=_0x1dea10;logger_1[_0x5d6379(0x97)][_0x5d6379(0xbc)](_0x5d6379(0x187));try{const _0x2546f6=(0x0,moment_1['default'])()['startOf'](_0x5d6379(0x134)),_0x4e6b8f=await Company_1[_0x5d6379(0xb4)]['findAll']({'where':{'status':!![],'dueDate':{[sequelize_1['Op']['lt']]:_0x2546f6[_0x5d6379(0x155)]()}}});if(_0x4e6b8f[_0x5d6379(0x163)]===0x0){logger_1['logger'][_0x5d6379(0xbc)]('[Assinaturas]\x20Nenhuma\x20empresa\x20com\x20assinatura\x20expirada\x20encontrada.');return;}logger_1[_0x5d6379(0x97)]['info'](_0x5d6379(0x133)+_0x4e6b8f[_0x5d6379(0x163)]+'\x20empresas\x20com\x20assinatura\x20expirada.');for(const _0x53dfc8 of _0x4e6b8f){logger_1['logger'][_0x5d6379(0xbc)](_0x5d6379(0x190)+_0x53dfc8['id']+'\x20-\x20'+_0x53dfc8[_0x5d6379(0x15e)]+_0x5d6379(0xdc)+(0x0,moment_1['default'])(_0x53dfc8[_0x5d6379(0xb8)])[_0x5d6379(0xca)](_0x5d6379(0x135))+')');const _0x4502ee=await Whatsapp_1['default'][_0x5d6379(0x8b)]({'where':{'companyId':_0x53dfc8['id'],'status':{[sequelize_1['Op']['in']]:[_0x5d6379(0x19b),'OPENING',_0x5d6379(0x167),_0x5d6379(0x146),_0x5d6379(0x145)]}}});if(_0x4502ee[_0x5d6379(0x163)]>0x0){logger_1[_0x5d6379(0x97)][_0x5d6379(0xbc)]('[Assinaturas]\x20Desconectando\x20'+_0x4502ee['length']+_0x5d6379(0x1ca)+_0x53dfc8[_0x5d6379(0x15e)]);for(const _0x272550 of _0x4502ee){try{await(0x0,wbot_1[_0x5d6379(0xae)])(_0x272550['id'],![]),await _0x272550['update']({'status':'DISCONNECTED','session':null}),logger_1[_0x5d6379(0x97)][_0x5d6379(0xbc)](_0x5d6379(0x110)+_0x272550[_0x5d6379(0x15e)]+_0x5d6379(0x104)+_0x272550['id']+_0x5d6379(0x15f));}catch(_0x464269){logger_1['logger'][_0x5d6379(0x1ae)](_0x5d6379(0x12f)+_0x272550['id']+':\x20'+_0x464269);}}const _0x79e0db=(0x0,socket_1[_0x5d6379(0xe9)])();_0x79e0db['to'](_0x5d6379(0xff)+_0x53dfc8['id']+_0x5d6379(0x118))[_0x5d6379(0xe2)]('company-'+_0x53dfc8['id']+_0x5d6379(0x18c),{'action':'update'});}}logger_1['logger']['info'](_0x5d6379(0xad));}catch(_0x42dda1){logger_1[_0x5d6379(0x97)]['error'](_0x5d6379(0x8a)+_0x42dda1),Sentry['captureException'](_0x42dda1);}});_0x1bd1cf[_0x1dea10(0x1b8)]();}handleExpiredSubscriptions(),handleInvoiceCreate();async function startQueueProcess(){const _0x172cd7=a426_0x4f6aed;logger_1['logger']['info']('Iniciando\x20processamento\x20de\x20filas'),exports[_0x172cd7(0xdf)][_0x172cd7(0xa2)](_0x172cd7(0x171),handleSendMessage),exports[_0x172cd7(0xaa)]['process'](_0x172cd7(0x1b4),handleVerifySchedules),exports[_0x172cd7(0xbe)]['process'](_0x172cd7(0x171),handleSendScheduledMessage),exports[_0x172cd7(0x173)][_0x172cd7(0xa2)](_0x172cd7(0x15a),handleVerifyCampaigns),exports[_0x172cd7(0x173)][_0x172cd7(0xa2)]('ProcessCampaign',handleProcessCampaign),exports[_0x172cd7(0x173)][_0x172cd7(0xa2)]('DispatchCampaign',handleDispatchCampaign),exports[_0x172cd7(0x1a4)][_0x172cd7(0xa2)](_0x172cd7(0x88),handleLoginStatus),exports['campaignQueue']['process'](_0x172cd7(0x1c4),handleDispatchCampaign),exports[_0x172cd7(0xd6)][_0x172cd7(0xa2)]('VerifyTicketExpiration',handleVerifyTicketExpiration),exports['whatsappRestartQueue'][_0x172cd7(0xa2)](_0x172cd7(0x1ce),handleWhatsappAutoRestart),exports[_0x172cd7(0xaa)][_0x172cd7(0x108)]('Verify',{},{'repeat':{'cron':_0x172cd7(0x1bb)},'removeOnComplete':!![]}),exports[_0x172cd7(0x173)][_0x172cd7(0x108)](_0x172cd7(0x15a),{},{'repeat':{'cron':_0x172cd7(0x188)},'removeOnComplete':!![]}),exports['userMonitor'][_0x172cd7(0x108)](_0x172cd7(0x88),{},{'repeat':{'cron':_0x172cd7(0x84)},'removeOnComplete':!![]}),exports['ticketMonitor']['add']('VerifyTicketExpiration',{},{'repeat':{'cron':_0x172cd7(0x185)},'removeOnComplete':!![]}),exports[_0x172cd7(0x8d)]['add']('AutoRestart',{},{'repeat':{'cron':_0x172cd7(0x85)},'removeOnComplete':!![]});}