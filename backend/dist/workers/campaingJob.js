const a573_0x1f3df2=a573_0x24e3;(function(_0x90f6b5,_0x274ee2){const _0x1ba530=a573_0x24e3,_0x1bc416=_0x90f6b5();while(!![]){try{const _0x1d967f=parseInt(_0x1ba530(0x159))/0x1*(-parseInt(_0x1ba530(0x15f))/0x2)+parseInt(_0x1ba530(0x19e))/0x3*(-parseInt(_0x1ba530(0x1bb))/0x4)+-parseInt(_0x1ba530(0x16d))/0x5*(-parseInt(_0x1ba530(0x1aa))/0x6)+parseInt(_0x1ba530(0x1d0))/0x7*(parseInt(_0x1ba530(0x146))/0x8)+-parseInt(_0x1ba530(0x1a8))/0x9+-parseInt(_0x1ba530(0x14f))/0xa*(parseInt(_0x1ba530(0x18e))/0xb)+parseInt(_0x1ba530(0x147))/0xc;if(_0x1d967f===_0x274ee2)break;else _0x1bc416['push'](_0x1bc416['shift']());}catch(_0x4f375a){_0x1bc416['push'](_0x1bc416['shift']());}}}(a573_0xc8c9,0x2500c));const a573_0x3c6657=(function(){let _0x10bca8=!![];return function(_0x1fd085,_0x3457b7){const _0x11f153=_0x10bca8?function(){const _0xb0432f=a573_0x24e3;if(_0x3457b7){const _0x5974b9=_0x3457b7[_0xb0432f(0x1b4)](_0x1fd085,arguments);return _0x3457b7=null,_0x5974b9;}}:function(){};return _0x10bca8=![],_0x11f153;};}()),a573_0x7733a9=a573_0x3c6657(this,function(){const _0x5510bf=a573_0x24e3;return a573_0x7733a9[_0x5510bf(0x14d)]()[_0x5510bf(0x140)](_0x5510bf(0x1ca))[_0x5510bf(0x14d)]()[_0x5510bf(0x195)](a573_0x7733a9)['search'](_0x5510bf(0x1ca));});a573_0x7733a9();'use strict';var __createBinding=this&&this[a573_0x1f3df2(0x151)]||(Object[a573_0x1f3df2(0x1a4)]?function(_0x2dce1a,_0x7da067,_0xc8cbe8,_0x30acac){const _0x15afbe=a573_0x1f3df2;if(_0x30acac===undefined)_0x30acac=_0xc8cbe8;var _0xd9f7eb=Object[_0x15afbe(0x14a)](_0x7da067,_0xc8cbe8);(!_0xd9f7eb||(_0x15afbe(0x194)in _0xd9f7eb?!_0x7da067[_0x15afbe(0x1ab)]:_0xd9f7eb[_0x15afbe(0x142)]||_0xd9f7eb[_0x15afbe(0x1b2)]))&&(_0xd9f7eb={'enumerable':!![],'get':function(){return _0x7da067[_0xc8cbe8];}}),Object[_0x15afbe(0x1c2)](_0x2dce1a,_0x30acac,_0xd9f7eb);}:function(_0xeb2f44,_0x53c458,_0x2a8170,_0x402079){if(_0x402079===undefined)_0x402079=_0x2a8170;_0xeb2f44[_0x402079]=_0x53c458[_0x2a8170];}),__setModuleDefault=this&&this[a573_0x1f3df2(0x1ba)]||(Object['create']?function(_0x212f83,_0x5b08d2){const _0x1d1841=a573_0x1f3df2;Object[_0x1d1841(0x1c2)](_0x212f83,_0x1d1841(0x178),{'enumerable':!![],'value':_0x5b08d2});}:function(_0x2cf92d,_0x1956d1){const _0x1f05bc=a573_0x1f3df2;_0x2cf92d[_0x1f05bc(0x178)]=_0x1956d1;}),__importStar=this&&this[a573_0x1f3df2(0x137)]||function(_0x517475){const _0x23251a=a573_0x1f3df2;if(_0x517475&&_0x517475[_0x23251a(0x1ab)])return _0x517475;var _0x5405b6={};if(_0x517475!=null){for(var _0xdd782c in _0x517475)if(_0xdd782c!==_0x23251a(0x178)&&Object['prototype'][_0x23251a(0x143)][_0x23251a(0x171)](_0x517475,_0xdd782c))__createBinding(_0x5405b6,_0x517475,_0xdd782c);}return __setModuleDefault(_0x5405b6,_0x517475),_0x5405b6;},__importDefault=this&&this[a573_0x1f3df2(0x1af)]||function(_0x10e063){return _0x10e063&&_0x10e063['__esModule']?_0x10e063:{'default':_0x10e063};};Object[a573_0x1f3df2(0x1c2)](exports,a573_0x1f3df2(0x1ab),{'value':!![]});const bullmq_1=require(a573_0x1f3df2(0x1a6)),Campaign_1=__importDefault(require('../models/Campaign')),sequelize_1=require(a573_0x1f3df2(0x1bc)),logger_1=require(a573_0x1f3df2(0x1b3)),moment_1=__importDefault(require(a573_0x1f3df2(0x1c3))),Sentry=__importStar(require(a573_0x1f3df2(0x17b))),ContactList_1=__importDefault(require(a573_0x1f3df2(0x157))),ContactListItem_1=__importDefault(require(a573_0x1f3df2(0x19f))),Whatsapp_1=__importDefault(require(a573_0x1f3df2(0x1cc))),CampaignShipping_1=__importDefault(require('../models/CampaignShipping')),queues_1=require('../queues'),lodash_1=require(a573_0x1f3df2(0x179)),date_fns_1=require(a573_0x1f3df2(0x166)),GetWhatsappWbot_1=__importDefault(require(a573_0x1f3df2(0x138))),path_1=__importDefault(require(a573_0x1f3df2(0x165))),ShowService_1=__importDefault(require('../services/FileServices/ShowService')),SendWhatsAppMedia_1=require('../services/WbotServices/SendWhatsAppMedia'),socket_1=require(a573_0x1f3df2(0x184)),CampaignSetting_1=__importDefault(require(a573_0x1f3df2(0x173))),SendPresenceStatus_1=require('../helpers/SendPresenceStatus');class CampaingJob{constructor(_0x59d82d,_0x2fe0d1){const _0x180b8c=a573_0x1f3df2,_0x3affe0=new bullmq_1[(_0x180b8c(0x1cd))](_0x59d82d,async _0xdf0a7=>{const _0x14c1c2=_0x180b8c;if(_0xdf0a7[_0x14c1c2(0x139)]===_0x14c1c2(0x19b))await this[_0x14c1c2(0x148)](_0xdf0a7);else{if(_0xdf0a7['name']===_0x14c1c2(0x145))await this[_0x14c1c2(0x154)](_0xdf0a7);else{if(_0xdf0a7['name']==='PrepareContact')await this[_0x14c1c2(0x1b9)](_0xdf0a7);else _0xdf0a7['name']===_0x14c1c2(0x13c)&&await this[_0x14c1c2(0x1c1)](_0xdf0a7);}}},{'maxStalledCount':0xa,'useWorkerThreads':![],'concurrency':0x64,'connection':_0x2fe0d1,'removeOnFail':{'count':0x0}});_0x3affe0['on'](_0x180b8c(0x199),async _0x1559e5=>{const _0x13b452=_0x180b8c;logger_1[_0x13b452(0x160)][_0x13b452(0x18a)](_0x13b452(0x1a0)+_0x1559e5[_0x13b452(0x139)]+'\x20('+_0x1559e5['id']+_0x13b452(0x180));}),_0x3affe0['on'](_0x180b8c(0x197),async(_0x36ade7,_0x3d72c9)=>{const _0x42ae84=_0x180b8c;logger_1[_0x42ae84(0x160)]['error'](_0x42ae84(0x1a0)+_0x36ade7[_0x42ae84(0x139)]+'\x20failed\x20with\x20error:\x20'+_0x3d72c9['message']);});}async['getContact'](_0x461031){const _0xa518c5=a573_0x1f3df2;return ContactListItem_1['default'][_0xa518c5(0x1bd)](_0x461031,{'attributes':['id',_0xa518c5(0x139),_0xa518c5(0x156),_0xa518c5(0x167)]});}async['handlePrepareContact'](_0x3e662c){const _0x2e5076=a573_0x1f3df2;try{const {contactId:_0x31e88f,campaignId:_0x162544,delay:_0x156857,variables:_0x1116a6}=_0x3e662c[_0x2e5076(0x17d)],_0x4ba085=await this[_0x2e5076(0x15d)](_0x162544),_0x452f0c=await this['getContact'](_0x31e88f),_0x553f07={};_0x553f07[_0x2e5076(0x156)]=_0x452f0c['number'],_0x553f07[_0x2e5076(0x161)]=_0x31e88f,_0x553f07[_0x2e5076(0x1c0)]=_0x162544;const _0x5a3356=this[_0x2e5076(0x14b)](_0x4ba085);if(_0x5a3356[_0x2e5076(0x16e)]){const _0x13c898=(0x0,queues_1[_0x2e5076(0x17e)])(0x0,_0x5a3356[_0x2e5076(0x16e)]),_0x46e9d8=this[_0x2e5076(0x13f)](_0x5a3356[_0x13c898],_0x1116a6,_0x452f0c);_0x553f07[_0x2e5076(0x19a)]='â€Œ\x20'+_0x46e9d8;}const [_0x14f456,_0x1be90b]=await CampaignShipping_1[_0x2e5076(0x178)]['findOrCreate']({'where':{'campaignId':_0x553f07[_0x2e5076(0x1c0)],'contactId':_0x553f07['contactId']},'defaults':_0x553f07});!_0x1be90b&&_0x14f456[_0x2e5076(0x18d)]===null&&(_0x14f456[_0x2e5076(0x152)](_0x553f07),await _0x14f456['save']());if(_0x14f456[_0x2e5076(0x18d)]===null){const _0x132011=await queues_1['campaignQueue'][_0x2e5076(0x16f)](_0x2e5076(0x13c),{'campaignId':_0x4ba085['id'],'campaignShippingId':_0x14f456['id'],'contactListItemId':_0x31e88f},{'removeOnComplete':!![],'delay':_0x156857});await _0x14f456['update']({'jobId':_0x132011['id']});}await this[_0x2e5076(0x13d)](_0x4ba085);}catch(_0x44c347){Sentry['captureException'](_0x44c347),logger_1[_0x2e5076(0x160)]['error'](_0x2e5076(0x153)+_0x44c347[_0x2e5076(0x19a)]);}}async[a573_0x1f3df2(0x13d)](_0x50014e){const _0xe934d3=a573_0x1f3df2;if(!_0x50014e[_0xe934d3(0x1b6)])throw new sequelize_1[(_0xe934d3(0x198))](_0xe934d3(0x183));const {contacts:_0x1004bb}=_0x50014e[_0xe934d3(0x1b6)],_0x2aad1d=_0x1004bb[_0xe934d3(0x16e)],_0x57b3a1=await CampaignShipping_1[_0xe934d3(0x178)]['count']({'where':{'campaignId':_0x50014e['id'],'deliveredAt':{[sequelize_1['Op'][_0xe934d3(0x189)]]:null}}});_0x2aad1d===_0x57b3a1&&await _0x50014e['update']({'status':_0xe934d3(0x15b),'completedAt':(0x0,moment_1[_0xe934d3(0x178)])()});const _0x3a722b=(0x0,socket_1[_0xe934d3(0x175)])();_0x3a722b['to'](_0xe934d3(0x177)+_0x50014e[_0xe934d3(0x14e)]+_0xe934d3(0x18c))[_0xe934d3(0x1b5)](_0xe934d3(0x177)+_0x50014e[_0xe934d3(0x14e)]+_0xe934d3(0x15e),{'action':_0xe934d3(0x1c4),'record':_0x50014e});}[a573_0x1f3df2(0x155)](_0x2e10dd,_0x32e883,_0x4aa1b4,_0x4ea6b6,_0x1406fc){const _0x1fcd8d=a573_0x1f3df2,_0x186705=(0x0,date_fns_1[_0x1fcd8d(0x185)])(_0x32e883,new Date());return _0x2e10dd>_0x4aa1b4?_0x186705*0x3e8+_0x4ea6b6:_0x186705*0x3e8+_0x1406fc;}async[a573_0x1f3df2(0x1c1)](_0x4cb50b){const _0x109563=a573_0x1f3df2;try{const {data:_0x1cd353}=_0x4cb50b,{campaignShippingId:_0x22e4aa,campaignId:_0x54bc00}=_0x1cd353,_0x5b55ab=await this[_0x109563(0x15d)](_0x54bc00),_0x1ac06d=await(0x0,GetWhatsappWbot_1[_0x109563(0x178)])(_0x5b55ab[_0x109563(0x141)]);if(!_0x1ac06d){logger_1[_0x109563(0x160)][_0x109563(0x1a2)](_0x109563(0x14c));return;}if(!_0x5b55ab[_0x109563(0x141)]){logger_1[_0x109563(0x160)]['error']('campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20whatsapp\x20not\x20found');return;}if(!_0x1ac06d?.[_0x109563(0x172)]?.['id']){logger_1['logger'][_0x109563(0x1a2)]('campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20user\x20not\x20found');return;}logger_1['logger']['info'](_0x109563(0x18f)+_0x54bc00+_0x109563(0x196)+_0x22e4aa);const _0x27097f=await CampaignShipping_1['default'][_0x109563(0x1bd)](_0x22e4aa,{'include':[{'model':ContactListItem_1['default'],'as':_0x109563(0x1c8)}]}),_0x540778=_0x27097f[_0x109563(0x156)]+'@s.whatsapp.net';let _0x18d8b1=_0x27097f[_0x109563(0x19a)][_0x109563(0x168)]()[_0x109563(0x164)]();const _0x5ed628=await _0x1ac06d[_0x109563(0x16a)](_0x540778,{'text':_0x18d8b1});await _0x27097f['update']({'messageId':_0x5ed628[_0x109563(0x17a)]['id'],'deliveredAt':(0x0,moment_1[_0x109563(0x178)])()}),await(0x0,SendPresenceStatus_1['SendPresenceStatus'])(_0x1ac06d,_0x540778);if(!(0x0,lodash_1[_0x109563(0x13e)])(_0x5b55ab['fileListId']))try{const _0x4f484b=path_1[_0x109563(0x178)][_0x109563(0x1cb)](__dirname,'../..',_0x109563(0x150),_0x109563(0x18b)+_0x5b55ab['companyId']),_0x176661=await(0x0,ShowService_1[_0x109563(0x178)])(_0x5b55ab[_0x109563(0x1b8)],_0x5b55ab[_0x109563(0x14e)]),_0x406418=path_1[_0x109563(0x178)][_0x109563(0x1cb)](_0x4f484b,_0x109563(0x13b),String(_0x176661['id']));for(const _0xd0e791 of _0x176661[_0x109563(0x1be)]){const _0x62ae20=await(0x0,SendWhatsAppMedia_1[_0x109563(0x16c)])(_0xd0e791['path'],path_1[_0x109563(0x178)]['resolve'](_0x406418,_0xd0e791[_0x109563(0x165)]),_0xd0e791[_0x109563(0x139)],_0x5b55ab[_0x109563(0x14e)]);await _0x1ac06d[_0x109563(0x16a)](_0x540778,{..._0x62ae20});}}catch(_0x34fd0e){logger_1[_0x109563(0x160)][_0x109563(0x1a2)]('Error\x20sending\x20campaign\x20files:\x20'+_0x34fd0e);}if(_0x5b55ab['mediaPath'])try{const _0x56adae=path_1['default'][_0x109563(0x1cb)](__dirname,_0x109563(0x1d2),_0x109563(0x150),_0x109563(0x18b)+_0x5b55ab[_0x109563(0x14e)]),_0x28fcd7=path_1['default'][_0x109563(0x1a7)](_0x56adae,_0x5b55ab['mediaPath']),_0x1a25e4=await(0x0,SendWhatsAppMedia_1[_0x109563(0x16c)])(_0x5b55ab['mediaName'],_0x28fcd7,_0x18d8b1,_0x5b55ab[_0x109563(0x14e)]);Object[_0x109563(0x170)](_0x1a25e4)[_0x109563(0x16e)]&&await _0x1ac06d[_0x109563(0x16a)](_0x540778,{..._0x1a25e4});}catch(_0x257876){logger_1['logger'][_0x109563(0x1a2)](_0x109563(0x1a9)+_0x257876);}await this[_0x109563(0x13d)](_0x5b55ab);const _0x41b522=(0x0,socket_1[_0x109563(0x175)])();_0x41b522['to'](_0x109563(0x177)+_0x5b55ab['companyId']+_0x109563(0x18c))['emit'](_0x109563(0x177)+_0x5b55ab[_0x109563(0x14e)]+_0x109563(0x15e),{'action':_0x109563(0x1c4),'record':_0x5b55ab}),logger_1['logger']['info']('Campanha\x20enviada\x20para:\x20Campanha='+_0x54bc00+_0x109563(0x149)+_0x27097f[_0x109563(0x1c8)][_0x109563(0x139)]);}catch(_0x1e8aee){Sentry[_0x109563(0x188)](_0x1e8aee),logger_1['logger'][_0x109563(0x1a2)](_0x1e8aee[_0x109563(0x19a)]);}}[a573_0x1f3df2(0x14b)](_0x6cb8e9){const _0x57353a=a573_0x1f3df2,_0x348c68=[];return!(0x0,lodash_1[_0x57353a(0x13a)])(_0x6cb8e9[_0x57353a(0x158)])&&!(0x0,lodash_1[_0x57353a(0x13e)])(_0x6cb8e9[_0x57353a(0x158)])&&_0x348c68[_0x57353a(0x1c6)](_0x6cb8e9[_0x57353a(0x158)]),!(0x0,lodash_1[_0x57353a(0x13a)])(_0x6cb8e9[_0x57353a(0x190)])&&!(0x0,lodash_1['isNil'])(_0x6cb8e9[_0x57353a(0x190)])&&_0x348c68[_0x57353a(0x1c6)](_0x6cb8e9['message2']),!(0x0,lodash_1[_0x57353a(0x13a)])(_0x6cb8e9[_0x57353a(0x1bf)])&&!(0x0,lodash_1['isNil'])(_0x6cb8e9[_0x57353a(0x1bf)])&&_0x348c68[_0x57353a(0x1c6)](_0x6cb8e9[_0x57353a(0x1bf)]),!(0x0,lodash_1[_0x57353a(0x13a)])(_0x6cb8e9[_0x57353a(0x1c7)])&&!(0x0,lodash_1['isNil'])(_0x6cb8e9[_0x57353a(0x1c7)])&&_0x348c68[_0x57353a(0x1c6)](_0x6cb8e9[_0x57353a(0x1c7)]),!(0x0,lodash_1['isEmpty'])(_0x6cb8e9['message5'])&&!(0x0,lodash_1['isNil'])(_0x6cb8e9[_0x57353a(0x1a1)])&&_0x348c68['push'](_0x6cb8e9['message5']),_0x348c68;}[a573_0x1f3df2(0x13f)](_0x94e257,_0x1a5e6c,_0x5aafdf){const _0x4d1e97=a573_0x1f3df2;let _0x265ea3=_0x94e257;return _0x265ea3[_0x4d1e97(0x144)](_0x4d1e97(0x169))&&(_0x265ea3=_0x265ea3[_0x4d1e97(0x1d3)](/{nome}/g,_0x5aafdf[_0x4d1e97(0x139)])),_0x265ea3[_0x4d1e97(0x144)](_0x4d1e97(0x1ad))&&(_0x265ea3=_0x265ea3[_0x4d1e97(0x1d3)](/{email}/g,_0x5aafdf[_0x4d1e97(0x167)])),_0x265ea3[_0x4d1e97(0x144)](_0x4d1e97(0x1c9))&&(_0x265ea3=_0x265ea3['replace'](/{numero}/g,_0x5aafdf[_0x4d1e97(0x156)])),_0x1a5e6c[_0x4d1e97(0x176)](_0x2cace0=>{const _0xf80411=_0x4d1e97;if(_0x265ea3[_0xf80411(0x144)]('{'+_0x2cace0[_0xf80411(0x17a)]+'}')){const _0x5d91cd=new RegExp('{'+_0x2cace0[_0xf80411(0x17a)]+'}','g');_0x265ea3=_0x265ea3['replace'](_0x5d91cd,_0x2cace0[_0xf80411(0x1b0)]);}}),_0x265ea3;}async[a573_0x1f3df2(0x191)](_0x1c54df){const _0x5565d3=a573_0x1f3df2,_0x11fcc8=await CampaignSetting_1[_0x5565d3(0x178)][_0x5565d3(0x174)]({'where':{'companyId':_0x1c54df[_0x5565d3(0x14e)]},'attributes':[_0x5565d3(0x17a),_0x5565d3(0x1b0)]});let _0x6975eb=0x5,_0x16b096=0x14,_0x5d1df8=0xf,_0x4b3a6d=[];return _0x11fcc8[_0x5565d3(0x176)](_0x27623e=>{const _0x3bf0cd=_0x5565d3;switch(_0x27623e[_0x3bf0cd(0x17a)]){case _0x3bf0cd(0x19c):_0x6975eb=parseInt(_0x27623e[_0x3bf0cd(0x1b0)],0xa)||0xa;break;case'longerIntervalAfter':_0x16b096=parseInt(_0x27623e[_0x3bf0cd(0x1b0)],0xa)||0x14;break;case'greaterInterval':_0x5d1df8=parseInt(_0x27623e['value'],0xa)||0xa;break;case _0x3bf0cd(0x1d1):_0x4b3a6d=JSON[_0x3bf0cd(0x1ae)](_0x27623e[_0x3bf0cd(0x1b0)]);break;}}),{'messageInterval':_0x6975eb,'longerIntervalAfter':_0x16b096,'greaterInterval':_0x5d1df8,'variables':_0x4b3a6d};}async[a573_0x1f3df2(0x154)](_0x3a155c){const _0x59d254=a573_0x1f3df2;try{const {id:_0x256304}=_0x3a155c[_0x59d254(0x17d)],_0x3f0788=await this[_0x59d254(0x15d)](_0x256304),_0x32ae33=await this[_0x59d254(0x191)](_0x3f0788);if(!_0x3f0788||!_0x3f0788[_0x59d254(0x1b6)]?.[_0x59d254(0x186)])throw new sequelize_1['Error'](_0x59d254(0x17f));const {contacts:_0x3d827a}=_0x3f0788['contactList'];if(!_0x3d827a[_0x59d254(0x16e)])throw new sequelize_1['Error']('No\x20contacts\x20found\x20for\x20this\x20campaign');const _0x83bfa=_0x3d827a[_0x59d254(0x19d)](_0x3cfa57=>({'contactId':_0x3cfa57['id'],'campaignId':_0x3f0788['id'],'variables':_0x32ae33[_0x59d254(0x1d1)]})),_0x401619=_0x83bfa['map']((_0x33a300,_0x1cab05)=>{const _0x5fb197=_0x59d254,_0x2bf396=this['calculateOptimizedDelay'](_0x1cab05,_0x32ae33[_0x5fb197(0x19c)],_0x32ae33[_0x5fb197(0x193)],_0x32ae33[_0x5fb197(0x163)]);return queues_1['campaignQueue']['add']('PrepareContact',{'contactId':_0x33a300[_0x5fb197(0x161)],'campaignId':_0x33a300[_0x5fb197(0x1c0)],'variables':_0x33a300[_0x5fb197(0x1d1)],'delay':_0x2bf396},{'removeOnComplete':!![]});});await Promise[_0x59d254(0x187)](_0x401619),await _0x3f0788[_0x59d254(0x1c4)]({'status':_0x59d254(0x17c)});}catch(_0x5ca53d){logger_1[_0x59d254(0x160)][_0x59d254(0x1a2)](_0x5ca53d),Sentry['captureException'](_0x5ca53d);}}[a573_0x1f3df2(0x1ac)](_0x531408,_0x538f5a,_0x251fe4,_0x3b3381){const _0x53b03e=a573_0x1f3df2,_0x1f45c9=0x96,_0x1a541a=0x12c,_0x40fa32=_0x531408>_0x251fe4?Math['min'](_0x1f45c9+(_0x531408-_0x251fe4)*_0x3b3381,_0x1f45c9+_0x1a541a):Math[_0x53b03e(0x1cf)](_0x531408*_0x538f5a,_0x1f45c9),_0x270a15=Math['floor'](Math[_0x53b03e(0x16b)]()*0x5dc);return _0x40fa32*0x3e8+_0x270a15;}async[a573_0x1f3df2(0x15d)](_0x40cdc8){const _0x18d780=a573_0x1f3df2,_0x138e84=await Campaign_1['default']['findByPk'](_0x40cdc8,{'include':[{'model':ContactList_1['default'],'as':'contactList','attributes':['id','name'],'include':[{'model':ContactListItem_1[_0x18d780(0x178)],'as':'contacts','attributes':['id',_0x18d780(0x139),_0x18d780(0x156),_0x18d780(0x167),_0x18d780(0x162)],'where':{'isWhatsappValid':!![]}}]},{'model':Whatsapp_1[_0x18d780(0x178)],'as':'whatsapp','attributes':['id',_0x18d780(0x139)]},{'model':CampaignShipping_1[_0x18d780(0x178)],'as':_0x18d780(0x192),'include':[{'model':ContactListItem_1['default'],'as':_0x18d780(0x1c8)}]}]});if(!_0x138e84||!_0x138e84['contactList'])throw new sequelize_1['Error'](_0x18d780(0x17f));return _0x138e84;}async[a573_0x1f3df2(0x148)](_0x35c846){const _0x59539f=a573_0x1f3df2,_0x4403a4=new Date(new Date()[_0x59539f(0x1b1)]()+0x3c*0x3c*0x3e8);let _0x94dacb=await Campaign_1[_0x59539f(0x178)]['findAll']({'where':{'scheduledAt':{[sequelize_1['Op'][_0x59539f(0x1ce)]]:+_0x4403a4},'status':_0x59539f(0x15c)},'attributes':['id',_0x59539f(0x15a)]});if(_0x94dacb['length']>0x0)logger_1[_0x59539f(0x160)][_0x59539f(0x18a)](_0x59539f(0x1a3)+_0x94dacb[_0x59539f(0x16e)]);for(let _0x9fb118 of _0x94dacb){try{const _0x4b86af=(0x0,moment_1[_0x59539f(0x178)])(),_0x1e9265=(0x0,moment_1[_0x59539f(0x178)])(_0x9fb118['scheduledAt']),_0x3cbe0e=_0x1e9265[_0x59539f(0x181)](_0x4b86af,'milliseconds');logger_1[_0x59539f(0x160)][_0x59539f(0x18a)](_0x59539f(0x1c5)+_0x9fb118['id']+_0x59539f(0x182)+_0x3cbe0e);const _0x4d26fb=await this['getCampaign'](_0x9fb118['id']);if(!_0x4d26fb[_0x59539f(0x1b6)]||!_0x4d26fb[_0x59539f(0x1b6)][_0x59539f(0x186)])throw new sequelize_1[(_0x59539f(0x198))](_0x59539f(0x1a5));await queues_1[_0x59539f(0x1b7)][_0x59539f(0x16f)](_0x59539f(0x145),{'id':_0x9fb118['id'],'delay':_0x3cbe0e},{'delay':_0x3cbe0e,'removeOnComplete':!![]});}catch(_0x54c682){return Sentry['captureException'](_0x54c682),Promise['reject'](new sequelize_1[(_0x59539f(0x198))](_0x54c682));}}return Promise['resolve']({'count':_0x94dacb[_0x59539f(0x16e)]});}}function a573_0x24e3(_0x7efae4,_0x4ddc0e){const _0x17cbe3=a573_0xc8c9();return a573_0x24e3=function(_0x7733a9,_0x3c6657){_0x7733a9=_0x7733a9-0x137;let _0xc8c947=_0x17cbe3[_0x7733a9];return _0xc8c947;},a573_0x24e3(_0x7efae4,_0x4ddc0e);}exports['default']=CampaingJob;function a573_0xc8c9(){const _0xcde227=['{email}','parse','__importDefault','value','getTime','configurable','../utils/logger','apply','emit','contactList','campaignQueue','fileListId','handlePrepareContact','__setModuleDefault','20iVgeSb','sequelize','findByPk','options','message3','campaignId','handleDispatchCampaign','defineProperty','moment/moment','update','Campanha\x20enviada\x20para\x20a\x20fila\x20de\x20processamento:\x20Campanha=','push','message4','contact','{numero}','(((.+)+)+)+$','resolve','../models/Whatsapp','Worker','lte','min','7XkfRbD','variables','../..','replace','__importStar','../helpers/GetWhatsappWbot','name','isEmpty','fileList','DispatchCampaign','verifyAndFinalizeCampaign','isNil','getProcessedMessage','search','whatsapp','writable','hasOwnProperty','includes','ProcessCampaign','788056xtbtlW','4412952gQdpCU','handleVerifyCampaigns',';Contato=','getOwnPropertyDescriptor','getCampaignValidMessages','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20not\x20found','toString','companyId','485020VyahEd','public','__createBinding','set','campaignQueue\x20->\x20PrepareContact\x20->\x20error:\x20','handleProcessCampaign','calculateDelay','number','../models/ContactList','message1','39013EsLHYF','scheduledAt','FINALIZADA','PROGRAMADA','getCampaign','-campaign','6mWTPgR','logger','contactId','isWhatsappValid','greaterInterval','trimStart','path','date-fns','email','trimEnd','{nome}','sendMessage','random','getMessageOptions','1117845zcXkLX','length','add','keys','call','user','../models/CampaignSetting','findAll','getIO','forEach','company-','default','lodash','key','@sentry/node','EM_ANDAMENTO','data','randomValue','Campaign\x20or\x20ContactList\x20not\x20found',')\x20completed','diff',',\x20Delay\x20Inicial=','campaign.contactList\x20is\x20null\x20or\x20undefined','../libs/socket','differenceInSeconds','contacts','all','captureException','not','info','company','-mainchannel','deliveredAt','11jarJlm','Disparo\x20de\x20campanha\x20solicitado:\x20Campanha=','message2','getSettings','shipping','longerIntervalAfter','get','constructor',';Registro=','failed','Error','completed','message','VerifyCampaigns','messageInterval','map','160221RTWpdw','../models/ContactListItem','Job\x20','message5','error','Campanhas\x20encontradas:\x20','create','ContactList\x20not\x20found\x20or\x20empty','bullmq','join','951138tzRouw','Error\x20sending\x20campaign\x20media:\x20','6AMvYIS','__esModule','calculateOptimizedDelay'];a573_0xc8c9=function(){return _0xcde227;};return a573_0xc8c9();}