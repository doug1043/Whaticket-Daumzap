const a572_0x24060f=a572_0x5318;(function(_0x276b1f,_0x341430){const _0x58f382=a572_0x5318,_0xcbd955=_0x276b1f();while(!![]){try{const _0x1bb8ce=-parseInt(_0x58f382(0xa5))/0x1*(parseInt(_0x58f382(0xac))/0x2)+-parseInt(_0x58f382(0xd9))/0x3*(-parseInt(_0x58f382(0x10f))/0x4)+parseInt(_0x58f382(0xdb))/0x5*(-parseInt(_0x58f382(0x12b))/0x6)+-parseInt(_0x58f382(0xb6))/0x7*(-parseInt(_0x58f382(0x123))/0x8)+parseInt(_0x58f382(0xc8))/0x9*(parseInt(_0x58f382(0xc5))/0xa)+parseInt(_0x58f382(0x98))/0xb*(-parseInt(_0x58f382(0x114))/0xc)+parseInt(_0x58f382(0xf9))/0xd;if(_0x1bb8ce===_0x341430)break;else _0xcbd955['push'](_0xcbd955['shift']());}catch(_0x4bedf4){_0xcbd955['push'](_0xcbd955['shift']());}}}(a572_0x13b9,0x841d8));const a572_0x145b8f=(function(){let _0xd3a24=!![];return function(_0x1d24a8,_0x46b71e){const _0x15051e=_0xd3a24?function(){const _0x32838e=a572_0x5318;if(_0x46b71e){const _0x4fb7cb=_0x46b71e[_0x32838e(0xa3)](_0x1d24a8,arguments);return _0x46b71e=null,_0x4fb7cb;}}:function(){};return _0xd3a24=![],_0x15051e;};}()),a572_0xda676a=a572_0x145b8f(this,function(){const _0x51fc20=a572_0x5318;return a572_0xda676a[_0x51fc20(0xab)]()[_0x51fc20(0x13a)](_0x51fc20(0xef))[_0x51fc20(0xab)]()[_0x51fc20(0xd2)](a572_0xda676a)[_0x51fc20(0x13a)](_0x51fc20(0xef));});a572_0xda676a();'use strict';var __createBinding=this&&this[a572_0x24060f(0x107)]||(Object['create']?function(_0x38d906,_0x37451a,_0x56e2f7,_0x32a485){const _0x6044da=a572_0x24060f;if(_0x32a485===undefined)_0x32a485=_0x56e2f7;var _0x2a5383=Object[_0x6044da(0xb8)](_0x37451a,_0x56e2f7);(!_0x2a5383||(_0x6044da(0xdf)in _0x2a5383?!_0x37451a[_0x6044da(0x128)]:_0x2a5383[_0x6044da(0xe2)]||_0x2a5383['configurable']))&&(_0x2a5383={'enumerable':!![],'get':function(){return _0x37451a[_0x56e2f7];}}),Object[_0x6044da(0x10b)](_0x38d906,_0x32a485,_0x2a5383);}:function(_0x3f8c08,_0x5d87fd,_0x4650ec,_0x35f4d0){if(_0x35f4d0===undefined)_0x35f4d0=_0x4650ec;_0x3f8c08[_0x35f4d0]=_0x5d87fd[_0x4650ec];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a572_0x24060f(0xe3)]?function(_0x44b15e,_0x269976){const _0x3e279c=a572_0x24060f;Object[_0x3e279c(0x10b)](_0x44b15e,_0x3e279c(0xd4),{'enumerable':!![],'value':_0x269976});}:function(_0x1f3487,_0x317e05){const _0x339a2e=a572_0x24060f;_0x1f3487[_0x339a2e(0xd4)]=_0x317e05;}),__importStar=this&&this[a572_0x24060f(0x13d)]||function(_0xfd178f){const _0x537013=a572_0x24060f;if(_0xfd178f&&_0xfd178f[_0x537013(0x128)])return _0xfd178f;var _0x3ee219={};if(_0xfd178f!=null){for(var _0x52cbec in _0xfd178f)if(_0x52cbec!=='default'&&Object[_0x537013(0xbc)][_0x537013(0x127)][_0x537013(0xae)](_0xfd178f,_0x52cbec))__createBinding(_0x3ee219,_0xfd178f,_0x52cbec);}return __setModuleDefault(_0x3ee219,_0xfd178f),_0x3ee219;},__importDefault=this&&this[a572_0x24060f(0x9b)]||function(_0x561908){const _0x2ac2f5=a572_0x24060f;return _0x561908&&_0x561908[_0x2ac2f5(0x128)]?_0x561908:{'default':_0x561908};};Object['defineProperty'](exports,a572_0x24060f(0x128),{'value':!![]});const bullmq_1=require('bullmq'),Campaign_1=__importDefault(require(a572_0x24060f(0xf4))),sequelize_1=require(a572_0x24060f(0xf7)),logger_1=require(a572_0x24060f(0xb3)),moment_1=__importDefault(require(a572_0x24060f(0xf0))),Sentry=__importStar(require('@sentry/node')),ContactList_1=__importDefault(require(a572_0x24060f(0x125))),ContactListItem_1=__importDefault(require(a572_0x24060f(0xaf))),Whatsapp_1=__importDefault(require(a572_0x24060f(0xad))),CampaignShipping_1=__importDefault(require(a572_0x24060f(0x97))),queues_1=require(a572_0x24060f(0xe1)),lodash_1=require(a572_0x24060f(0xa9)),date_fns_1=require(a572_0x24060f(0xc0)),GetWhatsappWbot_1=__importDefault(require(a572_0x24060f(0x131))),path_1=__importDefault(require(a572_0x24060f(0xf5))),ShowService_1=__importDefault(require(a572_0x24060f(0xdd))),SendWhatsAppMedia_1=require(a572_0x24060f(0x9f)),socket_1=require('../libs/socket'),CampaignSetting_1=__importDefault(require(a572_0x24060f(0x10d))),SendPresenceStatus_1=require(a572_0x24060f(0x121));class CampaingJob{constructor(_0x5e6255,_0x15ea6a){const _0x5ecb9d=a572_0x24060f,_0x2df9a9=new bullmq_1[(_0x5ecb9d(0xb0))](_0x5e6255,async _0x5cc0c6=>{const _0x2f8a16=_0x5ecb9d;if(_0x5cc0c6[_0x2f8a16(0x10c)]==='VerifyCampaigns')await this[_0x2f8a16(0xc7)](_0x5cc0c6);else{if(_0x5cc0c6[_0x2f8a16(0x10c)]==='ProcessCampaign')await this[_0x2f8a16(0x9c)](_0x5cc0c6);else{if(_0x5cc0c6[_0x2f8a16(0x10c)]===_0x2f8a16(0xc9))await this['handlePrepareContact'](_0x5cc0c6);else _0x5cc0c6[_0x2f8a16(0x10c)]==='DispatchCampaign'&&await this[_0x2f8a16(0x124)](_0x5cc0c6);}}},{'useWorkerThreads':![],'concurrency':0x64,'connection':_0x15ea6a,'removeOnFail':{'count':0x0}});_0x2df9a9['on'](_0x5ecb9d(0x10e),async _0x2d3522=>{const _0x504fc4=_0x5ecb9d;logger_1['logger'][_0x504fc4(0xcb)](_0x504fc4(0xcd)+_0x2d3522[_0x504fc4(0x10c)]+'\x20('+_0x2d3522['id']+_0x504fc4(0xf2));}),_0x2df9a9['on'](_0x5ecb9d(0x122),async(_0x51da4f,_0x1e5e51)=>{const _0x4dffbd=_0x5ecb9d;logger_1[_0x4dffbd(0xde)][_0x4dffbd(0x140)](_0x4dffbd(0xcd)+_0x51da4f[_0x4dffbd(0x10c)]+_0x4dffbd(0x12d)+_0x1e5e51[_0x4dffbd(0xda)]);});}async['getContact'](_0x26b256){const _0x4cc9a2=a572_0x24060f;return ContactListItem_1[_0x4cc9a2(0xd4)]['findByPk'](_0x26b256,{'attributes':['id','name','number',_0x4cc9a2(0x11b)]});}async['handlePrepareContact'](_0x56df4a){const _0x3579ad=a572_0x24060f;try{const {contactId:_0x1f8e55,campaignId:_0x283e87,delay:_0x3e8f1f,variables:_0x5e5531}=_0x56df4a[_0x3579ad(0x108)],_0x44826c=await this['getCampaign'](_0x283e87),_0x5c7ce2=await this[_0x3579ad(0xff)](_0x1f8e55),_0x3891bd={};_0x3891bd[_0x3579ad(0x9d)]=_0x5c7ce2[_0x3579ad(0x9d)],_0x3891bd['contactId']=_0x1f8e55,_0x3891bd[_0x3579ad(0xf3)]=_0x283e87;const _0x596139=this['getCampaignValidMessages'](_0x44826c);if(_0x596139[_0x3579ad(0xa0)]){const _0x1ecfe6=(0x0,queues_1[_0x3579ad(0x11d)])(0x0,_0x596139[_0x3579ad(0xa0)]),_0x379ad0=this['getProcessedMessage'](_0x596139[_0x1ecfe6],_0x5e5531,_0x5c7ce2);_0x3891bd[_0x3579ad(0xda)]='‌\x20'+_0x379ad0;}if(_0x44826c[_0x3579ad(0x110)]){const _0x2c0de5=this['getCampaignValidConfirmationMessages'](_0x44826c);if(_0x2c0de5['length']){const _0x397ef6=(0x0,queues_1[_0x3579ad(0x11d)])(0x0,_0x2c0de5[_0x3579ad(0xa0)]),_0x12647b=this[_0x3579ad(0x12c)](_0x2c0de5[_0x397ef6],_0x5e5531,_0x5c7ce2);_0x3891bd[_0x3579ad(0x11e)]='‌\x20'+_0x12647b;}}const [_0x56981c,_0x3aa246]=await CampaignShipping_1['default'][_0x3579ad(0x139)]({'where':{'campaignId':_0x3891bd[_0x3579ad(0xf3)],'contactId':_0x3891bd[_0x3579ad(0x13f)]},'defaults':_0x3891bd});!_0x3aa246&&_0x56981c[_0x3579ad(0x11f)]===null&&_0x56981c['confirmationRequestedAt']===null&&(_0x56981c[_0x3579ad(0x120)](_0x3891bd),await _0x56981c[_0x3579ad(0xa4)]());if(_0x56981c['deliveredAt']===null&&_0x56981c[_0x3579ad(0xd5)]===null){const _0x596b9b=await queues_1['campaignQueue'][_0x3579ad(0x105)](_0x3579ad(0xc6),{'campaignId':_0x44826c['id'],'campaignShippingId':_0x56981c['id'],'contactListItemId':_0x1f8e55},{'removeOnComplete':!![],'delay':_0x3e8f1f});await _0x56981c['update']({'jobId':_0x596b9b['id']});}await this[_0x3579ad(0xa2)](_0x44826c);}catch(_0x3d10a4){Sentry[_0x3579ad(0xd0)](_0x3d10a4),logger_1['logger'][_0x3579ad(0x140)]('campaignQueue\x20->\x20PrepareContact\x20->\x20error:\x20'+_0x3d10a4[_0x3579ad(0xda)]);}}async[a572_0x24060f(0xa2)](_0x18641e){const _0x20c9b1=a572_0x24060f;if(!_0x18641e['contactList'])throw new sequelize_1['Error']('campaign.contactList\x20is\x20null\x20or\x20undefined');const {contacts:_0x38bb56}=_0x18641e[_0x20c9b1(0x113)],_0x5f4dda=_0x38bb56[_0x20c9b1(0xa0)],_0x13285f=await CampaignShipping_1['default']['count']({'where':{'campaignId':_0x18641e['id'],'deliveredAt':{[sequelize_1['Op'][_0x20c9b1(0x104)]]:null}}});_0x5f4dda===_0x13285f&&await _0x18641e[_0x20c9b1(0x115)]({'status':_0x20c9b1(0x102),'completedAt':(0x0,moment_1[_0x20c9b1(0xd4)])()});const _0x4704ee=(0x0,socket_1['getIO'])();_0x4704ee['to'](_0x20c9b1(0xa6)+_0x18641e[_0x20c9b1(0x103)]+_0x20c9b1(0xd3))['emit']('company-'+_0x18641e[_0x20c9b1(0x103)]+'-campaign',{'action':_0x20c9b1(0x115),'record':_0x18641e});}[a572_0x24060f(0xf6)](_0x1d5a3e,_0x158036,_0x21c23d,_0x4a6174,_0x25cf8d){const _0x3dc482=a572_0x24060f,_0x4c3eae=(0x0,date_fns_1[_0x3dc482(0xcc)])(_0x158036,new Date());return _0x1d5a3e>_0x21c23d?_0x4c3eae*0x3e8+_0x4a6174:_0x4c3eae*0x3e8+_0x25cf8d;}[a572_0x24060f(0xeb)](_0x14805f){const _0x4f7d5c=a572_0x24060f,_0x2a176b=[];return!(0x0,lodash_1['isEmpty'])(_0x14805f[_0x4f7d5c(0x12f)])&&!(0x0,lodash_1[_0x4f7d5c(0xbf)])(_0x14805f['confirmationMessage1'])&&_0x2a176b['push'](_0x14805f[_0x4f7d5c(0x12f)]),!(0x0,lodash_1[_0x4f7d5c(0x111)])(_0x14805f[_0x4f7d5c(0xe8)])&&!(0x0,lodash_1[_0x4f7d5c(0xbf)])(_0x14805f[_0x4f7d5c(0xe8)])&&_0x2a176b[_0x4f7d5c(0xfe)](_0x14805f[_0x4f7d5c(0xe8)]),!(0x0,lodash_1['isEmpty'])(_0x14805f[_0x4f7d5c(0x132)])&&!(0x0,lodash_1['isNil'])(_0x14805f[_0x4f7d5c(0x132)])&&_0x2a176b[_0x4f7d5c(0xfe)](_0x14805f['confirmationMessage3']),!(0x0,lodash_1[_0x4f7d5c(0x111)])(_0x14805f[_0x4f7d5c(0x106)])&&!(0x0,lodash_1[_0x4f7d5c(0xbf)])(_0x14805f[_0x4f7d5c(0x106)])&&_0x2a176b[_0x4f7d5c(0xfe)](_0x14805f[_0x4f7d5c(0x106)]),!(0x0,lodash_1[_0x4f7d5c(0x111)])(_0x14805f[_0x4f7d5c(0x11c)])&&!(0x0,lodash_1[_0x4f7d5c(0xbf)])(_0x14805f[_0x4f7d5c(0x11c)])&&_0x2a176b['push'](_0x14805f[_0x4f7d5c(0x11c)]),_0x2a176b;}async[a572_0x24060f(0x124)](_0x223255){const _0x10625c=a572_0x24060f;try{const {data:_0x332e86}=_0x223255,{campaignShippingId:_0x41aa4e,campaignId:_0x21252f}=_0x332e86,_0x7752d9=await this['getCampaign'](_0x21252f),_0xf4827b=await(0x0,GetWhatsappWbot_1['default'])(_0x7752d9[_0x10625c(0x10a)]);if(!_0xf4827b){logger_1[_0x10625c(0xde)][_0x10625c(0x140)](_0x10625c(0xe0));return;}if(!_0x7752d9[_0x10625c(0x10a)]){logger_1['logger'][_0x10625c(0x140)]('campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20whatsapp\x20not\x20found');return;}if(!_0xf4827b?.['user']?.['id']){logger_1[_0x10625c(0xde)][_0x10625c(0x140)](_0x10625c(0xd8));return;}logger_1[_0x10625c(0xde)][_0x10625c(0xcb)](_0x10625c(0xaa)+_0x21252f+';Registro='+_0x41aa4e);const _0x2cea3b=await CampaignShipping_1[_0x10625c(0xd4)][_0x10625c(0x12a)](_0x41aa4e,{'include':[{'model':ContactListItem_1[_0x10625c(0xd4)],'as':'contact'}]}),_0x2c4955=_0x2cea3b[_0x10625c(0x9d)]+_0x10625c(0x126);let _0x1a246a=_0x2cea3b['message'][_0x10625c(0x13b)]()['trimStart']();_0x7752d9['confirmation']&&_0x2cea3b[_0x10625c(0x110)]===null&&(_0x1a246a=_0x2cea3b['confirmationMessage']);await(0x0,SendPresenceStatus_1[_0x10625c(0x13c)])(_0xf4827b,_0x2c4955);if(!(0x0,lodash_1['isNil'])(_0x7752d9[_0x10625c(0xf8)]))try{const _0xcb147b=path_1[_0x10625c(0xd4)][_0x10625c(0x138)](__dirname,_0x10625c(0x9a),'public','company'+_0x7752d9['companyId']),_0x4256db=await(0x0,ShowService_1['default'])(_0x7752d9[_0x10625c(0xf8)],_0x7752d9[_0x10625c(0x103)]),_0x468d82=path_1[_0x10625c(0xd4)]['resolve'](_0xcb147b,_0x10625c(0xec),String(_0x4256db['id']));for(const [_0x8b6fb8,_0x73d5c5]of _0x4256db['options'][_0x10625c(0xe6)]()){const _0x358ffe=await(0x0,SendWhatsAppMedia_1[_0x10625c(0x130)])(_0x73d5c5[_0x10625c(0xf5)],path_1['default'][_0x10625c(0x138)](_0x468d82,_0x73d5c5['path']),_0x73d5c5[_0x10625c(0x10c)],_0x7752d9['companyId']);await _0xf4827b[_0x10625c(0xcf)](_0x2c4955,{..._0x358ffe});}}catch(_0x6129c5){logger_1[_0x10625c(0xde)][_0x10625c(0xcb)](_0x6129c5);}if(_0x7752d9[_0x10625c(0xf1)]){const _0x38d3ea=path_1['default'][_0x10625c(0x138)](__dirname,_0x10625c(0x9a),_0x10625c(0xb5),_0x10625c(0x117)+_0x7752d9['companyId']),_0x3ea49b=path_1[_0x10625c(0xd4)][_0x10625c(0x119)](_0x38d3ea,_0x7752d9[_0x10625c(0xf1)]),_0x41eecd=await(0x0,SendWhatsAppMedia_1[_0x10625c(0x130)])(_0x7752d9['mediaName'],_0x3ea49b,_0x1a246a,_0x7752d9[_0x10625c(0x103)]);Object[_0x10625c(0xfd)](_0x41eecd)[_0x10625c(0xa0)]&&await _0xf4827b[_0x10625c(0xcf)](_0x2c4955,{..._0x41eecd});}else _0x7752d9[_0x10625c(0x110)]&&_0x2cea3b[_0x10625c(0x110)]===null?(await _0xf4827b[_0x10625c(0xcf)](_0x2c4955,{'text':_0x1a246a}),await _0x2cea3b[_0x10625c(0x115)]({'confirmationRequestedAt':(0x0,moment_1[_0x10625c(0xd4)])()})):await _0xf4827b[_0x10625c(0xcf)](_0x2c4955,{'text':_0x1a246a});await _0x2cea3b['update']({'deliveredAt':(0x0,moment_1['default'])()}),await this[_0x10625c(0xa2)](_0x7752d9);const _0x1da3d4=(0x0,socket_1[_0x10625c(0xca)])();_0x1da3d4['to'](_0x10625c(0xa6)+_0x7752d9[_0x10625c(0x103)]+_0x10625c(0xd3))[_0x10625c(0x109)](_0x10625c(0xa6)+_0x7752d9[_0x10625c(0x103)]+_0x10625c(0xea),{'action':_0x10625c(0x115),'record':_0x7752d9}),logger_1[_0x10625c(0xde)][_0x10625c(0xcb)](_0x10625c(0xbe)+_0x21252f+_0x10625c(0x135)+_0x2cea3b[_0x10625c(0xb9)][_0x10625c(0x10c)]);}catch(_0x3797f0){Sentry[_0x10625c(0xd0)](_0x3797f0),logger_1['logger'][_0x10625c(0x140)](_0x3797f0[_0x10625c(0xda)]);}}[a572_0x24060f(0xc2)](_0x2ec953){const _0x313fca=a572_0x24060f,_0x5a0b1f=[];return!(0x0,lodash_1[_0x313fca(0x111)])(_0x2ec953[_0x313fca(0xed)])&&!(0x0,lodash_1[_0x313fca(0xbf)])(_0x2ec953[_0x313fca(0xed)])&&_0x5a0b1f['push'](_0x2ec953[_0x313fca(0xed)]),!(0x0,lodash_1[_0x313fca(0x111)])(_0x2ec953[_0x313fca(0x129)])&&!(0x0,lodash_1[_0x313fca(0xbf)])(_0x2ec953[_0x313fca(0x129)])&&_0x5a0b1f[_0x313fca(0xfe)](_0x2ec953[_0x313fca(0x129)]),!(0x0,lodash_1[_0x313fca(0x111)])(_0x2ec953[_0x313fca(0x100)])&&!(0x0,lodash_1[_0x313fca(0xbf)])(_0x2ec953[_0x313fca(0x100)])&&_0x5a0b1f['push'](_0x2ec953[_0x313fca(0x100)]),!(0x0,lodash_1[_0x313fca(0x111)])(_0x2ec953[_0x313fca(0xb2)])&&!(0x0,lodash_1[_0x313fca(0xbf)])(_0x2ec953['message4'])&&_0x5a0b1f['push'](_0x2ec953[_0x313fca(0xb2)]),!(0x0,lodash_1[_0x313fca(0x111)])(_0x2ec953[_0x313fca(0xb4)])&&!(0x0,lodash_1[_0x313fca(0xbf)])(_0x2ec953[_0x313fca(0xb4)])&&_0x5a0b1f[_0x313fca(0xfe)](_0x2ec953['message5']),_0x5a0b1f;}[a572_0x24060f(0x12c)](_0x1bd0d9,_0x22e04b,_0x5a6cb3){const _0x31a35a=a572_0x24060f;let _0x312d45=_0x1bd0d9;return _0x312d45['includes'](_0x31a35a(0xfa))&&(_0x312d45=_0x312d45[_0x31a35a(0x9e)](/{nome}/g,_0x5a6cb3[_0x31a35a(0x10c)])),_0x312d45[_0x31a35a(0xba)](_0x31a35a(0xe5))&&(_0x312d45=_0x312d45['replace'](/{email}/g,_0x5a6cb3[_0x31a35a(0x11b)])),_0x312d45['includes'](_0x31a35a(0xce))&&(_0x312d45=_0x312d45[_0x31a35a(0x9e)](/{numero}/g,_0x5a6cb3['number'])),_0x22e04b[_0x31a35a(0xd7)](_0x1ee4e8=>{const _0x54c957=_0x31a35a;if(_0x312d45[_0x54c957(0xba)]('{'+_0x1ee4e8[_0x54c957(0xe9)]+'}')){const _0x2ab76c=new RegExp('{'+_0x1ee4e8[_0x54c957(0xe9)]+'}','g');_0x312d45=_0x312d45[_0x54c957(0x9e)](_0x2ab76c,_0x1ee4e8[_0x54c957(0xa1)]);}}),_0x312d45;}async[a572_0x24060f(0xd1)](_0x343788){const _0x207782=a572_0x24060f,_0x4e9152=await CampaignSetting_1['default']['findAll']({'where':{'companyId':_0x343788[_0x207782(0x103)]},'attributes':[_0x207782(0xe9),_0x207782(0xa1)]});let _0x2a7f6c=0x14,_0x5db6d4=0x14,_0x2090d2=0x3c,_0x59abdb=[];return _0x4e9152[_0x207782(0xd7)](_0x3866cf=>{const _0x210277=_0x207782;_0x3866cf[_0x210277(0xe9)]==='messageInterval'&&(_0x2a7f6c=JSON[_0x210277(0xe4)](_0x3866cf['value'])),_0x3866cf[_0x210277(0xe9)]===_0x210277(0x11a)&&(_0x5db6d4=JSON[_0x210277(0xe4)](_0x3866cf['value'])),_0x3866cf['key']===_0x210277(0x112)&&(_0x2090d2=JSON[_0x210277(0xe4)](_0x3866cf[_0x210277(0xa1)])),_0x3866cf[_0x210277(0xe9)]===_0x210277(0x118)&&(_0x59abdb=JSON[_0x210277(0xe4)](_0x3866cf[_0x210277(0xa1)]));}),{'messageInterval':_0x2a7f6c,'longerIntervalAfter':_0x5db6d4,'greaterInterval':_0x2090d2,'variables':_0x59abdb};}async['handleProcessCampaign'](_0x5d41cb){const _0x5addee=a572_0x24060f;try{const {id:_0x244316}=_0x5d41cb['data'],_0x463484=await this[_0x5addee(0x12e)](_0x244316),_0x1bafea=await this['getSettings'](_0x463484);if(!_0x463484)throw new sequelize_1['Error'](_0x5addee(0x134));if(!_0x463484[_0x5addee(0x113)]||!_0x463484[_0x5addee(0x113)][_0x5addee(0xdc)])throw new sequelize_1['Error'](_0x5addee(0x137));if(_0x463484){const {contacts:_0x59b3f3}=_0x463484[_0x5addee(0x113)];if((0x0,lodash_1[_0x5addee(0xb7)])(_0x59b3f3)){const _0x45340c=_0x59b3f3['map'](_0x17bb0c=>({'contactId':_0x17bb0c['id'],'campaignId':_0x463484['id'],'variables':_0x1bafea[_0x5addee(0x118)]})),_0x50d74a=(0x0,queues_1['parseToMilliseconds'])(_0x1bafea[_0x5addee(0x11a)]),_0x4bdf4a=(0x0,queues_1[_0x5addee(0xa8)])(_0x1bafea[_0x5addee(0x112)]),_0x20b71e=_0x1bafea[_0x5addee(0xc1)];let _0x2bb332=_0x463484[_0x5addee(0x13e)];const _0x13bfb2=[];for(let _0x595d0a=0x0;_0x595d0a<_0x45340c[_0x5addee(0xa0)];_0x595d0a++){_0x2bb332=(0x0,date_fns_1[_0x5addee(0x116)])(_0x2bb332,_0x595d0a>_0x50d74a?_0x4bdf4a:_0x20b71e);const {contactId:_0x42c6c8,campaignId:_0x3f2857,variables:_0x14dfe6}=_0x45340c[_0x595d0a],_0x274f04=this['calculateDelay'](_0x595d0a,_0x2bb332,_0x50d74a,_0x4bdf4a,_0x20b71e),_0x13d0e9=queues_1[_0x5addee(0x136)][_0x5addee(0x105)](_0x5addee(0xc9),{'contactId':_0x42c6c8,'campaignId':_0x3f2857,'variables':_0x14dfe6,'delay':_0x274f04+(0x0,queues_1[_0x5addee(0x11d)])(0x64,0x5dc)},{'removeOnComplete':!![]});_0x13bfb2[_0x5addee(0xfe)](_0x13d0e9),logger_1['logger'][_0x5addee(0xcb)](_0x5addee(0xfc)+_0x463484['id']+_0x5addee(0x135)+_0x59b3f3[_0x595d0a]['name']+_0x5addee(0xe7)+_0x274f04);}await Promise['all'](_0x13bfb2),await _0x463484[_0x5addee(0x115)]({'status':'EM_ANDAMENTO'});}}}catch(_0x55a936){logger_1[_0x5addee(0xde)]['error'](_0x55a936),Sentry[_0x5addee(0xd0)](_0x55a936);}}async[a572_0x24060f(0x12e)](_0x134aeb){const _0x3ee4c7=a572_0x24060f,_0x4027b5=await Campaign_1[_0x3ee4c7(0xd4)][_0x3ee4c7(0x12a)](_0x134aeb,{'include':[{'model':ContactList_1[_0x3ee4c7(0xd4)],'as':'contactList','attributes':['id',_0x3ee4c7(0x10c)],'include':[{'model':ContactListItem_1[_0x3ee4c7(0xd4)],'as':_0x3ee4c7(0xdc),'attributes':['id',_0x3ee4c7(0x10c),_0x3ee4c7(0x9d),_0x3ee4c7(0x11b),'isWhatsappValid'],'where':{'isWhatsappValid':!![]}}]},{'model':Whatsapp_1['default'],'as':'whatsapp','attributes':['id',_0x3ee4c7(0x10c)]},{'model':CampaignShipping_1[_0x3ee4c7(0xd4)],'as':_0x3ee4c7(0x101),'include':[{'model':ContactListItem_1[_0x3ee4c7(0xd4)],'as':'contact'}]}]});if(!_0x4027b5||!_0x4027b5[_0x3ee4c7(0x113)])throw new sequelize_1[(_0x3ee4c7(0xb1))]('Campaign\x20or\x20ContactList\x20not\x20found');return _0x4027b5;}async[a572_0x24060f(0xc7)](_0x1901f2){const _0x487fd8=a572_0x24060f,_0x1095d6=new Date(new Date()[_0x487fd8(0xbb)]()+0x3c*0x3c*0x3e8);let _0x31c58e=await Campaign_1['default'][_0x487fd8(0x133)]({'where':{'scheduledAt':{[sequelize_1['Op'][_0x487fd8(0xee)]]:+_0x1095d6},'status':_0x487fd8(0xbd)},'attributes':['id',_0x487fd8(0x13e)]});if(_0x31c58e['length']>0x0)logger_1[_0x487fd8(0xde)][_0x487fd8(0xcb)](_0x487fd8(0xc4)+_0x31c58e[_0x487fd8(0xa0)]);for(let _0x536b37 of _0x31c58e){try{const _0x25c180=(0x0,moment_1[_0x487fd8(0xd4)])(),_0x59435f=(0x0,moment_1['default'])(_0x536b37['scheduledAt']),_0x211580=_0x59435f[_0x487fd8(0xfb)](_0x25c180,'milliseconds');logger_1[_0x487fd8(0xde)][_0x487fd8(0xcb)](_0x487fd8(0x99)+_0x536b37['id']+_0x487fd8(0xa7)+_0x211580);const _0x2f5c54=await this['getCampaign'](_0x536b37['id']);if(!_0x2f5c54['contactList']||!_0x2f5c54['contactList']['contacts'])throw new sequelize_1[(_0x487fd8(0xb1))]('ContactList\x20not\x20found\x20or\x20empty');await queues_1[_0x487fd8(0x136)][_0x487fd8(0x105)](_0x487fd8(0xd6),{'id':_0x536b37['id'],'delay':_0x211580},{'delay':_0x211580,'removeOnComplete':!![]});}catch(_0x3cc928){return Sentry['captureException'](_0x3cc928),Promise[_0x487fd8(0xc3)](new sequelize_1[(_0x487fd8(0xb1))](_0x3cc928));}}return Promise[_0x487fd8(0x138)]({'count':_0x31c58e['length']});}}function a572_0x13b9(){const _0x2733a0=['forEach','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20user\x20not\x20found','148464FJvYvR','message','190KXnhUx','contacts','../services/FileServices/ShowService','logger','get','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20not\x20found','../queues','writable','create','parse','{email}','entries',';delay=','confirmationMessage2','key','-campaign','getCampaignValidConfirmationMessages','fileList','message1','lte','(((.+)+)+)+$','moment/moment','mediaPath',')\x20completed','campaignId','../models/Campaign','path','calculateDelay','sequelize','fileListId','1382706tygcSF','{nome}','diff','Registro\x20enviado\x20pra\x20fila\x20de\x20disparo:\x20Campanha=','keys','push','getContact','message3','shipping','FINALIZADA','companyId','not','add','confirmationMessage4','__createBinding','data','emit','whatsapp','defineProperty','name','../models/CampaignSetting','completed','84sVhBnX','confirmation','isEmpty','greaterInterval','contactList','1068tAoehk','update','addSeconds','company','variables','join','longerIntervalAfter','email','confirmationMessage5','randomValue','confirmationMessage','deliveredAt','set','../helpers/SendPresenceStatus','failed','136UVxksC','handleDispatchCampaign','../models/ContactList','@s.whatsapp.net','hasOwnProperty','__esModule','message2','findByPk','79530oAPZzZ','getProcessedMessage','\x20failed\x20with\x20error:\x20','getCampaign','confirmationMessage1','getMessageOptions','../helpers/GetWhatsappWbot','confirmationMessage3','findAll','Campaign\x20not\x20found',';Contato=','campaignQueue','ContactList\x20not\x20found\x20or\x20empty','resolve','findOrCreate','search','trimEnd','SendPresenceStatus','__importStar','scheduledAt','contactId','error','../models/CampaignShipping','38687MAyzQt','Campanha\x20enviada\x20para\x20a\x20fila\x20de\x20processamento:\x20Campanha=','../..','__importDefault','handleProcessCampaign','number','replace','../services/WbotServices/SendWhatsAppMedia','length','value','verifyAndFinalizeCampaign','apply','save','4mjhNiR','company-',',\x20Delay\x20Inicial=','parseToMilliseconds','lodash','Disparo\x20de\x20campanha\x20solicitado:\x20Campanha=','toString','311138kjAWYW','../models/Whatsapp','call','../models/ContactListItem','Worker','Error','message4','../utils/logger','message5','public','79513RvyEhS','isArray','getOwnPropertyDescriptor','contact','includes','getTime','prototype','PROGRAMADA','Campanha\x20enviada\x20para:\x20Campanha=','isNil','date-fns','messageInterval','getCampaignValidMessages','reject','Campanhas\x20encontradas:\x20','116620SMxYYJ','DispatchCampaign','handleVerifyCampaigns','495OaHFmt','PrepareContact','getIO','info','differenceInSeconds','Job\x20','{numero}','sendMessage','captureException','getSettings','constructor','-mainchannel','default','confirmationRequestedAt','ProcessCampaign'];a572_0x13b9=function(){return _0x2733a0;};return a572_0x13b9();}function a572_0x5318(_0x178528,_0x11b9d1){const _0x27b422=a572_0x13b9();return a572_0x5318=function(_0xda676a,_0x145b8f){_0xda676a=_0xda676a-0x97;let _0x13b9c3=_0x27b422[_0xda676a];return _0x13b9c3;},a572_0x5318(_0x178528,_0x11b9d1);}exports['default']=CampaingJob;