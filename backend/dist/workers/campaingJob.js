const a572_0x507d2d=a572_0x4bb1;(function(_0xb91f65,_0xef83df){const _0x3452b3=a572_0x4bb1,_0x2ff12b=_0xb91f65();while(!![]){try{const _0x351a1c=parseInt(_0x3452b3(0x120))/0x1*(parseInt(_0x3452b3(0x119))/0x2)+-parseInt(_0x3452b3(0x184))/0x3*(-parseInt(_0x3452b3(0x148))/0x4)+-parseInt(_0x3452b3(0x102))/0x5+parseInt(_0x3452b3(0x123))/0x6+parseInt(_0x3452b3(0x113))/0x7*(parseInt(_0x3452b3(0x103))/0x8)+-parseInt(_0x3452b3(0x1a3))/0x9+parseInt(_0x3452b3(0x15d))/0xa*(-parseInt(_0x3452b3(0x15b))/0xb);if(_0x351a1c===_0xef83df)break;else _0x2ff12b['push'](_0x2ff12b['shift']());}catch(_0x3e8de4){_0x2ff12b['push'](_0x2ff12b['shift']());}}}(a572_0x1c9a,0xe82ea));function a572_0x1c9a(){const _0x1b8a9d=['confirmationMessage1','isNil','../services/FileServices/ShowService','apply','lodash','shipping','getIO','DispatchCampaign','hasOwnProperty','../libs/socket','addSeconds','EM_ANDAMENTO','create','greaterInterval','push','campaign.contactList\x20is\x20null\x20or\x20undefined','confirmationMessage3','keys','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20user\x20not\x20found','options','../helpers/GetWhatsappWbot','company','handlePrepareContact','7751457IfECvU','call','info','SendPresenceStatus','(((.+)+)+)+$','public','ProcessCampaign','contact','failed','FINALIZADA','getCampaignValidMessages','__createBinding','update','Disparo\x20de\x20campanha\x20solicitado:\x20Campanha=','defineProperty','3162005ufarvV','24kiEGPZ','not',';delay=','../models/Campaign','length','user','../models/CampaignSetting','verifyAndFinalizeCampaign','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20not\x20found','__setModuleDefault','Error','isWhatsappValid','forEach','Worker','VerifyCampaigns','Campaign\x20or\x20ContactList\x20not\x20found','2430743EIowfc','key','Registro\x20enviado\x20pra\x20fila\x20de\x20disparo:\x20Campanha=','lte','getCampaign','getProcessedMessage','734UwuCMj','findOrCreate','Campaign\x20not\x20found','error','isArray','__importStar','parseToMilliseconds','4115TKsYLf','includes','PROGRAMADA','7571586aglOsk','logger','campaignQueue\x20->\x20PrepareContact\x20->\x20error:\x20','-campaign','@s.whatsapp.net','constructor','data','calculateDelay','trimEnd','contacts','mediaName','count','../..','-mainchannel','message1','contactList','parse','moment/moment','message3','deliveredAt','default','contactId','confirmationMessage','save','../helpers/SendPresenceStatus','__importDefault',';Registro=','fileList','findByPk','path','longerIntervalAfter','../models/CampaignShipping','date-fns','messageInterval','trimStart','configurable','Campanhas\x20encontradas:\x20','8fcZJKP','confirmationMessage4','companyId','join','handleProcessCampaign','Job\x20','handleDispatchCampaign','confirmation','confirmationMessage2','{nome}','completed','getCampaignValidConfirmationMessages','set','all','search','get','whatsapp','message','captureException','58025CobLMZ','toString','2830ihIvNR',',\x20Delay\x20Inicial=','getContact','confirmationMessage5','getSettings','isEmpty','add','entries','message2','campaignId','../services/WbotServices/SendWhatsAppMedia','resolve','message5','getTime','number','campaignQueue','randomValue','getOwnPropertyDescriptor','sendMessage','company-','fileListId','../models/Whatsapp','emit','ContactList\x20not\x20found\x20or\x20empty','email','reject','scheduledAt','__esModule','getMessageOptions','{numero}','@sentry/node','differenceInSeconds','Campanha\x20enviada\x20para\x20a\x20fila\x20de\x20processamento:\x20Campanha=',')\x20completed','map','mediaPath','findAll',';Contato=','replace','185451cwOFXZ','confirmationRequestedAt','Campanha\x20enviada\x20para:\x20Campanha=','variables','value','PrepareContact','name','milliseconds'];a572_0x1c9a=function(){return _0x1b8a9d;};return a572_0x1c9a();}const a572_0x149c09=(function(){let _0x2ce750=!![];return function(_0x2d8cd1,_0x2166b2){const _0xfc5100=_0x2ce750?function(){const _0x244001=a572_0x4bb1;if(_0x2166b2){const _0x390144=_0x2166b2[_0x244001(0x18f)](_0x2d8cd1,arguments);return _0x2166b2=null,_0x390144;}}:function(){};return _0x2ce750=![],_0xfc5100;};}()),a572_0x58c8bc=a572_0x149c09(this,function(){const _0x586ff7=a572_0x4bb1;return a572_0x58c8bc['toString']()[_0x586ff7(0x156)]('(((.+)+)+)+$')[_0x586ff7(0x15c)]()[_0x586ff7(0x128)](a572_0x58c8bc)[_0x586ff7(0x156)](_0x586ff7(0xf7));});a572_0x58c8bc();function a572_0x4bb1(_0x103102,_0xbad56c){const _0x18179b=a572_0x1c9a();return a572_0x4bb1=function(_0x58c8bc,_0x149c09){_0x58c8bc=_0x58c8bc-0xf6;let _0x1c9a78=_0x18179b[_0x58c8bc];return _0x1c9a78;},a572_0x4bb1(_0x103102,_0xbad56c);}'use strict';var __createBinding=this&&this[a572_0x507d2d(0xfe)]||(Object['create']?function(_0x1c50eb,_0x31f3d8,_0x32066c,_0x128653){const _0x3a9dba=a572_0x507d2d;if(_0x128653===undefined)_0x128653=_0x32066c;var _0x381499=Object[_0x3a9dba(0x16e)](_0x31f3d8,_0x32066c);(!_0x381499||(_0x3a9dba(0x157)in _0x381499?!_0x31f3d8[_0x3a9dba(0x178)]:_0x381499['writable']||_0x381499[_0x3a9dba(0x146)]))&&(_0x381499={'enumerable':!![],'get':function(){return _0x31f3d8[_0x32066c];}}),Object[_0x3a9dba(0x101)](_0x1c50eb,_0x128653,_0x381499);}:function(_0x3b7c7a,_0x33def6,_0x4f5ce4,_0x310d45){if(_0x310d45===undefined)_0x310d45=_0x4f5ce4;_0x3b7c7a[_0x310d45]=_0x33def6[_0x4f5ce4];}),__setModuleDefault=this&&this[a572_0x507d2d(0x10c)]||(Object[a572_0x507d2d(0x198)]?function(_0x2f18b2,_0x3a5041){const _0x578f48=a572_0x507d2d;Object[_0x578f48(0x101)](_0x2f18b2,_0x578f48(0x137),{'enumerable':!![],'value':_0x3a5041});}:function(_0x1dea58,_0x1fdec9){const _0x5cfd7c=a572_0x507d2d;_0x1dea58[_0x5cfd7c(0x137)]=_0x1fdec9;}),__importStar=this&&this[a572_0x507d2d(0x11e)]||function(_0x543e69){const _0x548ffc=a572_0x507d2d;if(_0x543e69&&_0x543e69['__esModule'])return _0x543e69;var _0x46d0b2={};if(_0x543e69!=null){for(var _0xaada2a in _0x543e69)if(_0xaada2a!=='default'&&Object['prototype'][_0x548ffc(0x194)][_0x548ffc(0x1a4)](_0x543e69,_0xaada2a))__createBinding(_0x46d0b2,_0x543e69,_0xaada2a);}return __setModuleDefault(_0x46d0b2,_0x543e69),_0x46d0b2;},__importDefault=this&&this[a572_0x507d2d(0x13c)]||function(_0x566eff){return _0x566eff&&_0x566eff['__esModule']?_0x566eff:{'default':_0x566eff};};Object[a572_0x507d2d(0x101)](exports,'__esModule',{'value':!![]});const bullmq_1=require('bullmq'),Campaign_1=__importDefault(require(a572_0x507d2d(0x106))),sequelize_1=require('sequelize'),logger_1=require('../utils/logger'),moment_1=__importDefault(require(a572_0x507d2d(0x134))),Sentry=__importStar(require(a572_0x507d2d(0x17b))),ContactList_1=__importDefault(require('../models/ContactList')),ContactListItem_1=__importDefault(require('../models/ContactListItem')),Whatsapp_1=__importDefault(require(a572_0x507d2d(0x172))),CampaignShipping_1=__importDefault(require(a572_0x507d2d(0x142))),queues_1=require('../queues'),lodash_1=require(a572_0x507d2d(0x190)),date_fns_1=require(a572_0x507d2d(0x143)),GetWhatsappWbot_1=__importDefault(require(a572_0x507d2d(0x1a0))),path_1=__importDefault(require(a572_0x507d2d(0x140))),ShowService_1=__importDefault(require(a572_0x507d2d(0x18e))),SendWhatsAppMedia_1=require(a572_0x507d2d(0x167)),socket_1=require(a572_0x507d2d(0x195)),CampaignSetting_1=__importDefault(require(a572_0x507d2d(0x109))),SendPresenceStatus_1=require(a572_0x507d2d(0x13b));class CampaingJob{constructor(_0x1c0ccc,_0x1c308a){const _0x562a98=a572_0x507d2d,_0x2c57c6=new bullmq_1[(_0x562a98(0x110))](_0x1c0ccc,async _0x2e2418=>{const _0x2e8b0e=_0x562a98;if(_0x2e2418[_0x2e8b0e(0x18a)]===_0x2e8b0e(0x111))await this['handleVerifyCampaigns'](_0x2e2418);else{if(_0x2e2418[_0x2e8b0e(0x18a)]===_0x2e8b0e(0xf9))await this[_0x2e8b0e(0x14c)](_0x2e2418);else{if(_0x2e2418['name']==='PrepareContact')await this[_0x2e8b0e(0x1a2)](_0x2e2418);else _0x2e2418[_0x2e8b0e(0x18a)]===_0x2e8b0e(0x193)&&await this[_0x2e8b0e(0x14e)](_0x2e2418);}}},{'useWorkerThreads':![],'concurrency':0x64,'connection':_0x1c308a,'removeOnFail':{'count':0x0}});_0x2c57c6['on'](_0x562a98(0x152),async _0x401dec=>{const _0x5b08e6=_0x562a98;logger_1[_0x5b08e6(0x124)]['info'](_0x5b08e6(0x14d)+_0x401dec['name']+'\x20('+_0x401dec['id']+_0x5b08e6(0x17e));}),_0x2c57c6['on'](_0x562a98(0xfb),async(_0x2a0ceb,_0x239f36)=>{const _0x20443a=_0x562a98;logger_1[_0x20443a(0x124)][_0x20443a(0x11c)](_0x20443a(0x14d)+_0x2a0ceb[_0x20443a(0x18a)]+'\x20failed\x20with\x20error:\x20'+_0x239f36[_0x20443a(0x159)]);});}async[a572_0x507d2d(0x15f)](_0x5d3fec){const _0x35834c=a572_0x507d2d;return ContactListItem_1['default'][_0x35834c(0x13f)](_0x5d3fec,{'attributes':['id','name',_0x35834c(0x16b),_0x35834c(0x175)]});}async[a572_0x507d2d(0x1a2)](_0xbe8273){const _0x3ba88f=a572_0x507d2d;try{const {contactId:_0xbe4730,campaignId:_0x1e6e83,delay:_0x1dfbc0,variables:_0x3ef47e}=_0xbe8273[_0x3ba88f(0x129)],_0x2a94f0=await this['getCampaign'](_0x1e6e83),_0x3ffd58=await this[_0x3ba88f(0x15f)](_0xbe4730),_0x5244c1={};_0x5244c1[_0x3ba88f(0x16b)]=_0x3ffd58[_0x3ba88f(0x16b)],_0x5244c1['contactId']=_0xbe4730,_0x5244c1[_0x3ba88f(0x166)]=_0x1e6e83;const _0x306403=this[_0x3ba88f(0xfd)](_0x2a94f0);if(_0x306403[_0x3ba88f(0x107)]){const _0x5187b9=(0x0,queues_1[_0x3ba88f(0x16d)])(0x0,_0x306403[_0x3ba88f(0x107)]),_0x201d76=this[_0x3ba88f(0x118)](_0x306403[_0x5187b9],_0x3ef47e,_0x3ffd58);_0x5244c1[_0x3ba88f(0x159)]='‌\x20'+_0x201d76;}if(_0x2a94f0[_0x3ba88f(0x14f)]){const _0x2db8d6=this[_0x3ba88f(0x153)](_0x2a94f0);if(_0x2db8d6[_0x3ba88f(0x107)]){const _0x546cce=(0x0,queues_1['randomValue'])(0x0,_0x2db8d6[_0x3ba88f(0x107)]),_0x30b26a=this['getProcessedMessage'](_0x2db8d6[_0x546cce],_0x3ef47e,_0x3ffd58);_0x5244c1[_0x3ba88f(0x139)]='‌\x20'+_0x30b26a;}}const [_0x4cb58e,_0x4cf2ff]=await CampaignShipping_1[_0x3ba88f(0x137)][_0x3ba88f(0x11a)]({'where':{'campaignId':_0x5244c1[_0x3ba88f(0x166)],'contactId':_0x5244c1[_0x3ba88f(0x138)]},'defaults':_0x5244c1});!_0x4cf2ff&&_0x4cb58e[_0x3ba88f(0x136)]===null&&_0x4cb58e['confirmationRequestedAt']===null&&(_0x4cb58e[_0x3ba88f(0x154)](_0x5244c1),await _0x4cb58e[_0x3ba88f(0x13a)]());if(_0x4cb58e[_0x3ba88f(0x136)]===null&&_0x4cb58e[_0x3ba88f(0x185)]===null){const _0x45d399=await queues_1[_0x3ba88f(0x16c)][_0x3ba88f(0x163)]('DispatchCampaign',{'campaignId':_0x2a94f0['id'],'campaignShippingId':_0x4cb58e['id'],'contactListItemId':_0xbe4730},{'removeOnComplete':!![],'delay':_0x1dfbc0});await _0x4cb58e[_0x3ba88f(0xff)]({'jobId':_0x45d399['id']});}await this['verifyAndFinalizeCampaign'](_0x2a94f0);}catch(_0x48905f){Sentry['captureException'](_0x48905f),logger_1[_0x3ba88f(0x124)][_0x3ba88f(0x11c)](_0x3ba88f(0x125)+_0x48905f[_0x3ba88f(0x159)]);}}async[a572_0x507d2d(0x10a)](_0x1a8380){const _0x38e6e1=a572_0x507d2d;if(!_0x1a8380[_0x38e6e1(0x132)])throw new sequelize_1[(_0x38e6e1(0x10d))](_0x38e6e1(0x19b));const {contacts:_0x50b00a}=_0x1a8380[_0x38e6e1(0x132)],_0x445668=_0x50b00a[_0x38e6e1(0x107)],_0x10bd82=await CampaignShipping_1['default'][_0x38e6e1(0x12e)]({'where':{'campaignId':_0x1a8380['id'],'deliveredAt':{[sequelize_1['Op'][_0x38e6e1(0x104)]]:null}}});_0x445668===_0x10bd82&&await _0x1a8380[_0x38e6e1(0xff)]({'status':_0x38e6e1(0xfc),'completedAt':(0x0,moment_1[_0x38e6e1(0x137)])()});const _0x3110b8=(0x0,socket_1[_0x38e6e1(0x192)])();_0x3110b8['to'](_0x38e6e1(0x170)+_0x1a8380[_0x38e6e1(0x14a)]+_0x38e6e1(0x130))[_0x38e6e1(0x173)](_0x38e6e1(0x170)+_0x1a8380['companyId']+'-campaign',{'action':'update','record':_0x1a8380});}['calculateDelay'](_0x474427,_0x5494ab,_0x5d2224,_0x3bba27,_0x181f8c){const _0x4f240a=a572_0x507d2d,_0xbc17c=(0x0,date_fns_1[_0x4f240a(0x17c)])(_0x5494ab,new Date());return _0x474427>_0x5d2224?_0xbc17c*0x3e8+_0x3bba27:_0xbc17c*0x3e8+_0x181f8c;}[a572_0x507d2d(0x153)](_0x596302){const _0x2dda18=a572_0x507d2d,_0x187471=[];return!(0x0,lodash_1[_0x2dda18(0x162)])(_0x596302[_0x2dda18(0x18c)])&&!(0x0,lodash_1['isNil'])(_0x596302[_0x2dda18(0x18c)])&&_0x187471[_0x2dda18(0x19a)](_0x596302[_0x2dda18(0x18c)]),!(0x0,lodash_1['isEmpty'])(_0x596302['confirmationMessage2'])&&!(0x0,lodash_1[_0x2dda18(0x18d)])(_0x596302['confirmationMessage2'])&&_0x187471['push'](_0x596302[_0x2dda18(0x150)]),!(0x0,lodash_1['isEmpty'])(_0x596302[_0x2dda18(0x19c)])&&!(0x0,lodash_1[_0x2dda18(0x18d)])(_0x596302[_0x2dda18(0x19c)])&&_0x187471[_0x2dda18(0x19a)](_0x596302[_0x2dda18(0x19c)]),!(0x0,lodash_1['isEmpty'])(_0x596302[_0x2dda18(0x149)])&&!(0x0,lodash_1[_0x2dda18(0x18d)])(_0x596302[_0x2dda18(0x149)])&&_0x187471['push'](_0x596302[_0x2dda18(0x149)]),!(0x0,lodash_1[_0x2dda18(0x162)])(_0x596302[_0x2dda18(0x160)])&&!(0x0,lodash_1[_0x2dda18(0x18d)])(_0x596302[_0x2dda18(0x160)])&&_0x187471[_0x2dda18(0x19a)](_0x596302['confirmationMessage5']),_0x187471;}async['handleDispatchCampaign'](_0x3cee4a){const _0x394ef9=a572_0x507d2d;try{const {data:_0x5cc51d}=_0x3cee4a,{campaignShippingId:_0x18ad93,campaignId:_0x7c14db}=_0x5cc51d,_0x29faef=await this[_0x394ef9(0x117)](_0x7c14db),_0x1fc87f=await(0x0,GetWhatsappWbot_1['default'])(_0x29faef[_0x394ef9(0x158)]);if(!_0x1fc87f){logger_1['logger']['error'](_0x394ef9(0x10b));return;}if(!_0x29faef[_0x394ef9(0x158)]){logger_1['logger'][_0x394ef9(0x11c)]('campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20whatsapp\x20not\x20found');return;}if(!_0x1fc87f?.[_0x394ef9(0x108)]?.['id']){logger_1['logger'][_0x394ef9(0x11c)](_0x394ef9(0x19e));return;}logger_1['logger']['info'](_0x394ef9(0x100)+_0x7c14db+_0x394ef9(0x13d)+_0x18ad93);const _0x82ad7d=await CampaignShipping_1[_0x394ef9(0x137)][_0x394ef9(0x13f)](_0x18ad93,{'include':[{'model':ContactListItem_1[_0x394ef9(0x137)],'as':_0x394ef9(0xfa)}]}),_0x273306=_0x82ad7d[_0x394ef9(0x16b)]+_0x394ef9(0x127);let _0x587069=_0x82ad7d[_0x394ef9(0x159)][_0x394ef9(0x12b)]()[_0x394ef9(0x145)]();_0x29faef[_0x394ef9(0x14f)]&&_0x82ad7d[_0x394ef9(0x14f)]===null&&(_0x587069=_0x82ad7d[_0x394ef9(0x139)]);await(0x0,SendPresenceStatus_1[_0x394ef9(0xf6)])(_0x1fc87f,_0x273306);if(!(0x0,lodash_1[_0x394ef9(0x18d)])(_0x29faef[_0x394ef9(0x171)]))try{const _0x510aea=path_1[_0x394ef9(0x137)][_0x394ef9(0x168)](__dirname,_0x394ef9(0x12f),_0x394ef9(0xf8),'company'+_0x29faef[_0x394ef9(0x14a)]),_0x36551a=await(0x0,ShowService_1[_0x394ef9(0x137)])(_0x29faef[_0x394ef9(0x171)],_0x29faef[_0x394ef9(0x14a)]),_0x57776a=path_1[_0x394ef9(0x137)][_0x394ef9(0x168)](_0x510aea,_0x394ef9(0x13e),String(_0x36551a['id']));for(const [_0x239ae1,_0x52d0f9]of _0x36551a[_0x394ef9(0x19f)][_0x394ef9(0x164)]()){const _0x7c307c=await(0x0,SendWhatsAppMedia_1[_0x394ef9(0x179)])(_0x52d0f9[_0x394ef9(0x140)],path_1['default'][_0x394ef9(0x168)](_0x57776a,_0x52d0f9[_0x394ef9(0x140)]),_0x52d0f9[_0x394ef9(0x18a)],_0x29faef['companyId']);await _0x1fc87f['sendMessage'](_0x273306,{..._0x7c307c});}}catch(_0x2740c9){logger_1[_0x394ef9(0x124)][_0x394ef9(0x1a5)](_0x2740c9);}if(_0x29faef['mediaPath']){const _0xa29d3a=path_1['default']['resolve'](__dirname,_0x394ef9(0x12f),_0x394ef9(0xf8),_0x394ef9(0x1a1)+_0x29faef['companyId']),_0x293c25=path_1[_0x394ef9(0x137)][_0x394ef9(0x14b)](_0xa29d3a,_0x29faef[_0x394ef9(0x180)]),_0x282353=await(0x0,SendWhatsAppMedia_1['getMessageOptions'])(_0x29faef[_0x394ef9(0x12d)],_0x293c25,_0x587069,_0x29faef[_0x394ef9(0x14a)]);Object[_0x394ef9(0x19d)](_0x282353)['length']&&await _0x1fc87f[_0x394ef9(0x16f)](_0x273306,{..._0x282353});}else _0x29faef[_0x394ef9(0x14f)]&&_0x82ad7d[_0x394ef9(0x14f)]===null?(await _0x1fc87f['sendMessage'](_0x273306,{'text':_0x587069}),await _0x82ad7d[_0x394ef9(0xff)]({'confirmationRequestedAt':(0x0,moment_1[_0x394ef9(0x137)])()})):await _0x1fc87f['sendMessage'](_0x273306,{'text':_0x587069});await _0x82ad7d['update']({'deliveredAt':(0x0,moment_1[_0x394ef9(0x137)])()}),await this[_0x394ef9(0x10a)](_0x29faef);const _0x4069d9=(0x0,socket_1['getIO'])();_0x4069d9['to'](_0x394ef9(0x170)+_0x29faef[_0x394ef9(0x14a)]+_0x394ef9(0x130))[_0x394ef9(0x173)](_0x394ef9(0x170)+_0x29faef[_0x394ef9(0x14a)]+_0x394ef9(0x126),{'action':_0x394ef9(0xff),'record':_0x29faef}),logger_1[_0x394ef9(0x124)][_0x394ef9(0x1a5)](_0x394ef9(0x186)+_0x7c14db+_0x394ef9(0x182)+_0x82ad7d['contact']['name']);}catch(_0x56166f){Sentry['captureException'](_0x56166f),logger_1[_0x394ef9(0x124)]['error'](_0x56166f[_0x394ef9(0x159)]);}}[a572_0x507d2d(0xfd)](_0xa33bb2){const _0x54e9d6=a572_0x507d2d,_0x37397b=[];return!(0x0,lodash_1[_0x54e9d6(0x162)])(_0xa33bb2[_0x54e9d6(0x131)])&&!(0x0,lodash_1[_0x54e9d6(0x18d)])(_0xa33bb2[_0x54e9d6(0x131)])&&_0x37397b[_0x54e9d6(0x19a)](_0xa33bb2[_0x54e9d6(0x131)]),!(0x0,lodash_1['isEmpty'])(_0xa33bb2[_0x54e9d6(0x165)])&&!(0x0,lodash_1[_0x54e9d6(0x18d)])(_0xa33bb2[_0x54e9d6(0x165)])&&_0x37397b[_0x54e9d6(0x19a)](_0xa33bb2[_0x54e9d6(0x165)]),!(0x0,lodash_1['isEmpty'])(_0xa33bb2[_0x54e9d6(0x135)])&&!(0x0,lodash_1[_0x54e9d6(0x18d)])(_0xa33bb2[_0x54e9d6(0x135)])&&_0x37397b[_0x54e9d6(0x19a)](_0xa33bb2['message3']),!(0x0,lodash_1['isEmpty'])(_0xa33bb2['message4'])&&!(0x0,lodash_1[_0x54e9d6(0x18d)])(_0xa33bb2['message4'])&&_0x37397b[_0x54e9d6(0x19a)](_0xa33bb2['message4']),!(0x0,lodash_1[_0x54e9d6(0x162)])(_0xa33bb2[_0x54e9d6(0x169)])&&!(0x0,lodash_1[_0x54e9d6(0x18d)])(_0xa33bb2[_0x54e9d6(0x169)])&&_0x37397b[_0x54e9d6(0x19a)](_0xa33bb2['message5']),_0x37397b;}[a572_0x507d2d(0x118)](_0x150742,_0x162e37,_0x198a40){const _0x3207c9=a572_0x507d2d;let _0x3262d8=_0x150742;return _0x3262d8[_0x3207c9(0x121)](_0x3207c9(0x151))&&(_0x3262d8=_0x3262d8['replace'](/{nome}/g,_0x198a40['name'])),_0x3262d8['includes']('{email}')&&(_0x3262d8=_0x3262d8[_0x3207c9(0x183)](/{email}/g,_0x198a40[_0x3207c9(0x175)])),_0x3262d8['includes'](_0x3207c9(0x17a))&&(_0x3262d8=_0x3262d8[_0x3207c9(0x183)](/{numero}/g,_0x198a40['number'])),_0x162e37[_0x3207c9(0x10f)](_0x200d97=>{const _0x5e0808=_0x3207c9;if(_0x3262d8[_0x5e0808(0x121)]('{'+_0x200d97['key']+'}')){const _0xa5db43=new RegExp('{'+_0x200d97[_0x5e0808(0x114)]+'}','g');_0x3262d8=_0x3262d8[_0x5e0808(0x183)](_0xa5db43,_0x200d97[_0x5e0808(0x188)]);}}),_0x3262d8;}async[a572_0x507d2d(0x161)](_0x489098){const _0x49d927=a572_0x507d2d,_0x371390=await CampaignSetting_1[_0x49d927(0x137)][_0x49d927(0x181)]({'where':{'companyId':_0x489098[_0x49d927(0x14a)]},'attributes':['key',_0x49d927(0x188)]});let _0xe9a0ff=0x14,_0xe40b4a=0x14,_0x276ddc=0x3c,_0x378927=[];return _0x371390[_0x49d927(0x10f)](_0x1b6aa6=>{const _0x162b3f=_0x49d927;_0x1b6aa6[_0x162b3f(0x114)]===_0x162b3f(0x144)&&(_0xe9a0ff=JSON[_0x162b3f(0x133)](_0x1b6aa6['value'])),_0x1b6aa6[_0x162b3f(0x114)]===_0x162b3f(0x141)&&(_0xe40b4a=JSON[_0x162b3f(0x133)](_0x1b6aa6[_0x162b3f(0x188)])),_0x1b6aa6[_0x162b3f(0x114)]===_0x162b3f(0x199)&&(_0x276ddc=JSON[_0x162b3f(0x133)](_0x1b6aa6[_0x162b3f(0x188)])),_0x1b6aa6[_0x162b3f(0x114)]===_0x162b3f(0x187)&&(_0x378927=JSON[_0x162b3f(0x133)](_0x1b6aa6[_0x162b3f(0x188)]));}),{'messageInterval':_0xe9a0ff,'longerIntervalAfter':_0xe40b4a,'greaterInterval':_0x276ddc,'variables':_0x378927};}async[a572_0x507d2d(0x14c)](_0x425e7f){const _0x5e23b7=a572_0x507d2d;try{const {id:_0x3d3be8}=_0x425e7f[_0x5e23b7(0x129)],_0x4668f5=await this[_0x5e23b7(0x117)](_0x3d3be8),_0x7e482a=await this[_0x5e23b7(0x161)](_0x4668f5);if(!_0x4668f5)throw new sequelize_1[(_0x5e23b7(0x10d))](_0x5e23b7(0x11b));if(!_0x4668f5['contactList']||!_0x4668f5[_0x5e23b7(0x132)][_0x5e23b7(0x12c)])throw new sequelize_1[(_0x5e23b7(0x10d))](_0x5e23b7(0x174));if(_0x4668f5){const {contacts:_0x3a7ef5}=_0x4668f5[_0x5e23b7(0x132)];if((0x0,lodash_1[_0x5e23b7(0x11d)])(_0x3a7ef5)){const _0x1b6cf8=_0x3a7ef5[_0x5e23b7(0x17f)](_0x1ac5fd=>({'contactId':_0x1ac5fd['id'],'campaignId':_0x4668f5['id'],'variables':_0x7e482a[_0x5e23b7(0x187)]})),_0x2cbd44=(0x0,queues_1['parseToMilliseconds'])(_0x7e482a['longerIntervalAfter']),_0x1f2e02=(0x0,queues_1[_0x5e23b7(0x11f)])(_0x7e482a['greaterInterval']),_0x2e3f3c=_0x7e482a[_0x5e23b7(0x144)];let _0x3615a7=_0x4668f5['scheduledAt'];const _0xc011b7=[];for(let _0x5607af=0x0;_0x5607af<_0x1b6cf8[_0x5e23b7(0x107)];_0x5607af++){_0x3615a7=(0x0,date_fns_1[_0x5e23b7(0x196)])(_0x3615a7,_0x5607af>_0x2cbd44?_0x1f2e02:_0x2e3f3c);const {contactId:_0x39abe4,campaignId:_0x4be03d,variables:_0x16ef40}=_0x1b6cf8[_0x5607af],_0x54dffc=this[_0x5e23b7(0x12a)](_0x5607af,_0x3615a7,_0x2cbd44,_0x1f2e02,_0x2e3f3c),_0x5f319a=queues_1[_0x5e23b7(0x16c)]['add'](_0x5e23b7(0x189),{'contactId':_0x39abe4,'campaignId':_0x4be03d,'variables':_0x16ef40,'delay':_0x54dffc+(0x0,queues_1[_0x5e23b7(0x16d)])(0x64,0x5dc)},{'removeOnComplete':!![]});_0xc011b7['push'](_0x5f319a),logger_1[_0x5e23b7(0x124)]['info'](_0x5e23b7(0x115)+_0x4668f5['id']+_0x5e23b7(0x182)+_0x3a7ef5[_0x5607af][_0x5e23b7(0x18a)]+_0x5e23b7(0x105)+_0x54dffc);}await Promise[_0x5e23b7(0x155)](_0xc011b7),await _0x4668f5[_0x5e23b7(0xff)]({'status':_0x5e23b7(0x197)});}}}catch(_0x16fe93){logger_1[_0x5e23b7(0x124)][_0x5e23b7(0x11c)](_0x16fe93),Sentry[_0x5e23b7(0x15a)](_0x16fe93);}}async[a572_0x507d2d(0x117)](_0x46618d){const _0x2dba69=a572_0x507d2d,_0x2d460b=await Campaign_1[_0x2dba69(0x137)][_0x2dba69(0x13f)](_0x46618d,{'include':[{'model':ContactList_1[_0x2dba69(0x137)],'as':_0x2dba69(0x132),'attributes':['id',_0x2dba69(0x18a)],'include':[{'model':ContactListItem_1[_0x2dba69(0x137)],'as':_0x2dba69(0x12c),'attributes':['id',_0x2dba69(0x18a),_0x2dba69(0x16b),_0x2dba69(0x175),_0x2dba69(0x10e)],'where':{'isWhatsappValid':!![]}}]},{'model':Whatsapp_1[_0x2dba69(0x137)],'as':_0x2dba69(0x158),'attributes':['id',_0x2dba69(0x18a)]},{'model':CampaignShipping_1[_0x2dba69(0x137)],'as':_0x2dba69(0x191),'include':[{'model':ContactListItem_1[_0x2dba69(0x137)],'as':_0x2dba69(0xfa)}]}]});if(!_0x2d460b||!_0x2d460b[_0x2dba69(0x132)])throw new sequelize_1['Error'](_0x2dba69(0x112));return _0x2d460b;}async['handleVerifyCampaigns'](_0x2a4f91){const _0x3fec74=a572_0x507d2d,_0xeeec2e=new Date(new Date()[_0x3fec74(0x16a)]()+0x3c*0x3c*0x3e8);let _0x26c836=await Campaign_1['default']['findAll']({'where':{'scheduledAt':{[sequelize_1['Op'][_0x3fec74(0x116)]]:+_0xeeec2e},'status':_0x3fec74(0x122)},'attributes':['id',_0x3fec74(0x177)]});if(_0x26c836[_0x3fec74(0x107)]>0x0)logger_1[_0x3fec74(0x124)]['info'](_0x3fec74(0x147)+_0x26c836[_0x3fec74(0x107)]);for(let _0x1e1f01 of _0x26c836){try{const _0x5cf2a4=(0x0,moment_1[_0x3fec74(0x137)])(),_0x19386a=(0x0,moment_1[_0x3fec74(0x137)])(_0x1e1f01['scheduledAt']),_0x2e9d74=_0x19386a['diff'](_0x5cf2a4,_0x3fec74(0x18b));logger_1[_0x3fec74(0x124)][_0x3fec74(0x1a5)](_0x3fec74(0x17d)+_0x1e1f01['id']+_0x3fec74(0x15e)+_0x2e9d74);const _0x52b2b6=await this[_0x3fec74(0x117)](_0x1e1f01['id']);if(!_0x52b2b6['contactList']||!_0x52b2b6[_0x3fec74(0x132)][_0x3fec74(0x12c)])throw new sequelize_1['Error'](_0x3fec74(0x174));await queues_1[_0x3fec74(0x16c)]['add'](_0x3fec74(0xf9),{'id':_0x1e1f01['id'],'delay':_0x2e9d74},{'delay':_0x2e9d74,'removeOnComplete':!![]});}catch(_0x4610af){return Sentry['captureException'](_0x4610af),Promise[_0x3fec74(0x176)](new sequelize_1[(_0x3fec74(0x10d))](_0x4610af));}}return Promise['resolve']({'count':_0x26c836[_0x3fec74(0x107)]});}}exports[a572_0x507d2d(0x137)]=CampaingJob;