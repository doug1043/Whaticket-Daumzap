function a572_0x4188(){const _0x51b635=['Campanhas\x20encontradas:\x20','isWhatsappValid','{nome}','value','sendMessage','../services/WbotServices/SendWhatsAppMedia','logger','join','search','get','differenceInSeconds','campaignQueue','set','getCampaignValidConfirmationMessages','isArray','includes','error','__esModule','confirmationMessage5','info','SendPresenceStatus','map','push','getCampaignValidMessages','../utils/logger','date-fns','writable','count','parseToMilliseconds','path','message','DispatchCampaign','data','resolve','getCampaign','keys','constructor','create','getOwnPropertyDescriptor','../libs/socket','email','hasOwnProperty','../queues','company-','204462zYQIuD','contact','Worker','getProcessedMessage','confirmationMessage3','__createBinding','entries','update','getTime','calculateDelay','completed','message1','-campaign','confirmationMessage','confirmationRequestedAt','handleDispatchCampaign','confirmation','save','campaignId','contacts','@s.whatsapp.net','messageInterval','message3','findAll',',\x20Delay\x20Inicial=','getMessageOptions','findByPk','1437162lsmuGa','FINALIZADA','mediaPath','configurable','../models/ContactList','captureException','../models/Campaign','verifyAndFinalizeCampaign','replace','../models/Whatsapp',';delay=','randomValue','campaign.contactList\x20is\x20null\x20or\x20undefined','contactId','scheduledAt','isEmpty','4255752JPOKYr','call','fileListId',';Contato=','confirmationMessage4','PrepareContact','key','__importDefault','Registro\x20enviado\x20pra\x20fila\x20de\x20disparo:\x20Campanha=','Disparo\x20de\x20campanha\x20solicitado:\x20Campanha=','company','user','findOrCreate','length','milliseconds','number','../models/CampaignSetting','lte','Campanha\x20enviada\x20para:\x20Campanha=','../models/CampaignShipping','__importStar','(((.+)+)+)+$','parse','Error','companyId','deliveredAt','fileList','Campaign\x20or\x20ContactList\x20not\x20found','message2','sequelize','whatsapp','handleVerifyCampaigns','longerIntervalAfter','variables','handlePrepareContact','message5','VerifyCampaigns','trimEnd','name','ContactList\x20not\x20found\x20or\x20empty','diff','defineProperty','add','\x20failed\x20with\x20error:\x20','greaterInterval','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20not\x20found','failed','confirmationMessage1',';Registro=','../helpers/SendPresenceStatus','375204zmbOMx','getContact','ProcessCampaign','1381552pazIex','reject','emit','handleProcessCampaign','Campanha\x20enviada\x20para\x20a\x20fila\x20de\x20processamento:\x20Campanha=','PROGRAMADA','forEach','public','default','apply','message4','../..','@sentry/node','confirmationMessage2','isNil','Job\x20','contactList','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20user\x20not\x20found','15ILVzhW','addSeconds','2595747DVknAN','prototype','-mainchannel','777566ZVezcm'];a572_0x4188=function(){return _0x51b635;};return a572_0x4188();}const a572_0xd8bf61=a572_0x12b0;function a572_0x12b0(_0x51a512,_0x771e37){const _0x3e878c=a572_0x4188();return a572_0x12b0=function(_0x3084ca,_0x7a7fdc){_0x3084ca=_0x3084ca-0xd0;let _0x4188e5=_0x3e878c[_0x3084ca];return _0x4188e5;},a572_0x12b0(_0x51a512,_0x771e37);}(function(_0x309544,_0x652ba6){const _0x1f119b=a572_0x12b0,_0x37901d=_0x309544();while(!![]){try{const _0x488fd2=-parseInt(_0x1f119b(0xf6))/0x1+-parseInt(_0x1f119b(0x16d))/0x2+parseInt(_0x1f119b(0x111))/0x3+-parseInt(_0x1f119b(0x156))/0x4+-parseInt(_0x1f119b(0x168))/0x5*(parseInt(_0x1f119b(0x153))/0x6)+parseInt(_0x1f119b(0x16a))/0x7+parseInt(_0x1f119b(0x121))/0x8;if(_0x488fd2===_0x652ba6)break;else _0x37901d['push'](_0x37901d['shift']());}catch(_0x22ee08){_0x37901d['push'](_0x37901d['shift']());}}}(a572_0x4188,0x3e679));const a572_0x7a7fdc=(function(){let _0xa2efc5=!![];return function(_0x1c0d31,_0x82309f){const _0x436ae3=_0xa2efc5?function(){const _0x1ba1fd=a572_0x12b0;if(_0x82309f){const _0x163eff=_0x82309f[_0x1ba1fd(0x15f)](_0x1c0d31,arguments);return _0x82309f=null,_0x163eff;}}:function(){};return _0xa2efc5=![],_0x436ae3;};}()),a572_0x3084ca=a572_0x7a7fdc(this,function(){const _0x332b8b=a572_0x12b0;return a572_0x3084ca['toString']()['search'](_0x332b8b(0x136))['toString']()[_0x332b8b(0xee)](a572_0x3084ca)[_0x332b8b(0xd2)]('(((.+)+)+)+$');});a572_0x3084ca();'use strict';var __createBinding=this&&this[a572_0xd8bf61(0xfb)]||(Object['create']?function(_0x4875d7,_0x57fb9e,_0x4b2a44,_0x22262f){const _0x8814=a572_0xd8bf61;if(_0x22262f===undefined)_0x22262f=_0x4b2a44;var _0x359699=Object[_0x8814(0xf0)](_0x57fb9e,_0x4b2a44);(!_0x359699||(_0x8814(0xd3)in _0x359699?!_0x57fb9e[_0x8814(0xdb)]:_0x359699[_0x8814(0xe4)]||_0x359699[_0x8814(0x114)]))&&(_0x359699={'enumerable':!![],'get':function(){return _0x57fb9e[_0x4b2a44];}}),Object[_0x8814(0x14a)](_0x4875d7,_0x22262f,_0x359699);}:function(_0x43b81d,_0x177fc7,_0x452bd8,_0x3af545){if(_0x3af545===undefined)_0x3af545=_0x452bd8;_0x43b81d[_0x3af545]=_0x177fc7[_0x452bd8];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a572_0xd8bf61(0xef)]?function(_0x10019d,_0x153db1){const _0x440cae=a572_0xd8bf61;Object[_0x440cae(0x14a)](_0x10019d,_0x440cae(0x15e),{'enumerable':!![],'value':_0x153db1});}:function(_0x1d1bc3,_0x32c507){const _0x52b631=a572_0xd8bf61;_0x1d1bc3[_0x52b631(0x15e)]=_0x32c507;}),__importStar=this&&this[a572_0xd8bf61(0x135)]||function(_0x223740){const _0x4a4b80=a572_0xd8bf61;if(_0x223740&&_0x223740[_0x4a4b80(0xdb)])return _0x223740;var _0x5e28fb={};if(_0x223740!=null){for(var _0x534749 in _0x223740)if(_0x534749!==_0x4a4b80(0x15e)&&Object[_0x4a4b80(0x16b)][_0x4a4b80(0xf3)][_0x4a4b80(0x122)](_0x223740,_0x534749))__createBinding(_0x5e28fb,_0x223740,_0x534749);}return __setModuleDefault(_0x5e28fb,_0x223740),_0x5e28fb;},__importDefault=this&&this[a572_0xd8bf61(0x128)]||function(_0x2409b1){const _0x2db7c1=a572_0xd8bf61;return _0x2409b1&&_0x2409b1[_0x2db7c1(0xdb)]?_0x2409b1:{'default':_0x2409b1};};Object[a572_0xd8bf61(0x14a)](exports,a572_0xd8bf61(0xdb),{'value':!![]});const bullmq_1=require('bullmq'),Campaign_1=__importDefault(require(a572_0xd8bf61(0x117))),sequelize_1=require(a572_0xd8bf61(0x13e)),logger_1=require(a572_0xd8bf61(0xe2)),moment_1=__importDefault(require('moment/moment')),Sentry=__importStar(require(a572_0xd8bf61(0x162))),ContactList_1=__importDefault(require(a572_0xd8bf61(0x115))),ContactListItem_1=__importDefault(require('../models/ContactListItem')),Whatsapp_1=__importDefault(require(a572_0xd8bf61(0x11a))),CampaignShipping_1=__importDefault(require(a572_0xd8bf61(0x134))),queues_1=require(a572_0xd8bf61(0xf4)),lodash_1=require('lodash'),date_fns_1=require(a572_0xd8bf61(0xe3)),GetWhatsappWbot_1=__importDefault(require('../helpers/GetWhatsappWbot')),path_1=__importDefault(require('path')),ShowService_1=__importDefault(require('../services/FileServices/ShowService')),SendWhatsAppMedia_1=require(a572_0xd8bf61(0x173)),socket_1=require(a572_0xd8bf61(0xf1)),CampaignSetting_1=__importDefault(require(a572_0xd8bf61(0x131))),SendPresenceStatus_1=require(a572_0xd8bf61(0x152));class CampaingJob{constructor(_0x29881f,_0x41061d){const _0x1882b9=a572_0xd8bf61,_0x14143f=new bullmq_1[(_0x1882b9(0xf8))](_0x29881f,async _0x56fd4c=>{const _0x31f92a=_0x1882b9;if(_0x56fd4c['name']===_0x31f92a(0x145))await this[_0x31f92a(0x140)](_0x56fd4c);else{if(_0x56fd4c[_0x31f92a(0x147)]==='ProcessCampaign')await this[_0x31f92a(0x159)](_0x56fd4c);else{if(_0x56fd4c['name']===_0x31f92a(0x126))await this[_0x31f92a(0x143)](_0x56fd4c);else _0x56fd4c['name']==='DispatchCampaign'&&await this[_0x31f92a(0x105)](_0x56fd4c);}}},{'useWorkerThreads':![],'concurrency':0x64,'connection':_0x41061d,'removeOnFail':{'count':0x0}});_0x14143f['on'](_0x1882b9(0x100),async _0x1a31b8=>{const _0x49ad37=_0x1882b9;logger_1[_0x49ad37(0xd0)][_0x49ad37(0xdd)]('Job\x20'+_0x1a31b8[_0x49ad37(0x147)]+'\x20('+_0x1a31b8['id']+')\x20completed');}),_0x14143f['on'](_0x1882b9(0x14f),async(_0x204598,_0x2e347e)=>{const _0x3bdb18=_0x1882b9;logger_1[_0x3bdb18(0xd0)][_0x3bdb18(0xda)](_0x3bdb18(0x165)+_0x204598[_0x3bdb18(0x147)]+_0x3bdb18(0x14c)+_0x2e347e[_0x3bdb18(0xe8)]);});}async[a572_0xd8bf61(0x154)](_0x15c3ce){const _0x102e77=a572_0xd8bf61;return ContactListItem_1[_0x102e77(0x15e)][_0x102e77(0x110)](_0x15c3ce,{'attributes':['id',_0x102e77(0x147),_0x102e77(0x130),_0x102e77(0xf2)]});}async[a572_0xd8bf61(0x143)](_0x5ba0f9){const _0x1ff3b2=a572_0xd8bf61;try{const {contactId:_0x3a4b98,campaignId:_0x2ab3f4,delay:_0x1ee558,variables:_0x2cbd6f}=_0x5ba0f9[_0x1ff3b2(0xea)],_0x499f0e=await this[_0x1ff3b2(0xec)](_0x2ab3f4),_0x599a73=await this[_0x1ff3b2(0x154)](_0x3a4b98),_0xdd79f2={};_0xdd79f2[_0x1ff3b2(0x130)]=_0x599a73[_0x1ff3b2(0x130)],_0xdd79f2[_0x1ff3b2(0x11e)]=_0x3a4b98,_0xdd79f2['campaignId']=_0x2ab3f4;const _0x57a395=this[_0x1ff3b2(0xe1)](_0x499f0e);if(_0x57a395[_0x1ff3b2(0x12e)]){const _0x452e93=(0x0,queues_1[_0x1ff3b2(0x11c)])(0x0,_0x57a395[_0x1ff3b2(0x12e)]),_0x357d8b=this[_0x1ff3b2(0xf9)](_0x57a395[_0x452e93],_0x2cbd6f,_0x599a73);_0xdd79f2[_0x1ff3b2(0xe8)]='‌\x20'+_0x357d8b;}if(_0x499f0e['confirmation']){const _0xe34aef=this[_0x1ff3b2(0xd7)](_0x499f0e);if(_0xe34aef[_0x1ff3b2(0x12e)]){const _0x41dfa7=(0x0,queues_1[_0x1ff3b2(0x11c)])(0x0,_0xe34aef[_0x1ff3b2(0x12e)]),_0x1c0aab=this[_0x1ff3b2(0xf9)](_0xe34aef[_0x41dfa7],_0x2cbd6f,_0x599a73);_0xdd79f2[_0x1ff3b2(0x103)]='‌\x20'+_0x1c0aab;}}const [_0x5c95d9,_0x16bf9d]=await CampaignShipping_1[_0x1ff3b2(0x15e)][_0x1ff3b2(0x12d)]({'where':{'campaignId':_0xdd79f2[_0x1ff3b2(0x108)],'contactId':_0xdd79f2[_0x1ff3b2(0x11e)]},'defaults':_0xdd79f2});!_0x16bf9d&&_0x5c95d9['deliveredAt']===null&&_0x5c95d9[_0x1ff3b2(0x104)]===null&&(_0x5c95d9[_0x1ff3b2(0xd6)](_0xdd79f2),await _0x5c95d9[_0x1ff3b2(0x107)]());if(_0x5c95d9[_0x1ff3b2(0x13a)]===null&&_0x5c95d9[_0x1ff3b2(0x104)]===null){const _0x46a421=await queues_1[_0x1ff3b2(0xd5)]['add'](_0x1ff3b2(0xe9),{'campaignId':_0x499f0e['id'],'campaignShippingId':_0x5c95d9['id'],'contactListItemId':_0x3a4b98},{'removeOnComplete':!![],'delay':_0x1ee558});await _0x5c95d9['update']({'jobId':_0x46a421['id']});}await this[_0x1ff3b2(0x118)](_0x499f0e);}catch(_0xe9754a){Sentry[_0x1ff3b2(0x116)](_0xe9754a),logger_1[_0x1ff3b2(0xd0)][_0x1ff3b2(0xda)]('campaignQueue\x20->\x20PrepareContact\x20->\x20error:\x20'+_0xe9754a[_0x1ff3b2(0xe8)]);}}async[a572_0xd8bf61(0x118)](_0x45f507){const _0x5f59f5=a572_0xd8bf61;if(!_0x45f507[_0x5f59f5(0x166)])throw new sequelize_1['Error'](_0x5f59f5(0x11d));const {contacts:_0x3e5f5b}=_0x45f507[_0x5f59f5(0x166)],_0x206d17=_0x3e5f5b['length'],_0x2230ea=await CampaignShipping_1[_0x5f59f5(0x15e)][_0x5f59f5(0xe5)]({'where':{'campaignId':_0x45f507['id'],'deliveredAt':{[sequelize_1['Op']['not']]:null}}});_0x206d17===_0x2230ea&&await _0x45f507[_0x5f59f5(0xfd)]({'status':_0x5f59f5(0x112),'completedAt':(0x0,moment_1[_0x5f59f5(0x15e)])()});const _0x411034=(0x0,socket_1['getIO'])();_0x411034['to'](_0x5f59f5(0xf5)+_0x45f507['companyId']+_0x5f59f5(0x16c))[_0x5f59f5(0x158)](_0x5f59f5(0xf5)+_0x45f507['companyId']+_0x5f59f5(0x102),{'action':'update','record':_0x45f507});}[a572_0xd8bf61(0xff)](_0x32de74,_0x41fb32,_0x156f1b,_0x38b273,_0x5baba9){const _0x56388e=a572_0xd8bf61,_0x72e566=(0x0,date_fns_1[_0x56388e(0xd4)])(_0x41fb32,new Date());return _0x32de74>_0x156f1b?_0x72e566*0x3e8+_0x38b273:_0x72e566*0x3e8+_0x5baba9;}[a572_0xd8bf61(0xd7)](_0x5ea43b){const _0x1c4c3b=a572_0xd8bf61,_0x25ca59=[];return!(0x0,lodash_1[_0x1c4c3b(0x120)])(_0x5ea43b[_0x1c4c3b(0x150)])&&!(0x0,lodash_1[_0x1c4c3b(0x164)])(_0x5ea43b[_0x1c4c3b(0x150)])&&_0x25ca59['push'](_0x5ea43b[_0x1c4c3b(0x150)]),!(0x0,lodash_1[_0x1c4c3b(0x120)])(_0x5ea43b[_0x1c4c3b(0x163)])&&!(0x0,lodash_1['isNil'])(_0x5ea43b[_0x1c4c3b(0x163)])&&_0x25ca59['push'](_0x5ea43b[_0x1c4c3b(0x163)]),!(0x0,lodash_1[_0x1c4c3b(0x120)])(_0x5ea43b[_0x1c4c3b(0xfa)])&&!(0x0,lodash_1[_0x1c4c3b(0x164)])(_0x5ea43b[_0x1c4c3b(0xfa)])&&_0x25ca59[_0x1c4c3b(0xe0)](_0x5ea43b[_0x1c4c3b(0xfa)]),!(0x0,lodash_1[_0x1c4c3b(0x120)])(_0x5ea43b['confirmationMessage4'])&&!(0x0,lodash_1[_0x1c4c3b(0x164)])(_0x5ea43b[_0x1c4c3b(0x125)])&&_0x25ca59[_0x1c4c3b(0xe0)](_0x5ea43b['confirmationMessage4']),!(0x0,lodash_1[_0x1c4c3b(0x120)])(_0x5ea43b['confirmationMessage5'])&&!(0x0,lodash_1[_0x1c4c3b(0x164)])(_0x5ea43b[_0x1c4c3b(0xdc)])&&_0x25ca59[_0x1c4c3b(0xe0)](_0x5ea43b[_0x1c4c3b(0xdc)]),_0x25ca59;}async[a572_0xd8bf61(0x105)](_0x103720){const _0x4272d5=a572_0xd8bf61;try{const {data:_0x244174}=_0x103720,{campaignShippingId:_0x5bf6b6,campaignId:_0x5e5919}=_0x244174,_0x579a8a=await this['getCampaign'](_0x5e5919),_0x39fe88=await(0x0,GetWhatsappWbot_1[_0x4272d5(0x15e)])(_0x579a8a[_0x4272d5(0x13f)]);if(!_0x39fe88){logger_1[_0x4272d5(0xd0)][_0x4272d5(0xda)](_0x4272d5(0x14e));return;}if(!_0x579a8a[_0x4272d5(0x13f)]){logger_1['logger'][_0x4272d5(0xda)]('campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20whatsapp\x20not\x20found');return;}if(!_0x39fe88?.[_0x4272d5(0x12c)]?.['id']){logger_1[_0x4272d5(0xd0)][_0x4272d5(0xda)](_0x4272d5(0x167));return;}logger_1[_0x4272d5(0xd0)][_0x4272d5(0xdd)](_0x4272d5(0x12a)+_0x5e5919+_0x4272d5(0x151)+_0x5bf6b6);const _0x1b95d5=await CampaignShipping_1[_0x4272d5(0x15e)][_0x4272d5(0x110)](_0x5bf6b6,{'include':[{'model':ContactListItem_1[_0x4272d5(0x15e)],'as':_0x4272d5(0xf7)}]}),_0x47c603=_0x1b95d5[_0x4272d5(0x130)]+_0x4272d5(0x10a);let _0x3f7f5b=_0x1b95d5[_0x4272d5(0xe8)][_0x4272d5(0x146)]()['trimStart']();_0x579a8a[_0x4272d5(0x106)]&&_0x1b95d5['confirmation']===null&&(_0x3f7f5b=_0x1b95d5[_0x4272d5(0x103)]);await(0x0,SendPresenceStatus_1[_0x4272d5(0xde)])(_0x39fe88,_0x47c603);if(!(0x0,lodash_1['isNil'])(_0x579a8a['fileListId']))try{const _0x30db7e=path_1[_0x4272d5(0x15e)][_0x4272d5(0xeb)](__dirname,_0x4272d5(0x161),'public',_0x4272d5(0x12b)+_0x579a8a['companyId']),_0xce58c2=await(0x0,ShowService_1[_0x4272d5(0x15e)])(_0x579a8a[_0x4272d5(0x123)],_0x579a8a[_0x4272d5(0x139)]),_0xa2c73a=path_1[_0x4272d5(0x15e)][_0x4272d5(0xeb)](_0x30db7e,_0x4272d5(0x13b),String(_0xce58c2['id']));for(const [_0x3edbe9,_0x18fc61]of _0xce58c2['options'][_0x4272d5(0xfc)]()){const _0x54cc51=await(0x0,SendWhatsAppMedia_1[_0x4272d5(0x10f)])(_0x18fc61[_0x4272d5(0xe7)],path_1[_0x4272d5(0x15e)][_0x4272d5(0xeb)](_0xa2c73a,_0x18fc61['path']),_0x18fc61[_0x4272d5(0x147)],_0x579a8a[_0x4272d5(0x139)]);await _0x39fe88[_0x4272d5(0x172)](_0x47c603,{..._0x54cc51});}}catch(_0x45eb0e){logger_1['logger'][_0x4272d5(0xdd)](_0x45eb0e);}if(_0x579a8a[_0x4272d5(0x113)]){const _0x1a1233=path_1[_0x4272d5(0x15e)]['resolve'](__dirname,_0x4272d5(0x161),_0x4272d5(0x15d),_0x4272d5(0x12b)+_0x579a8a[_0x4272d5(0x139)]),_0x41796b=path_1[_0x4272d5(0x15e)][_0x4272d5(0xd1)](_0x1a1233,_0x579a8a[_0x4272d5(0x113)]),_0x2746e3=await(0x0,SendWhatsAppMedia_1[_0x4272d5(0x10f)])(_0x579a8a['mediaName'],_0x41796b,_0x3f7f5b,_0x579a8a[_0x4272d5(0x139)]);Object[_0x4272d5(0xed)](_0x2746e3)[_0x4272d5(0x12e)]&&await _0x39fe88['sendMessage'](_0x47c603,{..._0x2746e3});}else _0x579a8a[_0x4272d5(0x106)]&&_0x1b95d5[_0x4272d5(0x106)]===null?(await _0x39fe88[_0x4272d5(0x172)](_0x47c603,{'text':_0x3f7f5b}),await _0x1b95d5[_0x4272d5(0xfd)]({'confirmationRequestedAt':(0x0,moment_1['default'])()})):await _0x39fe88[_0x4272d5(0x172)](_0x47c603,{'text':_0x3f7f5b});await _0x1b95d5[_0x4272d5(0xfd)]({'deliveredAt':(0x0,moment_1[_0x4272d5(0x15e)])()}),await this[_0x4272d5(0x118)](_0x579a8a);const _0x5a1267=(0x0,socket_1['getIO'])();_0x5a1267['to'](_0x4272d5(0xf5)+_0x579a8a[_0x4272d5(0x139)]+_0x4272d5(0x16c))['emit'](_0x4272d5(0xf5)+_0x579a8a['companyId']+'-campaign',{'action':_0x4272d5(0xfd),'record':_0x579a8a}),logger_1[_0x4272d5(0xd0)][_0x4272d5(0xdd)](_0x4272d5(0x133)+_0x5e5919+_0x4272d5(0x124)+_0x1b95d5['contact'][_0x4272d5(0x147)]);}catch(_0xd1f5ba){Sentry[_0x4272d5(0x116)](_0xd1f5ba),logger_1[_0x4272d5(0xd0)][_0x4272d5(0xda)](_0xd1f5ba['message']);}}[a572_0xd8bf61(0xe1)](_0x3d8894){const _0x57915c=a572_0xd8bf61,_0x2e66a5=[];return!(0x0,lodash_1[_0x57915c(0x120)])(_0x3d8894['message1'])&&!(0x0,lodash_1[_0x57915c(0x164)])(_0x3d8894[_0x57915c(0x101)])&&_0x2e66a5[_0x57915c(0xe0)](_0x3d8894[_0x57915c(0x101)]),!(0x0,lodash_1[_0x57915c(0x120)])(_0x3d8894['message2'])&&!(0x0,lodash_1[_0x57915c(0x164)])(_0x3d8894[_0x57915c(0x13d)])&&_0x2e66a5[_0x57915c(0xe0)](_0x3d8894[_0x57915c(0x13d)]),!(0x0,lodash_1[_0x57915c(0x120)])(_0x3d8894[_0x57915c(0x10c)])&&!(0x0,lodash_1[_0x57915c(0x164)])(_0x3d8894[_0x57915c(0x10c)])&&_0x2e66a5['push'](_0x3d8894[_0x57915c(0x10c)]),!(0x0,lodash_1['isEmpty'])(_0x3d8894['message4'])&&!(0x0,lodash_1['isNil'])(_0x3d8894[_0x57915c(0x160)])&&_0x2e66a5[_0x57915c(0xe0)](_0x3d8894['message4']),!(0x0,lodash_1['isEmpty'])(_0x3d8894[_0x57915c(0x144)])&&!(0x0,lodash_1[_0x57915c(0x164)])(_0x3d8894[_0x57915c(0x144)])&&_0x2e66a5['push'](_0x3d8894[_0x57915c(0x144)]),_0x2e66a5;}[a572_0xd8bf61(0xf9)](_0x2286b0,_0x291604,_0x38af67){const _0x5763fc=a572_0xd8bf61;let _0x3f23d=_0x2286b0;return _0x3f23d[_0x5763fc(0xd9)](_0x5763fc(0x170))&&(_0x3f23d=_0x3f23d['replace'](/{nome}/g,_0x38af67['name'])),_0x3f23d[_0x5763fc(0xd9)]('{email}')&&(_0x3f23d=_0x3f23d[_0x5763fc(0x119)](/{email}/g,_0x38af67[_0x5763fc(0xf2)])),_0x3f23d[_0x5763fc(0xd9)]('{numero}')&&(_0x3f23d=_0x3f23d[_0x5763fc(0x119)](/{numero}/g,_0x38af67[_0x5763fc(0x130)])),_0x291604['forEach'](_0x59bd38=>{const _0x4ec63d=_0x5763fc;if(_0x3f23d[_0x4ec63d(0xd9)]('{'+_0x59bd38[_0x4ec63d(0x127)]+'}')){const _0x55fd97=new RegExp('{'+_0x59bd38['key']+'}','g');_0x3f23d=_0x3f23d['replace'](_0x55fd97,_0x59bd38[_0x4ec63d(0x171)]);}}),_0x3f23d;}async['getSettings'](_0x3d1e1d){const _0x267a1b=a572_0xd8bf61,_0x130dd3=await CampaignSetting_1['default'][_0x267a1b(0x10d)]({'where':{'companyId':_0x3d1e1d['companyId']},'attributes':['key',_0x267a1b(0x171)]});let _0x39cb88=0x14,_0x23349a=0x14,_0x3dba2b=0x3c,_0x278270=[];return _0x130dd3[_0x267a1b(0x15c)](_0x343044=>{const _0x59cee9=_0x267a1b;_0x343044['key']===_0x59cee9(0x10b)&&(_0x39cb88=JSON[_0x59cee9(0x137)](_0x343044[_0x59cee9(0x171)])),_0x343044[_0x59cee9(0x127)]==='longerIntervalAfter'&&(_0x23349a=JSON[_0x59cee9(0x137)](_0x343044['value'])),_0x343044['key']===_0x59cee9(0x14d)&&(_0x3dba2b=JSON[_0x59cee9(0x137)](_0x343044['value'])),_0x343044[_0x59cee9(0x127)]===_0x59cee9(0x142)&&(_0x278270=JSON[_0x59cee9(0x137)](_0x343044[_0x59cee9(0x171)]));}),{'messageInterval':_0x39cb88,'longerIntervalAfter':_0x23349a,'greaterInterval':_0x3dba2b,'variables':_0x278270};}async['handleProcessCampaign'](_0x1451a1){const _0x158bff=a572_0xd8bf61;try{const {id:_0x5d5255}=_0x1451a1[_0x158bff(0xea)],_0x4c305c=await this[_0x158bff(0xec)](_0x5d5255),_0x5be311=await this['getSettings'](_0x4c305c);if(!_0x4c305c)throw new sequelize_1[(_0x158bff(0x138))]('Campaign\x20not\x20found');if(!_0x4c305c[_0x158bff(0x166)]||!_0x4c305c[_0x158bff(0x166)]['contacts'])throw new sequelize_1['Error'](_0x158bff(0x148));if(_0x4c305c){const {contacts:_0x43604c}=_0x4c305c[_0x158bff(0x166)];if((0x0,lodash_1[_0x158bff(0xd8)])(_0x43604c)){const _0x599125=_0x43604c[_0x158bff(0xdf)](_0x43858e=>({'contactId':_0x43858e['id'],'campaignId':_0x4c305c['id'],'variables':_0x5be311[_0x158bff(0x142)]})),_0x49684c=(0x0,queues_1['parseToMilliseconds'])(_0x5be311[_0x158bff(0x141)]),_0x3c5f8a=(0x0,queues_1[_0x158bff(0xe6)])(_0x5be311['greaterInterval']),_0x1d01b3=_0x5be311['messageInterval'];let _0x1b0f0c=_0x4c305c[_0x158bff(0x11f)];const _0x2e7367=[];for(let _0x5b56aa=0x0;_0x5b56aa<_0x599125[_0x158bff(0x12e)];_0x5b56aa++){_0x1b0f0c=(0x0,date_fns_1[_0x158bff(0x169)])(_0x1b0f0c,_0x5b56aa>_0x49684c?_0x3c5f8a:_0x1d01b3);const {contactId:_0x5582aa,campaignId:_0x590a3b,variables:_0x19018d}=_0x599125[_0x5b56aa],_0x414bae=this['calculateDelay'](_0x5b56aa,_0x1b0f0c,_0x49684c,_0x3c5f8a,_0x1d01b3),_0x53e222=queues_1[_0x158bff(0xd5)][_0x158bff(0x14b)](_0x158bff(0x126),{'contactId':_0x5582aa,'campaignId':_0x590a3b,'variables':_0x19018d,'delay':_0x414bae+(0x0,queues_1[_0x158bff(0x11c)])(0x64,0x5dc)},{'removeOnComplete':!![]});_0x2e7367[_0x158bff(0xe0)](_0x53e222),logger_1[_0x158bff(0xd0)][_0x158bff(0xdd)](_0x158bff(0x129)+_0x4c305c['id']+_0x158bff(0x124)+_0x43604c[_0x5b56aa][_0x158bff(0x147)]+_0x158bff(0x11b)+_0x414bae);}await Promise['all'](_0x2e7367),await _0x4c305c[_0x158bff(0xfd)]({'status':'EM_ANDAMENTO'});}}}catch(_0x3327e9){logger_1[_0x158bff(0xd0)][_0x158bff(0xda)](_0x3327e9),Sentry[_0x158bff(0x116)](_0x3327e9);}}async[a572_0xd8bf61(0xec)](_0x3a8f93){const _0x5de956=a572_0xd8bf61,_0x2b334d=await Campaign_1[_0x5de956(0x15e)][_0x5de956(0x110)](_0x3a8f93,{'include':[{'model':ContactList_1[_0x5de956(0x15e)],'as':_0x5de956(0x166),'attributes':['id',_0x5de956(0x147)],'include':[{'model':ContactListItem_1['default'],'as':_0x5de956(0x109),'attributes':['id','name','number',_0x5de956(0xf2),_0x5de956(0x16f)],'where':{'isWhatsappValid':!![]}}]},{'model':Whatsapp_1[_0x5de956(0x15e)],'as':'whatsapp','attributes':['id',_0x5de956(0x147)]},{'model':CampaignShipping_1['default'],'as':'shipping','include':[{'model':ContactListItem_1['default'],'as':_0x5de956(0xf7)}]}]});if(!_0x2b334d||!_0x2b334d[_0x5de956(0x166)])throw new sequelize_1[(_0x5de956(0x138))](_0x5de956(0x13c));return _0x2b334d;}async[a572_0xd8bf61(0x140)](_0x5d6bca){const _0x2d58fd=a572_0xd8bf61,_0x25b135=new Date(new Date()[_0x2d58fd(0xfe)]()+0x3c*0x3c*0x3e8);let _0x355e58=await Campaign_1[_0x2d58fd(0x15e)][_0x2d58fd(0x10d)]({'where':{'scheduledAt':{[sequelize_1['Op'][_0x2d58fd(0x132)]]:+_0x25b135},'status':_0x2d58fd(0x15b)},'attributes':['id',_0x2d58fd(0x11f)]});if(_0x355e58[_0x2d58fd(0x12e)]>0x0)logger_1['logger'][_0x2d58fd(0xdd)](_0x2d58fd(0x16e)+_0x355e58['length']);for(let _0x1375fa of _0x355e58){try{const _0x3a53c4=(0x0,moment_1['default'])(),_0x3c881b=(0x0,moment_1['default'])(_0x1375fa[_0x2d58fd(0x11f)]),_0x546af0=_0x3c881b[_0x2d58fd(0x149)](_0x3a53c4,_0x2d58fd(0x12f));logger_1['logger'][_0x2d58fd(0xdd)](_0x2d58fd(0x15a)+_0x1375fa['id']+_0x2d58fd(0x10e)+_0x546af0);const _0x4fc405=await this[_0x2d58fd(0xec)](_0x1375fa['id']);if(!_0x4fc405[_0x2d58fd(0x166)]||!_0x4fc405[_0x2d58fd(0x166)]['contacts'])throw new sequelize_1[(_0x2d58fd(0x138))](_0x2d58fd(0x148));await queues_1[_0x2d58fd(0xd5)]['add'](_0x2d58fd(0x155),{'id':_0x1375fa['id'],'delay':_0x546af0},{'delay':_0x546af0,'removeOnComplete':!![]});}catch(_0x381de8){return Sentry['captureException'](_0x381de8),Promise[_0x2d58fd(0x157)](new sequelize_1[(_0x2d58fd(0x138))](_0x381de8));}}return Promise[_0x2d58fd(0xeb)]({'count':_0x355e58[_0x2d58fd(0x12e)]});}}exports[a572_0xd8bf61(0x15e)]=CampaingJob;