const a575_0x2725ee=a575_0x449a;(function(_0x35d296,_0x4dfcbe){const _0x6b3799=a575_0x449a,_0x5c5699=_0x35d296();while(!![]){try{const _0x36c418=parseInt(_0x6b3799(0x105))/0x1*(parseInt(_0x6b3799(0x106))/0x2)+-parseInt(_0x6b3799(0x138))/0x3+-parseInt(_0x6b3799(0xe0))/0x4+-parseInt(_0x6b3799(0x162))/0x5+-parseInt(_0x6b3799(0x10e))/0x6*(-parseInt(_0x6b3799(0xe2))/0x7)+-parseInt(_0x6b3799(0x146))/0x8*(-parseInt(_0x6b3799(0x10f))/0x9)+parseInt(_0x6b3799(0x11a))/0xa;if(_0x36c418===_0x4dfcbe)break;else _0x5c5699['push'](_0x5c5699['shift']());}catch(_0x9df4c4){_0x5c5699['push'](_0x5c5699['shift']());}}}(a575_0x18d3,0x1a00b));const a575_0xb67a55=(function(){let _0x35a3a9=!![];return function(_0xe6e7c0,_0x29162f){const _0x2a9ad3=_0x35a3a9?function(){const _0x2a4d85=a575_0x449a;if(_0x29162f){const _0x5cd322=_0x29162f[_0x2a4d85(0xdb)](_0xe6e7c0,arguments);return _0x29162f=null,_0x5cd322;}}:function(){};return _0x35a3a9=![],_0x2a9ad3;};}()),a575_0x131c80=a575_0xb67a55(this,function(){const _0x2e189e=a575_0x449a;return a575_0x131c80[_0x2e189e(0x160)]()['search'](_0x2e189e(0x104))[_0x2e189e(0x160)]()['constructor'](a575_0x131c80)['search'](_0x2e189e(0x104));});a575_0x131c80();'use strict';function a575_0x449a(_0x552676,_0x10231b){const _0x4d0b50=a575_0x18d3();return a575_0x449a=function(_0x131c80,_0xb67a55){_0x131c80=_0x131c80-0xd9;let _0x18d30a=_0x4d0b50[_0x131c80];return _0x18d30a;},a575_0x449a(_0x552676,_0x10231b);}var __createBinding=this&&this[a575_0x2725ee(0x171)]||(Object[a575_0x2725ee(0x113)]?function(_0x58e5f1,_0x5ad92d,_0x422c4c,_0x52c95e){const _0x2a71f1=a575_0x2725ee;if(_0x52c95e===undefined)_0x52c95e=_0x422c4c;var _0x20bac4=Object[_0x2a71f1(0xf5)](_0x5ad92d,_0x422c4c);(!_0x20bac4||(_0x2a71f1(0x161)in _0x20bac4?!_0x5ad92d['__esModule']:_0x20bac4[_0x2a71f1(0x11b)]||_0x20bac4['configurable']))&&(_0x20bac4={'enumerable':!![],'get':function(){return _0x5ad92d[_0x422c4c];}}),Object[_0x2a71f1(0x11c)](_0x58e5f1,_0x52c95e,_0x20bac4);}:function(_0x3fab04,_0x4a3381,_0x4c4907,_0x1cca80){if(_0x1cca80===undefined)_0x1cca80=_0x4c4907;_0x3fab04[_0x1cca80]=_0x4a3381[_0x4c4907];}),__setModuleDefault=this&&this[a575_0x2725ee(0x14b)]||(Object[a575_0x2725ee(0x113)]?function(_0x135f7d,_0x3e51cd){const _0x386614=a575_0x2725ee;Object['defineProperty'](_0x135f7d,_0x386614(0x11e),{'enumerable':!![],'value':_0x3e51cd});}:function(_0x259e6f,_0x410a68){const _0x29db1c=a575_0x2725ee;_0x259e6f[_0x29db1c(0x11e)]=_0x410a68;}),__importStar=this&&this[a575_0x2725ee(0x151)]||function(_0x47e744){const _0x17dd6e=a575_0x2725ee;if(_0x47e744&&_0x47e744[_0x17dd6e(0xe6)])return _0x47e744;var _0x16feee={};if(_0x47e744!=null){for(var _0x344469 in _0x47e744)if(_0x344469!==_0x17dd6e(0x11e)&&Object['prototype']['hasOwnProperty'][_0x17dd6e(0x15e)](_0x47e744,_0x344469))__createBinding(_0x16feee,_0x47e744,_0x344469);}return __setModuleDefault(_0x16feee,_0x47e744),_0x16feee;},__importDefault=this&&this[a575_0x2725ee(0xfa)]||function(_0x4c0b2a){const _0x1d60a3=a575_0x2725ee;return _0x4c0b2a&&_0x4c0b2a[_0x1d60a3(0xe6)]?_0x4c0b2a:{'default':_0x4c0b2a};};function a575_0x18d3(){const _0xc139fa=['lte','DispatchCampaign','variables','options','handleVerifyCampaigns','getSettings','value','216069QUJZRf','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20whatsapp\x20not\x20found','{nome}','findOrCreate','message','FINALIZADA','contact','../..','getMessageOptions','keys','not','Job\x20','Error\x20sending\x20campaign\x20media:\x20','handleDispatchCampaign','1274088apIWSn','PROGRAMADA','lodash','getContact','deliveredAt','__setModuleDefault','fileList','messageInterval','email','company','ProcessCampaign','__importStar','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20user\x20not\x20found','info','forEach','emit','Worker','campaignQueue','scheduledAt','Error','ContactList\x20not\x20found\x20or\x20empty','completed','message3','../models/CampaignSetting','call','name','toString','get','371755UfpJMF','handlePrepareContact','SendPresenceStatus','fileListId','contactId','Campanhas\x20encontradas:\x20','message4',';Contato=','message1','milliseconds','../helpers/SendPresenceStatus','\x20failed\x20with\x20error:\x20','getCampaign',')\x20completed','Campanha\x20enviada\x20para:\x20Campanha=','__createBinding','Error\x20sending\x20campaign\x20files:\x20','../models/CampaignShipping','apply','{email}','Campanha\x20enviada\x20para\x20a\x20fila\x20de\x20processamento:\x20Campanha=','data','public','686980rUluZE','randomValue','1301426twsmdP','update','contacts','message2','__esModule','reject','campaignId','push','greaterInterval','calculateDelay','companyId','campaignQueue\x20->\x20DispatchCampaign\x20->\x20error:\x20wbot\x20not\x20found','message5','path','resolve','parse','../queues','../models/ContactList','replace','getOwnPropertyDescriptor','-mainchannel','getTime','add','Disparo\x20de\x20campanha\x20solicitado:\x20Campanha=','__importDefault','@sentry/node','count','mediaPath','findAll','verifyAndFinalizeCampaign','contactList','whatsapp','captureException','differenceInSeconds','(((.+)+)+)+$','1nrSwqJ','90922dmSfEw','logger','../services/FileServices/ShowService','save','../models/Campaign','isArray','key','longerIntervalAfter','6UXffEU','9tTcCbs','sendMessage','Registro\x20enviado\x20pra\x20fila\x20de\x20disparo:\x20Campanha=','includes','create','addSeconds','campaign.contactList\x20is\x20null\x20or\x20undefined','getCampaignValidMessages','handleProcessCampaign','isEmpty','join','339860GZaBOj','writable','defineProperty','../libs/socket','default','error','../utils/logger','isWhatsappValid','getProcessedMessage','company-','user','isNil','mediaName','parseToMilliseconds','length','-campaign','getIO','number','PrepareContact','Campaign\x20or\x20ContactList\x20not\x20found','findByPk','map','date-fns'];a575_0x18d3=function(){return _0xc139fa;};return a575_0x18d3();}Object[a575_0x2725ee(0x11c)](exports,a575_0x2725ee(0xe6),{'value':!![]});const bullmq_1=require('bullmq'),Campaign_1=__importDefault(require(a575_0x2725ee(0x10a))),sequelize_1=require('sequelize'),logger_1=require(a575_0x2725ee(0x120)),moment_1=__importDefault(require('moment/moment')),Sentry=__importStar(require(a575_0x2725ee(0xfb))),ContactList_1=__importDefault(require(a575_0x2725ee(0xf3))),ContactListItem_1=__importDefault(require('../models/ContactListItem')),Whatsapp_1=__importDefault(require('../models/Whatsapp')),CampaignShipping_1=__importDefault(require(a575_0x2725ee(0xda))),queues_1=require(a575_0x2725ee(0xf2)),lodash_1=require(a575_0x2725ee(0x148)),date_fns_1=require(a575_0x2725ee(0x130)),GetWhatsappWbot_1=__importDefault(require('../helpers/GetWhatsappWbot')),path_1=__importDefault(require(a575_0x2725ee(0xef))),ShowService_1=__importDefault(require(a575_0x2725ee(0x108))),SendWhatsAppMedia_1=require('../services/WbotServices/SendWhatsAppMedia'),socket_1=require(a575_0x2725ee(0x11d)),CampaignSetting_1=__importDefault(require(a575_0x2725ee(0x15d))),SendPresenceStatus_1=require(a575_0x2725ee(0x16c));class CampaingJob{constructor(_0x37a93b,_0x5a7b4d){const _0x3a310f=a575_0x2725ee,_0x24c6b1=new bullmq_1[(_0x3a310f(0x156))](_0x37a93b,async _0x5e99d7=>{const _0x8cc61a=_0x3a310f;if(_0x5e99d7[_0x8cc61a(0x15f)]==='VerifyCampaigns')await this[_0x8cc61a(0x135)](_0x5e99d7);else{if(_0x5e99d7['name']===_0x8cc61a(0x150))await this['handleProcessCampaign'](_0x5e99d7);else{if(_0x5e99d7[_0x8cc61a(0x15f)]===_0x8cc61a(0x12c))await this['handlePrepareContact'](_0x5e99d7);else _0x5e99d7[_0x8cc61a(0x15f)]===_0x8cc61a(0x132)&&await this['handleDispatchCampaign'](_0x5e99d7);}}},{'maxStalledCount':0xa,'useWorkerThreads':![],'concurrency':0x64,'connection':_0x5a7b4d,'removeOnFail':{'count':0x0}});_0x24c6b1['on'](_0x3a310f(0x15b),async _0x12e6f7=>{const _0x192d79=_0x3a310f;logger_1['logger']['info'](_0x192d79(0x143)+_0x12e6f7[_0x192d79(0x15f)]+'\x20('+_0x12e6f7['id']+_0x192d79(0x16f));}),_0x24c6b1['on']('failed',async(_0x574393,_0x46194b)=>{const _0x301de0=_0x3a310f;logger_1['logger'][_0x301de0(0x11f)](_0x301de0(0x143)+_0x574393['name']+_0x301de0(0x16d)+_0x46194b[_0x301de0(0x13c)]);});}async[a575_0x2725ee(0x149)](_0x489c34){const _0x5d5529=a575_0x2725ee;return ContactListItem_1[_0x5d5529(0x11e)]['findByPk'](_0x489c34,{'attributes':['id','name','number',_0x5d5529(0x14e)]});}async[a575_0x2725ee(0x163)](_0x257829){const _0x336425=a575_0x2725ee;try{const {contactId:_0x7243ee,campaignId:_0x33ee5e,delay:_0x2ba03e,variables:_0x5bf6f6}=_0x257829['data'],_0x113c68=await this[_0x336425(0x16e)](_0x33ee5e),_0x2c59cc=await this[_0x336425(0x149)](_0x7243ee),_0x297347={};_0x297347[_0x336425(0x12b)]=_0x2c59cc['number'],_0x297347[_0x336425(0x166)]=_0x7243ee,_0x297347[_0x336425(0xe8)]=_0x33ee5e;const _0x1d7daa=this[_0x336425(0x116)](_0x113c68);if(_0x1d7daa[_0x336425(0x128)]){const _0x47abd9=(0x0,queues_1[_0x336425(0xe1)])(0x0,_0x1d7daa[_0x336425(0x128)]),_0x5883e6=this[_0x336425(0x122)](_0x1d7daa[_0x47abd9],_0x5bf6f6,_0x2c59cc);_0x297347[_0x336425(0x13c)]='â€Œ\x20'+_0x5883e6;}const [_0x516feb,_0x104e0c]=await CampaignShipping_1[_0x336425(0x11e)][_0x336425(0x13b)]({'where':{'campaignId':_0x297347['campaignId'],'contactId':_0x297347[_0x336425(0x166)]},'defaults':_0x297347});!_0x104e0c&&_0x516feb[_0x336425(0x14a)]===null&&(_0x516feb['set'](_0x297347),await _0x516feb[_0x336425(0x109)]());if(_0x516feb['deliveredAt']===null){const _0x1d4278=await queues_1[_0x336425(0x157)]['add'](_0x336425(0x132),{'campaignId':_0x113c68['id'],'campaignShippingId':_0x516feb['id'],'contactListItemId':_0x7243ee},{'removeOnComplete':!![],'delay':_0x2ba03e});await _0x516feb[_0x336425(0xe3)]({'jobId':_0x1d4278['id']});}await this[_0x336425(0xff)](_0x113c68);}catch(_0x4a70a9){Sentry[_0x336425(0x102)](_0x4a70a9),logger_1[_0x336425(0x107)][_0x336425(0x11f)]('campaignQueue\x20->\x20PrepareContact\x20->\x20error:\x20'+_0x4a70a9[_0x336425(0x13c)]);}}async[a575_0x2725ee(0xff)](_0x2f4f91){const _0x2d200b=a575_0x2725ee;if(!_0x2f4f91['contactList'])throw new sequelize_1['Error'](_0x2d200b(0x115));const {contacts:_0x463299}=_0x2f4f91['contactList'],_0x4b813d=_0x463299['length'],_0x26bee3=await CampaignShipping_1[_0x2d200b(0x11e)][_0x2d200b(0xfc)]({'where':{'campaignId':_0x2f4f91['id'],'deliveredAt':{[sequelize_1['Op'][_0x2d200b(0x142)]]:null}}});_0x4b813d===_0x26bee3&&await _0x2f4f91['update']({'status':_0x2d200b(0x13d),'completedAt':(0x0,moment_1[_0x2d200b(0x11e)])()});const _0xb393c5=(0x0,socket_1[_0x2d200b(0x12a)])();_0xb393c5['to'](_0x2d200b(0x123)+_0x2f4f91[_0x2d200b(0xec)]+_0x2d200b(0xf6))[_0x2d200b(0x155)]('company-'+_0x2f4f91['companyId']+'-campaign',{'action':_0x2d200b(0xe3),'record':_0x2f4f91});}[a575_0x2725ee(0xeb)](_0x519b6f,_0x27e731,_0x3d8ae6,_0x3741ed,_0x1851a0){const _0x5bd54a=a575_0x2725ee,_0x4902d8=(0x0,date_fns_1[_0x5bd54a(0x103)])(_0x27e731,new Date());return _0x519b6f>_0x3d8ae6?_0x4902d8*0x3e8+_0x3741ed:_0x4902d8*0x3e8+_0x1851a0;}async[a575_0x2725ee(0x145)](_0x1764f1){const _0x1f7dc7=a575_0x2725ee;try{const {data:_0x4c212f}=_0x1764f1,{campaignShippingId:_0x4bc04a,campaignId:_0x2c985c}=_0x4c212f,_0x383249=await this[_0x1f7dc7(0x16e)](_0x2c985c),_0x268bed=await(0x0,GetWhatsappWbot_1[_0x1f7dc7(0x11e)])(_0x383249[_0x1f7dc7(0x101)]);if(!_0x268bed){logger_1[_0x1f7dc7(0x107)][_0x1f7dc7(0x11f)](_0x1f7dc7(0xed));return;}if(!_0x383249[_0x1f7dc7(0x101)]){logger_1[_0x1f7dc7(0x107)][_0x1f7dc7(0x11f)](_0x1f7dc7(0x139));return;}if(!_0x268bed?.[_0x1f7dc7(0x124)]?.['id']){logger_1[_0x1f7dc7(0x107)]['error'](_0x1f7dc7(0x152));return;}logger_1[_0x1f7dc7(0x107)][_0x1f7dc7(0x153)](_0x1f7dc7(0xf9)+_0x2c985c+';Registro='+_0x4bc04a);const _0x432c20=await CampaignShipping_1[_0x1f7dc7(0x11e)][_0x1f7dc7(0x12e)](_0x4bc04a,{'include':[{'model':ContactListItem_1[_0x1f7dc7(0x11e)],'as':_0x1f7dc7(0x13e)}]}),_0x2f3a9d=_0x432c20['number']+'@s.whatsapp.net';let _0x542536=_0x432c20[_0x1f7dc7(0x13c)]['trimEnd']()['trimStart']();const _0x6d8ce2=await _0x268bed['sendMessage'](_0x2f3a9d,{'text':_0x542536});await _0x432c20[_0x1f7dc7(0xe3)]({'messageId':_0x6d8ce2[_0x1f7dc7(0x10c)]['id'],'deliveredAt':(0x0,moment_1[_0x1f7dc7(0x11e)])()}),await(0x0,SendPresenceStatus_1[_0x1f7dc7(0x164)])(_0x268bed,_0x2f3a9d);if(!(0x0,lodash_1[_0x1f7dc7(0x125)])(_0x383249[_0x1f7dc7(0x165)]))try{const _0x2df528=path_1[_0x1f7dc7(0x11e)][_0x1f7dc7(0xf0)](__dirname,'../..',_0x1f7dc7(0xdf),_0x1f7dc7(0x14f)+_0x383249[_0x1f7dc7(0xec)]),_0x361796=await(0x0,ShowService_1[_0x1f7dc7(0x11e)])(_0x383249[_0x1f7dc7(0x165)],_0x383249[_0x1f7dc7(0xec)]),_0x4f2963=path_1['default'][_0x1f7dc7(0xf0)](_0x2df528,_0x1f7dc7(0x14c),String(_0x361796['id']));for(const _0x21d85c of _0x361796[_0x1f7dc7(0x134)]){const _0x43d38f=await(0x0,SendWhatsAppMedia_1['getMessageOptions'])(_0x21d85c['path'],path_1[_0x1f7dc7(0x11e)]['resolve'](_0x4f2963,_0x21d85c['path']),_0x21d85c['name'],_0x383249[_0x1f7dc7(0xec)]);await _0x268bed[_0x1f7dc7(0x110)](_0x2f3a9d,{..._0x43d38f});}}catch(_0x347882){logger_1[_0x1f7dc7(0x107)][_0x1f7dc7(0x11f)](_0x1f7dc7(0xd9)+_0x347882);}if(_0x383249[_0x1f7dc7(0xfd)])try{const _0xa82810=path_1[_0x1f7dc7(0x11e)][_0x1f7dc7(0xf0)](__dirname,_0x1f7dc7(0x13f),_0x1f7dc7(0xdf),_0x1f7dc7(0x14f)+_0x383249[_0x1f7dc7(0xec)]),_0x26b44a=path_1[_0x1f7dc7(0x11e)][_0x1f7dc7(0x119)](_0xa82810,_0x383249[_0x1f7dc7(0xfd)]),_0x50753a=await(0x0,SendWhatsAppMedia_1[_0x1f7dc7(0x140)])(_0x383249[_0x1f7dc7(0x126)],_0x26b44a,_0x542536,_0x383249[_0x1f7dc7(0xec)]);Object[_0x1f7dc7(0x141)](_0x50753a)[_0x1f7dc7(0x128)]&&await _0x268bed[_0x1f7dc7(0x110)](_0x2f3a9d,{..._0x50753a});}catch(_0x59c593){logger_1['logger'][_0x1f7dc7(0x11f)](_0x1f7dc7(0x144)+_0x59c593);}await this['verifyAndFinalizeCampaign'](_0x383249);const _0x32d0ed=(0x0,socket_1[_0x1f7dc7(0x12a)])();_0x32d0ed['to'](_0x1f7dc7(0x123)+_0x383249[_0x1f7dc7(0xec)]+'-mainchannel')[_0x1f7dc7(0x155)](_0x1f7dc7(0x123)+_0x383249['companyId']+_0x1f7dc7(0x129),{'action':'update','record':_0x383249}),logger_1['logger']['info'](_0x1f7dc7(0x170)+_0x2c985c+_0x1f7dc7(0x169)+_0x432c20[_0x1f7dc7(0x13e)][_0x1f7dc7(0x15f)]);}catch(_0x238976){Sentry[_0x1f7dc7(0x102)](_0x238976),logger_1['logger'][_0x1f7dc7(0x11f)](_0x238976[_0x1f7dc7(0x13c)]);}}[a575_0x2725ee(0x116)](_0x437d95){const _0xe27bb1=a575_0x2725ee,_0x3e504a=[];return!(0x0,lodash_1[_0xe27bb1(0x118)])(_0x437d95[_0xe27bb1(0x16a)])&&!(0x0,lodash_1[_0xe27bb1(0x125)])(_0x437d95[_0xe27bb1(0x16a)])&&_0x3e504a['push'](_0x437d95[_0xe27bb1(0x16a)]),!(0x0,lodash_1[_0xe27bb1(0x118)])(_0x437d95[_0xe27bb1(0xe5)])&&!(0x0,lodash_1[_0xe27bb1(0x125)])(_0x437d95[_0xe27bb1(0xe5)])&&_0x3e504a[_0xe27bb1(0xe9)](_0x437d95['message2']),!(0x0,lodash_1['isEmpty'])(_0x437d95[_0xe27bb1(0x15c)])&&!(0x0,lodash_1[_0xe27bb1(0x125)])(_0x437d95[_0xe27bb1(0x15c)])&&_0x3e504a[_0xe27bb1(0xe9)](_0x437d95[_0xe27bb1(0x15c)]),!(0x0,lodash_1['isEmpty'])(_0x437d95[_0xe27bb1(0x168)])&&!(0x0,lodash_1[_0xe27bb1(0x125)])(_0x437d95['message4'])&&_0x3e504a[_0xe27bb1(0xe9)](_0x437d95[_0xe27bb1(0x168)]),!(0x0,lodash_1[_0xe27bb1(0x118)])(_0x437d95[_0xe27bb1(0xee)])&&!(0x0,lodash_1[_0xe27bb1(0x125)])(_0x437d95[_0xe27bb1(0xee)])&&_0x3e504a[_0xe27bb1(0xe9)](_0x437d95[_0xe27bb1(0xee)]),_0x3e504a;}[a575_0x2725ee(0x122)](_0x26b9af,_0x53f3b7,_0xd69006){const _0x42183b=a575_0x2725ee;let _0x2412fd=_0x26b9af;return _0x2412fd[_0x42183b(0x112)](_0x42183b(0x13a))&&(_0x2412fd=_0x2412fd[_0x42183b(0xf4)](/{nome}/g,_0xd69006[_0x42183b(0x15f)])),_0x2412fd[_0x42183b(0x112)](_0x42183b(0xdc))&&(_0x2412fd=_0x2412fd[_0x42183b(0xf4)](/{email}/g,_0xd69006['email'])),_0x2412fd[_0x42183b(0x112)]('{numero}')&&(_0x2412fd=_0x2412fd[_0x42183b(0xf4)](/{numero}/g,_0xd69006[_0x42183b(0x12b)])),_0x53f3b7['forEach'](_0x3cc193=>{const _0xfd8ac3=_0x42183b;if(_0x2412fd[_0xfd8ac3(0x112)]('{'+_0x3cc193[_0xfd8ac3(0x10c)]+'}')){const _0x17dda6=new RegExp('{'+_0x3cc193[_0xfd8ac3(0x10c)]+'}','g');_0x2412fd=_0x2412fd['replace'](_0x17dda6,_0x3cc193[_0xfd8ac3(0x137)]);}}),_0x2412fd;}async['getSettings'](_0x5cf3a0){const _0x511b4a=a575_0x2725ee,_0x5b1ce7=await CampaignSetting_1[_0x511b4a(0x11e)][_0x511b4a(0xfe)]({'where':{'companyId':_0x5cf3a0['companyId']},'attributes':[_0x511b4a(0x10c),_0x511b4a(0x137)]});let _0x6bcf30=0x14,_0x54acdd=0x14,_0x3be93c=0x3c,_0x2e09c0=[];return _0x5b1ce7[_0x511b4a(0x154)](_0x3fced0=>{const _0xf5592=_0x511b4a;_0x3fced0['key']==='messageInterval'&&(_0x6bcf30=JSON[_0xf5592(0xf1)](_0x3fced0[_0xf5592(0x137)])),_0x3fced0['key']===_0xf5592(0x10d)&&(_0x54acdd=JSON['parse'](_0x3fced0[_0xf5592(0x137)])),_0x3fced0[_0xf5592(0x10c)]===_0xf5592(0xea)&&(_0x3be93c=JSON['parse'](_0x3fced0[_0xf5592(0x137)])),_0x3fced0[_0xf5592(0x10c)]===_0xf5592(0x133)&&(_0x2e09c0=JSON[_0xf5592(0xf1)](_0x3fced0['value']));}),{'messageInterval':_0x6bcf30,'longerIntervalAfter':_0x54acdd,'greaterInterval':_0x3be93c,'variables':_0x2e09c0};}async[a575_0x2725ee(0x117)](_0x2eaf4a){const _0x121594=a575_0x2725ee;try{const {id:_0xaa9f5d}=_0x2eaf4a[_0x121594(0xde)],_0x4240c8=await this[_0x121594(0x16e)](_0xaa9f5d),_0x3a1171=await this[_0x121594(0x136)](_0x4240c8);if(!_0x4240c8)throw new sequelize_1[(_0x121594(0x159))]('Campaign\x20not\x20found');if(!_0x4240c8[_0x121594(0x100)]||!_0x4240c8[_0x121594(0x100)]['contacts'])throw new sequelize_1['Error']('ContactList\x20not\x20found\x20or\x20empty');if(_0x4240c8){const {contacts:_0x469946}=_0x4240c8[_0x121594(0x100)];if((0x0,lodash_1[_0x121594(0x10b)])(_0x469946)){const _0x379ae9=_0x469946[_0x121594(0x12f)](_0x5c1563=>({'contactId':_0x5c1563['id'],'campaignId':_0x4240c8['id'],'variables':_0x3a1171[_0x121594(0x133)]})),_0x5183a4=(0x0,queues_1[_0x121594(0x127)])(_0x3a1171[_0x121594(0x10d)]),_0xb912ac=(0x0,queues_1[_0x121594(0x127)])(_0x3a1171[_0x121594(0xea)]),_0x950c5f=_0x3a1171[_0x121594(0x14d)];let _0x449884=_0x4240c8['scheduledAt'];const _0x1e1569=[];for(let _0x2f992c=0x0;_0x2f992c<_0x379ae9[_0x121594(0x128)];_0x2f992c++){_0x449884=(0x0,date_fns_1[_0x121594(0x114)])(_0x449884,_0x2f992c>_0x5183a4?_0xb912ac:_0x950c5f);const {contactId:_0x3ffdf2,campaignId:_0x551943,variables:_0x439b84}=_0x379ae9[_0x2f992c],_0x2130c9=this[_0x121594(0xeb)](_0x2f992c,_0x449884,_0x5183a4,_0xb912ac,_0x950c5f),_0x4a8f67=queues_1[_0x121594(0x157)][_0x121594(0xf8)](_0x121594(0x12c),{'contactId':_0x3ffdf2,'campaignId':_0x551943,'variables':_0x439b84,'delay':_0x2130c9+(0x0,queues_1[_0x121594(0xe1)])(0x64,0x5dc)},{'removeOnComplete':!![]});_0x1e1569['push'](_0x4a8f67),logger_1[_0x121594(0x107)][_0x121594(0x153)](_0x121594(0x111)+_0x4240c8['id']+';Contato='+_0x469946[_0x2f992c][_0x121594(0x15f)]+';delay='+_0x2130c9);}await Promise['all'](_0x1e1569),await _0x4240c8[_0x121594(0xe3)]({'status':'EM_ANDAMENTO'});}}}catch(_0x1c0a69){logger_1[_0x121594(0x107)][_0x121594(0x11f)](_0x1c0a69),Sentry[_0x121594(0x102)](_0x1c0a69);}}async[a575_0x2725ee(0x16e)](_0x53d4c8){const _0x474a03=a575_0x2725ee,_0x21214f=await Campaign_1[_0x474a03(0x11e)]['findByPk'](_0x53d4c8,{'include':[{'model':ContactList_1[_0x474a03(0x11e)],'as':_0x474a03(0x100),'attributes':['id','name'],'include':[{'model':ContactListItem_1[_0x474a03(0x11e)],'as':_0x474a03(0xe4),'attributes':['id',_0x474a03(0x15f),_0x474a03(0x12b),_0x474a03(0x14e),_0x474a03(0x121)],'where':{'isWhatsappValid':!![]}}]},{'model':Whatsapp_1['default'],'as':_0x474a03(0x101),'attributes':['id',_0x474a03(0x15f)]},{'model':CampaignShipping_1[_0x474a03(0x11e)],'as':'shipping','include':[{'model':ContactListItem_1[_0x474a03(0x11e)],'as':_0x474a03(0x13e)}]}]});if(!_0x21214f||!_0x21214f['contactList'])throw new sequelize_1[(_0x474a03(0x159))](_0x474a03(0x12d));return _0x21214f;}async[a575_0x2725ee(0x135)](_0x46c3c7){const _0x31a4ea=a575_0x2725ee,_0x5a5a61=new Date(new Date()[_0x31a4ea(0xf7)]()+0x3c*0x3c*0x3e8);let _0x2158b7=await Campaign_1['default'][_0x31a4ea(0xfe)]({'where':{'scheduledAt':{[sequelize_1['Op'][_0x31a4ea(0x131)]]:+_0x5a5a61},'status':_0x31a4ea(0x147)},'attributes':['id',_0x31a4ea(0x158)]});if(_0x2158b7[_0x31a4ea(0x128)]>0x0)logger_1[_0x31a4ea(0x107)][_0x31a4ea(0x153)](_0x31a4ea(0x167)+_0x2158b7[_0x31a4ea(0x128)]);for(let _0x18a8ae of _0x2158b7){try{const _0x76ec38=(0x0,moment_1[_0x31a4ea(0x11e)])(),_0x106a2b=(0x0,moment_1[_0x31a4ea(0x11e)])(_0x18a8ae['scheduledAt']),_0x598bd5=_0x106a2b['diff'](_0x76ec38,_0x31a4ea(0x16b));logger_1['logger'][_0x31a4ea(0x153)](_0x31a4ea(0xdd)+_0x18a8ae['id']+',\x20Delay\x20Inicial='+_0x598bd5);const _0x32df31=await this[_0x31a4ea(0x16e)](_0x18a8ae['id']);if(!_0x32df31[_0x31a4ea(0x100)]||!_0x32df31[_0x31a4ea(0x100)][_0x31a4ea(0xe4)])throw new sequelize_1[(_0x31a4ea(0x159))](_0x31a4ea(0x15a));await queues_1['campaignQueue'][_0x31a4ea(0xf8)](_0x31a4ea(0x150),{'id':_0x18a8ae['id'],'delay':_0x598bd5},{'delay':_0x598bd5,'removeOnComplete':!![]});}catch(_0x36a5fc){return Sentry['captureException'](_0x36a5fc),Promise[_0x31a4ea(0xe7)](new sequelize_1[(_0x31a4ea(0x159))](_0x36a5fc));}}return Promise[_0x31a4ea(0xf0)]({'count':_0x2158b7['length']});}}exports[a575_0x2725ee(0x11e)]=CampaingJob;