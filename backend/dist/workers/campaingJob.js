const a564_0x520310=a564_0x3912;(function(_0xb64405,_0x243c7e){const _0x1aff7a=a564_0x3912,_0x5c60a7=_0xb64405();while(!![]){try{const _0x68e92d=-parseInt(_0x1aff7a(0xf6))/0x1*(-parseInt(_0x1aff7a(0x9e))/0x2)+parseInt(_0x1aff7a(0xf3))/0x3+parseInt(_0x1aff7a(0xb9))/0x4+parseInt(_0x1aff7a(0x90))/0x5*(parseInt(_0x1aff7a(0xb7))/0x6)+parseInt(_0x1aff7a(0x7a))/0x7+-parseInt(_0x1aff7a(0x10d))/0x8+-parseInt(_0x1aff7a(0xdf))/0x9;if(_0x68e92d===_0x243c7e)break;else _0x5c60a7['push'](_0x5c60a7['shift']());}catch(_0x222e57){_0x5c60a7['push'](_0x5c60a7['shift']());}}}(a564_0x26bf,0x41502));const a564_0x329202=(function(){let _0xe6b015=!![];return function(_0x1686d9,_0x24b9dd){const _0xc69c3a=_0xe6b015?function(){const _0x20299b=a564_0x3912;if(_0x24b9dd){const _0x48f940=_0x24b9dd[_0x20299b(0xff)](_0x1686d9,arguments);return _0x24b9dd=null,_0x48f940;}}:function(){};return _0xe6b015=![],_0xc69c3a;};}()),a564_0x1a3cc4=a564_0x329202(this,function(){const _0x30a278=a564_0x3912;return a564_0x1a3cc4[_0x30a278(0xde)]()['search']('(((.+)+)+)+$')[_0x30a278(0xde)]()[_0x30a278(0xd2)](a564_0x1a3cc4)['search']('(((.+)+)+)+$');});a564_0x1a3cc4();'use strict';var __createBinding=this&&this[a564_0x520310(0x103)]||(Object['create']?function(_0x372368,_0x25ab40,_0x40b279,_0x4e64ab){const _0xfcbf4b=a564_0x520310;if(_0x4e64ab===undefined)_0x4e64ab=_0x40b279;var _0x45fc97=Object[_0xfcbf4b(0xef)](_0x25ab40,_0x40b279);(!_0x45fc97||(_0xfcbf4b(0x91)in _0x45fc97?!_0x25ab40[_0xfcbf4b(0xa4)]:_0x45fc97['writable']||_0x45fc97[_0xfcbf4b(0xf0)]))&&(_0x45fc97={'enumerable':!![],'get':function(){return _0x25ab40[_0x40b279];}}),Object['defineProperty'](_0x372368,_0x4e64ab,_0x45fc97);}:function(_0x31c55e,_0x48e487,_0x45fb5e,_0x44a002){if(_0x44a002===undefined)_0x44a002=_0x45fb5e;_0x31c55e[_0x44a002]=_0x48e487[_0x45fb5e];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x5007f9,_0xa42158){const _0x23655a=a564_0x520310;Object[_0x23655a(0x7e)](_0x5007f9,'default',{'enumerable':!![],'value':_0xa42158});}:function(_0xc3379d,_0x360aa7){const _0xb48d5e=a564_0x520310;_0xc3379d[_0xb48d5e(0xb4)]=_0x360aa7;}),__importStar=this&&this[a564_0x520310(0xb3)]||function(_0x1f9464){const _0x2b1c2a=a564_0x520310;if(_0x1f9464&&_0x1f9464['__esModule'])return _0x1f9464;var _0x54755={};if(_0x1f9464!=null){for(var _0x18ef36 in _0x1f9464)if(_0x18ef36!==_0x2b1c2a(0xb4)&&Object[_0x2b1c2a(0xd6)][_0x2b1c2a(0x7c)][_0x2b1c2a(0xf2)](_0x1f9464,_0x18ef36))__createBinding(_0x54755,_0x1f9464,_0x18ef36);}return __setModuleDefault(_0x54755,_0x1f9464),_0x54755;},__importDefault=this&&this['__importDefault']||function(_0x18261){return _0x18261&&_0x18261['__esModule']?_0x18261:{'default':_0x18261};};Object['defineProperty'](exports,a564_0x520310(0xa4),{'value':!![]});const bullmq_1=require(a564_0x520310(0x7d)),Campaign_1=__importDefault(require('../models/Campaign')),sequelize_1=require('sequelize'),logger_1=require(a564_0x520310(0xfe)),moment_1=__importDefault(require('moment/moment')),Sentry=__importStar(require('@sentry/node')),ContactList_1=__importDefault(require('../models/ContactList')),ContactListItem_1=__importDefault(require(a564_0x520310(0xd8))),CampaignShipping_1=__importDefault(require('../models/CampaignShipping')),SendWhatsAppMedia_1=require('../services/WbotServices/SendWhatsAppMedia'),GetWhatsappWbot_1=__importDefault(require(a564_0x520310(0xe3))),SendPresenceStatus_1=require(a564_0x520310(0xe1)),socket_1=require('../libs/socket'),path_1=__importDefault(require(a564_0x520310(0xc3))),ShowService_1=__importDefault(require(a564_0x520310(0xae))),CampaignSetting_1=__importDefault(require('../models/CampaignSetting')),lodash_1=require(a564_0x520310(0x89)),redisConfig={'port':parseInt(process[a564_0x520310(0xcd)][a564_0x520310(0xa8)]||a564_0x520310(0xe8)),'host':process['env']['REDIS_HOST']||'127.0.0.1','password':process[a564_0x520310(0xcd)]['REDIS_PASSWORD']},CAMPAIGN_CONCURRENCY=0x5,DISPATCH_CONCURRENCY=0x1,BATCH_SIZE=0x1,MAX_ATTEMPTS=0x3;class CampaignQueueManager{constructor(_0x540379,_0x34bd48){const _0x6fb825=a564_0x520310,_0x14d391=_0x34bd48||redisConfig;this[_0x6fb825(0x9d)]=new bullmq_1[(_0x6fb825(0xa5))](_0x540379||_0x6fb825(0xce),{'connection':_0x14d391}),this['processingQueue']=new bullmq_1[(_0x6fb825(0xa5))](_0x6fb825(0xd3),{'connection':_0x14d391}),this[_0x6fb825(0x97)]=new bullmq_1['Queue']('dispatch-queue',{'connection':_0x14d391,'defaultJobOptions':{'attempts':MAX_ATTEMPTS,'removeOnComplete':!![],'lifo':![]}}),this[_0x6fb825(0xc9)](_0x14d391);}['getCampaignQueue'](){const _0x4c2746=a564_0x520310;return this[_0x4c2746(0x9d)];}[a564_0x520310(0xd5)](){return this['processingQueue'];}[a564_0x520310(0x101)](){return this['dispatchQueue'];}async['getSettings'](_0x442b5f){const _0x1cbebb=a564_0x520310,_0x373e46=await CampaignSetting_1[_0x1cbebb(0xb4)]['findAll']({'where':{'companyId':_0x442b5f},'attributes':[_0x1cbebb(0xbb),_0x1cbebb(0x7b)]}),_0x2f38fc={'CAMPAIGN_CONCURRENCY':0x5,'DISPATCH_CONCURRENCY':0x1,'BATCH_SIZE':0x1,'MAX_ATTEMPTS':0x3,'messageInterval':0x14,'longerIntervalAfter':0x14,'greaterInterval':0x3c,'variables':[]};return _0x373e46['forEach'](_0x25372b=>{const _0x2283d9=_0x1cbebb;switch(_0x25372b['key']){case _0x2283d9(0x102):_0x2f38fc[_0x2283d9(0x102)]=parseInt(_0x25372b[_0x2283d9(0x7b)],0xa);break;case _0x2283d9(0xaf):_0x2f38fc[_0x2283d9(0xaf)]=parseInt(_0x25372b[_0x2283d9(0x7b)],0xa);break;case _0x2283d9(0xf5):_0x2f38fc[_0x2283d9(0xf5)]=parseInt(_0x25372b[_0x2283d9(0x7b)],0xa);break;case _0x2283d9(0xea):_0x2f38fc[_0x2283d9(0xea)]=parseInt(_0x25372b[_0x2283d9(0x7b)],0xa);break;case _0x2283d9(0xd4):_0x2f38fc[_0x2283d9(0xd4)]=parseInt(_0x25372b['value'],0xa);break;case'longerIntervalAfter':_0x2f38fc[_0x2283d9(0xf8)]=parseInt(_0x25372b['value'],0xa);break;case _0x2283d9(0xe2):_0x2f38fc[_0x2283d9(0xe2)]=parseInt(_0x25372b[_0x2283d9(0x7b)],0xa);break;case _0x2283d9(0xab):_0x2f38fc[_0x2283d9(0xab)]=JSON['parse'](_0x25372b[_0x2283d9(0x7b)]);break;}}),_0x2f38fc;}[a564_0x520310(0xc9)](_0x4f81b8){const _0x2c2e22=a564_0x520310,_0x1746f2=new bullmq_1[(_0x2c2e22(0xc1))]('campaign-queue',async _0x4e4705=>{const _0x1d979d=_0x2c2e22;if(_0x4e4705['name']===_0x1d979d(0x82))return this[_0x1d979d(0xd7)](_0x4e4705);},{'connection':_0x4f81b8,'concurrency':CAMPAIGN_CONCURRENCY});setInterval(async()=>{const _0x4a8980=_0x2c2e22;try{await this[_0x4a8980(0xa0)]();}catch(_0x20c677){logger_1[_0x4a8980(0xbf)][_0x4a8980(0x86)](_0x4a8980(0xe9),_0x20c677);}},0x1e*0x3c*0x3e8);const _0x179099=new bullmq_1['Worker'](_0x2c2e22(0xd3),async _0x44037c=>{const _0x3448b5=_0x2c2e22;await this[_0x3448b5(0xbc)](_0x44037c['data']);},{'connection':_0x4f81b8,'concurrency':CAMPAIGN_CONCURRENCY}),_0x2f5c28=new bullmq_1[(_0x2c2e22(0xc1))](_0x2c2e22(0xfd),async _0x576b7e=>{const _0x34217e=_0x2c2e22;await this[_0x34217e(0x9f)](_0x576b7e[_0x34217e(0xb2)]);},{'connection':_0x4f81b8,'concurrency':DISPATCH_CONCURRENCY});[_0x1746f2,_0x179099,_0x2f5c28][_0x2c2e22(0x109)](_0x43e17e=>{const _0x56b5f2=_0x2c2e22;_0x43e17e['on'](_0x56b5f2(0xa3),(_0x4e000c,_0x360c44)=>{const _0x47500b=_0x56b5f2;logger_1[_0x47500b(0xbf)][_0x47500b(0x86)]('Job\x20'+_0x4e000c[_0x47500b(0x8a)]+_0x47500b(0x94)+_0x360c44[_0x47500b(0xa1)]),Sentry['captureException'](_0x360c44);}),_0x43e17e['on'](_0x56b5f2(0x93),_0x119c55=>{const _0xb03e3b=_0x56b5f2;logger_1[_0xb03e3b(0xbf)][_0xb03e3b(0x8c)](_0xb03e3b(0x106)+_0x119c55[_0xb03e3b(0x8a)]+_0xb03e3b(0xf9));});});}async[a564_0x520310(0xd7)](_0x141949){const _0x32054d=a564_0x520310;logger_1[_0x32054d(0xbf)][_0x32054d(0x8c)](_0x32054d(0xa6));const _0x167e62=new Date(new Date()['getTime']()+0x3c*0x3c*0x3e8),_0x3f5a59=await Campaign_1['default'][_0x32054d(0xa9)]({'where':{'scheduledAt':{[sequelize_1['Op'][_0x32054d(0x99)]]:+_0x167e62},'status':_0x32054d(0xd9)}});for(const _0x3ae695 of _0x3f5a59){try{const _0x2ff8e1=(0x0,moment_1[_0x32054d(0xb4)])(),_0xbff32c=(0x0,moment_1[_0x32054d(0xb4)])(_0x3ae695['scheduledAt']),_0x488c6b=_0xbff32c[_0x32054d(0xfc)](_0x2ff8e1,_0x32054d(0x10a));await this[_0x32054d(0xda)][_0x32054d(0x8b)]('process-campaign',{'campaignId':_0x3ae695['id']},{'delay':_0x488c6b,'attempts':MAX_ATTEMPTS,'removeOnComplete':!![]}),await _0x3ae695[_0x32054d(0xe5)]({'status':_0x32054d(0x83)});const _0x19289c=(0x0,socket_1[_0x32054d(0x92)])();_0x19289c['to'](_0x32054d(0x80)+_0x3ae695[_0x32054d(0xcc)]+_0x32054d(0xa7))[_0x32054d(0xfa)]('company-'+_0x3ae695[_0x32054d(0xcc)]+_0x32054d(0x98),{'action':_0x32054d(0xe5),'record':_0x3ae695});}catch(_0x7ddb28){Sentry[_0x32054d(0x10c)](_0x7ddb28),logger_1[_0x32054d(0xbf)][_0x32054d(0x86)]('Erro\x20ao\x20processar\x20campanha:\x20'+_0x7ddb28);}}return{'count':_0x3f5a59[_0x32054d(0xaa)]};}async[a564_0x520310(0xbc)](_0x4fe2d8){const _0x53a442=a564_0x520310,{campaignId:_0x22dc9f}=_0x4fe2d8;try{const _0x6cb370=await Campaign_1[_0x53a442(0xb4)][_0x53a442(0xc6)](_0x22dc9f,{'include':[{'model':ContactList_1[_0x53a442(0xb4)],'as':_0x53a442(0xe0),'include':[{'model':ContactListItem_1['default'],'as':'contacts','where':{'isWhatsappValid':!![]}}]}]});if(!_0x6cb370||!_0x6cb370[_0x53a442(0xe0)])throw new Error(_0x53a442(0xc5));if(!_0x6cb370||_0x6cb370[_0x53a442(0xb5)]===_0x53a442(0xf7)){logger_1[_0x53a442(0xbf)][_0x53a442(0x8c)](_0x53a442(0xe7)+_0x22dc9f+'\x20foi\x20cancelada.\x20Interrompendo\x20envio.');return;}const _0x398e43=await CampaignShipping_1[_0x53a442(0xb4)]['findAll']({'where':{'campaignId':_0x6cb370['id'],'deliveredAt':{[sequelize_1['Op']['not']]:null}},'attributes':[_0x53a442(0xc8)]}),_0x5a8ebb=new Set(_0x398e43[_0x53a442(0xf1)](_0x1b977a=>_0x1b977a[_0x53a442(0xc8)])),_0x4dfffe=await this[_0x53a442(0x95)](_0x6cb370[_0x53a442(0xcc)]),_0x3791f0=_0x6cb370['contactList']['contacts'][_0x53a442(0xe6)](_0xef41dd=>!_0x5a8ebb['has'](_0xef41dd['id'])),_0x332616=this[_0x53a442(0xa2)](_0x3791f0[_0x53a442(0xaa)],_0x4dfffe[_0x53a442(0xd4)],_0x4dfffe[_0x53a442(0xf8)],_0x4dfffe['greaterInterval']);await _0x6cb370[_0x53a442(0xe5)]({'estimatedCompletionTime':(0x0,moment_1[_0x53a442(0xb4)])()['add'](_0x332616,_0x53a442(0x7f)),'updatedAt':new Date()});const _0x57fbc1=await CampaignShipping_1[_0x53a442(0xb4)][_0x53a442(0xdb)]({'where':{'campaignId':_0x22dc9f,'deliveredAt':{[sequelize_1['Op'][_0x53a442(0xcf)]]:null}}});if(_0x3791f0['length']>0x0){const _0x5962e7=_0x3791f0['map'](_0x4945b1=>_0x4945b1['id']);await this['dispatchQueue'][_0x53a442(0x8b)](_0x53a442(0xec),{'campaignId':_0x22dc9f,'contactId':_0x3791f0[0x0]['id'],'totalContacts':_0x3791f0[_0x53a442(0xaa)],'currentIndex':0x0,'contactIds':_0x5962e7,'settings':_0x4dfffe},{'attempts':MAX_ATTEMPTS,'removeOnComplete':!![]}),logger_1[_0x53a442(0xbf)][_0x53a442(0x8c)](_0x53a442(0x10b)+_0x3791f0[_0x53a442(0xaa)]+_0x53a442(0xcb));}else logger_1['logger'][_0x53a442(0x8c)](_0x53a442(0x8d)+_0x22dc9f);}catch(_0x4cdabd){Sentry[_0x53a442(0x10c)](_0x4cdabd),logger_1['logger'][_0x53a442(0x86)](_0x53a442(0x85)+_0x4cdabd);}}[a564_0x520310(0xa2)](_0x3138ed,_0x44b60a,_0x2c42e9,_0xb0a711){const _0x505305=a564_0x520310,_0x4b64fe=Math[_0x505305(0xdd)](_0x3138ed,_0x2c42e9),_0x32e9f9=Math['max'](0x0,_0x3138ed-_0x2c42e9);return _0x4b64fe*_0x44b60a+_0x32e9f9*_0xb0a711;}async[a564_0x520310(0x9f)](_0x249a9a){const _0x27dc2f=a564_0x520310,{campaignId:_0x1e260b,contactId:_0x28cc18,totalContacts:_0x2105db,currentIndex:_0x4fc9a2,contactIds:_0xf31a63,settings:_0x1b9a7f}=_0x249a9a;try{const _0x7bfa87=await Campaign_1[_0x27dc2f(0xb4)][_0x27dc2f(0xc6)](_0x1e260b,{'include':[_0x27dc2f(0xbd)]});if(!_0x7bfa87||_0x7bfa87[_0x27dc2f(0xb5)]===_0x27dc2f(0xf7)){logger_1[_0x27dc2f(0xbf)][_0x27dc2f(0x8c)](_0x27dc2f(0xe7)+_0x1e260b+_0x27dc2f(0x96));return;}const _0x3a1109=await ContactListItem_1['default']['findByPk'](_0x28cc18);if(!_0x7bfa87||!_0x3a1109)throw new Error(_0x27dc2f(0xb1));const _0x129d54=await(0x0,GetWhatsappWbot_1[_0x27dc2f(0xb4)])(_0x7bfa87['whatsapp']),_0x48ffa7=_0x3a1109[_0x27dc2f(0xe4)]+_0x27dc2f(0xc4),_0x56c766=this['getCampaignValidMessages'](_0x7bfa87),_0x1babe3=Math[_0x27dc2f(0xc7)](Math[_0x27dc2f(0xb0)]()*_0x56c766[_0x27dc2f(0xaa)]),_0x2ba590=_0x56c766[_0x1babe3],_0x3cc774=this[_0x27dc2f(0x9b)](_0x2ba590,_0x1b9a7f['variables'],_0x3a1109);await(0x0,SendPresenceStatus_1[_0x27dc2f(0x104)])(_0x129d54,_0x48ffa7);const _0xa116ad=await _0x129d54[_0x27dc2f(0x9c)](_0x48ffa7,{'text':_0x3cc774});if(!(0x0,lodash_1['isNil'])(_0x7bfa87['fileListId']))try{const _0x89285d=await(0x0,ShowService_1[_0x27dc2f(0xb4)])(_0x7bfa87[_0x27dc2f(0x9a)],_0x7bfa87[_0x27dc2f(0xcc)]),_0x3dd1ce=path_1[_0x27dc2f(0xb4)][_0x27dc2f(0xb8)](__dirname,'../..','public',_0x27dc2f(0xeb)+_0x7bfa87['companyId'],'fileList',String(_0x89285d['id']));for(const _0x4d85fa of _0x89285d[_0x27dc2f(0x8e)]){const _0x3c514a=await(0x0,SendWhatsAppMedia_1[_0x27dc2f(0x8f)])(_0x4d85fa['path'],path_1[_0x27dc2f(0xb4)]['resolve'](_0x3dd1ce,_0x4d85fa[_0x27dc2f(0xc3)]),_0x4d85fa[_0x27dc2f(0x8a)],_0x7bfa87['companyId']);await _0x129d54[_0x27dc2f(0x9c)](_0x48ffa7,{..._0x3c514a});}}catch(_0x560719){logger_1[_0x27dc2f(0xbf)][_0x27dc2f(0x86)](_0x27dc2f(0xed)+_0x560719);}await CampaignShipping_1[_0x27dc2f(0xb4)][_0x27dc2f(0xf4)]({'campaignId':_0x1e260b,'contactId':_0x3a1109['id'],'number':_0x3a1109[_0x27dc2f(0xe4)],'messageId':_0xa116ad['key']['id'],'message':_0x3cc774,'deliveredAt':(0x0,moment_1[_0x27dc2f(0xb4)])()});const _0x3cea3e=await CampaignShipping_1[_0x27dc2f(0xb4)]['count']({'where':{'campaignId':_0x1e260b,'deliveredAt':{[sequelize_1['Op'][_0x27dc2f(0xcf)]]:null}}});_0x3cea3e>=_0x2105db&&await _0x7bfa87[_0x27dc2f(0xe5)]({'status':_0x27dc2f(0x100),'completedAt':(0x0,moment_1[_0x27dc2f(0xb4)])()});const _0x4de76d=(0x0,socket_1['getIO'])();_0x4de76d['to']('company-'+_0x7bfa87['companyId']+'-mainchannel')[_0x27dc2f(0xfa)]('company-'+_0x7bfa87[_0x27dc2f(0xcc)]+_0x27dc2f(0x98),{'action':_0x27dc2f(0xe5),'record':{..._0x7bfa87[_0x27dc2f(0x81)](),'completedContacts':_0x3cea3e,'totalContacts':_0x2105db,'status':_0x7bfa87[_0x27dc2f(0xb5)]}});if(_0x4fc9a2<_0xf31a63[_0x27dc2f(0xaa)]-0x1){const _0x266e8b=_0x4fc9a2+0x1,_0x14fb60=_0xf31a63[_0x266e8b],_0x5946e3=this[_0x27dc2f(0xd0)](_0x266e8b,_0x1b9a7f[_0x27dc2f(0xd4)],_0x1b9a7f['longerIntervalAfter'],_0x1b9a7f['greaterInterval']);logger_1[_0x27dc2f(0xbf)][_0x27dc2f(0x8c)](_0x27dc2f(0x105)+_0x266e8b+_0x27dc2f(0xad)+_0x5946e3+'ms'),await this[_0x27dc2f(0x97)]['add']('send-campaign',{'campaignId':_0x1e260b,'contactId':_0x14fb60,'totalContacts':_0x2105db,'currentIndex':_0x266e8b,'contactIds':_0xf31a63,'settings':_0x1b9a7f},{'delay':_0x5946e3,'attempts':MAX_ATTEMPTS,'removeOnComplete':!![]});}else logger_1[_0x27dc2f(0xbf)][_0x27dc2f(0x8c)](_0x27dc2f(0x88)+_0x1e260b+_0x27dc2f(0xba));}catch(_0x4f41e3){Sentry[_0x27dc2f(0x10c)](_0x4f41e3),logger_1['logger'][_0x27dc2f(0x86)](_0x27dc2f(0xac)+_0x4f41e3);if(_0x4fc9a2<_0xf31a63['length']-0x1){const _0x38e7c1=_0x4fc9a2+0x1,_0x4c4334=_0xf31a63[_0x38e7c1];logger_1['logger'][_0x27dc2f(0x8c)]('Erro\x20no\x20envio\x20atual,\x20prosseguindo\x20para\x20o\x20próximo\x20contato\x20(índice\x20'+_0x38e7c1+')'),await this[_0x27dc2f(0x97)]['add']('send-campaign',{'campaignId':_0x1e260b,'contactId':_0x4c4334,'totalContacts':_0x2105db,'currentIndex':_0x38e7c1,'contactIds':_0xf31a63,'settings':_0x1b9a7f},{'attempts':MAX_ATTEMPTS,'removeOnComplete':!![]});}}}[a564_0x520310(0xd0)](_0x9dc4f8,_0x549016,_0xe79778,_0x14eeb8){const _0x24424e=a564_0x520310,_0x59ea9a=_0x9dc4f8<_0xe79778?_0x549016:_0x14eeb8,_0xaad41a=0x64+Math[_0x24424e(0xc7)](Math['random']()*0x190);return _0x59ea9a*0x3e8+_0xaad41a;}[a564_0x520310(0x108)](_0x57064b){const _0x38ca3e=a564_0x520310,_0x4554ec=[];for(let _0x40f2f6=0x1;_0x40f2f6<=0x5;_0x40f2f6++){const _0x56d3d1=_0x57064b[_0x38ca3e(0xa1)+_0x40f2f6];!(0x0,lodash_1[_0x38ca3e(0xc0)])(_0x56d3d1)&&!(0x0,lodash_1['isNil'])(_0x56d3d1)&&_0x4554ec[_0x38ca3e(0xdc)](_0x56d3d1);}return _0x4554ec;}[a564_0x520310(0x9b)](_0x1fdf80,_0x5d93e7,_0x2a2f54){const _0x5f461c=a564_0x520310;let _0x415862=_0x1fdf80;return _0x415862[_0x5f461c(0xbe)](_0x5f461c(0x87))&&(_0x415862=_0x415862[_0x5f461c(0xca)](/{nome}/g,_0x2a2f54[_0x5f461c(0x8a)])),_0x415862[_0x5f461c(0xbe)](_0x5f461c(0xee))&&(_0x415862=_0x415862[_0x5f461c(0xca)](/{email}/g,_0x2a2f54[_0x5f461c(0x84)])),_0x415862[_0x5f461c(0xbe)](_0x5f461c(0xb6))&&(_0x415862=_0x415862['replace'](/{numero}/g,_0x2a2f54[_0x5f461c(0xe4)])),_0x5d93e7[_0x5f461c(0x109)](_0x29d425=>{const _0x38e893=_0x5f461c;if(_0x415862[_0x38e893(0xbe)]('{'+_0x29d425['key']+'}')){const _0x47d54f=new RegExp('{'+_0x29d425[_0x38e893(0xbb)]+'}','g');_0x415862=_0x415862[_0x38e893(0xca)](_0x47d54f,_0x29d425[_0x38e893(0x7b)]);}}),_0x415862;}async[a564_0x520310(0xa0)](){const _0x2942a7=a564_0x520310,_0x5a6b00=await Campaign_1['default'][_0x2942a7(0xa9)]({'where':{'status':_0x2942a7(0x83),'estimatedCompletionTime':{[sequelize_1['Op']['lt']]:(0x0,moment_1[_0x2942a7(0xb4)])()[_0x2942a7(0x107)]()}}});for(const _0x3f272c of _0x5a6b00){try{const _0x190e4d=await CampaignShipping_1['default'][_0x2942a7(0xdb)]({'where':{'campaignId':_0x3f272c['id'],'deliveredAt':{[sequelize_1['Op'][_0x2942a7(0xcf)]]:null}}}),_0x7373eb=await ContactListItem_1[_0x2942a7(0xb4)][_0x2942a7(0xdb)]({'where':{'contactListId':_0x3f272c['contactListId'],'isWhatsappValid':!![]}});_0x190e4d<_0x7373eb?(logger_1['logger']['info'](_0x2942a7(0xd1)+_0x3f272c['id']),await _0x3f272c[_0x2942a7(0xe5)]({'status':_0x2942a7(0xd9),'updatedAt':new Date()}),await this[_0x2942a7(0xda)][_0x2942a7(0x8b)](_0x2942a7(0xfb),{'campaignId':_0x3f272c['id']},{'attempts':MAX_ATTEMPTS,'removeOnComplete':!![]})):await _0x3f272c[_0x2942a7(0xe5)]({'status':'FINALIZADA','completedAt':(0x0,moment_1[_0x2942a7(0xb4)])()});}catch(_0x46d431){logger_1['logger'][_0x2942a7(0x86)](_0x2942a7(0xc2)+_0x46d431),Sentry[_0x2942a7(0x10c)](_0x46d431);}}}}function a564_0x3912(_0x328410,_0xf6f030){const _0x468dc7=a564_0x26bf();return a564_0x3912=function(_0x1a3cc4,_0x329202){_0x1a3cc4=_0x1a3cc4-0x7a;let _0x26bfb2=_0x468dc7[_0x1a3cc4];return _0x26bfb2;},a564_0x3912(_0x328410,_0xf6f030);}function a564_0x26bf(){const _0x4c5fa9=['map','call','316464gfSLSF','create','BATCH_SIZE','1asClDE','CANCELADA','longerIntervalAfter','\x20completed\x20successfully','emit','process-campaign','diff','dispatch-queue','../utils/logger','apply','FINALIZADA','getDispatchQueue','CAMPAIGN_CONCURRENCY','__createBinding','SendPresenceStatus','Agendando\x20próximo\x20envio\x20(índice\x20','Job\x20','toDate','getCampaignValidMessages','forEach','milliseconds','Iniciando\x20envio\x20sequencial\x20para\x20','captureException','2177288CNJEng','1116234YtFgnn','value','hasOwnProperty','bullmq','defineProperty','seconds','company-','toJSON','VerifyCampaigns','EM_ANDAMENTO','email','Erro\x20no\x20processamento\x20em\x20lote:\x20','error','{nome}','Todos\x20os\x20contatos\x20da\x20campanha\x20','lodash','name','add','info','Não\x20há\x20contatos\x20pendentes\x20para\x20envio\x20na\x20campanha\x20','options','getMessageOptions','925lOwfHr','get','getIO','completed','\x20failed:\x20','getSettings','\x20foi\x20cancelada.\x20Interrompendo\x20envio.','dispatchQueue','-campaign','lte','fileListId','getProcessedMessage','sendMessage','campaignQueue','613030KCUHaB','handleDispatchCampaign','resumeStaledCampaigns','message','calculateTotalTimeEstimate','failed','__esModule','Queue','handleVerifyCampaigns\x20iniciado','-mainchannel','REDIS_PORT','findAll','length','variables','Erro\x20no\x20envio\x20da\x20campanha:\x20',')\x20com\x20delay\x20de\x20','../services/FileServices/ShowService','DISPATCH_CONCURRENCY','random','Campanha\x20ou\x20contato\x20não\x20encontrado','data','__importStar','default','status','{numero}','14142mWiOOb','resolve','842420rytvzG','\x20foram\x20processados\x20sequencialmente','key','handleProcessingBatch','whatsapp','includes','logger','isEmpty','Worker','Erro\x20ao\x20recuperar\x20campanha\x20travada:\x20','path','@s.whatsapp.net','Campanha\x20ou\x20lista\x20de\x20contatos\x20não\x20encontrada','findByPk','floor','contactId','initializeWorkers','replace','\x20contatos','companyId','env','campaign-queue','not','calculateOptimizedDelay','Retomando\x20campanha\x20travada:\x20','constructor','processing-queue','messageInterval','getProcessingQueue','prototype','handleVerifyCampaigns','../models/ContactListItem','PROGRAMADA','processingQueue','count','push','min','toString','6105888rMUbSU','contactList','../helpers/SendPresenceStatus','greaterInterval','../helpers/GetWhatsappWbot','number','update','filter','Campanha\x20','6379','Erro\x20na\x20verificação\x20de\x20campanhas\x20travadas','MAX_ATTEMPTS','company','send-campaign','Error\x20sending\x20campaign\x20files:\x20','{email}','getOwnPropertyDescriptor','configurable'];a564_0x26bf=function(){return _0x4c5fa9;};return a564_0x26bf();}exports['default']=CampaignQueueManager;