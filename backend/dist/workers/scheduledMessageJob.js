const a575_0x3635e0=a575_0x3756;(function(_0xf46ec3,_0x363731){const _0x4bb4e6=a575_0x3756,_0x2d3b3a=_0xf46ec3();while(!![]){try{const _0x2e82d0=-parseInt(_0x4bb4e6(0x1bf))/0x1*(parseInt(_0x4bb4e6(0x1d9))/0x2)+-parseInt(_0x4bb4e6(0x201))/0x3+parseInt(_0x4bb4e6(0x1f7))/0x4+-parseInt(_0x4bb4e6(0x20b))/0x5*(-parseInt(_0x4bb4e6(0x1d4))/0x6)+parseInt(_0x4bb4e6(0x1d2))/0x7*(parseInt(_0x4bb4e6(0x1fe))/0x8)+parseInt(_0x4bb4e6(0x209))/0x9*(parseInt(_0x4bb4e6(0x203))/0xa)+parseInt(_0x4bb4e6(0x1f0))/0xb;if(_0x2e82d0===_0x363731)break;else _0x2d3b3a['push'](_0x2d3b3a['shift']());}catch(_0x47069a){_0x2d3b3a['push'](_0x2d3b3a['shift']());}}}(a575_0x37df,0x3484d));const a575_0x2eda9b=(function(){let _0x491865=!![];return function(_0x271c8d,_0xb7d796){const _0x3ac901=_0x491865?function(){if(_0xb7d796){const _0x387f59=_0xb7d796['apply'](_0x271c8d,arguments);return _0xb7d796=null,_0x387f59;}}:function(){};return _0x491865=![],_0x3ac901;};}()),a575_0x45b57d=a575_0x2eda9b(this,function(){const _0x4f7a9a=a575_0x3756;return a575_0x45b57d['toString']()['search'](_0x4f7a9a(0x1ca))[_0x4f7a9a(0x1e7)]()[_0x4f7a9a(0x1f2)](a575_0x45b57d)[_0x4f7a9a(0x1dd)](_0x4f7a9a(0x1ca));});a575_0x45b57d();function a575_0x3756(_0x3e4957,_0x475d3e){const _0x5cdd03=a575_0x37df();return a575_0x3756=function(_0x45b57d,_0x2eda9b){_0x45b57d=_0x45b57d-0x1b6;let _0x37df04=_0x5cdd03[_0x45b57d];return _0x37df04;},a575_0x3756(_0x3e4957,_0x475d3e);}'use strict';var __createBinding=this&&this[a575_0x3635e0(0x1da)]||(Object[a575_0x3635e0(0x1c4)]?function(_0x37cadf,_0x230b37,_0x400575,_0x552db3){const _0x5b9a3c=a575_0x3635e0;if(_0x552db3===undefined)_0x552db3=_0x400575;var _0xc1cda7=Object[_0x5b9a3c(0x1f4)](_0x230b37,_0x400575);(!_0xc1cda7||(_0x5b9a3c(0x1e8)in _0xc1cda7?!_0x230b37['__esModule']:_0xc1cda7[_0x5b9a3c(0x1c2)]||_0xc1cda7['configurable']))&&(_0xc1cda7={'enumerable':!![],'get':function(){return _0x230b37[_0x400575];}}),Object[_0x5b9a3c(0x1de)](_0x37cadf,_0x552db3,_0xc1cda7);}:function(_0x1d4051,_0x2d412a,_0x43f37c,_0x7868b7){if(_0x7868b7===undefined)_0x7868b7=_0x43f37c;_0x1d4051[_0x7868b7]=_0x2d412a[_0x43f37c];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x31090c,_0x376556){const _0x103249=a575_0x3635e0;Object[_0x103249(0x1de)](_0x31090c,_0x103249(0x1e2),{'enumerable':!![],'value':_0x376556});}:function(_0x49a5dc,_0xfaefaf){_0x49a5dc['default']=_0xfaefaf;}),__importStar=this&&this[a575_0x3635e0(0x1c1)]||function(_0x294a8c){const _0x38bc7d=a575_0x3635e0;if(_0x294a8c&&_0x294a8c[_0x38bc7d(0x1e6)])return _0x294a8c;var _0x5a05ac={};if(_0x294a8c!=null){for(var _0x2a13f3 in _0x294a8c)if(_0x2a13f3!==_0x38bc7d(0x1e2)&&Object[_0x38bc7d(0x1e1)][_0x38bc7d(0x1ff)][_0x38bc7d(0x1fa)](_0x294a8c,_0x2a13f3))__createBinding(_0x5a05ac,_0x294a8c,_0x2a13f3);}return __setModuleDefault(_0x5a05ac,_0x294a8c),_0x5a05ac;},__importDefault=this&&this[a575_0x3635e0(0x1eb)]||function(_0x51f29a){const _0x307a51=a575_0x3635e0;return _0x51f29a&&_0x51f29a[_0x307a51(0x1e6)]?_0x51f29a:{'default':_0x51f29a};};Object['defineProperty'](exports,'__esModule',{'value':!![]});const bullmq_1=require('bullmq'),Schedule_1=__importDefault(require(a575_0x3635e0(0x1dc))),Sentry=__importStar(require(a575_0x3635e0(0x1fb))),logger_1=require(a575_0x3635e0(0x1fc)),moment_1=__importDefault(require(a575_0x3635e0(0x1e3))),GetDefaultWhatsApp_1=__importDefault(require(a575_0x3635e0(0x1bc))),Tag_1=__importDefault(require(a575_0x3635e0(0x1ce))),SendMessage_1=require(a575_0x3635e0(0x1ee)),path_1=__importDefault(require(a575_0x3635e0(0x1ba))),sequelize_1=require('sequelize'),Contact_1=__importDefault(require(a575_0x3635e0(0x1d8)));function a575_0x37df(){const _0x46828d=['72MlbPvf','hasOwnProperty','info','1253619bUtmWo','catch','420WNUivx','getQueue','failed','SendScheduledMessage\x20->\x20SendMessage:\x20error','map','format','57735xyrXQC','handleSendScheduledMessage','165035cfaTRA','AGENDADA','findByPk','getRandomArbitrary','name','daysR','path','../../public/company','../helpers/GetDefaultWhatsApp','Job\x20','\x20completed','13658uXViLl','captureException','__importStar','writable','logger','create','PENDENTE','Disparo\x20agendado\x20para:\x20','ERRO','SendScheduledMessage\x20->\x20Verify:\x20error','Worker','(((.+)+)+)+$','Mensagem\x20agendada\x20enviada\x20para:\x20','findAll','mediaPath','../models/Tag','number','queue','then','81319pIsNiy','sendAt','48aZQfnQ','msgR','companyId','length','../models/Contact','26ymbrLj','__createBinding','handleVerifySchedules','../models/Schedule','search','defineProperty','rptDays','resolve','prototype','default','moment/moment','add','reject','__esModule','toString','get','log','contact','__importDefault','SendMessage','Erro\x20ao\x20tentar\x20consultar\x20agendamento:\x20','../helpers/SendMessage','random','248545GfJbHJ','update','constructor','error','getOwnPropertyDescriptor','YYYY-MM-DD\x20HH:mm','lte','599640WrPjHS','Error','message','call','@sentry/node','../utils/logger','Tag\x20não\x20encontrada'];a575_0x37df=function(){return _0x46828d;};return a575_0x37df();}class ScheduledMessageJob{[a575_0x3635e0(0x204)](){const _0x1211cb=a575_0x3635e0;return this[_0x1211cb(0x1d0)];}constructor(_0x1553b1,_0x600150){const _0xa17674=a575_0x3635e0;this[_0xa17674(0x1d0)]=_0x1553b1;const _0x349596=new bullmq_1[(_0xa17674(0x1c9))](_0x1553b1['name'],async _0x55d9c4=>{const _0x4053c0=_0xa17674;if(_0x55d9c4[_0x4053c0(0x1b8)]==_0x4053c0(0x1ec))await this[_0x4053c0(0x20a)](_0x55d9c4);else _0x55d9c4[_0x4053c0(0x1b8)]=='VerifySchedules'&&await this[_0x4053c0(0x1db)]();},{'concurrency':0x64,'connection':_0x600150,'removeOnFail':{'count':0x0}});_0x349596['on']('completed',async _0x4dcb6c=>{const _0x3ac817=_0xa17674;logger_1[_0x3ac817(0x1c3)][_0x3ac817(0x200)](_0x3ac817(0x1bd)+_0x4dcb6c['id']+_0x3ac817(0x1be));}),_0x349596['on'](_0xa17674(0x205),async(_0x4118b0,_0x294af7)=>{const _0x218155=_0xa17674;logger_1[_0x218155(0x1c3)]['error'](_0x218155(0x1bd)+_0x4118b0[_0x218155(0x1b8)]+'\x20failed\x20with\x20error:\x20'+_0x294af7[_0x218155(0x1f9)]);});}async[a575_0x3635e0(0x1db)](){const _0x57886d=a575_0x3635e0;try{const _0x307d63=await Schedule_1[_0x57886d(0x1e2)][_0x57886d(0x1cc)]({'where':{'status':_0x57886d(0x1c5),'sentAt':null,'sendAt':{[sequelize_1['Op'][_0x57886d(0x1f6)]]:(0x0,moment_1[_0x57886d(0x1e2)])()['format']('YYYY-MM-DD\x20HH:mm:ss')}},'include':[{'model':Contact_1[_0x57886d(0x1e2)],'as':'contact'}]});return _0x307d63?.[_0x57886d(0x1d7)]>0x0&&_0x307d63[_0x57886d(0x207)](async _0x7b380f=>{const _0x590bf1=_0x57886d;await _0x7b380f[_0x590bf1(0x1f1)]({'status':_0x590bf1(0x20c)}),await this[_0x590bf1(0x1d0)][_0x590bf1(0x1e4)](_0x590bf1(0x1ec),{'schedule':_0x7b380f},{'delay':this[_0x590bf1(0x1b7)](0x3e8,0xbb8),'removeOnComplete':!![]}),logger_1['logger'][_0x590bf1(0x200)](_0x590bf1(0x1c6)+_0x7b380f[_0x590bf1(0x1ea)][_0x590bf1(0x1b8)]);}),Promise['resolve']({'count':_0x307d63['length']});}catch(_0x2b8056){return Sentry[_0x57886d(0x1c0)](_0x2b8056),logger_1['logger']['error'](_0x57886d(0x1c8),_0x2b8056['message']),Promise[_0x57886d(0x1e5)](new sequelize_1[(_0x57886d(0x1f8))](_0x2b8056));}}[a575_0x3635e0(0x1b7)](_0x3c7add,_0x2a9c03){const _0x27c9d1=a575_0x3635e0;return Math[_0x27c9d1(0x1ef)]()*(_0x2a9c03-_0x3c7add)+_0x3c7add;}async[a575_0x3635e0(0x20a)](_0x2d461c){const _0x1872ca=a575_0x3635e0,{data:{schedule:_0x199134}}=_0x2d461c;let _0x22689f=null;try{_0x22689f=await Schedule_1[_0x1872ca(0x1e2)][_0x1872ca(0x1b6)](_0x199134['id']);}catch(_0x36d09f){Sentry[_0x1872ca(0x1c0)](_0x36d09f),logger_1[_0x1872ca(0x1c3)][_0x1872ca(0x200)](_0x1872ca(0x1ed)+_0x199134['id']);}try{if(_0x22689f?.[_0x1872ca(0x1b9)]!==null){let _0x3b502d=(0x0,moment_1[_0x1872ca(0x1e2)])(_0x22689f[_0x1872ca(0x1d3)]);const _0x26d572=_0x199134[_0x1872ca(0x1d6)],_0x2f3771=await(0x0,GetDefaultWhatsApp_1[_0x1872ca(0x1e2)])(_0x199134[_0x1872ca(0x1d6)]);let _0x5d96a0=null;const _0x4ee4e7=_0x22689f?.['campId'];_0x4ee4e7?Tag_1[_0x1872ca(0x1e2)][_0x1872ca(0x1b6)](_0x4ee4e7)[_0x1872ca(0x1d1)](async _0x228567=>{const _0x22f1c2=_0x1872ca;if(_0x228567){let _0x15df60=_0x3b502d[_0x22f1c2(0x1e4)](_0x228567[_0x22f1c2(0x1df)],'days')[_0x22f1c2(0x208)](_0x22f1c2(0x1f5));_0x228567[_0x22f1c2(0x1cd)]&&(await(0x0,SendMessage_1[_0x22f1c2(0x1ec)])(_0x2f3771,{'number':_0x199134[_0x22f1c2(0x1ea)][_0x22f1c2(0x1cf)],'body':_0x228567[_0x22f1c2(0x1d5)]}),_0x5d96a0=path_1['default']['resolve'](_0x22f1c2(0x1bb)+_0x26d572,_0x228567[_0x22f1c2(0x1cd)]),await(0x0,SendMessage_1[_0x22f1c2(0x1ec)])(_0x2f3771,{'number':_0x199134[_0x22f1c2(0x1ea)][_0x22f1c2(0x1cf)],'body':_0x228567[_0x22f1c2(0x1d5)],'mediaPath':_0x5d96a0})),_0x228567[_0x22f1c2(0x1df)]===0x0?await _0x22689f?.[_0x22f1c2(0x1f1)]({'sentAt':(0x0,moment_1[_0x22f1c2(0x1e2)])()['format'](_0x22f1c2(0x1f5)),'status':'ENVIADA'}):await _0x22689f?.[_0x22f1c2(0x1f1)]({'sendAt':_0x15df60,'status':_0x22f1c2(0x1c5)}),logger_1[_0x22f1c2(0x1c3)][_0x22f1c2(0x200)]('Mensagem\x20agendada\x20enviada\x20para:\x20'+_0x199134[_0x22f1c2(0x1ea)]['name']+'\x20');}else console[_0x22f1c2(0x1e9)](_0x22f1c2(0x1fd));})[_0x1872ca(0x202)](_0xdc9329=>{const _0x310bb9=_0x1872ca;console[_0x310bb9(0x1f3)]('Erro\x20ao\x20buscar\x20tag:',_0xdc9329);}):console['log']('ID\x20da\x20tag\x20não\x20está\x20definido\x20em\x20scheduleRecord');}else{const _0x30ff0f=await(0x0,GetDefaultWhatsApp_1['default'])(_0x199134[_0x1872ca(0x1d6)]);let _0x263e13=null;_0x199134[_0x1872ca(0x1cd)]&&(_0x263e13=path_1[_0x1872ca(0x1e2)][_0x1872ca(0x1e0)](_0x1872ca(0x1bb)+_0x199134['companyId'],_0x199134[_0x1872ca(0x1cd)])),await(0x0,SendMessage_1[_0x1872ca(0x1ec)])(_0x30ff0f,{'number':_0x199134['contact']['number'],'body':_0x199134['body'],'mediaPath':_0x263e13}),await _0x22689f?.[_0x1872ca(0x1f1)]({'sentAt':(0x0,moment_1[_0x1872ca(0x1e2)])()[_0x1872ca(0x208)](_0x1872ca(0x1f5)),'status':'ENVIADA'}),logger_1[_0x1872ca(0x1c3)]['info'](_0x1872ca(0x1cb)+_0x199134[_0x1872ca(0x1ea)][_0x1872ca(0x1b8)]);}}catch(_0x39ec35){Sentry[_0x1872ca(0x1c0)](_0x39ec35),await _0x22689f?.[_0x1872ca(0x1f1)]({'status':_0x1872ca(0x1c7)}),logger_1[_0x1872ca(0x1c3)][_0x1872ca(0x1f3)](_0x1872ca(0x206),_0x39ec35[_0x1872ca(0x1f9)]);throw _0x39ec35;}}}exports[a575_0x3635e0(0x1e2)]=ScheduledMessageJob;