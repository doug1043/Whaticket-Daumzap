function a574_0x5ef1(){const _0x1e1fa2=['format','map','msgR','Mensagem\x20agendada\x20enviada\x20para:\x20','contact','create','then','SendScheduledMessage\x20->\x20Verify:\x20error','__esModule','reject','info','SendMessage','AGENDADA','3518jWTYBL','mediaPath','VerifySchedules','../models/Schedule','Erro\x20ao\x20buscar\x20tag:','findByPk','call','558ZYaFbv','getRandomArbitrary','__createBinding','3532023CbilQY','Disparo\x20agendado\x20para:\x20','apply','captureException','(((.+)+)+)+$','ENVIADA','toString','\x20failed\x20with\x20error:\x20','days','writable','../../public/company','__importDefault','41826ecWyBb','../models/Tag','YYYY-MM-DD\x20HH:mm:ss','prototype','log','ERRO','completed','52760cGSGzi','moment/moment','handleVerifySchedules','13139750VRmgah','Tag\x20não\x20encontrada','resolve','@sentry/node','handleSendScheduledMessage','500ULjlhp','search','defineProperty','failed','queue','hasOwnProperty','rptDays','path','configurable','catch','20UfWpro','../helpers/SendMessage','random','error','companyId','PENDENTE','22xTMqFO','number','update','../models/Contact','logger','message','add','name','Job\x20','YYYY-MM-DD\x20HH:mm','399HGIoDb','203830gXQwuF','sendAt','lte','__importStar','12NCMktE','574923Qunlql','length','default'];a574_0x5ef1=function(){return _0x1e1fa2;};return a574_0x5ef1();}const a574_0x2e011d=a574_0x34a4;(function(_0x34e43e,_0x232a83){const _0x4601f6=a574_0x34a4,_0x2ae625=_0x34e43e();while(!![]){try{const _0x2db559=parseInt(_0x4601f6(0xd1))/0x1*(-parseInt(_0x4601f6(0x9c))/0x2)+-parseInt(_0x4601f6(0x8c))/0x3*(-parseInt(_0x4601f6(0xcb))/0x4)+-parseInt(_0x4601f6(0xc1))/0x5*(parseInt(_0x4601f6(0xb2))/0x6)+parseInt(_0x4601f6(0x86))/0x7*(parseInt(_0x4601f6(0xb9))/0x8)+-parseInt(_0x4601f6(0xa3))/0x9*(parseInt(_0x4601f6(0x87))/0xa)+-parseInt(_0x4601f6(0xa6))/0xb*(-parseInt(_0x4601f6(0x8b))/0xc)+parseInt(_0x4601f6(0xbc))/0xd;if(_0x2db559===_0x232a83)break;else _0x2ae625['push'](_0x2ae625['shift']());}catch(_0x3a113c){_0x2ae625['push'](_0x2ae625['shift']());}}}(a574_0x5ef1,0xa2b33));const a574_0x5e2237=(function(){let _0x45b20b=!![];return function(_0x237ee3,_0x4eefa4){const _0x3e23db=_0x45b20b?function(){const _0x309e09=a574_0x34a4;if(_0x4eefa4){const _0xa7851b=_0x4eefa4[_0x309e09(0xa8)](_0x237ee3,arguments);return _0x4eefa4=null,_0xa7851b;}}:function(){};return _0x45b20b=![],_0x3e23db;};}()),a574_0x58ddbf=a574_0x5e2237(this,function(){const _0x3adefa=a574_0x34a4;return a574_0x58ddbf[_0x3adefa(0xac)]()[_0x3adefa(0xc2)](_0x3adefa(0xaa))[_0x3adefa(0xac)]()['constructor'](a574_0x58ddbf)['search']('(((.+)+)+)+$');});a574_0x58ddbf();'use strict';var __createBinding=this&&this[a574_0x2e011d(0xa5)]||(Object['create']?function(_0x27c22c,_0x514f1f,_0x3f3541,_0x151d4d){const _0x19a456=a574_0x2e011d;if(_0x151d4d===undefined)_0x151d4d=_0x3f3541;var _0x42a875=Object['getOwnPropertyDescriptor'](_0x514f1f,_0x3f3541);(!_0x42a875||('get'in _0x42a875?!_0x514f1f[_0x19a456(0x97)]:_0x42a875[_0x19a456(0xaf)]||_0x42a875[_0x19a456(0xc9)]))&&(_0x42a875={'enumerable':!![],'get':function(){return _0x514f1f[_0x3f3541];}}),Object[_0x19a456(0xc3)](_0x27c22c,_0x151d4d,_0x42a875);}:function(_0x18fd6b,_0x37beba,_0x286569,_0x16d4a4){if(_0x16d4a4===undefined)_0x16d4a4=_0x286569;_0x18fd6b[_0x16d4a4]=_0x37beba[_0x286569];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a574_0x2e011d(0x94)]?function(_0x1059d0,_0x130a7a){Object['defineProperty'](_0x1059d0,'default',{'enumerable':!![],'value':_0x130a7a});}:function(_0x2fa9a1,_0x4cac0c){const _0x3aebba=a574_0x2e011d;_0x2fa9a1[_0x3aebba(0x8e)]=_0x4cac0c;}),__importStar=this&&this[a574_0x2e011d(0x8a)]||function(_0x446b76){const _0x5efa54=a574_0x2e011d;if(_0x446b76&&_0x446b76[_0x5efa54(0x97)])return _0x446b76;var _0x45cb6f={};if(_0x446b76!=null){for(var _0x46fc62 in _0x446b76)if(_0x46fc62!==_0x5efa54(0x8e)&&Object[_0x5efa54(0xb5)][_0x5efa54(0xc6)][_0x5efa54(0xa2)](_0x446b76,_0x46fc62))__createBinding(_0x45cb6f,_0x446b76,_0x46fc62);}return __setModuleDefault(_0x45cb6f,_0x446b76),_0x45cb6f;},__importDefault=this&&this[a574_0x2e011d(0xb1)]||function(_0xfb8abf){const _0x220df5=a574_0x2e011d;return _0xfb8abf&&_0xfb8abf[_0x220df5(0x97)]?_0xfb8abf:{'default':_0xfb8abf};};Object[a574_0x2e011d(0xc3)](exports,a574_0x2e011d(0x97),{'value':!![]});const bullmq_1=require('bullmq'),Schedule_1=__importDefault(require(a574_0x2e011d(0x9f))),Sentry=__importStar(require(a574_0x2e011d(0xbf))),logger_1=require('../utils/logger'),moment_1=__importDefault(require(a574_0x2e011d(0xba))),GetDefaultWhatsApp_1=__importDefault(require('../helpers/GetDefaultWhatsApp')),Tag_1=__importDefault(require(a574_0x2e011d(0xb3))),SendMessage_1=require(a574_0x2e011d(0xcc)),path_1=__importDefault(require(a574_0x2e011d(0xc8))),sequelize_1=require('sequelize'),Contact_1=__importDefault(require(a574_0x2e011d(0x7f)));class ScheduledMessageJob{['getQueue'](){const _0x5bbfc9=a574_0x2e011d;return this[_0x5bbfc9(0xc5)];}constructor(_0x367bc7,_0x1a508d){const _0x264f8e=a574_0x2e011d;this[_0x264f8e(0xc5)]=_0x367bc7;const _0x15908d=new bullmq_1['Worker'](_0x367bc7[_0x264f8e(0x83)],async _0x2555b0=>{const _0x53785c=_0x264f8e;if(_0x2555b0[_0x53785c(0x83)]==_0x53785c(0x9a))await this[_0x53785c(0xc0)](_0x2555b0);else _0x2555b0['name']==_0x53785c(0x9e)&&await this[_0x53785c(0xbb)]();},{'concurrency':0x64,'connection':_0x1a508d,'removeOnFail':{'count':0x0}});_0x15908d['on'](_0x264f8e(0xb8),async _0x18b493=>{const _0x46b79c=_0x264f8e;logger_1[_0x46b79c(0x80)][_0x46b79c(0x99)](_0x46b79c(0x84)+_0x18b493['id']+'\x20completed');}),_0x15908d['on'](_0x264f8e(0xc4),async(_0x1957ab,_0x59d1f1)=>{const _0x569963=_0x264f8e;logger_1[_0x569963(0x80)][_0x569963(0xce)](_0x569963(0x84)+_0x1957ab[_0x569963(0x83)]+_0x569963(0xad)+_0x59d1f1[_0x569963(0x81)]);});}async['handleVerifySchedules'](){const _0x2d7e59=a574_0x2e011d;try{const _0x51c071=await Schedule_1[_0x2d7e59(0x8e)]['findAll']({'where':{'status':_0x2d7e59(0xd0),'sentAt':null,'sendAt':{[sequelize_1['Op'][_0x2d7e59(0x89)]]:(0x0,moment_1['default'])()[_0x2d7e59(0x8f)](_0x2d7e59(0xb4))}},'include':[{'model':Contact_1[_0x2d7e59(0x8e)],'as':_0x2d7e59(0x93)}]});return _0x51c071?.[_0x2d7e59(0x8d)]>0x0&&_0x51c071[_0x2d7e59(0x90)](async _0x31822a=>{const _0x465a0b=_0x2d7e59;await _0x31822a[_0x465a0b(0x7e)]({'status':_0x465a0b(0x9b)}),await this[_0x465a0b(0xc5)][_0x465a0b(0x82)](_0x465a0b(0x9a),{'schedule':_0x31822a},{'delay':this[_0x465a0b(0xa4)](0x3e8,0xbb8),'removeOnComplete':!![]}),logger_1['logger'][_0x465a0b(0x99)](_0x465a0b(0xa7)+_0x31822a['contact'][_0x465a0b(0x83)]);}),Promise[_0x2d7e59(0xbe)]({'count':_0x51c071[_0x2d7e59(0x8d)]});}catch(_0x1fa4c4){return Sentry[_0x2d7e59(0xa9)](_0x1fa4c4),logger_1['logger'][_0x2d7e59(0xce)](_0x2d7e59(0x96),_0x1fa4c4[_0x2d7e59(0x81)]),Promise[_0x2d7e59(0x98)](new sequelize_1['Error'](_0x1fa4c4));}}[a574_0x2e011d(0xa4)](_0x5e94d4,_0x52f5ea){const _0xa169d8=a574_0x2e011d;return Math[_0xa169d8(0xcd)]()*(_0x52f5ea-_0x5e94d4)+_0x5e94d4;}async['handleSendScheduledMessage'](_0x2eed57){const _0x48d47e=a574_0x2e011d,{data:{schedule:_0x4b0a35}}=_0x2eed57;let _0x105d2d=null;try{_0x105d2d=await Schedule_1[_0x48d47e(0x8e)][_0x48d47e(0xa1)](_0x4b0a35['id']);}catch(_0x50001c){Sentry[_0x48d47e(0xa9)](_0x50001c),logger_1[_0x48d47e(0x80)]['info']('Erro\x20ao\x20tentar\x20consultar\x20agendamento:\x20'+_0x4b0a35['id']);}try{if(_0x105d2d?.['daysR']!==null){let _0x21d599=(0x0,moment_1[_0x48d47e(0x8e)])(_0x105d2d[_0x48d47e(0x88)]);const _0x184e17=_0x4b0a35[_0x48d47e(0xcf)],_0x229938=await(0x0,GetDefaultWhatsApp_1[_0x48d47e(0x8e)])(_0x4b0a35[_0x48d47e(0xcf)]);let _0x12650d=null;const _0x46607b=_0x105d2d?.['campId'];_0x46607b?Tag_1[_0x48d47e(0x8e)][_0x48d47e(0xa1)](_0x46607b)[_0x48d47e(0x95)](async _0x36444c=>{const _0x5c26b0=_0x48d47e;if(_0x36444c){let _0x43f340=_0x21d599[_0x5c26b0(0x82)](_0x36444c['rptDays'],_0x5c26b0(0xae))['format'](_0x5c26b0(0x85));_0x36444c[_0x5c26b0(0x9d)]&&(await(0x0,SendMessage_1[_0x5c26b0(0x9a)])(_0x229938,{'number':_0x4b0a35['contact'][_0x5c26b0(0xd2)],'body':_0x36444c[_0x5c26b0(0x91)]}),_0x12650d=path_1[_0x5c26b0(0x8e)][_0x5c26b0(0xbe)](_0x5c26b0(0xb0)+_0x184e17,_0x36444c[_0x5c26b0(0x9d)]),await(0x0,SendMessage_1[_0x5c26b0(0x9a)])(_0x229938,{'number':_0x4b0a35[_0x5c26b0(0x93)][_0x5c26b0(0xd2)],'body':_0x36444c[_0x5c26b0(0x91)],'mediaPath':_0x12650d})),_0x36444c[_0x5c26b0(0xc7)]===0x0?await _0x105d2d?.[_0x5c26b0(0x7e)]({'sentAt':(0x0,moment_1[_0x5c26b0(0x8e)])()[_0x5c26b0(0x8f)](_0x5c26b0(0x85)),'status':'ENVIADA'}):await _0x105d2d?.[_0x5c26b0(0x7e)]({'sendAt':_0x43f340,'status':_0x5c26b0(0xd0)}),logger_1['logger'][_0x5c26b0(0x99)]('Mensagem\x20agendada\x20enviada\x20para:\x20'+_0x4b0a35[_0x5c26b0(0x93)]['name']+'\x20');}else console[_0x5c26b0(0xb6)](_0x5c26b0(0xbd));})[_0x48d47e(0xca)](_0xd18209=>{const _0x45496c=_0x48d47e;console[_0x45496c(0xce)](_0x45496c(0xa0),_0xd18209);}):console[_0x48d47e(0xb6)]('ID\x20da\x20tag\x20não\x20está\x20definido\x20em\x20scheduleRecord');}else{const _0x121e71=await(0x0,GetDefaultWhatsApp_1['default'])(_0x4b0a35['companyId']);let _0x2a3019=null;_0x4b0a35[_0x48d47e(0x9d)]&&(_0x2a3019=path_1[_0x48d47e(0x8e)][_0x48d47e(0xbe)]('../../public/company'+_0x4b0a35[_0x48d47e(0xcf)],_0x4b0a35[_0x48d47e(0x9d)])),await(0x0,SendMessage_1['SendMessage'])(_0x121e71,{'number':_0x4b0a35[_0x48d47e(0x93)][_0x48d47e(0xd2)],'body':_0x4b0a35['body'],'mediaPath':_0x2a3019}),await _0x105d2d?.[_0x48d47e(0x7e)]({'sentAt':(0x0,moment_1['default'])()[_0x48d47e(0x8f)](_0x48d47e(0x85)),'status':_0x48d47e(0xab)}),logger_1[_0x48d47e(0x80)][_0x48d47e(0x99)](_0x48d47e(0x92)+_0x4b0a35[_0x48d47e(0x93)][_0x48d47e(0x83)]);}}catch(_0x2e76a4){Sentry[_0x48d47e(0xa9)](_0x2e76a4),await _0x105d2d?.[_0x48d47e(0x7e)]({'status':_0x48d47e(0xb7)}),logger_1[_0x48d47e(0x80)][_0x48d47e(0xce)]('SendScheduledMessage\x20->\x20SendMessage:\x20error',_0x2e76a4[_0x48d47e(0x81)]);throw _0x2e76a4;}}}function a574_0x34a4(_0x58eff9,_0x457c90){const _0x436d4a=a574_0x5ef1();return a574_0x34a4=function(_0x58ddbf,_0x5e2237){_0x58ddbf=_0x58ddbf-0x7e;let _0x5ef198=_0x436d4a[_0x58ddbf];return _0x5ef198;},a574_0x34a4(_0x58eff9,_0x457c90);}exports[a574_0x2e011d(0x8e)]=ScheduledMessageJob;