const a566_0x4e20b9=a566_0x3cab;function a566_0x4891(){const _0x191996=['Mensagem\x20agendada\x20enviada\x20para:\x20','get','(((.+)+)+)+$','defineProperty','Erro\x20ao\x20buscar\x20tag:','handleVerifySchedules','contact','../models/Contact','3tzrzCt','../../public/company','search','failed','body','YYYY-MM-DD\x20HH:mm','resolve','217292SsfGHF','format','1927720CbTEPi','ERRO','ID\x20da\x20tag\x20não\x20está\x20definido\x20em\x20scheduleRecord','configurable','SendScheduledMessage\x20->\x20Verify:\x20error','length','Tag\x20não\x20encontrada','__esModule','update','lte','rptDays','default','handleSendScheduledMessage','campId','../helpers/SendMessage','call','sendAt','add','@sentry/node','queue','findByPk','639600vFoegQ','VerifySchedules','\x20failed\x20with\x20error:\x20','9405BKxFyo','getRandomArbitrary','info','AGENDADA','companyId','logger','prototype','number','create','mediaPath','__importStar','then','captureException','YYYY-MM-DD\x20HH:mm:ss','bullmq','apply','374954KZaaAs','SendScheduledMessage\x20->\x20SendMessage:\x20error','491476cSEYiB','catch','../models/Tag','../utils/logger','438746UwkKlN','Error','error','msgR','SendMessage','name','Job\x20','Worker','sequelize','99sNqtYt','constructor','\x20completed','../models/Schedule','hasOwnProperty','PENDENTE','54GWHIor','getOwnPropertyDescriptor','findAll','__importDefault','ENVIADA','Disparo\x20agendado\x20para:\x20','message','__setModuleDefault'];a566_0x4891=function(){return _0x191996;};return a566_0x4891();}(function(_0x5a5507,_0x527d28){const _0x299d82=a566_0x3cab,_0x4662e2=_0x5a5507();while(!![]){try{const _0x348abf=-parseInt(_0x299d82(0x21e))/0x1+-parseInt(_0x299d82(0x220))/0x2+-parseInt(_0x299d82(0x1ed))/0x3*(parseInt(_0x299d82(0x1f4))/0x4)+parseInt(_0x299d82(0x20e))/0x5*(parseInt(_0x299d82(0x1dd))/0x6)+-parseInt(_0x299d82(0x224))/0x7+parseInt(_0x299d82(0x1f6))/0x8+parseInt(_0x299d82(0x1d7))/0x9*(parseInt(_0x299d82(0x20b))/0xa);if(_0x348abf===_0x527d28)break;else _0x4662e2['push'](_0x4662e2['shift']());}catch(_0x1560f4){_0x4662e2['push'](_0x4662e2['shift']());}}}(a566_0x4891,0x36a11));const a566_0x4e827c=(function(){let _0xbc7959=!![];return function(_0x4f3c84,_0x4784b8){const _0x4eebc5=_0xbc7959?function(){const _0x401ed9=a566_0x3cab;if(_0x4784b8){const _0x30bd80=_0x4784b8[_0x401ed9(0x21d)](_0x4f3c84,arguments);return _0x4784b8=null,_0x30bd80;}}:function(){};return _0xbc7959=![],_0x4eebc5;};}()),a566_0x2be934=a566_0x4e827c(this,function(){const _0x36d07c=a566_0x3cab;return a566_0x2be934['toString']()['search'](_0x36d07c(0x1e7))['toString']()[_0x36d07c(0x1d8)](a566_0x2be934)[_0x36d07c(0x1ef)](_0x36d07c(0x1e7));});a566_0x2be934();'use strict';var __createBinding=this&&this['__createBinding']||(Object[a566_0x4e20b9(0x216)]?function(_0x1fd638,_0x44b571,_0x2fe520,_0x526fcb){const _0x427cee=a566_0x4e20b9;if(_0x526fcb===undefined)_0x526fcb=_0x2fe520;var _0x3939ef=Object[_0x427cee(0x1de)](_0x44b571,_0x2fe520);(!_0x3939ef||(_0x427cee(0x1e6)in _0x3939ef?!_0x44b571[_0x427cee(0x1fd)]:_0x3939ef['writable']||_0x3939ef[_0x427cee(0x1f9)]))&&(_0x3939ef={'enumerable':!![],'get':function(){return _0x44b571[_0x2fe520];}}),Object[_0x427cee(0x1e8)](_0x1fd638,_0x526fcb,_0x3939ef);}:function(_0x1e4f9a,_0x4a17d5,_0x47ab7f,_0x3da7e2){if(_0x3da7e2===undefined)_0x3da7e2=_0x47ab7f;_0x1e4f9a[_0x3da7e2]=_0x4a17d5[_0x47ab7f];}),__setModuleDefault=this&&this[a566_0x4e20b9(0x1e4)]||(Object['create']?function(_0x2e191c,_0x1d63e2){Object['defineProperty'](_0x2e191c,'default',{'enumerable':!![],'value':_0x1d63e2});}:function(_0x1ae2c3,_0x39a055){_0x1ae2c3['default']=_0x39a055;}),__importStar=this&&this[a566_0x4e20b9(0x218)]||function(_0x5b4ff0){const _0x288234=a566_0x4e20b9;if(_0x5b4ff0&&_0x5b4ff0[_0x288234(0x1fd)])return _0x5b4ff0;var _0x21d573={};if(_0x5b4ff0!=null){for(var _0x313d1a in _0x5b4ff0)if(_0x313d1a!==_0x288234(0x201)&&Object[_0x288234(0x214)][_0x288234(0x1db)][_0x288234(0x205)](_0x5b4ff0,_0x313d1a))__createBinding(_0x21d573,_0x5b4ff0,_0x313d1a);}return __setModuleDefault(_0x21d573,_0x5b4ff0),_0x21d573;},__importDefault=this&&this[a566_0x4e20b9(0x1e0)]||function(_0x28dc7b){const _0x473b6e=a566_0x4e20b9;return _0x28dc7b&&_0x28dc7b[_0x473b6e(0x1fd)]?_0x28dc7b:{'default':_0x28dc7b};};Object[a566_0x4e20b9(0x1e8)](exports,a566_0x4e20b9(0x1fd),{'value':!![]});const bullmq_1=require(a566_0x4e20b9(0x21c)),Schedule_1=__importDefault(require(a566_0x4e20b9(0x1da))),Sentry=__importStar(require(a566_0x4e20b9(0x208))),logger_1=require(a566_0x4e20b9(0x223)),moment_1=__importDefault(require('moment/moment')),GetDefaultWhatsApp_1=__importDefault(require('../helpers/GetDefaultWhatsApp')),Tag_1=__importDefault(require(a566_0x4e20b9(0x222))),SendMessage_1=require(a566_0x4e20b9(0x204)),path_1=__importDefault(require('path')),sequelize_1=require(a566_0x4e20b9(0x1d6)),Contact_1=__importDefault(require(a566_0x4e20b9(0x1ec)));function a566_0x3cab(_0x557895,_0x56e9ad){const _0x145f84=a566_0x4891();return a566_0x3cab=function(_0x2be934,_0x4e827c){_0x2be934=_0x2be934-0x1d0;let _0x489100=_0x145f84[_0x2be934];return _0x489100;},a566_0x3cab(_0x557895,_0x56e9ad);}class ScheduledMessageJob{['getQueue'](){return this['queue'];}constructor(_0x42e4a6,_0x1a160b){const _0x392bbd=a566_0x4e20b9;this[_0x392bbd(0x209)]=_0x42e4a6;const _0x5369bb=new bullmq_1[(_0x392bbd(0x1d5))](_0x42e4a6[_0x392bbd(0x1d3)],async _0x144daf=>{const _0x5f4378=_0x392bbd;if(_0x144daf[_0x5f4378(0x1d3)]==_0x5f4378(0x1d2))await this[_0x5f4378(0x202)](_0x144daf);else _0x144daf[_0x5f4378(0x1d3)]==_0x5f4378(0x20c)&&await this[_0x5f4378(0x1ea)]();},{'concurrency':0x64,'connection':_0x1a160b,'removeOnFail':{'count':0x0}});_0x5369bb['on']('completed',async _0x258ef4=>{const _0x3bf665=_0x392bbd;logger_1[_0x3bf665(0x213)][_0x3bf665(0x210)](_0x3bf665(0x1d4)+_0x258ef4['id']+_0x3bf665(0x1d9));}),_0x5369bb['on'](_0x392bbd(0x1f0),async(_0x437d72,_0x5aceb6)=>{const _0x5c84a4=_0x392bbd;logger_1['logger'][_0x5c84a4(0x1d0)]('Job\x20'+_0x437d72[_0x5c84a4(0x1d3)]+_0x5c84a4(0x20d)+_0x5aceb6[_0x5c84a4(0x1e3)]);});}async[a566_0x4e20b9(0x1ea)](){const _0x1f9090=a566_0x4e20b9;try{const _0x566aed=await Schedule_1['default'][_0x1f9090(0x1df)]({'where':{'status':_0x1f9090(0x1dc),'sentAt':null,'sendAt':{[sequelize_1['Op'][_0x1f9090(0x1ff)]]:(0x0,moment_1[_0x1f9090(0x201)])()['format'](_0x1f9090(0x21b))}},'include':[{'model':Contact_1[_0x1f9090(0x201)],'as':_0x1f9090(0x1eb)}]});return _0x566aed?.[_0x1f9090(0x1fb)]>0x0&&_0x566aed['map'](async _0x3b4e01=>{const _0x386d60=_0x1f9090;await _0x3b4e01['update']({'status':_0x386d60(0x211)}),await this[_0x386d60(0x209)][_0x386d60(0x207)](_0x386d60(0x1d2),{'schedule':_0x3b4e01},{'delay':this[_0x386d60(0x20f)](0x3e8,0xbb8),'removeOnComplete':!![]}),logger_1[_0x386d60(0x213)][_0x386d60(0x210)](_0x386d60(0x1e2)+_0x3b4e01[_0x386d60(0x1eb)][_0x386d60(0x1d3)]);}),Promise[_0x1f9090(0x1f3)]({'count':_0x566aed[_0x1f9090(0x1fb)]});}catch(_0x425834){return Sentry[_0x1f9090(0x21a)](_0x425834),logger_1[_0x1f9090(0x213)]['error'](_0x1f9090(0x1fa),_0x425834[_0x1f9090(0x1e3)]),Promise['reject'](new sequelize_1[(_0x1f9090(0x225))](_0x425834));}}[a566_0x4e20b9(0x20f)](_0x25c8f8,_0x16fadf){return Math['random']()*(_0x16fadf-_0x25c8f8)+_0x25c8f8;}async[a566_0x4e20b9(0x202)](_0x477278){const _0x1f26d4=a566_0x4e20b9,{data:{schedule:_0x570457}}=_0x477278;let _0x3bd055=null;try{_0x3bd055=await Schedule_1[_0x1f26d4(0x201)][_0x1f26d4(0x20a)](_0x570457['id']);}catch(_0x482723){Sentry[_0x1f26d4(0x21a)](_0x482723),logger_1[_0x1f26d4(0x213)][_0x1f26d4(0x210)]('Erro\x20ao\x20tentar\x20consultar\x20agendamento:\x20'+_0x570457['id']);}try{if(_0x3bd055?.['daysR']!==null){let _0x5d7b2b=(0x0,moment_1['default'])(_0x3bd055[_0x1f26d4(0x206)]);const _0x1a8e6a=_0x570457[_0x1f26d4(0x212)],_0x8b24e2=await(0x0,GetDefaultWhatsApp_1[_0x1f26d4(0x201)])(_0x570457[_0x1f26d4(0x212)]);let _0x5e8817=null;const _0x43839c=_0x3bd055?.[_0x1f26d4(0x203)];_0x43839c?Tag_1['default'][_0x1f26d4(0x20a)](_0x43839c)[_0x1f26d4(0x219)](async _0x37cbfa=>{const _0x2375bb=_0x1f26d4;if(_0x37cbfa){let _0x310a31=_0x5d7b2b[_0x2375bb(0x207)](_0x37cbfa[_0x2375bb(0x200)],'days')['format'](_0x2375bb(0x1f2));_0x37cbfa[_0x2375bb(0x217)]&&(await(0x0,SendMessage_1[_0x2375bb(0x1d2)])(_0x8b24e2,{'number':_0x570457[_0x2375bb(0x1eb)][_0x2375bb(0x215)],'body':_0x37cbfa[_0x2375bb(0x1d1)]}),_0x5e8817=path_1['default'][_0x2375bb(0x1f3)](_0x2375bb(0x1ee)+_0x1a8e6a,_0x37cbfa[_0x2375bb(0x217)]),await(0x0,SendMessage_1[_0x2375bb(0x1d2)])(_0x8b24e2,{'number':_0x570457[_0x2375bb(0x1eb)][_0x2375bb(0x215)],'body':_0x37cbfa[_0x2375bb(0x1d1)],'mediaPath':_0x5e8817})),_0x37cbfa[_0x2375bb(0x200)]===0x0?await _0x3bd055?.[_0x2375bb(0x1fe)]({'sentAt':(0x0,moment_1[_0x2375bb(0x201)])()['format'](_0x2375bb(0x1f2)),'status':'ENVIADA'}):await _0x3bd055?.[_0x2375bb(0x1fe)]({'sendAt':_0x310a31,'status':_0x2375bb(0x1dc)}),logger_1[_0x2375bb(0x213)][_0x2375bb(0x210)]('Mensagem\x20agendada\x20enviada\x20para:\x20'+_0x570457[_0x2375bb(0x1eb)][_0x2375bb(0x1d3)]+'\x20');}else console['log'](_0x2375bb(0x1fc));})[_0x1f26d4(0x221)](_0x434efa=>{const _0x15e396=_0x1f26d4;console[_0x15e396(0x1d0)](_0x15e396(0x1e9),_0x434efa);}):console['log'](_0x1f26d4(0x1f8));}else{const _0x18ae41=await(0x0,GetDefaultWhatsApp_1[_0x1f26d4(0x201)])(_0x570457['companyId']);let _0x4a4150=null;_0x570457[_0x1f26d4(0x217)]&&(_0x4a4150=path_1['default'][_0x1f26d4(0x1f3)](_0x1f26d4(0x1ee)+_0x570457[_0x1f26d4(0x212)],_0x570457[_0x1f26d4(0x217)])),await(0x0,SendMessage_1[_0x1f26d4(0x1d2)])(_0x18ae41,{'number':_0x570457[_0x1f26d4(0x1eb)][_0x1f26d4(0x215)],'body':_0x570457[_0x1f26d4(0x1f1)],'mediaPath':_0x4a4150}),await _0x3bd055?.[_0x1f26d4(0x1fe)]({'sentAt':(0x0,moment_1[_0x1f26d4(0x201)])()[_0x1f26d4(0x1f5)](_0x1f26d4(0x1f2)),'status':_0x1f26d4(0x1e1)}),logger_1[_0x1f26d4(0x213)][_0x1f26d4(0x210)](_0x1f26d4(0x1e5)+_0x570457['contact'][_0x1f26d4(0x1d3)]);}}catch(_0x4e2bd7){Sentry[_0x1f26d4(0x21a)](_0x4e2bd7),await _0x3bd055?.['update']({'status':_0x1f26d4(0x1f7)}),logger_1[_0x1f26d4(0x213)]['error'](_0x1f26d4(0x21f),_0x4e2bd7[_0x1f26d4(0x1e3)]);throw _0x4e2bd7;}}}exports[a566_0x4e20b9(0x201)]=ScheduledMessageJob;