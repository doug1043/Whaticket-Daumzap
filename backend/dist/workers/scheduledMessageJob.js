const a577_0x4a0038=a577_0x3b53;(function(_0x5f5d34,_0x1b7617){const _0x24763c=a577_0x3b53,_0x12f5d5=_0x5f5d34();while(!![]){try{const _0x6ed721=parseInt(_0x24763c(0x17a))/0x1+parseInt(_0x24763c(0x12e))/0x2+parseInt(_0x24763c(0x135))/0x3+-parseInt(_0x24763c(0x15b))/0x4*(parseInt(_0x24763c(0x141))/0x5)+-parseInt(_0x24763c(0x145))/0x6*(parseInt(_0x24763c(0x16f))/0x7)+-parseInt(_0x24763c(0x162))/0x8*(-parseInt(_0x24763c(0x17d))/0x9)+-parseInt(_0x24763c(0x158))/0xa;if(_0x6ed721===_0x1b7617)break;else _0x12f5d5['push'](_0x12f5d5['shift']());}catch(_0x3779d1){_0x12f5d5['push'](_0x12f5d5['shift']());}}}(a577_0x2ebd,0xa5054));const a577_0x370774=(function(){let _0x539990=!![];return function(_0xb7f5d2,_0x4e5430){const _0x5730d1=_0x539990?function(){const _0x1e8f4=a577_0x3b53;if(_0x4e5430){const _0x1c7efb=_0x4e5430[_0x1e8f4(0x150)](_0xb7f5d2,arguments);return _0x4e5430=null,_0x1c7efb;}}:function(){};return _0x539990=![],_0x5730d1;};}()),a577_0x55f460=a577_0x370774(this,function(){const _0x5b0c2e=a577_0x3b53;return a577_0x55f460[_0x5b0c2e(0x131)]()[_0x5b0c2e(0x161)](_0x5b0c2e(0x129))['toString']()[_0x5b0c2e(0x14b)](a577_0x55f460)[_0x5b0c2e(0x161)](_0x5b0c2e(0x129));});a577_0x55f460();function a577_0x3b53(_0x3367db,_0x4bfa20){const _0xd9a2b0=a577_0x2ebd();return a577_0x3b53=function(_0x55f460,_0x370774){_0x55f460=_0x55f460-0x127;let _0x2ebdae=_0xd9a2b0[_0x55f460];return _0x2ebdae;},a577_0x3b53(_0x3367db,_0x4bfa20);}'use strict';var __createBinding=this&&this[a577_0x4a0038(0x152)]||(Object[a577_0x4a0038(0x148)]?function(_0x189b06,_0x3bdc84,_0x8cc4b5,_0x189659){const _0x209b3c=a577_0x4a0038;if(_0x189659===undefined)_0x189659=_0x8cc4b5;var _0x323f0e=Object[_0x209b3c(0x17c)](_0x3bdc84,_0x8cc4b5);(!_0x323f0e||(_0x209b3c(0x16a)in _0x323f0e?!_0x3bdc84['__esModule']:_0x323f0e[_0x209b3c(0x151)]||_0x323f0e[_0x209b3c(0x12d)]))&&(_0x323f0e={'enumerable':!![],'get':function(){return _0x3bdc84[_0x8cc4b5];}}),Object[_0x209b3c(0x169)](_0x189b06,_0x189659,_0x323f0e);}:function(_0x3cfbc1,_0x899b8e,_0xe3f7db,_0xbb975c){if(_0xbb975c===undefined)_0xbb975c=_0xe3f7db;_0x3cfbc1[_0xbb975c]=_0x899b8e[_0xe3f7db];}),__setModuleDefault=this&&this[a577_0x4a0038(0x167)]||(Object[a577_0x4a0038(0x148)]?function(_0x4840f8,_0xf1aef8){const _0x958eac=a577_0x4a0038;Object[_0x958eac(0x169)](_0x4840f8,'default',{'enumerable':!![],'value':_0xf1aef8});}:function(_0x28e559,_0x32fafd){const _0xa64d09=a577_0x4a0038;_0x28e559[_0xa64d09(0x17e)]=_0x32fafd;}),__importStar=this&&this[a577_0x4a0038(0x14f)]||function(_0x1a32e9){const _0x459511=a577_0x4a0038;if(_0x1a32e9&&_0x1a32e9['__esModule'])return _0x1a32e9;var _0x245222={};if(_0x1a32e9!=null){for(var _0x5cbfe2 in _0x1a32e9)if(_0x5cbfe2!==_0x459511(0x17e)&&Object['prototype'][_0x459511(0x14a)][_0x459511(0x13c)](_0x1a32e9,_0x5cbfe2))__createBinding(_0x245222,_0x1a32e9,_0x5cbfe2);}return __setModuleDefault(_0x245222,_0x1a32e9),_0x245222;},__importDefault=this&&this[a577_0x4a0038(0x13e)]||function(_0x18d623){const _0x3ce349=a577_0x4a0038;return _0x18d623&&_0x18d623[_0x3ce349(0x13f)]?_0x18d623:{'default':_0x18d623};};Object[a577_0x4a0038(0x169)](exports,a577_0x4a0038(0x13f),{'value':!![]});function a577_0x2ebd(){const _0x564b6b=['Error','create','path','hasOwnProperty','constructor','../models/Schedule','format','findByPk','__importStar','apply','writable','__createBinding','ENVIADA','Tag\x20não\x20encontrada','SendMessage','add','lte','7411950ojAsLH','campId','body','845980ByFCOS','../../public/company','handleVerifySchedules','days','YYYY-MM-DD\x20HH:mm:ss','findAll','search','3599496McnaDI','resolve','length','sequelize','ID\x20da\x20tag\x20não\x20está\x20definido\x20em\x20scheduleRecord','__setModuleDefault','companyId','defineProperty','get','message','AGENDADA','msgR','logger','1110025mmWUNc','../models/Contact','map','update','daysR','random','info','rptDays','completed','Job\x20','getRandomArbitrary','640236yYawqN','Disparo\x20agendado\x20para:\x20','getOwnPropertyDescriptor','9tYdWQG','default','mediaPath','moment/moment','(((.+)+)+)+$','\x20completed','PENDENTE','../models/Tag','configurable','1500248LmenJR','number','SendScheduledMessage\x20->\x20Verify:\x20error','toString','contact','handleSendScheduledMessage','name','2854341YEcpvO','getQueue','captureException','error','failed','queue','log','call','Erro\x20ao\x20buscar\x20tag:','__importDefault','__esModule','sendAt','25ZvYKPs','Erro\x20ao\x20tentar\x20consultar\x20agendamento:\x20','@sentry/node','then','12YxKQgq','YYYY-MM-DD\x20HH:mm'];a577_0x2ebd=function(){return _0x564b6b;};return a577_0x2ebd();}const bullmq_1=require('bullmq'),Schedule_1=__importDefault(require(a577_0x4a0038(0x14c))),Sentry=__importStar(require(a577_0x4a0038(0x143))),logger_1=require('../utils/logger'),moment_1=__importDefault(require(a577_0x4a0038(0x128))),GetDefaultWhatsApp_1=__importDefault(require('../helpers/GetDefaultWhatsApp')),Tag_1=__importDefault(require(a577_0x4a0038(0x12c))),SendMessage_1=require('../helpers/SendMessage'),path_1=__importDefault(require(a577_0x4a0038(0x149))),sequelize_1=require(a577_0x4a0038(0x165)),Contact_1=__importDefault(require(a577_0x4a0038(0x170)));class ScheduledMessageJob{[a577_0x4a0038(0x136)](){const _0x4918ad=a577_0x4a0038;return this[_0x4918ad(0x13a)];}constructor(_0x187b9f,_0x4a4a2a){const _0x1f9d60=a577_0x4a0038;this[_0x1f9d60(0x13a)]=_0x187b9f;const _0x3ffca2=new bullmq_1['Worker'](_0x187b9f[_0x1f9d60(0x134)],async _0x1dc0f1=>{const _0x55b5cc=_0x1f9d60;if(_0x1dc0f1[_0x55b5cc(0x134)]==_0x55b5cc(0x155))await this[_0x55b5cc(0x133)](_0x1dc0f1);else _0x1dc0f1[_0x55b5cc(0x134)]=='VerifySchedules'&&await this[_0x55b5cc(0x15d)]();},{'concurrency':0x64,'connection':_0x4a4a2a,'removeOnFail':{'count':0x0}});_0x3ffca2['on'](_0x1f9d60(0x177),async _0x4e94c7=>{const _0x2a374a=_0x1f9d60;logger_1[_0x2a374a(0x16e)]['info'](_0x2a374a(0x178)+_0x4e94c7['id']+_0x2a374a(0x12a));}),_0x3ffca2['on'](_0x1f9d60(0x139),async(_0xb5eff3,_0x354469)=>{const _0x2d63c5=_0x1f9d60;logger_1[_0x2d63c5(0x16e)][_0x2d63c5(0x138)](_0x2d63c5(0x178)+_0xb5eff3[_0x2d63c5(0x134)]+'\x20failed\x20with\x20error:\x20'+_0x354469[_0x2d63c5(0x16b)]);});}async[a577_0x4a0038(0x15d)](){const _0x4db7e5=a577_0x4a0038;try{const _0x2a7a10=await Schedule_1[_0x4db7e5(0x17e)][_0x4db7e5(0x160)]({'where':{'status':'PENDENTE','sentAt':null,'sendAt':{[sequelize_1['Op'][_0x4db7e5(0x157)]]:(0x0,moment_1[_0x4db7e5(0x17e)])()[_0x4db7e5(0x14d)](_0x4db7e5(0x15f))}},'include':[{'model':Contact_1[_0x4db7e5(0x17e)],'as':'contact'}]});return _0x2a7a10?.['length']>0x0&&_0x2a7a10[_0x4db7e5(0x171)](async _0x478b18=>{const _0x1d1c58=_0x4db7e5;await _0x478b18[_0x1d1c58(0x172)]({'status':_0x1d1c58(0x16c)}),await this[_0x1d1c58(0x13a)][_0x1d1c58(0x156)](_0x1d1c58(0x155),{'schedule':_0x478b18},{'delay':this[_0x1d1c58(0x179)](0x3e8,0xbb8),'removeOnComplete':!![]}),logger_1[_0x1d1c58(0x16e)][_0x1d1c58(0x175)](_0x1d1c58(0x17b)+_0x478b18['contact'][_0x1d1c58(0x134)]);}),Promise['resolve']({'count':_0x2a7a10[_0x4db7e5(0x164)]});}catch(_0x2063d1){return Sentry[_0x4db7e5(0x137)](_0x2063d1),logger_1[_0x4db7e5(0x16e)][_0x4db7e5(0x138)](_0x4db7e5(0x130),_0x2063d1[_0x4db7e5(0x16b)]),Promise['reject'](new sequelize_1[(_0x4db7e5(0x147))](_0x2063d1));}}[a577_0x4a0038(0x179)](_0x1e6f79,_0x2d068f){const _0x5230fb=a577_0x4a0038;return Math[_0x5230fb(0x174)]()*(_0x2d068f-_0x1e6f79)+_0x1e6f79;}async[a577_0x4a0038(0x133)](_0x3379a3){const _0x4c2791=a577_0x4a0038,{data:{schedule:_0x165f08}}=_0x3379a3;let _0x540a41=null;try{_0x540a41=await Schedule_1[_0x4c2791(0x17e)][_0x4c2791(0x14e)](_0x165f08['id']);}catch(_0x2ad2a1){Sentry[_0x4c2791(0x137)](_0x2ad2a1),logger_1[_0x4c2791(0x16e)][_0x4c2791(0x175)](_0x4c2791(0x142)+_0x165f08['id']);}try{if(_0x540a41?.[_0x4c2791(0x173)]!==null){let _0x5763a4=(0x0,moment_1[_0x4c2791(0x17e)])(_0x540a41[_0x4c2791(0x140)]);const _0x30baf9=_0x165f08[_0x4c2791(0x168)],_0x556cc5=await(0x0,GetDefaultWhatsApp_1['default'])(_0x165f08['companyId']);let _0x43556b=null;const _0x91ea95=_0x540a41?.[_0x4c2791(0x159)];_0x91ea95?Tag_1['default'][_0x4c2791(0x14e)](_0x91ea95)[_0x4c2791(0x144)](async _0x1f093d=>{const _0x539e67=_0x4c2791;if(_0x1f093d){let _0x6ba0d7=_0x5763a4[_0x539e67(0x156)](_0x1f093d['rptDays'],_0x539e67(0x15e))[_0x539e67(0x14d)](_0x539e67(0x146));_0x1f093d[_0x539e67(0x127)]&&(await(0x0,SendMessage_1['SendMessage'])(_0x556cc5,{'number':_0x165f08[_0x539e67(0x132)][_0x539e67(0x12f)],'body':_0x1f093d[_0x539e67(0x16d)]}),_0x43556b=path_1[_0x539e67(0x17e)][_0x539e67(0x163)](_0x539e67(0x15c)+_0x30baf9,_0x1f093d[_0x539e67(0x127)]),await(0x0,SendMessage_1['SendMessage'])(_0x556cc5,{'number':_0x165f08[_0x539e67(0x132)][_0x539e67(0x12f)],'body':_0x1f093d['msgR'],'mediaPath':_0x43556b})),_0x1f093d[_0x539e67(0x176)]===0x0?await _0x540a41?.['update']({'sentAt':(0x0,moment_1['default'])()[_0x539e67(0x14d)](_0x539e67(0x146)),'status':'ENVIADA'}):await _0x540a41?.[_0x539e67(0x172)]({'sendAt':_0x6ba0d7,'status':_0x539e67(0x12b)}),logger_1['logger'][_0x539e67(0x175)]('Mensagem\x20agendada\x20enviada\x20para:\x20'+_0x165f08['contact'][_0x539e67(0x134)]+'\x20');}else console['log'](_0x539e67(0x154));})['catch'](_0xb72b9b=>{const _0x433eee=_0x4c2791;console['error'](_0x433eee(0x13d),_0xb72b9b);}):console[_0x4c2791(0x13b)](_0x4c2791(0x166));}else{const _0x5518a7=await(0x0,GetDefaultWhatsApp_1[_0x4c2791(0x17e)])(_0x165f08[_0x4c2791(0x168)]);let _0x3207b8=null;_0x165f08[_0x4c2791(0x127)]&&(_0x3207b8=path_1[_0x4c2791(0x17e)][_0x4c2791(0x163)](_0x4c2791(0x15c)+_0x165f08[_0x4c2791(0x168)],_0x165f08[_0x4c2791(0x127)])),await(0x0,SendMessage_1['SendMessage'])(_0x5518a7,{'number':_0x165f08[_0x4c2791(0x132)][_0x4c2791(0x12f)],'body':_0x165f08[_0x4c2791(0x15a)],'mediaPath':_0x3207b8}),await _0x540a41?.[_0x4c2791(0x172)]({'sentAt':(0x0,moment_1[_0x4c2791(0x17e)])()[_0x4c2791(0x14d)](_0x4c2791(0x146)),'status':_0x4c2791(0x153)}),logger_1[_0x4c2791(0x16e)][_0x4c2791(0x175)]('Mensagem\x20agendada\x20enviada\x20para:\x20'+_0x165f08['contact'][_0x4c2791(0x134)]);}}catch(_0x558ff6){Sentry[_0x4c2791(0x137)](_0x558ff6),await _0x540a41?.[_0x4c2791(0x172)]({'status':'ERRO'}),logger_1[_0x4c2791(0x16e)][_0x4c2791(0x138)]('SendScheduledMessage\x20->\x20SendMessage:\x20error',_0x558ff6[_0x4c2791(0x16b)]);throw _0x558ff6;}}}exports[a577_0x4a0038(0x17e)]=ScheduledMessageJob;