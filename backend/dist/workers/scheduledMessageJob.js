const a577_0x200142=a577_0x139b;(function(_0x1baef4,_0x45ecd1){const _0x53d4ef=a577_0x139b,_0x3874bf=_0x1baef4();while(!![]){try{const _0x5575bf=parseInt(_0x53d4ef(0x130))/0x1*(-parseInt(_0x53d4ef(0x10b))/0x2)+parseInt(_0x53d4ef(0x14f))/0x3*(-parseInt(_0x53d4ef(0x108))/0x4)+-parseInt(_0x53d4ef(0x119))/0x5+-parseInt(_0x53d4ef(0x148))/0x6*(-parseInt(_0x53d4ef(0x110))/0x7)+parseInt(_0x53d4ef(0x13e))/0x8+-parseInt(_0x53d4ef(0x155))/0x9+parseInt(_0x53d4ef(0x149))/0xa;if(_0x5575bf===_0x45ecd1)break;else _0x3874bf['push'](_0x3874bf['shift']());}catch(_0x44157d){_0x3874bf['push'](_0x3874bf['shift']());}}}(a577_0x1de5,0x70506));const a577_0x261909=(function(){let _0x5eace5=!![];return function(_0x3067c2,_0x3b7263){const _0x1a4850=_0x5eace5?function(){const _0x15aa7c=a577_0x139b;if(_0x3b7263){const _0x177e46=_0x3b7263[_0x15aa7c(0x138)](_0x3067c2,arguments);return _0x3b7263=null,_0x177e46;}}:function(){};return _0x5eace5=![],_0x1a4850;};}()),a577_0x3730d8=a577_0x261909(this,function(){const _0x508774=a577_0x139b;return a577_0x3730d8[_0x508774(0x13b)]()[_0x508774(0x128)](_0x508774(0x124))['toString']()[_0x508774(0x12f)](a577_0x3730d8)['search'](_0x508774(0x124));});function a577_0x139b(_0x3144fe,_0x59165e){const _0x17478f=a577_0x1de5();return a577_0x139b=function(_0x3730d8,_0x261909){_0x3730d8=_0x3730d8-0x107;let _0x1de58b=_0x17478f[_0x3730d8];return _0x1de58b;},a577_0x139b(_0x3144fe,_0x59165e);}a577_0x3730d8();'use strict';function a577_0x1de5(){const _0x407d9b=['sequelize','prototype','queue','ERRO','__importDefault','YYYY-MM-DD\x20HH:mm','../../public/company','Mensagem\x20agendada\x20enviada\x20para:\x20','defineProperty','6dbTGNs','20081190npaXVz','getOwnPropertyDescriptor','Worker','SendMessage','ENVIADA','companyId','1509CcNORn','random','info','../models/Tag','daysR','rptDays','1936737TFoxww','__setModuleDefault','__importStar','captureException','VerifySchedules','@sentry/node','getQueue','default','update','map','findByPk','6180YAdDFv','__esModule','handleSendScheduledMessage','17776jnDOKN','sendAt','configurable','moment/moment','getRandomArbitrary','1242927NHlslk','resolve','__createBinding','writable','reject','AGENDADA','hasOwnProperty','length','logger','1099275zniWrW','log','error','Job\x20','SendScheduledMessage\x20->\x20SendMessage:\x20error','add','Erro\x20ao\x20tentar\x20consultar\x20agendamento:\x20','\x20completed','Error','then','format','(((.+)+)+)+$','catch','contact','name','search','completed','Disparo\x20agendado\x20para:\x20','findAll','lte','message','create','constructor','61alvKbk','../helpers/GetDefaultWhatsApp','msgR','\x20failed\x20with\x20error:\x20','number','get','../models/Schedule','failed','apply','mediaPath','SendScheduledMessage\x20->\x20Verify:\x20error','toString','PENDENTE','../utils/logger','229672lHmCLS'];a577_0x1de5=function(){return _0x407d9b;};return a577_0x1de5();}var __createBinding=this&&this[a577_0x200142(0x112)]||(Object[a577_0x200142(0x12e)]?function(_0x3dbd8d,_0x4c530c,_0x176d3f,_0x1ffe63){const _0xce04c2=a577_0x200142;if(_0x1ffe63===undefined)_0x1ffe63=_0x176d3f;var _0x8c3939=Object[_0xce04c2(0x14a)](_0x4c530c,_0x176d3f);(!_0x8c3939||(_0xce04c2(0x135)in _0x8c3939?!_0x4c530c[_0xce04c2(0x109)]:_0x8c3939[_0xce04c2(0x113)]||_0x8c3939[_0xce04c2(0x10d)]))&&(_0x8c3939={'enumerable':!![],'get':function(){return _0x4c530c[_0x176d3f];}}),Object[_0xce04c2(0x147)](_0x3dbd8d,_0x1ffe63,_0x8c3939);}:function(_0x3c62a6,_0x5452e5,_0x1a137a,_0x18503f){if(_0x18503f===undefined)_0x18503f=_0x1a137a;_0x3c62a6[_0x18503f]=_0x5452e5[_0x1a137a];}),__setModuleDefault=this&&this[a577_0x200142(0x156)]||(Object[a577_0x200142(0x12e)]?function(_0x3506c6,_0xcf0a85){const _0x325f7c=a577_0x200142;Object[_0x325f7c(0x147)](_0x3506c6,_0x325f7c(0x15c),{'enumerable':!![],'value':_0xcf0a85});}:function(_0x43aaef,_0x594ab6){_0x43aaef['default']=_0x594ab6;}),__importStar=this&&this[a577_0x200142(0x157)]||function(_0x263665){const _0x2c3f63=a577_0x200142;if(_0x263665&&_0x263665[_0x2c3f63(0x109)])return _0x263665;var _0x22a26f={};if(_0x263665!=null){for(var _0x17b1e6 in _0x263665)if(_0x17b1e6!=='default'&&Object[_0x2c3f63(0x140)][_0x2c3f63(0x116)]['call'](_0x263665,_0x17b1e6))__createBinding(_0x22a26f,_0x263665,_0x17b1e6);}return __setModuleDefault(_0x22a26f,_0x263665),_0x22a26f;},__importDefault=this&&this[a577_0x200142(0x143)]||function(_0x5098ec){const _0x33cc91=a577_0x200142;return _0x5098ec&&_0x5098ec[_0x33cc91(0x109)]?_0x5098ec:{'default':_0x5098ec};};Object['defineProperty'](exports,'__esModule',{'value':!![]});const bullmq_1=require('bullmq'),Schedule_1=__importDefault(require(a577_0x200142(0x136))),Sentry=__importStar(require(a577_0x200142(0x15a))),logger_1=require(a577_0x200142(0x13d)),moment_1=__importDefault(require(a577_0x200142(0x10e))),GetDefaultWhatsApp_1=__importDefault(require(a577_0x200142(0x131))),Tag_1=__importDefault(require(a577_0x200142(0x152))),SendMessage_1=require('../helpers/SendMessage'),path_1=__importDefault(require('path')),sequelize_1=require(a577_0x200142(0x13f)),Contact_1=__importDefault(require('../models/Contact'));class ScheduledMessageJob{[a577_0x200142(0x15b)](){const _0x502301=a577_0x200142;return this[_0x502301(0x141)];}constructor(_0x5c9f4a,_0x4f5d98){const _0x43f23b=a577_0x200142;this[_0x43f23b(0x141)]=_0x5c9f4a;const _0x3e3383=new bullmq_1[(_0x43f23b(0x14b))](_0x5c9f4a[_0x43f23b(0x127)],async _0x191d4d=>{const _0x3081da=_0x43f23b;if(_0x191d4d[_0x3081da(0x127)]==_0x3081da(0x14c))await this[_0x3081da(0x10a)](_0x191d4d);else _0x191d4d[_0x3081da(0x127)]==_0x3081da(0x159)&&await this['handleVerifySchedules']();},{'concurrency':0x64,'connection':_0x4f5d98,'removeOnFail':{'count':0x0}});_0x3e3383['on'](_0x43f23b(0x129),async _0x238c83=>{const _0xafa906=_0x43f23b;logger_1[_0xafa906(0x118)][_0xafa906(0x151)](_0xafa906(0x11c)+_0x238c83['id']+_0xafa906(0x120));}),_0x3e3383['on'](_0x43f23b(0x137),async(_0x176c50,_0x39ed5a)=>{const _0xae2e76=_0x43f23b;logger_1[_0xae2e76(0x118)][_0xae2e76(0x11b)](_0xae2e76(0x11c)+_0x176c50[_0xae2e76(0x127)]+_0xae2e76(0x133)+_0x39ed5a[_0xae2e76(0x12d)]);});}async['handleVerifySchedules'](){const _0x27fc3c=a577_0x200142;try{const _0x452016=await Schedule_1[_0x27fc3c(0x15c)][_0x27fc3c(0x12b)]({'where':{'status':_0x27fc3c(0x13c),'sentAt':null,'sendAt':{[sequelize_1['Op'][_0x27fc3c(0x12c)]]:(0x0,moment_1[_0x27fc3c(0x15c)])()['format']('YYYY-MM-DD\x20HH:mm:ss')}},'include':[{'model':Contact_1[_0x27fc3c(0x15c)],'as':_0x27fc3c(0x126)}]});return _0x452016?.[_0x27fc3c(0x117)]>0x0&&_0x452016[_0x27fc3c(0x15e)](async _0x4ccd73=>{const _0x3a61b5=_0x27fc3c;await _0x4ccd73['update']({'status':_0x3a61b5(0x115)}),await this['queue'][_0x3a61b5(0x11e)]('SendMessage',{'schedule':_0x4ccd73},{'delay':this[_0x3a61b5(0x10f)](0x3e8,0xbb8),'removeOnComplete':!![]}),logger_1[_0x3a61b5(0x118)][_0x3a61b5(0x151)](_0x3a61b5(0x12a)+_0x4ccd73[_0x3a61b5(0x126)][_0x3a61b5(0x127)]);}),Promise[_0x27fc3c(0x111)]({'count':_0x452016[_0x27fc3c(0x117)]});}catch(_0x2401d0){return Sentry[_0x27fc3c(0x158)](_0x2401d0),logger_1[_0x27fc3c(0x118)][_0x27fc3c(0x11b)](_0x27fc3c(0x13a),_0x2401d0['message']),Promise[_0x27fc3c(0x114)](new sequelize_1[(_0x27fc3c(0x121))](_0x2401d0));}}['getRandomArbitrary'](_0x19bfe3,_0x1bbdd6){const _0x4b254b=a577_0x200142;return Math[_0x4b254b(0x150)]()*(_0x1bbdd6-_0x19bfe3)+_0x19bfe3;}async[a577_0x200142(0x10a)](_0x274438){const _0x518c8b=a577_0x200142,{data:{schedule:_0x283adb}}=_0x274438;let _0x26012d=null;try{_0x26012d=await Schedule_1[_0x518c8b(0x15c)][_0x518c8b(0x107)](_0x283adb['id']);}catch(_0x552fb9){Sentry[_0x518c8b(0x158)](_0x552fb9),logger_1[_0x518c8b(0x118)][_0x518c8b(0x151)](_0x518c8b(0x11f)+_0x283adb['id']);}try{if(_0x26012d?.[_0x518c8b(0x153)]!==null){let _0x2f5547=(0x0,moment_1[_0x518c8b(0x15c)])(_0x26012d[_0x518c8b(0x10c)]);const _0x37f78f=_0x283adb[_0x518c8b(0x14e)],_0x127c77=await(0x0,GetDefaultWhatsApp_1[_0x518c8b(0x15c)])(_0x283adb['companyId']);let _0x1e306e=null;const _0x28a757=_0x26012d?.['campId'];_0x28a757?Tag_1[_0x518c8b(0x15c)][_0x518c8b(0x107)](_0x28a757)[_0x518c8b(0x122)](async _0x4cb4bb=>{const _0x136e2f=_0x518c8b;if(_0x4cb4bb){let _0x358145=_0x2f5547[_0x136e2f(0x11e)](_0x4cb4bb['rptDays'],'days')['format'](_0x136e2f(0x144));_0x4cb4bb[_0x136e2f(0x139)]&&(await(0x0,SendMessage_1[_0x136e2f(0x14c)])(_0x127c77,{'number':_0x283adb['contact'][_0x136e2f(0x134)],'body':_0x4cb4bb['msgR']}),_0x1e306e=path_1['default'][_0x136e2f(0x111)](_0x136e2f(0x145)+_0x37f78f,_0x4cb4bb[_0x136e2f(0x139)]),await(0x0,SendMessage_1[_0x136e2f(0x14c)])(_0x127c77,{'number':_0x283adb[_0x136e2f(0x126)][_0x136e2f(0x134)],'body':_0x4cb4bb[_0x136e2f(0x132)],'mediaPath':_0x1e306e})),_0x4cb4bb[_0x136e2f(0x154)]===0x0?await _0x26012d?.['update']({'sentAt':(0x0,moment_1['default'])()['format'](_0x136e2f(0x144)),'status':_0x136e2f(0x14d)}):await _0x26012d?.[_0x136e2f(0x15d)]({'sendAt':_0x358145,'status':'PENDENTE'}),logger_1[_0x136e2f(0x118)][_0x136e2f(0x151)]('Mensagem\x20agendada\x20enviada\x20para:\x20'+_0x283adb[_0x136e2f(0x126)][_0x136e2f(0x127)]+'\x20');}else console[_0x136e2f(0x11a)]('Tag\x20não\x20encontrada');})[_0x518c8b(0x125)](_0x367555=>{const _0x55ee50=_0x518c8b;console[_0x55ee50(0x11b)]('Erro\x20ao\x20buscar\x20tag:',_0x367555);}):console[_0x518c8b(0x11a)]('ID\x20da\x20tag\x20não\x20está\x20definido\x20em\x20scheduleRecord');}else{const _0x378b29=await(0x0,GetDefaultWhatsApp_1[_0x518c8b(0x15c)])(_0x283adb[_0x518c8b(0x14e)]);let _0x1c8d31=null;_0x283adb[_0x518c8b(0x139)]&&(_0x1c8d31=path_1[_0x518c8b(0x15c)][_0x518c8b(0x111)](_0x518c8b(0x145)+_0x283adb[_0x518c8b(0x14e)],_0x283adb['mediaPath'])),await(0x0,SendMessage_1['SendMessage'])(_0x378b29,{'number':_0x283adb['contact'][_0x518c8b(0x134)],'body':_0x283adb['body'],'mediaPath':_0x1c8d31}),await _0x26012d?.[_0x518c8b(0x15d)]({'sentAt':(0x0,moment_1['default'])()[_0x518c8b(0x123)]('YYYY-MM-DD\x20HH:mm'),'status':_0x518c8b(0x14d)}),logger_1[_0x518c8b(0x118)][_0x518c8b(0x151)](_0x518c8b(0x146)+_0x283adb[_0x518c8b(0x126)][_0x518c8b(0x127)]);}}catch(_0x8007ed){Sentry['captureException'](_0x8007ed),await _0x26012d?.['update']({'status':_0x518c8b(0x142)}),logger_1[_0x518c8b(0x118)]['error'](_0x518c8b(0x11d),_0x8007ed[_0x518c8b(0x12d)]);throw _0x8007ed;}}}exports[a577_0x200142(0x15c)]=ScheduledMessageJob;