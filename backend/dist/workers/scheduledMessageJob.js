function a574_0x239a(_0x58a430,_0x55d914){const _0x59a8c3=a574_0x350f();return a574_0x239a=function(_0x1095c4,_0xd564b4){_0x1095c4=_0x1095c4-0xaa;let _0x350fab=_0x59a8c3[_0x1095c4];return _0x350fab;},a574_0x239a(_0x58a430,_0x55d914);}const a574_0x24d52f=a574_0x239a;(function(_0x3a0f52,_0x16d03e){const _0x3947b6=a574_0x239a,_0x65556c=_0x3a0f52();while(!![]){try{const _0x5aa957=-parseInt(_0x3947b6(0xb9))/0x1+parseInt(_0x3947b6(0xef))/0x2+parseInt(_0x3947b6(0xdf))/0x3+parseInt(_0x3947b6(0xba))/0x4*(parseInt(_0x3947b6(0xe8))/0x5)+-parseInt(_0x3947b6(0xf2))/0x6+parseInt(_0x3947b6(0xad))/0x7*(parseInt(_0x3947b6(0xdc))/0x8)+-parseInt(_0x3947b6(0xf9))/0x9;if(_0x5aa957===_0x16d03e)break;else _0x65556c['push'](_0x65556c['shift']());}catch(_0x7f2dec){_0x65556c['push'](_0x65556c['shift']());}}}(a574_0x350f,0x18f8b));const a574_0xd564b4=(function(){let _0x505c69=!![];return function(_0x6633b5,_0x19c1af){const _0x42cd79=_0x505c69?function(){const _0x21146e=a574_0x239a;if(_0x19c1af){const _0x5a2914=_0x19c1af[_0x21146e(0xec)](_0x6633b5,arguments);return _0x19c1af=null,_0x5a2914;}}:function(){};return _0x505c69=![],_0x42cd79;};}()),a574_0x1095c4=a574_0xd564b4(this,function(){const _0x477f9e=a574_0x239a;return a574_0x1095c4['toString']()[_0x477f9e(0xb3)](_0x477f9e(0xfd))['toString']()[_0x477f9e(0xc9)](a574_0x1095c4)['search'](_0x477f9e(0xfd));});a574_0x1095c4();'use strict';function a574_0x350f(){const _0x3db516=['SendMessage','constructor','ENVIADA','default','mediaPath','reject','error','Erro\x20ao\x20tentar\x20consultar\x20agendamento:\x20','number','sendAt','captureException','call','name','update','logger','handleVerifySchedules','defineProperty','lte','__esModule','../models/Schedule','632GUHNjA','../helpers/GetDefaultWhatsApp','configurable','99729qQyKLz','../../public/company','random','findByPk','SendScheduledMessage\x20->\x20Verify:\x20error','../utils/logger','\x20completed','Error','create','925230uluxpH','@sentry/node','Erro\x20ao\x20buscar\x20tag:','AGENDADA','apply','findAll','hasOwnProperty','299516JSiyQp','ID\x20da\x20tag\x20não\x20está\x20definido\x20em\x20scheduleRecord','add','1016160SrUaCq','resolve','body','days','bullmq','msgR','completed','2126808nmdRWw','info','message','campId','(((.+)+)+)+$','failed','companyId','getQueue','__createBinding','length','get','15442jEUrko','format','Tag\x20não\x20encontrada','contact','PENDENTE','map','search','writable','Mensagem\x20agendada\x20enviada\x20para:\x20','catch','rptDays','getOwnPropertyDescriptor','34366Drfgqc','4LYPOEv','YYYY-MM-DD\x20HH:mm:ss','log','queue','__importStar','handleSendScheduledMessage','YYYY-MM-DD\x20HH:mm','Job\x20','then','moment/moment','ERRO','sequelize','getRandomArbitrary','Disparo\x20agendado\x20para:\x20'];a574_0x350f=function(){return _0x3db516;};return a574_0x350f();}var __createBinding=this&&this[a574_0x24d52f(0xaa)]||(Object['create']?function(_0x2bc5a6,_0x3daf9d,_0x5612f3,_0xc95c70){const _0x5dd55e=a574_0x24d52f;if(_0xc95c70===undefined)_0xc95c70=_0x5612f3;var _0x1e0d32=Object[_0x5dd55e(0xb8)](_0x3daf9d,_0x5612f3);(!_0x1e0d32||(_0x5dd55e(0xac)in _0x1e0d32?!_0x3daf9d[_0x5dd55e(0xda)]:_0x1e0d32[_0x5dd55e(0xb4)]||_0x1e0d32[_0x5dd55e(0xde)]))&&(_0x1e0d32={'enumerable':!![],'get':function(){return _0x3daf9d[_0x5612f3];}}),Object[_0x5dd55e(0xd8)](_0x2bc5a6,_0xc95c70,_0x1e0d32);}:function(_0x16c17c,_0x5ce1ff,_0x12a77d,_0x265479){if(_0x265479===undefined)_0x265479=_0x12a77d;_0x16c17c[_0x265479]=_0x5ce1ff[_0x12a77d];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a574_0x24d52f(0xe7)]?function(_0xcded50,_0x17d6d8){const _0x16f06b=a574_0x24d52f;Object[_0x16f06b(0xd8)](_0xcded50,_0x16f06b(0xcb),{'enumerable':!![],'value':_0x17d6d8});}:function(_0x4fc736,_0x42949){const _0x2e22e0=a574_0x24d52f;_0x4fc736[_0x2e22e0(0xcb)]=_0x42949;}),__importStar=this&&this[a574_0x24d52f(0xbe)]||function(_0x4a8104){const _0x29b437=a574_0x24d52f;if(_0x4a8104&&_0x4a8104[_0x29b437(0xda)])return _0x4a8104;var _0x274f7c={};if(_0x4a8104!=null){for(var _0x5581a2 in _0x4a8104)if(_0x5581a2!==_0x29b437(0xcb)&&Object['prototype'][_0x29b437(0xee)][_0x29b437(0xd3)](_0x4a8104,_0x5581a2))__createBinding(_0x274f7c,_0x4a8104,_0x5581a2);}return __setModuleDefault(_0x274f7c,_0x4a8104),_0x274f7c;},__importDefault=this&&this['__importDefault']||function(_0x5522bd){const _0xadcba=a574_0x24d52f;return _0x5522bd&&_0x5522bd[_0xadcba(0xda)]?_0x5522bd:{'default':_0x5522bd};};Object[a574_0x24d52f(0xd8)](exports,a574_0x24d52f(0xda),{'value':!![]});const bullmq_1=require(a574_0x24d52f(0xf6)),Schedule_1=__importDefault(require(a574_0x24d52f(0xdb))),Sentry=__importStar(require(a574_0x24d52f(0xe9))),logger_1=require(a574_0x24d52f(0xe4)),moment_1=__importDefault(require(a574_0x24d52f(0xc3))),GetDefaultWhatsApp_1=__importDefault(require(a574_0x24d52f(0xdd))),Tag_1=__importDefault(require('../models/Tag')),SendMessage_1=require('../helpers/SendMessage'),path_1=__importDefault(require('path')),sequelize_1=require(a574_0x24d52f(0xc5)),Contact_1=__importDefault(require('../models/Contact'));class ScheduledMessageJob{[a574_0x24d52f(0x100)](){return this['queue'];}constructor(_0x2d8699,_0x174a57){const _0x303cd3=a574_0x24d52f;this[_0x303cd3(0xbd)]=_0x2d8699;const _0x1a6546=new bullmq_1['Worker'](_0x2d8699[_0x303cd3(0xd4)],async _0xf351ff=>{const _0x59a0eb=_0x303cd3;if(_0xf351ff[_0x59a0eb(0xd4)]==_0x59a0eb(0xc8))await this[_0x59a0eb(0xbf)](_0xf351ff);else _0xf351ff[_0x59a0eb(0xd4)]=='VerifySchedules'&&await this[_0x59a0eb(0xd7)]();},{'concurrency':0x64,'connection':_0x174a57,'removeOnFail':{'count':0x0}});_0x1a6546['on'](_0x303cd3(0xf8),async _0x11e693=>{const _0x589b10=_0x303cd3;logger_1[_0x589b10(0xd6)][_0x589b10(0xfa)]('Job\x20'+_0x11e693['id']+_0x589b10(0xe5));}),_0x1a6546['on'](_0x303cd3(0xfe),async(_0xbdec19,_0x1e3ef1)=>{const _0x4e6dd2=_0x303cd3;logger_1[_0x4e6dd2(0xd6)]['error'](_0x4e6dd2(0xc1)+_0xbdec19[_0x4e6dd2(0xd4)]+'\x20failed\x20with\x20error:\x20'+_0x1e3ef1['message']);});}async[a574_0x24d52f(0xd7)](){const _0x493182=a574_0x24d52f;try{const _0x256552=await Schedule_1[_0x493182(0xcb)][_0x493182(0xed)]({'where':{'status':_0x493182(0xb1),'sentAt':null,'sendAt':{[sequelize_1['Op'][_0x493182(0xd9)]]:(0x0,moment_1['default'])()[_0x493182(0xae)](_0x493182(0xbb))}},'include':[{'model':Contact_1[_0x493182(0xcb)],'as':_0x493182(0xb0)}]});return _0x256552?.[_0x493182(0xab)]>0x0&&_0x256552[_0x493182(0xb2)](async _0x3cbce3=>{const _0x506a9d=_0x493182;await _0x3cbce3[_0x506a9d(0xd5)]({'status':_0x506a9d(0xeb)}),await this['queue']['add'](_0x506a9d(0xc8),{'schedule':_0x3cbce3},{'delay':this[_0x506a9d(0xc6)](0x3e8,0xbb8),'removeOnComplete':!![]}),logger_1['logger'][_0x506a9d(0xfa)](_0x506a9d(0xc7)+_0x3cbce3[_0x506a9d(0xb0)][_0x506a9d(0xd4)]);}),Promise[_0x493182(0xf3)]({'count':_0x256552[_0x493182(0xab)]});}catch(_0x4e0a84){return Sentry[_0x493182(0xd2)](_0x4e0a84),logger_1[_0x493182(0xd6)][_0x493182(0xce)](_0x493182(0xe3),_0x4e0a84[_0x493182(0xfb)]),Promise[_0x493182(0xcd)](new sequelize_1[(_0x493182(0xe6))](_0x4e0a84));}}[a574_0x24d52f(0xc6)](_0x1b35f8,_0x33c9c9){const _0x44c8ea=a574_0x24d52f;return Math[_0x44c8ea(0xe1)]()*(_0x33c9c9-_0x1b35f8)+_0x1b35f8;}async[a574_0x24d52f(0xbf)](_0x3f500b){const _0x11691b=a574_0x24d52f,{data:{schedule:_0x401c86}}=_0x3f500b;let _0x2ce4f5=null;try{_0x2ce4f5=await Schedule_1[_0x11691b(0xcb)][_0x11691b(0xe2)](_0x401c86['id']);}catch(_0x259765){Sentry[_0x11691b(0xd2)](_0x259765),logger_1[_0x11691b(0xd6)][_0x11691b(0xfa)](_0x11691b(0xcf)+_0x401c86['id']);}try{if(_0x2ce4f5?.['daysR']!==null){let _0x4360cf=(0x0,moment_1[_0x11691b(0xcb)])(_0x2ce4f5[_0x11691b(0xd1)]);const _0x1f5169=_0x401c86[_0x11691b(0xff)],_0x44b27f=await(0x0,GetDefaultWhatsApp_1[_0x11691b(0xcb)])(_0x401c86['companyId']);let _0x3d8e28=null;const _0x5b6284=_0x2ce4f5?.[_0x11691b(0xfc)];_0x5b6284?Tag_1[_0x11691b(0xcb)]['findByPk'](_0x5b6284)[_0x11691b(0xc2)](async _0x5e748b=>{const _0x2cc563=_0x11691b;if(_0x5e748b){let _0xe3edc6=_0x4360cf[_0x2cc563(0xf1)](_0x5e748b[_0x2cc563(0xb7)],_0x2cc563(0xf5))[_0x2cc563(0xae)]('YYYY-MM-DD\x20HH:mm');_0x5e748b['mediaPath']&&(await(0x0,SendMessage_1['SendMessage'])(_0x44b27f,{'number':_0x401c86[_0x2cc563(0xb0)]['number'],'body':_0x5e748b[_0x2cc563(0xf7)]}),_0x3d8e28=path_1[_0x2cc563(0xcb)][_0x2cc563(0xf3)](_0x2cc563(0xe0)+_0x1f5169,_0x5e748b[_0x2cc563(0xcc)]),await(0x0,SendMessage_1[_0x2cc563(0xc8)])(_0x44b27f,{'number':_0x401c86[_0x2cc563(0xb0)][_0x2cc563(0xd0)],'body':_0x5e748b[_0x2cc563(0xf7)],'mediaPath':_0x3d8e28})),_0x5e748b['rptDays']===0x0?await _0x2ce4f5?.['update']({'sentAt':(0x0,moment_1[_0x2cc563(0xcb)])()[_0x2cc563(0xae)](_0x2cc563(0xc0)),'status':_0x2cc563(0xca)}):await _0x2ce4f5?.[_0x2cc563(0xd5)]({'sendAt':_0xe3edc6,'status':'PENDENTE'}),logger_1[_0x2cc563(0xd6)][_0x2cc563(0xfa)](_0x2cc563(0xb5)+_0x401c86[_0x2cc563(0xb0)][_0x2cc563(0xd4)]+'\x20');}else console[_0x2cc563(0xbc)](_0x2cc563(0xaf));})[_0x11691b(0xb6)](_0xc1d37f=>{const _0x314629=_0x11691b;console['error'](_0x314629(0xea),_0xc1d37f);}):console[_0x11691b(0xbc)](_0x11691b(0xf0));}else{const _0x33fd47=await(0x0,GetDefaultWhatsApp_1['default'])(_0x401c86[_0x11691b(0xff)]);let _0x31f7e0=null;_0x401c86[_0x11691b(0xcc)]&&(_0x31f7e0=path_1[_0x11691b(0xcb)]['resolve'](_0x11691b(0xe0)+_0x401c86['companyId'],_0x401c86[_0x11691b(0xcc)])),await(0x0,SendMessage_1[_0x11691b(0xc8)])(_0x33fd47,{'number':_0x401c86['contact'][_0x11691b(0xd0)],'body':_0x401c86[_0x11691b(0xf4)],'mediaPath':_0x31f7e0}),await _0x2ce4f5?.[_0x11691b(0xd5)]({'sentAt':(0x0,moment_1['default'])()[_0x11691b(0xae)]('YYYY-MM-DD\x20HH:mm'),'status':_0x11691b(0xca)}),logger_1[_0x11691b(0xd6)][_0x11691b(0xfa)](_0x11691b(0xb5)+_0x401c86['contact'][_0x11691b(0xd4)]);}}catch(_0x563b54){Sentry[_0x11691b(0xd2)](_0x563b54),await _0x2ce4f5?.[_0x11691b(0xd5)]({'status':_0x11691b(0xc4)}),logger_1[_0x11691b(0xd6)][_0x11691b(0xce)]('SendScheduledMessage\x20->\x20SendMessage:\x20error',_0x563b54[_0x11691b(0xfb)]);throw _0x563b54;}}}exports[a574_0x24d52f(0xcb)]=ScheduledMessageJob;