const a576_0x42010c=a576_0x64b2;(function(_0x43f929,_0x434d2d){const _0x3263d2=a576_0x64b2,_0x5caed8=_0x43f929();while(!![]){try{const _0x3cbeec=-parseInt(_0x3263d2(0x1ca))/0x1+-parseInt(_0x3263d2(0x1ab))/0x2+-parseInt(_0x3263d2(0x1ba))/0x3*(parseInt(_0x3263d2(0x18f))/0x4)+-parseInt(_0x3263d2(0x1d5))/0x5*(-parseInt(_0x3263d2(0x1d2))/0x6)+parseInt(_0x3263d2(0x196))/0x7+parseInt(_0x3263d2(0x1c2))/0x8+-parseInt(_0x3263d2(0x1b2))/0x9*(-parseInt(_0x3263d2(0x1cb))/0xa);if(_0x3cbeec===_0x434d2d)break;else _0x5caed8['push'](_0x5caed8['shift']());}catch(_0x339e21){_0x5caed8['push'](_0x5caed8['shift']());}}}(a576_0x5d4c,0x304c8));const a576_0x5c8ceb=(function(){let _0x3c3206=!![];return function(_0x59bbd3,_0x1e9054){const _0xd3981b=_0x3c3206?function(){if(_0x1e9054){const _0x563ff8=_0x1e9054['apply'](_0x59bbd3,arguments);return _0x1e9054=null,_0x563ff8;}}:function(){};return _0x3c3206=![],_0xd3981b;};}()),a576_0x5eb70b=a576_0x5c8ceb(this,function(){const _0x11b972=a576_0x64b2;return a576_0x5eb70b[_0x11b972(0x1cf)]()[_0x11b972(0x197)](_0x11b972(0x1a9))[_0x11b972(0x1cf)]()['constructor'](a576_0x5eb70b)[_0x11b972(0x197)]('(((.+)+)+)+$');});a576_0x5eb70b();'use strict';function a576_0x64b2(_0x2d7734,_0x65a5c9){const _0x17b4c4=a576_0x5d4c();return a576_0x64b2=function(_0x5eb70b,_0x5c8ceb){_0x5eb70b=_0x5eb70b-0x182;let _0x5d4cac=_0x17b4c4[_0x5eb70b];return _0x5d4cac;},a576_0x64b2(_0x2d7734,_0x65a5c9);}var __createBinding=this&&this[a576_0x42010c(0x19c)]||(Object[a576_0x42010c(0x18c)]?function(_0x367655,_0x5b6e12,_0x484585,_0x14d89e){const _0x2bec54=a576_0x42010c;if(_0x14d89e===undefined)_0x14d89e=_0x484585;var _0x124e11=Object[_0x2bec54(0x189)](_0x5b6e12,_0x484585);(!_0x124e11||('get'in _0x124e11?!_0x5b6e12[_0x2bec54(0x1ac)]:_0x124e11[_0x2bec54(0x1b0)]||_0x124e11[_0x2bec54(0x1cc)]))&&(_0x124e11={'enumerable':!![],'get':function(){return _0x5b6e12[_0x484585];}}),Object[_0x2bec54(0x193)](_0x367655,_0x14d89e,_0x124e11);}:function(_0x4612cd,_0x4b1640,_0x4d1a88,_0x236353){if(_0x236353===undefined)_0x236353=_0x4d1a88;_0x4612cd[_0x236353]=_0x4b1640[_0x4d1a88];}),__setModuleDefault=this&&this[a576_0x42010c(0x1c8)]||(Object[a576_0x42010c(0x18c)]?function(_0x377804,_0x533a06){const _0x11b0e5=a576_0x42010c;Object[_0x11b0e5(0x193)](_0x377804,_0x11b0e5(0x1c6),{'enumerable':!![],'value':_0x533a06});}:function(_0x2f9272,_0x44cc76){const _0x18edc0=a576_0x42010c;_0x2f9272[_0x18edc0(0x1c6)]=_0x44cc76;}),__importStar=this&&this[a576_0x42010c(0x1b8)]||function(_0xdad554){const _0x3f9516=a576_0x42010c;if(_0xdad554&&_0xdad554[_0x3f9516(0x1ac)])return _0xdad554;var _0x5e3136={};if(_0xdad554!=null){for(var _0x54e6ec in _0xdad554)if(_0x54e6ec!==_0x3f9516(0x1c6)&&Object[_0x3f9516(0x194)]['hasOwnProperty']['call'](_0xdad554,_0x54e6ec))__createBinding(_0x5e3136,_0xdad554,_0x54e6ec);}return __setModuleDefault(_0x5e3136,_0xdad554),_0x5e3136;},__importDefault=this&&this[a576_0x42010c(0x1be)]||function(_0x4a9947){const _0x18be83=a576_0x42010c;return _0x4a9947&&_0x4a9947[_0x18be83(0x1ac)]?_0x4a9947:{'default':_0x4a9947};};function a576_0x5d4c(){const _0x1f2ab9=['SendScheduledMessage\x20->\x20Verify:\x20error','days','body','rptDays','__createBinding','queue','format','reject','Erro\x20ao\x20tentar\x20consultar\x20agendamento:\x20','log','then','companyId','handleSendScheduledMessage','info','completed','resolve','error','(((.+)+)+)+$','msgR','333856tjdfzm','__esModule','Disparo\x20agendado\x20para:\x20','moment/moment','Erro\x20ao\x20buscar\x20tag:','writable','ENVIADA','105246tsREPB','lte','ERRO','VerifySchedules','captureException','\x20completed','__importStar','YYYY-MM-DD\x20HH:mm','339ujRTBy','contact','../helpers/GetDefaultWhatsApp','name','__importDefault','findByPk','number','Tag\x20não\x20encontrada','732352GISakb','Job\x20','SendScheduledMessage\x20->\x20SendMessage:\x20error','update','default','ID\x20da\x20tag\x20não\x20está\x20definido\x20em\x20scheduleRecord','__setModuleDefault','sequelize','245978atsoyE','360VbXoUj','configurable','Mensagem\x20agendada\x20enviada\x20para:\x20','PENDENTE','toString','length','SendMessage','163620ffkCvE','add','getRandomArbitrary','5AnlEGd','../models/Tag','findAll','../../public/company','YYYY-MM-DD\x20HH:mm:ss','bullmq','message','getQueue','logger','Error','getOwnPropertyDescriptor','failed','catch','create','sendAt','handleVerifySchedules','11172iitoZQ','AGENDADA','../models/Schedule','map','defineProperty','prototype','mediaPath','2705843rgoYoD','search'];a576_0x5d4c=function(){return _0x1f2ab9;};return a576_0x5d4c();}Object[a576_0x42010c(0x193)](exports,a576_0x42010c(0x1ac),{'value':!![]});const bullmq_1=require(a576_0x42010c(0x184)),Schedule_1=__importDefault(require(a576_0x42010c(0x191))),Sentry=__importStar(require('@sentry/node')),logger_1=require('../utils/logger'),moment_1=__importDefault(require(a576_0x42010c(0x1ae))),GetDefaultWhatsApp_1=__importDefault(require(a576_0x42010c(0x1bc))),Tag_1=__importDefault(require(a576_0x42010c(0x1d6))),SendMessage_1=require('../helpers/SendMessage'),path_1=__importDefault(require('path')),sequelize_1=require(a576_0x42010c(0x1c9)),Contact_1=__importDefault(require('../models/Contact'));class ScheduledMessageJob{[a576_0x42010c(0x186)](){const _0x5165ec=a576_0x42010c;return this[_0x5165ec(0x19d)];}constructor(_0x40f521,_0x577968){const _0x5512cd=a576_0x42010c;this['queue']=_0x40f521;const _0x4a8342=new bullmq_1['Worker'](_0x40f521[_0x5512cd(0x1bd)],async _0x2e646f=>{const _0xc4c735=_0x5512cd;if(_0x2e646f[_0xc4c735(0x1bd)]==_0xc4c735(0x1d1))await this['handleSendScheduledMessage'](_0x2e646f);else _0x2e646f[_0xc4c735(0x1bd)]==_0xc4c735(0x1b5)&&await this[_0xc4c735(0x18e)]();},{'concurrency':0x64,'connection':_0x577968,'removeOnFail':{'count':0x0}});_0x4a8342['on'](_0x5512cd(0x1a6),async _0x310ab4=>{const _0x1fe846=_0x5512cd;logger_1['logger']['info'](_0x1fe846(0x1c3)+_0x310ab4['id']+_0x1fe846(0x1b7));}),_0x4a8342['on'](_0x5512cd(0x18a),async(_0x3c29fc,_0x2da352)=>{const _0x3cf9f8=_0x5512cd;logger_1[_0x3cf9f8(0x187)]['error'](_0x3cf9f8(0x1c3)+_0x3c29fc[_0x3cf9f8(0x1bd)]+'\x20failed\x20with\x20error:\x20'+_0x2da352[_0x3cf9f8(0x185)]);});}async[a576_0x42010c(0x18e)](){const _0x3c77c0=a576_0x42010c;try{const _0x211a11=await Schedule_1['default'][_0x3c77c0(0x1d7)]({'where':{'status':_0x3c77c0(0x1ce),'sentAt':null,'sendAt':{[sequelize_1['Op'][_0x3c77c0(0x1b3)]]:(0x0,moment_1[_0x3c77c0(0x1c6)])()[_0x3c77c0(0x19e)](_0x3c77c0(0x183))}},'include':[{'model':Contact_1[_0x3c77c0(0x1c6)],'as':_0x3c77c0(0x1bb)}]});return _0x211a11?.['length']>0x0&&_0x211a11[_0x3c77c0(0x192)](async _0xe22853=>{const _0x4144b1=_0x3c77c0;await _0xe22853[_0x4144b1(0x1c5)]({'status':_0x4144b1(0x190)}),await this[_0x4144b1(0x19d)][_0x4144b1(0x1d3)](_0x4144b1(0x1d1),{'schedule':_0xe22853},{'delay':this[_0x4144b1(0x1d4)](0x3e8,0xbb8),'removeOnComplete':!![]}),logger_1[_0x4144b1(0x187)][_0x4144b1(0x1a5)](_0x4144b1(0x1ad)+_0xe22853[_0x4144b1(0x1bb)][_0x4144b1(0x1bd)]);}),Promise[_0x3c77c0(0x1a7)]({'count':_0x211a11[_0x3c77c0(0x1d0)]});}catch(_0x2116db){return Sentry[_0x3c77c0(0x1b6)](_0x2116db),logger_1[_0x3c77c0(0x187)][_0x3c77c0(0x1a8)](_0x3c77c0(0x198),_0x2116db['message']),Promise[_0x3c77c0(0x19f)](new sequelize_1[(_0x3c77c0(0x188))](_0x2116db));}}[a576_0x42010c(0x1d4)](_0x31d935,_0x2f559a){return Math['random']()*(_0x2f559a-_0x31d935)+_0x31d935;}async[a576_0x42010c(0x1a4)](_0x52d53f){const _0x4ef9bc=a576_0x42010c,{data:{schedule:_0x36f154}}=_0x52d53f;let _0x4dc86f=null;try{_0x4dc86f=await Schedule_1[_0x4ef9bc(0x1c6)][_0x4ef9bc(0x1bf)](_0x36f154['id']);}catch(_0x4be0cf){Sentry[_0x4ef9bc(0x1b6)](_0x4be0cf),logger_1[_0x4ef9bc(0x187)][_0x4ef9bc(0x1a5)](_0x4ef9bc(0x1a0)+_0x36f154['id']);}try{if(_0x4dc86f?.['daysR']!==null){let _0x2a9f54=(0x0,moment_1[_0x4ef9bc(0x1c6)])(_0x4dc86f[_0x4ef9bc(0x18d)]);const _0x40574a=_0x36f154[_0x4ef9bc(0x1a3)],_0x3a3500=await(0x0,GetDefaultWhatsApp_1[_0x4ef9bc(0x1c6)])(_0x36f154[_0x4ef9bc(0x1a3)]);let _0x66b0c7=null;const _0x58b999=_0x4dc86f?.['campId'];_0x58b999?Tag_1[_0x4ef9bc(0x1c6)][_0x4ef9bc(0x1bf)](_0x58b999)[_0x4ef9bc(0x1a2)](async _0x1b0769=>{const _0x1a2086=_0x4ef9bc;if(_0x1b0769){let _0x4a95cc=_0x2a9f54[_0x1a2086(0x1d3)](_0x1b0769[_0x1a2086(0x19b)],_0x1a2086(0x199))[_0x1a2086(0x19e)](_0x1a2086(0x1b9));_0x1b0769[_0x1a2086(0x195)]&&(await(0x0,SendMessage_1['SendMessage'])(_0x3a3500,{'number':_0x36f154[_0x1a2086(0x1bb)][_0x1a2086(0x1c0)],'body':_0x1b0769[_0x1a2086(0x1aa)]}),_0x66b0c7=path_1[_0x1a2086(0x1c6)][_0x1a2086(0x1a7)](_0x1a2086(0x182)+_0x40574a,_0x1b0769[_0x1a2086(0x195)]),await(0x0,SendMessage_1[_0x1a2086(0x1d1)])(_0x3a3500,{'number':_0x36f154['contact'][_0x1a2086(0x1c0)],'body':_0x1b0769[_0x1a2086(0x1aa)],'mediaPath':_0x66b0c7})),_0x1b0769['rptDays']===0x0?await _0x4dc86f?.[_0x1a2086(0x1c5)]({'sentAt':(0x0,moment_1[_0x1a2086(0x1c6)])()[_0x1a2086(0x19e)](_0x1a2086(0x1b9)),'status':_0x1a2086(0x1b1)}):await _0x4dc86f?.[_0x1a2086(0x1c5)]({'sendAt':_0x4a95cc,'status':_0x1a2086(0x1ce)}),logger_1['logger'][_0x1a2086(0x1a5)](_0x1a2086(0x1cd)+_0x36f154[_0x1a2086(0x1bb)][_0x1a2086(0x1bd)]+'\x20');}else console[_0x1a2086(0x1a1)](_0x1a2086(0x1c1));})[_0x4ef9bc(0x18b)](_0x13e75b=>{const _0x28620f=_0x4ef9bc;console[_0x28620f(0x1a8)](_0x28620f(0x1af),_0x13e75b);}):console[_0x4ef9bc(0x1a1)](_0x4ef9bc(0x1c7));}else{const _0x24e6d4=await(0x0,GetDefaultWhatsApp_1[_0x4ef9bc(0x1c6)])(_0x36f154['companyId']);let _0x506b9b=null;_0x36f154['mediaPath']&&(_0x506b9b=path_1[_0x4ef9bc(0x1c6)][_0x4ef9bc(0x1a7)]('../../public/company'+_0x36f154['companyId'],_0x36f154[_0x4ef9bc(0x195)])),await(0x0,SendMessage_1[_0x4ef9bc(0x1d1)])(_0x24e6d4,{'number':_0x36f154['contact'][_0x4ef9bc(0x1c0)],'body':_0x36f154[_0x4ef9bc(0x19a)],'mediaPath':_0x506b9b}),await _0x4dc86f?.['update']({'sentAt':(0x0,moment_1[_0x4ef9bc(0x1c6)])()[_0x4ef9bc(0x19e)](_0x4ef9bc(0x1b9)),'status':_0x4ef9bc(0x1b1)}),logger_1[_0x4ef9bc(0x187)]['info']('Mensagem\x20agendada\x20enviada\x20para:\x20'+_0x36f154[_0x4ef9bc(0x1bb)][_0x4ef9bc(0x1bd)]);}}catch(_0x3e5dd4){Sentry[_0x4ef9bc(0x1b6)](_0x3e5dd4),await _0x4dc86f?.[_0x4ef9bc(0x1c5)]({'status':_0x4ef9bc(0x1b4)}),logger_1[_0x4ef9bc(0x187)][_0x4ef9bc(0x1a8)](_0x4ef9bc(0x1c4),_0x3e5dd4[_0x4ef9bc(0x185)]);throw _0x3e5dd4;}}}exports[a576_0x42010c(0x1c6)]=ScheduledMessageJob;