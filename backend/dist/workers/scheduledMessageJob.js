const a575_0x5e9e9d=a575_0x576e;(function(_0x1afe03,_0x259169){const _0x3f4e7e=a575_0x576e,_0x1eb47c=_0x1afe03();while(!![]){try{const _0x3f266e=-parseInt(_0x3f4e7e(0x9f))/0x1+-parseInt(_0x3f4e7e(0x8a))/0x2*(parseInt(_0x3f4e7e(0xa3))/0x3)+-parseInt(_0x3f4e7e(0xb4))/0x4*(-parseInt(_0x3f4e7e(0xcf))/0x5)+-parseInt(_0x3f4e7e(0xa0))/0x6*(-parseInt(_0x3f4e7e(0xa1))/0x7)+parseInt(_0x3f4e7e(0xaf))/0x8*(-parseInt(_0x3f4e7e(0xc0))/0x9)+parseInt(_0x3f4e7e(0xa5))/0xa+-parseInt(_0x3f4e7e(0xb6))/0xb*(parseInt(_0x3f4e7e(0xa7))/0xc);if(_0x3f266e===_0x259169)break;else _0x1eb47c['push'](_0x1eb47c['shift']());}catch(_0x785fa4){_0x1eb47c['push'](_0x1eb47c['shift']());}}}(a575_0x4439,0xd0f8e));function a575_0x576e(_0x55ea09,_0x2f96b3){const _0xe52332=a575_0x4439();return a575_0x576e=function(_0x5527e8,_0x4c7527){_0x5527e8=_0x5527e8-0x84;let _0x4439b1=_0xe52332[_0x5527e8];return _0x4439b1;},a575_0x576e(_0x55ea09,_0x2f96b3);}const a575_0x4c7527=(function(){let _0xfbed4e=!![];return function(_0x578dc7,_0x3833bd){const _0xdb5245=_0xfbed4e?function(){if(_0x3833bd){const _0xbda517=_0x3833bd['apply'](_0x578dc7,arguments);return _0x3833bd=null,_0xbda517;}}:function(){};return _0xfbed4e=![],_0xdb5245;};}()),a575_0x5527e8=a575_0x4c7527(this,function(){const _0x3309fc=a575_0x576e;return a575_0x5527e8[_0x3309fc(0xcc)]()['search']('(((.+)+)+)+$')[_0x3309fc(0xcc)]()[_0x3309fc(0xd0)](a575_0x5527e8)[_0x3309fc(0xd5)]('(((.+)+)+)+$');});a575_0x5527e8();'use strict';var __createBinding=this&&this[a575_0x5e9e9d(0xd4)]||(Object[a575_0x5e9e9d(0xaa)]?function(_0x584fb9,_0x113572,_0x44fa74,_0x1d7f3d){const _0x313d45=a575_0x5e9e9d;if(_0x1d7f3d===undefined)_0x1d7f3d=_0x44fa74;var _0x35eb18=Object[_0x313d45(0xc4)](_0x113572,_0x44fa74);(!_0x35eb18||('get'in _0x35eb18?!_0x113572[_0x313d45(0x90)]:_0x35eb18[_0x313d45(0xa4)]||_0x35eb18['configurable']))&&(_0x35eb18={'enumerable':!![],'get':function(){return _0x113572[_0x44fa74];}}),Object[_0x313d45(0xc5)](_0x584fb9,_0x1d7f3d,_0x35eb18);}:function(_0x25a539,_0x4783d9,_0x394225,_0x4b93){if(_0x4b93===undefined)_0x4b93=_0x394225;_0x25a539[_0x4b93]=_0x4783d9[_0x394225];}),__setModuleDefault=this&&this[a575_0x5e9e9d(0xb8)]||(Object[a575_0x5e9e9d(0xaa)]?function(_0x3aef15,_0x390e09){const _0x17f13a=a575_0x5e9e9d;Object[_0x17f13a(0xc5)](_0x3aef15,_0x17f13a(0x88),{'enumerable':!![],'value':_0x390e09});}:function(_0x27e2f5,_0x281105){const _0x5479e7=a575_0x5e9e9d;_0x27e2f5[_0x5479e7(0x88)]=_0x281105;}),__importStar=this&&this[a575_0x5e9e9d(0xd3)]||function(_0x36ff5e){const _0x575463=a575_0x5e9e9d;if(_0x36ff5e&&_0x36ff5e[_0x575463(0x90)])return _0x36ff5e;var _0x545c6b={};if(_0x36ff5e!=null){for(var _0xacbc88 in _0x36ff5e)if(_0xacbc88!==_0x575463(0x88)&&Object['prototype'][_0x575463(0x8b)]['call'](_0x36ff5e,_0xacbc88))__createBinding(_0x545c6b,_0x36ff5e,_0xacbc88);}return __setModuleDefault(_0x545c6b,_0x36ff5e),_0x545c6b;},__importDefault=this&&this[a575_0x5e9e9d(0x8c)]||function(_0x44d975){const _0xc4e8b2=a575_0x5e9e9d;return _0x44d975&&_0x44d975[_0xc4e8b2(0x90)]?_0x44d975:{'default':_0x44d975};};Object[a575_0x5e9e9d(0xc5)](exports,a575_0x5e9e9d(0x90),{'value':!![]});function a575_0x4439(){const _0x4cf963=['ENVIADA','path','message','update','Error','SendScheduledMessage\x20->\x20Verify:\x20error','toString','then','handleVerifySchedules','450BEjnVA','constructor','name','../models/Tag','__importStar','__createBinding','search','error','random','getRandomArbitrary','logger','Job\x20','daysR','mediaPath','@sentry/node','VerifySchedules','default','YYYY-MM-DD\x20HH:mm','6JFdIkg','hasOwnProperty','__importDefault','completed','getQueue','Mensagem\x20agendada\x20enviada\x20para:\x20','__esModule','resolve','length','lte','findAll','body','format','captureException','SendMessage','AGENDADA','number','../utils/logger','findByPk','rptDays','Erro\x20ao\x20buscar\x20tag:','214521kBONjI','4854YYQAMD','1064ZhOHNq','log','38139MKDWbR','writable','8732890TSeDCe','YYYY-MM-DD\x20HH:mm:ss','12dKFdvc','map','../models/Contact','create','add','queue','Disparo\x20agendado\x20para:\x20','ID\x20da\x20tag\x20não\x20está\x20definido\x20em\x20scheduleRecord','784528iNWdOr','contact','Worker','days','moment/moment','52496dWGzNf','info','2048343MJeTNS','../../public/company','__setModuleDefault','failed','sendAt','../models/Schedule','companyId','handleSendScheduledMessage','reject','Tag\x20não\x20encontrada','81DhCwTV','msgR','\x20completed','SendScheduledMessage\x20->\x20SendMessage:\x20error','getOwnPropertyDescriptor','defineProperty'];a575_0x4439=function(){return _0x4cf963;};return a575_0x4439();}const bullmq_1=require('bullmq'),Schedule_1=__importDefault(require(a575_0x5e9e9d(0xbb))),Sentry=__importStar(require(a575_0x5e9e9d(0x86))),logger_1=require(a575_0x5e9e9d(0x9b)),moment_1=__importDefault(require(a575_0x5e9e9d(0xb3))),GetDefaultWhatsApp_1=__importDefault(require('../helpers/GetDefaultWhatsApp')),Tag_1=__importDefault(require(a575_0x5e9e9d(0xd2))),SendMessage_1=require('../helpers/SendMessage'),path_1=__importDefault(require(a575_0x5e9e9d(0xc7))),sequelize_1=require('sequelize'),Contact_1=__importDefault(require(a575_0x5e9e9d(0xa9)));class ScheduledMessageJob{[a575_0x5e9e9d(0x8e)](){return this['queue'];}constructor(_0x2827e4,_0x44bb33){const _0x13b8f5=a575_0x5e9e9d;this[_0x13b8f5(0xac)]=_0x2827e4;const _0x15b482=new bullmq_1[(_0x13b8f5(0xb1))](_0x2827e4[_0x13b8f5(0xd1)],async _0x5a6640=>{const _0x3b1dd9=_0x13b8f5;if(_0x5a6640['name']==_0x3b1dd9(0x98))await this[_0x3b1dd9(0xbd)](_0x5a6640);else _0x5a6640[_0x3b1dd9(0xd1)]==_0x3b1dd9(0x87)&&await this[_0x3b1dd9(0xce)]();},{'concurrency':0x64,'connection':_0x44bb33,'removeOnFail':{'count':0x0}});_0x15b482['on'](_0x13b8f5(0x8d),async _0x224456=>{const _0x1c1644=_0x13b8f5;logger_1[_0x1c1644(0xd9)][_0x1c1644(0xb5)](_0x1c1644(0xda)+_0x224456['id']+_0x1c1644(0xc2));}),_0x15b482['on'](_0x13b8f5(0xb9),async(_0x475e74,_0x14249d)=>{const _0x557a2a=_0x13b8f5;logger_1[_0x557a2a(0xd9)][_0x557a2a(0xd6)](_0x557a2a(0xda)+_0x475e74['name']+'\x20failed\x20with\x20error:\x20'+_0x14249d[_0x557a2a(0xc8)]);});}async[a575_0x5e9e9d(0xce)](){const _0x57a795=a575_0x5e9e9d;try{const _0x56228d=await Schedule_1[_0x57a795(0x88)][_0x57a795(0x94)]({'where':{'status':'PENDENTE','sentAt':null,'sendAt':{[sequelize_1['Op'][_0x57a795(0x93)]]:(0x0,moment_1['default'])()[_0x57a795(0x96)](_0x57a795(0xa6))}},'include':[{'model':Contact_1['default'],'as':_0x57a795(0xb0)}]});return _0x56228d?.[_0x57a795(0x92)]>0x0&&_0x56228d[_0x57a795(0xa8)](async _0x518d55=>{const _0x15fb86=_0x57a795;await _0x518d55['update']({'status':_0x15fb86(0x99)}),await this[_0x15fb86(0xac)][_0x15fb86(0xab)](_0x15fb86(0x98),{'schedule':_0x518d55},{'delay':this[_0x15fb86(0xd8)](0x3e8,0xbb8),'removeOnComplete':!![]}),logger_1[_0x15fb86(0xd9)][_0x15fb86(0xb5)](_0x15fb86(0xad)+_0x518d55[_0x15fb86(0xb0)]['name']);}),Promise[_0x57a795(0x91)]({'count':_0x56228d[_0x57a795(0x92)]});}catch(_0x2033e4){return Sentry[_0x57a795(0x97)](_0x2033e4),logger_1[_0x57a795(0xd9)]['error'](_0x57a795(0xcb),_0x2033e4[_0x57a795(0xc8)]),Promise[_0x57a795(0xbe)](new sequelize_1[(_0x57a795(0xca))](_0x2033e4));}}[a575_0x5e9e9d(0xd8)](_0x4fa986,_0x4635b6){const _0x4efd56=a575_0x5e9e9d;return Math[_0x4efd56(0xd7)]()*(_0x4635b6-_0x4fa986)+_0x4fa986;}async['handleSendScheduledMessage'](_0x1c2450){const _0x4b6f96=a575_0x5e9e9d,{data:{schedule:_0x2514b6}}=_0x1c2450;let _0xfd5293=null;try{_0xfd5293=await Schedule_1[_0x4b6f96(0x88)][_0x4b6f96(0x9c)](_0x2514b6['id']);}catch(_0x486026){Sentry['captureException'](_0x486026),logger_1[_0x4b6f96(0xd9)]['info']('Erro\x20ao\x20tentar\x20consultar\x20agendamento:\x20'+_0x2514b6['id']);}try{if(_0xfd5293?.[_0x4b6f96(0x84)]!==null){let _0x37c8a2=(0x0,moment_1[_0x4b6f96(0x88)])(_0xfd5293[_0x4b6f96(0xba)]);const _0x514c90=_0x2514b6['companyId'],_0x190c2f=await(0x0,GetDefaultWhatsApp_1[_0x4b6f96(0x88)])(_0x2514b6[_0x4b6f96(0xbc)]);let _0x16be3=null;const _0x1b1e1d=_0xfd5293?.['campId'];_0x1b1e1d?Tag_1[_0x4b6f96(0x88)]['findByPk'](_0x1b1e1d)[_0x4b6f96(0xcd)](async _0xde0360=>{const _0x2a601e=_0x4b6f96;if(_0xde0360){let _0x47a6d0=_0x37c8a2[_0x2a601e(0xab)](_0xde0360[_0x2a601e(0x9d)],_0x2a601e(0xb2))[_0x2a601e(0x96)](_0x2a601e(0x89));_0xde0360[_0x2a601e(0x85)]&&(await(0x0,SendMessage_1[_0x2a601e(0x98)])(_0x190c2f,{'number':_0x2514b6['contact']['number'],'body':_0xde0360['msgR']}),_0x16be3=path_1['default'][_0x2a601e(0x91)]('../../public/company'+_0x514c90,_0xde0360[_0x2a601e(0x85)]),await(0x0,SendMessage_1['SendMessage'])(_0x190c2f,{'number':_0x2514b6['contact'][_0x2a601e(0x9a)],'body':_0xde0360[_0x2a601e(0xc1)],'mediaPath':_0x16be3})),_0xde0360['rptDays']===0x0?await _0xfd5293?.[_0x2a601e(0xc9)]({'sentAt':(0x0,moment_1['default'])()['format']('YYYY-MM-DD\x20HH:mm'),'status':_0x2a601e(0xc6)}):await _0xfd5293?.['update']({'sendAt':_0x47a6d0,'status':'PENDENTE'}),logger_1['logger'][_0x2a601e(0xb5)](_0x2a601e(0x8f)+_0x2514b6[_0x2a601e(0xb0)][_0x2a601e(0xd1)]+'\x20');}else console[_0x2a601e(0xa2)](_0x2a601e(0xbf));})['catch'](_0x55e511=>{const _0x20165c=_0x4b6f96;console[_0x20165c(0xd6)](_0x20165c(0x9e),_0x55e511);}):console['log'](_0x4b6f96(0xae));}else{const _0x27ffa4=await(0x0,GetDefaultWhatsApp_1[_0x4b6f96(0x88)])(_0x2514b6[_0x4b6f96(0xbc)]);let _0x45618a=null;_0x2514b6[_0x4b6f96(0x85)]&&(_0x45618a=path_1[_0x4b6f96(0x88)][_0x4b6f96(0x91)](_0x4b6f96(0xb7)+_0x2514b6[_0x4b6f96(0xbc)],_0x2514b6[_0x4b6f96(0x85)])),await(0x0,SendMessage_1[_0x4b6f96(0x98)])(_0x27ffa4,{'number':_0x2514b6['contact'][_0x4b6f96(0x9a)],'body':_0x2514b6[_0x4b6f96(0x95)],'mediaPath':_0x45618a}),await _0xfd5293?.['update']({'sentAt':(0x0,moment_1[_0x4b6f96(0x88)])()[_0x4b6f96(0x96)](_0x4b6f96(0x89)),'status':'ENVIADA'}),logger_1[_0x4b6f96(0xd9)][_0x4b6f96(0xb5)]('Mensagem\x20agendada\x20enviada\x20para:\x20'+_0x2514b6[_0x4b6f96(0xb0)][_0x4b6f96(0xd1)]);}}catch(_0x3d1d4a){Sentry['captureException'](_0x3d1d4a),await _0xfd5293?.[_0x4b6f96(0xc9)]({'status':'ERRO'}),logger_1['logger'][_0x4b6f96(0xd6)](_0x4b6f96(0xc3),_0x3d1d4a[_0x4b6f96(0xc8)]);throw _0x3d1d4a;}}}exports[a575_0x5e9e9d(0x88)]=ScheduledMessageJob;