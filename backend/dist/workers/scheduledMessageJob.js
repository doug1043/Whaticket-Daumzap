const a574_0x2e31d2=a574_0x3075;(function(_0x369580,_0x213128){const _0x2a84db=a574_0x3075,_0x1b4491=_0x369580();while(!![]){try{const _0x5cfb92=parseInt(_0x2a84db(0x1fc))/0x1*(-parseInt(_0x2a84db(0x209))/0x2)+parseInt(_0x2a84db(0x218))/0x3+-parseInt(_0x2a84db(0x202))/0x4+parseInt(_0x2a84db(0x204))/0x5*(-parseInt(_0x2a84db(0x20c))/0x6)+parseInt(_0x2a84db(0x1cd))/0x7+-parseInt(_0x2a84db(0x1fb))/0x8*(parseInt(_0x2a84db(0x1ee))/0x9)+parseInt(_0x2a84db(0x1e8))/0xa;if(_0x5cfb92===_0x213128)break;else _0x1b4491['push'](_0x1b4491['shift']());}catch(_0x219600){_0x1b4491['push'](_0x1b4491['shift']());}}}(a574_0x4347,0x6bc09));const a574_0x5ea72c=(function(){let _0x332430=!![];return function(_0x4dedf2,_0x5aba44){const _0x41b6fe=_0x332430?function(){const _0x535363=a574_0x3075;if(_0x5aba44){const _0x3f1ade=_0x5aba44[_0x535363(0x21f)](_0x4dedf2,arguments);return _0x5aba44=null,_0x3f1ade;}}:function(){};return _0x332430=![],_0x41b6fe;};}()),a574_0x7b0f17=a574_0x5ea72c(this,function(){const _0x325a76=a574_0x3075;return a574_0x7b0f17[_0x325a76(0x20a)]()['search'](_0x325a76(0x200))[_0x325a76(0x20a)]()['constructor'](a574_0x7b0f17)[_0x325a76(0x211)](_0x325a76(0x200));});function a574_0x4347(){const _0x2af7bb=['random','map','update','logger','add','Error','format','Mensagem\x20agendada\x20enviada\x20para:\x20','msgR','rptDays','getRandomArbitrary','default','number','findAll','@sentry/node','sequelize','campId','mediaPath','lte','length','completed','Job\x20','error','__importStar','16744890mAxDfV','then','info','../utils/logger','Worker','handleVerifySchedules','45SemrVc','getQueue','Disparo\x20agendado\x20para:\x20','Erro\x20ao\x20tentar\x20consultar\x20agendamento:\x20','findByPk','ERRO','ID\x20da\x20tag\x20não\x20está\x20definido\x20em\x20scheduleRecord','SendScheduledMessage\x20->\x20SendMessage:\x20error','prototype','VerifySchedules','ENVIADA','__importDefault','../../public/company','1331928oRAbus','41aNTUKY','configurable','AGENDADA','__esModule','(((.+)+)+)+$','create','2753244fmzqwj','\x20completed','335mqzeer','contact','queue','PENDENTE','companyId','38500PRSHcY','toString','Erro\x20ao\x20buscar\x20tag:','57492qhWgIs','log','defineProperty','../models/Schedule','path','search','moment/moment','SendMessage','captureException','resolve','YYYY-MM-DD\x20HH:mm:ss','__createBinding','2621553gZLkCh','YYYY-MM-DD\x20HH:mm','name','sendAt','reject','failed','../models/Tag','apply','../helpers/GetDefaultWhatsApp','catch','message','5915161TtmBJZ','handleSendScheduledMessage','__setModuleDefault'];a574_0x4347=function(){return _0x2af7bb;};return a574_0x4347();}a574_0x7b0f17();'use strict';var __createBinding=this&&this[a574_0x2e31d2(0x217)]||(Object[a574_0x2e31d2(0x201)]?function(_0x58bb66,_0x4e4f2c,_0x36c3b4,_0x294699){const _0x4038c1=a574_0x2e31d2;if(_0x294699===undefined)_0x294699=_0x36c3b4;var _0x2f9135=Object['getOwnPropertyDescriptor'](_0x4e4f2c,_0x36c3b4);(!_0x2f9135||('get'in _0x2f9135?!_0x4e4f2c['__esModule']:_0x2f9135['writable']||_0x2f9135[_0x4038c1(0x1fd)]))&&(_0x2f9135={'enumerable':!![],'get':function(){return _0x4e4f2c[_0x36c3b4];}}),Object[_0x4038c1(0x20e)](_0x58bb66,_0x294699,_0x2f9135);}:function(_0x1e34d3,_0x3a07bf,_0x1aaf79,_0x53b064){if(_0x53b064===undefined)_0x53b064=_0x1aaf79;_0x1e34d3[_0x53b064]=_0x3a07bf[_0x1aaf79];}),__setModuleDefault=this&&this[a574_0x2e31d2(0x1cf)]||(Object[a574_0x2e31d2(0x201)]?function(_0x34c9e6,_0x1714fe){const _0x24ae08=a574_0x2e31d2;Object[_0x24ae08(0x20e)](_0x34c9e6,'default',{'enumerable':!![],'value':_0x1714fe});}:function(_0x452a85,_0x42d175){_0x452a85['default']=_0x42d175;}),__importStar=this&&this[a574_0x2e31d2(0x1e7)]||function(_0xe08bcb){const _0x201116=a574_0x2e31d2;if(_0xe08bcb&&_0xe08bcb[_0x201116(0x1ff)])return _0xe08bcb;var _0x29f323={};if(_0xe08bcb!=null){for(var _0x43ece6 in _0xe08bcb)if(_0x43ece6!==_0x201116(0x1db)&&Object[_0x201116(0x1f6)]['hasOwnProperty']['call'](_0xe08bcb,_0x43ece6))__createBinding(_0x29f323,_0xe08bcb,_0x43ece6);}return __setModuleDefault(_0x29f323,_0xe08bcb),_0x29f323;},__importDefault=this&&this[a574_0x2e31d2(0x1f9)]||function(_0x23881b){return _0x23881b&&_0x23881b['__esModule']?_0x23881b:{'default':_0x23881b};};Object[a574_0x2e31d2(0x20e)](exports,a574_0x2e31d2(0x1ff),{'value':!![]});function a574_0x3075(_0x2caafd,_0x38ebf7){const _0x545cf2=a574_0x4347();return a574_0x3075=function(_0x7b0f17,_0x5ea72c){_0x7b0f17=_0x7b0f17-0x1ca;let _0x43472c=_0x545cf2[_0x7b0f17];return _0x43472c;},a574_0x3075(_0x2caafd,_0x38ebf7);}const bullmq_1=require('bullmq'),Schedule_1=__importDefault(require(a574_0x2e31d2(0x20f))),Sentry=__importStar(require(a574_0x2e31d2(0x1de))),logger_1=require(a574_0x2e31d2(0x1eb)),moment_1=__importDefault(require(a574_0x2e31d2(0x212))),GetDefaultWhatsApp_1=__importDefault(require(a574_0x2e31d2(0x1ca))),Tag_1=__importDefault(require(a574_0x2e31d2(0x21e))),SendMessage_1=require('../helpers/SendMessage'),path_1=__importDefault(require(a574_0x2e31d2(0x210))),sequelize_1=require(a574_0x2e31d2(0x1df)),Contact_1=__importDefault(require('../models/Contact'));class ScheduledMessageJob{[a574_0x2e31d2(0x1ef)](){const _0x13c82d=a574_0x2e31d2;return this[_0x13c82d(0x206)];}constructor(_0x5573f4,_0x35c995){const _0xc93f18=a574_0x2e31d2;this[_0xc93f18(0x206)]=_0x5573f4;const _0x4b34de=new bullmq_1[(_0xc93f18(0x1ec))](_0x5573f4[_0xc93f18(0x21a)],async _0x43cb62=>{const _0x5f33ae=_0xc93f18;if(_0x43cb62[_0x5f33ae(0x21a)]==_0x5f33ae(0x213))await this['handleSendScheduledMessage'](_0x43cb62);else _0x43cb62['name']==_0x5f33ae(0x1f7)&&await this[_0x5f33ae(0x1ed)]();},{'concurrency':0x64,'connection':_0x35c995,'removeOnFail':{'count':0x0}});_0x4b34de['on'](_0xc93f18(0x1e4),async _0x4ee327=>{const _0x1cba37=_0xc93f18;logger_1['logger'][_0x1cba37(0x1ea)]('Job\x20'+_0x4ee327['id']+_0x1cba37(0x203));}),_0x4b34de['on'](_0xc93f18(0x21d),async(_0x9f1b78,_0x4ccc3a)=>{const _0x44e96c=_0xc93f18;logger_1[_0x44e96c(0x1d3)][_0x44e96c(0x1e6)](_0x44e96c(0x1e5)+_0x9f1b78[_0x44e96c(0x21a)]+'\x20failed\x20with\x20error:\x20'+_0x4ccc3a[_0x44e96c(0x1cc)]);});}async[a574_0x2e31d2(0x1ed)](){const _0x1e7d07=a574_0x2e31d2;try{const _0x2870a8=await Schedule_1[_0x1e7d07(0x1db)][_0x1e7d07(0x1dd)]({'where':{'status':_0x1e7d07(0x207),'sentAt':null,'sendAt':{[sequelize_1['Op'][_0x1e7d07(0x1e2)]]:(0x0,moment_1['default'])()[_0x1e7d07(0x1d6)](_0x1e7d07(0x216))}},'include':[{'model':Contact_1[_0x1e7d07(0x1db)],'as':'contact'}]});return _0x2870a8?.[_0x1e7d07(0x1e3)]>0x0&&_0x2870a8[_0x1e7d07(0x1d1)](async _0x526c18=>{const _0x265e92=_0x1e7d07;await _0x526c18[_0x265e92(0x1d2)]({'status':_0x265e92(0x1fe)}),await this[_0x265e92(0x206)][_0x265e92(0x1d4)](_0x265e92(0x213),{'schedule':_0x526c18},{'delay':this[_0x265e92(0x1da)](0x3e8,0xbb8),'removeOnComplete':!![]}),logger_1[_0x265e92(0x1d3)]['info'](_0x265e92(0x1f0)+_0x526c18[_0x265e92(0x205)]['name']);}),Promise[_0x1e7d07(0x215)]({'count':_0x2870a8[_0x1e7d07(0x1e3)]});}catch(_0x3a932e){return Sentry['captureException'](_0x3a932e),logger_1[_0x1e7d07(0x1d3)][_0x1e7d07(0x1e6)]('SendScheduledMessage\x20->\x20Verify:\x20error',_0x3a932e[_0x1e7d07(0x1cc)]),Promise[_0x1e7d07(0x21c)](new sequelize_1[(_0x1e7d07(0x1d5))](_0x3a932e));}}[a574_0x2e31d2(0x1da)](_0x4ff4fd,_0x1f1d13){const _0x3c275c=a574_0x2e31d2;return Math[_0x3c275c(0x1d0)]()*(_0x1f1d13-_0x4ff4fd)+_0x4ff4fd;}async[a574_0x2e31d2(0x1ce)](_0x231b37){const _0x3768ca=a574_0x2e31d2,{data:{schedule:_0x278c7f}}=_0x231b37;let _0x1f0199=null;try{_0x1f0199=await Schedule_1[_0x3768ca(0x1db)][_0x3768ca(0x1f2)](_0x278c7f['id']);}catch(_0x52aca1){Sentry['captureException'](_0x52aca1),logger_1['logger']['info'](_0x3768ca(0x1f1)+_0x278c7f['id']);}try{if(_0x1f0199?.['daysR']!==null){let _0x29cd64=(0x0,moment_1[_0x3768ca(0x1db)])(_0x1f0199[_0x3768ca(0x21b)]);const _0x34300b=_0x278c7f['companyId'],_0x2d8928=await(0x0,GetDefaultWhatsApp_1['default'])(_0x278c7f['companyId']);let _0x247b46=null;const _0x33442d=_0x1f0199?.[_0x3768ca(0x1e0)];_0x33442d?Tag_1[_0x3768ca(0x1db)][_0x3768ca(0x1f2)](_0x33442d)[_0x3768ca(0x1e9)](async _0x11d35b=>{const _0x1ae302=_0x3768ca;if(_0x11d35b){let _0x334367=_0x29cd64[_0x1ae302(0x1d4)](_0x11d35b[_0x1ae302(0x1d9)],'days')['format'](_0x1ae302(0x219));_0x11d35b[_0x1ae302(0x1e1)]&&(await(0x0,SendMessage_1[_0x1ae302(0x213)])(_0x2d8928,{'number':_0x278c7f[_0x1ae302(0x205)]['number'],'body':_0x11d35b['msgR']}),_0x247b46=path_1['default'][_0x1ae302(0x215)](_0x1ae302(0x1fa)+_0x34300b,_0x11d35b['mediaPath']),await(0x0,SendMessage_1[_0x1ae302(0x213)])(_0x2d8928,{'number':_0x278c7f[_0x1ae302(0x205)][_0x1ae302(0x1dc)],'body':_0x11d35b[_0x1ae302(0x1d8)],'mediaPath':_0x247b46})),_0x11d35b[_0x1ae302(0x1d9)]===0x0?await _0x1f0199?.[_0x1ae302(0x1d2)]({'sentAt':(0x0,moment_1[_0x1ae302(0x1db)])()[_0x1ae302(0x1d6)](_0x1ae302(0x219)),'status':_0x1ae302(0x1f8)}):await _0x1f0199?.[_0x1ae302(0x1d2)]({'sendAt':_0x334367,'status':_0x1ae302(0x207)}),logger_1['logger'][_0x1ae302(0x1ea)](_0x1ae302(0x1d7)+_0x278c7f[_0x1ae302(0x205)][_0x1ae302(0x21a)]+'\x20');}else console[_0x1ae302(0x20d)]('Tag\x20não\x20encontrada');})[_0x3768ca(0x1cb)](_0x5262da=>{const _0x4917fd=_0x3768ca;console['error'](_0x4917fd(0x20b),_0x5262da);}):console['log'](_0x3768ca(0x1f4));}else{const _0x558b99=await(0x0,GetDefaultWhatsApp_1[_0x3768ca(0x1db)])(_0x278c7f[_0x3768ca(0x208)]);let _0x514b24=null;_0x278c7f[_0x3768ca(0x1e1)]&&(_0x514b24=path_1[_0x3768ca(0x1db)][_0x3768ca(0x215)](_0x3768ca(0x1fa)+_0x278c7f[_0x3768ca(0x208)],_0x278c7f[_0x3768ca(0x1e1)])),await(0x0,SendMessage_1[_0x3768ca(0x213)])(_0x558b99,{'number':_0x278c7f[_0x3768ca(0x205)]['number'],'body':_0x278c7f['body'],'mediaPath':_0x514b24}),await _0x1f0199?.[_0x3768ca(0x1d2)]({'sentAt':(0x0,moment_1[_0x3768ca(0x1db)])()['format'](_0x3768ca(0x219)),'status':_0x3768ca(0x1f8)}),logger_1['logger']['info'](_0x3768ca(0x1d7)+_0x278c7f[_0x3768ca(0x205)][_0x3768ca(0x21a)]);}}catch(_0x1eaf29){Sentry[_0x3768ca(0x214)](_0x1eaf29),await _0x1f0199?.['update']({'status':_0x3768ca(0x1f3)}),logger_1[_0x3768ca(0x1d3)]['error'](_0x3768ca(0x1f5),_0x1eaf29[_0x3768ca(0x1cc)]);throw _0x1eaf29;}}}exports['default']=ScheduledMessageJob;