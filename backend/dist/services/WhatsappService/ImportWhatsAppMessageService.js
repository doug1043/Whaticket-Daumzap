const a563_0x5bd757=a563_0x442f;function a563_0x442f(_0x2af9a,_0x57e394){const _0x56d605=a563_0x3444();return a563_0x442f=function(_0x554b46,_0x567c88){_0x554b46=_0x554b46-0x140;let _0x344452=_0x56d605[_0x554b46];return _0x344452;},a563_0x442f(_0x2af9a,_0x57e394);}(function(_0x5aaed8,_0x5e6677){const _0x266468=a563_0x442f,_0x3810d9=_0x5aaed8();while(!![]){try{const _0xbc37db=-parseInt(_0x266468(0x177))/0x1*(-parseInt(_0x266468(0x172))/0x2)+parseInt(_0x266468(0x14a))/0x3+-parseInt(_0x266468(0x157))/0x4*(-parseInt(_0x266468(0x165))/0x5)+parseInt(_0x266468(0x159))/0x6+-parseInt(_0x266468(0x16c))/0x7*(-parseInt(_0x266468(0x163))/0x8)+parseInt(_0x266468(0x150))/0x9*(-parseInt(_0x266468(0x15a))/0xa)+-parseInt(_0x266468(0x162))/0xb;if(_0xbc37db===_0x5e6677)break;else _0x3810d9['push'](_0x3810d9['shift']());}catch(_0x175010){_0x3810d9['push'](_0x3810d9['shift']());}}}(a563_0x3444,0xc1de6));const a563_0x567c88=(function(){let _0x928deb=!![];return function(_0x45eae6,_0x929344){const _0x26b2ae=_0x928deb?function(){if(_0x929344){const _0x5483d8=_0x929344['apply'](_0x45eae6,arguments);return _0x929344=null,_0x5483d8;}}:function(){};return _0x928deb=![],_0x26b2ae;};}()),a563_0x554b46=a563_0x567c88(this,function(){const _0x4b7ced=a563_0x442f;return a563_0x554b46['toString']()[_0x4b7ced(0x151)](_0x4b7ced(0x16b))[_0x4b7ced(0x16f)]()[_0x4b7ced(0x15f)](a563_0x554b46)[_0x4b7ced(0x151)](_0x4b7ced(0x16b));});a563_0x554b46();'use strict';var __importDefault=this&&this[a563_0x5bd757(0x14b)]||function(_0x17ec6d){return _0x17ec6d&&_0x17ec6d['__esModule']?_0x17ec6d:{'default':_0x17ec6d};};function a563_0x3444(){const _0x387ea5=['2365370vRhDYR','findByPk','handleMessage','toString','../../models/Ticket','messageTimestamp','756226BZXsTR','getIO','moment','dataMessages','emit','1ihnWKn','floor','has','sequelize','key','../../libs/socket','closeImportedTickets','../../errors/AppError','processImportMessagesWppId','default','refresh','company-','6006evtQVF','__importDefault','log','-mainchannel','importMessages-','closed','9432QdZmjx','search','defineProperty','__esModule','sort','date-fns','../../models/Whatsapp','708dXmTcX','format','5701116SnqUza','11890jxFnLS','findAll','renderButtonCloseTickets','closedTicketsPostImported','length','constructor','../WbotServices/wbotMessageListener','ERROR_IMPORTING_MESSAGE','10887041eTzsjp','16zqoQwB','companyId','28920iQqadY','update','whatsapps','../TicketServices/UpdateTicketService','low','../../libs/wbot','(((.+)+)+)+$'];a563_0x3444=function(){return _0x387ea5;};return a563_0x3444();}Object[a563_0x5bd757(0x152)](exports,a563_0x5bd757(0x153),{'value':!![]}),exports[a563_0x5bd757(0x144)]=void 0x0;const AppError_1=__importDefault(require(a563_0x5bd757(0x145))),Whatsapp_1=__importDefault(require(a563_0x5bd757(0x156))),Ticket_1=__importDefault(require(a563_0x5bd757(0x170))),UpdateTicketService_1=__importDefault(require(a563_0x5bd757(0x168))),wbot_1=require(a563_0x5bd757(0x16a)),socket_1=require(a563_0x5bd757(0x143)),wbotMessageListener_1=require(a563_0x5bd757(0x160)),moment_1=__importDefault(require(a563_0x5bd757(0x174))),sequelize_1=require(a563_0x5bd757(0x141)),date_fns_1=require(a563_0x5bd757(0x155)),closeImportedTickets=async _0x34b90c=>{const _0xe8e046=a563_0x5bd757;console[_0xe8e046(0x14c)](_0xe8e046(0x144));const _0x4b2d77=await Ticket_1[_0xe8e046(0x147)][_0xe8e046(0x15b)]({'where':{'status':'pending','whatsappId':_0x34b90c,'imported':{[sequelize_1['Op']['lt']]:(0x0,date_fns_1['add'])(new Date(),{'hours':0x5})}}});for(const _0xec8474 of _0x4b2d77){await new Promise(_0x5dad51=>setTimeout(_0x5dad51,0x14a)),await(0x0,UpdateTicketService_1[_0xe8e046(0x147)])({'ticketData':{'status':_0xe8e046(0x14f)},'ticketId':_0xec8474['id'],'companyId':_0xec8474[_0xe8e046(0x164)]});}let _0xb22511=await Whatsapp_1[_0xe8e046(0x147)][_0xe8e046(0x16d)](_0x34b90c);_0xb22511[_0xe8e046(0x166)]({'statusImportMessages':null});const _0x1c28c2=(0x0,socket_1[_0xe8e046(0x173)])();_0x1c28c2['to'](_0xe8e046(0x149)+_0xb22511[_0xe8e046(0x164)]+_0xe8e046(0x14d))[_0xe8e046(0x176)](_0xe8e046(0x14e)+_0xb22511[_0xe8e046(0x164)],{'action':_0xe8e046(0x148)});};exports['closeImportedTickets']=closeImportedTickets;function compareMessageTimestamps(_0x288efc,_0x1ecd8c){const _0x3295de=a563_0x5bd757;return _0x288efc[_0x3295de(0x171)]-_0x1ecd8c[_0x3295de(0x171)];}function removeDuplicateById(_0x49457c){const _0x15e3d1=a563_0x5bd757,_0x2316a2=new Map(),_0x233184=[];for(const _0x9ea230 of _0x49457c){const _0x19cb55=_0x9ea230[_0x15e3d1(0x142)]['id'];!_0x2316a2[_0x15e3d1(0x140)](_0x19cb55)&&(_0x2316a2['set'](_0x19cb55,!![]),_0x233184['push'](_0x9ea230));}return _0x233184[_0x15e3d1(0x154)](compareMessageTimestamps);}const ImportWhatsAppService=async _0x4c4e31=>{const _0x1f6930=a563_0x5bd757,_0x84f6a8=(0x0,wbot_1['getWbot'])(_0x4c4e31['id']);try{const _0xc3c312=(0x0,socket_1[_0x1f6930(0x173)])(),_0x56d8bd=removeDuplicateById(wbot_1[_0x1f6930(0x175)][_0x4c4e31['id']]);console[_0x1f6930(0x14c)](_0x1f6930(0x146));const _0x3001a3=_0x56d8bd[_0x1f6930(0x15e)];let _0x14141a=0x0;while(_0x14141a<_0x3001a3){try{const _0x1a6aeb=_0x56d8bd[_0x14141a];await(0x0,wbotMessageListener_1[_0x1f6930(0x16e)])(_0x1a6aeb,_0x84f6a8,_0x4c4e31[_0x1f6930(0x164)],!![]);if(_0x14141a%0x2===0x0){const _0x4431b8=Math[_0x1f6930(0x178)](_0x1a6aeb[_0x1f6930(0x171)][_0x1f6930(0x169)]*0x3e8);_0xc3c312[_0x1f6930(0x176)](_0x1f6930(0x14e)+_0x4c4e31[_0x1f6930(0x164)],{'action':_0x1f6930(0x166),'status':{'this':_0x14141a+0x1,'all':_0x3001a3,'date':(0x0,moment_1['default'])(_0x4431b8)[_0x1f6930(0x158)]('DD/MM/YY\x20HH:mm:ss')}});}_0x14141a+0x1===_0x3001a3&&(wbot_1[_0x1f6930(0x175)][_0x4c4e31['id']]=[],_0x4c4e31[_0x1f6930(0x15d)]&&await(0x0,exports[_0x1f6930(0x144)])(_0x4c4e31['id']),await _0x4c4e31['update']({'statusImportMessages':_0x4c4e31['closedTicketsPostImported']?null:_0x1f6930(0x15c),'importOldMessages':null,'importRecentMessages':null}),_0xc3c312['to'](_0x1f6930(0x149)+_0x4c4e31[_0x1f6930(0x164)]+'-mainchannel')[_0x1f6930(0x176)](_0x1f6930(0x14e)+_0x4c4e31['companyId'],{'action':_0x1f6930(0x148)}));}catch(_0x2c7f52){console[_0x1f6930(0x14c)](_0x2c7f52),console[_0x1f6930(0x14c)](_0x1f6930(0x161));}_0x14141a++;}}catch(_0x49707d){console[_0x1f6930(0x14c)](_0x49707d);throw new AppError_1[(_0x1f6930(0x147))]('ERR_NOT_MESSAGE_TO_IMPORT',0x193);}return _0x1f6930(0x167);};exports['default']=ImportWhatsAppService;