const a565_0x40ea8f=a565_0x5a97;function a565_0x484a(){const _0x2a64d8=['../../models/Whatsapp','push','floor','245260XKigLj','__esModule','companyId','findAll','2978962HhwoKV','closedTicketsPostImported','default','messageTimestamp','10170160jDgRNV','../../models/Ticket','dataMessages','length','7132mOHtGv','key','log','../../libs/socket','handleMessage','../TicketServices/UpdateTicketService','add','low','48YjBFxf','apply','constructor','1040DeMQOQ','moment','6xeoJMy','ERR_NOT_MESSAGE_TO_IMPORT','update','../WbotServices/wbotMessageListener','../../errors/AppError','sort','processImportMessagesWppId','emit','findByPk','closeImportedTickets','format','has','326403YqbNYs','date-fns','-mainchannel','pending','88029xtVuBd','refresh','getWbot','company-','set','importMessages-','getIO','(((.+)+)+)+$','150854HnODDu','search'];a565_0x484a=function(){return _0x2a64d8;};return a565_0x484a();}(function(_0xdc16b3,_0x8f5be2){const _0xac436e=a565_0x5a97,_0xfff38e=_0xdc16b3();while(!![]){try{const _0x124536=parseInt(_0xac436e(0xee))/0x1+parseInt(_0xac436e(0xe9))/0x2+parseInt(_0xac436e(0xdd))/0x3+parseInt(_0xac436e(0xfa))/0x4*(parseInt(_0xac436e(0x105))/0x5)+-parseInt(_0xac436e(0x107))/0x6*(-parseInt(_0xac436e(0xf2))/0x7)+-parseInt(_0xac436e(0x102))/0x8*(-parseInt(_0xac436e(0xe1))/0x9)+-parseInt(_0xac436e(0xf6))/0xa;if(_0x124536===_0x8f5be2)break;else _0xfff38e['push'](_0xfff38e['shift']());}catch(_0x334bcb){_0xfff38e['push'](_0xfff38e['shift']());}}}(a565_0x484a,0x41544));const a565_0x1a8b58=(function(){let _0x261ef7=!![];return function(_0x173884,_0x46031a){const _0x487f82=_0x261ef7?function(){const _0x33e2b2=a565_0x5a97;if(_0x46031a){const _0x272e62=_0x46031a[_0x33e2b2(0x103)](_0x173884,arguments);return _0x46031a=null,_0x272e62;}}:function(){};return _0x261ef7=![],_0x487f82;};}()),a565_0x3954c9=a565_0x1a8b58(this,function(){const _0xd5a37e=a565_0x5a97;return a565_0x3954c9['toString']()[_0xd5a37e(0xea)]('(((.+)+)+)+$')['toString']()[_0xd5a37e(0x104)](a565_0x3954c9)[_0xd5a37e(0xea)](_0xd5a37e(0xe8));});a565_0x3954c9();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x1a49a0){const _0x1ff845=a565_0x5a97;return _0x1a49a0&&_0x1a49a0[_0x1ff845(0xef)]?_0x1a49a0:{'default':_0x1a49a0};};Object['defineProperty'](exports,a565_0x40ea8f(0xef),{'value':!![]}),exports[a565_0x40ea8f(0xda)]=void 0x0;const AppError_1=__importDefault(require(a565_0x40ea8f(0xd5))),Whatsapp_1=__importDefault(require(a565_0x40ea8f(0xeb))),Ticket_1=__importDefault(require(a565_0x40ea8f(0xf7))),UpdateTicketService_1=__importDefault(require(a565_0x40ea8f(0xff))),wbot_1=require('../../libs/wbot'),socket_1=require(a565_0x40ea8f(0xfd)),wbotMessageListener_1=require(a565_0x40ea8f(0xd4)),moment_1=__importDefault(require(a565_0x40ea8f(0x106))),sequelize_1=require('sequelize'),date_fns_1=require(a565_0x40ea8f(0xde)),closeImportedTickets=async _0x4ec9b2=>{const _0x3af3de=a565_0x40ea8f;console['log'](_0x3af3de(0xda));const _0x17d53d=await Ticket_1['default'][_0x3af3de(0xf1)]({'where':{'status':_0x3af3de(0xe0),'whatsappId':_0x4ec9b2,'imported':{[sequelize_1['Op']['lt']]:(0x0,date_fns_1[_0x3af3de(0x100)])(new Date(),{'hours':0x5})}}});for(const _0x12cf33 of _0x17d53d){await new Promise(_0x32af04=>setTimeout(_0x32af04,0x14a)),await(0x0,UpdateTicketService_1[_0x3af3de(0xf4)])({'ticketData':{'status':'closed'},'ticketId':_0x12cf33['id'],'companyId':_0x12cf33[_0x3af3de(0xf0)]});}let _0x510ce6=await Whatsapp_1[_0x3af3de(0xf4)][_0x3af3de(0xd9)](_0x4ec9b2);_0x510ce6[_0x3af3de(0xd3)]({'statusImportMessages':null});const _0x386409=(0x0,socket_1[_0x3af3de(0xe7)])();_0x386409['to'](_0x3af3de(0xe4)+_0x510ce6['companyId']+_0x3af3de(0xdf))[_0x3af3de(0xd8)]('importMessages-'+_0x510ce6[_0x3af3de(0xf0)],{'action':'refresh'});};exports[a565_0x40ea8f(0xda)]=closeImportedTickets;function compareMessageTimestamps(_0x3fbc44,_0x518dd5){const _0x500d81=a565_0x40ea8f;return _0x3fbc44[_0x500d81(0xf5)]-_0x518dd5[_0x500d81(0xf5)];}function a565_0x5a97(_0x4d594a,_0x15bec6){const _0x36e15a=a565_0x484a();return a565_0x5a97=function(_0x3954c9,_0x1a8b58){_0x3954c9=_0x3954c9-0xd3;let _0x484a09=_0x36e15a[_0x3954c9];return _0x484a09;},a565_0x5a97(_0x4d594a,_0x15bec6);}function removeDuplicateById(_0x621eb1){const _0x42761a=a565_0x40ea8f,_0x3c316d=new Map(),_0x4ce0fc=[];for(const _0x5aec32 of _0x621eb1){const _0x192d4d=_0x5aec32[_0x42761a(0xfb)]['id'];!_0x3c316d[_0x42761a(0xdc)](_0x192d4d)&&(_0x3c316d[_0x42761a(0xe5)](_0x192d4d,!![]),_0x4ce0fc[_0x42761a(0xec)](_0x5aec32));}return _0x4ce0fc[_0x42761a(0xd6)](compareMessageTimestamps);}const ImportWhatsAppService=async _0x57a9c3=>{const _0x3b8f59=a565_0x40ea8f,_0x508879=(0x0,wbot_1[_0x3b8f59(0xe3)])(_0x57a9c3['id']);try{const _0x11dfe1=(0x0,socket_1[_0x3b8f59(0xe7)])(),_0x587f51=removeDuplicateById(wbot_1['dataMessages'][_0x57a9c3['id']]);console['log'](_0x3b8f59(0xd7));const _0x2f7c7a=_0x587f51[_0x3b8f59(0xf9)];let _0x2d5fde=0x0;while(_0x2d5fde<_0x2f7c7a){try{const _0x201e94=_0x587f51[_0x2d5fde];await(0x0,wbotMessageListener_1[_0x3b8f59(0xfe)])(_0x201e94,_0x508879,_0x57a9c3['companyId'],!![]);if(_0x2d5fde%0x2===0x0){const _0xf000e5=Math[_0x3b8f59(0xed)](_0x201e94[_0x3b8f59(0xf5)][_0x3b8f59(0x101)]*0x3e8);_0x11dfe1['emit']('importMessages-'+_0x57a9c3[_0x3b8f59(0xf0)],{'action':_0x3b8f59(0xd3),'status':{'this':_0x2d5fde+0x1,'all':_0x2f7c7a,'date':(0x0,moment_1[_0x3b8f59(0xf4)])(_0xf000e5)[_0x3b8f59(0xdb)]('DD/MM/YY\x20HH:mm:ss')}});}_0x2d5fde+0x1===_0x2f7c7a&&(wbot_1[_0x3b8f59(0xf8)][_0x57a9c3['id']]=[],_0x57a9c3['closedTicketsPostImported']&&await(0x0,exports['closeImportedTickets'])(_0x57a9c3['id']),await _0x57a9c3[_0x3b8f59(0xd3)]({'statusImportMessages':_0x57a9c3[_0x3b8f59(0xf3)]?null:'renderButtonCloseTickets','importOldMessages':null,'importRecentMessages':null}),_0x11dfe1['to'](_0x3b8f59(0xe4)+_0x57a9c3[_0x3b8f59(0xf0)]+'-mainchannel')[_0x3b8f59(0xd8)](_0x3b8f59(0xe6)+_0x57a9c3[_0x3b8f59(0xf0)],{'action':_0x3b8f59(0xe2)}));}catch(_0x2acea1){console[_0x3b8f59(0xfc)](_0x2acea1),console['log']('ERROR_IMPORTING_MESSAGE');}_0x2d5fde++;}}catch(_0x22dbdb){console['log'](_0x22dbdb);throw new AppError_1[(_0x3b8f59(0xf4))](_0x3b8f59(0x108),0x193);}return'whatsapps';};exports[a565_0x40ea8f(0xf4)]=ImportWhatsAppService;