const a555_0x59f513=a555_0x550b;(function(_0x215a2f,_0x57049e){const _0x2c21e9=a555_0x550b,_0xf1a310=_0x215a2f();while(!![]){try{const _0x1388f4=parseInt(_0x2c21e9(0x1c1))/0x1+-parseInt(_0x2c21e9(0x1ca))/0x2*(-parseInt(_0x2c21e9(0x1a7))/0x3)+parseInt(_0x2c21e9(0x1b6))/0x4+parseInt(_0x2c21e9(0x1ad))/0x5*(parseInt(_0x2c21e9(0x1ba))/0x6)+-parseInt(_0x2c21e9(0x19f))/0x7+parseInt(_0x2c21e9(0x1b1))/0x8+-parseInt(_0x2c21e9(0x1b9))/0x9*(parseInt(_0x2c21e9(0x1cb))/0xa);if(_0x1388f4===_0x57049e)break;else _0xf1a310['push'](_0xf1a310['shift']());}catch(_0x58636a){_0xf1a310['push'](_0xf1a310['shift']());}}}(a555_0x6c16,0x81c60));const a555_0x605b8d=(function(){let _0x570e93=!![];return function(_0x56c61e,_0xc49fe7){const _0x475bd1=_0x570e93?function(){if(_0xc49fe7){const _0x43d63c=_0xc49fe7['apply'](_0x56c61e,arguments);return _0xc49fe7=null,_0x43d63c;}}:function(){};return _0x570e93=![],_0x475bd1;};}()),a555_0x5eb0c5=a555_0x605b8d(this,function(){const _0x5ce68f=a555_0x550b;return a555_0x5eb0c5[_0x5ce68f(0x1be)]()[_0x5ce68f(0x1a6)](_0x5ce68f(0x1a9))[_0x5ce68f(0x1be)]()[_0x5ce68f(0x1bb)](a555_0x5eb0c5)['search'](_0x5ce68f(0x1a9));});a555_0x5eb0c5();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x535917){return _0x535917&&_0x535917['__esModule']?_0x535917:{'default':_0x535917};};Object[a555_0x59f513(0x1c7)](exports,'__esModule',{'value':!![]}),exports[a555_0x59f513(0x1b5)]=void 0x0;const AppError_1=__importDefault(require(a555_0x59f513(0x1c6))),Whatsapp_1=__importDefault(require(a555_0x59f513(0x1a8))),Ticket_1=__importDefault(require(a555_0x59f513(0x1bd))),UpdateTicketService_1=__importDefault(require(a555_0x59f513(0x19d))),wbot_1=require(a555_0x59f513(0x1a5)),socket_1=require(a555_0x59f513(0x1c5)),wbotMessageListener_1=require(a555_0x59f513(0x1a3)),moment_1=__importDefault(require(a555_0x59f513(0x1c3))),sequelize_1=require(a555_0x59f513(0x1ac)),date_fns_1=require('date-fns'),closeImportedTickets=async _0x130de0=>{const _0x813c0=a555_0x59f513;console[_0x813c0(0x1b8)](_0x813c0(0x1b5));const _0x3bd336=await Ticket_1[_0x813c0(0x19e)][_0x813c0(0x198)]({'where':{'status':'pending','whatsappId':_0x130de0,'imported':{[sequelize_1['Op']['lt']]:(0x0,date_fns_1[_0x813c0(0x1bc)])(new Date(),{'hours':0x5})}}});for(const _0x3446ca of _0x3bd336){await new Promise(_0x3e415a=>setTimeout(_0x3e415a,0x14a)),await(0x0,UpdateTicketService_1[_0x813c0(0x19e)])({'ticketData':{'status':_0x813c0(0x1a4)},'ticketId':_0x3446ca['id'],'companyId':_0x3446ca[_0x813c0(0x1a0)]});}let _0x210d0c=await Whatsapp_1[_0x813c0(0x19e)][_0x813c0(0x19a)](_0x130de0);_0x210d0c[_0x813c0(0x1a1)]({'statusImportMessages':null});const _0x6dcf0=(0x0,socket_1[_0x813c0(0x1aa)])();_0x6dcf0['to'](_0x813c0(0x1ae)+_0x210d0c[_0x813c0(0x1a0)]+_0x813c0(0x19b))[_0x813c0(0x1bf)](_0x813c0(0x1ab)+_0x210d0c[_0x813c0(0x1a0)],{'action':_0x813c0(0x1c4)});};exports[a555_0x59f513(0x1b5)]=closeImportedTickets;function compareMessageTimestamps(_0x1c713,_0x18695f){const _0xe20293=a555_0x59f513;return _0x1c713['messageTimestamp']-_0x18695f[_0xe20293(0x1c8)];}function removeDuplicateById(_0x46ee06){const _0x5019c0=a555_0x59f513,_0x1f677d=new Map(),_0x3c59b2=[];for(const _0x459f04 of _0x46ee06){const _0x21e8c4=_0x459f04[_0x5019c0(0x19c)]['id'];!_0x1f677d['has'](_0x21e8c4)&&(_0x1f677d[_0x5019c0(0x1b4)](_0x21e8c4,!![]),_0x3c59b2['push'](_0x459f04));}return _0x3c59b2['sort'](compareMessageTimestamps);}function a555_0x550b(_0x1c0c1f,_0x46982f){const _0x30829b=a555_0x6c16();return a555_0x550b=function(_0x5eb0c5,_0x605b8d){_0x5eb0c5=_0x5eb0c5-0x198;let _0x6c16b5=_0x30829b[_0x5eb0c5];return _0x6c16b5;},a555_0x550b(_0x1c0c1f,_0x46982f);}const ImportWhatsAppService=async _0x3d7440=>{const _0x57d950=a555_0x59f513,_0x33e1c4=(0x0,wbot_1[_0x57d950(0x1b2)])(_0x3d7440['id']);try{const _0x4d985d=(0x0,socket_1[_0x57d950(0x1aa)])(),_0x132570=removeDuplicateById(wbot_1['dataMessages'][_0x3d7440['id']]);console[_0x57d950(0x1b8)]('processImportMessagesWppId');const _0x2378f5=_0x132570['length'];let _0x4a9277=0x0;while(_0x4a9277<_0x2378f5){try{const _0x57cc0b=_0x132570[_0x4a9277];await(0x0,wbotMessageListener_1[_0x57d950(0x1c2)])(_0x57cc0b,_0x33e1c4,_0x3d7440[_0x57d950(0x1a0)],!![]);if(_0x4a9277%0x2===0x0){const _0x5d0445=Math[_0x57d950(0x1b7)](_0x57cc0b[_0x57d950(0x1c8)]['low']*0x3e8);_0x4d985d[_0x57d950(0x1bf)](_0x57d950(0x1ab)+_0x3d7440['companyId'],{'action':_0x57d950(0x1a1),'status':{'this':_0x4a9277+0x1,'all':_0x2378f5,'date':(0x0,moment_1[_0x57d950(0x19e)])(_0x5d0445)[_0x57d950(0x199)](_0x57d950(0x1b3))}});}_0x4a9277+0x1===_0x2378f5&&(wbot_1['dataMessages'][_0x3d7440['id']]=[],_0x3d7440[_0x57d950(0x1b0)]&&await(0x0,exports[_0x57d950(0x1b5)])(_0x3d7440['id']),await _0x3d7440['update']({'statusImportMessages':_0x3d7440[_0x57d950(0x1b0)]?null:_0x57d950(0x1c9),'importOldMessages':null,'importRecentMessages':null}),_0x4d985d['to'](_0x57d950(0x1ae)+_0x3d7440['companyId']+_0x57d950(0x19b))[_0x57d950(0x1bf)]('importMessages-'+_0x3d7440[_0x57d950(0x1a0)],{'action':_0x57d950(0x1c4)}));}catch(_0x1be63e){console[_0x57d950(0x1b8)](_0x1be63e),console[_0x57d950(0x1b8)](_0x57d950(0x1a2));}_0x4a9277++;}}catch(_0x18fcf8){console[_0x57d950(0x1b8)](_0x18fcf8);throw new AppError_1[(_0x57d950(0x19e))](_0x57d950(0x1c0),0x193);}return _0x57d950(0x1af);};function a555_0x6c16(){const _0x109880=['getIO','importMessages-','sequelize','5JhtnNp','company-','whatsapps','closedTicketsPostImported','859544FyyQlX','getWbot','DD/MM/YY\x20HH:mm:ss','set','closeImportedTickets','132628kNegMr','floor','log','103419DXkYyO','6076482vaBzBp','constructor','add','../../models/Ticket','toString','emit','ERR_NOT_MESSAGE_TO_IMPORT','847443nyuAZp','handleMessage','moment','refresh','../../libs/socket','../../errors/AppError','defineProperty','messageTimestamp','renderButtonCloseTickets','2MAvvtr','1780DWgIcg','findAll','format','findByPk','-mainchannel','key','../TicketServices/UpdateTicketService','default','2251431rATOlW','companyId','update','ERROR_IMPORTING_MESSAGE','../WbotServices/wbotMessageListener','closed','../../libs/wbot','search','2693379GSoQOL','../../models/Whatsapp','(((.+)+)+)+$'];a555_0x6c16=function(){return _0x109880;};return a555_0x6c16();}exports[a555_0x59f513(0x19e)]=ImportWhatsAppService;