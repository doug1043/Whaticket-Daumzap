const a563_0x4bf105=a563_0x2b41;(function(_0x4c8564,_0x4968f0){const _0x4a6478=a563_0x2b41,_0x5733ca=_0x4c8564();while(!![]){try{const _0x225333=parseInt(_0x4a6478(0x1e5))/0x1+parseInt(_0x4a6478(0x1f3))/0x2+parseInt(_0x4a6478(0x1ef))/0x3*(-parseInt(_0x4a6478(0x1f4))/0x4)+-parseInt(_0x4a6478(0x1e2))/0x5*(-parseInt(_0x4a6478(0x1f5))/0x6)+-parseInt(_0x4a6478(0x1db))/0x7+parseInt(_0x4a6478(0x206))/0x8+parseInt(_0x4a6478(0x201))/0x9*(-parseInt(_0x4a6478(0x208))/0xa);if(_0x225333===_0x4968f0)break;else _0x5733ca['push'](_0x5733ca['shift']());}catch(_0x2ca619){_0x5733ca['push'](_0x5733ca['shift']());}}}(a563_0x42a3,0xa7627));const a563_0x53583d=(function(){let _0x4c1d9a=!![];return function(_0x8dbede,_0x1be5dc){const _0x466946=_0x4c1d9a?function(){const _0x3f3fa0=a563_0x2b41;if(_0x1be5dc){const _0x2e1535=_0x1be5dc[_0x3f3fa0(0x1e3)](_0x8dbede,arguments);return _0x1be5dc=null,_0x2e1535;}}:function(){};return _0x4c1d9a=![],_0x466946;};}()),a563_0x49ef91=a563_0x53583d(this,function(){const _0x5deb1e=a563_0x2b41;return a563_0x49ef91[_0x5deb1e(0x1de)]()[_0x5deb1e(0x1fa)](_0x5deb1e(0x1d7))[_0x5deb1e(0x1de)]()[_0x5deb1e(0x1ec)](a563_0x49ef91)['search'](_0x5deb1e(0x1d7));});a563_0x49ef91();'use strict';var __importDefault=this&&this[a563_0x4bf105(0x1dd)]||function(_0x2cda27){const _0x2a6508=a563_0x4bf105;return _0x2cda27&&_0x2cda27[_0x2a6508(0x1e9)]?_0x2cda27:{'default':_0x2cda27};};Object['defineProperty'](exports,a563_0x4bf105(0x1e9),{'value':!![]}),exports['closeImportedTickets']=void 0x0;const AppError_1=__importDefault(require(a563_0x4bf105(0x1d9))),Whatsapp_1=__importDefault(require(a563_0x4bf105(0x202))),Ticket_1=__importDefault(require('../../models/Ticket')),UpdateTicketService_1=__importDefault(require(a563_0x4bf105(0x1e1))),wbot_1=require(a563_0x4bf105(0x1e4)),socket_1=require(a563_0x4bf105(0x1f9)),wbotMessageListener_1=require(a563_0x4bf105(0x203)),moment_1=__importDefault(require(a563_0x4bf105(0x1fe))),sequelize_1=require(a563_0x4bf105(0x1ff)),date_fns_1=require(a563_0x4bf105(0x1ea)),closeImportedTickets=async _0x28724e=>{const _0x39257f=a563_0x4bf105;console[_0x39257f(0x1f7)](_0x39257f(0x1df));const _0x40b3bd=await Ticket_1[_0x39257f(0x1ee)][_0x39257f(0x204)]({'where':{'status':_0x39257f(0x1fb),'whatsappId':_0x28724e,'imported':{[sequelize_1['Op']['lt']]:(0x0,date_fns_1[_0x39257f(0x20a)])(new Date(),{'hours':0x5})}}});for(const _0x398196 of _0x40b3bd){await new Promise(_0x44baa3=>setTimeout(_0x44baa3,0x14a)),await(0x0,UpdateTicketService_1[_0x39257f(0x1ee)])({'ticketData':{'status':_0x39257f(0x1e0)},'ticketId':_0x398196['id'],'companyId':_0x398196[_0x39257f(0x209)]});}let _0x59837a=await Whatsapp_1[_0x39257f(0x1ee)][_0x39257f(0x1dc)](_0x28724e);_0x59837a['update']({'statusImportMessages':null});const _0x3c42c8=(0x0,socket_1['getIO'])();_0x3c42c8['to'](_0x39257f(0x205)+_0x59837a[_0x39257f(0x209)]+_0x39257f(0x1e7))[_0x39257f(0x207)](_0x39257f(0x1f0)+_0x59837a[_0x39257f(0x209)],{'action':_0x39257f(0x1fc)});};function a563_0x42a3(){const _0x453282=['low','(((.+)+)+)+$','renderButtonCloseTickets','../../errors/AppError','format','416346hIEapM','findByPk','__importDefault','toString','closeImportedTickets','closed','../TicketServices/UpdateTicketService','20NIdqfb','apply','../../libs/wbot','960883VIobNf','ERR_NOT_MESSAGE_TO_IMPORT','-mainchannel','length','__esModule','date-fns','messageTimestamp','constructor','dataMessages','default','1756554dwlDvw','importMessages-','ERROR_IMPORTING_MESSAGE','handleMessage','1930818gyUCXw','8QqWTGN','186666smAVEU','DD/MM/YY\x20HH:mm:ss','log','update','../../libs/socket','search','pending','refresh','sort','moment','sequelize','getIO','17532hLYoSY','../../models/Whatsapp','../WbotServices/wbotMessageListener','findAll','company-','2460648wGJMEI','emit','2270niAYXR','companyId','add','push','floor','key'];a563_0x42a3=function(){return _0x453282;};return a563_0x42a3();}exports[a563_0x4bf105(0x1df)]=closeImportedTickets;function compareMessageTimestamps(_0x963df1,_0x2b6d73){const _0x198ad=a563_0x4bf105;return _0x963df1['messageTimestamp']-_0x2b6d73[_0x198ad(0x1eb)];}function a563_0x2b41(_0x20bc55,_0x6331a9){const _0x54c6d5=a563_0x42a3();return a563_0x2b41=function(_0x49ef91,_0x53583d){_0x49ef91=_0x49ef91-0x1d3;let _0x42a37c=_0x54c6d5[_0x49ef91];return _0x42a37c;},a563_0x2b41(_0x20bc55,_0x6331a9);}function removeDuplicateById(_0x44593d){const _0x34458b=a563_0x4bf105,_0x1ce84a=new Map(),_0x1311fc=[];for(const _0x458d4c of _0x44593d){const _0x37c489=_0x458d4c[_0x34458b(0x1d5)]['id'];!_0x1ce84a['has'](_0x37c489)&&(_0x1ce84a['set'](_0x37c489,!![]),_0x1311fc[_0x34458b(0x1d3)](_0x458d4c));}return _0x1311fc[_0x34458b(0x1fd)](compareMessageTimestamps);}const ImportWhatsAppService=async _0x1a6c6a=>{const _0x21f226=a563_0x4bf105,_0x4f0261=(0x0,wbot_1['getWbot'])(_0x1a6c6a['id']);try{const _0xdc797a=(0x0,socket_1[_0x21f226(0x200)])(),_0x20825a=removeDuplicateById(wbot_1['dataMessages'][_0x1a6c6a['id']]);console[_0x21f226(0x1f7)]('processImportMessagesWppId');const _0x286e54=_0x20825a[_0x21f226(0x1e8)];let _0x52f6f7=0x0;while(_0x52f6f7<_0x286e54){try{const _0x602260=_0x20825a[_0x52f6f7];await(0x0,wbotMessageListener_1[_0x21f226(0x1f2)])(_0x602260,_0x4f0261,_0x1a6c6a[_0x21f226(0x209)],!![]);if(_0x52f6f7%0x2===0x0){const _0x2e4d9a=Math[_0x21f226(0x1d4)](_0x602260[_0x21f226(0x1eb)][_0x21f226(0x1d6)]*0x3e8);_0xdc797a[_0x21f226(0x207)](_0x21f226(0x1f0)+_0x1a6c6a[_0x21f226(0x209)],{'action':_0x21f226(0x1f8),'status':{'this':_0x52f6f7+0x1,'all':_0x286e54,'date':(0x0,moment_1['default'])(_0x2e4d9a)[_0x21f226(0x1da)](_0x21f226(0x1f6))}});}_0x52f6f7+0x1===_0x286e54&&(wbot_1[_0x21f226(0x1ed)][_0x1a6c6a['id']]=[],_0x1a6c6a['closedTicketsPostImported']&&await(0x0,exports[_0x21f226(0x1df)])(_0x1a6c6a['id']),await _0x1a6c6a[_0x21f226(0x1f8)]({'statusImportMessages':_0x1a6c6a['closedTicketsPostImported']?null:_0x21f226(0x1d8),'importOldMessages':null,'importRecentMessages':null}),_0xdc797a['to'](_0x21f226(0x205)+_0x1a6c6a[_0x21f226(0x209)]+_0x21f226(0x1e7))[_0x21f226(0x207)](_0x21f226(0x1f0)+_0x1a6c6a[_0x21f226(0x209)],{'action':'refresh'}));}catch(_0x376e15){console['log'](_0x376e15),console['log'](_0x21f226(0x1f1));}_0x52f6f7++;}}catch(_0x325ab2){console[_0x21f226(0x1f7)](_0x325ab2);throw new AppError_1[(_0x21f226(0x1ee))](_0x21f226(0x1e6),0x193);}return'whatsapps';};exports[a563_0x4bf105(0x1ee)]=ImportWhatsAppService;