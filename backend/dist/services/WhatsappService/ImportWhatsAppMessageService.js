const a566_0x211d14=a566_0x4352;(function(_0x440bd0,_0x4fd873){const _0x34da05=a566_0x4352,_0x2fe747=_0x440bd0();while(!![]){try{const _0x34ce66=parseInt(_0x34da05(0x1c6))/0x1*(parseInt(_0x34da05(0x1aa))/0x2)+parseInt(_0x34da05(0x1c3))/0x3*(-parseInt(_0x34da05(0x1ce))/0x4)+parseInt(_0x34da05(0x1e3))/0x5*(parseInt(_0x34da05(0x1c4))/0x6)+parseInt(_0x34da05(0x1bc))/0x7+-parseInt(_0x34da05(0x1ab))/0x8+-parseInt(_0x34da05(0x1e0))/0x9*(-parseInt(_0x34da05(0x1c1))/0xa)+-parseInt(_0x34da05(0x1b0))/0xb*(parseInt(_0x34da05(0x1c9))/0xc);if(_0x34ce66===_0x4fd873)break;else _0x2fe747['push'](_0x2fe747['shift']());}catch(_0x122451){_0x2fe747['push'](_0x2fe747['shift']());}}}(a566_0x4ff5,0x77fef));const a566_0x1cbeaf=(function(){let _0x29c80f=!![];return function(_0x2f0a7d,_0x397469){const _0x2e3c94=_0x29c80f?function(){const _0xc8907e=a566_0x4352;if(_0x397469){const _0x4b4693=_0x397469[_0xc8907e(0x1d4)](_0x2f0a7d,arguments);return _0x397469=null,_0x4b4693;}}:function(){};return _0x29c80f=![],_0x2e3c94;};}()),a566_0x3ab7a3=a566_0x1cbeaf(this,function(){const _0x320bae=a566_0x4352;return a566_0x3ab7a3[_0x320bae(0x1d0)]()['search'](_0x320bae(0x1a9))[_0x320bae(0x1d0)]()[_0x320bae(0x1e4)](a566_0x3ab7a3)[_0x320bae(0x1cf)](_0x320bae(0x1a9));});a566_0x3ab7a3();'use strict';var __importDefault=this&&this['__importDefault']||function(_0xb7be8a){const _0x2b6244=a566_0x4352;return _0xb7be8a&&_0xb7be8a[_0x2b6244(0x1e1)]?_0xb7be8a:{'default':_0xb7be8a};};function a566_0x4ff5(){const _0x2b8a22=['ERR_NOT_MESSAGE_TO_IMPORT','10tNESEf','dataMessages','6BMIGRv','1652700ADJWyh','default','381158Iupkac','-mainchannel','importMessages-','3804NRjCCH','update','../../errors/AppError','defineProperty','../../libs/wbot','396252xzQCSN','search','toString','moment','companyId','closedTicketsPostImported','apply','length','messageTimestamp','date-fns','renderButtonCloseTickets','closeImportedTickets','log','has','processImportMessagesWppId','floor','handleMessage','whatsapps','1472265rjYcNu','__esModule','getWbot','15sRPgxC','constructor','company-','(((.+)+)+)+$','4XyTpim','419896mqmKvR','refresh','../TicketServices/UpdateTicketService','../../models/Whatsapp','closed','60335XdttAU','set','DD/MM/YY\x20HH:mm:ss','push','pending','low','sequelize','findAll','ERROR_IMPORTING_MESSAGE','findByPk','key','emit','5100270hGcBUZ','getIO','add','../../models/Ticket'];a566_0x4ff5=function(){return _0x2b8a22;};return a566_0x4ff5();}Object[a566_0x211d14(0x1cc)](exports,a566_0x211d14(0x1e1),{'value':!![]}),exports[a566_0x211d14(0x1d9)]=void 0x0;function a566_0x4352(_0x50db0e,_0x10210e){const _0x1e47cf=a566_0x4ff5();return a566_0x4352=function(_0x3ab7a3,_0x1cbeaf){_0x3ab7a3=_0x3ab7a3-0x1a9;let _0x4ff5b5=_0x1e47cf[_0x3ab7a3];return _0x4ff5b5;},a566_0x4352(_0x50db0e,_0x10210e);}const AppError_1=__importDefault(require(a566_0x211d14(0x1cb))),Whatsapp_1=__importDefault(require(a566_0x211d14(0x1ae))),Ticket_1=__importDefault(require(a566_0x211d14(0x1bf))),UpdateTicketService_1=__importDefault(require(a566_0x211d14(0x1ad))),wbot_1=require(a566_0x211d14(0x1cd)),socket_1=require('../../libs/socket'),wbotMessageListener_1=require('../WbotServices/wbotMessageListener'),moment_1=__importDefault(require(a566_0x211d14(0x1d1))),sequelize_1=require(a566_0x211d14(0x1b6)),date_fns_1=require(a566_0x211d14(0x1d7)),closeImportedTickets=async _0x5e004f=>{const _0x11cf66=a566_0x211d14;console[_0x11cf66(0x1da)]('closeImportedTickets');const _0x33ec3d=await Ticket_1['default'][_0x11cf66(0x1b7)]({'where':{'status':_0x11cf66(0x1b4),'whatsappId':_0x5e004f,'imported':{[sequelize_1['Op']['lt']]:(0x0,date_fns_1[_0x11cf66(0x1be)])(new Date(),{'hours':0x5})}}});for(const _0x2f6e3c of _0x33ec3d){await new Promise(_0x489917=>setTimeout(_0x489917,0x14a)),await(0x0,UpdateTicketService_1[_0x11cf66(0x1c5)])({'ticketData':{'status':_0x11cf66(0x1af)},'ticketId':_0x2f6e3c['id'],'companyId':_0x2f6e3c['companyId']});}let _0x5f5ad8=await Whatsapp_1[_0x11cf66(0x1c5)][_0x11cf66(0x1b9)](_0x5e004f);_0x5f5ad8[_0x11cf66(0x1ca)]({'statusImportMessages':null});const _0x394abd=(0x0,socket_1[_0x11cf66(0x1bd)])();_0x394abd['to'](_0x11cf66(0x1e5)+_0x5f5ad8[_0x11cf66(0x1d2)]+_0x11cf66(0x1c7))[_0x11cf66(0x1bb)](_0x11cf66(0x1c8)+_0x5f5ad8['companyId'],{'action':_0x11cf66(0x1ac)});};exports['closeImportedTickets']=closeImportedTickets;function compareMessageTimestamps(_0x345439,_0x571343){const _0x12b20c=a566_0x211d14;return _0x345439[_0x12b20c(0x1d6)]-_0x571343[_0x12b20c(0x1d6)];}function removeDuplicateById(_0x3be264){const _0x5b0db2=a566_0x211d14,_0x493c68=new Map(),_0x15b097=[];for(const _0x252848 of _0x3be264){const _0x801fba=_0x252848[_0x5b0db2(0x1ba)]['id'];!_0x493c68[_0x5b0db2(0x1db)](_0x801fba)&&(_0x493c68[_0x5b0db2(0x1b1)](_0x801fba,!![]),_0x15b097[_0x5b0db2(0x1b3)](_0x252848));}return _0x15b097['sort'](compareMessageTimestamps);}const ImportWhatsAppService=async _0x3c14ec=>{const _0xe32945=a566_0x211d14,_0x6793ce=(0x0,wbot_1[_0xe32945(0x1e2)])(_0x3c14ec['id']);try{const _0x9c0d72=(0x0,socket_1[_0xe32945(0x1bd)])(),_0x58cccb=removeDuplicateById(wbot_1[_0xe32945(0x1c2)][_0x3c14ec['id']]);console[_0xe32945(0x1da)](_0xe32945(0x1dc));const _0x539cfc=_0x58cccb[_0xe32945(0x1d5)];let _0x420977=0x0;while(_0x420977<_0x539cfc){try{const _0x569ffa=_0x58cccb[_0x420977];await(0x0,wbotMessageListener_1[_0xe32945(0x1de)])(_0x569ffa,_0x6793ce,_0x3c14ec[_0xe32945(0x1d2)],!![]);if(_0x420977%0x2===0x0){const _0x14aa64=Math[_0xe32945(0x1dd)](_0x569ffa[_0xe32945(0x1d6)][_0xe32945(0x1b5)]*0x3e8);_0x9c0d72['emit']('importMessages-'+_0x3c14ec[_0xe32945(0x1d2)],{'action':'update','status':{'this':_0x420977+0x1,'all':_0x539cfc,'date':(0x0,moment_1[_0xe32945(0x1c5)])(_0x14aa64)['format'](_0xe32945(0x1b2))}});}_0x420977+0x1===_0x539cfc&&(wbot_1['dataMessages'][_0x3c14ec['id']]=[],_0x3c14ec[_0xe32945(0x1d3)]&&await(0x0,exports[_0xe32945(0x1d9)])(_0x3c14ec['id']),await _0x3c14ec[_0xe32945(0x1ca)]({'statusImportMessages':_0x3c14ec[_0xe32945(0x1d3)]?null:_0xe32945(0x1d8),'importOldMessages':null,'importRecentMessages':null}),_0x9c0d72['to']('company-'+_0x3c14ec[_0xe32945(0x1d2)]+'-mainchannel')[_0xe32945(0x1bb)](_0xe32945(0x1c8)+_0x3c14ec[_0xe32945(0x1d2)],{'action':_0xe32945(0x1ac)}));}catch(_0x4013de){console['log'](_0x4013de),console[_0xe32945(0x1da)](_0xe32945(0x1b8));}_0x420977++;}}catch(_0x28de3b){console[_0xe32945(0x1da)](_0x28de3b);throw new AppError_1[(_0xe32945(0x1c5))](_0xe32945(0x1c0),0x193);}return _0xe32945(0x1df);};exports['default']=ImportWhatsAppService;