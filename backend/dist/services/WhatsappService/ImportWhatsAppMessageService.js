const a565_0x359027=a565_0x2d0d;function a565_0x5d83(){const _0x164606=['-mainchannel','2025408VnhgBP','closedTicketsPostImported','floor','__importDefault','low','key','defineProperty','__esModule','ERR_NOT_MESSAGE_TO_IMPORT','sort','default','623xHpLUJ','ERROR_IMPORTING_MESSAGE','set','447lOYUdG','processImportMessagesWppId','date-fns','messageTimestamp','../../models/Whatsapp','moment','constructor','DD/MM/YY\x20HH:mm:ss','../WbotServices/wbotMessageListener','companyId','importMessages-','getIO','716mHuOzO','company-','format','../../libs/socket','17227550lThHuc','renderButtonCloseTickets','update','log','../../libs/wbot','has','search','toString','refresh','closeImportedTickets','../../errors/AppError','8728lmMqdR','whatsapps','(((.+)+)+)+$','push','3768QvqWQe','1283ApodBc','../../models/Ticket','dataMessages','pending','9013410QQLpgB','closed','handleMessage','emit','4674560NVWDCG','length'];a565_0x5d83=function(){return _0x164606;};return a565_0x5d83();}(function(_0x1f4244,_0x49b8ba){const _0x3fa64d=a565_0x2d0d,_0x24166e=_0x1f4244();while(!![]){try{const _0x10d54b=-parseInt(_0x3fa64d(0x89))/0x1*(-parseInt(_0x3fa64d(0xae))/0x2)+parseInt(_0x3fa64d(0xa2))/0x3*(-parseInt(_0x3fa64d(0x88))/0x4)+-parseInt(_0x3fa64d(0x91))/0x5+parseInt(_0x3fa64d(0x94))/0x6+parseInt(_0x3fa64d(0x9f))/0x7*(parseInt(_0x3fa64d(0xbd))/0x8)+-parseInt(_0x3fa64d(0x8d))/0x9+parseInt(_0x3fa64d(0xb2))/0xa;if(_0x10d54b===_0x49b8ba)break;else _0x24166e['push'](_0x24166e['shift']());}catch(_0x34bba8){_0x24166e['push'](_0x24166e['shift']());}}}(a565_0x5d83,0x83d48));const a565_0x361821=(function(){let _0x1a76ce=!![];return function(_0x298d34,_0x1d1039){const _0x13a17d=_0x1a76ce?function(){if(_0x1d1039){const _0x2d8dc4=_0x1d1039['apply'](_0x298d34,arguments);return _0x1d1039=null,_0x2d8dc4;}}:function(){};return _0x1a76ce=![],_0x13a17d;};}()),a565_0x2df548=a565_0x361821(this,function(){const _0x5dd870=a565_0x2d0d;return a565_0x2df548[_0x5dd870(0xb9)]()['search'](_0x5dd870(0xbf))['toString']()[_0x5dd870(0xa8)](a565_0x2df548)[_0x5dd870(0xb8)](_0x5dd870(0xbf));});a565_0x2df548();'use strict';var __importDefault=this&&this[a565_0x359027(0x97)]||function(_0x53a084){return _0x53a084&&_0x53a084['__esModule']?_0x53a084:{'default':_0x53a084};};Object[a565_0x359027(0x9a)](exports,a565_0x359027(0x9b),{'value':!![]}),exports['closeImportedTickets']=void 0x0;const AppError_1=__importDefault(require(a565_0x359027(0xbc))),Whatsapp_1=__importDefault(require(a565_0x359027(0xa6))),Ticket_1=__importDefault(require(a565_0x359027(0x8a))),UpdateTicketService_1=__importDefault(require('../TicketServices/UpdateTicketService')),wbot_1=require(a565_0x359027(0xb6)),socket_1=require(a565_0x359027(0xb1)),wbotMessageListener_1=require(a565_0x359027(0xaa)),moment_1=__importDefault(require(a565_0x359027(0xa7))),sequelize_1=require('sequelize'),date_fns_1=require(a565_0x359027(0xa4)),closeImportedTickets=async _0x3e8408=>{const _0x294c07=a565_0x359027;console[_0x294c07(0xb5)](_0x294c07(0xbb));const _0x49370c=await Ticket_1['default']['findAll']({'where':{'status':_0x294c07(0x8c),'whatsappId':_0x3e8408,'imported':{[sequelize_1['Op']['lt']]:(0x0,date_fns_1['add'])(new Date(),{'hours':0x5})}}});for(const _0x3cde1c of _0x49370c){await new Promise(_0xcbaf0f=>setTimeout(_0xcbaf0f,0x14a)),await(0x0,UpdateTicketService_1['default'])({'ticketData':{'status':_0x294c07(0x8e)},'ticketId':_0x3cde1c['id'],'companyId':_0x3cde1c[_0x294c07(0xab)]});}let _0x18b031=await Whatsapp_1[_0x294c07(0x9e)]['findByPk'](_0x3e8408);_0x18b031[_0x294c07(0xb4)]({'statusImportMessages':null});const _0x17d2d0=(0x0,socket_1['getIO'])();_0x17d2d0['to'](_0x294c07(0xaf)+_0x18b031[_0x294c07(0xab)]+_0x294c07(0x93))[_0x294c07(0x90)](_0x294c07(0xac)+_0x18b031[_0x294c07(0xab)],{'action':_0x294c07(0xba)});};exports[a565_0x359027(0xbb)]=closeImportedTickets;function compareMessageTimestamps(_0x4af630,_0x210e52){const _0x519e85=a565_0x359027;return _0x4af630['messageTimestamp']-_0x210e52[_0x519e85(0xa5)];}function removeDuplicateById(_0x5b4eba){const _0x4abe12=a565_0x359027,_0x586b33=new Map(),_0x6c6348=[];for(const _0x3455c4 of _0x5b4eba){const _0x4b1593=_0x3455c4[_0x4abe12(0x99)]['id'];!_0x586b33[_0x4abe12(0xb7)](_0x4b1593)&&(_0x586b33[_0x4abe12(0xa1)](_0x4b1593,!![]),_0x6c6348[_0x4abe12(0x87)](_0x3455c4));}return _0x6c6348[_0x4abe12(0x9d)](compareMessageTimestamps);}function a565_0x2d0d(_0x1db722,_0x57eb93){const _0x34a525=a565_0x5d83();return a565_0x2d0d=function(_0x2df548,_0x361821){_0x2df548=_0x2df548-0x87;let _0x5d8388=_0x34a525[_0x2df548];return _0x5d8388;},a565_0x2d0d(_0x1db722,_0x57eb93);}const ImportWhatsAppService=async _0x102afa=>{const _0x3cfdc6=a565_0x359027,_0x10442f=(0x0,wbot_1['getWbot'])(_0x102afa['id']);try{const _0x1accac=(0x0,socket_1[_0x3cfdc6(0xad)])(),_0x39b083=removeDuplicateById(wbot_1[_0x3cfdc6(0x8b)][_0x102afa['id']]);console[_0x3cfdc6(0xb5)](_0x3cfdc6(0xa3));const _0x50fe83=_0x39b083[_0x3cfdc6(0x92)];let _0x27b75f=0x0;while(_0x27b75f<_0x50fe83){try{const _0x4baced=_0x39b083[_0x27b75f];await(0x0,wbotMessageListener_1[_0x3cfdc6(0x8f)])(_0x4baced,_0x10442f,_0x102afa['companyId'],!![]);if(_0x27b75f%0x2===0x0){const _0x571f87=Math[_0x3cfdc6(0x96)](_0x4baced[_0x3cfdc6(0xa5)][_0x3cfdc6(0x98)]*0x3e8);_0x1accac[_0x3cfdc6(0x90)](_0x3cfdc6(0xac)+_0x102afa[_0x3cfdc6(0xab)],{'action':_0x3cfdc6(0xb4),'status':{'this':_0x27b75f+0x1,'all':_0x50fe83,'date':(0x0,moment_1[_0x3cfdc6(0x9e)])(_0x571f87)[_0x3cfdc6(0xb0)](_0x3cfdc6(0xa9))}});}_0x27b75f+0x1===_0x50fe83&&(wbot_1[_0x3cfdc6(0x8b)][_0x102afa['id']]=[],_0x102afa[_0x3cfdc6(0x95)]&&await(0x0,exports['closeImportedTickets'])(_0x102afa['id']),await _0x102afa[_0x3cfdc6(0xb4)]({'statusImportMessages':_0x102afa['closedTicketsPostImported']?null:_0x3cfdc6(0xb3),'importOldMessages':null,'importRecentMessages':null}),_0x1accac['to'](_0x3cfdc6(0xaf)+_0x102afa['companyId']+'-mainchannel')[_0x3cfdc6(0x90)](_0x3cfdc6(0xac)+_0x102afa['companyId'],{'action':'refresh'}));}catch(_0x32e9b2){console['log'](_0x32e9b2),console[_0x3cfdc6(0xb5)](_0x3cfdc6(0xa0));}_0x27b75f++;}}catch(_0x531745){console[_0x3cfdc6(0xb5)](_0x531745);throw new AppError_1['default'](_0x3cfdc6(0x9c),0x193);}return _0x3cfdc6(0xbe);};exports[a565_0x359027(0x9e)]=ImportWhatsAppService;