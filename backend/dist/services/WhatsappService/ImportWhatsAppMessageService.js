const a564_0x3e997b=a564_0x1d10;(function(_0x36b4d7,_0x2dedf7){const _0x4fb26c=a564_0x1d10,_0x34154a=_0x36b4d7();while(!![]){try{const _0x1d56ce=parseInt(_0x4fb26c(0xc4))/0x1+-parseInt(_0x4fb26c(0xf1))/0x2*(parseInt(_0x4fb26c(0xd5))/0x3)+parseInt(_0x4fb26c(0xdd))/0x4*(-parseInt(_0x4fb26c(0xeb))/0x5)+parseInt(_0x4fb26c(0xea))/0x6+parseInt(_0x4fb26c(0xc5))/0x7*(-parseInt(_0x4fb26c(0xf3))/0x8)+-parseInt(_0x4fb26c(0xe9))/0x9+-parseInt(_0x4fb26c(0xe2))/0xa*(-parseInt(_0x4fb26c(0xc2))/0xb);if(_0x1d56ce===_0x2dedf7)break;else _0x34154a['push'](_0x34154a['shift']());}catch(_0x4e91f1){_0x34154a['push'](_0x34154a['shift']());}}}(a564_0x40d7,0xb160c));const a564_0x3d279d=(function(){let _0x4d8b96=!![];return function(_0x310657,_0x266b79){const _0x54f8bc=_0x4d8b96?function(){if(_0x266b79){const _0x2abb8d=_0x266b79['apply'](_0x310657,arguments);return _0x266b79=null,_0x2abb8d;}}:function(){};return _0x4d8b96=![],_0x54f8bc;};}()),a564_0x55d2d4=a564_0x3d279d(this,function(){const _0x49a109=a564_0x1d10;return a564_0x55d2d4['toString']()[_0x49a109(0xdc)](_0x49a109(0xd7))[_0x49a109(0xf2)]()['constructor'](a564_0x55d2d4)[_0x49a109(0xdc)](_0x49a109(0xd7));});a564_0x55d2d4();function a564_0x40d7(){const _0x54f39b=['207124fZeAgT','toString','1682696Hvhvil','dataMessages','add','../../models/Ticket','DD/MM/YY\x20HH:mm:ss','6852010aKmSjq','defineProperty','956590hWadWk','21Tmcitk','refresh','key','getIO','sort','findAll','sequelize','importMessages-','pending','push','company-','findByPk','default','../../models/Whatsapp','../WbotServices/wbotMessageListener','emit','36fvHYfo','has','(((.+)+)+)+$','update','log','__importDefault','companyId','search','4NopZOt','low','../../libs/wbot','-mainchannel','closeImportedTickets','20aVcuwd','closed','whatsapps','moment','format','date-fns','messageTimestamp','1945080hPwfGb','6205548svHbqi','2101265xPmKfZ','renderButtonCloseTickets','handleMessage','closedTicketsPostImported','set','length'];a564_0x40d7=function(){return _0x54f39b;};return a564_0x40d7();}'use strict';var __importDefault=this&&this[a564_0x3e997b(0xda)]||function(_0x29d0de){return _0x29d0de&&_0x29d0de['__esModule']?_0x29d0de:{'default':_0x29d0de};};Object[a564_0x3e997b(0xc3)](exports,'__esModule',{'value':!![]}),exports['closeImportedTickets']=void 0x0;function a564_0x1d10(_0x2f9d5f,_0x29aa13){const _0x5bf9bb=a564_0x40d7();return a564_0x1d10=function(_0x55d2d4,_0x3d279d){_0x55d2d4=_0x55d2d4-0xc1;let _0x40d753=_0x5bf9bb[_0x55d2d4];return _0x40d753;},a564_0x1d10(_0x2f9d5f,_0x29aa13);}const AppError_1=__importDefault(require('../../errors/AppError')),Whatsapp_1=__importDefault(require(a564_0x3e997b(0xd2))),Ticket_1=__importDefault(require(a564_0x3e997b(0xf6))),UpdateTicketService_1=__importDefault(require('../TicketServices/UpdateTicketService')),wbot_1=require(a564_0x3e997b(0xdf)),socket_1=require('../../libs/socket'),wbotMessageListener_1=require(a564_0x3e997b(0xd3)),moment_1=__importDefault(require(a564_0x3e997b(0xe5))),sequelize_1=require(a564_0x3e997b(0xcb)),date_fns_1=require(a564_0x3e997b(0xe7)),closeImportedTickets=async _0x462f03=>{const _0x45a0ca=a564_0x3e997b;console[_0x45a0ca(0xd9)](_0x45a0ca(0xe1));const _0x54cf3c=await Ticket_1['default'][_0x45a0ca(0xca)]({'where':{'status':_0x45a0ca(0xcd),'whatsappId':_0x462f03,'imported':{[sequelize_1['Op']['lt']]:(0x0,date_fns_1[_0x45a0ca(0xf5)])(new Date(),{'hours':0x5})}}});for(const _0x7c683f of _0x54cf3c){await new Promise(_0x4b3064=>setTimeout(_0x4b3064,0x14a)),await(0x0,UpdateTicketService_1[_0x45a0ca(0xd1)])({'ticketData':{'status':_0x45a0ca(0xe3)},'ticketId':_0x7c683f['id'],'companyId':_0x7c683f[_0x45a0ca(0xdb)]});}let _0x497099=await Whatsapp_1[_0x45a0ca(0xd1)][_0x45a0ca(0xd0)](_0x462f03);_0x497099['update']({'statusImportMessages':null});const _0x38f4ce=(0x0,socket_1[_0x45a0ca(0xc8)])();_0x38f4ce['to'](_0x45a0ca(0xcf)+_0x497099[_0x45a0ca(0xdb)]+_0x45a0ca(0xe0))[_0x45a0ca(0xd4)]('importMessages-'+_0x497099[_0x45a0ca(0xdb)],{'action':_0x45a0ca(0xc6)});};exports[a564_0x3e997b(0xe1)]=closeImportedTickets;function compareMessageTimestamps(_0x3fda1a,_0x3853f7){const _0x213c2b=a564_0x3e997b;return _0x3fda1a[_0x213c2b(0xe8)]-_0x3853f7[_0x213c2b(0xe8)];}function removeDuplicateById(_0x148ff1){const _0x4c0e7e=a564_0x3e997b,_0x55b1f5=new Map(),_0x55de51=[];for(const _0xb296fd of _0x148ff1){const _0x5d1570=_0xb296fd[_0x4c0e7e(0xc7)]['id'];!_0x55b1f5[_0x4c0e7e(0xd6)](_0x5d1570)&&(_0x55b1f5[_0x4c0e7e(0xef)](_0x5d1570,!![]),_0x55de51[_0x4c0e7e(0xce)](_0xb296fd));}return _0x55de51[_0x4c0e7e(0xc9)](compareMessageTimestamps);}const ImportWhatsAppService=async _0x422500=>{const _0x5ec949=a564_0x3e997b,_0x1e1e9e=(0x0,wbot_1['getWbot'])(_0x422500['id']);try{const _0x3cc35c=(0x0,socket_1[_0x5ec949(0xc8)])(),_0x1a86e1=removeDuplicateById(wbot_1[_0x5ec949(0xf4)][_0x422500['id']]);console[_0x5ec949(0xd9)]('processImportMessagesWppId');const _0x55ba31=_0x1a86e1[_0x5ec949(0xf0)];let _0x40b237=0x0;while(_0x40b237<_0x55ba31){try{const _0x273295=_0x1a86e1[_0x40b237];await(0x0,wbotMessageListener_1[_0x5ec949(0xed)])(_0x273295,_0x1e1e9e,_0x422500['companyId'],!![]);if(_0x40b237%0x2===0x0){const _0x17dfdf=Math['floor'](_0x273295[_0x5ec949(0xe8)][_0x5ec949(0xde)]*0x3e8);_0x3cc35c[_0x5ec949(0xd4)](_0x5ec949(0xcc)+_0x422500[_0x5ec949(0xdb)],{'action':'update','status':{'this':_0x40b237+0x1,'all':_0x55ba31,'date':(0x0,moment_1[_0x5ec949(0xd1)])(_0x17dfdf)[_0x5ec949(0xe6)](_0x5ec949(0xc1))}});}_0x40b237+0x1===_0x55ba31&&(wbot_1['dataMessages'][_0x422500['id']]=[],_0x422500[_0x5ec949(0xee)]&&await(0x0,exports[_0x5ec949(0xe1)])(_0x422500['id']),await _0x422500[_0x5ec949(0xd8)]({'statusImportMessages':_0x422500[_0x5ec949(0xee)]?null:_0x5ec949(0xec),'importOldMessages':null,'importRecentMessages':null}),_0x3cc35c['to'](_0x5ec949(0xcf)+_0x422500['companyId']+'-mainchannel')[_0x5ec949(0xd4)](_0x5ec949(0xcc)+_0x422500['companyId'],{'action':'refresh'}));}catch(_0x3f7895){console['log'](_0x3f7895),console[_0x5ec949(0xd9)]('ERROR_IMPORTING_MESSAGE');}_0x40b237++;}}catch(_0x5c2462){console['log'](_0x5c2462);throw new AppError_1[(_0x5ec949(0xd1))]('ERR_NOT_MESSAGE_TO_IMPORT',0x193);}return _0x5ec949(0xe4);};exports[a564_0x3e997b(0xd1)]=ImportWhatsAppService;