'use strict';const a587_0x37e0a0=a587_0x5848;(function(_0x52f128,_0x396bfc){const _0x50c218=a587_0x5848,_0x2a1c0c=_0x52f128();while(!![]){try{const _0x1d9389=parseInt(_0x50c218(0x1de))/0x1*(parseInt(_0x50c218(0x1d8))/0x2)+parseInt(_0x50c218(0x1c4))/0x3*(-parseInt(_0x50c218(0x1d1))/0x4)+parseInt(_0x50c218(0x1b5))/0x5*(parseInt(_0x50c218(0x1c9))/0x6)+parseInt(_0x50c218(0x1e6))/0x7*(parseInt(_0x50c218(0x1c5))/0x8)+parseInt(_0x50c218(0x1c2))/0x9*(-parseInt(_0x50c218(0x1e5))/0xa)+-parseInt(_0x50c218(0x1d5))/0xb+-parseInt(_0x50c218(0x1d4))/0xc*(-parseInt(_0x50c218(0x1eb))/0xd);if(_0x1d9389===_0x396bfc)break;else _0x2a1c0c['push'](_0x2a1c0c['shift']());}catch(_0x3419f5){_0x2a1c0c['push'](_0x2a1c0c['shift']());}}}(a587_0x3dcb,0xc2ff2));function a587_0x3dcb(){const _0x586f6e=['configurable','count','prototype','../../models/Plan','83aKOcUJ','../../models/Company','required','get','shape','whatsapp','toString','10tmaihp','248591AecnFH','__importDefault','validate','__esModule','update','13GrlcwT','__importStar','346435VdwZqO','search','__setModuleDefault','apply','(((.+)+)+)+$','object','beta','default','../../errors/AppError','ERR_WAPP_GREETING_REQUIRED','Número\x20máximo\x20de\x20conexões\x20já\x20alcançado:\x20','getOwnPropertyDescriptor','writable','3027195TWHLJt','This\x20whatsapp\x20token\x20is\x20already\x20used.','80994QOgbjD','272RBzMkI','./AssociateWhatsappQueue','create','test','42jTWXvx','defineProperty','findOne','message','min','string','boolean','call','124ttWEiv','length','__createBinding','3663708pEQEuP','12317624mhzCkx','getOwnPropertyNames','hasOwnProperty','26362CgAhru','plan'];a587_0x3dcb=function(){return _0x586f6e;};return a587_0x3dcb();}function a587_0x5848(_0x11a974,_0x11f03c){const _0x386d2c=a587_0x3dcb();return a587_0x5848=function(_0x34a3a2,_0x38a6d3){_0x34a3a2=_0x34a3a2-0x1b5;let _0x3dcb33=_0x386d2c[_0x34a3a2];return _0x3dcb33;},a587_0x5848(_0x11a974,_0x11f03c);}var __createBinding=this&&this[a587_0x37e0a0(0x1d3)]||(Object[a587_0x37e0a0(0x1c7)]?function(_0x1e185b,_0xdc64fa,_0x3c2b8d,_0x2cd977){const _0x2311d6=a587_0x37e0a0;if(_0x2cd977===undefined)_0x2cd977=_0x3c2b8d;var _0x5e43eb=Object[_0x2311d6(0x1c0)](_0xdc64fa,_0x3c2b8d);(!_0x5e43eb||(_0x2311d6(0x1e1)in _0x5e43eb?!_0xdc64fa[_0x2311d6(0x1e9)]:_0x5e43eb[_0x2311d6(0x1c1)]||_0x5e43eb[_0x2311d6(0x1da)]))&&(_0x5e43eb={'enumerable':!![],'get':function(){return _0xdc64fa[_0x3c2b8d];}}),Object[_0x2311d6(0x1ca)](_0x1e185b,_0x2cd977,_0x5e43eb);}:function(_0x392b88,_0x37b714,_0x4a2bb7,_0x4c1acb){if(_0x4c1acb===undefined)_0x4c1acb=_0x4a2bb7;_0x392b88[_0x4c1acb]=_0x37b714[_0x4a2bb7];}),__setModuleDefault=this&&this[a587_0x37e0a0(0x1b7)]||(Object[a587_0x37e0a0(0x1c7)]?function(_0x888588,_0x512b65){const _0x4393d6=a587_0x37e0a0;Object[_0x4393d6(0x1ca)](_0x888588,'default',{'enumerable':!![],'value':_0x512b65});}:function(_0x52d85e,_0x55d3f7){const _0x116744=a587_0x37e0a0;_0x52d85e[_0x116744(0x1bc)]=_0x55d3f7;}),__importStar=this&&this[a587_0x37e0a0(0x1ec)]||(function(){const _0xbab6c6=(function(){let _0x436939=!![];return function(_0x35adce,_0x202f22){const _0x446107=_0x436939?function(){const _0x5ee2ff=a587_0x5848;if(_0x202f22){const _0x581673=_0x202f22[_0x5ee2ff(0x1b8)](_0x35adce,arguments);return _0x202f22=null,_0x581673;}}:function(){};return _0x436939=![],_0x446107;};}()),_0x2654a2=_0xbab6c6(this,function(){const _0xb3920a=a587_0x5848;return _0x2654a2[_0xb3920a(0x1e4)]()[_0xb3920a(0x1b6)](_0xb3920a(0x1b9))[_0xb3920a(0x1e4)]()['constructor'](_0x2654a2)[_0xb3920a(0x1b6)](_0xb3920a(0x1b9));});_0x2654a2();var _0x490e0f=function(_0x267f52){const _0x48f416=a587_0x5848;return _0x490e0f=Object[_0x48f416(0x1d6)]||function(_0x1df06e){const _0x9fefc0=_0x48f416;var _0x264594=[];for(var _0x1de51f in _0x1df06e)if(Object[_0x9fefc0(0x1dc)][_0x9fefc0(0x1d7)][_0x9fefc0(0x1d0)](_0x1df06e,_0x1de51f))_0x264594[_0x264594['length']]=_0x1de51f;return _0x264594;},_0x490e0f(_0x267f52);};return function(_0x4c65f9){const _0xca3135=a587_0x5848;if(_0x4c65f9&&_0x4c65f9[_0xca3135(0x1e9)])return _0x4c65f9;var _0x28b6c1={};if(_0x4c65f9!=null){for(var _0x263cd3=_0x490e0f(_0x4c65f9),_0x11df6b=0x0;_0x11df6b<_0x263cd3[_0xca3135(0x1d2)];_0x11df6b++)if(_0x263cd3[_0x11df6b]!==_0xca3135(0x1bc))__createBinding(_0x28b6c1,_0x4c65f9,_0x263cd3[_0x11df6b]);}return __setModuleDefault(_0x28b6c1,_0x4c65f9),_0x28b6c1;};}()),__importDefault=this&&this[a587_0x37e0a0(0x1e7)]||function(_0x45178e){return _0x45178e&&_0x45178e['__esModule']?_0x45178e:{'default':_0x45178e};};Object[a587_0x37e0a0(0x1ca)](exports,a587_0x37e0a0(0x1e9),{'value':!![]});const Yup=__importStar(require('yup')),AppError_1=__importDefault(require(a587_0x37e0a0(0x1bd))),Whatsapp_1=__importDefault(require('../../models/Whatsapp')),Company_1=__importDefault(require(a587_0x37e0a0(0x1df))),Plan_1=__importDefault(require(a587_0x37e0a0(0x1dd))),AssociateWhatsappQueue_1=__importDefault(require(a587_0x37e0a0(0x1c6))),CreateWhatsAppService=async({name:_0x3a7ddb,status:status='OPENING',queueIds:queueIds=[],greetingMessage:_0x1bc781,complationMessage:_0x142035,outOfHoursMessage:_0x38807f,useRating:_0x2b2219,ratingMessage:_0x5970b2,transferMessage:_0x1fff25,isDefault:isDefault=![],companyId:_0x5cd34e,token:token='',provider:provider=a587_0x37e0a0(0x1bb),facebookUserId:_0xe95a5e,facebookUserToken:_0x29fd6e,facebookPageUserId:_0xf1b940,tokenMeta:_0x41c418,channel:channel=a587_0x37e0a0(0x1e3),integrationId:_0x57a769,maxUseBotQueues:maxUseBotQueues=0x3,sendIdQueue:_0x207c0d,timeSendQueue:_0x2cfbad,expiresTicket:expiresTicket=0x0,expiresInactiveMessage:expiresInactiveMessage='',allowGroup:allowGroup=![],importOldMessages:_0x2cff98,schedules:schedules=[],whenExpireTicket:_0x53ddd6,inactiveMessageTime:_0x4a695d,inactiveMessage:_0x590cf7,automaticRestart:_0x4ba343,period:_0x27e64d,lastRestartAt:_0x355fb3})=>{const _0x3d6f82=a587_0x37e0a0,_0x5485e4=await Company_1[_0x3d6f82(0x1bc)][_0x3d6f82(0x1cb)]({'where':{'id':_0x5cd34e},'include':[{'model':Plan_1[_0x3d6f82(0x1bc)],'as':_0x3d6f82(0x1d9)}]});if(_0x5485e4){const _0x143ba7=await Whatsapp_1[_0x3d6f82(0x1bc)][_0x3d6f82(0x1db)]({'where':{'companyId':_0x5cd34e,'channel':channel}});if(_0x143ba7>=_0x5485e4[_0x3d6f82(0x1d9)]['connections'])throw new AppError_1['default'](_0x3d6f82(0x1bf)+_0x143ba7);}const _0x16cbc7=Yup[_0x3d6f82(0x1ba)]()[_0x3d6f82(0x1e2)]({'name':Yup[_0x3d6f82(0x1ce)]()[_0x3d6f82(0x1e0)]()[_0x3d6f82(0x1cd)](0x2)[_0x3d6f82(0x1c8)]('Check-name','Esse\x20nome\x20já\x20está\x20sendo\x20utilizado\x20por\x20outra\x20conexão',async _0x2d4933=>{const _0x3b5349=_0x3d6f82;if(!_0x2d4933)return![];const _0x43ddbd=await Whatsapp_1['default'][_0x3b5349(0x1cb)]({'where':{'name':_0x2d4933,'companyId':_0x5cd34e}});return!_0x43ddbd;}),'isDefault':Yup[_0x3d6f82(0x1cf)]()[_0x3d6f82(0x1e0)]()});try{await _0x16cbc7[_0x3d6f82(0x1e8)]({'name':_0x3a7ddb,'status':status,'isDefault':isDefault});}catch(_0x314c45){throw new AppError_1['default'](_0x314c45[_0x3d6f82(0x1cc)]);}const _0x4d8dff=await Whatsapp_1[_0x3d6f82(0x1bc)][_0x3d6f82(0x1cb)]({'where':{'companyId':_0x5cd34e}});isDefault=channel==='whatsapp'?!_0x4d8dff:![];let _0x220940=null;channel===_0x3d6f82(0x1e3)&&isDefault&&(_0x220940=await Whatsapp_1[_0x3d6f82(0x1bc)][_0x3d6f82(0x1cb)]({'where':{'isDefault':!![],'companyId':_0x5cd34e,'channel':channel}}),_0x220940&&await _0x220940[_0x3d6f82(0x1ea)]({'isDefault':![]}));if(queueIds[_0x3d6f82(0x1d2)]>0x1&&!_0x1bc781)throw new AppError_1[(_0x3d6f82(0x1bc))](_0x3d6f82(0x1be));if(token){const _0x682702=Yup['object']()[_0x3d6f82(0x1e2)]({'token':Yup[_0x3d6f82(0x1ce)]()['required']()[_0x3d6f82(0x1cd)](0x2)[_0x3d6f82(0x1c8)]('Check-token',_0x3d6f82(0x1c3),async _0x3fe0fa=>{const _0x56e239=_0x3d6f82;if(!_0x3fe0fa)return![];const _0x488441=await Whatsapp_1[_0x56e239(0x1bc)][_0x56e239(0x1cb)]({'where':{'token':_0x3fe0fa,'channel':channel}});return!_0x488441;})});try{await _0x682702[_0x3d6f82(0x1e8)]({'token':token});}catch(_0x3d6ec7){throw new AppError_1['default'](_0x3d6ec7[_0x3d6f82(0x1cc)]);}}const _0xae5737=await Whatsapp_1['default']['create']({'name':_0x3a7ddb,'status':status,'greetingMessage':_0x1bc781,'complationMessage':_0x142035,'outOfHoursMessage':_0x38807f,'useRating':_0x2b2219,'ratingMessage':_0x5970b2,'transferMessage':_0x1fff25,'isDefault':isDefault,'companyId':_0x5cd34e,'token':token,'provider':provider,'channel':channel,'facebookUserId':_0xe95a5e,'facebookUserToken':_0x29fd6e,'facebookPageUserId':_0xf1b940,'tokenMeta':_0x41c418,'integrationId':_0x57a769&&_0x57a769>0x0?_0x57a769:null,'maxUseBotQueues':maxUseBotQueues,'sendIdQueue':_0x207c0d,'timeSendQueue':_0x2cfbad,'expiresTicket':expiresTicket,'expiresInactiveMessage':expiresInactiveMessage,'allowGroup':allowGroup,'importOldMessages':_0x2cff98,'schedules':schedules,'whenExpireTicket':_0x53ddd6,'inactiveMessageTime':_0x4a695d,'inactiveMessage':_0x590cf7,'automaticRestart':_0x4ba343,'period':_0x27e64d,'lastRestartAt':_0x355fb3},{'include':['queues']});return await(0x0,AssociateWhatsappQueue_1[_0x3d6f82(0x1bc)])(_0xae5737,queueIds),{'whatsapp':_0xae5737,'oldDefaultWhatsapp':_0x220940};};exports['default']=CreateWhatsAppService;