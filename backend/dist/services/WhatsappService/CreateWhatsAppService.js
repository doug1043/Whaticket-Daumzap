'use strict';const a710_0x526fde=a710_0x19da;(function(_0x4ba1d0,_0x42583b){const _0x371506=a710_0x19da,_0x156ef0=_0x4ba1d0();while(!![]){try{const _0x333c4b=parseInt(_0x371506(0x7f))/0x1+-parseInt(_0x371506(0x93))/0x2+-parseInt(_0x371506(0x83))/0x3*(-parseInt(_0x371506(0x81))/0x4)+parseInt(_0x371506(0x87))/0x5*(parseInt(_0x371506(0x9d))/0x6)+-parseInt(_0x371506(0x90))/0x7*(-parseInt(_0x371506(0x8b))/0x8)+parseInt(_0x371506(0x74))/0x9+parseInt(_0x371506(0x6c))/0xa*(-parseInt(_0x371506(0x78))/0xb);if(_0x333c4b===_0x42583b)break;else _0x156ef0['push'](_0x156ef0['shift']());}catch(_0x5d3b2e){_0x156ef0['push'](_0x156ef0['shift']());}}}(a710_0x7ee6,0x52251));var __createBinding=this&&this[a710_0x526fde(0x94)]||(Object[a710_0x526fde(0x85)]?function(_0xd57a9,_0x74b562,_0x532876,_0x578dbb){const _0x15d3c7=a710_0x526fde;if(_0x578dbb===undefined)_0x578dbb=_0x532876;var _0x46756b=Object['getOwnPropertyDescriptor'](_0x74b562,_0x532876);(!_0x46756b||(_0x15d3c7(0x70)in _0x46756b?!_0x74b562['__esModule']:_0x46756b[_0x15d3c7(0x99)]||_0x46756b[_0x15d3c7(0x9f)]))&&(_0x46756b={'enumerable':!![],'get':function(){return _0x74b562[_0x532876];}}),Object[_0x15d3c7(0x6d)](_0xd57a9,_0x578dbb,_0x46756b);}:function(_0x316824,_0x2863b1,_0x471332,_0x5776c5){if(_0x5776c5===undefined)_0x5776c5=_0x471332;_0x316824[_0x5776c5]=_0x2863b1[_0x471332];}),__setModuleDefault=this&&this[a710_0x526fde(0x92)]||(Object[a710_0x526fde(0x85)]?function(_0x2e2a51,_0x166b89){const _0x3e712d=a710_0x526fde;Object[_0x3e712d(0x6d)](_0x2e2a51,_0x3e712d(0x86),{'enumerable':!![],'value':_0x166b89});}:function(_0x5b4d33,_0x37e14c){_0x5b4d33['default']=_0x37e14c;}),__importStar=this&&this[a710_0x526fde(0x8f)]||(function(){const _0x56cee9=(function(){let _0x2d96ef=!![];return function(_0x4847b3,_0x1c7863){const _0x13d687=_0x2d96ef?function(){const _0x3f6406=a710_0x19da;if(_0x1c7863){const _0x3a05ba=_0x1c7863[_0x3f6406(0x71)](_0x4847b3,arguments);return _0x1c7863=null,_0x3a05ba;}}:function(){};return _0x2d96ef=![],_0x13d687;};}()),_0x438dbd=_0x56cee9(this,function(){const _0x53cf71=a710_0x19da;return _0x438dbd[_0x53cf71(0x9e)]()[_0x53cf71(0x9c)]('(((.+)+)+)+$')['toString']()[_0x53cf71(0x8d)](_0x438dbd)[_0x53cf71(0x9c)](_0x53cf71(0x72));});_0x438dbd();var _0x502b32=function(_0x93a0f0){const _0x1515e6=a710_0x19da;return _0x502b32=Object[_0x1515e6(0x9b)]||function(_0x350b87){const _0x14aa26=_0x1515e6;var _0x407487=[];for(var _0x1181bd in _0x350b87)if(Object['prototype'][_0x14aa26(0x6e)]['call'](_0x350b87,_0x1181bd))_0x407487[_0x407487[_0x14aa26(0x89)]]=_0x1181bd;return _0x407487;},_0x502b32(_0x93a0f0);};return function(_0x55f41f){const _0x49692e=a710_0x19da;if(_0x55f41f&&_0x55f41f[_0x49692e(0x82)])return _0x55f41f;var _0xf4be44={};if(_0x55f41f!=null){for(var _0x1a6312=_0x502b32(_0x55f41f),_0xdc40d0=0x0;_0xdc40d0<_0x1a6312['length'];_0xdc40d0++)if(_0x1a6312[_0xdc40d0]!==_0x49692e(0x86))__createBinding(_0xf4be44,_0x55f41f,_0x1a6312[_0xdc40d0]);}return __setModuleDefault(_0xf4be44,_0x55f41f),_0xf4be44;};}()),__importDefault=this&&this[a710_0x526fde(0x91)]||function(_0x112d7c){const _0xa799b9=a710_0x526fde;return _0x112d7c&&_0x112d7c[_0xa799b9(0x82)]?_0x112d7c:{'default':_0x112d7c};};function a710_0x19da(_0xc82135,_0x572d82){const _0x407016=a710_0x7ee6();return a710_0x19da=function(_0x122a73,_0x514278){_0x122a73=_0x122a73-0x6a;let _0x7ee659=_0x407016[_0x122a73];return _0x7ee659;},a710_0x19da(_0xc82135,_0x572d82);}Object[a710_0x526fde(0x6d)](exports,a710_0x526fde(0x82),{'value':!![]});const Yup=__importStar(require(a710_0x526fde(0x7d))),AppError_1=__importDefault(require(a710_0x526fde(0x7b))),Whatsapp_1=__importDefault(require('../../models/Whatsapp')),Company_1=__importDefault(require(a710_0x526fde(0x77))),Plan_1=__importDefault(require(a710_0x526fde(0x7e))),AssociateWhatsappQueue_1=__importDefault(require('./AssociateWhatsappQueue')),AssociateWhatsappFlow_1=__importDefault(require('./AssociateWhatsappFlow')),CreateWhatsAppService=async({name:_0x1c8288,status:status='OPENING',queueIds:queueIds=[],flowIds:flowIds=[],greetingMessage:_0x16f1d1,greetingAcceptedMessage:_0x3489e7,complationMessage:_0x302ce6,outOfHoursMessage:_0x203923,useRating:_0x1f1130,ratingMessage:_0x2dc709,transferMessage:_0xdac770,sendTransferMessage:_0x30f07e,sendGreetingAccepted:_0x2181b1,sendRejectCall:_0x2dace1,rejectCallMessage:_0xb3082f,isDefault:isDefault=![],companyId:_0x399e70,token:token='',provider:provider='beta',facebookUserId:_0x53261c,facebookUserToken:_0x145409,facebookPageUserId:_0x4636a0,tokenMeta:_0x144c2a,channel:channel=a710_0x526fde(0xa0),integrationId:_0x449698,maxUseBotQueues:maxUseBotQueues=0x3,sendIdQueue:_0x213dc7,timeSendQueue:_0x7ab7c6,expiresTicket:expiresTicket=0x0,expiresInactiveMessage:_0x429640,allowGroup:allowGroup=![],importOldMessages:_0x1a1c85,whenExpireTicket:_0x485bf0,inactiveMessageTime:_0x2edf98,inactiveMessage:_0x21d2d2,automaticRestart:_0x275d88,period:_0x18c290,lastRestartAt:_0x393d58})=>{const _0x50860d=a710_0x526fde,_0x34cef8=await Company_1['default']['findOne']({'where':{'id':_0x399e70},'include':[{'model':Plan_1[_0x50860d(0x86)],'as':_0x50860d(0x9a)}]});if(_0x34cef8){const _0xf51c33=await Whatsapp_1[_0x50860d(0x86)]['count']({'where':{'companyId':_0x399e70,'channel':channel}});if(_0xf51c33>=_0x34cef8[_0x50860d(0x9a)]['connections'])throw new AppError_1[(_0x50860d(0x86))](_0x50860d(0x95)+_0xf51c33);}const _0x3a95a4=Yup[_0x50860d(0x80)]()[_0x50860d(0x6b)]({'name':Yup[_0x50860d(0x98)]()[_0x50860d(0x79)]()[_0x50860d(0x75)](0x2)[_0x50860d(0x7c)](_0x50860d(0x96),_0x50860d(0x76),async _0x3031e9=>{const _0x258306=_0x50860d;if(!_0x3031e9)return![];const _0x234a17=await Whatsapp_1[_0x258306(0x86)][_0x258306(0x8c)]({'where':{'name':_0x3031e9,'companyId':_0x399e70}});return!_0x234a17;}),'isDefault':Yup[_0x50860d(0x7a)]()['required']()});try{await _0x3a95a4['validate']({'name':_0x1c8288,'status':status,'isDefault':isDefault});}catch(_0x4b4c4c){throw new AppError_1[(_0x50860d(0x86))](_0x4b4c4c[_0x50860d(0x84)]);}const _0x40c552=await Whatsapp_1['default'][_0x50860d(0x8c)]({'where':{'companyId':_0x399e70}});isDefault=channel===_0x50860d(0xa0)?!_0x40c552:![];let _0x400bcb=null;channel==='whatsapp'&&isDefault&&(_0x400bcb=await Whatsapp_1[_0x50860d(0x86)][_0x50860d(0x8c)]({'where':{'isDefault':!![],'companyId':_0x399e70,'channel':channel}}),_0x400bcb&&await _0x400bcb[_0x50860d(0x6a)]({'isDefault':![]}));if(queueIds[_0x50860d(0x89)]>0x1&&!_0x16f1d1)throw new AppError_1['default']('ERR_WAPP_GREETING_REQUIRED');if(token){const _0x2b69e6=Yup['object']()[_0x50860d(0x6b)]({'token':Yup[_0x50860d(0x98)]()[_0x50860d(0x79)]()[_0x50860d(0x75)](0x2)['test']('Check-token',_0x50860d(0x88),async _0x1ba183=>{const _0x31a03e=_0x50860d;if(!_0x1ba183)return![];const _0x366a59=await Whatsapp_1[_0x31a03e(0x86)][_0x31a03e(0x8c)]({'where':{'token':_0x1ba183,'channel':channel}});return!_0x366a59;})});try{await _0x2b69e6[_0x50860d(0x73)]({'token':token});}catch(_0x474687){throw new AppError_1['default'](_0x474687['message']);}}const _0x182c9c=parseInt(expiresTicket?.[_0x50860d(0x9e)]()||'0',0xa),_0x380fbf=parseInt(_0x2edf98?.[_0x50860d(0x9e)]()||'0',0xa),_0x513e9e=_0x429640?.[_0x50860d(0x8a)]()||'',_0x27bd94=_0x21d2d2?.[_0x50860d(0x8a)]()||'';if(_0x182c9c>0x0&&!_0x513e9e)throw new AppError_1[(_0x50860d(0x86))]('Defina\x20uma\x20mensagem\x20de\x20encerramento\x20por\x20inatividade\x20ou\x20configure\x20o\x20tempo\x20para\x200');if(_0x513e9e&&_0x182c9c===0x0)throw new AppError_1[(_0x50860d(0x86))](_0x50860d(0x97));if(_0x380fbf>0x0&&!_0x27bd94)throw new AppError_1[(_0x50860d(0x86))](_0x50860d(0x6f));if(_0x27bd94&&_0x380fbf===0x0)throw new AppError_1[(_0x50860d(0x86))](_0x50860d(0x8e));const _0x325274=await Whatsapp_1[_0x50860d(0x86)][_0x50860d(0x85)]({'name':_0x1c8288,'status':status,'greetingMessage':_0x16f1d1,'greetingAcceptedMessage':_0x3489e7,'complationMessage':_0x302ce6,'outOfHoursMessage':_0x203923,'useRating':_0x1f1130,'ratingMessage':_0x2dc709,'transferMessage':_0xdac770,'sendTransferMessage':_0x30f07e,'sendGreetingAccepted':_0x2181b1,'sendRejectCall':_0x2dace1,'rejectCallMessage':_0xb3082f,'isDefault':isDefault,'companyId':_0x399e70,'token':token,'provider':provider,'channel':channel,'facebookUserId':_0x53261c,'facebookUserToken':_0x145409,'facebookPageUserId':_0x4636a0,'tokenMeta':_0x144c2a,'integrationId':_0x449698&&_0x449698>0x0?_0x449698:null,'maxUseBotQueues':maxUseBotQueues,'sendIdQueue':_0x213dc7,'timeSendQueue':_0x7ab7c6,'expiresTicket':expiresTicket,'expiresInactiveMessage':_0x429640,'allowGroup':allowGroup,'importOldMessages':_0x1a1c85,'whenExpireTicket':_0x485bf0,'inactiveMessageTime':_0x2edf98,'inactiveMessage':_0x21d2d2,'automaticRestart':_0x275d88,'period':_0x18c290,'lastRestartAt':_0x393d58},{'include':['queues']});return await(0x0,AssociateWhatsappQueue_1[_0x50860d(0x86)])(_0x325274,queueIds),await(0x0,AssociateWhatsappFlow_1[_0x50860d(0x86)])(_0x325274,flowIds),{'whatsapp':_0x325274,'oldDefaultWhatsapp':_0x400bcb};};function a710_0x7ee6(){const _0x3b9f4a=['writable','plan','getOwnPropertyNames','search','6GtGqFI','toString','configurable','whatsapp','update','shape','700090trrktJ','defineProperty','hasOwnProperty','Defina\x20uma\x20mensagem\x20de\x20aviso\x20de\x20inatividade\x20ou\x20configure\x20o\x20tempo\x20para\x200','get','apply','(((.+)+)+)+$','validate','3516237uNLYMa','min','Esse\x20nome\x20já\x20está\x20sendo\x20utilizado\x20por\x20outra\x20conexão','../../models/Company','154HAiutP','required','boolean','../../errors/AppError','test','yup','../../models/Plan','519524wExuiG','object','1503852YnwDOX','__esModule','3ncnyTK','message','create','default','256460icgAFJ','This\x20whatsapp\x20token\x20is\x20already\x20used.','length','trim','251032eUjzQy','findOne','constructor','Defina\x20um\x20tempo\x20para\x20aviso\x20maior\x20que\x200\x20ou\x20remova\x20a\x20mensagem','__importStar','35UGNJBh','__importDefault','__setModuleDefault','355552wBlnfn','__createBinding','Número\x20máximo\x20de\x20conexões\x20já\x20alcançado:\x20','Check-name','Defina\x20um\x20tempo\x20de\x20encerramento\x20maior\x20que\x200\x20ou\x20remova\x20a\x20mensagem','string'];a710_0x7ee6=function(){return _0x3b9f4a;};return a710_0x7ee6();}exports[a710_0x526fde(0x86)]=CreateWhatsAppService;