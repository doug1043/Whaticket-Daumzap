'use strict';function a591_0x2d98(){const _0x401624=['Check-name','defineProperty','24997vOqQve','findOne','Número\x20máximo\x20de\x20conexões\x20já\x20alcançado:\x20','../../models/Plan','(((.+)+)+)+$','254381hRATNk','344virkLY','shape','3530846Acaxmk','queues','__createBinding','whatsapp','search','plan','3143155mRfdym','create','required','beta','__importDefault','connections','string','prototype','../../errors/AppError','writable','OPENING','297pVFCLf','call','4hgGlFw','421170eYFhMa','get','__importStar','length','getOwnPropertyNames','min','configurable','2838810IZBetN','default','toString','hasOwnProperty','__esModule','count','test','12hlwezI','../../models/Company','apply','message','3577328iSDGHi','update','object','validate'];a591_0x2d98=function(){return _0x401624;};return a591_0x2d98();}const a591_0x252e02=a591_0x3aa3;function a591_0x3aa3(_0x336ca1,_0x5eb577){const _0x4bdccf=a591_0x2d98();return a591_0x3aa3=function(_0x2d8c29,_0x4e0025){_0x2d8c29=_0x2d8c29-0x1f3;let _0x2d9806=_0x4bdccf[_0x2d8c29];return _0x2d9806;},a591_0x3aa3(_0x336ca1,_0x5eb577);}(function(_0x28dd47,_0x4160a4){const _0x3761f9=a591_0x3aa3,_0x5aef4b=_0x28dd47();while(!![]){try{const _0x1b9fd4=-parseInt(_0x3761f9(0x21c))/0x1*(-parseInt(_0x3761f9(0x1fe))/0x2)+-parseInt(_0x3761f9(0x206))/0x3+parseInt(_0x3761f9(0x211))/0x4+parseInt(_0x3761f9(0x225))/0x5*(-parseInt(_0x3761f9(0x20d))/0x6)+-parseInt(_0x3761f9(0x217))/0x7*(parseInt(_0x3761f9(0x21d))/0x8)+parseInt(_0x3761f9(0x1fc))/0x9*(parseInt(_0x3761f9(0x1ff))/0xa)+parseInt(_0x3761f9(0x21f))/0xb;if(_0x1b9fd4===_0x4160a4)break;else _0x5aef4b['push'](_0x5aef4b['shift']());}catch(_0x3ad3a1){_0x5aef4b['push'](_0x5aef4b['shift']());}}}(a591_0x2d98,0xb8c78));var __createBinding=this&&this[a591_0x252e02(0x221)]||(Object['create']?function(_0x3c46d3,_0xf56d4f,_0x44770c,_0x3379bf){const _0x3da8f8=a591_0x252e02;if(_0x3379bf===undefined)_0x3379bf=_0x44770c;var _0x257ef7=Object['getOwnPropertyDescriptor'](_0xf56d4f,_0x44770c);(!_0x257ef7||(_0x3da8f8(0x200)in _0x257ef7?!_0xf56d4f[_0x3da8f8(0x20a)]:_0x257ef7[_0x3da8f8(0x1fa)]||_0x257ef7[_0x3da8f8(0x205)]))&&(_0x257ef7={'enumerable':!![],'get':function(){return _0xf56d4f[_0x44770c];}}),Object[_0x3da8f8(0x216)](_0x3c46d3,_0x3379bf,_0x257ef7);}:function(_0x290712,_0x538e08,_0x57feee,_0x3cf717){if(_0x3cf717===undefined)_0x3cf717=_0x57feee;_0x290712[_0x3cf717]=_0x538e08[_0x57feee];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a591_0x252e02(0x226)]?function(_0x1149eb,_0x5971b7){const _0x575a99=a591_0x252e02;Object['defineProperty'](_0x1149eb,_0x575a99(0x207),{'enumerable':!![],'value':_0x5971b7});}:function(_0x136383,_0x401972){const _0x598741=a591_0x252e02;_0x136383[_0x598741(0x207)]=_0x401972;}),__importStar=this&&this[a591_0x252e02(0x201)]||(function(){const _0x309630=(function(){let _0x2cc366=!![];return function(_0x29b8ca,_0x16f584){const _0x5d266f=_0x2cc366?function(){const _0xb37a00=a591_0x3aa3;if(_0x16f584){const _0x11ff89=_0x16f584[_0xb37a00(0x20f)](_0x29b8ca,arguments);return _0x16f584=null,_0x11ff89;}}:function(){};return _0x2cc366=![],_0x5d266f;};}()),_0x9f7e41=_0x309630(this,function(){const _0x44b386=a591_0x3aa3;return _0x9f7e41[_0x44b386(0x208)]()[_0x44b386(0x223)](_0x44b386(0x21b))['toString']()['constructor'](_0x9f7e41)[_0x44b386(0x223)](_0x44b386(0x21b));});_0x9f7e41();var _0x4a57e7=function(_0x12460e){const _0x2f9530=a591_0x3aa3;return _0x4a57e7=Object[_0x2f9530(0x203)]||function(_0x5ae3de){const _0x97cb1e=_0x2f9530;var _0x400806=[];for(var _0x5bd314 in _0x5ae3de)if(Object[_0x97cb1e(0x1f8)][_0x97cb1e(0x209)][_0x97cb1e(0x1fd)](_0x5ae3de,_0x5bd314))_0x400806[_0x400806['length']]=_0x5bd314;return _0x400806;},_0x4a57e7(_0x12460e);};return function(_0xd4adf1){const _0x1abd84=a591_0x3aa3;if(_0xd4adf1&&_0xd4adf1['__esModule'])return _0xd4adf1;var _0x46d43c={};if(_0xd4adf1!=null){for(var _0x46feb2=_0x4a57e7(_0xd4adf1),_0x1f1818=0x0;_0x1f1818<_0x46feb2['length'];_0x1f1818++)if(_0x46feb2[_0x1f1818]!==_0x1abd84(0x207))__createBinding(_0x46d43c,_0xd4adf1,_0x46feb2[_0x1f1818]);}return __setModuleDefault(_0x46d43c,_0xd4adf1),_0x46d43c;};}()),__importDefault=this&&this[a591_0x252e02(0x1f5)]||function(_0x3187cf){return _0x3187cf&&_0x3187cf['__esModule']?_0x3187cf:{'default':_0x3187cf};};Object[a591_0x252e02(0x216)](exports,a591_0x252e02(0x20a),{'value':!![]});const Yup=__importStar(require('yup')),AppError_1=__importDefault(require(a591_0x252e02(0x1f9))),Whatsapp_1=__importDefault(require('../../models/Whatsapp')),Company_1=__importDefault(require(a591_0x252e02(0x20e))),Plan_1=__importDefault(require(a591_0x252e02(0x21a))),AssociateWhatsappQueue_1=__importDefault(require('./AssociateWhatsappQueue')),CreateWhatsAppService=async({name:_0x54a573,status:status=a591_0x252e02(0x1fb),queueIds:queueIds=[],greetingMessage:_0x1882d3,complationMessage:_0x26b4a8,outOfHoursMessage:_0x3c35ec,useRating:_0x35976b,ratingMessage:_0x3d74af,transferMessage:_0x4ffd38,isDefault:isDefault=![],companyId:_0x9a1eea,token:token='',provider:provider=a591_0x252e02(0x1f4),facebookUserId:_0x3a9546,facebookUserToken:_0x21ea53,facebookPageUserId:_0x40c48f,tokenMeta:_0x356fdb,channel:channel=a591_0x252e02(0x222),integrationId:_0x2d2c5d,maxUseBotQueues:maxUseBotQueues=0x3,sendIdQueue:_0x12e12f,timeSendQueue:_0x48814c,expiresTicket:expiresTicket=0x0,expiresInactiveMessage:expiresInactiveMessage='',allowGroup:allowGroup=![],importOldMessages:_0xefba3,schedules:schedules=[],whenExpireTicket:_0x5c93b3,inactiveMessageTime:_0x44977c,inactiveMessage:_0x1e5a07,automaticRestart:_0x19bfce,period:_0x46a086,lastRestartAt:_0x3baf05})=>{const _0x3e55b3=a591_0x252e02,_0x3d05a7=await Company_1[_0x3e55b3(0x207)][_0x3e55b3(0x218)]({'where':{'id':_0x9a1eea},'include':[{'model':Plan_1[_0x3e55b3(0x207)],'as':_0x3e55b3(0x224)}]});if(_0x3d05a7){const _0x1170bf=await Whatsapp_1[_0x3e55b3(0x207)][_0x3e55b3(0x20b)]({'where':{'companyId':_0x9a1eea,'channel':channel}});if(_0x1170bf>=_0x3d05a7[_0x3e55b3(0x224)][_0x3e55b3(0x1f6)])throw new AppError_1[(_0x3e55b3(0x207))](_0x3e55b3(0x219)+_0x1170bf);}const _0x2ea8f6=Yup[_0x3e55b3(0x213)]()[_0x3e55b3(0x21e)]({'name':Yup[_0x3e55b3(0x1f7)]()['required']()['min'](0x2)[_0x3e55b3(0x20c)](_0x3e55b3(0x215),'Esse\x20nome\x20já\x20está\x20sendo\x20utilizado\x20por\x20outra\x20conexão',async _0x407c30=>{const _0x582bcc=_0x3e55b3;if(!_0x407c30)return![];const _0x1b071e=await Whatsapp_1[_0x582bcc(0x207)][_0x582bcc(0x218)]({'where':{'name':_0x407c30,'companyId':_0x9a1eea}});return!_0x1b071e;}),'isDefault':Yup['boolean']()[_0x3e55b3(0x1f3)]()});try{await _0x2ea8f6[_0x3e55b3(0x214)]({'name':_0x54a573,'status':status,'isDefault':isDefault});}catch(_0x540877){throw new AppError_1[(_0x3e55b3(0x207))](_0x540877[_0x3e55b3(0x210)]);}const _0x541111=await Whatsapp_1[_0x3e55b3(0x207)][_0x3e55b3(0x218)]({'where':{'companyId':_0x9a1eea}});isDefault=channel===_0x3e55b3(0x222)?!_0x541111:![];let _0x5a78ab=null;channel===_0x3e55b3(0x222)&&isDefault&&(_0x5a78ab=await Whatsapp_1[_0x3e55b3(0x207)]['findOne']({'where':{'isDefault':!![],'companyId':_0x9a1eea,'channel':channel}}),_0x5a78ab&&await _0x5a78ab[_0x3e55b3(0x212)]({'isDefault':![]}));if(queueIds[_0x3e55b3(0x202)]>0x1&&!_0x1882d3)throw new AppError_1['default']('ERR_WAPP_GREETING_REQUIRED');if(token){const _0x1a4e35=Yup['object']()[_0x3e55b3(0x21e)]({'token':Yup[_0x3e55b3(0x1f7)]()['required']()[_0x3e55b3(0x204)](0x2)[_0x3e55b3(0x20c)]('Check-token','This\x20whatsapp\x20token\x20is\x20already\x20used.',async _0xa27392=>{const _0x27b7be=_0x3e55b3;if(!_0xa27392)return![];const _0x22ab93=await Whatsapp_1[_0x27b7be(0x207)][_0x27b7be(0x218)]({'where':{'token':_0xa27392,'channel':channel}});return!_0x22ab93;})});try{await _0x1a4e35[_0x3e55b3(0x214)]({'token':token});}catch(_0x283321){throw new AppError_1[(_0x3e55b3(0x207))](_0x283321[_0x3e55b3(0x210)]);}}const _0x968d70=await Whatsapp_1['default'][_0x3e55b3(0x226)]({'name':_0x54a573,'status':status,'greetingMessage':_0x1882d3,'complationMessage':_0x26b4a8,'outOfHoursMessage':_0x3c35ec,'useRating':_0x35976b,'ratingMessage':_0x3d74af,'transferMessage':_0x4ffd38,'isDefault':isDefault,'companyId':_0x9a1eea,'token':token,'provider':provider,'channel':channel,'facebookUserId':_0x3a9546,'facebookUserToken':_0x21ea53,'facebookPageUserId':_0x40c48f,'tokenMeta':_0x356fdb,'integrationId':_0x2d2c5d&&_0x2d2c5d>0x0?_0x2d2c5d:null,'maxUseBotQueues':maxUseBotQueues,'sendIdQueue':_0x12e12f,'timeSendQueue':_0x48814c,'expiresTicket':expiresTicket,'expiresInactiveMessage':expiresInactiveMessage,'allowGroup':allowGroup,'importOldMessages':_0xefba3,'schedules':schedules,'whenExpireTicket':_0x5c93b3,'inactiveMessageTime':_0x44977c,'inactiveMessage':_0x1e5a07,'automaticRestart':_0x19bfce,'period':_0x46a086,'lastRestartAt':_0x3baf05},{'include':[_0x3e55b3(0x220)]});return await(0x0,AssociateWhatsappQueue_1['default'])(_0x968d70,queueIds),{'whatsapp':_0x968d70,'oldDefaultWhatsapp':_0x5a78ab};};exports[a591_0x252e02(0x207)]=CreateWhatsAppService;