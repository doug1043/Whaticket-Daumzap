'use strict';const a590_0x378107=a590_0x2dbc;function a590_0xda59(){const _0x5bdfe7=['__importDefault','6mCqhUZ','beta','shape','required','__setModuleDefault','getOwnPropertyDescriptor','default','4673570wapqBf','__createBinding','OPENING','420780TofIaK','toString','update','min','Check-name','count','18652428RfOyVg','__esModule','424KmBJHL','whatsapp','1230613HcSiBU','3394926rTfzVV','This\x20whatsapp\x20token\x20is\x20already\x20used.','test','configurable','(((.+)+)+)+$','writable','3SpVQln','Número\x20máximo\x20de\x20conexões\x20já\x20alcançado:\x20','yup','object','hasOwnProperty','61229saTGrO','11TZplrh','Check-token','create','findOne','Esse\x20nome\x20já\x20está\x20sendo\x20utilizado\x20por\x20outra\x20conexão','2pLkDPG','length','apply','call','get','ERR_WAPP_GREETING_REQUIRED','../../models/Plan','4002205YCytyy','plan','defineProperty','../../errors/AppError','message','prototype','./AssociateWhatsappQueue','getOwnPropertyNames','search','connections','validate'];a590_0xda59=function(){return _0x5bdfe7;};return a590_0xda59();}(function(_0x3fd120,_0x53d550){const _0x4a65e4=a590_0x2dbc,_0xe7b910=_0x3fd120();while(!![]){try{const _0x34c7a1=parseInt(_0x4a65e4(0x1d6))/0x1*(-parseInt(_0x4a65e4(0x1af))/0x2)+-parseInt(_0x4a65e4(0x1dd))/0x3*(parseInt(_0x4a65e4(0x1cc))/0x4)+-parseInt(_0x4a65e4(0x1b6))/0x5*(-parseInt(_0x4a65e4(0x1c2))/0x6)+-parseInt(_0x4a65e4(0x1e2))/0x7*(-parseInt(_0x4a65e4(0x1d4))/0x8)+-parseInt(_0x4a65e4(0x1d7))/0x9+-parseInt(_0x4a65e4(0x1c9))/0xa*(parseInt(_0x4a65e4(0x1e3))/0xb)+parseInt(_0x4a65e4(0x1d2))/0xc;if(_0x34c7a1===_0x53d550)break;else _0xe7b910['push'](_0xe7b910['shift']());}catch(_0x42dd0c){_0xe7b910['push'](_0xe7b910['shift']());}}}(a590_0xda59,0x9bc46));function a590_0x2dbc(_0x5beee6,_0x3b9280){const _0x3bf471=a590_0xda59();return a590_0x2dbc=function(_0x5e0c46,_0x3ff8f9){_0x5e0c46=_0x5e0c46-0x1ac;let _0xda59ee=_0x3bf471[_0x5e0c46];return _0xda59ee;},a590_0x2dbc(_0x5beee6,_0x3b9280);}var __createBinding=this&&this[a590_0x378107(0x1ca)]||(Object[a590_0x378107(0x1ac)]?function(_0x584cf1,_0x157b59,_0xba8bf6,_0x122dbe){const _0x45d049=a590_0x378107;if(_0x122dbe===undefined)_0x122dbe=_0xba8bf6;var _0x1e0962=Object[_0x45d049(0x1c7)](_0x157b59,_0xba8bf6);(!_0x1e0962||(_0x45d049(0x1b3)in _0x1e0962?!_0x157b59[_0x45d049(0x1d3)]:_0x1e0962[_0x45d049(0x1dc)]||_0x1e0962[_0x45d049(0x1da)]))&&(_0x1e0962={'enumerable':!![],'get':function(){return _0x157b59[_0xba8bf6];}}),Object['defineProperty'](_0x584cf1,_0x122dbe,_0x1e0962);}:function(_0x37b6e3,_0x512f57,_0x3b73d6,_0x2120b0){if(_0x2120b0===undefined)_0x2120b0=_0x3b73d6;_0x37b6e3[_0x2120b0]=_0x512f57[_0x3b73d6];}),__setModuleDefault=this&&this[a590_0x378107(0x1c6)]||(Object[a590_0x378107(0x1ac)]?function(_0x12e1eb,_0x4a0ef9){const _0x418f93=a590_0x378107;Object[_0x418f93(0x1b8)](_0x12e1eb,_0x418f93(0x1c8),{'enumerable':!![],'value':_0x4a0ef9});}:function(_0x279cb1,_0x5d4fa1){const _0x153fa0=a590_0x378107;_0x279cb1[_0x153fa0(0x1c8)]=_0x5d4fa1;}),__importStar=this&&this['__importStar']||(function(){const _0x2d95ee=(function(){let _0x751e35=!![];return function(_0x21a259,_0x355c08){const _0x54db1e=_0x751e35?function(){const _0x3b510f=a590_0x2dbc;if(_0x355c08){const _0x2ab0a4=_0x355c08[_0x3b510f(0x1b1)](_0x21a259,arguments);return _0x355c08=null,_0x2ab0a4;}}:function(){};return _0x751e35=![],_0x54db1e;};}()),_0x408990=_0x2d95ee(this,function(){const _0x5b377b=a590_0x2dbc;return _0x408990['toString']()[_0x5b377b(0x1be)]('(((.+)+)+)+$')[_0x5b377b(0x1cd)]()['constructor'](_0x408990)[_0x5b377b(0x1be)](_0x5b377b(0x1db));});_0x408990();var _0x4b6dcd=function(_0x4e3840){const _0x2dee01=a590_0x2dbc;return _0x4b6dcd=Object[_0x2dee01(0x1bd)]||function(_0x203497){const _0x515632=_0x2dee01;var _0x62f56a=[];for(var _0x372ac4 in _0x203497)if(Object[_0x515632(0x1bb)][_0x515632(0x1e1)][_0x515632(0x1b2)](_0x203497,_0x372ac4))_0x62f56a[_0x62f56a[_0x515632(0x1b0)]]=_0x372ac4;return _0x62f56a;},_0x4b6dcd(_0x4e3840);};return function(_0x1d1703){const _0x58341f=a590_0x2dbc;if(_0x1d1703&&_0x1d1703[_0x58341f(0x1d3)])return _0x1d1703;var _0x2f51f3={};if(_0x1d1703!=null){for(var _0x3490b3=_0x4b6dcd(_0x1d1703),_0x5d10ac=0x0;_0x5d10ac<_0x3490b3[_0x58341f(0x1b0)];_0x5d10ac++)if(_0x3490b3[_0x5d10ac]!==_0x58341f(0x1c8))__createBinding(_0x2f51f3,_0x1d1703,_0x3490b3[_0x5d10ac]);}return __setModuleDefault(_0x2f51f3,_0x1d1703),_0x2f51f3;};}()),__importDefault=this&&this[a590_0x378107(0x1c1)]||function(_0x493ccf){return _0x493ccf&&_0x493ccf['__esModule']?_0x493ccf:{'default':_0x493ccf};};Object[a590_0x378107(0x1b8)](exports,a590_0x378107(0x1d3),{'value':!![]});const Yup=__importStar(require(a590_0x378107(0x1df))),AppError_1=__importDefault(require(a590_0x378107(0x1b9))),Whatsapp_1=__importDefault(require('../../models/Whatsapp')),Company_1=__importDefault(require('../../models/Company')),Plan_1=__importDefault(require(a590_0x378107(0x1b5))),AssociateWhatsappQueue_1=__importDefault(require(a590_0x378107(0x1bc))),CreateWhatsAppService=async({name:_0x3401e1,status:status=a590_0x378107(0x1cb),queueIds:queueIds=[],greetingMessage:_0x207b69,complationMessage:_0x473557,outOfHoursMessage:_0x45cfa7,useRating:_0x3c2a30,ratingMessage:_0x284983,transferMessage:_0x193e51,isDefault:isDefault=![],companyId:_0x380b61,token:token='',provider:provider=a590_0x378107(0x1c3),facebookUserId:_0x597673,facebookUserToken:_0x4aa3ad,facebookPageUserId:_0x5d49cd,tokenMeta:_0x275958,channel:channel=a590_0x378107(0x1d5),integrationId:_0x297b61,maxUseBotQueues:maxUseBotQueues=0x3,sendIdQueue:_0x39119a,timeSendQueue:_0x394a48,expiresTicket:expiresTicket=0x0,expiresInactiveMessage:expiresInactiveMessage='',allowGroup:allowGroup=![],importOldMessages:_0xaaa6f3,schedules:schedules=[],whenExpireTicket:_0x4e9cd7,inactiveMessageTime:_0x38af21,inactiveMessage:_0x5b91d2,automaticRestart:_0x5d3619,period:_0x188efa,lastRestartAt:_0x57f8cd})=>{const _0x2b7150=a590_0x378107,_0x3d9287=await Company_1[_0x2b7150(0x1c8)]['findOne']({'where':{'id':_0x380b61},'include':[{'model':Plan_1[_0x2b7150(0x1c8)],'as':_0x2b7150(0x1b7)}]});if(_0x3d9287){const _0x37d0a4=await Whatsapp_1['default'][_0x2b7150(0x1d1)]({'where':{'companyId':_0x380b61,'channel':channel}});if(_0x37d0a4>=_0x3d9287[_0x2b7150(0x1b7)][_0x2b7150(0x1bf)])throw new AppError_1[(_0x2b7150(0x1c8))](_0x2b7150(0x1de)+_0x37d0a4);}const _0x11ce43=Yup[_0x2b7150(0x1e0)]()[_0x2b7150(0x1c4)]({'name':Yup['string']()[_0x2b7150(0x1c5)]()[_0x2b7150(0x1cf)](0x2)[_0x2b7150(0x1d9)](_0x2b7150(0x1d0),_0x2b7150(0x1ae),async _0xff9af7=>{const _0x1c1e17=_0x2b7150;if(!_0xff9af7)return![];const _0x333f99=await Whatsapp_1[_0x1c1e17(0x1c8)]['findOne']({'where':{'name':_0xff9af7,'companyId':_0x380b61}});return!_0x333f99;}),'isDefault':Yup['boolean']()[_0x2b7150(0x1c5)]()});try{await _0x11ce43[_0x2b7150(0x1c0)]({'name':_0x3401e1,'status':status,'isDefault':isDefault});}catch(_0x4be468){throw new AppError_1[(_0x2b7150(0x1c8))](_0x4be468[_0x2b7150(0x1ba)]);}const _0x4fba23=await Whatsapp_1[_0x2b7150(0x1c8)][_0x2b7150(0x1ad)]({'where':{'companyId':_0x380b61}});isDefault=channel===_0x2b7150(0x1d5)?!_0x4fba23:![];let _0x42fa35=null;channel===_0x2b7150(0x1d5)&&isDefault&&(_0x42fa35=await Whatsapp_1[_0x2b7150(0x1c8)][_0x2b7150(0x1ad)]({'where':{'isDefault':!![],'companyId':_0x380b61,'channel':channel}}),_0x42fa35&&await _0x42fa35[_0x2b7150(0x1ce)]({'isDefault':![]}));if(queueIds[_0x2b7150(0x1b0)]>0x1&&!_0x207b69)throw new AppError_1[(_0x2b7150(0x1c8))](_0x2b7150(0x1b4));if(token){const _0x4e10cd=Yup[_0x2b7150(0x1e0)]()[_0x2b7150(0x1c4)]({'token':Yup['string']()[_0x2b7150(0x1c5)]()[_0x2b7150(0x1cf)](0x2)[_0x2b7150(0x1d9)](_0x2b7150(0x1e4),_0x2b7150(0x1d8),async _0x41c05d=>{const _0x1382c9=_0x2b7150;if(!_0x41c05d)return![];const _0x4fde25=await Whatsapp_1[_0x1382c9(0x1c8)][_0x1382c9(0x1ad)]({'where':{'token':_0x41c05d,'channel':channel}});return!_0x4fde25;})});try{await _0x4e10cd[_0x2b7150(0x1c0)]({'token':token});}catch(_0x2f5226){throw new AppError_1['default'](_0x2f5226[_0x2b7150(0x1ba)]);}}const _0x3d687a=await Whatsapp_1[_0x2b7150(0x1c8)][_0x2b7150(0x1ac)]({'name':_0x3401e1,'status':status,'greetingMessage':_0x207b69,'complationMessage':_0x473557,'outOfHoursMessage':_0x45cfa7,'useRating':_0x3c2a30,'ratingMessage':_0x284983,'transferMessage':_0x193e51,'isDefault':isDefault,'companyId':_0x380b61,'token':token,'provider':provider,'channel':channel,'facebookUserId':_0x597673,'facebookUserToken':_0x4aa3ad,'facebookPageUserId':_0x5d49cd,'tokenMeta':_0x275958,'integrationId':_0x297b61&&_0x297b61>0x0?_0x297b61:null,'maxUseBotQueues':maxUseBotQueues,'sendIdQueue':_0x39119a,'timeSendQueue':_0x394a48,'expiresTicket':expiresTicket,'expiresInactiveMessage':expiresInactiveMessage,'allowGroup':allowGroup,'importOldMessages':_0xaaa6f3,'schedules':schedules,'whenExpireTicket':_0x4e9cd7,'inactiveMessageTime':_0x38af21,'inactiveMessage':_0x5b91d2,'automaticRestart':_0x5d3619,'period':_0x188efa,'lastRestartAt':_0x57f8cd},{'include':['queues']});return await(0x0,AssociateWhatsappQueue_1[_0x2b7150(0x1c8)])(_0x3d687a,queueIds),{'whatsapp':_0x3d687a,'oldDefaultWhatsapp':_0x42fa35};};exports['default']=CreateWhatsAppService;