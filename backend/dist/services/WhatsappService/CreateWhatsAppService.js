'use strict';const a581_0x13aba6=a581_0x1ca3;function a581_0xc9b7(){const _0x2bf2df=['queues','get','Check-token','6096069wHdAeb','boolean','toString','1390nZNlYe','30710pbAAUz','shape','string','findOne','This\x20whatsapp\x20token\x20is\x20already\x20used.','whatsapp','beta','Número\x20máximo\x20de\x20conexões\x20já\x20alcançado:\x20','3585174sHeSuo','OPENING','getOwnPropertyDescriptor','__importDefault','45971FpByfW','validate','create','../../models/Company','28994218qcsCvy','66HpSxfY','__createBinding','hasOwnProperty','__setModuleDefault','search','1310856rlLjsd','message','8mTTWGr','getOwnPropertyNames','defineProperty','object','default','Check-name','__esModule','../../models/Plan','Esse\x20nome\x20já\x20está\x20sendo\x20utilizado\x20por\x20outra\x20conexão','68274NnuKEh','__importStar','test','required','(((.+)+)+)+$','ERR_WAPP_GREETING_REQUIRED','604stzYoq','update','min','configurable','plan','prototype','length'];a581_0xc9b7=function(){return _0x2bf2df;};return a581_0xc9b7();}(function(_0x30aac5,_0xc20764){const _0x18b322=a581_0x1ca3,_0x2cb2a8=_0x30aac5();while(!![]){try{const _0x4a8f46=parseInt(_0x18b322(0x1ba))/0x1*(-parseInt(_0x18b322(0x1bf))/0x2)+-parseInt(_0x18b322(0x1b6))/0x3+-parseInt(_0x18b322(0x1a0))/0x4*(-parseInt(_0x18b322(0x1ae))/0x5)+-parseInt(_0x18b322(0x1c4))/0x6+-parseInt(_0x18b322(0x1aa))/0x7*(parseInt(_0x18b322(0x1c6))/0x8)+parseInt(_0x18b322(0x19a))/0x9*(parseInt(_0x18b322(0x1ad))/0xa)+parseInt(_0x18b322(0x1be))/0xb;if(_0x4a8f46===_0xc20764)break;else _0x2cb2a8['push'](_0x2cb2a8['shift']());}catch(_0x28518a){_0x2cb2a8['push'](_0x2cb2a8['shift']());}}}(a581_0xc9b7,0xc74a2));var __createBinding=this&&this[a581_0x13aba6(0x1c0)]||(Object[a581_0x13aba6(0x1bc)]?function(_0x575035,_0x3c41bc,_0x3873ba,_0x4cc28e){const _0x4e0074=a581_0x13aba6;if(_0x4cc28e===undefined)_0x4cc28e=_0x3873ba;var _0x55625e=Object[_0x4e0074(0x1b8)](_0x3c41bc,_0x3873ba);(!_0x55625e||(_0x4e0074(0x1a8)in _0x55625e?!_0x3c41bc[_0x4e0074(0x1cc)]:_0x55625e['writable']||_0x55625e[_0x4e0074(0x1a3)]))&&(_0x55625e={'enumerable':!![],'get':function(){return _0x3c41bc[_0x3873ba];}}),Object[_0x4e0074(0x1c8)](_0x575035,_0x4cc28e,_0x55625e);}:function(_0x2de2a0,_0x1f5956,_0x576321,_0x41c4bf){if(_0x41c4bf===undefined)_0x41c4bf=_0x576321;_0x2de2a0[_0x41c4bf]=_0x1f5956[_0x576321];}),__setModuleDefault=this&&this[a581_0x13aba6(0x1c2)]||(Object[a581_0x13aba6(0x1bc)]?function(_0x4d2dcb,_0xddbc3){const _0x3e43e3=a581_0x13aba6;Object[_0x3e43e3(0x1c8)](_0x4d2dcb,_0x3e43e3(0x1ca),{'enumerable':!![],'value':_0xddbc3});}:function(_0x575b76,_0x6c7716){_0x575b76['default']=_0x6c7716;}),__importStar=this&&this[a581_0x13aba6(0x19b)]||(function(){const _0x24688c=(function(){let _0x54880c=!![];return function(_0x20140f,_0x26a73b){const _0x22af71=_0x54880c?function(){if(_0x26a73b){const _0x452dc3=_0x26a73b['apply'](_0x20140f,arguments);return _0x26a73b=null,_0x452dc3;}}:function(){};return _0x54880c=![],_0x22af71;};}()),_0x239c2a=_0x24688c(this,function(){const _0x95e540=a581_0x1ca3;return _0x239c2a[_0x95e540(0x1ac)]()[_0x95e540(0x1c3)](_0x95e540(0x19e))[_0x95e540(0x1ac)]()['constructor'](_0x239c2a)['search'](_0x95e540(0x19e));});_0x239c2a();var _0x1efaa1=function(_0x1dab07){const _0x94aa23=a581_0x1ca3;return _0x1efaa1=Object[_0x94aa23(0x1c7)]||function(_0x3e4593){const _0x439eef=_0x94aa23;var _0x3859b0=[];for(var _0x2774bb in _0x3e4593)if(Object[_0x439eef(0x1a5)][_0x439eef(0x1c1)]['call'](_0x3e4593,_0x2774bb))_0x3859b0[_0x3859b0[_0x439eef(0x1a6)]]=_0x2774bb;return _0x3859b0;},_0x1efaa1(_0x1dab07);};return function(_0x16f3b8){const _0x224597=a581_0x1ca3;if(_0x16f3b8&&_0x16f3b8[_0x224597(0x1cc)])return _0x16f3b8;var _0x166059={};if(_0x16f3b8!=null){for(var _0x574548=_0x1efaa1(_0x16f3b8),_0x3fb672=0x0;_0x3fb672<_0x574548[_0x224597(0x1a6)];_0x3fb672++)if(_0x574548[_0x3fb672]!==_0x224597(0x1ca))__createBinding(_0x166059,_0x16f3b8,_0x574548[_0x3fb672]);}return __setModuleDefault(_0x166059,_0x16f3b8),_0x166059;};}()),__importDefault=this&&this[a581_0x13aba6(0x1b9)]||function(_0x21b2b6){const _0x3c4e29=a581_0x13aba6;return _0x21b2b6&&_0x21b2b6[_0x3c4e29(0x1cc)]?_0x21b2b6:{'default':_0x21b2b6};};function a581_0x1ca3(_0xd61b5a,_0x4b9da9){const _0x5baed3=a581_0xc9b7();return a581_0x1ca3=function(_0x1c8a63,_0x4e97a1){_0x1c8a63=_0x1c8a63-0x19a;let _0xc9b75d=_0x5baed3[_0x1c8a63];return _0xc9b75d;},a581_0x1ca3(_0xd61b5a,_0x4b9da9);}Object['defineProperty'](exports,a581_0x13aba6(0x1cc),{'value':!![]});const Yup=__importStar(require('yup')),AppError_1=__importDefault(require('../../errors/AppError')),Whatsapp_1=__importDefault(require('../../models/Whatsapp')),Company_1=__importDefault(require(a581_0x13aba6(0x1bd))),Plan_1=__importDefault(require(a581_0x13aba6(0x1cd))),AssociateWhatsappQueue_1=__importDefault(require('./AssociateWhatsappQueue')),CreateWhatsAppService=async({name:_0x5b0274,status:status=a581_0x13aba6(0x1b7),queueIds:queueIds=[],greetingMessage:_0x346a79,complationMessage:_0x569576,outOfHoursMessage:_0x44af13,ratingMessage:_0x53e527,transferMessage:_0x3eab47,isDefault:isDefault=![],companyId:_0x4e758,token:token='',provider:provider=a581_0x13aba6(0x1b4),facebookUserId:_0xe1e2da,facebookUserToken:_0x3a9500,facebookPageUserId:_0xba4227,tokenMeta:_0x30e1f0,channel:channel=a581_0x13aba6(0x1b3),integrationId:_0x5b684b,maxUseBotQueues:maxUseBotQueues=0x3,sendIdQueue:_0x1df63e,timeSendQueue:_0x3cea7f,expiresTicket:expiresTicket=0x0,expiresInactiveMessage:expiresInactiveMessage='',allowGroup:allowGroup=![],importOldMessages:_0xea3302,schedules:schedules=[]})=>{const _0x14ff0f=a581_0x13aba6,_0x57f53e=await Company_1['default'][_0x14ff0f(0x1b1)]({'where':{'id':_0x4e758},'include':[{'model':Plan_1['default'],'as':_0x14ff0f(0x1a4)}]});if(_0x57f53e){const _0x5a661c=await Whatsapp_1[_0x14ff0f(0x1ca)]['count']({'where':{'companyId':_0x4e758,'channel':channel}});if(_0x5a661c>=_0x57f53e[_0x14ff0f(0x1a4)]['connections'])throw new AppError_1['default'](_0x14ff0f(0x1b5)+_0x5a661c);}const _0x50d23d=Yup[_0x14ff0f(0x1c9)]()[_0x14ff0f(0x1af)]({'name':Yup[_0x14ff0f(0x1b0)]()[_0x14ff0f(0x19d)]()['min'](0x2)[_0x14ff0f(0x19c)](_0x14ff0f(0x1cb),_0x14ff0f(0x1ce),async _0x36f172=>{const _0x29f1eb=_0x14ff0f;if(!_0x36f172)return![];const _0xf328a1=await Whatsapp_1['default'][_0x29f1eb(0x1b1)]({'where':{'name':_0x36f172,'companyId':_0x4e758}});return!_0xf328a1;}),'isDefault':Yup[_0x14ff0f(0x1ab)]()[_0x14ff0f(0x19d)]()});try{await _0x50d23d['validate']({'name':_0x5b0274,'status':status,'isDefault':isDefault});}catch(_0x1a1dfa){throw new AppError_1[(_0x14ff0f(0x1ca))](_0x1a1dfa[_0x14ff0f(0x1c5)]);}const _0x23dda4=await Whatsapp_1[_0x14ff0f(0x1ca)][_0x14ff0f(0x1b1)]({'where':{'companyId':_0x4e758}});isDefault=channel===_0x14ff0f(0x1b3)?!_0x23dda4:![];let _0x579342=null;channel===_0x14ff0f(0x1b3)&&isDefault&&(_0x579342=await Whatsapp_1[_0x14ff0f(0x1ca)][_0x14ff0f(0x1b1)]({'where':{'isDefault':!![],'companyId':_0x4e758,'channel':channel}}),_0x579342&&await _0x579342[_0x14ff0f(0x1a1)]({'isDefault':![]}));if(queueIds[_0x14ff0f(0x1a6)]>0x1&&!_0x346a79)throw new AppError_1[(_0x14ff0f(0x1ca))](_0x14ff0f(0x19f));if(token){const _0x26f786=Yup[_0x14ff0f(0x1c9)]()[_0x14ff0f(0x1af)]({'token':Yup[_0x14ff0f(0x1b0)]()[_0x14ff0f(0x19d)]()[_0x14ff0f(0x1a2)](0x2)[_0x14ff0f(0x19c)](_0x14ff0f(0x1a9),_0x14ff0f(0x1b2),async _0x953fa6=>{const _0x3731e0=_0x14ff0f;if(!_0x953fa6)return![];const _0x26c480=await Whatsapp_1[_0x3731e0(0x1ca)][_0x3731e0(0x1b1)]({'where':{'token':_0x953fa6,'channel':channel}});return!_0x26c480;})});try{await _0x26f786[_0x14ff0f(0x1bb)]({'token':token});}catch(_0x32acc3){throw new AppError_1[(_0x14ff0f(0x1ca))](_0x32acc3[_0x14ff0f(0x1c5)]);}}const _0x444efa=await Whatsapp_1['default']['create']({'name':_0x5b0274,'status':status,'greetingMessage':_0x346a79,'complationMessage':_0x569576,'outOfHoursMessage':_0x44af13,'ratingMessage':_0x53e527,'transferMessage':_0x3eab47,'isDefault':isDefault,'companyId':_0x4e758,'token':token,'provider':provider,'channel':channel,'facebookUserId':_0xe1e2da,'facebookUserToken':_0x3a9500,'facebookPageUserId':_0xba4227,'tokenMeta':_0x30e1f0,'integrationId':_0x5b684b&&_0x5b684b>0x0?_0x5b684b:null,'maxUseBotQueues':maxUseBotQueues,'sendIdQueue':_0x1df63e,'timeSendQueue':_0x3cea7f,'expiresTicket':expiresTicket,'expiresInactiveMessage':expiresInactiveMessage,'allowGroup':allowGroup,'importOldMessages':_0xea3302,'schedules':schedules},{'include':[_0x14ff0f(0x1a7)]});return await(0x0,AssociateWhatsappQueue_1[_0x14ff0f(0x1ca)])(_0x444efa,queueIds),{'whatsapp':_0x444efa,'oldDefaultWhatsapp':_0x579342};};exports[a581_0x13aba6(0x1ca)]=CreateWhatsAppService;