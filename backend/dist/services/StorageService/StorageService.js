'use strict';const a643_0x4c85ff=a643_0x560f;(function(_0xe641ce,_0x3e0f39){const _0x198476=a643_0x560f,_0x40def8=_0xe641ce();while(!![]){try{const _0x3155b5=parseInt(_0x198476(0x111))/0x1*(-parseInt(_0x198476(0x164))/0x2)+parseInt(_0x198476(0x11f))/0x3*(-parseInt(_0x198476(0x199))/0x4)+-parseInt(_0x198476(0x1aa))/0x5+parseInt(_0x198476(0x13f))/0x6*(-parseInt(_0x198476(0x11e))/0x7)+parseInt(_0x198476(0x1a1))/0x8*(parseInt(_0x198476(0x1a7))/0x9)+parseInt(_0x198476(0x151))/0xa+parseInt(_0x198476(0x15f))/0xb*(parseInt(_0x198476(0x1a2))/0xc);if(_0x3155b5===_0x3e0f39)break;else _0x40def8['push'](_0x40def8['shift']());}catch(_0x26b9d2){_0x40def8['push'](_0x40def8['shift']());}}}(a643_0x51ed,0xe6a5e));var __createBinding=this&&this[a643_0x4c85ff(0x1b8)]||(Object[a643_0x4c85ff(0x121)]?function(_0x39f8f1,_0x3b3b14,_0x1d8af3,_0x30fe65){const _0x1c8ad4=a643_0x4c85ff;if(_0x30fe65===undefined)_0x30fe65=_0x1d8af3;var _0x5d77f1=Object['getOwnPropertyDescriptor'](_0x3b3b14,_0x1d8af3);(!_0x5d77f1||(_0x1c8ad4(0x184)in _0x5d77f1?!_0x3b3b14[_0x1c8ad4(0x1a6)]:_0x5d77f1[_0x1c8ad4(0x135)]||_0x5d77f1['configurable']))&&(_0x5d77f1={'enumerable':!![],'get':function(){return _0x3b3b14[_0x1d8af3];}}),Object['defineProperty'](_0x39f8f1,_0x30fe65,_0x5d77f1);}:function(_0x4d64c5,_0x360191,_0x8ad73e,_0xee4b3c){if(_0xee4b3c===undefined)_0xee4b3c=_0x8ad73e;_0x4d64c5[_0xee4b3c]=_0x360191[_0x8ad73e];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a643_0x4c85ff(0x121)]?function(_0x2b3fc9,_0x3cd0d8){const _0x2be98c=a643_0x4c85ff;Object[_0x2be98c(0x11a)](_0x2b3fc9,'default',{'enumerable':!![],'value':_0x3cd0d8});}:function(_0x455ba5,_0x3c6ffa){const _0x5ca003=a643_0x4c85ff;_0x455ba5[_0x5ca003(0x154)]=_0x3c6ffa;}),__importStar=this&&this['__importStar']||(function(){const _0x57d91b=(function(){let _0x31ca23=!![];return function(_0x119477,_0x3142be){const _0x504577=_0x31ca23?function(){const _0x2f24a2=a643_0x560f;if(_0x3142be){const _0x5b460c=_0x3142be[_0x2f24a2(0x18d)](_0x119477,arguments);return _0x3142be=null,_0x5b460c;}}:function(){};return _0x31ca23=![],_0x504577;};}()),_0x193928=_0x57d91b(this,function(){const _0x19587b=a643_0x560f;return _0x193928[_0x19587b(0x11c)]()[_0x19587b(0x18c)](_0x19587b(0x187))['toString']()['constructor'](_0x193928)['search'](_0x19587b(0x187));});_0x193928();var _0x1d9d4f=function(_0x26ee65){const _0x5a2f6b=a643_0x560f;return _0x1d9d4f=Object[_0x5a2f6b(0x19c)]||function(_0x2bcba4){const _0x56538c=_0x5a2f6b;var _0x1903af=[];for(var _0x558a66 in _0x2bcba4)if(Object[_0x56538c(0x172)][_0x56538c(0x12e)][_0x56538c(0x1af)](_0x2bcba4,_0x558a66))_0x1903af[_0x1903af[_0x56538c(0x105)]]=_0x558a66;return _0x1903af;},_0x1d9d4f(_0x26ee65);};return function(_0x836ecf){const _0x388a35=a643_0x560f;if(_0x836ecf&&_0x836ecf[_0x388a35(0x1a6)])return _0x836ecf;var _0xceae05={};if(_0x836ecf!=null){for(var _0x46acd2=_0x1d9d4f(_0x836ecf),_0xa060b4=0x0;_0xa060b4<_0x46acd2[_0x388a35(0x105)];_0xa060b4++)if(_0x46acd2[_0xa060b4]!==_0x388a35(0x154))__createBinding(_0xceae05,_0x836ecf,_0x46acd2[_0xa060b4]);}return __setModuleDefault(_0xceae05,_0x836ecf),_0xceae05;};}()),__importDefault=this&&this['__importDefault']||function(_0x101fe2){const _0x461a3c=a643_0x4c85ff;return _0x101fe2&&_0x101fe2[_0x461a3c(0x1a6)]?_0x101fe2:{'default':_0x101fe2};};Object[a643_0x4c85ff(0x11a)](exports,a643_0x4c85ff(0x1a6),{'value':!![]});const Minio=__importStar(require(a643_0x4c85ff(0x15c))),fs_1=__importDefault(require('fs')),path_1=__importDefault(require(a643_0x4c85ff(0x196))),util_1=require(a643_0x4c85ff(0x1b6)),storage_1=__importStar(require('../../config/storage')),Setting_1=__importDefault(require(a643_0x4c85ff(0x130))),Company_1=__importDefault(require(a643_0x4c85ff(0x13e))),Plan_1=__importDefault(require(a643_0x4c85ff(0x158))),AppError_1=__importDefault(require(a643_0x4c85ff(0x19f))),readdir=(0x0,util_1[a643_0x4c85ff(0x12a)])(fs_1[a643_0x4c85ff(0x154)]['readdir']),stat=(0x0,util_1[a643_0x4c85ff(0x12a)])(fs_1[a643_0x4c85ff(0x154)][a643_0x4c85ff(0x116)]),mkdir=(0x0,util_1[a643_0x4c85ff(0x12a)])(fs_1[a643_0x4c85ff(0x154)][a643_0x4c85ff(0x124)]),rmdir=(0x0,util_1[a643_0x4c85ff(0x12a)])(fs_1[a643_0x4c85ff(0x154)]['rm']),formatBytes=_0x4c7237=>{const _0x3ef098=a643_0x4c85ff;if(_0x4c7237===0x0)return _0x3ef098(0x14c);const _0x453c81=0x400,_0x23b92e=[_0x3ef098(0x136),'KB','MB','GB','TB'],_0x24caef=Math[_0x3ef098(0x173)](Math[_0x3ef098(0x140)](_0x4c7237)/Math[_0x3ef098(0x140)](_0x453c81));return parseFloat((_0x4c7237/Math[_0x3ef098(0x13a)](_0x453c81,_0x24caef))[_0x3ef098(0x13b)](0x2))+'\x20'+_0x23b92e[_0x24caef];},getGlobalMinioConfig=async()=>{const _0x4fe2b2=a643_0x4c85ff;try{const _0x3b1ae5=await Setting_1[_0x4fe2b2(0x154)][_0x4fe2b2(0x18b)]({'where':{'companyId':0x1},'attributes':[_0x4fe2b2(0x17c),'value']}),_0x3d35c5={};_0x3b1ae5[_0x4fe2b2(0x123)](_0x5935a0=>{const _0x2eaa2a=_0x4fe2b2;_0x3d35c5[_0x5935a0[_0x2eaa2a(0x17c)]]=_0x5935a0[_0x2eaa2a(0x1b5)];});const _0xf2100b=_0x3d35c5[_0x4fe2b2(0x15e)],_0x1af46b=_0x3d35c5[_0x4fe2b2(0x14f)],_0x110127=_0x3d35c5['minioSecretKey'],_0x39be9a=_0x3d35c5[_0x4fe2b2(0x19e)]||_0x4fe2b2(0x152),_0x5644f5=parseInt(_0x3d35c5['minioPort']||'9000',0xa),_0x3af8c1=_0x3d35c5[_0x4fe2b2(0x118)]===_0x4fe2b2(0x192);if(!_0xf2100b||!_0x1af46b||!_0x110127)return null;return{'endPoint':_0xf2100b,'port':_0x5644f5,'useSSL':_0x3af8c1,'accessKey':_0x1af46b,'secretKey':_0x110127,'bucket':_0x39be9a};}catch(_0x5c7993){return console[_0x4fe2b2(0x16c)](_0x4fe2b2(0x141),_0x5c7993),null;}},getCompanyBucketName=async(_0x3726e7,_0x470008)=>{const _0x530743=a643_0x4c85ff;try{const _0x3b41cf=await Company_1['default'][_0x530743(0x1a9)](_0x470008,{'attributes':[_0x530743(0x12b)]});if(_0x3b41cf?.[_0x530743(0x12b)])return _0x3b41cf['bucketName'][_0x530743(0x120)]();}catch(_0x43212b){console[_0x530743(0x16c)](_0x530743(0x171),_0x43212b);}return _0x3726e7[_0x530743(0x120)]()+'-'+_0x470008;},getCompanyBucketNameSync=(_0x496331,_0x3bba80)=>{const _0x3365b3=a643_0x4c85ff;return _0x496331[_0x3365b3(0x120)]()+'-'+_0x3bba80;},createMinioClient=_0x4a7b3c=>{const _0xbc92b=a643_0x4c85ff;let _0x1c0ca4=_0x4a7b3c[_0xbc92b(0x146)],_0x2a0bbf=_0x4a7b3c['useSSL'];if(_0x1c0ca4[_0xbc92b(0x1b7)](_0xbc92b(0x191)))_0x1c0ca4=_0x1c0ca4[_0xbc92b(0x12d)](_0xbc92b(0x191),''),_0x2a0bbf=!![];else _0x1c0ca4[_0xbc92b(0x1b7)](_0xbc92b(0x115))&&(_0x1c0ca4=_0x1c0ca4[_0xbc92b(0x12d)](_0xbc92b(0x115),''),_0x2a0bbf=![]);_0x1c0ca4=_0x1c0ca4[_0xbc92b(0x12d)](/\/$/,'');if(_0x4a7b3c[_0xbc92b(0x175)]===0x1bb)_0x2a0bbf=!![];else _0x4a7b3c['port']===0x50&&(_0x2a0bbf=![]);return new Minio[(_0xbc92b(0x16a))]({'endPoint':_0x1c0ca4,'port':_0x4a7b3c[_0xbc92b(0x175)],'useSSL':_0x2a0bbf,'accessKey':_0x4a7b3c[_0xbc92b(0x17b)],'secretKey':_0x4a7b3c['secretKey']});},getFolderSize=async _0x30dcf9=>{const _0x283c1d=a643_0x4c85ff;let _0x38f30f=0x0,_0x55cc49=0x0;try{if(!fs_1[_0x283c1d(0x154)][_0x283c1d(0x198)](_0x30dcf9))return{'size':0x0,'fileCount':0x0};const _0x168322=await readdir(_0x30dcf9);for(const _0x5837ae of _0x168322){const _0x2d31d3=path_1[_0x283c1d(0x154)][_0x283c1d(0x149)](_0x30dcf9,_0x5837ae),_0x2a8c22=await stat(_0x2d31d3);if(_0x2a8c22['isDirectory']()){const _0x1f6e34=await getFolderSize(_0x2d31d3);_0x38f30f+=_0x1f6e34['size'],_0x55cc49+=_0x1f6e34['fileCount'];}else _0x38f30f+=_0x2a8c22[_0x283c1d(0x189)],_0x55cc49++;}}catch(_0x2796e8){console[_0x283c1d(0x16c)](_0x283c1d(0x10a)+_0x30dcf9+':',_0x2796e8);}return{'size':_0x38f30f,'fileCount':_0x55cc49};},getMinioFolderSize=async(_0x2e3dfc,_0x2f73a7,_0x4a6482)=>{return new Promise(_0x598e60=>{const _0xf78c49=a643_0x560f;let _0x5ac527=0x0,_0x33fdbe=0x0;const _0x3d2ecf=_0x2e3dfc['listObjects'](_0x2f73a7,_0x4a6482,!![]);_0x3d2ecf['on'](_0xf78c49(0x104),_0x5bff6a=>{const _0x3d0eba=_0xf78c49;_0x5ac527+=_0x5bff6a[_0x3d0eba(0x189)]||0x0,_0x33fdbe++;}),_0x3d2ecf['on']('error',_0x31cf57=>{const _0x23fc00=_0xf78c49;console[_0x23fc00(0x16c)]('Erro\x20ao\x20listar\x20objetos\x20MinIO:',_0x31cf57),_0x598e60({'size':0x0,'fileCount':0x0});}),_0x3d2ecf['on'](_0xf78c49(0x18a),()=>{_0x598e60({'size':_0x5ac527,'fileCount':_0x33fdbe});});});},getStorageLimit=async _0x518c06=>{const _0x2ed256=a643_0x4c85ff;try{const _0x3ae2dc=await Company_1[_0x2ed256(0x154)][_0x2ed256(0x1a9)](_0x518c06,{'include':[{'model':Plan_1[_0x2ed256(0x154)],'as':'plan'}]});if(_0x3ae2dc?.[_0x2ed256(0x127)]?.[_0x2ed256(0x126)])return _0x3ae2dc['plan'][_0x2ed256(0x126)];return 0xa;}catch(_0x3374fc){return console['error'](_0x2ed256(0x179),_0x3374fc),0xa;}},getCompanyPath=_0x565378=>{const _0x275a93=a643_0x4c85ff,_0x2f5792=path_1[_0x275a93(0x154)][_0x275a93(0x149)](storage_1[_0x275a93(0x154)]['directory'],_0x275a93(0x181),String(_0x565378));return console[_0x275a93(0x140)](_0x275a93(0x17a)+storage_1[_0x275a93(0x154)][_0x275a93(0x150)]+',\x20companyPath='+_0x2f5792),_0x2f5792;},createLocalFolderStructure=async _0x3945e6=>{const _0x45f076=a643_0x4c85ff,_0x4d3ee4=getCompanyPath(_0x3945e6);await mkdir(_0x4d3ee4,{'recursive':!![]});for(const _0xc3887a of Object[_0x45f076(0x167)](storage_1[_0x45f076(0x148)])){const _0x47797f=path_1[_0x45f076(0x154)][_0x45f076(0x149)](_0x4d3ee4,storage_1[_0x45f076(0x148)][_0xc3887a]);await mkdir(_0x47797f,{'recursive':!![]});}},createMinioBucketForCompany=async(_0x304e1f,_0x5276e6,_0x22837a)=>{const _0x7407ce=a643_0x4c85ff;try{const _0x3358b0=await _0x304e1f[_0x7407ce(0x1b2)](_0x5276e6);if(!_0x3358b0){await _0x304e1f['makeBucket'](_0x5276e6),console[_0x7407ce(0x140)](_0x7407ce(0x159)+_0x5276e6+_0x7407ce(0x14b));const _0x7dae6c={'Version':_0x7407ce(0x101),'Statement':[{'Effect':_0x7407ce(0x1b4),'Principal':{'AWS':['*']},'Action':[_0x7407ce(0x156)],'Resource':['arn:aws:s3:::'+_0x5276e6+'/*']}]};await _0x304e1f[_0x7407ce(0x16e)](_0x5276e6,JSON['stringify'](_0x7dae6c)),console[_0x7407ce(0x140)]('Política\x20de\x20acesso\x20configurada\x20para\x20'+_0x5276e6);}for(const _0x33d6de of Object['keys'](storage_1['STORAGE_FOLDERS'])){const _0x143947=storage_1[_0x7407ce(0x148)][_0x33d6de]+'/.keep';try{await _0x304e1f[_0x7407ce(0x102)](_0x5276e6,_0x143947,Buffer[_0x7407ce(0x131)](''),0x0);}catch(_0xb38dd6){}}console[_0x7407ce(0x140)](_0x7407ce(0x193)+_0x5276e6);}catch(_0x3622a1){console[_0x7407ce(0x16c)]('Erro\x20ao\x20criar\x20bucket\x20'+_0x5276e6+':',_0x3622a1);throw _0x3622a1;}};class StorageService{static async[a643_0x4c85ff(0x176)](_0x62ca4){const _0x45cfec=a643_0x4c85ff,_0x5a5c74=await getGlobalMinioConfig();let _0x571363=![],_0x3c56cf;if(_0x5a5c74)try{const _0x4392ed=createMinioClient(_0x5a5c74);_0x3c56cf=await getCompanyBucketName(_0x5a5c74[_0x45cfec(0x1a3)],_0x62ca4);const _0x4c3724=await getStorageLimit(_0x62ca4);await createMinioBucketForCompany(_0x4392ed,_0x3c56cf,_0x4c3724),_0x571363=!![],console[_0x45cfec(0x140)]('Bucket\x20MinIO\x20'+_0x3c56cf+_0x45cfec(0x18f)+_0x62ca4);}catch(_0x3803ab){console[_0x45cfec(0x16c)](_0x45cfec(0x1ae)+_0x62ca4+':',_0x3803ab);}return await createLocalFolderStructure(_0x62ca4),{'bucketCreated':_0x571363,'bucketName':_0x3c56cf};}static async[a643_0x4c85ff(0x17f)](_0x3b6afd){const _0x122a31=a643_0x4c85ff,_0x33b72a=await getGlobalMinioConfig(),_0x1c7219=await getStorageLimit(_0x3b6afd),_0x2d221e=_0x1c7219*0x400*0x400*0x400,_0x1762f7=[];let _0x165661=0x0;const _0x1a62f8={'tickets':_0x122a31(0x169),'uploads':'Uploads','campanhas':_0x122a31(0x122),'campanhasLista':_0x122a31(0x195),'kanban':_0x122a31(0x13c),'empresa':_0x122a31(0x19d),'conexao':_0x122a31(0x157),'filas':_0x122a31(0x142),'flowbuilder':_0x122a31(0x125)};if(_0x33b72a){const _0x4a76be=createMinioClient(_0x33b72a),_0x51bba1=await getCompanyBucketName(_0x33b72a[_0x122a31(0x1a3)],_0x3b6afd);try{const _0x234eaa=await _0x4a76be[_0x122a31(0x1b2)](_0x51bba1);if(_0x234eaa){for(const [_0x5b1222,_0x1b91de]of Object['entries'](storage_1['STORAGE_FOLDERS'])){const _0x544400=_0x1b91de+'/',{size:_0x452982,fileCount:_0x4579c4}=await getMinioFolderSize(_0x4a76be,_0x51bba1,_0x544400);_0x1762f7['push']({'folder':_0x5b1222,'folderName':_0x1a62f8[_0x5b1222]||_0x5b1222,'size':_0x452982,'sizeFormatted':formatBytes(_0x452982),'fileCount':_0x4579c4}),_0x165661+=_0x452982;}return{'storageType':_0x122a31(0x15c),'totalUsed':_0x165661,'totalUsedFormatted':formatBytes(_0x165661),'storageLimit':_0x1c7219,'storageLimitBytes':_0x2d221e,'usagePercentage':Math[_0x122a31(0x137)](_0x165661/_0x2d221e*0x64*0x64)/0x64,'folders':_0x1762f7,'isLimitReached':_0x165661>=_0x2d221e,'bucketName':_0x51bba1};}}catch(_0x42d301){console[_0x122a31(0x16c)](_0x122a31(0x163),_0x42d301);}}const _0x3d11c5=getCompanyPath(_0x3b6afd);console[_0x122a31(0x140)](_0x122a31(0x166)+_0x3d11c5+',\x20exists='+fs_1[_0x122a31(0x154)][_0x122a31(0x198)](_0x3d11c5));for(const [_0x1a65bb,_0x880b96]of Object[_0x122a31(0x12c)](storage_1[_0x122a31(0x148)])){const _0x407540=path_1[_0x122a31(0x154)][_0x122a31(0x149)](_0x3d11c5,_0x880b96),_0x4a99ce=fs_1['default']['existsSync'](_0x407540),{size:_0x2d2857,fileCount:_0x4feb2a}=await getFolderSize(_0x407540);console[_0x122a31(0x140)]('[StorageService]\x20Pasta\x20'+_0x1a65bb+_0x122a31(0x161)+_0x407540+_0x122a31(0x182)+_0x4a99ce+',\x20size='+formatBytes(_0x2d2857)+_0x122a31(0x134)+_0x4feb2a),_0x1762f7[_0x122a31(0x10b)]({'folder':_0x1a65bb,'folderName':_0x1a62f8[_0x1a65bb]||_0x1a65bb,'size':_0x2d2857,'sizeFormatted':formatBytes(_0x2d2857),'fileCount':_0x4feb2a});}const {size:_0x23a4c7,fileCount:_0x68c07b}=await getFolderSize(_0x3d11c5);_0x165661=_0x23a4c7;const _0x350f89=_0x1762f7[_0x122a31(0x16d)]((_0x2c881b,_0x296106)=>_0x2c881b+_0x296106[_0x122a31(0x189)],0x0),_0x3bf635=_0x165661-_0x350f89;if(_0x3bf635>0x0){const _0x22cf57=_0x68c07b-_0x1762f7[_0x122a31(0x16d)]((_0x402519,_0x1a1c53)=>_0x402519+_0x1a1c53[_0x122a31(0x1b3)],0x0);_0x1762f7['push']({'folder':_0x122a31(0x178),'folderName':_0x122a31(0x103),'size':_0x3bf635,'sizeFormatted':formatBytes(_0x3bf635),'fileCount':_0x22cf57}),console[_0x122a31(0x140)](_0x122a31(0x17e)+formatBytes(_0x3bf635)+_0x122a31(0x134)+_0x22cf57);}return console[_0x122a31(0x140)](_0x122a31(0x194)+formatBytes(_0x165661)+_0x122a31(0x14a)+formatBytes(_0x2d221e)+',\x20percentage='+Math['round'](_0x165661/_0x2d221e*0x64)+'%'),{'storageType':_0x122a31(0x10e),'totalUsed':_0x165661,'totalUsedFormatted':formatBytes(_0x165661),'storageLimit':_0x1c7219,'storageLimitBytes':_0x2d221e,'usagePercentage':Math[_0x122a31(0x137)](_0x165661/_0x2d221e*0x64*0x64)/0x64,'folders':_0x1762f7,'isLimitReached':_0x165661>=_0x2d221e};}static async[a643_0x4c85ff(0x106)](_0x4bbc0a,_0x10e9b8=0x0){const _0x5bb658=a643_0x4c85ff,_0x4bdc19=await this[_0x5bb658(0x17f)](_0x4bbc0a),_0x16b003=_0x4bdc19[_0x5bb658(0x119)]+_0x10e9b8<_0x4bdc19[_0x5bb658(0x11b)];return console[_0x5bb658(0x140)](_0x5bb658(0x16b)+_0x4bbc0a+_0x5bb658(0x144)+formatBytes(_0x4bdc19[_0x5bb658(0x119)])+_0x5bb658(0x15d)+formatBytes(_0x4bdc19[_0x5bb658(0x11b)])+_0x5bb658(0x1a4)+formatBytes(_0x10e9b8)+_0x5bb658(0x114)+_0x16b003),_0x16b003;}static async[a643_0x4c85ff(0x170)](_0x2c8292,_0x273e79){const _0x233ffb=a643_0x4c85ff,_0x5d92df=storage_1[_0x233ffb(0x148)][_0x273e79];if(!_0x5d92df)throw new AppError_1[(_0x233ffb(0x154))]('Pasta\x20não\x20encontrada',0x194);const _0x1e1324=await getGlobalMinioConfig();if(_0x1e1324){const _0x2642d4=createMinioClient(_0x1e1324),_0x10a3fc=await getCompanyBucketName(_0x1e1324[_0x233ffb(0x1a3)],_0x2c8292);try{const _0x86da69=await _0x2642d4[_0x233ffb(0x1b2)](_0x10a3fc);if(_0x86da69){const _0x3324f9=_0x5d92df+'/';return new Promise((_0x49c8a3,_0x27d2b4)=>{const _0x571601=_0x233ffb,_0x44189d=[],_0x431906=_0x2642d4[_0x571601(0x112)](_0x10a3fc,_0x3324f9,!![]);_0x431906['on'](_0x571601(0x104),_0x4c45dd=>{const _0x25395e=_0x571601;_0x4c45dd[_0x25395e(0x12f)]&&!_0x4c45dd[_0x25395e(0x12f)][_0x25395e(0x1ad)](_0x25395e(0x160))&&_0x44189d[_0x25395e(0x10b)](_0x4c45dd[_0x25395e(0x12f)]);}),_0x431906['on'](_0x571601(0x16c),_0x306403=>{_0x27d2b4(_0x306403);}),_0x431906['on'](_0x571601(0x18a),async()=>{const _0x1ecb50=_0x571601;if(_0x44189d[_0x1ecb50(0x105)]>0x0)try{await _0x2642d4[_0x1ecb50(0x10f)](_0x10a3fc,_0x44189d),_0x49c8a3({'success':!![],'message':_0x44189d['length']+'\x20arquivo(s)\x20removido(s)\x20com\x20sucesso'});}catch(_0x4209d5){_0x27d2b4(_0x4209d5);}else _0x49c8a3({'success':!![],'message':_0x1ecb50(0x133)});});});}}catch(_0x4b3df6){console['error'](_0x233ffb(0x143),_0x4b3df6);}}const _0x3dce66=path_1[_0x233ffb(0x154)]['join'](getCompanyPath(_0x2c8292),_0x5d92df);if(!fs_1[_0x233ffb(0x154)][_0x233ffb(0x198)](_0x3dce66))return{'success':!![],'message':_0x233ffb(0x133)};try{return await rmdir(_0x3dce66,{'recursive':!![]}),await mkdir(_0x3dce66,{'recursive':!![]}),{'success':!![],'message':_0x233ffb(0x109)};}catch(_0xcaf8f6){console[_0x233ffb(0x16c)](_0x233ffb(0xff),_0xcaf8f6);throw new AppError_1[(_0x233ffb(0x154))](_0x233ffb(0x174),0x1f4);}}static async[a643_0x4c85ff(0x162)](_0x2d9a84,_0x530d45,_0x1237f8,_0x4711e7,_0x597d81){const _0x4bef69=a643_0x4c85ff,_0x3de676=await getGlobalMinioConfig();let _0x1576a5;const _0x4cdbbb=typeof _0x4711e7==='string';_0x4cdbbb?_0x1576a5=await fs_1[_0x4bef69(0x154)][_0x4bef69(0x19b)][_0x4bef69(0x147)](_0x4711e7):_0x1576a5=_0x4711e7;const _0x16c3d9=async()=>{const _0x301540=_0x4bef69;if(_0x4cdbbb&&fs_1[_0x301540(0x154)]['existsSync'](_0x4711e7))try{await fs_1['default'][_0x301540(0x19b)][_0x301540(0x129)](_0x4711e7);}catch(_0x19b999){console[_0x301540(0x16c)]('Erro\x20ao\x20deletar\x20arquivo\x20temporário:',_0x19b999);}};if(_0x3de676)try{const _0x35c2a0=createMinioClient(_0x3de676),_0x393fe1=await getCompanyBucketName(_0x3de676['bucket'],_0x2d9a84),_0x3dc1d8=await _0x35c2a0[_0x4bef69(0x1b2)](_0x393fe1);if(!_0x3dc1d8){const _0xe370d1=await getStorageLimit(_0x2d9a84);await createMinioBucketForCompany(_0x35c2a0,_0x393fe1,_0xe370d1);}const _0x132dca=_0x530d45+'/'+_0x1237f8,_0x3b1448=_0x597d81?{'Content-Type':_0x597d81}:{};await _0x35c2a0['putObject'](_0x393fe1,_0x132dca,_0x1576a5,_0x1576a5[_0x4bef69(0x105)],_0x3b1448);let _0x369898=_0x3de676[_0x4bef69(0x146)];if(_0x369898[_0x4bef69(0x1b7)](_0x4bef69(0x191)))_0x369898=_0x369898[_0x4bef69(0x12d)](_0x4bef69(0x191),'');else _0x369898[_0x4bef69(0x1b7)](_0x4bef69(0x115))&&(_0x369898=_0x369898['replace'](_0x4bef69(0x115),''));const _0x2d78b8=_0x3de676[_0x4bef69(0x17d)]||_0x3de676[_0x4bef69(0x175)]===0x1bb?_0x4bef69(0x14e):_0x4bef69(0x18e),_0x724d86=_0x3de676[_0x4bef69(0x175)]===0x50||_0x3de676[_0x4bef69(0x175)]===0x1bb?'':':'+_0x3de676[_0x4bef69(0x175)],_0x4cf2cc=_0x2d78b8+_0x4bef69(0x188)+_0x369898+_0x724d86+'/'+_0x393fe1+'/'+_0x132dca;return await _0x16c3d9(),{'url':_0x4cf2cc,'storageType':_0x4bef69(0x15c)};}catch(_0x120796){await _0x16c3d9(),console[_0x4bef69(0x16c)]('Erro\x20ao\x20fazer\x20upload\x20para\x20MinIO:',_0x120796);throw new AppError_1[(_0x4bef69(0x154))](_0x4bef69(0x186),0x1f4);}const _0x5f34ed=storage_1['default']['directory'],_0x596de9=path_1[_0x4bef69(0x154)]['join'](_0x5f34ed,'media',String(_0x2d9a84),_0x530d45);!fs_1[_0x4bef69(0x154)]['existsSync'](_0x596de9)&&await mkdir(_0x596de9,{'recursive':!![]});const _0x48c61c=path_1[_0x4bef69(0x154)][_0x4bef69(0x149)](_0x596de9,_0x1237f8);_0x4cdbbb?_0x4711e7!==_0x48c61c&&await fs_1[_0x4bef69(0x154)][_0x4bef69(0x19b)]['rename'](_0x4711e7,_0x48c61c):await fs_1['default'][_0x4bef69(0x19b)][_0x4bef69(0x19a)](_0x48c61c,new Uint8Array(_0x1576a5));const _0x3de775=_0x4bef69(0x165)+_0x2d9a84+'/'+_0x530d45+'/'+_0x1237f8;return{'url':_0x3de775,'storageType':_0x4bef69(0x10e)};}static async['deleteFile'](_0x573da7,_0x110427){const _0x2a82b2=a643_0x4c85ff;if(_0x110427['startsWith'](_0x2a82b2(0x115))||_0x110427[_0x2a82b2(0x1b7)](_0x2a82b2(0x191))){const _0xd8faf0=await getGlobalMinioConfig();if(_0xd8faf0)try{const _0x2f0654=createMinioClient(_0xd8faf0),_0x48407b=await getCompanyBucketName(_0xd8faf0['bucket'],_0x573da7),_0x453232=new URL(_0x110427),_0x4f3563=_0x453232['pathname'][_0x2a82b2(0x1b1)]('/'),_0x2e7a8a=_0x4f3563['slice'](0x2)['join']('/');return await _0x2f0654[_0x2a82b2(0x10c)](_0x48407b,_0x2e7a8a),{'success':!![]};}catch(_0x2cab0f){return console['error'](_0x2a82b2(0x138),_0x2cab0f),{'success':![]};}}const _0x3e6db7=path_1['default']['join'](storage_1[_0x2a82b2(0x154)][_0x2a82b2(0x150)],_0x110427);if(fs_1[_0x2a82b2(0x154)][_0x2a82b2(0x198)](_0x3e6db7))try{return await fs_1[_0x2a82b2(0x154)][_0x2a82b2(0x19b)]['unlink'](_0x3e6db7),{'success':!![]};}catch(_0x2e82f1){return console['error'](_0x2a82b2(0x10d),_0x2e82f1),{'success':![]};}return{'success':!![]};}static async[a643_0x4c85ff(0x110)](_0x38ae75,_0x1ba970,_0x11cbc5,_0x5cc7fe,_0x5af36e){const _0x2bbb7a=a643_0x4c85ff,_0x42becc=await getGlobalMinioConfig(),_0x1f8248=typeof _0x5cc7fe==='string'?Buffer[_0x2bbb7a(0x131)](_0x5cc7fe,_0x2bbb7a(0x145)):_0x5cc7fe;if(_0x42becc)try{const _0x1918bd=createMinioClient(_0x42becc),_0x23abc6=await getCompanyBucketName(_0x42becc[_0x2bbb7a(0x1a3)],_0x38ae75),_0xcb9c8b=await _0x1918bd['bucketExists'](_0x23abc6);if(!_0xcb9c8b){const _0x4c8a8f=await getStorageLimit(_0x38ae75);await createMinioBucketForCompany(_0x1918bd,_0x23abc6,_0x4c8a8f);}const _0x1be45b=_0x2bbb7a(0x108)+_0x1ba970+'/'+_0x11cbc5,_0x507bd1=_0x5af36e?{'Content-Type':_0x5af36e}:{};await _0x1918bd[_0x2bbb7a(0x102)](_0x23abc6,_0x1be45b,_0x1f8248,_0x1f8248[_0x2bbb7a(0x105)],_0x507bd1);let _0x22fd41=_0x42becc[_0x2bbb7a(0x146)];if(_0x22fd41['startsWith'](_0x2bbb7a(0x191)))_0x22fd41=_0x22fd41[_0x2bbb7a(0x12d)](_0x2bbb7a(0x191),'');else _0x22fd41[_0x2bbb7a(0x1b7)]('http://')&&(_0x22fd41=_0x22fd41[_0x2bbb7a(0x12d)]('http://',''));const _0x5d65f7=_0x42becc[_0x2bbb7a(0x17d)]||_0x42becc[_0x2bbb7a(0x175)]===0x1bb?'https':_0x2bbb7a(0x18e),_0x206773=_0x42becc[_0x2bbb7a(0x175)]===0x50||_0x42becc[_0x2bbb7a(0x175)]===0x1bb?'':':'+_0x42becc[_0x2bbb7a(0x175)],_0x5b90da=_0x5d65f7+'://'+_0x22fd41+_0x206773+'/'+_0x23abc6+'/'+_0x1be45b;return{'url':_0x5b90da,'storageType':_0x2bbb7a(0x15c)};}catch(_0x2ab87c){console[_0x2bbb7a(0x16c)]('Erro\x20ao\x20fazer\x20upload\x20para\x20MinIO:',_0x2ab87c);throw _0x2ab87c;}const _0x10786c=storage_1[_0x2bbb7a(0x154)]['directory'],_0x528403=path_1[_0x2bbb7a(0x154)][_0x2bbb7a(0x149)](_0x10786c,_0x2bbb7a(0x181),String(_0x38ae75),_0x1ba970);!fs_1[_0x2bbb7a(0x154)]['existsSync'](_0x528403)&&await mkdir(_0x528403,{'recursive':!![]});const _0x43a8b3=path_1[_0x2bbb7a(0x154)]['join'](_0x528403,_0x11cbc5);await fs_1[_0x2bbb7a(0x154)][_0x2bbb7a(0x19b)][_0x2bbb7a(0x19a)](_0x43a8b3,new Uint8Array(_0x1f8248));const _0x21b079=_0x2bbb7a(0x165)+_0x38ae75+'/'+_0x1ba970+'/'+_0x11cbc5;return{'url':_0x21b079,'storageType':'local'};}static async['isMinioConfigured'](){const _0x45a00f=await getGlobalMinioConfig();return _0x45a00f!==null;}static async[a643_0x4c85ff(0x153)](_0x18614c){const _0x3ee7ab=a643_0x4c85ff;try{const _0x5af2b6=createMinioClient(_0x18614c);return await _0x5af2b6[_0x3ee7ab(0x139)](),{'success':!![],'message':_0x3ee7ab(0x1b0)};}catch(_0x1236bc){console['error'](_0x3ee7ab(0x16f),_0x1236bc);let _0x3eb54a=_0x3ee7ab(0x1ab);if(_0x1236bc[_0x3ee7ab(0x15b)]===_0x3ee7ab(0x107))_0x3eb54a=_0x3ee7ab(0x177);else{if(_0x1236bc[_0x3ee7ab(0x15b)]===_0x3ee7ab(0x155))_0x3eb54a=_0x3ee7ab(0x117);else{if(_0x1236bc['code']===_0x3ee7ab(0x128))_0x3eb54a=_0x3ee7ab(0x1a0);else{if(_0x1236bc[_0x3ee7ab(0x15b)]===_0x3ee7ab(0x13d))_0x3eb54a='Endpoint\x20\x22'+_0x18614c[_0x3ee7ab(0x146)]+_0x3ee7ab(0x1ac);else{if(_0x1236bc[_0x3ee7ab(0x15b)]==='ECONNREFUSED')_0x3eb54a=_0x3ee7ab(0x185)+_0x18614c['endPoint']+':'+_0x18614c[_0x3ee7ab(0x175)];else _0x1236bc['message']&&(_0x3eb54a=_0x1236bc[_0x3ee7ab(0x15a)]);}}}}return{'success':![],'message':_0x3eb54a};}}static async[a643_0x4c85ff(0x1a5)](){const _0x156cac=a643_0x4c85ff,_0x57a0d4=await getGlobalMinioConfig();if(!_0x57a0d4)return{'buckets':[],'error':_0x156cac(0x100)};try{const _0x10dc0d=createMinioClient(_0x57a0d4),_0x455221=await _0x10dc0d[_0x156cac(0x139)](),_0xb998f5=_0x57a0d4[_0x156cac(0x1a3)][_0x156cac(0x120)](),_0x32d839=_0x455221[_0x156cac(0x180)](_0x25d70d=>_0x25d70d['name']['startsWith'](_0xb998f5+'-'))['map'](_0x58947b=>_0x58947b['name']);return{'buckets':_0x32d839};}catch(_0x7a09ea){return console['error'](_0x156cac(0x168),_0x7a09ea),{'buckets':[],'error':_0x7a09ea['message']};}}static async['deleteCompanyBucket'](_0x14a530){const _0x43b44b=a643_0x4c85ff,_0x26b093=await getGlobalMinioConfig();if(!_0x26b093)return{'success':![],'message':'MinIO\x20não\x20configurado'};try{const _0x3f89f4=createMinioClient(_0x26b093),_0x55f16e=await getCompanyBucketName(_0x26b093[_0x43b44b(0x1a3)],_0x14a530),_0x10866b=await _0x3f89f4['bucketExists'](_0x55f16e);if(!_0x10866b)return{'success':!![],'message':_0x43b44b(0x197)};const _0x2db141=[],_0x14eefd=_0x3f89f4[_0x43b44b(0x112)](_0x55f16e,'',!![]);return await new Promise((_0x1b0990,_0x334609)=>{const _0x353c41=_0x43b44b;_0x14eefd['on']('data',_0x3f5989=>{const _0x3445cf=a643_0x560f;if(_0x3f5989[_0x3445cf(0x12f)])_0x2db141[_0x3445cf(0x10b)](_0x3f5989[_0x3445cf(0x12f)]);}),_0x14eefd['on'](_0x353c41(0x16c),_0x334609),_0x14eefd['on'](_0x353c41(0x18a),_0x1b0990);}),_0x2db141[_0x43b44b(0x105)]>0x0&&await _0x3f89f4[_0x43b44b(0x10f)](_0x55f16e,_0x2db141),await _0x3f89f4[_0x43b44b(0x183)](_0x55f16e),{'success':!![],'message':_0x43b44b(0x159)+_0x55f16e+_0x43b44b(0x190)};}catch(_0x30f253){return console['error'](_0x43b44b(0xfe),_0x30f253),{'success':![],'message':_0x30f253[_0x43b44b(0x15a)]};}}static async[a643_0x4c85ff(0x1a8)](_0x132ffd,_0x2f9c51){const _0x12e3d0=a643_0x4c85ff,_0x1f1626=await getGlobalMinioConfig();if(!_0x1f1626)return{'success':![],'message':_0x12e3d0(0x100)};const _0x4b09d5=await getCompanyBucketName(_0x1f1626[_0x12e3d0(0x1a3)],_0x132ffd);return console[_0x12e3d0(0x140)]('Quota\x20do\x20bucket\x20'+_0x4b09d5+_0x12e3d0(0x132)+_0x2f9c51+'GB'),console[_0x12e3d0(0x140)](_0x12e3d0(0x11d)),{'success':!![],'message':_0x12e3d0(0x14d)+_0x2f9c51+_0x12e3d0(0x113)+_0x4b09d5+',\x20configure\x20via\x20console\x20MinIO\x20ou\x20use:\x20mc\x20admin\x20bucket\x20quota\x20ALIAS/'+_0x4b09d5+'\x20--hard\x20'+_0x2f9c51+'GB'};}}exports['default']=StorageService;function a643_0x560f(_0x18f654,_0xb39d1b){const _0x1f6011=a643_0x51ed();return a643_0x560f=function(_0x489214,_0x6168ea){_0x489214=_0x489214-0xfe;let _0x51ed08=_0x1f6011[_0x489214];return _0x51ed08;},a643_0x560f(_0x18f654,_0xb39d1b);}function a643_0x51ed(){const _0x294e0f=['Conexão\x20estabelecida\x20com\x20sucesso!','split','bucketExists','fileCount','Allow','value','util','startsWith','__createBinding','Erro\x20ao\x20deletar\x20bucket:','Erro\x20ao\x20limpar\x20pasta:','MinIO\x20não\x20configurado','2012-10-17','putObject','Outros\x20(arquivos\x20na\x20raiz)','data','length','canUpload','MovedPermanently','tickets/','Pasta\x20limpa\x20com\x20sucesso','Erro\x20ao\x20calcular\x20tamanho\x20da\x20pasta\x20','push','removeObject','Erro\x20ao\x20deletar\x20arquivo\x20local:','local','removeObjects','uploadTicketMedia','74450pFBNCT','listObjects','GB\x20no\x20bucket\x20',',\x20pode=','http://','stat','Access\x20Key\x20inválida','minioUseSSL','totalUsed','defineProperty','storageLimitBytes','toString','Nota:\x20Configure\x20a\x20quota\x20manualmente\x20no\x20console\x20do\x20MinIO\x20ou\x20via\x20mc\x20admin','7txdnDL','3024jvARva','toLowerCase','create','Campanhas','forEach','mkdir','FlowBuilder','storageLimit','plan','SignatureDoesNotMatch','unlink','promisify','bucketName','entries','replace','hasOwnProperty','name','../../models/Setting','from','\x20deve\x20ser\x20atualizada\x20para\x20','Pasta\x20já\x20está\x20vazia',',\x20files=','writable','Bytes','round','Erro\x20ao\x20deletar\x20arquivo\x20do\x20MinIO:','listBuckets','pow','toFixed','Kanban','ENOTFOUND','../../models/Company','2982498fJrVYe','log','Erro\x20ao\x20obter\x20configuração\x20global\x20MinIO:','Filas','Erro\x20ao\x20limpar\x20pasta\x20no\x20MinIO:',':\x20usado=','base64','endPoint','readFile','STORAGE_FOLDERS','join',',\x20limit=','\x20criado\x20com\x20sucesso','0\x20Bytes','Para\x20aplicar\x20quota\x20de\x20','https','minioAccessKey','directory','7280760vvPILj','company','testMinioConnection','default','InvalidAccessKeyId','s3:GetObject','Conexões','../../models/Plan','Bucket\x20','message','code','minio',',\x20limite=','minioEndpoint','5070395sMWqRD','/.keep',':\x20path=','uploadFile','Erro\x20ao\x20acessar\x20MinIO,\x20usando\x20local:','4XfcBmG','media/','[StorageService]\x20getStorageUsage\x20LOCAL:\x20companyPath=','keys','Erro\x20ao\x20listar\x20buckets:','Tickets','Client','[canUpload]\x20Company\x20','error','reduce','setBucketPolicy','Erro\x20ao\x20testar\x20conexão\x20MinIO:','clearFolder','Erro\x20ao\x20buscar\x20bucket\x20da\x20empresa:','prototype','floor','Erro\x20ao\x20limpar\x20pasta','port','createCompanyStorage','Erro\x20de\x20redirecionamento.\x20Verifique\x20se\x20a\x20configuração\x20SSL\x20está\x20correta.','outros','Erro\x20ao\x20obter\x20limite\x20de\x20armazenamento:','[StorageService]\x20getCompanyPath:\x20storageConfig.directory=','accessKey','key','useSSL','[StorageService]\x20Pasta\x20outros:\x20size=','getStorageUsage','filter','media',',\x20exists=','removeBucket','get','Conexão\x20recusada\x20em\x20','Erro\x20ao\x20fazer\x20upload\x20para\x20o\x20armazenamento.\x20Verifique\x20a\x20configuração\x20do\x20MinIO.','(((.+)+)+)+$','://','size','end','findAll','search','apply','http','\x20criado\x20para\x20empresa\x20','\x20removido\x20com\x20sucesso','https://','true','Estrutura\x20de\x20pastas\x20criada\x20para\x20bucket\x20','[StorageService]\x20TOTAL\x20LOCAL:\x20totalUsed=','Lista\x20de\x20Campanhas','path','Bucket\x20não\x20existe','existsSync','44mAvXPq','writeFile','promises','getOwnPropertyNames','Empresa\x20(WhiteLabel)','minioBucket','../../errors/AppError','Secret\x20Key\x20inválida','16WdpCzE','12wyWCtj','bucket',',\x20arquivo=','listCompanyBuckets','__esModule','5329440rMyGQi','updateBucketQuota','findByPk','3857680RpgbaN','Erro\x20desconhecido\x20ao\x20conectar','\x22\x20não\x20encontrado.\x20Verifique\x20a\x20URL.','endsWith','Erro\x20ao\x20criar\x20bucket\x20MinIO\x20para\x20empresa\x20','call'];a643_0x51ed=function(){return _0x294e0f;};return a643_0x51ed();}