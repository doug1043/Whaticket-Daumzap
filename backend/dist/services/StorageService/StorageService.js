'use strict';function a644_0x16b7(_0x9b19d4,_0x4a4e1a){const _0x4e82d1=a644_0x3918();return a644_0x16b7=function(_0x2cc971,_0x1387de){_0x2cc971=_0x2cc971-0x18f;let _0x39188b=_0x4e82d1[_0x2cc971];return _0x39188b;},a644_0x16b7(_0x9b19d4,_0x4a4e1a);}const a644_0x8c74a5=a644_0x16b7;(function(_0x1816b9,_0x12d402){const _0x2ad43c=a644_0x16b7,_0x4aa972=_0x1816b9();while(!![]){try{const _0xb1a4d6=-parseInt(_0x2ad43c(0x1ca))/0x1*(-parseInt(_0x2ad43c(0x1c1))/0x2)+parseInt(_0x2ad43c(0x1d7))/0x3+parseInt(_0x2ad43c(0x1d0))/0x4+-parseInt(_0x2ad43c(0x236))/0x5+parseInt(_0x2ad43c(0x1ac))/0x6*(parseInt(_0x2ad43c(0x1d4))/0x7)+parseInt(_0x2ad43c(0x242))/0x8*(parseInt(_0x2ad43c(0x213))/0x9)+parseInt(_0x2ad43c(0x19a))/0xa*(-parseInt(_0x2ad43c(0x23d))/0xb);if(_0xb1a4d6===_0x12d402)break;else _0x4aa972['push'](_0x4aa972['shift']());}catch(_0x3ea501){_0x4aa972['push'](_0x4aa972['shift']());}}}(a644_0x3918,0x48385));var __createBinding=this&&this['__createBinding']||(Object[a644_0x8c74a5(0x1af)]?function(_0x45f644,_0x1b6932,_0x4efb6d,_0x37b3cc){const _0x274d0e=a644_0x8c74a5;if(_0x37b3cc===undefined)_0x37b3cc=_0x4efb6d;var _0x311a73=Object[_0x274d0e(0x209)](_0x1b6932,_0x4efb6d);(!_0x311a73||(_0x274d0e(0x1ab)in _0x311a73?!_0x1b6932['__esModule']:_0x311a73[_0x274d0e(0x227)]||_0x311a73[_0x274d0e(0x23f)]))&&(_0x311a73={'enumerable':!![],'get':function(){return _0x1b6932[_0x4efb6d];}}),Object['defineProperty'](_0x45f644,_0x37b3cc,_0x311a73);}:function(_0x436b4b,_0x4b139b,_0x496593,_0x476c41){if(_0x476c41===undefined)_0x476c41=_0x496593;_0x436b4b[_0x476c41]=_0x4b139b[_0x496593];}),__setModuleDefault=this&&this[a644_0x8c74a5(0x1ef)]||(Object[a644_0x8c74a5(0x1af)]?function(_0x1f60cc,_0x48f0fc){const _0x2a1508=a644_0x8c74a5;Object[_0x2a1508(0x247)](_0x1f60cc,'default',{'enumerable':!![],'value':_0x48f0fc});}:function(_0x484c45,_0x4a9ce5){const _0x51edef=a644_0x8c74a5;_0x484c45[_0x51edef(0x22f)]=_0x4a9ce5;}),__importStar=this&&this['__importStar']||(function(){const _0x3a871e=(function(){let _0x1b2763=!![];return function(_0x2815e4,_0x40e982){const _0x17b47e=_0x1b2763?function(){const _0x1c782b=a644_0x16b7;if(_0x40e982){const _0x56a4ce=_0x40e982[_0x1c782b(0x1cd)](_0x2815e4,arguments);return _0x40e982=null,_0x56a4ce;}}:function(){};return _0x1b2763=![],_0x17b47e;};}()),_0x5a9724=_0x3a871e(this,function(){const _0x5ebbf4=a644_0x16b7;return _0x5a9724[_0x5ebbf4(0x223)]()[_0x5ebbf4(0x245)](_0x5ebbf4(0x198))[_0x5ebbf4(0x223)]()['constructor'](_0x5a9724)[_0x5ebbf4(0x245)]('(((.+)+)+)+$');});_0x5a9724();var _0x494786=function(_0x348685){const _0x1e4e18=a644_0x16b7;return _0x494786=Object[_0x1e4e18(0x22c)]||function(_0x52f558){const _0x46c1e1=_0x1e4e18;var _0x1feae2=[];for(var _0x369ca9 in _0x52f558)if(Object[_0x46c1e1(0x18f)]['hasOwnProperty']['call'](_0x52f558,_0x369ca9))_0x1feae2[_0x1feae2[_0x46c1e1(0x1f9)]]=_0x369ca9;return _0x1feae2;},_0x494786(_0x348685);};return function(_0x3ff570){const _0x4eec99=a644_0x16b7;if(_0x3ff570&&_0x3ff570[_0x4eec99(0x1e5)])return _0x3ff570;var _0x4f0d8a={};if(_0x3ff570!=null){for(var _0x3ebdfc=_0x494786(_0x3ff570),_0x52acbb=0x0;_0x52acbb<_0x3ebdfc[_0x4eec99(0x1f9)];_0x52acbb++)if(_0x3ebdfc[_0x52acbb]!==_0x4eec99(0x22f))__createBinding(_0x4f0d8a,_0x3ff570,_0x3ebdfc[_0x52acbb]);}return __setModuleDefault(_0x4f0d8a,_0x3ff570),_0x4f0d8a;};}()),__importDefault=this&&this[a644_0x8c74a5(0x1db)]||function(_0x2709bc){const _0x499992=a644_0x8c74a5;return _0x2709bc&&_0x2709bc[_0x499992(0x1e5)]?_0x2709bc:{'default':_0x2709bc};};function a644_0x3918(){const _0x3edfe5=['[canUpload]\x20Company\x20','FlowBuilder','ECONNREFUSED','Erro\x20ao\x20limpar\x20pasta\x20no\x20MinIO:','[StorageService]\x20TOTAL\x20LOCAL:\x20totalUsed=','keys','__setModuleDefault','\x20arquivo(s)\x20removido(s)\x20com\x20sucesso','listObjects','data','replace','SignatureDoesNotMatch','media/','Erro\x20ao\x20buscar\x20bucket\x20da\x20empresa:','Erro\x20ao\x20listar\x20objetos\x20MinIO:','Pasta\x20limpa\x20com\x20sucesso','length','\x20criado\x20para\x20empresa\x20','Erro\x20ao\x20criar\x20bucket\x20','useSSL','tickets/','Para\x20aplicar\x20quota\x20de\x20','Erro\x20de\x20redirecionamento.\x20Verifique\x20se\x20a\x20configuração\x20SSL\x20está\x20correta.',',\x20files=','MinIO\x20não\x20configurado','bucketExists','Lista\x20de\x20Campanhas','media','Access\x20Key\x20inválida','http://','listCompanyBuckets','Nota:\x20Configure\x20a\x20quota\x20manualmente\x20no\x20console\x20do\x20MinIO\x20ou\x20via\x20mc\x20admin','getOwnPropertyDescriptor','\x22\x20não\x20encontrado.\x20Verifique\x20a\x20URL.','removeObject','Bytes','slice','Pasta\x20já\x20está\x20vazia',',\x20exists=','Erro\x20ao\x20acessar\x20MinIO,\x20usando\x20local:','STORAGE_FOLDERS','error','20295Wynmas','readdir','listBuckets','https://','local',',\x20percentage=','uploadTicketMedia','writeFile','filter','string','/.keep','Outros\x20(arquivos\x20antigos/migração)','outros','stringify','minioEndpoint','end','toString','Erro\x20ao\x20deletar\x20arquivo\x20do\x20MinIO:','9000','join','writable',',\x20pode=','Erro\x20ao\x20deletar\x20arquivo\x20local:','key','canUpload','getOwnPropertyNames',',\x20limite=','readFile','default','Bucket\x20não\x20existe','Erro\x20ao\x20fazer\x20upload\x20para\x20o\x20armazenamento.\x20Verifique\x20a\x20configuração\x20do\x20MinIO.','entries','totalUsed','promises','Política\x20de\x20acesso\x20configurada\x20para\x20','2349710hCNgoY','startsWith','bucket','toFixed','://','Endpoint\x20\x22','accessKey','11InZTmY','plan','configurable','reduce','Client','184waqluG','Erro\x20ao\x20calcular\x20tamanho\x20da\x20pasta\x20','putObject','search','GB\x20no\x20bucket\x20','defineProperty','size','Erro\x20ao\x20testar\x20conexão\x20MinIO:','minioPort',',\x20companyPath=','../../models/Plan','../../config/storage','message','prototype','s3:GetObject','Kanban','existsSync','Estrutura\x20de\x20pastas\x20criada\x20para\x20bucket\x20','../../models/Company','forEach','util','Conexão\x20estabelecida\x20com\x20sucesso!','(((.+)+)+)+$','code','439870HNobtB','ENOTFOUND','findByPk','promisify','http','pathname','/tickets/','updateBucketQuota','../../models/Setting','company','endPoint','Conexão\x20recusada\x20em\x20','push','[StorageService]\x20getCompanyPath:\x20storageConfig.directory=','unlink','Uploads','pow','get','1590jHOWIS','Conexões','minioSecretKey','create','minioUseSSL','uploadFile','Secret\x20Key\x20inválida','map','true','\x20criado\x20com\x20sucesso','\x20deve\x20ser\x20atualizada\x20para\x20','Filas','Campanhas','Erro\x20ao\x20obter\x20limite\x20de\x20armazenamento:','2012-10-17','Allow','Erro\x20ao\x20deletar\x20bucket:','setBucketPolicy',',\x20size=','fileCount','value','4mSsveB','round','toLowerCase','https','[StorageService]\x20Pasta\x20','port','minio','Bucket\x20','findAll','67763ExVnwA','Tickets','Erro\x20ao\x20criar\x20bucket\x20MinIO\x20para\x20empresa\x20','apply','from','removeObjects','141256PqLDvh','stat','deleteFile','makeBucket','9219sqcYjo','log',':\x20path=','714096chbqlO','directory','Pasta\x20não\x20encontrada','\x20--hard\x20','__importDefault','storageLimitBytes','../../errors/AppError','name','storageLimit',',\x20arquivo=','bucketName','minioBucket','createCompanyStorage','Erro\x20ao\x20fazer\x20upload\x20para\x20MinIO:','__esModule','Bucket\x20MinIO\x20','endsWith','clearFolder'];a644_0x3918=function(){return _0x3edfe5;};return a644_0x3918();}Object[a644_0x8c74a5(0x247)](exports,a644_0x8c74a5(0x1e5),{'value':!![]});const Minio=__importStar(require(a644_0x8c74a5(0x1c7))),fs_1=__importDefault(require('fs')),path_1=__importDefault(require('path')),util_1=require(a644_0x8c74a5(0x196)),storage_1=__importStar(require(a644_0x8c74a5(0x24d))),Setting_1=__importDefault(require(a644_0x8c74a5(0x1a2))),Company_1=__importDefault(require(a644_0x8c74a5(0x194))),Plan_1=__importDefault(require(a644_0x8c74a5(0x24c))),AppError_1=__importDefault(require(a644_0x8c74a5(0x1dd))),readdir=(0x0,util_1[a644_0x8c74a5(0x19d)])(fs_1[a644_0x8c74a5(0x22f)][a644_0x8c74a5(0x214)]),stat=(0x0,util_1[a644_0x8c74a5(0x19d)])(fs_1[a644_0x8c74a5(0x22f)][a644_0x8c74a5(0x1d1)]),mkdir=(0x0,util_1[a644_0x8c74a5(0x19d)])(fs_1[a644_0x8c74a5(0x22f)]['mkdir']),rmdir=(0x0,util_1['promisify'])(fs_1['default']['rm']),formatBytes=_0x552887=>{const _0x5ee7cf=a644_0x8c74a5;if(_0x552887===0x0)return'0\x20Bytes';const _0x5d7dcf=0x400,_0x4ebe52=[_0x5ee7cf(0x20c),'KB','MB','GB','TB'],_0x96bc9e=Math['floor'](Math['log'](_0x552887)/Math[_0x5ee7cf(0x1d5)](_0x5d7dcf));return parseFloat((_0x552887/Math[_0x5ee7cf(0x1aa)](_0x5d7dcf,_0x96bc9e))[_0x5ee7cf(0x239)](0x2))+'\x20'+_0x4ebe52[_0x96bc9e];},getGlobalMinioConfig=async()=>{const _0x4af3a5=a644_0x8c74a5;try{const _0x5ea5bc=await Setting_1[_0x4af3a5(0x22f)][_0x4af3a5(0x1c9)]({'where':{'companyId':0x1},'attributes':[_0x4af3a5(0x22a),_0x4af3a5(0x1c0)]}),_0x37e41f={};_0x5ea5bc[_0x4af3a5(0x195)](_0x1b7bed=>{const _0x5dce17=_0x4af3a5;_0x37e41f[_0x1b7bed[_0x5dce17(0x22a)]]=_0x1b7bed[_0x5dce17(0x1c0)];});const _0x229c8e=_0x37e41f[_0x4af3a5(0x221)],_0x4f5a23=_0x37e41f['minioAccessKey'],_0x3762ae=_0x37e41f[_0x4af3a5(0x1ae)],_0x5a4595=_0x37e41f[_0x4af3a5(0x1e2)]||_0x4af3a5(0x1a3),_0x39de6f=parseInt(_0x37e41f[_0x4af3a5(0x24a)]||_0x4af3a5(0x225),0xa),_0x57ab4b=_0x37e41f[_0x4af3a5(0x1b0)]===_0x4af3a5(0x1b4);if(!_0x229c8e||!_0x4f5a23||!_0x3762ae)return null;return{'endPoint':_0x229c8e,'port':_0x39de6f,'useSSL':_0x57ab4b,'accessKey':_0x4f5a23,'secretKey':_0x3762ae,'bucket':_0x5a4595};}catch(_0x155b83){return console[_0x4af3a5(0x212)]('Erro\x20ao\x20obter\x20configuração\x20global\x20MinIO:',_0x155b83),null;}},getCompanyBucketName=async(_0x3fc087,_0x2251a9)=>{const _0xfb944d=a644_0x8c74a5;try{const _0x1ed7ad=await Company_1[_0xfb944d(0x22f)][_0xfb944d(0x19c)](_0x2251a9,{'attributes':[_0xfb944d(0x1e1)]});if(_0x1ed7ad?.['bucketName'])return _0x1ed7ad[_0xfb944d(0x1e1)][_0xfb944d(0x1c3)]();}catch(_0x5282f1){console[_0xfb944d(0x212)](_0xfb944d(0x1f6),_0x5282f1);}return _0x3fc087['toLowerCase']()+'-'+_0x2251a9;},getCompanyBucketNameSync=(_0x438fde,_0x1cabe1)=>{const _0x46aa64=a644_0x8c74a5;return _0x438fde[_0x46aa64(0x1c3)]()+'-'+_0x1cabe1;},createMinioClient=_0x2ed82f=>{const _0x18cced=a644_0x8c74a5;let _0x4f69ed=_0x2ed82f[_0x18cced(0x1a4)],_0x1de893=_0x2ed82f[_0x18cced(0x1fc)];if(_0x4f69ed[_0x18cced(0x237)](_0x18cced(0x216)))_0x4f69ed=_0x4f69ed[_0x18cced(0x1f3)]('https://',''),_0x1de893=!![];else _0x4f69ed['startsWith'](_0x18cced(0x206))&&(_0x4f69ed=_0x4f69ed[_0x18cced(0x1f3)](_0x18cced(0x206),''),_0x1de893=![]);_0x4f69ed=_0x4f69ed[_0x18cced(0x1f3)](/\/$/,'');if(_0x2ed82f[_0x18cced(0x1c6)]===0x1bb)_0x1de893=!![];else _0x2ed82f[_0x18cced(0x1c6)]===0x50&&(_0x1de893=![]);return new Minio[(_0x18cced(0x241))]({'endPoint':_0x4f69ed,'port':_0x2ed82f[_0x18cced(0x1c6)],'useSSL':_0x1de893,'accessKey':_0x2ed82f[_0x18cced(0x23c)],'secretKey':_0x2ed82f['secretKey']});},getFolderSize=async _0x53365=>{const _0x1249e9=a644_0x8c74a5;let _0x48b119=0x0,_0x5b19de=0x0;try{if(!fs_1[_0x1249e9(0x22f)]['existsSync'](_0x53365))return{'size':0x0,'fileCount':0x0};const _0x3b7e79=await readdir(_0x53365);for(const _0x5ca486 of _0x3b7e79){const _0x207686=path_1[_0x1249e9(0x22f)][_0x1249e9(0x226)](_0x53365,_0x5ca486),_0x1eb0ac=await stat(_0x207686);if(_0x1eb0ac['isDirectory']()){const _0x4e10dd=await getFolderSize(_0x207686);_0x48b119+=_0x4e10dd[_0x1249e9(0x248)],_0x5b19de+=_0x4e10dd[_0x1249e9(0x1bf)];}else _0x48b119+=_0x1eb0ac['size'],_0x5b19de++;}}catch(_0x43a641){console[_0x1249e9(0x212)](_0x1249e9(0x243)+_0x53365+':',_0x43a641);}return{'size':_0x48b119,'fileCount':_0x5b19de};},getMinioFolderSize=async(_0x948967,_0x486bd0,_0x3a85ce)=>{return new Promise(_0x840e6=>{const _0x16e1d6=a644_0x16b7;let _0xa9f8ef=0x0,_0x3622b4=0x0;const _0x2526c5=_0x948967[_0x16e1d6(0x1f1)](_0x486bd0,_0x3a85ce,!![]);_0x2526c5['on']('data',_0x243628=>{const _0xa31cec=_0x16e1d6;_0xa9f8ef+=_0x243628[_0xa31cec(0x248)]||0x0,_0x3622b4++;}),_0x2526c5['on'](_0x16e1d6(0x212),_0x166a36=>{const _0x4b7e76=_0x16e1d6;console[_0x4b7e76(0x212)](_0x4b7e76(0x1f7),_0x166a36),_0x840e6({'size':0x0,'fileCount':0x0});}),_0x2526c5['on'](_0x16e1d6(0x222),()=>{_0x840e6({'size':_0xa9f8ef,'fileCount':_0x3622b4});});});},getStorageLimit=async _0x538751=>{const _0x1498a6=a644_0x8c74a5;try{const _0x373453=await Company_1[_0x1498a6(0x22f)][_0x1498a6(0x19c)](_0x538751,{'include':[{'model':Plan_1[_0x1498a6(0x22f)],'as':_0x1498a6(0x23e)}]});if(_0x373453?.[_0x1498a6(0x23e)]?.[_0x1498a6(0x1df)])return _0x373453[_0x1498a6(0x23e)][_0x1498a6(0x1df)];return 0xa;}catch(_0x4ea30e){return console[_0x1498a6(0x212)](_0x1498a6(0x1b9),_0x4ea30e),0xa;}},getCompanyPath=_0xc8fb8a=>{const _0x117a5a=a644_0x8c74a5,_0x572e4b=path_1[_0x117a5a(0x22f)]['join'](storage_1[_0x117a5a(0x22f)][_0x117a5a(0x1d8)],_0x117a5a(0x204),String(_0xc8fb8a));return console[_0x117a5a(0x1d5)](_0x117a5a(0x1a7)+storage_1['default'][_0x117a5a(0x1d8)]+_0x117a5a(0x24b)+_0x572e4b),_0x572e4b;},createLocalFolderStructure=async _0x45f02c=>{const _0x4e588a=a644_0x8c74a5,_0x4ba00d=getCompanyPath(_0x45f02c);await mkdir(_0x4ba00d,{'recursive':!![]});for(const _0x3a7b3d of Object[_0x4e588a(0x1ee)](storage_1[_0x4e588a(0x211)])){const _0x1919b8=path_1[_0x4e588a(0x22f)]['join'](_0x4ba00d,storage_1[_0x4e588a(0x211)][_0x3a7b3d]);await mkdir(_0x1919b8,{'recursive':!![]});}},createMinioBucketForCompany=async(_0x553b3e,_0x51e5f3,_0x2be22d)=>{const _0x25c2ac=a644_0x8c74a5;try{const _0x320f3d=await _0x553b3e['bucketExists'](_0x51e5f3);if(!_0x320f3d){await _0x553b3e[_0x25c2ac(0x1d3)](_0x51e5f3),console[_0x25c2ac(0x1d5)](_0x25c2ac(0x1c8)+_0x51e5f3+_0x25c2ac(0x1b5));const _0x4295e1={'Version':_0x25c2ac(0x1ba),'Statement':[{'Effect':_0x25c2ac(0x1bb),'Principal':{'AWS':['*']},'Action':[_0x25c2ac(0x190)],'Resource':['arn:aws:s3:::'+_0x51e5f3+'/*']}]};await _0x553b3e[_0x25c2ac(0x1bd)](_0x51e5f3,JSON[_0x25c2ac(0x220)](_0x4295e1)),console[_0x25c2ac(0x1d5)](_0x25c2ac(0x235)+_0x51e5f3);}for(const _0x29fb2f of Object[_0x25c2ac(0x1ee)](storage_1['STORAGE_FOLDERS'])){const _0x13e1a5=storage_1[_0x25c2ac(0x211)][_0x29fb2f]+'/.keep';try{await _0x553b3e[_0x25c2ac(0x244)](_0x51e5f3,_0x13e1a5,Buffer[_0x25c2ac(0x1ce)](''),0x0);}catch(_0x190709){}}console[_0x25c2ac(0x1d5)](_0x25c2ac(0x193)+_0x51e5f3);}catch(_0xcccfc8){console[_0x25c2ac(0x212)](_0x25c2ac(0x1fb)+_0x51e5f3+':',_0xcccfc8);throw _0xcccfc8;}};class StorageService{static async[a644_0x8c74a5(0x1e3)](_0x45fac5){const _0x5a6547=a644_0x8c74a5,_0x19a804=await getGlobalMinioConfig();let _0x123081=![],_0x5b6ee3;if(_0x19a804)try{const _0xc140bb=createMinioClient(_0x19a804);_0x5b6ee3=await getCompanyBucketName(_0x19a804[_0x5a6547(0x238)],_0x45fac5);const _0x2c3efd=await getStorageLimit(_0x45fac5);await createMinioBucketForCompany(_0xc140bb,_0x5b6ee3,_0x2c3efd),_0x123081=!![],console[_0x5a6547(0x1d5)](_0x5a6547(0x1e6)+_0x5b6ee3+_0x5a6547(0x1fa)+_0x45fac5);}catch(_0x1682e2){console['error'](_0x5a6547(0x1cc)+_0x45fac5+':',_0x1682e2);}return await createLocalFolderStructure(_0x45fac5),{'bucketCreated':_0x123081,'bucketName':_0x5b6ee3};}static async['getStorageUsage'](_0x523229){const _0x414955=a644_0x8c74a5,_0x3fba4e=await getGlobalMinioConfig(),_0x59c20b=await getStorageLimit(_0x523229),_0x597544=_0x59c20b*0x400*0x400*0x400,_0xe9733=[];let _0x496e97=0x0;const _0xdeba97={'tickets':_0x414955(0x1cb),'uploads':_0x414955(0x1a9),'campanhas':_0x414955(0x1b8),'campanhasLista':_0x414955(0x203),'kanban':_0x414955(0x191),'empresa':'Empresa\x20(WhiteLabel)','conexao':_0x414955(0x1ad),'filas':_0x414955(0x1b7),'flowbuilder':_0x414955(0x1ea)};if(_0x3fba4e){const _0x54f6af=createMinioClient(_0x3fba4e),_0x457575=await getCompanyBucketName(_0x3fba4e[_0x414955(0x238)],_0x523229);try{const _0x5ca756=await _0x54f6af['bucketExists'](_0x457575);if(_0x5ca756){for(const [_0x14dec4,_0x5f35b4]of Object[_0x414955(0x232)](storage_1['STORAGE_FOLDERS'])){const _0x222eea=_0x5f35b4+'/',{size:_0x4efc4f,fileCount:_0x3f0248}=await getMinioFolderSize(_0x54f6af,_0x457575,_0x222eea);_0xe9733[_0x414955(0x1a6)]({'folder':_0x14dec4,'folderName':_0xdeba97[_0x14dec4]||_0x14dec4,'size':_0x4efc4f,'sizeFormatted':formatBytes(_0x4efc4f),'fileCount':_0x3f0248}),_0x496e97+=_0x4efc4f;}return{'storageType':_0x414955(0x1c7),'totalUsed':_0x496e97,'totalUsedFormatted':formatBytes(_0x496e97),'storageLimit':_0x59c20b,'storageLimitBytes':_0x597544,'usagePercentage':Math[_0x414955(0x1c2)](_0x496e97/_0x597544*0x64*0x64)/0x64,'folders':_0xe9733,'isLimitReached':_0x496e97>=_0x597544,'bucketName':_0x457575};}}catch(_0x1f2ca8){console[_0x414955(0x212)](_0x414955(0x210),_0x1f2ca8);}}const _0x2be82c=getCompanyPath(_0x523229);console[_0x414955(0x1d5)]('[StorageService]\x20getStorageUsage\x20LOCAL:\x20companyPath='+_0x2be82c+',\x20exists='+fs_1['default'][_0x414955(0x192)](_0x2be82c));for(const [_0x102620,_0x312ec6]of Object['entries'](storage_1['STORAGE_FOLDERS'])){const _0x43ded6=path_1[_0x414955(0x22f)][_0x414955(0x226)](_0x2be82c,_0x312ec6),_0x177c8e=fs_1[_0x414955(0x22f)][_0x414955(0x192)](_0x43ded6),{size:_0x23eba0,fileCount:_0x1ba62b}=await getFolderSize(_0x43ded6);console[_0x414955(0x1d5)](_0x414955(0x1c5)+_0x102620+_0x414955(0x1d6)+_0x43ded6+_0x414955(0x20f)+_0x177c8e+_0x414955(0x1be)+formatBytes(_0x23eba0)+_0x414955(0x200)+_0x1ba62b),_0xe9733[_0x414955(0x1a6)]({'folder':_0x102620,'folderName':_0xdeba97[_0x102620]||_0x102620,'size':_0x23eba0,'sizeFormatted':formatBytes(_0x23eba0),'fileCount':_0x1ba62b});}const {size:_0x581652,fileCount:_0x274ff4}=await getFolderSize(_0x2be82c);_0x496e97=_0x581652;const _0xdaa6c1=_0xe9733[_0x414955(0x240)]((_0x3d73d1,_0x44a4e2)=>_0x3d73d1+_0x44a4e2[_0x414955(0x248)],0x0),_0x1e55e8=_0x496e97-_0xdaa6c1;if(_0x1e55e8>0x0){const _0x2a4054=_0x274ff4-_0xe9733[_0x414955(0x240)]((_0x4ee567,_0xf12dd8)=>_0x4ee567+_0xf12dd8[_0x414955(0x1bf)],0x0);_0xe9733[_0x414955(0x1a6)]({'folder':_0x414955(0x21f),'folderName':_0x414955(0x21e),'size':_0x1e55e8,'sizeFormatted':formatBytes(_0x1e55e8),'fileCount':_0x2a4054}),console[_0x414955(0x1d5)]('[StorageService]\x20Arquivos\x20não\x20mapeados:\x20size='+formatBytes(_0x1e55e8)+_0x414955(0x200)+_0x2a4054);}return console[_0x414955(0x1d5)](_0x414955(0x1ed)+formatBytes(_0x496e97)+',\x20limit='+formatBytes(_0x597544)+_0x414955(0x218)+Math[_0x414955(0x1c2)](_0x496e97/_0x597544*0x64)+'%'),{'storageType':_0x414955(0x217),'totalUsed':_0x496e97,'totalUsedFormatted':formatBytes(_0x496e97),'storageLimit':_0x59c20b,'storageLimitBytes':_0x597544,'usagePercentage':Math[_0x414955(0x1c2)](_0x496e97/_0x597544*0x64*0x64)/0x64,'folders':_0xe9733,'isLimitReached':_0x496e97>=_0x597544};}static async[a644_0x8c74a5(0x22b)](_0x292e60,_0x1df7e5=0x0){const _0x22a96b=a644_0x8c74a5,_0x15187c=await this['getStorageUsage'](_0x292e60),_0x2a9fcd=_0x15187c['totalUsed']+_0x1df7e5<_0x15187c[_0x22a96b(0x1dc)];return console[_0x22a96b(0x1d5)](_0x22a96b(0x1e9)+_0x292e60+':\x20usado='+formatBytes(_0x15187c[_0x22a96b(0x233)])+_0x22a96b(0x22d)+formatBytes(_0x15187c[_0x22a96b(0x1dc)])+_0x22a96b(0x1e0)+formatBytes(_0x1df7e5)+_0x22a96b(0x228)+_0x2a9fcd),_0x2a9fcd;}static async[a644_0x8c74a5(0x1e8)](_0x42e940,_0x11ddfd){const _0x499777=a644_0x8c74a5,_0x58ce22=storage_1[_0x499777(0x211)][_0x11ddfd];if(!_0x58ce22)throw new AppError_1[(_0x499777(0x22f))](_0x499777(0x1d9),0x194);const _0x42c8c8=await getGlobalMinioConfig();if(_0x42c8c8){const _0x544131=createMinioClient(_0x42c8c8),_0x31f518=await getCompanyBucketName(_0x42c8c8[_0x499777(0x238)],_0x42e940);try{const _0x51fe08=await _0x544131['bucketExists'](_0x31f518);if(_0x51fe08){const _0x242c8f=_0x58ce22+'/';return new Promise((_0x2584d8,_0xc24ad7)=>{const _0x110601=_0x499777,_0x3d54d2=[],_0x2fcb71=_0x544131[_0x110601(0x1f1)](_0x31f518,_0x242c8f,!![]);_0x2fcb71['on'](_0x110601(0x1f2),_0x1564e3=>{const _0x573b68=_0x110601;_0x1564e3[_0x573b68(0x1de)]&&!_0x1564e3['name'][_0x573b68(0x1e7)](_0x573b68(0x21d))&&_0x3d54d2[_0x573b68(0x1a6)](_0x1564e3[_0x573b68(0x1de)]);}),_0x2fcb71['on']('error',_0x41831c=>{_0xc24ad7(_0x41831c);}),_0x2fcb71['on'](_0x110601(0x222),async()=>{const _0x255ee3=_0x110601;if(_0x3d54d2[_0x255ee3(0x1f9)]>0x0)try{await _0x544131[_0x255ee3(0x1cf)](_0x31f518,_0x3d54d2),_0x2584d8({'success':!![],'message':_0x3d54d2[_0x255ee3(0x1f9)]+_0x255ee3(0x1f0)});}catch(_0x1d8e99){_0xc24ad7(_0x1d8e99);}else _0x2584d8({'success':!![],'message':_0x255ee3(0x20e)});});});}}catch(_0x530a41){console['error'](_0x499777(0x1ec),_0x530a41);}}const _0x55193f=path_1[_0x499777(0x22f)][_0x499777(0x226)](getCompanyPath(_0x42e940),_0x58ce22);if(!fs_1['default'][_0x499777(0x192)](_0x55193f))return{'success':!![],'message':'Pasta\x20já\x20está\x20vazia'};try{return await rmdir(_0x55193f,{'recursive':!![]}),await mkdir(_0x55193f,{'recursive':!![]}),{'success':!![],'message':_0x499777(0x1f8)};}catch(_0x217260){console[_0x499777(0x212)]('Erro\x20ao\x20limpar\x20pasta:',_0x217260);throw new AppError_1[(_0x499777(0x22f))]('Erro\x20ao\x20limpar\x20pasta',0x1f4);}}static async[a644_0x8c74a5(0x1b1)](_0x40980c,_0x5987e7,_0x218159,_0x4b45f7,_0x4a38ce){const _0x2a90cc=a644_0x8c74a5,_0x2a46e9=await getGlobalMinioConfig();let _0x1d6ac8;const _0xc0ef8=typeof _0x4b45f7===_0x2a90cc(0x21c);_0xc0ef8?_0x1d6ac8=await fs_1[_0x2a90cc(0x22f)][_0x2a90cc(0x234)][_0x2a90cc(0x22e)](_0x4b45f7):_0x1d6ac8=_0x4b45f7;const _0xe77504=async()=>{const _0x2cf67a=_0x2a90cc;if(_0xc0ef8&&fs_1[_0x2cf67a(0x22f)]['existsSync'](_0x4b45f7))try{await fs_1[_0x2cf67a(0x22f)]['promises'][_0x2cf67a(0x1a8)](_0x4b45f7);}catch(_0x1d09f3){console[_0x2cf67a(0x212)]('Erro\x20ao\x20deletar\x20arquivo\x20temporário:',_0x1d09f3);}};if(_0x2a46e9)try{const _0x440d63=createMinioClient(_0x2a46e9),_0x22c67c=await getCompanyBucketName(_0x2a46e9[_0x2a90cc(0x238)],_0x40980c),_0x56555c=await _0x440d63[_0x2a90cc(0x202)](_0x22c67c);if(!_0x56555c){const _0x2156da=await getStorageLimit(_0x40980c);await createMinioBucketForCompany(_0x440d63,_0x22c67c,_0x2156da);}const _0x17facf=_0x5987e7+'/'+_0x218159,_0x1a8614=_0x4a38ce?{'Content-Type':_0x4a38ce}:{};await _0x440d63[_0x2a90cc(0x244)](_0x22c67c,_0x17facf,_0x1d6ac8,_0x1d6ac8[_0x2a90cc(0x1f9)],_0x1a8614);let _0x2bbde5=_0x2a46e9['endPoint'];if(_0x2bbde5[_0x2a90cc(0x237)](_0x2a90cc(0x216)))_0x2bbde5=_0x2bbde5[_0x2a90cc(0x1f3)]('https://','');else _0x2bbde5[_0x2a90cc(0x237)](_0x2a90cc(0x206))&&(_0x2bbde5=_0x2bbde5['replace']('http://',''));const _0x3e7520=_0x2a46e9[_0x2a90cc(0x1fc)]||_0x2a46e9[_0x2a90cc(0x1c6)]===0x1bb?'https':_0x2a90cc(0x19e),_0xfa3d2c=_0x2a46e9[_0x2a90cc(0x1c6)]===0x50||_0x2a46e9[_0x2a90cc(0x1c6)]===0x1bb?'':':'+_0x2a46e9[_0x2a90cc(0x1c6)],_0xd100fe=_0x3e7520+_0x2a90cc(0x23a)+_0x2bbde5+_0xfa3d2c+'/'+_0x22c67c+'/'+_0x17facf;return await _0xe77504(),{'url':_0xd100fe,'storageType':'minio'};}catch(_0x152d14){await _0xe77504(),console[_0x2a90cc(0x212)](_0x2a90cc(0x1e4),_0x152d14);throw new AppError_1['default'](_0x2a90cc(0x231),0x1f4);}const _0x5cddc0=storage_1[_0x2a90cc(0x22f)][_0x2a90cc(0x1d8)],_0x35c767=path_1[_0x2a90cc(0x22f)][_0x2a90cc(0x226)](_0x5cddc0,_0x2a90cc(0x204),String(_0x40980c),_0x5987e7);!fs_1[_0x2a90cc(0x22f)][_0x2a90cc(0x192)](_0x35c767)&&await mkdir(_0x35c767,{'recursive':!![]});const _0x401b8a=path_1['default']['join'](_0x35c767,_0x218159);_0xc0ef8?_0x4b45f7!==_0x401b8a&&await fs_1[_0x2a90cc(0x22f)][_0x2a90cc(0x234)]['rename'](_0x4b45f7,_0x401b8a):await fs_1[_0x2a90cc(0x22f)][_0x2a90cc(0x234)][_0x2a90cc(0x21a)](_0x401b8a,new Uint8Array(_0x1d6ac8));const _0x561a79=_0x2a90cc(0x1f5)+_0x40980c+'/'+_0x5987e7+'/'+_0x218159;return{'url':_0x561a79,'storageType':_0x2a90cc(0x217)};}static async[a644_0x8c74a5(0x1d2)](_0x1151d8,_0x41f12b){const _0x15d991=a644_0x8c74a5;if(_0x41f12b[_0x15d991(0x237)](_0x15d991(0x206))||_0x41f12b[_0x15d991(0x237)]('https://')){const _0x48e048=await getGlobalMinioConfig();if(_0x48e048)try{const _0x1b06c4=createMinioClient(_0x48e048),_0x25f0ce=await getCompanyBucketName(_0x48e048[_0x15d991(0x238)],_0x1151d8),_0xd44ad8=new URL(_0x41f12b),_0x2d1195=_0xd44ad8[_0x15d991(0x19f)]['split']('/'),_0x1b3040=_0x2d1195[_0x15d991(0x20d)](0x2)[_0x15d991(0x226)]('/');return await _0x1b06c4[_0x15d991(0x20b)](_0x25f0ce,_0x1b3040),{'success':!![]};}catch(_0x221777){return console[_0x15d991(0x212)](_0x15d991(0x224),_0x221777),{'success':![]};}}const _0x27acb0=path_1[_0x15d991(0x22f)][_0x15d991(0x226)](storage_1[_0x15d991(0x22f)]['directory'],_0x41f12b);if(fs_1['default'][_0x15d991(0x192)](_0x27acb0))try{return await fs_1['default'][_0x15d991(0x234)][_0x15d991(0x1a8)](_0x27acb0),{'success':!![]};}catch(_0x519974){return console[_0x15d991(0x212)](_0x15d991(0x229),_0x519974),{'success':![]};}return{'success':!![]};}static async[a644_0x8c74a5(0x219)](_0x139028,_0x4d1f6e,_0xb0e010,_0xe703b1,_0x26f620){const _0x5b9a07=a644_0x8c74a5,_0x242ed2=await getGlobalMinioConfig(),_0x48a9f3=typeof _0xe703b1==='string'?Buffer[_0x5b9a07(0x1ce)](_0xe703b1,'base64'):_0xe703b1;if(_0x242ed2)try{const _0x42cc75=createMinioClient(_0x242ed2),_0x2720b4=await getCompanyBucketName(_0x242ed2[_0x5b9a07(0x238)],_0x139028),_0xbced5f=await _0x42cc75['bucketExists'](_0x2720b4);if(!_0xbced5f){const _0x536734=await getStorageLimit(_0x139028);await createMinioBucketForCompany(_0x42cc75,_0x2720b4,_0x536734);}const _0x2bed15=_0x5b9a07(0x1fd)+_0x4d1f6e+'/'+_0xb0e010,_0x5caab5=_0x26f620?{'Content-Type':_0x26f620}:{};await _0x42cc75[_0x5b9a07(0x244)](_0x2720b4,_0x2bed15,_0x48a9f3,_0x48a9f3[_0x5b9a07(0x1f9)],_0x5caab5);let _0x1c2a90=_0x242ed2[_0x5b9a07(0x1a4)];if(_0x1c2a90[_0x5b9a07(0x237)](_0x5b9a07(0x216)))_0x1c2a90=_0x1c2a90[_0x5b9a07(0x1f3)](_0x5b9a07(0x216),'');else _0x1c2a90['startsWith'](_0x5b9a07(0x206))&&(_0x1c2a90=_0x1c2a90[_0x5b9a07(0x1f3)]('http://',''));const _0xee8f3=_0x242ed2['useSSL']||_0x242ed2[_0x5b9a07(0x1c6)]===0x1bb?_0x5b9a07(0x1c4):_0x5b9a07(0x19e),_0x4f2fc7=_0x242ed2[_0x5b9a07(0x1c6)]===0x50||_0x242ed2[_0x5b9a07(0x1c6)]===0x1bb?'':':'+_0x242ed2['port'],_0x49faca=_0xee8f3+'://'+_0x1c2a90+_0x4f2fc7+'/'+_0x2720b4+'/'+_0x2bed15;return{'url':_0x49faca,'storageType':_0x5b9a07(0x1c7)};}catch(_0x446835){console[_0x5b9a07(0x212)]('Erro\x20ao\x20fazer\x20upload\x20para\x20MinIO:',_0x446835);throw _0x446835;}const _0x745bd1=storage_1[_0x5b9a07(0x22f)][_0x5b9a07(0x1d8)],_0x27deb0=path_1[_0x5b9a07(0x22f)][_0x5b9a07(0x226)](_0x745bd1,_0x5b9a07(0x204),String(_0x139028),'tickets',_0x4d1f6e);!fs_1['default'][_0x5b9a07(0x192)](_0x27deb0)&&await mkdir(_0x27deb0,{'recursive':!![]});const _0xdb4526=path_1[_0x5b9a07(0x22f)]['join'](_0x27deb0,_0xb0e010);await fs_1[_0x5b9a07(0x22f)][_0x5b9a07(0x234)][_0x5b9a07(0x21a)](_0xdb4526,new Uint8Array(_0x48a9f3));const _0x222e01=_0x5b9a07(0x1f5)+_0x139028+_0x5b9a07(0x1a0)+_0x4d1f6e+'/'+_0xb0e010;return{'url':_0x222e01,'storageType':_0x5b9a07(0x217)};}static async['isMinioConfigured'](){const _0x33a94f=await getGlobalMinioConfig();return _0x33a94f!==null;}static async['testMinioConnection'](_0x15097c){const _0x1a1b24=a644_0x8c74a5;try{const _0x2fc5b7=createMinioClient(_0x15097c);return await _0x2fc5b7[_0x1a1b24(0x215)](),{'success':!![],'message':_0x1a1b24(0x197)};}catch(_0x11f80b){console[_0x1a1b24(0x212)](_0x1a1b24(0x249),_0x11f80b);let _0x704c6='Erro\x20desconhecido\x20ao\x20conectar';if(_0x11f80b[_0x1a1b24(0x199)]==='MovedPermanently')_0x704c6=_0x1a1b24(0x1ff);else{if(_0x11f80b[_0x1a1b24(0x199)]==='InvalidAccessKeyId')_0x704c6=_0x1a1b24(0x205);else{if(_0x11f80b[_0x1a1b24(0x199)]===_0x1a1b24(0x1f4))_0x704c6=_0x1a1b24(0x1b2);else{if(_0x11f80b['code']===_0x1a1b24(0x19b))_0x704c6=_0x1a1b24(0x23b)+_0x15097c[_0x1a1b24(0x1a4)]+_0x1a1b24(0x20a);else{if(_0x11f80b[_0x1a1b24(0x199)]===_0x1a1b24(0x1eb))_0x704c6=_0x1a1b24(0x1a5)+_0x15097c[_0x1a1b24(0x1a4)]+':'+_0x15097c[_0x1a1b24(0x1c6)];else _0x11f80b[_0x1a1b24(0x24e)]&&(_0x704c6=_0x11f80b['message']);}}}}return{'success':![],'message':_0x704c6};}}static async[a644_0x8c74a5(0x207)](){const _0x4f1a06=a644_0x8c74a5,_0x52f713=await getGlobalMinioConfig();if(!_0x52f713)return{'buckets':[],'error':_0x4f1a06(0x201)};try{const _0x39b06e=createMinioClient(_0x52f713),_0x37b63a=await _0x39b06e[_0x4f1a06(0x215)](),_0x5aecd4=_0x52f713[_0x4f1a06(0x238)][_0x4f1a06(0x1c3)](),_0x37c01d=_0x37b63a[_0x4f1a06(0x21b)](_0x2f83f9=>_0x2f83f9[_0x4f1a06(0x1de)][_0x4f1a06(0x237)](_0x5aecd4+'-'))[_0x4f1a06(0x1b3)](_0x170749=>_0x170749[_0x4f1a06(0x1de)]);return{'buckets':_0x37c01d};}catch(_0x490bc4){return console['error']('Erro\x20ao\x20listar\x20buckets:',_0x490bc4),{'buckets':[],'error':_0x490bc4[_0x4f1a06(0x24e)]};}}static async['deleteCompanyBucket'](_0x558f82){const _0x118a04=a644_0x8c74a5,_0x19b5dc=await getGlobalMinioConfig();if(!_0x19b5dc)return{'success':![],'message':_0x118a04(0x201)};try{const _0x51e1af=createMinioClient(_0x19b5dc),_0x4715e3=await getCompanyBucketName(_0x19b5dc[_0x118a04(0x238)],_0x558f82),_0x6c5f38=await _0x51e1af[_0x118a04(0x202)](_0x4715e3);if(!_0x6c5f38)return{'success':!![],'message':_0x118a04(0x230)};const _0x5ed36b=[],_0x7fad2d=_0x51e1af['listObjects'](_0x4715e3,'',!![]);return await new Promise((_0x508da5,_0xabd97e)=>{const _0x377468=_0x118a04;_0x7fad2d['on']('data',_0x6aec60=>{const _0x5bd16b=a644_0x16b7;if(_0x6aec60[_0x5bd16b(0x1de)])_0x5ed36b['push'](_0x6aec60['name']);}),_0x7fad2d['on'](_0x377468(0x212),_0xabd97e),_0x7fad2d['on']('end',_0x508da5);}),_0x5ed36b[_0x118a04(0x1f9)]>0x0&&await _0x51e1af[_0x118a04(0x1cf)](_0x4715e3,_0x5ed36b),await _0x51e1af['removeBucket'](_0x4715e3),{'success':!![],'message':_0x118a04(0x1c8)+_0x4715e3+'\x20removido\x20com\x20sucesso'};}catch(_0x2c81f0){return console[_0x118a04(0x212)](_0x118a04(0x1bc),_0x2c81f0),{'success':![],'message':_0x2c81f0['message']};}}static async[a644_0x8c74a5(0x1a1)](_0x136375,_0x29481d){const _0x5cb344=a644_0x8c74a5,_0x54f17f=await getGlobalMinioConfig();if(!_0x54f17f)return{'success':![],'message':_0x5cb344(0x201)};const _0x27cebf=await getCompanyBucketName(_0x54f17f['bucket'],_0x136375);return console[_0x5cb344(0x1d5)]('Quota\x20do\x20bucket\x20'+_0x27cebf+_0x5cb344(0x1b6)+_0x29481d+'GB'),console[_0x5cb344(0x1d5)](_0x5cb344(0x208)),{'success':!![],'message':_0x5cb344(0x1fe)+_0x29481d+_0x5cb344(0x246)+_0x27cebf+',\x20configure\x20via\x20console\x20MinIO\x20ou\x20use:\x20mc\x20admin\x20bucket\x20quota\x20ALIAS/'+_0x27cebf+_0x5cb344(0x1da)+_0x29481d+'GB'};}}exports[a644_0x8c74a5(0x22f)]=StorageService;