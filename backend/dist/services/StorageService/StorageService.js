'use strict';const a642_0x92a5db=a642_0x51df;(function(_0x1ab610,_0x3f7a01){const _0x405461=a642_0x51df,_0x448bd6=_0x1ab610();while(!![]){try{const _0x57faa7=-parseInt(_0x405461(0xf3))/0x1*(parseInt(_0x405461(0x162))/0x2)+-parseInt(_0x405461(0x16c))/0x3+-parseInt(_0x405461(0x126))/0x4*(parseInt(_0x405461(0x169))/0x5)+parseInt(_0x405461(0x151))/0x6*(-parseInt(_0x405461(0xeb))/0x7)+-parseInt(_0x405461(0x161))/0x8+parseInt(_0x405461(0x184))/0x9*(-parseInt(_0x405461(0x124))/0xa)+parseInt(_0x405461(0x15c))/0xb*(parseInt(_0x405461(0x109))/0xc);if(_0x57faa7===_0x3f7a01)break;else _0x448bd6['push'](_0x448bd6['shift']());}catch(_0x3bcd95){_0x448bd6['push'](_0x448bd6['shift']());}}}(a642_0x4bec,0xd0a79));function a642_0x51df(_0xb3536f,_0x45bbba){const _0x3762e5=a642_0x4bec();return a642_0x51df=function(_0xd9d779,_0x2d5139){_0xd9d779=_0xd9d779-0xe7;let _0x4becec=_0x3762e5[_0xd9d779];return _0x4becec;},a642_0x51df(_0xb3536f,_0x45bbba);}var __createBinding=this&&this[a642_0x92a5db(0xfc)]||(Object[a642_0x92a5db(0x179)]?function(_0x1f8857,_0xcfd531,_0x2d8591,_0x391cf7){const _0x12b46f=a642_0x92a5db;if(_0x391cf7===undefined)_0x391cf7=_0x2d8591;var _0x4a2a31=Object['getOwnPropertyDescriptor'](_0xcfd531,_0x2d8591);(!_0x4a2a31||('get'in _0x4a2a31?!_0xcfd531['__esModule']:_0x4a2a31['writable']||_0x4a2a31[_0x12b46f(0x130)]))&&(_0x4a2a31={'enumerable':!![],'get':function(){return _0xcfd531[_0x2d8591];}}),Object[_0x12b46f(0xe9)](_0x1f8857,_0x391cf7,_0x4a2a31);}:function(_0x43e81f,_0x3e536e,_0x46a7f3,_0xbd95df){if(_0xbd95df===undefined)_0xbd95df=_0x46a7f3;_0x43e81f[_0xbd95df]=_0x3e536e[_0x46a7f3];}),__setModuleDefault=this&&this[a642_0x92a5db(0x174)]||(Object[a642_0x92a5db(0x179)]?function(_0x3514e4,_0x4cfdcc){const _0x22cbdc=a642_0x92a5db;Object['defineProperty'](_0x3514e4,_0x22cbdc(0xf9),{'enumerable':!![],'value':_0x4cfdcc});}:function(_0x4a93ab,_0x2b2389){_0x4a93ab['default']=_0x2b2389;}),__importStar=this&&this[a642_0x92a5db(0x181)]||(function(){const _0x37c955=(function(){let _0x391d68=!![];return function(_0x20d133,_0x21e6df){const _0x25241b=_0x391d68?function(){const _0x40eaa3=a642_0x51df;if(_0x21e6df){const _0x38d692=_0x21e6df[_0x40eaa3(0x10b)](_0x20d133,arguments);return _0x21e6df=null,_0x38d692;}}:function(){};return _0x391d68=![],_0x25241b;};}()),_0x8263e=_0x37c955(this,function(){const _0x41b616=a642_0x51df;return _0x8263e[_0x41b616(0x10d)]()['search']('(((.+)+)+)+$')[_0x41b616(0x10d)]()[_0x41b616(0x15f)](_0x8263e)[_0x41b616(0x15e)](_0x41b616(0x12d));});_0x8263e();var _0x3bdd5d=function(_0x4a7d12){const _0x46ef1b=a642_0x51df;return _0x3bdd5d=Object[_0x46ef1b(0x168)]||function(_0x464e46){const _0x34872f=_0x46ef1b;var _0x3dcb96=[];for(var _0x12f4f4 in _0x464e46)if(Object[_0x34872f(0xe7)][_0x34872f(0x122)]['call'](_0x464e46,_0x12f4f4))_0x3dcb96[_0x3dcb96[_0x34872f(0x175)]]=_0x12f4f4;return _0x3dcb96;},_0x3bdd5d(_0x4a7d12);};return function(_0x1fc9e8){const _0x409b0=a642_0x51df;if(_0x1fc9e8&&_0x1fc9e8['__esModule'])return _0x1fc9e8;var _0x1e062c={};if(_0x1fc9e8!=null){for(var _0x4e006d=_0x3bdd5d(_0x1fc9e8),_0x429d28=0x0;_0x429d28<_0x4e006d[_0x409b0(0x175)];_0x429d28++)if(_0x4e006d[_0x429d28]!==_0x409b0(0xf9))__createBinding(_0x1e062c,_0x1fc9e8,_0x4e006d[_0x429d28]);}return __setModuleDefault(_0x1e062c,_0x1fc9e8),_0x1e062c;};}()),__importDefault=this&&this[a642_0x92a5db(0x183)]||function(_0x1bf7d4){const _0x4cb0ef=a642_0x92a5db;return _0x1bf7d4&&_0x1bf7d4[_0x4cb0ef(0x187)]?_0x1bf7d4:{'default':_0x1bf7d4};};function a642_0x4bec(){const _0x3ff908=['Uploads','4dHRkoc','value','Bytes',':\x20usado=','toFixed','string','Erro\x20ao\x20limpar\x20pasta\x20no\x20MinIO:','(((.+)+)+)+$','pow','Erro\x20ao\x20deletar\x20arquivo\x20do\x20MinIO:','configurable','Conexões','InvalidAccessKeyId',',\x20limite=','Bucket\x20','bucketName','Erro\x20ao\x20obter\x20limite\x20de\x20armazenamento:','Erro\x20ao\x20deletar\x20bucket:','toLowerCase','endPoint','Erro\x20ao\x20deletar\x20arquivo\x20local:','code','minio','directory','Erro\x20ao\x20criar\x20bucket\x20','../../models/Company','ECONNREFUSED','totalUsed','\x20arquivo(s)\x20removido(s)\x20com\x20sucesso','Nota:\x20Configure\x20a\x20quota\x20manualmente\x20no\x20console\x20do\x20MinIO\x20ou\x20via\x20mc\x20admin','key','MovedPermanently','uploadFile','https','startsWith','\x20removido\x20com\x20sucesso','pathname','findByPk','Filas','from','9000','FlowBuilder','Pasta\x20já\x20está\x20vazia','294opdJJq','writeFile','Quota\x20do\x20bucket\x20','Bucket\x20não\x20existe','../../models/Setting','listBuckets','map','floor','\x20criado\x20para\x20empresa\x20','listCompanyBuckets',',\x20pode=','11bzhycp','useSSL','search','constructor','plan','11474776lpqFIC','208PdPpeO','stringify','://','path','Erro\x20ao\x20obter\x20configuração\x20global\x20MinIO:','Erro\x20ao\x20deletar\x20arquivo\x20temporário:','getOwnPropertyNames','5021020ZmVaLV','existsSync','join','2289618LYojcw','Erro\x20ao\x20buscar\x20bucket\x20da\x20empresa:','Tickets','s3:GetObject','\x22\x20não\x20encontrado.\x20Verifique\x20a\x20URL.','true','Empresa\x20(WhiteLabel)','media/','__setModuleDefault','length','removeObjects','putObject','Erro\x20ao\x20testar\x20conexão\x20MinIO:','create','size','getStorageUsage','media','storageLimitBytes','rename','bucketExists','\x20deve\x20ser\x20atualizada\x20para\x20','__importStar','storageLimit','__importDefault','541395SUuPpf','promises','keys','__esModule','endsWith','Conexão\x20recusada\x20em\x20','Estrutura\x20de\x20pastas\x20criada\x20para\x20bucket\x20','name','\x20--hard\x20','minioUseSSL','2012-10-17',',\x20arquivo=','prototype','SignatureDoesNotMatch','defineProperty','removeObject','102851xNEwDy','STORAGE_FOLDERS','split','message','Allow','minioPort','log','end','3921VCDHQc','canUpload','readFile','http','Erro\x20ao\x20calcular\x20tamanho\x20da\x20pasta\x20','/.keep','default','push','http://','__createBinding','MinIO\x20não\x20configurado','Erro\x20ao\x20listar\x20buckets:','stat','0\x20Bytes',',\x20configure\x20via\x20console\x20MinIO\x20ou\x20use:\x20mc\x20admin\x20bucket\x20quota\x20ALIAS/','uploadTicketMedia','Secret\x20Key\x20inválida','Endpoint\x20\x22','GB\x20no\x20bucket\x20','promisify','data','port','62931624yVFpoW','Erro\x20ao\x20acessar\x20MinIO,\x20usando\x20local:','apply','Campanhas','toString','local','removeBucket','bucket','company','secretKey','Para\x20aplicar\x20quota\x20de\x20','findAll','https://','Erro\x20ao\x20limpar\x20pasta','createCompanyStorage','Bucket\x20MinIO\x20','replace','Client','unlink','../../models/Plan','entries','listObjects','fileCount','minioBucket','error','hasOwnProperty','minioEndpoint','10EfLKVS'];a642_0x4bec=function(){return _0x3ff908;};return a642_0x4bec();}Object[a642_0x92a5db(0xe9)](exports,a642_0x92a5db(0x187),{'value':!![]});const Minio=__importStar(require(a642_0x92a5db(0x13c))),fs_1=__importDefault(require('fs')),path_1=__importDefault(require(a642_0x92a5db(0x165))),util_1=require('util'),storage_1=__importStar(require('../../config/storage')),Setting_1=__importDefault(require(a642_0x92a5db(0x155))),Company_1=__importDefault(require(a642_0x92a5db(0x13f))),Plan_1=__importDefault(require(a642_0x92a5db(0x11c))),AppError_1=__importDefault(require('../../errors/AppError')),readdir=(0x0,util_1[a642_0x92a5db(0x106)])(fs_1['default']['readdir']),stat=(0x0,util_1[a642_0x92a5db(0x106)])(fs_1[a642_0x92a5db(0xf9)][a642_0x92a5db(0xff)]),mkdir=(0x0,util_1[a642_0x92a5db(0x106)])(fs_1[a642_0x92a5db(0xf9)]['mkdir']),rmdir=(0x0,util_1['promisify'])(fs_1[a642_0x92a5db(0xf9)]['rm']),formatBytes=_0x581cb9=>{const _0x1e068a=a642_0x92a5db;if(_0x581cb9===0x0)return _0x1e068a(0x100);const _0xbb7e22=0x400,_0x5cbdfa=[_0x1e068a(0x128),'KB','MB','GB','TB'],_0x5ae004=Math[_0x1e068a(0x158)](Math[_0x1e068a(0xf1)](_0x581cb9)/Math[_0x1e068a(0xf1)](_0xbb7e22));return parseFloat((_0x581cb9/Math[_0x1e068a(0x12e)](_0xbb7e22,_0x5ae004))[_0x1e068a(0x12a)](0x2))+'\x20'+_0x5cbdfa[_0x5ae004];},getGlobalMinioConfig=async()=>{const _0x579d25=a642_0x92a5db;try{const _0x26d576=await Setting_1['default'][_0x579d25(0x114)]({'where':{'companyId':0x1},'attributes':[_0x579d25(0x144),_0x579d25(0x127)]}),_0x16b64e={};_0x26d576['forEach'](_0x3f2f7a=>{const _0x5ceece=_0x579d25;_0x16b64e[_0x3f2f7a['key']]=_0x3f2f7a[_0x5ceece(0x127)];});const _0x367686=_0x16b64e[_0x579d25(0x123)],_0x118e85=_0x16b64e['minioAccessKey'],_0x3516ce=_0x16b64e['minioSecretKey'],_0x44f315=_0x16b64e[_0x579d25(0x120)]||_0x579d25(0x111),_0xd3b2ec=parseInt(_0x16b64e[_0x579d25(0xf0)]||_0x579d25(0x14e),0xa),_0x1a8f46=_0x16b64e[_0x579d25(0x18d)]===_0x579d25(0x171);if(!_0x367686||!_0x118e85||!_0x3516ce)return null;return{'endPoint':_0x367686,'port':_0xd3b2ec,'useSSL':_0x1a8f46,'accessKey':_0x118e85,'secretKey':_0x3516ce,'bucket':_0x44f315};}catch(_0x480577){return console[_0x579d25(0x121)](_0x579d25(0x166),_0x480577),null;}},getCompanyBucketName=async(_0x43c6bf,_0x3f440c)=>{const _0x3fac64=a642_0x92a5db;try{const _0xd662e3=await Company_1[_0x3fac64(0xf9)][_0x3fac64(0x14b)](_0x3f440c,{'attributes':['bucketName']});if(_0xd662e3?.[_0x3fac64(0x135)])return _0xd662e3[_0x3fac64(0x135)][_0x3fac64(0x138)]();}catch(_0x4c3837){console[_0x3fac64(0x121)](_0x3fac64(0x16d),_0x4c3837);}return _0x43c6bf[_0x3fac64(0x138)]()+'-'+_0x3f440c;},getCompanyBucketNameSync=(_0x4de650,_0x1d9676)=>{return _0x4de650['toLowerCase']()+'-'+_0x1d9676;},createMinioClient=_0x1f405b=>{const _0x3095b4=a642_0x92a5db;let _0x2e2d42=_0x1f405b[_0x3095b4(0x139)],_0x5300d5=_0x1f405b['useSSL'];if(_0x2e2d42[_0x3095b4(0x148)](_0x3095b4(0x115)))_0x2e2d42=_0x2e2d42['replace']('https://',''),_0x5300d5=!![];else _0x2e2d42[_0x3095b4(0x148)](_0x3095b4(0xfb))&&(_0x2e2d42=_0x2e2d42[_0x3095b4(0x119)]('http://',''),_0x5300d5=![]);_0x2e2d42=_0x2e2d42[_0x3095b4(0x119)](/\/$/,'');if(_0x1f405b[_0x3095b4(0x108)]===0x1bb)_0x5300d5=!![];else _0x1f405b[_0x3095b4(0x108)]===0x50&&(_0x5300d5=![]);return new Minio[(_0x3095b4(0x11a))]({'endPoint':_0x2e2d42,'port':_0x1f405b[_0x3095b4(0x108)],'useSSL':_0x5300d5,'accessKey':_0x1f405b['accessKey'],'secretKey':_0x1f405b[_0x3095b4(0x112)]});},getFolderSize=async _0x3c0e13=>{const _0x21fb17=a642_0x92a5db;let _0x53c9a0=0x0,_0x2d1c99=0x0;try{if(!fs_1['default'][_0x21fb17(0x16a)](_0x3c0e13))return{'size':0x0,'fileCount':0x0};const _0xb71eda=await readdir(_0x3c0e13);for(const _0x594415 of _0xb71eda){const _0x1e1429=path_1[_0x21fb17(0xf9)][_0x21fb17(0x16b)](_0x3c0e13,_0x594415),_0x50d957=await stat(_0x1e1429);if(_0x50d957['isDirectory']()){const _0x3a8af1=await getFolderSize(_0x1e1429);_0x53c9a0+=_0x3a8af1[_0x21fb17(0x17a)],_0x2d1c99+=_0x3a8af1[_0x21fb17(0x11f)];}else _0x53c9a0+=_0x50d957[_0x21fb17(0x17a)],_0x2d1c99++;}}catch(_0x2eacc9){console[_0x21fb17(0x121)](_0x21fb17(0xf7)+_0x3c0e13+':',_0x2eacc9);}return{'size':_0x53c9a0,'fileCount':_0x2d1c99};},getMinioFolderSize=async(_0x287dd1,_0x3f3f28,_0x3754d5)=>{return new Promise(_0x20b0b2=>{const _0x421764=a642_0x51df;let _0x43d1dd=0x0,_0x33cf03=0x0;const _0x29e43c=_0x287dd1['listObjects'](_0x3f3f28,_0x3754d5,!![]);_0x29e43c['on']('data',_0x2cd1b4=>{_0x43d1dd+=_0x2cd1b4['size']||0x0,_0x33cf03++;}),_0x29e43c['on']('error',_0x563aa9=>{const _0x8e3f28=a642_0x51df;console[_0x8e3f28(0x121)]('Erro\x20ao\x20listar\x20objetos\x20MinIO:',_0x563aa9),_0x20b0b2({'size':0x0,'fileCount':0x0});}),_0x29e43c['on'](_0x421764(0xf2),()=>{_0x20b0b2({'size':_0x43d1dd,'fileCount':_0x33cf03});});});},getStorageLimit=async _0x4ce5d5=>{const _0x4416b7=a642_0x92a5db;try{const _0x1078e6=await Company_1['default'][_0x4416b7(0x14b)](_0x4ce5d5,{'include':[{'model':Plan_1[_0x4416b7(0xf9)],'as':_0x4416b7(0x160)}]});if(_0x1078e6?.[_0x4416b7(0x160)]?.[_0x4416b7(0x182)])return _0x1078e6[_0x4416b7(0x160)][_0x4416b7(0x182)];return 0xa;}catch(_0x3ae3d0){return console[_0x4416b7(0x121)](_0x4416b7(0x136),_0x3ae3d0),0xa;}},getCompanyPath=_0x4b959b=>{const _0x2dc6ec=a642_0x92a5db;return path_1['default'][_0x2dc6ec(0x16b)](storage_1['default'][_0x2dc6ec(0x13d)],_0x2dc6ec(0x111),String(_0x4b959b));},createLocalFolderStructure=async _0x4231dd=>{const _0x41aa4d=a642_0x92a5db,_0x1be84f=getCompanyPath(_0x4231dd);await mkdir(_0x1be84f,{'recursive':!![]});for(const _0x24663c of Object[_0x41aa4d(0x186)](storage_1[_0x41aa4d(0xec)])){const _0x988861=path_1['default']['join'](_0x1be84f,storage_1[_0x41aa4d(0xec)][_0x24663c]);await mkdir(_0x988861,{'recursive':!![]});}},createMinioBucketForCompany=async(_0x4dd583,_0xf781ae,_0x24b92c)=>{const _0x34c8b9=a642_0x92a5db;try{const _0xe29706=await _0x4dd583['bucketExists'](_0xf781ae);if(!_0xe29706){await _0x4dd583['makeBucket'](_0xf781ae),console['log'](_0x34c8b9(0x134)+_0xf781ae+'\x20criado\x20com\x20sucesso');const _0x3b1ed4={'Version':_0x34c8b9(0x18e),'Statement':[{'Effect':_0x34c8b9(0xef),'Principal':{'AWS':['*']},'Action':[_0x34c8b9(0x16f)],'Resource':['arn:aws:s3:::'+_0xf781ae+'/*']}]};await _0x4dd583['setBucketPolicy'](_0xf781ae,JSON[_0x34c8b9(0x163)](_0x3b1ed4)),console['log']('Política\x20de\x20acesso\x20configurada\x20para\x20'+_0xf781ae);}for(const _0x51b4a2 of Object[_0x34c8b9(0x186)](storage_1[_0x34c8b9(0xec)])){const _0x16c2cc=storage_1[_0x34c8b9(0xec)][_0x51b4a2]+'/.keep';try{await _0x4dd583['putObject'](_0xf781ae,_0x16c2cc,Buffer[_0x34c8b9(0x14d)](''),0x0);}catch(_0x50fac6){}}console[_0x34c8b9(0xf1)](_0x34c8b9(0x18a)+_0xf781ae);}catch(_0x3bf2d8){console[_0x34c8b9(0x121)](_0x34c8b9(0x13e)+_0xf781ae+':',_0x3bf2d8);throw _0x3bf2d8;}};class StorageService{static async[a642_0x92a5db(0x117)](_0x245018){const _0x265f53=a642_0x92a5db,_0x41cc01=await getGlobalMinioConfig();let _0x95d7f=![],_0xbfccb1;if(_0x41cc01)try{const _0x10a1f8=createMinioClient(_0x41cc01);_0xbfccb1=await getCompanyBucketName(_0x41cc01[_0x265f53(0x110)],_0x245018);const _0x14acc2=await getStorageLimit(_0x245018);await createMinioBucketForCompany(_0x10a1f8,_0xbfccb1,_0x14acc2),_0x95d7f=!![],console['log'](_0x265f53(0x118)+_0xbfccb1+_0x265f53(0x159)+_0x245018);}catch(_0x56d439){console[_0x265f53(0x121)]('Erro\x20ao\x20criar\x20bucket\x20MinIO\x20para\x20empresa\x20'+_0x245018+':',_0x56d439);}return await createLocalFolderStructure(_0x245018),{'bucketCreated':_0x95d7f,'bucketName':_0xbfccb1};}static async[a642_0x92a5db(0x17b)](_0x444bf8){const _0x33c385=a642_0x92a5db,_0x3c231a=await getGlobalMinioConfig(),_0x5e8118=await getStorageLimit(_0x444bf8),_0x634d59=_0x5e8118*0x400*0x400*0x400,_0x34770a=[];let _0x134529=0x0;const _0x10532b={'tickets':_0x33c385(0x16e),'uploads':_0x33c385(0x125),'campanhas':_0x33c385(0x10c),'campanhasLista':'Lista\x20de\x20Campanhas','kanban':'Kanban','empresa':_0x33c385(0x172),'conexao':_0x33c385(0x131),'filas':_0x33c385(0x14c),'flowbuilder':_0x33c385(0x14f)};if(_0x3c231a){const _0x415951=createMinioClient(_0x3c231a),_0x482ba7=await getCompanyBucketName(_0x3c231a[_0x33c385(0x110)],_0x444bf8);try{const _0x5baedd=await _0x415951[_0x33c385(0x17f)](_0x482ba7);if(_0x5baedd){for(const [_0x579429,_0x4a3aed]of Object[_0x33c385(0x11d)](storage_1['STORAGE_FOLDERS'])){const _0x2fe4a5=_0x4a3aed+'/',{size:_0x5157e9,fileCount:_0x3d2da2}=await getMinioFolderSize(_0x415951,_0x482ba7,_0x2fe4a5);_0x34770a[_0x33c385(0xfa)]({'folder':_0x579429,'folderName':_0x10532b[_0x579429]||_0x579429,'size':_0x5157e9,'sizeFormatted':formatBytes(_0x5157e9),'fileCount':_0x3d2da2}),_0x134529+=_0x5157e9;}return{'storageType':_0x33c385(0x13c),'totalUsed':_0x134529,'totalUsedFormatted':formatBytes(_0x134529),'storageLimit':_0x5e8118,'storageLimitBytes':_0x634d59,'usagePercentage':Math['round'](_0x134529/_0x634d59*0x64*0x64)/0x64,'folders':_0x34770a,'isLimitReached':_0x134529>=_0x634d59,'bucketName':_0x482ba7};}}catch(_0x4eccc0){console[_0x33c385(0x121)](_0x33c385(0x10a),_0x4eccc0);}}const _0x229b66=getCompanyPath(_0x444bf8);for(const [_0x433549,_0x4cf0d1]of Object[_0x33c385(0x11d)](storage_1[_0x33c385(0xec)])){const _0x184749=path_1[_0x33c385(0xf9)][_0x33c385(0x16b)](_0x229b66,_0x4cf0d1),{size:_0x3d6f99,fileCount:_0x3d440b}=await getFolderSize(_0x184749);_0x34770a[_0x33c385(0xfa)]({'folder':_0x433549,'folderName':_0x10532b[_0x433549]||_0x433549,'size':_0x3d6f99,'sizeFormatted':formatBytes(_0x3d6f99),'fileCount':_0x3d440b}),_0x134529+=_0x3d6f99;}return{'storageType':_0x33c385(0x10e),'totalUsed':_0x134529,'totalUsedFormatted':formatBytes(_0x134529),'storageLimit':_0x5e8118,'storageLimitBytes':_0x634d59,'usagePercentage':Math['round'](_0x134529/_0x634d59*0x64*0x64)/0x64,'folders':_0x34770a,'isLimitReached':_0x134529>=_0x634d59};}static async[a642_0x92a5db(0xf4)](_0x505e99,_0x3223aa=0x0){const _0x52e9b9=a642_0x92a5db,_0x5da824=await this[_0x52e9b9(0x17b)](_0x505e99),_0x3a8199=_0x5da824[_0x52e9b9(0x141)]+_0x3223aa<_0x5da824[_0x52e9b9(0x17d)];return console[_0x52e9b9(0xf1)]('[canUpload]\x20Company\x20'+_0x505e99+_0x52e9b9(0x129)+formatBytes(_0x5da824['totalUsed'])+_0x52e9b9(0x133)+formatBytes(_0x5da824[_0x52e9b9(0x17d)])+_0x52e9b9(0x18f)+formatBytes(_0x3223aa)+_0x52e9b9(0x15b)+_0x3a8199),_0x3a8199;}static async['clearFolder'](_0x1613b8,_0x476512){const _0x471afb=a642_0x92a5db,_0x1de7a2=storage_1[_0x471afb(0xec)][_0x476512];if(!_0x1de7a2)throw new AppError_1['default']('Pasta\x20não\x20encontrada',0x194);const _0x1283be=await getGlobalMinioConfig();if(_0x1283be){const _0x6a80f5=createMinioClient(_0x1283be),_0x2e9dca=await getCompanyBucketName(_0x1283be['bucket'],_0x1613b8);try{const _0x29997e=await _0x6a80f5['bucketExists'](_0x2e9dca);if(_0x29997e){const _0x190d45=_0x1de7a2+'/';return new Promise((_0x4aa5d4,_0x4f6849)=>{const _0x4c5b9e=_0x471afb,_0x40e15e=[],_0x439f1b=_0x6a80f5[_0x4c5b9e(0x11e)](_0x2e9dca,_0x190d45,!![]);_0x439f1b['on'](_0x4c5b9e(0x107),_0x2f2576=>{const _0x4f0dbb=_0x4c5b9e;_0x2f2576[_0x4f0dbb(0x18b)]&&!_0x2f2576[_0x4f0dbb(0x18b)][_0x4f0dbb(0x188)](_0x4f0dbb(0xf8))&&_0x40e15e['push'](_0x2f2576[_0x4f0dbb(0x18b)]);}),_0x439f1b['on'](_0x4c5b9e(0x121),_0x3d7147=>{_0x4f6849(_0x3d7147);}),_0x439f1b['on'](_0x4c5b9e(0xf2),async()=>{const _0x37fe81=_0x4c5b9e;if(_0x40e15e[_0x37fe81(0x175)]>0x0)try{await _0x6a80f5[_0x37fe81(0x176)](_0x2e9dca,_0x40e15e),_0x4aa5d4({'success':!![],'message':_0x40e15e[_0x37fe81(0x175)]+_0x37fe81(0x142)});}catch(_0x482b64){_0x4f6849(_0x482b64);}else _0x4aa5d4({'success':!![],'message':_0x37fe81(0x150)});});});}}catch(_0x3d479c){console[_0x471afb(0x121)](_0x471afb(0x12c),_0x3d479c);}}const _0xa20e0=path_1[_0x471afb(0xf9)][_0x471afb(0x16b)](getCompanyPath(_0x1613b8),_0x1de7a2);if(!fs_1['default'][_0x471afb(0x16a)](_0xa20e0))return{'success':!![],'message':_0x471afb(0x150)};try{return await rmdir(_0xa20e0,{'recursive':!![]}),await mkdir(_0xa20e0,{'recursive':!![]}),{'success':!![],'message':'Pasta\x20limpa\x20com\x20sucesso'};}catch(_0x4c0f31){console['error']('Erro\x20ao\x20limpar\x20pasta:',_0x4c0f31);throw new AppError_1['default'](_0x471afb(0x116),0x1f4);}}static async[a642_0x92a5db(0x146)](_0x8d147,_0x3d12c6,_0x23e07b,_0x4cd84d,_0x281bf3){const _0x1b7f07=a642_0x92a5db,_0x4f9bfd=await getGlobalMinioConfig();let _0x3230fe;const _0x367ca1=typeof _0x4cd84d==='string';_0x367ca1?_0x3230fe=await fs_1[_0x1b7f07(0xf9)][_0x1b7f07(0x185)][_0x1b7f07(0xf5)](_0x4cd84d):_0x3230fe=_0x4cd84d;const _0x3bc1a6=async()=>{const _0x569fd7=_0x1b7f07;if(_0x367ca1&&fs_1[_0x569fd7(0xf9)][_0x569fd7(0x16a)](_0x4cd84d))try{await fs_1['default'][_0x569fd7(0x185)][_0x569fd7(0x11b)](_0x4cd84d);}catch(_0x397c33){console[_0x569fd7(0x121)](_0x569fd7(0x167),_0x397c33);}};if(_0x4f9bfd)try{const _0x10d220=createMinioClient(_0x4f9bfd),_0x4ad59c=await getCompanyBucketName(_0x4f9bfd[_0x1b7f07(0x110)],_0x8d147),_0x1a748b=await _0x10d220['bucketExists'](_0x4ad59c);if(!_0x1a748b){const _0x181955=await getStorageLimit(_0x8d147);await createMinioBucketForCompany(_0x10d220,_0x4ad59c,_0x181955);}const _0x4851bf=_0x3d12c6+'/'+_0x23e07b,_0x3f0b50=_0x281bf3?{'Content-Type':_0x281bf3}:{};await _0x10d220[_0x1b7f07(0x177)](_0x4ad59c,_0x4851bf,_0x3230fe,_0x3230fe[_0x1b7f07(0x175)],_0x3f0b50);let _0x2d725e=_0x4f9bfd[_0x1b7f07(0x139)];if(_0x2d725e[_0x1b7f07(0x148)](_0x1b7f07(0x115)))_0x2d725e=_0x2d725e['replace'](_0x1b7f07(0x115),'');else _0x2d725e['startsWith'](_0x1b7f07(0xfb))&&(_0x2d725e=_0x2d725e[_0x1b7f07(0x119)](_0x1b7f07(0xfb),''));const _0x41b91f=_0x4f9bfd[_0x1b7f07(0x15d)]||_0x4f9bfd[_0x1b7f07(0x108)]===0x1bb?_0x1b7f07(0x147):_0x1b7f07(0xf6),_0x2d1b95=_0x4f9bfd[_0x1b7f07(0x108)]===0x50||_0x4f9bfd['port']===0x1bb?'':':'+_0x4f9bfd['port'],_0x44a384=_0x41b91f+_0x1b7f07(0x164)+_0x2d725e+_0x2d1b95+'/'+_0x4ad59c+'/'+_0x4851bf;return await _0x3bc1a6(),{'url':_0x44a384,'storageType':'minio'};}catch(_0x1d700e){await _0x3bc1a6(),console[_0x1b7f07(0x121)]('Erro\x20ao\x20fazer\x20upload\x20para\x20MinIO:',_0x1d700e);throw new AppError_1['default']('Erro\x20ao\x20fazer\x20upload\x20para\x20o\x20armazenamento.\x20Verifique\x20a\x20configuração\x20do\x20MinIO.',0x1f4);}const _0x4a20a1=storage_1[_0x1b7f07(0xf9)][_0x1b7f07(0x13d)],_0x446826=path_1['default']['join'](_0x4a20a1,_0x3d12c6);!fs_1[_0x1b7f07(0xf9)][_0x1b7f07(0x16a)](_0x446826)&&await mkdir(_0x446826,{'recursive':!![]});const _0x4c567b=path_1['default']['join'](_0x446826,_0x23e07b);_0x367ca1?_0x4cd84d!==_0x4c567b&&await fs_1[_0x1b7f07(0xf9)][_0x1b7f07(0x185)][_0x1b7f07(0x17e)](_0x4cd84d,_0x4c567b):await fs_1[_0x1b7f07(0xf9)]['promises'][_0x1b7f07(0x152)](_0x4c567b,new Uint8Array(_0x3230fe));const _0x48240e=_0x3d12c6+'/'+_0x23e07b;return{'url':_0x48240e,'storageType':_0x1b7f07(0x10e)};}static async['deleteFile'](_0xf96caa,_0x4b3398){const _0x526124=a642_0x92a5db;if(_0x4b3398[_0x526124(0x148)](_0x526124(0xfb))||_0x4b3398[_0x526124(0x148)]('https://')){const _0x47d0d8=await getGlobalMinioConfig();if(_0x47d0d8)try{const _0x3ae74a=createMinioClient(_0x47d0d8),_0xae573=await getCompanyBucketName(_0x47d0d8[_0x526124(0x110)],_0xf96caa),_0x5050db=new URL(_0x4b3398),_0x29df96=_0x5050db[_0x526124(0x14a)][_0x526124(0xed)]('/'),_0x2db876=_0x29df96['slice'](0x2)[_0x526124(0x16b)]('/');return await _0x3ae74a[_0x526124(0xea)](_0xae573,_0x2db876),{'success':!![]};}catch(_0x2bacef){return console[_0x526124(0x121)](_0x526124(0x12f),_0x2bacef),{'success':![]};}}const _0x4972dc=path_1[_0x526124(0xf9)]['join'](storage_1['default'][_0x526124(0x13d)],_0x4b3398);if(fs_1['default']['existsSync'](_0x4972dc))try{return await fs_1['default'][_0x526124(0x185)]['unlink'](_0x4972dc),{'success':!![]};}catch(_0x2822a3){return console[_0x526124(0x121)](_0x526124(0x13a),_0x2822a3),{'success':![]};}return{'success':!![]};}static async[a642_0x92a5db(0x102)](_0x4a5a0e,_0x5956c8,_0x4e1b60,_0x9de375,_0x161d4d){const _0x208c50=a642_0x92a5db,_0x45a449=await getGlobalMinioConfig(),_0x1d8530=typeof _0x9de375===_0x208c50(0x12b)?Buffer[_0x208c50(0x14d)](_0x9de375,'base64'):_0x9de375;if(_0x45a449)try{const _0x511c9d=createMinioClient(_0x45a449),_0x3bb77b=await getCompanyBucketName(_0x45a449[_0x208c50(0x110)],_0x4a5a0e),_0x2f9cd5=await _0x511c9d[_0x208c50(0x17f)](_0x3bb77b);if(!_0x2f9cd5){const _0x51616f=await getStorageLimit(_0x4a5a0e);await createMinioBucketForCompany(_0x511c9d,_0x3bb77b,_0x51616f);}const _0x402e50='tickets/'+_0x5956c8+'/'+_0x4e1b60,_0x484d2f=_0x161d4d?{'Content-Type':_0x161d4d}:{};await _0x511c9d[_0x208c50(0x177)](_0x3bb77b,_0x402e50,_0x1d8530,_0x1d8530[_0x208c50(0x175)],_0x484d2f);let _0x257ab4=_0x45a449[_0x208c50(0x139)];if(_0x257ab4[_0x208c50(0x148)](_0x208c50(0x115)))_0x257ab4=_0x257ab4[_0x208c50(0x119)]('https://','');else _0x257ab4[_0x208c50(0x148)](_0x208c50(0xfb))&&(_0x257ab4=_0x257ab4[_0x208c50(0x119)](_0x208c50(0xfb),''));const _0x2cf038=_0x45a449['useSSL']||_0x45a449['port']===0x1bb?'https':_0x208c50(0xf6),_0x40413c=_0x45a449[_0x208c50(0x108)]===0x50||_0x45a449[_0x208c50(0x108)]===0x1bb?'':':'+_0x45a449[_0x208c50(0x108)],_0x90a970=_0x2cf038+_0x208c50(0x164)+_0x257ab4+_0x40413c+'/'+_0x3bb77b+'/'+_0x402e50;return{'url':_0x90a970,'storageType':_0x208c50(0x13c)};}catch(_0x56ad21){console[_0x208c50(0x121)]('Erro\x20ao\x20fazer\x20upload\x20para\x20MinIO:',_0x56ad21);throw _0x56ad21;}const _0x528730=storage_1[_0x208c50(0xf9)]['directory'],_0x21f9b3=path_1[_0x208c50(0xf9)]['join'](_0x528730,_0x208c50(0x17c),String(_0x4a5a0e),_0x5956c8);!fs_1[_0x208c50(0xf9)][_0x208c50(0x16a)](_0x21f9b3)&&await mkdir(_0x21f9b3,{'recursive':!![]});const _0x14ef15=path_1['default']['join'](_0x21f9b3,_0x4e1b60);await fs_1[_0x208c50(0xf9)][_0x208c50(0x185)][_0x208c50(0x152)](_0x14ef15,new Uint8Array(_0x1d8530));const _0x1404bf=_0x208c50(0x173)+_0x4a5a0e+'/'+_0x5956c8+'/'+_0x4e1b60;return{'url':_0x1404bf,'storageType':_0x208c50(0x10e)};}static async['isMinioConfigured'](){const _0x4f0ca9=await getGlobalMinioConfig();return _0x4f0ca9!==null;}static async['testMinioConnection'](_0x4b9c62){const _0x2ab020=a642_0x92a5db;try{const _0xb75fab=createMinioClient(_0x4b9c62);return await _0xb75fab[_0x2ab020(0x156)](),{'success':!![],'message':'Conexão\x20estabelecida\x20com\x20sucesso!'};}catch(_0x125068){console['error'](_0x2ab020(0x178),_0x125068);let _0x30500e='Erro\x20desconhecido\x20ao\x20conectar';if(_0x125068[_0x2ab020(0x13b)]===_0x2ab020(0x145))_0x30500e='Erro\x20de\x20redirecionamento.\x20Verifique\x20se\x20a\x20configuração\x20SSL\x20está\x20correta.';else{if(_0x125068[_0x2ab020(0x13b)]===_0x2ab020(0x132))_0x30500e='Access\x20Key\x20inválida';else{if(_0x125068[_0x2ab020(0x13b)]===_0x2ab020(0xe8))_0x30500e=_0x2ab020(0x103);else{if(_0x125068[_0x2ab020(0x13b)]==='ENOTFOUND')_0x30500e=_0x2ab020(0x104)+_0x4b9c62[_0x2ab020(0x139)]+_0x2ab020(0x170);else{if(_0x125068[_0x2ab020(0x13b)]===_0x2ab020(0x140))_0x30500e=_0x2ab020(0x189)+_0x4b9c62['endPoint']+':'+_0x4b9c62[_0x2ab020(0x108)];else _0x125068['message']&&(_0x30500e=_0x125068[_0x2ab020(0xee)]);}}}}return{'success':![],'message':_0x30500e};}}static async[a642_0x92a5db(0x15a)](){const _0x2ae56f=a642_0x92a5db,_0x3e01d7=await getGlobalMinioConfig();if(!_0x3e01d7)return{'buckets':[],'error':_0x2ae56f(0xfd)};try{const _0x536f57=createMinioClient(_0x3e01d7),_0x36a724=await _0x536f57[_0x2ae56f(0x156)](),_0x1cf2e5=_0x3e01d7[_0x2ae56f(0x110)][_0x2ae56f(0x138)](),_0x2d90ba=_0x36a724['filter'](_0xff08b8=>_0xff08b8['name'][_0x2ae56f(0x148)](_0x1cf2e5+'-'))[_0x2ae56f(0x157)](_0x8f03de=>_0x8f03de['name']);return{'buckets':_0x2d90ba};}catch(_0x8d7487){return console[_0x2ae56f(0x121)](_0x2ae56f(0xfe),_0x8d7487),{'buckets':[],'error':_0x8d7487[_0x2ae56f(0xee)]};}}static async['deleteCompanyBucket'](_0x2fadde){const _0x538b4=a642_0x92a5db,_0x2bf3b6=await getGlobalMinioConfig();if(!_0x2bf3b6)return{'success':![],'message':'MinIO\x20não\x20configurado'};try{const _0x43397e=createMinioClient(_0x2bf3b6),_0x42aa7b=await getCompanyBucketName(_0x2bf3b6[_0x538b4(0x110)],_0x2fadde),_0x285137=await _0x43397e[_0x538b4(0x17f)](_0x42aa7b);if(!_0x285137)return{'success':!![],'message':_0x538b4(0x154)};const _0x3fe176=[],_0x1db6b8=_0x43397e[_0x538b4(0x11e)](_0x42aa7b,'',!![]);return await new Promise((_0x24c7a3,_0x1c9179)=>{const _0x240384=_0x538b4;_0x1db6b8['on'](_0x240384(0x107),_0x1c8536=>{const _0x399d12=_0x240384;if(_0x1c8536[_0x399d12(0x18b)])_0x3fe176['push'](_0x1c8536['name']);}),_0x1db6b8['on'](_0x240384(0x121),_0x1c9179),_0x1db6b8['on'](_0x240384(0xf2),_0x24c7a3);}),_0x3fe176[_0x538b4(0x175)]>0x0&&await _0x43397e['removeObjects'](_0x42aa7b,_0x3fe176),await _0x43397e[_0x538b4(0x10f)](_0x42aa7b),{'success':!![],'message':_0x538b4(0x134)+_0x42aa7b+_0x538b4(0x149)};}catch(_0x3bdb12){return console['error'](_0x538b4(0x137),_0x3bdb12),{'success':![],'message':_0x3bdb12[_0x538b4(0xee)]};}}static async['updateBucketQuota'](_0x3f3560,_0x3a1261){const _0x1a7778=a642_0x92a5db,_0x5441ed=await getGlobalMinioConfig();if(!_0x5441ed)return{'success':![],'message':_0x1a7778(0xfd)};const _0x2f5071=await getCompanyBucketName(_0x5441ed['bucket'],_0x3f3560);return console[_0x1a7778(0xf1)](_0x1a7778(0x153)+_0x2f5071+_0x1a7778(0x180)+_0x3a1261+'GB'),console['log'](_0x1a7778(0x143)),{'success':!![],'message':_0x1a7778(0x113)+_0x3a1261+_0x1a7778(0x105)+_0x2f5071+_0x1a7778(0x101)+_0x2f5071+_0x1a7778(0x18c)+_0x3a1261+'GB'};}}exports[a642_0x92a5db(0xf9)]=StorageService;