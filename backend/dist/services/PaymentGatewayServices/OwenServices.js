const a482_0x550723=a482_0x4606;function a482_0x2e60(){const _0xc8982c=['split','constructor','11749740EYcZyc','../../errors/AppError','company','sender','toISOString','open','_owenToken','./PaymentGatewayServices','qrcodeId','377lbiAQe','../../models/Company','get','error','9917776elUesU','paid','142dKnkZd','qrcode','super','/qrdinamico','/qrstatus','json','36jhjQRZ','logger','owenCheckStatus','_owenCnpj','Invoice\x20not\x20found','../SettingServices/GetSuperSettingService','(((.+)+)+)+$','545025hROTpe','../../utils/logger','company-','update','companyId','getIO','default','getDate','18783qOMBXp','emit','owen','3006227khNUTJ','owenPollCheckStatus:\x20Invoice\x20','owenWebhook','404060XJCqmP','reload','setDate','findOne','toFixed','search','CONCLUIDA','body','__esModule','https://api.apipix.me/v1','_owenSecretKey','status','12LbxJTV','valor','defineProperty','data','2120MPXBPQ','__importDefault','value','toString','APPROVED','owenCreateSubscription','-mainchannel','owenCreateSubscription\x20error'];a482_0x2e60=function(){return _0xc8982c;};return a482_0x2e60();}(function(_0xa973a,_0x5dbb30){const _0x257c73=a482_0x4606,_0x2e4152=_0xa973a();while(!![]){try{const _0xfd0337=parseInt(_0x257c73(0x1d5))/0x1*(parseInt(_0x257c73(0x1db))/0x2)+-parseInt(_0x257c73(0x19d))/0x3*(parseInt(_0x257c73(0x1b2))/0x4)+parseInt(_0x257c73(0x1a4))/0x5+parseInt(_0x257c73(0x1be))/0x6*(parseInt(_0x257c73(0x1af))/0x7)+parseInt(_0x257c73(0x1c2))/0x8*(parseInt(_0x257c73(0x1ac))/0x9)+parseInt(_0x257c73(0x1cc))/0xa+-parseInt(_0x257c73(0x1d9))/0xb;if(_0xfd0337===_0x5dbb30)break;else _0x2e4152['push'](_0x2e4152['shift']());}catch(_0x3e84b6){_0x2e4152['push'](_0x2e4152['shift']());}}}(a482_0x2e60,0x94a9f));const a482_0x4d54aa=(function(){let _0x35915b=!![];return function(_0x4065bf,_0x13941b){const _0x5bcc84=_0x35915b?function(){if(_0x13941b){const _0x43af4e=_0x13941b['apply'](_0x4065bf,arguments);return _0x13941b=null,_0x43af4e;}}:function(){};return _0x35915b=![],_0x5bcc84;};}()),a482_0x5f346f=a482_0x4d54aa(this,function(){const _0x289a42=a482_0x4606;return a482_0x5f346f[_0x289a42(0x1c5)]()['search'](_0x289a42(0x1a3))[_0x289a42(0x1c5)]()[_0x289a42(0x1cb)](a482_0x5f346f)[_0x289a42(0x1b7)](_0x289a42(0x1a3));});a482_0x5f346f();'use strict';var __importDefault=this&&this[a482_0x550723(0x1c3)]||function(_0x36e7b8){const _0x477959=a482_0x550723;return _0x36e7b8&&_0x36e7b8[_0x477959(0x1ba)]?_0x36e7b8:{'default':_0x36e7b8};};Object[a482_0x550723(0x1c0)](exports,a482_0x550723(0x1ba),{'value':!![]}),exports[a482_0x550723(0x1c7)]=exports[a482_0x550723(0x19f)]=exports[a482_0x550723(0x1b1)]=void 0x0;const axios_1=__importDefault(require('axios')),GetSuperSettingService_1=__importDefault(require(a482_0x550723(0x1a2))),logger_1=require(a482_0x550723(0x1a5)),socket_1=require('../../libs/socket'),Invoices_1=__importDefault(require('../../models/Invoices')),Company_1=__importDefault(require(a482_0x550723(0x1d6))),AppError_1=__importDefault(require(a482_0x550723(0x1cd))),PaymentGatewayServices_1=require(a482_0x550723(0x1d3)),owenBaseURL=a482_0x550723(0x1bb),owenLoadConfig=async()=>{const _0x1d4439=a482_0x550723;return{'user':await(0x0,GetSuperSettingService_1['default'])({'key':_0x1d4439(0x1a0)}),'password':await(0x0,GetSuperSettingService_1[_0x1d4439(0x1aa)])({'key':_0x1d4439(0x1d2)}),'secretkey':await(0x0,GetSuperSettingService_1[_0x1d4439(0x1aa)])({'key':_0x1d4439(0x1bc)})};},owenWebhook=async(_0x46f2da,_0x51a2f4)=>{const _0x28dde2=a482_0x550723,{data:_0x498f05}=_0x46f2da[_0x28dde2(0x1b9)];if(_0x498f05[_0x28dde2(0x1bd)]==='APPROVED'){const {qrcodeId:_0x2cfd2b}=_0x498f05,_0x5619db=await Invoices_1[_0x28dde2(0x1aa)][_0x28dde2(0x1b5)]({'where':{'txId':_0x2cfd2b,'status':_0x28dde2(0x1d1)},'include':{'model':Company_1['default'],'as':_0x28dde2(0x1ce)}});if(!_0x5619db||_0x498f05[_0x28dde2(0x1bf)]<_0x5619db[_0x28dde2(0x1c4)])return _0x51a2f4['json']({'ok':!![]});const _0x3441fa=new Date(_0x5619db[_0x28dde2(0x1ce)]['dueDate']);_0x3441fa[_0x28dde2(0x1b4)](_0x3441fa[_0x28dde2(0x1ab)]()+0x1e);const _0x49979c=_0x3441fa[_0x28dde2(0x1d0)]()[_0x28dde2(0x1ca)]('T')[0x0];await _0x5619db['company'][_0x28dde2(0x1a7)]({'dueDate':_0x49979c}),await _0x5619db[_0x28dde2(0x1a7)]({'status':'paid'}),await _0x5619db[_0x28dde2(0x1ce)][_0x28dde2(0x1b3)]();const _0x4544e1=(0x0,socket_1[_0x28dde2(0x1a9)])();_0x4544e1['to'](_0x28dde2(0x1a6)+_0x5619db[_0x28dde2(0x1a8)]+_0x28dde2(0x1c8))['to'](_0x28dde2(0x199))[_0x28dde2(0x1ad)]('company-'+_0x5619db['companyId']+'-payment',{'action':_0x28dde2(0x1b8),'company':_0x5619db['company'],'invoiceId':_0x5619db['id']});}return _0x51a2f4[_0x28dde2(0x19c)]({'ok':!![]});};exports[a482_0x550723(0x1b1)]=owenWebhook;const owenCheckStatus=async(_0x54980d,_0x4fcb6f=null)=>{const _0x52b60e=a482_0x550723;try{!_0x4fcb6f&&(_0x4fcb6f=await owenLoadConfig());const _0x4b6184=await axios_1[_0x52b60e(0x1aa)][_0x52b60e(0x1d7)](owenBaseURL+_0x52b60e(0x19b),{'params':{'qrcodeId':_0x54980d['txId'],..._0x4fcb6f}});if(_0x4b6184?.[_0x52b60e(0x1c1)]?.[_0x52b60e(0x1c1)]?.[_0x52b60e(0x1bd)]!==_0x52b60e(0x1c6))return![];if(_0x4b6184?.['data']?.[_0x52b60e(0x1c1)]?.[_0x52b60e(0x1cf)]?.[_0x52b60e(0x1bf)]>=_0x54980d[_0x52b60e(0x1c4)])return await(0x0,PaymentGatewayServices_1['processInvoicePaid'])(_0x54980d),!![];return![];}catch(_0xa2025c){logger_1['logger'][_0x52b60e(0x1d8)](_0xa2025c,'Error\x20getting\x20detail\x20of\x20txid');}return![];};exports['owenCheckStatus']=owenCheckStatus;const owenPollCheckStatus=async(_0x4055ce,_0x4b4bbb,_0x39ce60=0xa,_0x1b548d=0x7530)=>{let _0xfa553a=0x0;async function _0x4a05f2(){const _0x38ab96=a482_0x4606;await _0x4b4bbb[_0x38ab96(0x1b3)]();if(_0x4b4bbb[_0x38ab96(0x1bd)]===_0x38ab96(0x1da)){logger_1['logger']['debug'](_0x38ab96(0x1b0)+_0x4b4bbb['id']+'\x20already\x20paid,\x20finishing\x20polling');return;}const _0x5b7513=await(0x0,exports[_0x38ab96(0x19f)])(_0x4b4bbb,_0x4055ce);if(_0x5b7513)return;_0xfa553a+=0x1;if(_0xfa553a>=_0x39ce60){(0x0,PaymentGatewayServices_1['processInvoiceExpired'])(_0x4b4bbb);return;}await new Promise(_0x4b4d3f=>{setTimeout(_0x4b4d3f,_0x1b548d);}),await _0x4a05f2();}return _0x4a05f2();},owenCreateSubscription=async(_0x1b0210,_0x267445)=>{const _0x5dd5a2=a482_0x550723,{price:_0x415ef4,invoiceId:_0x12b74a}=_0x1b0210[_0x5dd5a2(0x1b9)],_0x79e5bc=await owenLoadConfig(),_0x569072={'params':{'valor':_0x415ef4[_0x5dd5a2(0x1b6)]([0x2]),'minutos':0x5,'mensagem':'#Fatura:'+_0x12b74a,..._0x79e5bc}};try{const _0x5040c8=await Invoices_1[_0x5dd5a2(0x1aa)]['findByPk'](_0x12b74a);if(!_0x5040c8)throw new Error(_0x5dd5a2(0x1a1));const _0x5655c1=await axios_1['default'][_0x5dd5a2(0x1d7)](owenBaseURL+_0x5dd5a2(0x19a),_0x569072);return _0x5040c8[_0x5dd5a2(0x1a7)]({'value':_0x415ef4,'txId':_0x5655c1[_0x5dd5a2(0x1c1)][_0x5dd5a2(0x1c1)][_0x5dd5a2(0x1d4)],'payGw':_0x5dd5a2(0x1ae),'payGwData':JSON['stringify'](_0x5655c1[_0x5dd5a2(0x1c1)][_0x5dd5a2(0x1c1)])}),owenPollCheckStatus(_0x79e5bc,_0x5040c8),_0x267445['json']({'qrcode':{'qrcode':_0x5655c1[_0x5dd5a2(0x1c1)]['data'][_0x5dd5a2(0x198)]},'valor':{'original':_0x415ef4}});}catch(_0x34c187){logger_1[_0x5dd5a2(0x19e)][_0x5dd5a2(0x1d8)]({'error':_0x34c187},_0x5dd5a2(0x1c9));throw new AppError_1[(_0x5dd5a2(0x1aa))]('Problema\x20encontrado,\x20entre\x20em\x20contato\x20com\x20o\x20suporte!',0x190);}};function a482_0x4606(_0x5bbab9,_0x3d7d06){const _0x41f8b5=a482_0x2e60();return a482_0x4606=function(_0x5f346f,_0x4d54aa){_0x5f346f=_0x5f346f-0x198;let _0x2e607f=_0x41f8b5[_0x5f346f];return _0x2e607f;},a482_0x4606(_0x5bbab9,_0x3d7d06);}exports[a482_0x550723(0x1c7)]=owenCreateSubscription;