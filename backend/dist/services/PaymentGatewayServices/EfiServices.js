function a452_0x1354(){const _0x2f5205=['CONCLUIDA','pixConfigWebhook\x20error:','logger','Error\x20getting\x20detail\x20of\x20txid','join','../../errors/AppError','_efiClientSecret','env','Invoice\x20not\x20found','search','findByPk','https://','../../models/Invoices','update','(((.+)+)+)+$','2345605lWByeH','processInvoicePaid','info','txid','8742444qkgXWj','pix','toLocaleString','body','#Fatura:','error','efiWebhook:\x20Invoice\x20not\x20found\x20or\x20already\x20paid','2370039FbTSNR','efiWebhook','pixDetailCharge','efiInitialize:\x20webhook\x20correto\x20jÃ¡\x20instalado','nome','9lIJgmT','json','34041936FmMnea','pt-br','paid','__importDefault','4EvNceL','valor','1252917wWHPPH','efiInitialize','../SettingServices/GetSuperSettingService','sdk-node-apis-efi','/subscription/aa/webhook','value','then','12gTcMMP','BACKEND_URL','teste_webhook','company','__esModule','default','1130oxWQRU','../../models/Company','efiPollCheckStatus:\x20Invoice\x20','_efiClientId','reload','14705048LPXeCa','debug','stringify','efiCheckStatus','_paymentGateway','_efiCertFile','pixConfigWebhook\x20ok','efi','txId','7XkGWpT','188892gscIyn','Processando\x20pagamento','original','_efiPixKey','pixDetailWebhook','efiCreateSubscription','startsWith','../../utils/logger','efiInitialize:\x20fail\x20to\x20verify\x20current\x20webhook','open','\x20already\x20paid,\x20finishing\x20polling','efiInitialize:\x20only\x20SSL\x20webhooks\x20are\x20supported'];a452_0x1354=function(){return _0x2f5205;};return a452_0x1354();}const a452_0x3a1e1b=a452_0x504e;(function(_0x54a586,_0x312fd0){const _0x111c6f=a452_0x504e,_0x2fdd06=_0x54a586();while(!![]){try{const _0x2a8f91=-parseInt(_0x111c6f(0x7b))/0x1+-parseInt(_0x111c6f(0x79))/0x2*(parseInt(_0x111c6f(0xbd))/0x3)+-parseInt(_0x111c6f(0x82))/0x4*(-parseInt(_0x111c6f(0xb2))/0x5)+parseInt(_0x111c6f(0xb6))/0x6*(parseInt(_0x111c6f(0x96))/0x7)+-parseInt(_0x111c6f(0x8d))/0x8*(-parseInt(_0x111c6f(0x73))/0x9)+parseInt(_0x111c6f(0x88))/0xa*(parseInt(_0x111c6f(0x97))/0xb)+-parseInt(_0x111c6f(0x75))/0xc;if(_0x2a8f91===_0x312fd0)break;else _0x2fdd06['push'](_0x2fdd06['shift']());}catch(_0x855de1){_0x2fdd06['push'](_0x2fdd06['shift']());}}}(a452_0x1354,0xed9b1));const a452_0x360aad=(function(){let _0x6de84e=!![];return function(_0x5ba784,_0x18d42b){const _0x41a239=_0x6de84e?function(){if(_0x18d42b){const _0x346154=_0x18d42b['apply'](_0x5ba784,arguments);return _0x18d42b=null,_0x346154;}}:function(){};return _0x6de84e=![],_0x41a239;};}()),a452_0xbd2d5a=a452_0x360aad(this,function(){const _0x391fdf=a452_0x504e;return a452_0xbd2d5a['toString']()[_0x391fdf(0xac)](_0x391fdf(0xb1))['toString']()['constructor'](a452_0xbd2d5a)[_0x391fdf(0xac)](_0x391fdf(0xb1));});a452_0xbd2d5a();'use strict';var __importDefault=this&&this[a452_0x3a1e1b(0x78)]||function(_0x5de4c6){const _0x3e99d9=a452_0x3a1e1b;return _0x5de4c6&&_0x5de4c6[_0x3e99d9(0x86)]?_0x5de4c6:{'default':_0x5de4c6};};function a452_0x504e(_0x37bda3,_0x5b5f44){const _0x56b145=a452_0x1354();return a452_0x504e=function(_0xbd2d5a,_0x360aad){_0xbd2d5a=_0xbd2d5a-0x71;let _0x135417=_0x56b145[_0xbd2d5a];return _0x135417;},a452_0x504e(_0x37bda3,_0x5b5f44);}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a452_0x3a1e1b(0x9c)]=exports['efiCheckStatus']=exports[a452_0x3a1e1b(0xbe)]=exports[a452_0x3a1e1b(0x7c)]=void 0x0;const sdk_node_apis_efi_1=__importDefault(require(a452_0x3a1e1b(0x7e))),path_1=__importDefault(require('path')),GetSuperSettingService_1=__importDefault(require(a452_0x3a1e1b(0x7d))),logger_1=require(a452_0x3a1e1b(0x9e)),Invoices_1=__importDefault(require(a452_0x3a1e1b(0xaf))),Company_1=__importDefault(require(a452_0x3a1e1b(0x89))),AppError_1=__importDefault(require(a452_0x3a1e1b(0xa8))),PaymentGatewayServices_1=require('./PaymentGatewayServices'),webhookUrl=process[a452_0x3a1e1b(0xaa)][a452_0x3a1e1b(0x83)]+a452_0x3a1e1b(0x7f);async function getEfiOptions(){const _0x27bea9=a452_0x3a1e1b,_0xacfc49=path_1[_0x27bea9(0x87)][_0x27bea9(0xa7)](__dirname,'../../../private/'+await(0x0,GetSuperSettingService_1[_0x27bea9(0x87)])({'key':_0x27bea9(0x92)}));return{'sandbox':![],'client_id':await(0x0,GetSuperSettingService_1[_0x27bea9(0x87)])({'key':_0x27bea9(0x8b)}),'client_secret':await(0x0,GetSuperSettingService_1['default'])({'key':_0x27bea9(0xa9)}),'pix_cert':_0xacfc49,'validateMtls':![]};}const newEfiPayInstance=async()=>{const _0x5cb5ec=a452_0x3a1e1b,_0x2c6fef=await getEfiOptions();return new sdk_node_apis_efi_1[(_0x5cb5ec(0x87))](_0x2c6fef);},createWebHook=async _0x321a3e=>{const _0x441797=a452_0x3a1e1b,_0x442d49={'chave':await(0x0,GetSuperSettingService_1[_0x441797(0x87)])({'key':_0x441797(0x9a)})},_0x4593ca={'webhookUrl':webhookUrl};return _0x321a3e['pixConfigWebhook'](_0x442d49,_0x4593ca)[_0x441797(0x81)](_0x5558af=>{const _0x50ef64=_0x441797;logger_1[_0x50ef64(0xa5)][_0x50ef64(0xb4)]({'result':_0x5558af},_0x50ef64(0x93));},_0x3a7a81=>{const _0x20950f=_0x441797;logger_1[_0x20950f(0xa5)][_0x20950f(0xbb)]({'result':_0x3a7a81},_0x20950f(0xa4));});},efiInitialize=async()=>{const _0x4d27fd=a452_0x3a1e1b,_0x2efeca=await(0x0,GetSuperSettingService_1[_0x4d27fd(0x87)])({'key':_0x4d27fd(0x91)});if(!webhookUrl[_0x4d27fd(0x9d)](_0x4d27fd(0xae))){logger_1['logger'][_0x4d27fd(0x8e)](_0x4d27fd(0xa2));return;}try{if(_0x2efeca===_0x4d27fd(0x94)){const _0x15a8bf=await getEfiOptions(),_0x3511ad=new sdk_node_apis_efi_1[(_0x4d27fd(0x87))](_0x15a8bf),_0x281bc2={'chave':await(0x0,GetSuperSettingService_1['default'])({'key':'_efiPixKey'})};_0x3511ad[_0x4d27fd(0x9b)](_0x281bc2)[_0x4d27fd(0x81)](_0x4730bf=>{const _0x237f4d=_0x4d27fd;_0x4730bf?.['webhookUrl']!==webhookUrl?createWebHook(_0x3511ad):logger_1[_0x237f4d(0xa5)][_0x237f4d(0x8e)]({'result':_0x4730bf},_0x237f4d(0x71));},_0x122692=>{const _0x2d3246=_0x4d27fd;_0x122692?.[_0x2d3246(0x72)]==='webhook_nao_encontrado'?createWebHook(_0x3511ad):logger_1[_0x2d3246(0xa5)][_0x2d3246(0xbb)](_0x122692,_0x2d3246(0x9f));});}}catch(_0x1f9e25){logger_1['logger']['error'](_0x1f9e25,'efiInitialize:\x20');}};exports[a452_0x3a1e1b(0x7c)]=efiInitialize;const efiWebhook=async(_0xcd75,_0x3d24b4)=>{const _0x579a00=a452_0x3a1e1b,{evento:_0x27dd04}=_0xcd75[_0x579a00(0xb9)];if(_0x27dd04===_0x579a00(0x84))return _0x3d24b4['json']({'ok':!![]});return _0xcd75[_0x579a00(0xb9)][_0x579a00(0xb7)]&&await Promise['all'](_0xcd75[_0x579a00(0xb9)][_0x579a00(0xb7)]['map'](async _0x12d0be=>{const _0x1c6a6a=_0x579a00;logger_1['logger']['debug'](_0x12d0be,_0x1c6a6a(0x98));const _0x36fd4b=await Invoices_1['default']['findOne']({'where':{'txId':_0x12d0be[_0x1c6a6a(0xb5)],'status':_0x1c6a6a(0xa0)},'include':[{'model':Company_1[_0x1c6a6a(0x87)],'as':_0x1c6a6a(0x85)}]});if(!_0x36fd4b){logger_1[_0x1c6a6a(0xa5)][_0x1c6a6a(0x8e)](_0x1c6a6a(0xbc));return;}const _0x3f7b02=parseFloat(_0x12d0be[_0x1c6a6a(0x7a)]);if(_0x3f7b02<_0x36fd4b[_0x1c6a6a(0x80)]){logger_1[_0x1c6a6a(0xa5)]['debug']('Recebido\x20valor\x20menor');return;}await(0x0,PaymentGatewayServices_1[_0x1c6a6a(0xb3)])(_0x36fd4b);})),_0x3d24b4[_0x579a00(0x74)]({'ok':!![]});};exports[a452_0x3a1e1b(0xbe)]=efiWebhook;const efiCheckStatus=async(_0x5c80a4,_0x5111bc=null)=>{const _0x5b95f6=a452_0x3a1e1b;try{!_0x5111bc&&(_0x5111bc=await newEfiPayInstance());const _0x4477d9=await _0x5111bc[_0x5b95f6(0xbf)]({'txid':_0x5c80a4[_0x5b95f6(0x95)]});if(_0x4477d9['status']!==_0x5b95f6(0xa3))return![];const {pix:_0x186b97}=_0x4477d9,_0x4c46d1=parseFloat(_0x186b97[0x0][_0x5b95f6(0x7a)]);if(_0x4c46d1>=_0x5c80a4[_0x5b95f6(0x80)])return await(0x0,PaymentGatewayServices_1[_0x5b95f6(0xb3)])(_0x5c80a4),!![];return![];}catch(_0x2ee193){logger_1[_0x5b95f6(0xa5)][_0x5b95f6(0xbb)](_0x2ee193,_0x5b95f6(0xa6));}return![];};exports[a452_0x3a1e1b(0x90)]=efiCheckStatus;const efiPollCheckStatus=async(_0x4e3da8,_0x4cd38e,_0xa74c46=0xa,_0x3396ba=0x7530)=>{let _0x3eadee=0x0;async function _0x2873c2(){const _0x15aea2=a452_0x504e;await _0x4cd38e[_0x15aea2(0x8c)]();if(_0x4cd38e['status']===_0x15aea2(0x77)){logger_1[_0x15aea2(0xa5)][_0x15aea2(0x8e)](_0x15aea2(0x8a)+_0x4cd38e['id']+_0x15aea2(0xa1));return;}const _0x286e14=await(0x0,exports['efiCheckStatus'])(_0x4cd38e,_0x4e3da8);if(_0x286e14)return;_0x3eadee+=0x1;if(_0x3eadee>=_0xa74c46){(0x0,PaymentGatewayServices_1['processInvoiceExpired'])(_0x4cd38e);return;}await new Promise(_0x2530ee=>setTimeout(_0x2530ee,_0x3396ba)),await _0x2873c2();}return _0x2873c2();},efiCreateSubscription=async(_0x1340f0,_0xab1d38)=>{const _0x14792f=a452_0x3a1e1b,{price:_0x36cc64,invoiceId:_0x40861a}=_0x1340f0['body'],_0x341c95=parseFloat(_0x36cc64),_0x32ca34={'calendario':{'expiracao':0x12c},'valor':{'original':_0x341c95[_0x14792f(0xb8)](_0x14792f(0x76),{'minimumFractionDigits':0x2})['replace'](',','.')},'chave':await(0x0,GetSuperSettingService_1[_0x14792f(0x87)])({'key':'_efiPixKey'}),'solicitacaoPagador':_0x14792f(0xba)+_0x40861a},_0x3de94e=await getEfiOptions();try{const _0x386c7a=await Invoices_1[_0x14792f(0x87)][_0x14792f(0xad)](_0x40861a);if(!_0x386c7a)throw new Error(_0x14792f(0xab));await(0x0,exports[_0x14792f(0x7c)])();const _0x57df0e=new sdk_node_apis_efi_1[(_0x14792f(0x87))](_0x3de94e),_0x241862=await _0x57df0e['pixCreateImmediateCharge']([],_0x32ca34);return await _0x386c7a[_0x14792f(0xb0)]({'txId':_0x241862[_0x14792f(0xb5)],'payGw':_0x14792f(0x94),'payGwData':JSON[_0x14792f(0x8f)](_0x241862)}),await _0x386c7a[_0x14792f(0x8c)](),efiPollCheckStatus(_0x57df0e,_0x386c7a),_0xab1d38[_0x14792f(0x74)]({'qrcode':{'qrcode':_0x241862['pixCopiaECola']},'valor':{'original':_0x32ca34[_0x14792f(0x7a)][_0x14792f(0x99)]}});}catch(_0xcf9189){logger_1[_0x14792f(0xa5)]['error']({'efiOptions':_0x3de94e,'error':_0xcf9189},'efiCreateSubscription\x20error');throw new AppError_1['default']('Problema\x20encontrado,\x20entre\x20em\x20contato\x20com\x20o\x20suporte!',0x190);}};exports[a452_0x3a1e1b(0x9c)]=efiCreateSubscription;