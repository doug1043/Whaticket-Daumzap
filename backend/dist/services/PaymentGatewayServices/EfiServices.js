const a448_0xae2e0=a448_0xd34e;function a448_0x1e66(){const _0x3cda44=['1625121RRmilS','apply','759911eKNcON','valor','logger','efiInitialize:\x20','sdk-node-apis-efi','defineProperty','efiWebhook','paid','original','65ysnFzk','processInvoiceExpired','../../../private/','debug','pixDetailCharge','BACKEND_URL','7NntJQh','efiInitialize:\x20webhook\x20correto\x20jÃ¡\x20instalado','body','error','pixConfigWebhook\x20ok','_efiPixKey','../../models/Invoices','env','../../errors/AppError','efiCreateSubscription\x20error','../SettingServices/GetSuperSettingService','9506298Gavfzi','efiCheckStatus','_paymentGateway','reload','pixConfigWebhook','../../utils/logger','efiInitialize:\x20fail\x20to\x20verify\x20current\x20webhook','Invoice\x20not\x20found','__importDefault','txId','findOne','toString','findByPk','Error\x20getting\x20detail\x20of\x20txid','efiPollCheckStatus:\x20Invoice\x20','then','efiWebhook:\x20Invoice\x20not\x20found\x20or\x20already\x20paid','constructor','pix','company','stringify','default','(((.+)+)+)+$','json','./PaymentGatewayServices','txid','replace','_efiCertFile','webhook_nao_encontrado','status','pixDetailWebhook','/subscription/aa/webhook','692144UjRQlw','18132417ddciZP','efiInitialize:\x20only\x20SSL\x20webhooks\x20are\x20supported','value','pixCreateImmediateCharge','map','__esModule','efiInitialize','all','#Fatura:','pixConfigWebhook\x20error:','join','info','_efiClientId','processInvoicePaid','44132mGmumh','update','CONCLUIDA','search','efiCreateSubscription','1965360FPSDCj','toLocaleString','efi'];a448_0x1e66=function(){return _0x3cda44;};return a448_0x1e66();}(function(_0x3046b8,_0x4c1179){const _0x86890c=a448_0xd34e,_0x2b054a=_0x3046b8();while(!![]){try{const _0x35cf1d=parseInt(_0x86890c(0x16c))/0x1+parseInt(_0x86890c(0x153))/0x2+parseInt(_0x86890c(0x16a))/0x3+parseInt(_0x86890c(0x162))/0x4*(-parseInt(_0x86890c(0x175))/0x5)+-parseInt(_0x86890c(0x186))/0x6*(-parseInt(_0x86890c(0x17b))/0x7)+-parseInt(_0x86890c(0x167))/0x8+-parseInt(_0x86890c(0x154))/0x9;if(_0x35cf1d===_0x4c1179)break;else _0x2b054a['push'](_0x2b054a['shift']());}catch(_0x491b82){_0x2b054a['push'](_0x2b054a['shift']());}}}(a448_0x1e66,0xca365));const a448_0x30dc70=(function(){let _0x193e49=!![];return function(_0x463f1b,_0x272ce4){const _0x496066=_0x193e49?function(){const _0x16e718=a448_0xd34e;if(_0x272ce4){const _0x228c60=_0x272ce4[_0x16e718(0x16b)](_0x463f1b,arguments);return _0x272ce4=null,_0x228c60;}}:function(){};return _0x193e49=![],_0x496066;};}()),a448_0x43e38e=a448_0x30dc70(this,function(){const _0x5c4f41=a448_0xd34e;return a448_0x43e38e[_0x5c4f41(0x13e)]()[_0x5c4f41(0x165)](_0x5c4f41(0x149))[_0x5c4f41(0x13e)]()[_0x5c4f41(0x144)](a448_0x43e38e)['search'](_0x5c4f41(0x149));});a448_0x43e38e();'use strict';var __importDefault=this&&this[a448_0xae2e0(0x13b)]||function(_0x33809c){const _0x46f85d=a448_0xae2e0;return _0x33809c&&_0x33809c[_0x46f85d(0x159)]?_0x33809c:{'default':_0x33809c};};Object[a448_0xae2e0(0x171)](exports,'__esModule',{'value':!![]}),exports[a448_0xae2e0(0x166)]=exports[a448_0xae2e0(0x187)]=exports[a448_0xae2e0(0x172)]=exports[a448_0xae2e0(0x15a)]=void 0x0;function a448_0xd34e(_0x3d5f90,_0x4a1d49){const _0x5e8400=a448_0x1e66();return a448_0xd34e=function(_0x43e38e,_0x30dc70){_0x43e38e=_0x43e38e-0x137;let _0x1e662e=_0x5e8400[_0x43e38e];return _0x1e662e;},a448_0xd34e(_0x3d5f90,_0x4a1d49);}const sdk_node_apis_efi_1=__importDefault(require(a448_0xae2e0(0x170))),path_1=__importDefault(require('path')),GetSuperSettingService_1=__importDefault(require(a448_0xae2e0(0x185))),logger_1=require(a448_0xae2e0(0x138)),Invoices_1=__importDefault(require(a448_0xae2e0(0x181))),Company_1=__importDefault(require('../../models/Company')),AppError_1=__importDefault(require(a448_0xae2e0(0x183))),PaymentGatewayServices_1=require(a448_0xae2e0(0x14b)),webhookUrl=process[a448_0xae2e0(0x182)][a448_0xae2e0(0x17a)]+a448_0xae2e0(0x152);async function getEfiOptions(){const _0x3f67b1=a448_0xae2e0,_0x5d0888=path_1[_0x3f67b1(0x148)][_0x3f67b1(0x15e)](__dirname,_0x3f67b1(0x177)+await(0x0,GetSuperSettingService_1['default'])({'key':_0x3f67b1(0x14e)}));return{'sandbox':![],'client_id':await(0x0,GetSuperSettingService_1[_0x3f67b1(0x148)])({'key':_0x3f67b1(0x160)}),'client_secret':await(0x0,GetSuperSettingService_1['default'])({'key':'_efiClientSecret'}),'pix_cert':_0x5d0888,'validateMtls':![]};}const newEfiPayInstance=async()=>{const _0x3b3fad=await getEfiOptions();return new sdk_node_apis_efi_1['default'](_0x3b3fad);},createWebHook=async _0x1f377d=>{const _0x416796=a448_0xae2e0,_0x1f317c={'chave':await(0x0,GetSuperSettingService_1['default'])({'key':_0x416796(0x180)})},_0x31778c={'webhookUrl':webhookUrl};return _0x1f377d[_0x416796(0x137)](_0x1f317c,_0x31778c)[_0x416796(0x142)](_0x2ccbd2=>{const _0x10d1e5=_0x416796;logger_1[_0x10d1e5(0x16e)][_0x10d1e5(0x15f)]({'result':_0x2ccbd2},_0x10d1e5(0x17f));},_0x52c4b3=>{const _0x73ed38=_0x416796;logger_1[_0x73ed38(0x16e)][_0x73ed38(0x17e)]({'result':_0x52c4b3},_0x73ed38(0x15d));});},efiInitialize=async()=>{const _0x2be198=a448_0xae2e0,_0x235461=await(0x0,GetSuperSettingService_1['default'])({'key':_0x2be198(0x188)});if(!webhookUrl['startsWith']('https://')){logger_1[_0x2be198(0x16e)]['debug'](_0x2be198(0x155));return;}try{if(_0x235461===_0x2be198(0x169)){const _0x10a17c=await getEfiOptions(),_0x1324ac=new sdk_node_apis_efi_1['default'](_0x10a17c),_0x21b845={'chave':await(0x0,GetSuperSettingService_1[_0x2be198(0x148)])({'key':_0x2be198(0x180)})};_0x1324ac[_0x2be198(0x151)](_0x21b845)[_0x2be198(0x142)](_0x4df976=>{const _0x297f0b=_0x2be198;_0x4df976?.['webhookUrl']!==webhookUrl?createWebHook(_0x1324ac):logger_1[_0x297f0b(0x16e)][_0x297f0b(0x178)]({'result':_0x4df976},_0x297f0b(0x17c));},_0x392311=>{const _0x71ab53=_0x2be198;_0x392311?.['nome']===_0x71ab53(0x14f)?createWebHook(_0x1324ac):logger_1[_0x71ab53(0x16e)][_0x71ab53(0x17e)](_0x392311,_0x71ab53(0x139));});}}catch(_0x3f4960){logger_1[_0x2be198(0x16e)][_0x2be198(0x17e)](_0x3f4960,_0x2be198(0x16f));}};exports[a448_0xae2e0(0x15a)]=efiInitialize;const efiWebhook=async(_0xb1e123,_0x39f023)=>{const _0x47c4aa=a448_0xae2e0,{evento:_0x4d2a6b}=_0xb1e123[_0x47c4aa(0x17d)];if(_0x4d2a6b==='teste_webhook')return _0x39f023[_0x47c4aa(0x14a)]({'ok':!![]});return _0xb1e123[_0x47c4aa(0x17d)][_0x47c4aa(0x145)]&&await Promise[_0x47c4aa(0x15b)](_0xb1e123['body'][_0x47c4aa(0x145)][_0x47c4aa(0x158)](async _0x2e9191=>{const _0x13e0c8=_0x47c4aa;logger_1[_0x13e0c8(0x16e)][_0x13e0c8(0x178)](_0x2e9191,'Processando\x20pagamento');const _0x139008=await Invoices_1[_0x13e0c8(0x148)][_0x13e0c8(0x13d)]({'where':{'txId':_0x2e9191['txid'],'status':'open'},'include':[{'model':Company_1[_0x13e0c8(0x148)],'as':_0x13e0c8(0x146)}]});if(!_0x139008){logger_1[_0x13e0c8(0x16e)]['debug'](_0x13e0c8(0x143));return;}const _0x45a6fb=parseFloat(_0x2e9191[_0x13e0c8(0x16d)]);if(_0x45a6fb<_0x139008['value']){logger_1[_0x13e0c8(0x16e)]['debug']('Recebido\x20valor\x20menor');return;}await(0x0,PaymentGatewayServices_1[_0x13e0c8(0x161)])(_0x139008);})),_0x39f023[_0x47c4aa(0x14a)]({'ok':!![]});};exports[a448_0xae2e0(0x172)]=efiWebhook;const efiCheckStatus=async(_0x37af58,_0x35c282=null)=>{const _0x431d2f=a448_0xae2e0;try{!_0x35c282&&(_0x35c282=await newEfiPayInstance());const _0x4ce1c6=await _0x35c282[_0x431d2f(0x179)]({'txid':_0x37af58[_0x431d2f(0x13c)]});if(_0x4ce1c6['status']!==_0x431d2f(0x164))return![];const {pix:_0xcd76be}=_0x4ce1c6,_0x23e7c8=parseFloat(_0xcd76be[0x0][_0x431d2f(0x16d)]);if(_0x23e7c8>=_0x37af58[_0x431d2f(0x156)])return await(0x0,PaymentGatewayServices_1['processInvoicePaid'])(_0x37af58),!![];return![];}catch(_0x3ba94f){logger_1[_0x431d2f(0x16e)][_0x431d2f(0x17e)](_0x3ba94f,_0x431d2f(0x140));}return![];};exports['efiCheckStatus']=efiCheckStatus;const efiPollCheckStatus=async(_0x17ad4a,_0x395fc2,_0x30c667=0xa,_0x337bc1=0x7530)=>{let _0x5a116c=0x0;async function _0x2de1db(){const _0x1b5f45=a448_0xd34e;await _0x395fc2[_0x1b5f45(0x189)]();if(_0x395fc2[_0x1b5f45(0x150)]===_0x1b5f45(0x173)){logger_1[_0x1b5f45(0x16e)]['debug'](_0x1b5f45(0x141)+_0x395fc2['id']+'\x20already\x20paid,\x20finishing\x20polling');return;}const _0x3a49d4=await(0x0,exports[_0x1b5f45(0x187)])(_0x395fc2,_0x17ad4a);if(_0x3a49d4)return;_0x5a116c+=0x1;if(_0x5a116c>=_0x30c667){(0x0,PaymentGatewayServices_1[_0x1b5f45(0x176)])(_0x395fc2);return;}await new Promise(_0x377fe6=>setTimeout(_0x377fe6,_0x337bc1)),await _0x2de1db();}return _0x2de1db();},efiCreateSubscription=async(_0x10afd6,_0x5a44c6)=>{const _0x56c008=a448_0xae2e0,{price:_0x3b0f07,invoiceId:_0x5ca5ef}=_0x10afd6['body'],_0x19e543=parseFloat(_0x3b0f07),_0x110480={'calendario':{'expiracao':0x12c},'valor':{'original':_0x19e543[_0x56c008(0x168)]('pt-br',{'minimumFractionDigits':0x2})[_0x56c008(0x14d)](',','.')},'chave':await(0x0,GetSuperSettingService_1['default'])({'key':'_efiPixKey'}),'solicitacaoPagador':_0x56c008(0x15c)+_0x5ca5ef},_0x4a1a94=await getEfiOptions();try{const _0x1e8e0f=await Invoices_1[_0x56c008(0x148)][_0x56c008(0x13f)](_0x5ca5ef);if(!_0x1e8e0f)throw new Error(_0x56c008(0x13a));await(0x0,exports[_0x56c008(0x15a)])();const _0x1decae=new sdk_node_apis_efi_1['default'](_0x4a1a94),_0x543d97=await _0x1decae[_0x56c008(0x157)]([],_0x110480);return await _0x1e8e0f[_0x56c008(0x163)]({'txId':_0x543d97[_0x56c008(0x14c)],'payGw':_0x56c008(0x169),'payGwData':JSON[_0x56c008(0x147)](_0x543d97)}),await _0x1e8e0f[_0x56c008(0x189)](),efiPollCheckStatus(_0x1decae,_0x1e8e0f),_0x5a44c6[_0x56c008(0x14a)]({'qrcode':{'qrcode':_0x543d97['pixCopiaECola']},'valor':{'original':_0x110480[_0x56c008(0x16d)][_0x56c008(0x174)]}});}catch(_0x1603c5){logger_1[_0x56c008(0x16e)]['error']({'efiOptions':_0x4a1a94,'error':_0x1603c5},_0x56c008(0x184));throw new AppError_1[(_0x56c008(0x148))]('Problema\x20encontrado,\x20entre\x20em\x20contato\x20com\x20o\x20suporte!',0x190);}};exports['efiCreateSubscription']=efiCreateSubscription;