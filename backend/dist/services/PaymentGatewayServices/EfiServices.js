const a450_0x1cf8aa=a450_0x2280;function a450_0x4890(){const _0x4e65da=['pixConfigWebhook','Problema\x20encontrado,\x20entre\x20em\x20contato\x20com\x20o\x20suporte!','1046925yAZygI','pix','efiCreateSubscription\x20error','22910BnPLPj','pixCreateImmediateCharge','1280532jRvNrb','startsWith','json','debug','__esModule','path','pixDetailCharge','efiPollCheckStatus:\x20Invoice\x20','__importDefault','pixCopiaECola','reload','env','constructor','2921796ZZOyzi','Recebido\x20valor\x20menor','(((.+)+)+)+$','#Fatura:','open','8ljyeUt','processInvoiceExpired','pixConfigWebhook\x20error:','webhook_nao_encontrado','paid','default','efiInitialize:\x20fail\x20to\x20verify\x20current\x20webhook','651592yzhxuF','map','../../models/Company','../../utils/logger','value','https://','CONCLUIDA','processInvoicePaid','4081QxdODr','info','pixDetailWebhook','../../errors/AppError','efiInitialize:\x20webhook\x20correto\x20jÃ¡\x20instalado','../../../private/','apply','../../models/Invoices','findOne','efiInitialize:\x20','_efiClientId','Invoice\x20not\x20found','efiInitialize','body','_efiPixKey','BACKEND_URL','error','replace','nome','69678JOVHeM','efiInitialize:\x20only\x20SSL\x20webhooks\x20are\x20supported','../SettingServices/GetSuperSettingService','sdk-node-apis-efi','efi','Processando\x20pagamento','then','efiCheckStatus','./PaymentGatewayServices','logger','status','join','stringify','efiCreateSubscription','efiWebhook','600cdmpie','_efiCertFile','txid','company','458108eVbCdx','valor','Error\x20getting\x20detail\x20of\x20txid','_paymentGateway','search','txId','30xsSrzQ'];a450_0x4890=function(){return _0x4e65da;};return a450_0x4890();}(function(_0x363e19,_0x38373e){const _0x518a58=a450_0x2280,_0x567d1c=_0x363e19();while(!![]){try{const _0x135a76=parseInt(_0x518a58(0xdc))/0x1+-parseInt(_0x518a58(0xc3))/0x2+-parseInt(_0x518a58(0x110))/0x3*(-parseInt(_0x518a58(0x10a))/0x4)+-parseInt(_0x518a58(0x113))/0x5+-parseInt(_0x518a58(0x106))/0x6*(-parseInt(_0x518a58(0xf7))/0x7)+parseInt(_0x518a58(0xd5))/0x8*(-parseInt(_0x518a58(0xd0))/0x9)+-parseInt(_0x518a58(0x116))/0xa*(parseInt(_0x518a58(0xe4))/0xb);if(_0x135a76===_0x38373e)break;else _0x567d1c['push'](_0x567d1c['shift']());}catch(_0xac3859){_0x567d1c['push'](_0x567d1c['shift']());}}}(a450_0x4890,0xbb806));function a450_0x2280(_0x51fe46,_0x2ab41a){const _0x2625fb=a450_0x4890();return a450_0x2280=function(_0x346a1c,_0x2001a2){_0x346a1c=_0x346a1c-0xc3;let _0x48907c=_0x2625fb[_0x346a1c];return _0x48907c;},a450_0x2280(_0x51fe46,_0x2ab41a);}const a450_0x2001a2=(function(){let _0x38a75a=!![];return function(_0x5b8483,_0x54801c){const _0x38281f=_0x38a75a?function(){const _0xb99956=a450_0x2280;if(_0x54801c){const _0x5c1b59=_0x54801c[_0xb99956(0xea)](_0x5b8483,arguments);return _0x54801c=null,_0x5c1b59;}}:function(){};return _0x38a75a=![],_0x38281f;};}()),a450_0x346a1c=a450_0x2001a2(this,function(){const _0x4c59d2=a450_0x2280;return a450_0x346a1c['toString']()[_0x4c59d2(0x10e)](_0x4c59d2(0xd2))['toString']()[_0x4c59d2(0xcf)](a450_0x346a1c)[_0x4c59d2(0x10e)]('(((.+)+)+)+$');});a450_0x346a1c();'use strict';var __importDefault=this&&this[a450_0x1cf8aa(0xcb)]||function(_0x26edbd){const _0x2753ed=a450_0x1cf8aa;return _0x26edbd&&_0x26edbd[_0x2753ed(0xc7)]?_0x26edbd:{'default':_0x26edbd};};Object['defineProperty'](exports,a450_0x1cf8aa(0xc7),{'value':!![]}),exports['efiCreateSubscription']=exports[a450_0x1cf8aa(0xfe)]=exports[a450_0x1cf8aa(0x105)]=exports[a450_0x1cf8aa(0xf0)]=void 0x0;const sdk_node_apis_efi_1=__importDefault(require(a450_0x1cf8aa(0xfa))),path_1=__importDefault(require(a450_0x1cf8aa(0xc8))),GetSuperSettingService_1=__importDefault(require(a450_0x1cf8aa(0xf9))),logger_1=require(a450_0x1cf8aa(0xdf)),Invoices_1=__importDefault(require(a450_0x1cf8aa(0xeb))),Company_1=__importDefault(require(a450_0x1cf8aa(0xde))),AppError_1=__importDefault(require(a450_0x1cf8aa(0xe7))),PaymentGatewayServices_1=require(a450_0x1cf8aa(0xff)),webhookUrl=process[a450_0x1cf8aa(0xce)][a450_0x1cf8aa(0xf3)]+'/subscription/aa/webhook';async function getEfiOptions(){const _0x7dc241=a450_0x1cf8aa,_0x57f586=path_1[_0x7dc241(0xda)][_0x7dc241(0x102)](__dirname,_0x7dc241(0xe9)+await(0x0,GetSuperSettingService_1[_0x7dc241(0xda)])({'key':_0x7dc241(0x107)}));return{'sandbox':![],'client_id':await(0x0,GetSuperSettingService_1['default'])({'key':_0x7dc241(0xee)}),'client_secret':await(0x0,GetSuperSettingService_1['default'])({'key':'_efiClientSecret'}),'pix_cert':_0x57f586,'validateMtls':![]};}const newEfiPayInstance=async()=>{const _0x591a70=await getEfiOptions();return new sdk_node_apis_efi_1['default'](_0x591a70);},createWebHook=async _0x44664e=>{const _0x5f3b2a=a450_0x1cf8aa,_0x3a9897={'chave':await(0x0,GetSuperSettingService_1[_0x5f3b2a(0xda)])({'key':_0x5f3b2a(0xf2)})},_0x3d8e2e={'webhookUrl':webhookUrl};return _0x44664e[_0x5f3b2a(0x111)](_0x3a9897,_0x3d8e2e)[_0x5f3b2a(0xfd)](_0x478d2b=>{const _0x4ccdff=_0x5f3b2a;logger_1['logger'][_0x4ccdff(0xe5)]({'result':_0x478d2b},'pixConfigWebhook\x20ok');},_0x35d5df=>{const _0x540533=_0x5f3b2a;logger_1[_0x540533(0x100)][_0x540533(0xf4)]({'result':_0x35d5df},_0x540533(0xd7));});},efiInitialize=async()=>{const _0xa487a=a450_0x1cf8aa,_0x1b8c5f=await(0x0,GetSuperSettingService_1[_0xa487a(0xda)])({'key':_0xa487a(0x10d)});if(!webhookUrl[_0xa487a(0xc4)](_0xa487a(0xe1))){logger_1[_0xa487a(0x100)][_0xa487a(0xc6)](_0xa487a(0xf8));return;}try{if(_0x1b8c5f===_0xa487a(0xfb)){const _0x513c49=await getEfiOptions(),_0x3f156b=new sdk_node_apis_efi_1[(_0xa487a(0xda))](_0x513c49),_0x3a772a={'chave':await(0x0,GetSuperSettingService_1[_0xa487a(0xda)])({'key':'_efiPixKey'})};_0x3f156b[_0xa487a(0xe6)](_0x3a772a)[_0xa487a(0xfd)](_0x56e90d=>{const _0x43ec5c=_0xa487a;_0x56e90d?.['webhookUrl']!==webhookUrl?createWebHook(_0x3f156b):logger_1[_0x43ec5c(0x100)][_0x43ec5c(0xc6)]({'result':_0x56e90d},_0x43ec5c(0xe8));},_0xb57c0c=>{const _0x2efd5f=_0xa487a;_0xb57c0c?.[_0x2efd5f(0xf6)]===_0x2efd5f(0xd8)?createWebHook(_0x3f156b):logger_1[_0x2efd5f(0x100)]['error'](_0xb57c0c,_0x2efd5f(0xdb));});}}catch(_0x3c909a){logger_1['logger'][_0xa487a(0xf4)](_0x3c909a,_0xa487a(0xed));}};exports[a450_0x1cf8aa(0xf0)]=efiInitialize;const efiWebhook=async(_0xb91eb0,_0x463981)=>{const _0x707cf2=a450_0x1cf8aa,{evento:_0x586c2f}=_0xb91eb0['body'];if(_0x586c2f==='teste_webhook')return _0x463981[_0x707cf2(0xc5)]({'ok':!![]});return _0xb91eb0['body'][_0x707cf2(0x114)]&&await Promise['all'](_0xb91eb0['body'][_0x707cf2(0x114)][_0x707cf2(0xdd)](async _0x5112c5=>{const _0x290041=_0x707cf2;logger_1[_0x290041(0x100)][_0x290041(0xc6)](_0x5112c5,_0x290041(0xfc));const _0xd61424=await Invoices_1[_0x290041(0xda)][_0x290041(0xec)]({'where':{'txId':_0x5112c5[_0x290041(0x108)],'status':_0x290041(0xd4)},'include':[{'model':Company_1['default'],'as':_0x290041(0x109)}]});if(!_0xd61424){logger_1[_0x290041(0x100)]['debug']('efiWebhook:\x20Invoice\x20not\x20found\x20or\x20already\x20paid');return;}const _0x55220f=parseFloat(_0x5112c5[_0x290041(0x10b)]);if(_0x55220f<_0xd61424['value']){logger_1[_0x290041(0x100)]['debug'](_0x290041(0xd1));return;}await(0x0,PaymentGatewayServices_1['processInvoicePaid'])(_0xd61424);})),_0x463981[_0x707cf2(0xc5)]({'ok':!![]});};exports['efiWebhook']=efiWebhook;const efiCheckStatus=async(_0x5c0b0d,_0x3135fa=null)=>{const _0x31f3e6=a450_0x1cf8aa;try{!_0x3135fa&&(_0x3135fa=await newEfiPayInstance());const _0x45b05b=await _0x3135fa[_0x31f3e6(0xc9)]({'txid':_0x5c0b0d[_0x31f3e6(0x10f)]});if(_0x45b05b[_0x31f3e6(0x101)]!==_0x31f3e6(0xe2))return![];const {pix:_0x5dcc75}=_0x45b05b,_0xb5f077=parseFloat(_0x5dcc75[0x0][_0x31f3e6(0x10b)]);if(_0xb5f077>=_0x5c0b0d[_0x31f3e6(0xe0)])return await(0x0,PaymentGatewayServices_1[_0x31f3e6(0xe3)])(_0x5c0b0d),!![];return![];}catch(_0x10c688){logger_1[_0x31f3e6(0x100)][_0x31f3e6(0xf4)](_0x10c688,_0x31f3e6(0x10c));}return![];};exports[a450_0x1cf8aa(0xfe)]=efiCheckStatus;const efiPollCheckStatus=async(_0x406af9,_0x50f0d3,_0x4381d2=0xa,_0x294829=0x7530)=>{let _0x1e4711=0x0;async function _0x151a72(){const _0x12be3a=a450_0x2280;await _0x50f0d3['reload']();if(_0x50f0d3[_0x12be3a(0x101)]===_0x12be3a(0xd9)){logger_1[_0x12be3a(0x100)][_0x12be3a(0xc6)](_0x12be3a(0xca)+_0x50f0d3['id']+'\x20already\x20paid,\x20finishing\x20polling');return;}const _0x4d380f=await(0x0,exports[_0x12be3a(0xfe)])(_0x50f0d3,_0x406af9);if(_0x4d380f)return;_0x1e4711+=0x1;if(_0x1e4711>=_0x4381d2){(0x0,PaymentGatewayServices_1[_0x12be3a(0xd6)])(_0x50f0d3);return;}await new Promise(_0x4e5f69=>setTimeout(_0x4e5f69,_0x294829)),await _0x151a72();}return _0x151a72();},efiCreateSubscription=async(_0x5eef30,_0x4f082b)=>{const _0x4befe7=a450_0x1cf8aa,{price:_0x4c8cac,invoiceId:_0x482c59}=_0x5eef30[_0x4befe7(0xf1)],_0x4c1aad=parseFloat(_0x4c8cac),_0x20d494={'calendario':{'expiracao':0x12c},'valor':{'original':_0x4c1aad['toLocaleString']('pt-br',{'minimumFractionDigits':0x2})[_0x4befe7(0xf5)](',','.')},'chave':await(0x0,GetSuperSettingService_1[_0x4befe7(0xda)])({'key':'_efiPixKey'}),'solicitacaoPagador':_0x4befe7(0xd3)+_0x482c59},_0x3410ab=await getEfiOptions();try{const _0x1f2c99=await Invoices_1[_0x4befe7(0xda)]['findByPk'](_0x482c59);if(!_0x1f2c99)throw new Error(_0x4befe7(0xef));await(0x0,exports[_0x4befe7(0xf0)])();const _0x37c90e=new sdk_node_apis_efi_1[(_0x4befe7(0xda))](_0x3410ab),_0x482ea9=await _0x37c90e[_0x4befe7(0x117)]([],_0x20d494);return await _0x1f2c99['update']({'txId':_0x482ea9[_0x4befe7(0x108)],'payGw':_0x4befe7(0xfb),'payGwData':JSON[_0x4befe7(0x103)](_0x482ea9)}),await _0x1f2c99[_0x4befe7(0xcd)](),efiPollCheckStatus(_0x37c90e,_0x1f2c99),_0x4f082b['json']({'qrcode':{'qrcode':_0x482ea9[_0x4befe7(0xcc)]},'valor':{'original':_0x20d494[_0x4befe7(0x10b)]['original']}});}catch(_0x64228e){logger_1[_0x4befe7(0x100)]['error']({'efiOptions':_0x3410ab,'error':_0x64228e},_0x4befe7(0x115));throw new AppError_1[(_0x4befe7(0xda))](_0x4befe7(0x112),0x190);}};exports[a450_0x1cf8aa(0x104)]=efiCreateSubscription;