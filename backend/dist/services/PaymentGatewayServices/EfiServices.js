const a453_0x5711df=a453_0x396d;(function(_0x5c4cb6,_0x15053a){const _0x4af7fd=a453_0x396d,_0xa42485=_0x5c4cb6();while(!![]){try{const _0x37af73=-parseInt(_0x4af7fd(0x116))/0x1+-parseInt(_0x4af7fd(0x14e))/0x2*(parseInt(_0x4af7fd(0x13e))/0x3)+parseInt(_0x4af7fd(0x148))/0x4+parseInt(_0x4af7fd(0x117))/0x5*(parseInt(_0x4af7fd(0x10e))/0x6)+-parseInt(_0x4af7fd(0x121))/0x7+parseInt(_0x4af7fd(0x11a))/0x8*(parseInt(_0x4af7fd(0x12a))/0x9)+parseInt(_0x4af7fd(0x13c))/0xa*(parseInt(_0x4af7fd(0x11c))/0xb);if(_0x37af73===_0x15053a)break;else _0xa42485['push'](_0xa42485['shift']());}catch(_0x87b935){_0xa42485['push'](_0xa42485['shift']());}}}(a453_0x5b33,0xa2955));const a453_0x23b7d7=(function(){let _0x1b851c=!![];return function(_0xa9c79d,_0x5c497c){const _0x31af4e=_0x1b851c?function(){const _0x3a4994=a453_0x396d;if(_0x5c497c){const _0x1876fc=_0x5c497c[_0x3a4994(0x128)](_0xa9c79d,arguments);return _0x5c497c=null,_0x1876fc;}}:function(){};return _0x1b851c=![],_0x31af4e;};}()),a453_0x4cfc4b=a453_0x23b7d7(this,function(){const _0x730640=a453_0x396d;return a453_0x4cfc4b['toString']()[_0x730640(0x142)](_0x730640(0x129))[_0x730640(0x102)]()['constructor'](a453_0x4cfc4b)[_0x730640(0x142)](_0x730640(0x129));});a453_0x4cfc4b();'use strict';var __importDefault=this&&this['__importDefault']||function(_0xe1f152){const _0x32872b=a453_0x396d;return _0xe1f152&&_0xe1f152[_0x32872b(0x106)]?_0xe1f152:{'default':_0xe1f152};};Object[a453_0x5711df(0x10b)](exports,a453_0x5711df(0x106),{'value':!![]}),exports[a453_0x5711df(0x108)]=exports[a453_0x5711df(0x104)]=exports[a453_0x5711df(0x101)]=exports[a453_0x5711df(0x132)]=void 0x0;const sdk_node_apis_efi_1=__importDefault(require(a453_0x5711df(0x12d))),path_1=__importDefault(require(a453_0x5711df(0x10f))),GetSuperSettingService_1=__importDefault(require(a453_0x5711df(0x125))),logger_1=require('../../utils/logger'),Invoices_1=__importDefault(require(a453_0x5711df(0x127))),Company_1=__importDefault(require(a453_0x5711df(0x141))),AppError_1=__importDefault(require(a453_0x5711df(0x13d))),PaymentGatewayServices_1=require('./PaymentGatewayServices'),webhookUrl=process[a453_0x5711df(0x143)][a453_0x5711df(0x147)]+'/subscription/aa/webhook';async function getEfiOptions(){const _0x4b048b=a453_0x5711df,_0xfad05c=path_1['default'][_0x4b048b(0x10d)](__dirname,_0x4b048b(0x13f)+await(0x0,GetSuperSettingService_1[_0x4b048b(0x122)])({'key':_0x4b048b(0x14f)}));return{'sandbox':![],'client_id':await(0x0,GetSuperSettingService_1[_0x4b048b(0x122)])({'key':_0x4b048b(0x146)}),'client_secret':await(0x0,GetSuperSettingService_1['default'])({'key':_0x4b048b(0x11f)}),'pix_cert':_0xfad05c,'validateMtls':![]};}const newEfiPayInstance=async()=>{const _0x5e8af7=a453_0x5711df,_0x4b2569=await getEfiOptions();return new sdk_node_apis_efi_1[(_0x5e8af7(0x122))](_0x4b2569);},createWebHook=async _0x4dbc7f=>{const _0x3f501e=a453_0x5711df,_0x3204af={'chave':await(0x0,GetSuperSettingService_1[_0x3f501e(0x122)])({'key':_0x3f501e(0x14b)})},_0x14bd38={'webhookUrl':webhookUrl};return _0x4dbc7f[_0x3f501e(0x135)](_0x3204af,_0x14bd38)[_0x3f501e(0x13b)](_0x5b4d67=>{const _0x56c96d=_0x3f501e;logger_1[_0x56c96d(0x111)]['info']({'result':_0x5b4d67},_0x56c96d(0x130));},_0x5d9158=>{const _0x52b507=_0x3f501e;logger_1[_0x52b507(0x111)]['error']({'result':_0x5d9158},_0x52b507(0x113));});},efiInitialize=async()=>{const _0x3dc30b=a453_0x5711df,_0x3dad23=await(0x0,GetSuperSettingService_1[_0x3dc30b(0x122)])({'key':_0x3dc30b(0x126)});if(!webhookUrl[_0x3dc30b(0x112)](_0x3dc30b(0x124))){logger_1[_0x3dc30b(0x111)]['debug'](_0x3dc30b(0x118));return;}try{if(_0x3dad23===_0x3dc30b(0x13a)){const _0x33f937=await getEfiOptions(),_0x368dad=new sdk_node_apis_efi_1[(_0x3dc30b(0x122))](_0x33f937),_0x12a8f6={'chave':await(0x0,GetSuperSettingService_1[_0x3dc30b(0x122)])({'key':_0x3dc30b(0x14b)})};_0x368dad['pixDetailWebhook'](_0x12a8f6)['then'](_0x18f7d7=>{const _0x284b45=_0x3dc30b;_0x18f7d7?.['webhookUrl']!==webhookUrl?createWebHook(_0x368dad):logger_1[_0x284b45(0x111)]['debug']({'result':_0x18f7d7},'efiInitialize:\x20webhook\x20correto\x20jÃ¡\x20instalado');},_0x26d590=>{const _0x208691=_0x3dc30b;_0x26d590?.[_0x208691(0x144)]===_0x208691(0x11d)?createWebHook(_0x368dad):logger_1[_0x208691(0x111)][_0x208691(0x119)](_0x26d590,_0x208691(0x137));});}}catch(_0x56006a){logger_1['logger'][_0x3dc30b(0x119)](_0x56006a,_0x3dc30b(0x11b));}};exports[a453_0x5711df(0x132)]=efiInitialize;const efiWebhook=async(_0x1d90ab,_0x252011)=>{const _0x348b9d=a453_0x5711df,{evento:_0x1499f4}=_0x1d90ab[_0x348b9d(0x11e)];if(_0x1499f4===_0x348b9d(0x149))return _0x252011[_0x348b9d(0x131)]({'ok':!![]});return _0x1d90ab[_0x348b9d(0x11e)][_0x348b9d(0x145)]&&await Promise['all'](_0x1d90ab[_0x348b9d(0x11e)][_0x348b9d(0x145)]['map'](async _0x1a9283=>{const _0xf3131b=_0x348b9d;logger_1[_0xf3131b(0x111)][_0xf3131b(0x12f)](_0x1a9283,'Processando\x20pagamento');const _0x406a89=await Invoices_1[_0xf3131b(0x122)][_0xf3131b(0x134)]({'where':{'txId':_0x1a9283[_0xf3131b(0x10a)],'status':_0xf3131b(0x12b)},'include':[{'model':Company_1[_0xf3131b(0x122)],'as':'company'}]});if(!_0x406a89){logger_1['logger'][_0xf3131b(0x12f)](_0xf3131b(0x103));return;}const _0x4f7c98=parseFloat(_0x1a9283[_0xf3131b(0x115)]);if(_0x4f7c98<_0x406a89['value']){logger_1[_0xf3131b(0x111)][_0xf3131b(0x12f)](_0xf3131b(0x120));return;}await(0x0,PaymentGatewayServices_1['processInvoicePaid'])(_0x406a89);})),_0x252011[_0x348b9d(0x131)]({'ok':!![]});};exports[a453_0x5711df(0x101)]=efiWebhook;const efiCheckStatus=async(_0xf86b9d,_0x34af5f=null)=>{const _0xf6dc9a=a453_0x5711df;try{!_0x34af5f&&(_0x34af5f=await newEfiPayInstance());const _0x1416b1=await _0x34af5f[_0xf6dc9a(0x138)]({'txid':_0xf86b9d[_0xf6dc9a(0x123)]});if(_0x1416b1[_0xf6dc9a(0x114)]!=='CONCLUIDA')return![];const {pix:_0x40f158}=_0x1416b1,_0x1093a=parseFloat(_0x40f158[0x0][_0xf6dc9a(0x115)]);if(_0x1093a>=_0xf86b9d['value'])return await(0x0,PaymentGatewayServices_1['processInvoicePaid'])(_0xf86b9d),!![];return![];}catch(_0x4dd2cc){logger_1[_0xf6dc9a(0x111)]['error'](_0x4dd2cc,_0xf6dc9a(0x12c));}return![];};exports[a453_0x5711df(0x104)]=efiCheckStatus;function a453_0x396d(_0x44381e,_0xa0d386){const _0x236e75=a453_0x5b33();return a453_0x396d=function(_0x4cfc4b,_0x23b7d7){_0x4cfc4b=_0x4cfc4b-0x101;let _0x5b33da=_0x236e75[_0x4cfc4b];return _0x5b33da;},a453_0x396d(_0x44381e,_0xa0d386);}const efiPollCheckStatus=async(_0x5f4979,_0x3c1ddc,_0x2e4d24=0xa,_0x5cc682=0x7530)=>{let _0x9920c3=0x0;async function _0x2e01d3(){const _0x4ffb0f=a453_0x396d;await _0x3c1ddc[_0x4ffb0f(0x107)]();if(_0x3c1ddc['status']===_0x4ffb0f(0x14d)){logger_1[_0x4ffb0f(0x111)]['debug'](_0x4ffb0f(0x136)+_0x3c1ddc['id']+_0x4ffb0f(0x14a));return;}const _0x2b4cf1=await(0x0,exports[_0x4ffb0f(0x104)])(_0x3c1ddc,_0x5f4979);if(_0x2b4cf1)return;_0x9920c3+=0x1;if(_0x9920c3>=_0x2e4d24){(0x0,PaymentGatewayServices_1[_0x4ffb0f(0x139)])(_0x3c1ddc);return;}await new Promise(_0x4c6304=>setTimeout(_0x4c6304,_0x5cc682)),await _0x2e01d3();}return _0x2e01d3();},efiCreateSubscription=async(_0x596545,_0x18c009)=>{const _0x55dffb=a453_0x5711df,{price:_0x3d4476,invoiceId:_0x44e5b3}=_0x596545[_0x55dffb(0x11e)],_0x1c0ce2=parseFloat(_0x3d4476),_0x204768={'calendario':{'expiracao':0x12c},'valor':{'original':_0x1c0ce2['toLocaleString']('pt-br',{'minimumFractionDigits':0x2})[_0x55dffb(0x105)](',','.')},'chave':await(0x0,GetSuperSettingService_1[_0x55dffb(0x122)])({'key':_0x55dffb(0x14b)}),'solicitacaoPagador':_0x55dffb(0x110)+_0x44e5b3},_0xb87f1b=await getEfiOptions();try{const _0x3eac54=await Invoices_1[_0x55dffb(0x122)][_0x55dffb(0x140)](_0x44e5b3);if(!_0x3eac54)throw new Error('Invoice\x20not\x20found');await(0x0,exports[_0x55dffb(0x132)])();const _0x2e6b20=new sdk_node_apis_efi_1['default'](_0xb87f1b),_0x429ba0=await _0x2e6b20[_0x55dffb(0x12e)]([],_0x204768);return await _0x3eac54['update']({'txId':_0x429ba0[_0x55dffb(0x10a)],'payGw':_0x55dffb(0x13a),'payGwData':JSON[_0x55dffb(0x109)](_0x429ba0)}),await _0x3eac54['reload'](),efiPollCheckStatus(_0x2e6b20,_0x3eac54),_0x18c009[_0x55dffb(0x131)]({'qrcode':{'qrcode':_0x429ba0[_0x55dffb(0x14c)]},'valor':{'original':_0x204768[_0x55dffb(0x115)][_0x55dffb(0x133)]}});}catch(_0x4daca8){logger_1[_0x55dffb(0x111)]['error']({'efiOptions':_0xb87f1b,'error':_0x4daca8},_0x55dffb(0x10c));throw new AppError_1['default']('Problema\x20encontrado,\x20entre\x20em\x20contato\x20com\x20o\x20suporte!',0x190);}};function a453_0x5b33(){const _0x36dea4=['5828515UFTGVw','webhook_nao_encontrado','body','_efiClientSecret','Recebido\x20valor\x20menor','8825376PFNowx','default','txId','https://','../SettingServices/GetSuperSettingService','_paymentGateway','../../models/Invoices','apply','(((.+)+)+)+$','54SCNxwb','open','Error\x20getting\x20detail\x20of\x20txid','sdk-node-apis-efi','pixCreateImmediateCharge','debug','pixConfigWebhook\x20ok','json','efiInitialize','original','findOne','pixConfigWebhook','efiPollCheckStatus:\x20Invoice\x20','efiInitialize:\x20fail\x20to\x20verify\x20current\x20webhook','pixDetailCharge','processInvoiceExpired','efi','then','50cwJcfq','../../errors/AppError','1117704lUIEuN','../../../private/','findByPk','../../models/Company','search','env','nome','pix','_efiClientId','BACKEND_URL','1963048dInyMc','teste_webhook','\x20already\x20paid,\x20finishing\x20polling','_efiPixKey','pixCopiaECola','paid','6dJBgCX','_efiCertFile','efiWebhook','toString','efiWebhook:\x20Invoice\x20not\x20found\x20or\x20already\x20paid','efiCheckStatus','replace','__esModule','reload','efiCreateSubscription','stringify','txid','defineProperty','efiCreateSubscription\x20error','join','88890VoWeqX','path','#Fatura:','logger','startsWith','pixConfigWebhook\x20error:','status','valor','1311545Nrvsdh','365mTYbWs','efiInitialize:\x20only\x20SSL\x20webhooks\x20are\x20supported','error','179168dkyskb','efiInitialize:\x20'];a453_0x5b33=function(){return _0x36dea4;};return a453_0x5b33();}exports[a453_0x5711df(0x108)]=efiCreateSubscription;