const a477_0x4f9bef=a477_0x41de;(function(_0x4ef4f5,_0x27f6ad){const _0x4dc088=a477_0x41de,_0x2ff8c7=_0x4ef4f5();while(!![]){try{const _0x58ff85=parseInt(_0x4dc088(0x105))/0x1+-parseInt(_0x4dc088(0x10a))/0x2+parseInt(_0x4dc088(0xee))/0x3+-parseInt(_0x4dc088(0xcd))/0x4+-parseInt(_0x4dc088(0x107))/0x5+-parseInt(_0x4dc088(0xe1))/0x6*(parseInt(_0x4dc088(0x100))/0x7)+-parseInt(_0x4dc088(0xf3))/0x8*(-parseInt(_0x4dc088(0xd8))/0x9);if(_0x58ff85===_0x27f6ad)break;else _0x2ff8c7['push'](_0x2ff8c7['shift']());}catch(_0x3b7b38){_0x2ff8c7['push'](_0x2ff8c7['shift']());}}}(a477_0x5c4d,0x86d39));const a477_0x28eb1c=(function(){let _0x3113d5=!![];return function(_0x53234b,_0x345759){const _0x134e0b=_0x3113d5?function(){const _0x3b76fb=a477_0x41de;if(_0x345759){const _0x195a50=_0x345759[_0x3b76fb(0xf1)](_0x53234b,arguments);return _0x345759=null,_0x195a50;}}:function(){};return _0x3113d5=![],_0x134e0b;};}()),a477_0x72942e=a477_0x28eb1c(this,function(){const _0x9a5de=a477_0x41de;return a477_0x72942e['toString']()[_0x9a5de(0xd3)](_0x9a5de(0xe7))[_0x9a5de(0xfc)]()['constructor'](a477_0x72942e)['search']('(((.+)+)+)+$');});a477_0x72942e();'use strict';function a477_0x5c4d(){const _0x2d0098=['stringify','5632277jSjZRp','status','../../errors/AppError','all','_efiClientSecret','553365KCscIy','open','1652410FqBtAl','efiPollCheckStatus:\x20Invoice\x20','findOne','626978iXeGhj','debug','Invoice\x20not\x20found','https://','_efiClientId','processInvoicePaid','../../models/Company','join','reload','../../models/Invoices','efi','efiInitialize:\x20fail\x20to\x20verify\x20current\x20webhook','paid','/subscription/aa/webhook','default','logger','__importDefault','\x20already\x20paid,\x20finishing\x20polling','3423852MiRUsh','map','original','txid','then','teste_webhook','search','efiInitialize:\x20only\x20SSL\x20webhooks\x20are\x20supported','efiWebhook:\x20Invoice\x20not\x20found\x20or\x20already\x20paid','company','pixDetailWebhook','9297oCFWnr','info','./PaymentGatewayServices','webhook_nao_encontrado','efiCreateSubscription','__esModule','efiCheckStatus','pixConfigWebhook\x20ok','processInvoiceExpired','6DwibGh','json','pixCopiaECola','pixCreateImmediateCharge','Processando\x20pagamento','nome','(((.+)+)+)+$','Recebido\x20valor\x20menor','error','update','Problema\x20encontrado,\x20entre\x20em\x20contato\x20com\x20o\x20suporte!','pixConfigWebhook','webhookUrl','2457024tYBPUc','efiInitialize','efiWebhook','apply','env','11496uQJBHe','startsWith','body','pixDetailCharge','_efiPixKey','value','#Fatura:','_paymentGateway','pix','toString','replace','pt-br'];a477_0x5c4d=function(){return _0x2d0098;};return a477_0x5c4d();}function a477_0x41de(_0x381754,_0x43e33b){const _0x3f855b=a477_0x5c4d();return a477_0x41de=function(_0x72942e,_0x28eb1c){_0x72942e=_0x72942e-0xc0;let _0x5c4d2b=_0x3f855b[_0x72942e];return _0x5c4d2b;},a477_0x41de(_0x381754,_0x43e33b);}var __importDefault=this&&this[a477_0x4f9bef(0xcb)]||function(_0x52313d){const _0x293666=a477_0x4f9bef;return _0x52313d&&_0x52313d[_0x293666(0xdd)]?_0x52313d:{'default':_0x52313d};};Object['defineProperty'](exports,a477_0x4f9bef(0xdd),{'value':!![]}),exports[a477_0x4f9bef(0xdc)]=exports[a477_0x4f9bef(0xde)]=exports[a477_0x4f9bef(0xf0)]=exports[a477_0x4f9bef(0xef)]=void 0x0;const sdk_node_apis_efi_1=__importDefault(require('sdk-node-apis-efi')),path_1=__importDefault(require('path')),GetSuperSettingService_1=__importDefault(require('../SettingServices/GetSuperSettingService')),logger_1=require('../../utils/logger'),Invoices_1=__importDefault(require(a477_0x4f9bef(0xc4))),Company_1=__importDefault(require(a477_0x4f9bef(0xc1))),AppError_1=__importDefault(require(a477_0x4f9bef(0x102))),PaymentGatewayServices_1=require(a477_0x4f9bef(0xda)),webhookUrl=process[a477_0x4f9bef(0xf2)]['BACKEND_URL']+a477_0x4f9bef(0xc8);async function getEfiOptions(){const _0x141aa9=a477_0x4f9bef,_0xab4f5f=path_1[_0x141aa9(0xc9)][_0x141aa9(0xc2)](__dirname,'../../../private/'+await(0x0,GetSuperSettingService_1[_0x141aa9(0xc9)])({'key':'_efiCertFile'}));return{'sandbox':![],'client_id':await(0x0,GetSuperSettingService_1['default'])({'key':_0x141aa9(0x10e)}),'client_secret':await(0x0,GetSuperSettingService_1[_0x141aa9(0xc9)])({'key':_0x141aa9(0x104)}),'pix_cert':_0xab4f5f,'validateMtls':![]};}const newEfiPayInstance=async()=>{const _0x2e7a33=a477_0x4f9bef,_0x3b0d09=await getEfiOptions();return new sdk_node_apis_efi_1[(_0x2e7a33(0xc9))](_0x3b0d09);},createWebHook=async _0x5ee507=>{const _0x450f3e=a477_0x4f9bef,_0x965309={'chave':await(0x0,GetSuperSettingService_1[_0x450f3e(0xc9)])({'key':_0x450f3e(0xf7)})},_0x5c0af7={'webhookUrl':webhookUrl};return _0x5ee507[_0x450f3e(0xec)](_0x965309,_0x5c0af7)[_0x450f3e(0xd1)](_0x4890e9=>{const _0x5cb9ab=_0x450f3e;logger_1[_0x5cb9ab(0xca)][_0x5cb9ab(0xd9)]({'result':_0x4890e9},_0x5cb9ab(0xdf));},_0x52697e=>{const _0x4605f9=_0x450f3e;logger_1[_0x4605f9(0xca)]['error']({'result':_0x52697e},'pixConfigWebhook\x20error:');});},efiInitialize=async()=>{const _0x2e9a9f=a477_0x4f9bef,_0x507337=await(0x0,GetSuperSettingService_1[_0x2e9a9f(0xc9)])({'key':_0x2e9a9f(0xfa)});if(!webhookUrl[_0x2e9a9f(0xf4)](_0x2e9a9f(0x10d))){logger_1[_0x2e9a9f(0xca)][_0x2e9a9f(0x10b)](_0x2e9a9f(0xd4));return;}try{if(_0x507337===_0x2e9a9f(0xc5)){const _0x2f4e6e=await getEfiOptions(),_0x3dd04b=new sdk_node_apis_efi_1[(_0x2e9a9f(0xc9))](_0x2f4e6e),_0x51138d={'chave':await(0x0,GetSuperSettingService_1[_0x2e9a9f(0xc9)])({'key':'_efiPixKey'})};_0x3dd04b[_0x2e9a9f(0xd7)](_0x51138d)[_0x2e9a9f(0xd1)](_0x4ef623=>{const _0x4fa6c1=_0x2e9a9f;_0x4ef623?.[_0x4fa6c1(0xed)]!==webhookUrl?createWebHook(_0x3dd04b):logger_1[_0x4fa6c1(0xca)][_0x4fa6c1(0x10b)]({'result':_0x4ef623},'efiInitialize:\x20webhook\x20correto\x20jÃ¡\x20instalado');},_0x170e04=>{const _0x58b94f=_0x2e9a9f;_0x170e04?.[_0x58b94f(0xe6)]===_0x58b94f(0xdb)?createWebHook(_0x3dd04b):logger_1[_0x58b94f(0xca)]['error'](_0x170e04,_0x58b94f(0xc6));});}}catch(_0x34cf16){logger_1['logger']['error'](_0x34cf16,'efiInitialize:\x20');}};exports['efiInitialize']=efiInitialize;const efiWebhook=async(_0x447013,_0x3814ce)=>{const _0x3782b7=a477_0x4f9bef,{evento:_0xbad086}=_0x447013[_0x3782b7(0xf5)];if(_0xbad086===_0x3782b7(0xd2))return _0x3814ce['json']({'ok':!![]});return _0x447013[_0x3782b7(0xf5)]['pix']&&await Promise[_0x3782b7(0x103)](_0x447013[_0x3782b7(0xf5)][_0x3782b7(0xfb)][_0x3782b7(0xce)](async _0x3c009a=>{const _0x20ee24=_0x3782b7;logger_1[_0x20ee24(0xca)][_0x20ee24(0x10b)](_0x3c009a,_0x20ee24(0xe5));const _0x1b6944=await Invoices_1[_0x20ee24(0xc9)][_0x20ee24(0x109)]({'where':{'txId':_0x3c009a['txid'],'status':_0x20ee24(0x106)},'include':[{'model':Company_1[_0x20ee24(0xc9)],'as':_0x20ee24(0xd6)}]});if(!_0x1b6944){logger_1[_0x20ee24(0xca)][_0x20ee24(0x10b)](_0x20ee24(0xd5));return;}const _0x403798=parseFloat(_0x3c009a['valor']);if(_0x403798<_0x1b6944[_0x20ee24(0xf8)]){logger_1[_0x20ee24(0xca)][_0x20ee24(0x10b)](_0x20ee24(0xe8));return;}await(0x0,PaymentGatewayServices_1[_0x20ee24(0xc0)])(_0x1b6944);})),_0x3814ce[_0x3782b7(0xe2)]({'ok':!![]});};exports[a477_0x4f9bef(0xf0)]=efiWebhook;const efiCheckStatus=async(_0x613d4,_0x3473fd=null)=>{const _0x41c475=a477_0x4f9bef;try{!_0x3473fd&&(_0x3473fd=await newEfiPayInstance());const _0x45add6=await _0x3473fd[_0x41c475(0xf6)]({'txid':_0x613d4['txId']});if(_0x45add6[_0x41c475(0x101)]!=='CONCLUIDA')return![];const {pix:_0x4d4f0b}=_0x45add6,_0x5ba25d=parseFloat(_0x4d4f0b[0x0]['valor']);if(_0x5ba25d>=_0x613d4[_0x41c475(0xf8)])return await(0x0,PaymentGatewayServices_1[_0x41c475(0xc0)])(_0x613d4),!![];return![];}catch(_0x5a0905){logger_1[_0x41c475(0xca)][_0x41c475(0xe9)](_0x5a0905,'Error\x20getting\x20detail\x20of\x20txid');}return![];};exports['efiCheckStatus']=efiCheckStatus;const efiPollCheckStatus=async(_0x52a10b,_0x2b638a,_0x247f5b=0xa,_0x213b55=0x7530)=>{let _0x28380b=0x0;async function _0x5bcfb7(){const _0x24b318=a477_0x41de;await _0x2b638a[_0x24b318(0xc3)]();if(_0x2b638a[_0x24b318(0x101)]===_0x24b318(0xc7)){logger_1['logger']['debug'](_0x24b318(0x108)+_0x2b638a['id']+_0x24b318(0xcc));return;}const _0x1eb221=await(0x0,exports[_0x24b318(0xde)])(_0x2b638a,_0x52a10b);if(_0x1eb221)return;_0x28380b+=0x1;if(_0x28380b>=_0x247f5b){(0x0,PaymentGatewayServices_1[_0x24b318(0xe0)])(_0x2b638a);return;}await new Promise(_0x3988ae=>setTimeout(_0x3988ae,_0x213b55)),await _0x5bcfb7();}return _0x5bcfb7();},efiCreateSubscription=async(_0x5cf26c,_0x2815c9)=>{const _0x3ec668=a477_0x4f9bef,{price:_0x4d8def,invoiceId:_0x1376dd}=_0x5cf26c['body'],_0x4ce45d=parseFloat(_0x4d8def),_0xd83071={'calendario':{'expiracao':0x12c},'valor':{'original':_0x4ce45d['toLocaleString'](_0x3ec668(0xfe),{'minimumFractionDigits':0x2})[_0x3ec668(0xfd)](',','.')},'chave':await(0x0,GetSuperSettingService_1[_0x3ec668(0xc9)])({'key':'_efiPixKey'}),'solicitacaoPagador':_0x3ec668(0xf9)+_0x1376dd},_0x5ade11=await getEfiOptions();try{const _0x461d99=await Invoices_1[_0x3ec668(0xc9)]['findByPk'](_0x1376dd);if(!_0x461d99)throw new Error(_0x3ec668(0x10c));await(0x0,exports['efiInitialize'])();const _0x5a8834=new sdk_node_apis_efi_1[(_0x3ec668(0xc9))](_0x5ade11),_0x2f76b7=await _0x5a8834[_0x3ec668(0xe4)]([],_0xd83071);return await _0x461d99[_0x3ec668(0xea)]({'txId':_0x2f76b7[_0x3ec668(0xd0)],'payGw':_0x3ec668(0xc5),'payGwData':JSON[_0x3ec668(0xff)](_0x2f76b7)}),await _0x461d99[_0x3ec668(0xc3)](),efiPollCheckStatus(_0x5a8834,_0x461d99),_0x2815c9[_0x3ec668(0xe2)]({'qrcode':{'qrcode':_0x2f76b7[_0x3ec668(0xe3)]},'valor':{'original':_0xd83071['valor'][_0x3ec668(0xcf)]}});}catch(_0x37446a){logger_1[_0x3ec668(0xca)][_0x3ec668(0xe9)]({'efiOptions':_0x5ade11,'error':_0x37446a},'efiCreateSubscription\x20error');throw new AppError_1['default'](_0x3ec668(0xeb),0x190);}};exports[a477_0x4f9bef(0xdc)]=efiCreateSubscription;