const a451_0x921c11=a451_0x5d09;function a451_0x30fd(){const _0x119215=['error','pixCreateImmediateCharge','__importDefault','Processando\x20pagamento','Error\x20getting\x20detail\x20of\x20txid','./PaymentGatewayServices','map','startsWith','_efiPixKey','default','replace','pixDetailWebhook','8946509OWvQgF','all','efiInitialize','\x20already\x20paid,\x20finishing\x20polling','../SettingServices/GetSuperSettingService','73060DrJJIH','webhookUrl','stringify','logger','https://','../../../private/','env','efiInitialize:\x20only\x20SSL\x20webhooks\x20are\x20supported','_efiCertFile','172764yGcWex','json','efiWebhook:\x20Invoice\x20not\x20found\x20or\x20already\x20paid','join','findByPk','update','__esModule','(((.+)+)+)+$','apply','valor','pix','toString','processInvoicePaid','Recebido\x20valor\x20menor','search','teste_webhook','../../models/Company','efiCheckStatus','/subscription/aa/webhook','efiCreateSubscription\x20error','2DxEXEX','184gEHaGD','efiCreateSubscription','webhook_nao_encontrado','2594732kIjJpi','reload','findOne','info','body','company','88mcWNYl','then','pixCopiaECola','../../errors/AppError','efiInitialize:\x20','txid','4365111STUEGZ','efi','pt-br','CONCLUIDA','_efiClientSecret','10IOTzPw','efiWebhook','#Fatura:','../../utils/logger','_efiClientId','../../models/Invoices','defineProperty','54330768ysRUhA','18LgmAFr','debug','1717849fDasXs','_paymentGateway','pixConfigWebhook\x20error:','value','txId','Problema\x20encontrado,\x20entre\x20em\x20contato\x20com\x20o\x20suporte!','toLocaleString','pixConfigWebhook','open','pixConfigWebhook\x20ok'];a451_0x30fd=function(){return _0x119215;};return a451_0x30fd();}(function(_0x4faf59,_0x27f538){const _0x4e59af=a451_0x5d09,_0x424efa=_0x4faf59();while(!![]){try{const _0x13810f=parseInt(_0x4e59af(0x158))/0x1*(-parseInt(_0x4e59af(0x139))/0x2)+-parseInt(_0x4e59af(0x149))/0x3+-parseInt(_0x4e59af(0x143))/0x4*(parseInt(_0x4e59af(0x11c))/0x5)+parseInt(_0x4e59af(0x156))/0x6*(parseInt(_0x4e59af(0x13d))/0x7)+-parseInt(_0x4e59af(0x13a))/0x8*(parseInt(_0x4e59af(0x125))/0x9)+parseInt(_0x4e59af(0x14e))/0xa*(-parseInt(_0x4e59af(0x117))/0xb)+parseInt(_0x4e59af(0x155))/0xc;if(_0x13810f===_0x27f538)break;else _0x424efa['push'](_0x424efa['shift']());}catch(_0x2a6ada){_0x424efa['push'](_0x424efa['shift']());}}}(a451_0x30fd,0xd962f));function a451_0x5d09(_0x28fbd8,_0x2e5f4f){const _0x47a4f4=a451_0x30fd();return a451_0x5d09=function(_0x9eada7,_0x387638){_0x9eada7=_0x9eada7-0x114;let _0x30fd36=_0x47a4f4[_0x9eada7];return _0x30fd36;},a451_0x5d09(_0x28fbd8,_0x2e5f4f);}const a451_0x387638=(function(){let _0x1af896=!![];return function(_0x328cf2,_0x17852c){const _0x197262=_0x1af896?function(){const _0x49ac54=a451_0x5d09;if(_0x17852c){const _0x36f0fb=_0x17852c[_0x49ac54(0x12d)](_0x328cf2,arguments);return _0x17852c=null,_0x36f0fb;}}:function(){};return _0x1af896=![],_0x197262;};}()),a451_0x9eada7=a451_0x387638(this,function(){const _0x352e33=a451_0x5d09;return a451_0x9eada7['toString']()[_0x352e33(0x133)](_0x352e33(0x12c))[_0x352e33(0x130)]()['constructor'](a451_0x9eada7)['search'](_0x352e33(0x12c));});a451_0x9eada7();'use strict';var __importDefault=this&&this[a451_0x921c11(0x164)]||function(_0x49f3ad){const _0x5c5937=a451_0x921c11;return _0x49f3ad&&_0x49f3ad[_0x5c5937(0x12b)]?_0x49f3ad:{'default':_0x49f3ad};};Object[a451_0x921c11(0x154)](exports,'__esModule',{'value':!![]}),exports[a451_0x921c11(0x13b)]=exports[a451_0x921c11(0x136)]=exports[a451_0x921c11(0x14f)]=exports[a451_0x921c11(0x119)]=void 0x0;const sdk_node_apis_efi_1=__importDefault(require('sdk-node-apis-efi')),path_1=__importDefault(require('path')),GetSuperSettingService_1=__importDefault(require(a451_0x921c11(0x11b))),logger_1=require(a451_0x921c11(0x151)),Invoices_1=__importDefault(require(a451_0x921c11(0x153))),Company_1=__importDefault(require(a451_0x921c11(0x135))),AppError_1=__importDefault(require(a451_0x921c11(0x146))),PaymentGatewayServices_1=require(a451_0x921c11(0x167)),webhookUrl=process[a451_0x921c11(0x122)]['BACKEND_URL']+a451_0x921c11(0x137);async function getEfiOptions(){const _0x19ffc0=a451_0x921c11,_0x280d2e=path_1[_0x19ffc0(0x114)][_0x19ffc0(0x128)](__dirname,_0x19ffc0(0x121)+await(0x0,GetSuperSettingService_1[_0x19ffc0(0x114)])({'key':_0x19ffc0(0x124)}));return{'sandbox':![],'client_id':await(0x0,GetSuperSettingService_1[_0x19ffc0(0x114)])({'key':_0x19ffc0(0x152)}),'client_secret':await(0x0,GetSuperSettingService_1['default'])({'key':_0x19ffc0(0x14d)}),'pix_cert':_0x280d2e,'validateMtls':![]};}const newEfiPayInstance=async()=>{const _0x36617f=await getEfiOptions();return new sdk_node_apis_efi_1['default'](_0x36617f);},createWebHook=async _0x79501d=>{const _0x40b64a=a451_0x921c11,_0x264b40={'chave':await(0x0,GetSuperSettingService_1[_0x40b64a(0x114)])({'key':_0x40b64a(0x16a)})},_0x372a06={'webhookUrl':webhookUrl};return _0x79501d[_0x40b64a(0x15f)](_0x264b40,_0x372a06)[_0x40b64a(0x144)](_0x2a013b=>{const _0x292acc=_0x40b64a;logger_1['logger'][_0x292acc(0x140)]({'result':_0x2a013b},_0x292acc(0x161));},_0x5d5d04=>{const _0x4c3163=_0x40b64a;logger_1[_0x4c3163(0x11f)][_0x4c3163(0x162)]({'result':_0x5d5d04},_0x4c3163(0x15a));});},efiInitialize=async()=>{const _0x203104=a451_0x921c11,_0x20d903=await(0x0,GetSuperSettingService_1['default'])({'key':_0x203104(0x159)});if(!webhookUrl[_0x203104(0x169)](_0x203104(0x120))){logger_1[_0x203104(0x11f)]['debug'](_0x203104(0x123));return;}try{if(_0x20d903===_0x203104(0x14a)){const _0x18bf55=await getEfiOptions(),_0x468865=new sdk_node_apis_efi_1[(_0x203104(0x114))](_0x18bf55),_0x41e349={'chave':await(0x0,GetSuperSettingService_1[_0x203104(0x114)])({'key':_0x203104(0x16a)})};_0x468865[_0x203104(0x116)](_0x41e349)[_0x203104(0x144)](_0x4a3126=>{const _0x42faa2=_0x203104;_0x4a3126?.[_0x42faa2(0x11d)]!==webhookUrl?createWebHook(_0x468865):logger_1[_0x42faa2(0x11f)]['debug']({'result':_0x4a3126},'efiInitialize:\x20webhook\x20correto\x20jÃ¡\x20instalado');},_0x4bcd48=>{const _0x3986b4=_0x203104;_0x4bcd48?.['nome']===_0x3986b4(0x13c)?createWebHook(_0x468865):logger_1[_0x3986b4(0x11f)][_0x3986b4(0x162)](_0x4bcd48,'efiInitialize:\x20fail\x20to\x20verify\x20current\x20webhook');});}}catch(_0x1957d7){logger_1[_0x203104(0x11f)][_0x203104(0x162)](_0x1957d7,_0x203104(0x147));}};exports['efiInitialize']=efiInitialize;const efiWebhook=async(_0x535047,_0x20e0a4)=>{const _0x205cad=a451_0x921c11,{evento:_0x59dddc}=_0x535047[_0x205cad(0x141)];if(_0x59dddc===_0x205cad(0x134))return _0x20e0a4[_0x205cad(0x126)]({'ok':!![]});return _0x535047[_0x205cad(0x141)][_0x205cad(0x12f)]&&await Promise[_0x205cad(0x118)](_0x535047[_0x205cad(0x141)]['pix'][_0x205cad(0x168)](async _0x3d27cd=>{const _0x3fc2aa=_0x205cad;logger_1[_0x3fc2aa(0x11f)][_0x3fc2aa(0x157)](_0x3d27cd,_0x3fc2aa(0x165));const _0x3d877b=await Invoices_1[_0x3fc2aa(0x114)][_0x3fc2aa(0x13f)]({'where':{'txId':_0x3d27cd[_0x3fc2aa(0x148)],'status':_0x3fc2aa(0x160)},'include':[{'model':Company_1[_0x3fc2aa(0x114)],'as':_0x3fc2aa(0x142)}]});if(!_0x3d877b){logger_1['logger'][_0x3fc2aa(0x157)](_0x3fc2aa(0x127));return;}const _0x4f7a01=parseFloat(_0x3d27cd[_0x3fc2aa(0x12e)]);if(_0x4f7a01<_0x3d877b[_0x3fc2aa(0x15b)]){logger_1[_0x3fc2aa(0x11f)]['debug'](_0x3fc2aa(0x132));return;}await(0x0,PaymentGatewayServices_1['processInvoicePaid'])(_0x3d877b);})),_0x20e0a4[_0x205cad(0x126)]({'ok':!![]});};exports[a451_0x921c11(0x14f)]=efiWebhook;const efiCheckStatus=async(_0x5ba7bd,_0x3bf2aa=null)=>{const _0x56dbaa=a451_0x921c11;try{!_0x3bf2aa&&(_0x3bf2aa=await newEfiPayInstance());const _0x10c025=await _0x3bf2aa['pixDetailCharge']({'txid':_0x5ba7bd[_0x56dbaa(0x15c)]});if(_0x10c025['status']!==_0x56dbaa(0x14c))return![];const {pix:_0x1e0004}=_0x10c025,_0x5b9f52=parseFloat(_0x1e0004[0x0]['valor']);if(_0x5b9f52>=_0x5ba7bd[_0x56dbaa(0x15b)])return await(0x0,PaymentGatewayServices_1[_0x56dbaa(0x131)])(_0x5ba7bd),!![];return![];}catch(_0x3b7719){logger_1[_0x56dbaa(0x11f)][_0x56dbaa(0x162)](_0x3b7719,_0x56dbaa(0x166));}return![];};exports[a451_0x921c11(0x136)]=efiCheckStatus;const efiPollCheckStatus=async(_0x3fb847,_0x1691ce,_0x32b0fd=0xa,_0x4666a0=0x7530)=>{let _0xb56baf=0x0;async function _0x344449(){const _0x1d46c9=a451_0x5d09;await _0x1691ce[_0x1d46c9(0x13e)]();if(_0x1691ce['status']==='paid'){logger_1['logger'][_0x1d46c9(0x157)]('efiPollCheckStatus:\x20Invoice\x20'+_0x1691ce['id']+_0x1d46c9(0x11a));return;}const _0x46f398=await(0x0,exports[_0x1d46c9(0x136)])(_0x1691ce,_0x3fb847);if(_0x46f398)return;_0xb56baf+=0x1;if(_0xb56baf>=_0x32b0fd){(0x0,PaymentGatewayServices_1['processInvoiceExpired'])(_0x1691ce);return;}await new Promise(_0x1b7b7=>setTimeout(_0x1b7b7,_0x4666a0)),await _0x344449();}return _0x344449();},efiCreateSubscription=async(_0x48477f,_0x35102c)=>{const _0x14f4fa=a451_0x921c11,{price:_0x1cf39a,invoiceId:_0x1f1639}=_0x48477f['body'],_0x356072=parseFloat(_0x1cf39a),_0x2bbe0b={'calendario':{'expiracao':0x12c},'valor':{'original':_0x356072[_0x14f4fa(0x15e)](_0x14f4fa(0x14b),{'minimumFractionDigits':0x2})[_0x14f4fa(0x115)](',','.')},'chave':await(0x0,GetSuperSettingService_1[_0x14f4fa(0x114)])({'key':'_efiPixKey'}),'solicitacaoPagador':_0x14f4fa(0x150)+_0x1f1639},_0x44f3c6=await getEfiOptions();try{const _0x42e676=await Invoices_1[_0x14f4fa(0x114)][_0x14f4fa(0x129)](_0x1f1639);if(!_0x42e676)throw new Error('Invoice\x20not\x20found');await(0x0,exports[_0x14f4fa(0x119)])();const _0x47eb17=new sdk_node_apis_efi_1['default'](_0x44f3c6),_0x6085d4=await _0x47eb17[_0x14f4fa(0x163)]([],_0x2bbe0b);return await _0x42e676[_0x14f4fa(0x12a)]({'txId':_0x6085d4[_0x14f4fa(0x148)],'payGw':_0x14f4fa(0x14a),'payGwData':JSON[_0x14f4fa(0x11e)](_0x6085d4)}),await _0x42e676[_0x14f4fa(0x13e)](),efiPollCheckStatus(_0x47eb17,_0x42e676),_0x35102c[_0x14f4fa(0x126)]({'qrcode':{'qrcode':_0x6085d4[_0x14f4fa(0x145)]},'valor':{'original':_0x2bbe0b[_0x14f4fa(0x12e)]['original']}});}catch(_0x54e165){logger_1[_0x14f4fa(0x11f)]['error']({'efiOptions':_0x44f3c6,'error':_0x54e165},_0x14f4fa(0x138));throw new AppError_1['default'](_0x14f4fa(0x15d),0x190);}};exports[a451_0x921c11(0x13b)]=efiCreateSubscription;