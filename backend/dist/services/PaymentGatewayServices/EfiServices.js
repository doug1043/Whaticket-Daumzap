function a482_0x3ec8(_0x182840,_0x433946){const _0xd4067e=a482_0x6970();return a482_0x3ec8=function(_0x44f3ab,_0x4f5520){_0x44f3ab=_0x44f3ab-0x76;let _0x6970f0=_0xd4067e[_0x44f3ab];return _0x6970f0;},a482_0x3ec8(_0x182840,_0x433946);}const a482_0x5ef5e2=a482_0x3ec8;(function(_0x583476,_0x207e46){const _0x562132=a482_0x3ec8,_0x3e2eb5=_0x583476();while(!![]){try{const _0x39e18d=parseInt(_0x562132(0x9e))/0x1+parseInt(_0x562132(0x9c))/0x2+-parseInt(_0x562132(0x94))/0x3*(parseInt(_0x562132(0x9a))/0x4)+parseInt(_0x562132(0x99))/0x5+-parseInt(_0x562132(0x87))/0x6*(parseInt(_0x562132(0x90))/0x7)+-parseInt(_0x562132(0xb0))/0x8*(parseInt(_0x562132(0x76))/0x9)+parseInt(_0x562132(0x7b))/0xa*(parseInt(_0x562132(0x89))/0xb);if(_0x39e18d===_0x207e46)break;else _0x3e2eb5['push'](_0x3e2eb5['shift']());}catch(_0x5f5984){_0x3e2eb5['push'](_0x3e2eb5['shift']());}}}(a482_0x6970,0xdfd77));const a482_0x4f5520=(function(){let _0x35a1f=!![];return function(_0x76f746,_0x187a8d){const _0xb55caf=_0x35a1f?function(){if(_0x187a8d){const _0x33cbb9=_0x187a8d['apply'](_0x76f746,arguments);return _0x187a8d=null,_0x33cbb9;}}:function(){};return _0x35a1f=![],_0xb55caf;};}()),a482_0x44f3ab=a482_0x4f5520(this,function(){const _0x209c4c=a482_0x3ec8;return a482_0x44f3ab['toString']()[_0x209c4c(0xbe)](_0x209c4c(0x7e))['toString']()[_0x209c4c(0x8a)](a482_0x44f3ab)[_0x209c4c(0xbe)](_0x209c4c(0x7e));});a482_0x44f3ab();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x496b47){return _0x496b47&&_0x496b47['__esModule']?_0x496b47:{'default':_0x496b47};};Object[a482_0x5ef5e2(0x7c)](exports,a482_0x5ef5e2(0x79),{'value':!![]}),exports[a482_0x5ef5e2(0xbc)]=exports['efiCheckStatus']=exports['efiWebhook']=exports[a482_0x5ef5e2(0x92)]=void 0x0;const sdk_node_apis_efi_1=__importDefault(require(a482_0x5ef5e2(0xa7))),path_1=__importDefault(require(a482_0x5ef5e2(0xbf))),GetSuperSettingService_1=__importDefault(require(a482_0x5ef5e2(0x98))),logger_1=require(a482_0x5ef5e2(0xb4)),Invoices_1=__importDefault(require('../../models/Invoices')),Company_1=__importDefault(require(a482_0x5ef5e2(0xa6))),AppError_1=__importDefault(require('../../errors/AppError')),PaymentGatewayServices_1=require(a482_0x5ef5e2(0xae)),webhookUrl=process[a482_0x5ef5e2(0xa0)][a482_0x5ef5e2(0xac)]+'/subscription/aa/webhook';async function getEfiOptions(){const _0x47cd7d=a482_0x5ef5e2,_0x51a64f=path_1[_0x47cd7d(0xc7)][_0x47cd7d(0x82)](__dirname,_0x47cd7d(0xa8)+await(0x0,GetSuperSettingService_1[_0x47cd7d(0xc7)])({'key':_0x47cd7d(0xb7)}));return{'sandbox':![],'client_id':await(0x0,GetSuperSettingService_1['default'])({'key':_0x47cd7d(0xc0)}),'client_secret':await(0x0,GetSuperSettingService_1[_0x47cd7d(0xc7)])({'key':_0x47cd7d(0xc4)}),'pix_cert':_0x51a64f,'validateMtls':![]};}const newEfiPayInstance=async()=>{const _0x2210fd=a482_0x5ef5e2,_0x5d9e89=await getEfiOptions();return new sdk_node_apis_efi_1[(_0x2210fd(0xc7))](_0x5d9e89);},createWebHook=async _0x1756fe=>{const _0x170314=a482_0x5ef5e2,_0x30804a={'chave':await(0x0,GetSuperSettingService_1[_0x170314(0xc7)])({'key':_0x170314(0xc6)})},_0x43dafa={'webhookUrl':webhookUrl};return _0x1756fe[_0x170314(0x77)](_0x30804a,_0x43dafa)[_0x170314(0xbd)](_0x51e635=>{const _0x467623=_0x170314;logger_1[_0x467623(0x85)][_0x467623(0xbb)]({'result':_0x51e635},'pixConfigWebhook\x20ok');},_0x35b394=>{const _0x5b13ec=_0x170314;logger_1[_0x5b13ec(0x85)][_0x5b13ec(0xb5)]({'result':_0x35b394},_0x5b13ec(0x9b));});},efiInitialize=async()=>{const _0x4e19d0=a482_0x5ef5e2,_0x4c8eb8=await(0x0,GetSuperSettingService_1[_0x4e19d0(0xc7)])({'key':_0x4e19d0(0xba)});if(!webhookUrl[_0x4e19d0(0xa5)](_0x4e19d0(0x93))){logger_1['logger'][_0x4e19d0(0x7f)]('efiInitialize:\x20only\x20SSL\x20webhooks\x20are\x20supported');return;}try{if(_0x4c8eb8===_0x4e19d0(0x78)){const _0x3b383f=await getEfiOptions(),_0x2e2727=new sdk_node_apis_efi_1[(_0x4e19d0(0xc7))](_0x3b383f),_0xc18101={'chave':await(0x0,GetSuperSettingService_1[_0x4e19d0(0xc7)])({'key':'_efiPixKey'})};_0x2e2727[_0x4e19d0(0xaa)](_0xc18101)[_0x4e19d0(0xbd)](_0x3962a6=>{const _0x5d92cf=_0x4e19d0;_0x3962a6?.['webhookUrl']!==webhookUrl?createWebHook(_0x2e2727):logger_1[_0x5d92cf(0x85)][_0x5d92cf(0x7f)]({'result':_0x3962a6},_0x5d92cf(0x7d));},_0x215b81=>{const _0x1b6756=_0x4e19d0;_0x215b81?.[_0x1b6756(0x8e)]===_0x1b6756(0x83)?createWebHook(_0x2e2727):logger_1[_0x1b6756(0x85)][_0x1b6756(0xb5)](_0x215b81,_0x1b6756(0xa9));});}}catch(_0x47f5b6){logger_1[_0x4e19d0(0x85)]['error'](_0x47f5b6,_0x4e19d0(0x80));}};exports[a482_0x5ef5e2(0x92)]=efiInitialize;const efiWebhook=async(_0xb27f37,_0x36604c)=>{const _0x1cd46c=a482_0x5ef5e2,{evento:_0x55cd2d}=_0xb27f37[_0x1cd46c(0x9d)];if(_0x55cd2d===_0x1cd46c(0x95))return _0x36604c[_0x1cd46c(0x86)]({'ok':!![]});return _0xb27f37[_0x1cd46c(0x9d)][_0x1cd46c(0xa1)]&&await Promise[_0x1cd46c(0x97)](_0xb27f37[_0x1cd46c(0x9d)]['pix'][_0x1cd46c(0x96)](async _0x33c45f=>{const _0x3f1650=_0x1cd46c;logger_1[_0x3f1650(0x85)][_0x3f1650(0x7f)](_0x33c45f,_0x3f1650(0x84));const _0x2be0c2=await Invoices_1['default'][_0x3f1650(0x7a)]({'where':{'txId':_0x33c45f[_0x3f1650(0x8c)],'status':_0x3f1650(0x88)},'include':[{'model':Company_1[_0x3f1650(0xc7)],'as':_0x3f1650(0x91)}]});if(!_0x2be0c2){logger_1[_0x3f1650(0x85)][_0x3f1650(0x7f)](_0x3f1650(0x81));return;}const _0x4d3db9=parseFloat(_0x33c45f[_0x3f1650(0xb8)]);if(_0x4d3db9<_0x2be0c2[_0x3f1650(0xa4)]){logger_1[_0x3f1650(0x85)]['debug'](_0x3f1650(0xb6));return;}await(0x0,PaymentGatewayServices_1[_0x3f1650(0xaf)])(_0x2be0c2);})),_0x36604c[_0x1cd46c(0x86)]({'ok':!![]});};function a482_0x6970(){const _0x402d39=['reload','_efiPixKey','default','28233kkfvZl','pixConfigWebhook','efi','__esModule','findOne','2470990jTwTGM','defineProperty','efiInitialize:\x20webhook\x20correto\x20jÃ¡\x20instalado','(((.+)+)+)+$','debug','efiInitialize:\x20','efiWebhook:\x20Invoice\x20not\x20found\x20or\x20already\x20paid','join','webhook_nao_encontrado','Processando\x20pagamento','logger','json','30ccVrWw','open','11FlxTyA','constructor','txId','txid','efiWebhook','nome','Invoice\x20not\x20found','979839dYPNbk','company','efiInitialize','https://','111CGBKBy','teste_webhook','map','all','../SettingServices/GetSuperSettingService','5957600DslOAI','77972JJRyVI','pixConfigWebhook\x20error:','3105380ZOeQPf','body','1062611UGuwHA','toLocaleString','env','pix','\x20already\x20paid,\x20finishing\x20polling','efiCheckStatus','value','startsWith','../../models/Company','sdk-node-apis-efi','../../../private/','efiInitialize:\x20fail\x20to\x20verify\x20current\x20webhook','pixDetailWebhook','status','BACKEND_URL','Error\x20getting\x20detail\x20of\x20txid','./PaymentGatewayServices','processInvoicePaid','4376OhBjmn','CONCLUIDA','efiCreateSubscription\x20error','processInvoiceExpired','../../utils/logger','error','Recebido\x20valor\x20menor','_efiCertFile','valor','findByPk','_paymentGateway','info','efiCreateSubscription','then','search','path','_efiClientId','#Fatura:','original','efiPollCheckStatus:\x20Invoice\x20','_efiClientSecret'];a482_0x6970=function(){return _0x402d39;};return a482_0x6970();}exports[a482_0x5ef5e2(0x8d)]=efiWebhook;const efiCheckStatus=async(_0x2df925,_0xe01cf8=null)=>{const _0x48d431=a482_0x5ef5e2;try{!_0xe01cf8&&(_0xe01cf8=await newEfiPayInstance());const _0x1fbbaf=await _0xe01cf8['pixDetailCharge']({'txid':_0x2df925[_0x48d431(0x8b)]});if(_0x1fbbaf[_0x48d431(0xab)]!==_0x48d431(0xb1))return![];const {pix:_0x21c0f4}=_0x1fbbaf,_0x38729c=parseFloat(_0x21c0f4[0x0][_0x48d431(0xb8)]);if(_0x38729c>=_0x2df925[_0x48d431(0xa4)])return await(0x0,PaymentGatewayServices_1[_0x48d431(0xaf)])(_0x2df925),!![];return![];}catch(_0xb29f01){logger_1['logger'][_0x48d431(0xb5)](_0xb29f01,_0x48d431(0xad));}return![];};exports[a482_0x5ef5e2(0xa3)]=efiCheckStatus;const efiPollCheckStatus=async(_0x55d5c9,_0x2b4bdb,_0x57e6ec=0xa,_0x3664e9=0x7530)=>{let _0x5abb44=0x0;async function _0x281e4c(){const _0x1b14ae=a482_0x3ec8;await _0x2b4bdb['reload']();if(_0x2b4bdb['status']==='paid'){logger_1[_0x1b14ae(0x85)]['debug'](_0x1b14ae(0xc3)+_0x2b4bdb['id']+_0x1b14ae(0xa2));return;}const _0x42ae1e=await(0x0,exports[_0x1b14ae(0xa3)])(_0x2b4bdb,_0x55d5c9);if(_0x42ae1e)return;_0x5abb44+=0x1;if(_0x5abb44>=_0x57e6ec){(0x0,PaymentGatewayServices_1[_0x1b14ae(0xb3)])(_0x2b4bdb);return;}await new Promise(_0x19446e=>setTimeout(_0x19446e,_0x3664e9)),await _0x281e4c();}return _0x281e4c();},efiCreateSubscription=async(_0x49eda7,_0x1d6e9e)=>{const _0x24c1ec=a482_0x5ef5e2,{price:_0x50c4e4,invoiceId:_0x20d196}=_0x49eda7['body'],_0x3b0e19=parseFloat(_0x50c4e4),_0x224419={'calendario':{'expiracao':0x12c},'valor':{'original':_0x3b0e19[_0x24c1ec(0x9f)]('pt-br',{'minimumFractionDigits':0x2})['replace'](',','.')},'chave':await(0x0,GetSuperSettingService_1[_0x24c1ec(0xc7)])({'key':_0x24c1ec(0xc6)}),'solicitacaoPagador':_0x24c1ec(0xc1)+_0x20d196},_0x2e8562=await getEfiOptions();try{const _0x2a1409=await Invoices_1[_0x24c1ec(0xc7)][_0x24c1ec(0xb9)](_0x20d196);if(!_0x2a1409)throw new Error(_0x24c1ec(0x8f));await(0x0,exports[_0x24c1ec(0x92)])();const _0xa285fa=new sdk_node_apis_efi_1[(_0x24c1ec(0xc7))](_0x2e8562),_0x5e99e6=await _0xa285fa['pixCreateImmediateCharge']([],_0x224419);return await _0x2a1409['update']({'txId':_0x5e99e6[_0x24c1ec(0x8c)],'payGw':_0x24c1ec(0x78),'payGwData':JSON['stringify'](_0x5e99e6)}),await _0x2a1409[_0x24c1ec(0xc5)](),efiPollCheckStatus(_0xa285fa,_0x2a1409),_0x1d6e9e[_0x24c1ec(0x86)]({'qrcode':{'qrcode':_0x5e99e6['pixCopiaECola']},'valor':{'original':_0x224419[_0x24c1ec(0xb8)][_0x24c1ec(0xc2)]}});}catch(_0x14d11a){logger_1[_0x24c1ec(0x85)][_0x24c1ec(0xb5)]({'efiOptions':_0x2e8562,'error':_0x14d11a},_0x24c1ec(0xb2));throw new AppError_1[(_0x24c1ec(0xc7))]('Problema\x20encontrado,\x20entre\x20em\x20contato\x20com\x20o\x20suporte!',0x190);}};exports[a482_0x5ef5e2(0xbc)]=efiCreateSubscription;