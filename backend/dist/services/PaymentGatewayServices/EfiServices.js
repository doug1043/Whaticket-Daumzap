const a487_0x4a4757=a487_0x1f58;(function(_0x4d1e92,_0x4e302c){const _0x612036=a487_0x1f58,_0x297cdf=_0x4d1e92();while(!![]){try{const _0x1cd06d=-parseInt(_0x612036(0x13c))/0x1*(-parseInt(_0x612036(0x11f))/0x2)+-parseInt(_0x612036(0x10c))/0x3*(parseInt(_0x612036(0x106))/0x4)+-parseInt(_0x612036(0x103))/0x5*(parseInt(_0x612036(0x13d))/0x6)+parseInt(_0x612036(0x102))/0x7*(-parseInt(_0x612036(0x14c))/0x8)+parseInt(_0x612036(0x143))/0x9*(-parseInt(_0x612036(0x124))/0xa)+-parseInt(_0x612036(0x11b))/0xb+parseInt(_0x612036(0x132))/0xc;if(_0x1cd06d===_0x4e302c)break;else _0x297cdf['push'](_0x297cdf['shift']());}catch(_0x2c2df6){_0x297cdf['push'](_0x297cdf['shift']());}}}(a487_0x2f08,0xbb0cc));const a487_0x352c12=(function(){let _0x4a9fd3=!![];return function(_0x413cfd,_0x2e725c){const _0x28dad3=_0x4a9fd3?function(){const _0xa54c9d=a487_0x1f58;if(_0x2e725c){const _0xfbde4b=_0x2e725c[_0xa54c9d(0x120)](_0x413cfd,arguments);return _0x2e725c=null,_0xfbde4b;}}:function(){};return _0x4a9fd3=![],_0x28dad3;};}()),a487_0x72512f=a487_0x352c12(this,function(){const _0x898801=a487_0x1f58;return a487_0x72512f[_0x898801(0x13a)]()[_0x898801(0x128)]('(((.+)+)+)+$')['toString']()[_0x898801(0x149)](a487_0x72512f)[_0x898801(0x128)](_0x898801(0x14b));});a487_0x72512f();'use strict';var __importDefault=this&&this[a487_0x4a4757(0x123)]||function(_0x286f24){const _0x306669=a487_0x4a4757;return _0x286f24&&_0x286f24[_0x306669(0x148)]?_0x286f24:{'default':_0x286f24};};function a487_0x1f58(_0x32e4ed,_0x12354c){const _0x17c526=a487_0x2f08();return a487_0x1f58=function(_0x72512f,_0x352c12){_0x72512f=_0x72512f-0xfe;let _0x2f0874=_0x17c526[_0x72512f];return _0x2f0874;},a487_0x1f58(_0x32e4ed,_0x12354c);}Object[a487_0x4a4757(0x13b)](exports,a487_0x4a4757(0x148),{'value':!![]}),exports['efiCreateSubscription']=exports[a487_0x4a4757(0x112)]=exports[a487_0x4a4757(0x10d)]=exports['efiInitialize']=void 0x0;function a487_0x2f08(){const _0x5a0af7=['22038tiIgZF','logger','#Fatura:','json','join','map','60066imXBTh','efiCreateSubscription','_efiClientSecret','valor','\x20already\x20paid,\x20finishing\x20polling','__esModule','constructor','Recebido\x20valor\x20menor','(((.+)+)+)+$','8SxtndG','_paymentGateway','Problema\x20encontrado,\x20entre\x20em\x20contato\x20com\x20o\x20suporte!','replace','efiInitialize:\x20only\x20SSL\x20webhooks\x20are\x20supported','Invoice\x20not\x20found','pixDetailCharge','../../models/Invoices','450947SzLBkh','1935qDEBWE','./PaymentGatewayServices','processInvoicePaid','568404InUSce','efiInitialize','../../../private/','pix','body','nome','27PSmTXZ','efiWebhook','teste_webhook','../../errors/AppError','all','reload','efiCheckStatus','efiInitialize:\x20webhook\x20correto\x20jÃ¡\x20instalado','/subscription/aa/webhook','pixCreateImmediateCharge','Error\x20getting\x20detail\x20of\x20txid','value','BACKEND_URL','stringify','debug','5278526IPrbgs','pixConfigWebhook\x20error:','findByPk','pixConfigWebhook','2sWqoLK','apply','_efiPixKey','then','__importDefault','1870UTDbqu','pixDetailWebhook','pixCopiaECola','CONCLUIDA','search','status','webhook_nao_encontrado','open','original','efi','pt-br','update','company','info','58935672OBuGqN','efiCreateSubscription\x20error','efiInitialize:\x20fail\x20to\x20verify\x20current\x20webhook','error','default','path','_efiClientId','pixConfigWebhook\x20ok','toString','defineProperty','347535MGFjos'];a487_0x2f08=function(){return _0x5a0af7;};return a487_0x2f08();}const sdk_node_apis_efi_1=__importDefault(require('sdk-node-apis-efi')),path_1=__importDefault(require(a487_0x4a4757(0x137))),GetSuperSettingService_1=__importDefault(require('../SettingServices/GetSuperSettingService')),logger_1=require('../../utils/logger'),Invoices_1=__importDefault(require(a487_0x4a4757(0x101))),Company_1=__importDefault(require('../../models/Company')),AppError_1=__importDefault(require(a487_0x4a4757(0x10f))),PaymentGatewayServices_1=require(a487_0x4a4757(0x104)),webhookUrl=process['env'][a487_0x4a4757(0x118)]+a487_0x4a4757(0x114);async function getEfiOptions(){const _0x56dc4e=a487_0x4a4757,_0x34a262=path_1[_0x56dc4e(0x136)][_0x56dc4e(0x141)](__dirname,_0x56dc4e(0x108)+await(0x0,GetSuperSettingService_1[_0x56dc4e(0x136)])({'key':'_efiCertFile'}));return{'sandbox':![],'client_id':await(0x0,GetSuperSettingService_1[_0x56dc4e(0x136)])({'key':_0x56dc4e(0x138)}),'client_secret':await(0x0,GetSuperSettingService_1[_0x56dc4e(0x136)])({'key':_0x56dc4e(0x145)}),'pix_cert':_0x34a262,'validateMtls':![]};}const newEfiPayInstance=async()=>{const _0x23b67d=a487_0x4a4757,_0x2087a8=await getEfiOptions();return new sdk_node_apis_efi_1[(_0x23b67d(0x136))](_0x2087a8);},createWebHook=async _0x40ba8e=>{const _0x453352=a487_0x4a4757,_0x35c8cf={'chave':await(0x0,GetSuperSettingService_1[_0x453352(0x136)])({'key':_0x453352(0x121)})},_0x4287d0={'webhookUrl':webhookUrl};return _0x40ba8e[_0x453352(0x11e)](_0x35c8cf,_0x4287d0)[_0x453352(0x122)](_0x3f8705=>{const _0x9bb67e=_0x453352;logger_1['logger'][_0x9bb67e(0x131)]({'result':_0x3f8705},_0x9bb67e(0x139));},_0xebb79c=>{const _0x191866=_0x453352;logger_1['logger'][_0x191866(0x135)]({'result':_0xebb79c},_0x191866(0x11c));});},efiInitialize=async()=>{const _0x108e5a=a487_0x4a4757,_0x5d5d72=await(0x0,GetSuperSettingService_1[_0x108e5a(0x136)])({'key':_0x108e5a(0x14d)});if(!webhookUrl['startsWith']('https://')){logger_1[_0x108e5a(0x13e)][_0x108e5a(0x11a)](_0x108e5a(0xfe));return;}try{if(_0x5d5d72===_0x108e5a(0x12d)){const _0x368d5a=await getEfiOptions(),_0x1ebc09=new sdk_node_apis_efi_1[(_0x108e5a(0x136))](_0x368d5a),_0x56f70e={'chave':await(0x0,GetSuperSettingService_1[_0x108e5a(0x136)])({'key':_0x108e5a(0x121)})};_0x1ebc09[_0x108e5a(0x125)](_0x56f70e)[_0x108e5a(0x122)](_0x4d4c27=>{const _0x1d83e3=_0x108e5a;_0x4d4c27?.['webhookUrl']!==webhookUrl?createWebHook(_0x1ebc09):logger_1[_0x1d83e3(0x13e)][_0x1d83e3(0x11a)]({'result':_0x4d4c27},_0x1d83e3(0x113));},_0x40f831=>{const _0x33f77a=_0x108e5a;_0x40f831?.[_0x33f77a(0x10b)]===_0x33f77a(0x12a)?createWebHook(_0x1ebc09):logger_1[_0x33f77a(0x13e)][_0x33f77a(0x135)](_0x40f831,_0x33f77a(0x134));});}}catch(_0x1454f6){logger_1[_0x108e5a(0x13e)]['error'](_0x1454f6,'efiInitialize:\x20');}};exports[a487_0x4a4757(0x107)]=efiInitialize;const efiWebhook=async(_0x4ee962,_0x51597b)=>{const _0x71e3f2=a487_0x4a4757,{evento:_0x4543ad}=_0x4ee962[_0x71e3f2(0x10a)];if(_0x4543ad===_0x71e3f2(0x10e))return _0x51597b[_0x71e3f2(0x140)]({'ok':!![]});return _0x4ee962[_0x71e3f2(0x10a)][_0x71e3f2(0x109)]&&await Promise[_0x71e3f2(0x110)](_0x4ee962[_0x71e3f2(0x10a)][_0x71e3f2(0x109)][_0x71e3f2(0x142)](async _0x56a796=>{const _0x5cf809=_0x71e3f2;logger_1[_0x5cf809(0x13e)][_0x5cf809(0x11a)](_0x56a796,'Processando\x20pagamento');const _0x19e7af=await Invoices_1[_0x5cf809(0x136)]['findOne']({'where':{'txId':_0x56a796['txid'],'status':_0x5cf809(0x12b)},'include':[{'model':Company_1['default'],'as':_0x5cf809(0x130)}]});if(!_0x19e7af){logger_1['logger'][_0x5cf809(0x11a)]('efiWebhook:\x20Invoice\x20not\x20found\x20or\x20already\x20paid');return;}const _0x18170c=parseFloat(_0x56a796[_0x5cf809(0x146)]);if(_0x18170c<_0x19e7af[_0x5cf809(0x117)]){logger_1[_0x5cf809(0x13e)]['debug'](_0x5cf809(0x14a));return;}await(0x0,PaymentGatewayServices_1['processInvoicePaid'])(_0x19e7af);})),_0x51597b['json']({'ok':!![]});};exports[a487_0x4a4757(0x10d)]=efiWebhook;const efiCheckStatus=async(_0x49ff6c,_0x5647b8=null)=>{const _0x4a4c2a=a487_0x4a4757;try{!_0x5647b8&&(_0x5647b8=await newEfiPayInstance());const _0x280645=await _0x5647b8[_0x4a4c2a(0x100)]({'txid':_0x49ff6c['txId']});if(_0x280645[_0x4a4c2a(0x129)]!==_0x4a4c2a(0x127))return![];const {pix:_0xbe7d70}=_0x280645,_0x429dd9=parseFloat(_0xbe7d70[0x0][_0x4a4c2a(0x146)]);if(_0x429dd9>=_0x49ff6c['value'])return await(0x0,PaymentGatewayServices_1[_0x4a4c2a(0x105)])(_0x49ff6c),!![];return![];}catch(_0x401185){logger_1[_0x4a4c2a(0x13e)][_0x4a4c2a(0x135)](_0x401185,_0x4a4c2a(0x116));}return![];};exports[a487_0x4a4757(0x112)]=efiCheckStatus;const efiPollCheckStatus=async(_0x4bdb6e,_0x186a58,_0x4df1c5=0xa,_0xf73078=0x7530)=>{let _0x440802=0x0;async function _0x48c5c6(){const _0x1e1d6f=a487_0x1f58;await _0x186a58[_0x1e1d6f(0x111)]();if(_0x186a58[_0x1e1d6f(0x129)]==='paid'){logger_1['logger'][_0x1e1d6f(0x11a)]('efiPollCheckStatus:\x20Invoice\x20'+_0x186a58['id']+_0x1e1d6f(0x147));return;}const _0xda76ce=await(0x0,exports[_0x1e1d6f(0x112)])(_0x186a58,_0x4bdb6e);if(_0xda76ce)return;_0x440802+=0x1;if(_0x440802>=_0x4df1c5){(0x0,PaymentGatewayServices_1['processInvoiceExpired'])(_0x186a58);return;}await new Promise(_0x4f4d77=>setTimeout(_0x4f4d77,_0xf73078)),await _0x48c5c6();}return _0x48c5c6();},efiCreateSubscription=async(_0x43e980,_0x4cc8b0)=>{const _0xcd6ea1=a487_0x4a4757,{price:_0x16313a,invoiceId:_0x494d45}=_0x43e980['body'],_0x52d220=parseFloat(_0x16313a),_0x4fce0b={'calendario':{'expiracao':0x12c},'valor':{'original':_0x52d220['toLocaleString'](_0xcd6ea1(0x12e),{'minimumFractionDigits':0x2})[_0xcd6ea1(0x14f)](',','.')},'chave':await(0x0,GetSuperSettingService_1[_0xcd6ea1(0x136)])({'key':'_efiPixKey'}),'solicitacaoPagador':_0xcd6ea1(0x13f)+_0x494d45},_0x423f14=await getEfiOptions();try{const _0x1ecc12=await Invoices_1['default'][_0xcd6ea1(0x11d)](_0x494d45);if(!_0x1ecc12)throw new Error(_0xcd6ea1(0xff));await(0x0,exports[_0xcd6ea1(0x107)])();const _0x1d17b7=new sdk_node_apis_efi_1[(_0xcd6ea1(0x136))](_0x423f14),_0x1c23cd=await _0x1d17b7[_0xcd6ea1(0x115)]([],_0x4fce0b);return await _0x1ecc12[_0xcd6ea1(0x12f)]({'txId':_0x1c23cd['txid'],'payGw':_0xcd6ea1(0x12d),'payGwData':JSON[_0xcd6ea1(0x119)](_0x1c23cd)}),await _0x1ecc12[_0xcd6ea1(0x111)](),efiPollCheckStatus(_0x1d17b7,_0x1ecc12),_0x4cc8b0['json']({'qrcode':{'qrcode':_0x1c23cd[_0xcd6ea1(0x126)]},'valor':{'original':_0x4fce0b[_0xcd6ea1(0x146)][_0xcd6ea1(0x12c)]}});}catch(_0xe03c92){logger_1[_0xcd6ea1(0x13e)][_0xcd6ea1(0x135)]({'efiOptions':_0x423f14,'error':_0xe03c92},_0xcd6ea1(0x133));throw new AppError_1[(_0xcd6ea1(0x136))](_0xcd6ea1(0x14e),0x190);}};exports[a487_0x4a4757(0x144)]=efiCreateSubscription;