const a483_0xa8cdd1=a483_0x47b6;(function(_0x7a79b7,_0x472e14){const _0xcce122=a483_0x47b6,_0x1d6064=_0x7a79b7();while(!![]){try{const _0x20a64e=-parseInt(_0xcce122(0x1b1))/0x1+parseInt(_0xcce122(0x1e0))/0x2*(-parseInt(_0xcce122(0x1ce))/0x3)+-parseInt(_0xcce122(0x1c8))/0x4+parseInt(_0xcce122(0x1d8))/0x5*(-parseInt(_0xcce122(0x1e1))/0x6)+-parseInt(_0xcce122(0x1e6))/0x7+parseInt(_0xcce122(0x19b))/0x8*(parseInt(_0xcce122(0x1c9))/0x9)+parseInt(_0xcce122(0x199))/0xa*(parseInt(_0xcce122(0x1ba))/0xb);if(_0x20a64e===_0x472e14)break;else _0x1d6064['push'](_0x1d6064['shift']());}catch(_0x58f0fd){_0x1d6064['push'](_0x1d6064['shift']());}}}(a483_0x37a2,0xd9f7a));const a483_0x55e2ba=(function(){let _0x1c3522=!![];return function(_0x5378be,_0x1bb147){const _0x3725a1=_0x1c3522?function(){const _0xdaed82=a483_0x47b6;if(_0x1bb147){const _0x3f1a5b=_0x1bb147[_0xdaed82(0x1a1)](_0x5378be,arguments);return _0x1bb147=null,_0x3f1a5b;}}:function(){};return _0x1c3522=![],_0x3725a1;};}()),a483_0xbb8f8a=a483_0x55e2ba(this,function(){const _0x10d634=a483_0x47b6;return a483_0xbb8f8a[_0x10d634(0x1b3)]()[_0x10d634(0x1c2)]('(((.+)+)+)+$')['toString']()[_0x10d634(0x1ae)](a483_0xbb8f8a)[_0x10d634(0x1c2)]('(((.+)+)+)+$');});a483_0xbb8f8a();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x1f2d51){return _0x1f2d51&&_0x1f2d51['__esModule']?_0x1f2d51:{'default':_0x1f2d51};};function a483_0x47b6(_0x3d168a,_0x2a6148){const _0x373ba8=a483_0x37a2();return a483_0x47b6=function(_0xbb8f8a,_0x55e2ba){_0xbb8f8a=_0xbb8f8a-0x196;let _0x37a2d0=_0x373ba8[_0xbb8f8a];return _0x37a2d0;},a483_0x47b6(_0x3d168a,_0x2a6148);}Object[a483_0xa8cdd1(0x1a0)](exports,a483_0xa8cdd1(0x1aa),{'value':!![]}),exports[a483_0xa8cdd1(0x1e4)]=exports['efiCheckStatus']=exports['efiWebhook']=exports[a483_0xa8cdd1(0x1a5)]=void 0x0;const sdk_node_apis_efi_1=__importDefault(require(a483_0xa8cdd1(0x1d2))),path_1=__importDefault(require(a483_0xa8cdd1(0x1bb))),GetSuperSettingService_1=__importDefault(require(a483_0xa8cdd1(0x1a8))),logger_1=require(a483_0xa8cdd1(0x1c4)),Invoices_1=__importDefault(require(a483_0xa8cdd1(0x1cd))),Company_1=__importDefault(require(a483_0xa8cdd1(0x1b9))),AppError_1=__importDefault(require(a483_0xa8cdd1(0x197))),PaymentGatewayServices_1=require('./PaymentGatewayServices'),webhookUrl=process[a483_0xa8cdd1(0x1af)][a483_0xa8cdd1(0x1b5)]+a483_0xa8cdd1(0x19d);async function getEfiOptions(){const _0x1e2b0a=a483_0xa8cdd1,_0x3c1ecf=path_1[_0x1e2b0a(0x1b0)][_0x1e2b0a(0x1dc)](__dirname,'../../../private/'+await(0x0,GetSuperSettingService_1[_0x1e2b0a(0x1b0)])({'key':_0x1e2b0a(0x1c0)}));return{'sandbox':![],'client_id':await(0x0,GetSuperSettingService_1[_0x1e2b0a(0x1b0)])({'key':_0x1e2b0a(0x1d7)}),'client_secret':await(0x0,GetSuperSettingService_1[_0x1e2b0a(0x1b0)])({'key':_0x1e2b0a(0x1a4)}),'pix_cert':_0x3c1ecf,'validateMtls':![]};}const newEfiPayInstance=async()=>{const _0x31076b=a483_0xa8cdd1,_0x590f1f=await getEfiOptions();return new sdk_node_apis_efi_1[(_0x31076b(0x1b0))](_0x590f1f);},createWebHook=async _0x2e5552=>{const _0x3adc0a=a483_0xa8cdd1,_0x3d1d70={'chave':await(0x0,GetSuperSettingService_1['default'])({'key':'_efiPixKey'})},_0x5a76c1={'webhookUrl':webhookUrl};return _0x2e5552[_0x3adc0a(0x1da)](_0x3d1d70,_0x5a76c1)[_0x3adc0a(0x1ab)](_0x51b9fd=>{const _0x3de5d5=_0x3adc0a;logger_1[_0x3de5d5(0x1a3)][_0x3de5d5(0x19c)]({'result':_0x51b9fd},_0x3de5d5(0x1b7));},_0x2ffa21=>{const _0x2c1374=_0x3adc0a;logger_1[_0x2c1374(0x1a3)][_0x2c1374(0x1e5)]({'result':_0x2ffa21},_0x2c1374(0x1e7));});},efiInitialize=async()=>{const _0x5f3dcf=a483_0xa8cdd1,_0x158d7c=await(0x0,GetSuperSettingService_1[_0x5f3dcf(0x1b0)])({'key':_0x5f3dcf(0x1cf)});if(!webhookUrl[_0x5f3dcf(0x1ad)](_0x5f3dcf(0x1b8))){logger_1[_0x5f3dcf(0x1a3)][_0x5f3dcf(0x1bf)]('efiInitialize:\x20only\x20SSL\x20webhooks\x20are\x20supported');return;}try{if(_0x158d7c==='efi'){const _0x30a815=await getEfiOptions(),_0x5f4185=new sdk_node_apis_efi_1[(_0x5f3dcf(0x1b0))](_0x30a815),_0x15b714={'chave':await(0x0,GetSuperSettingService_1['default'])({'key':_0x5f3dcf(0x1ac)})};_0x5f4185['pixDetailWebhook'](_0x15b714)[_0x5f3dcf(0x1ab)](_0x48a1b1=>{const _0x496861=_0x5f3dcf;_0x48a1b1?.['webhookUrl']!==webhookUrl?createWebHook(_0x5f4185):logger_1[_0x496861(0x1a3)][_0x496861(0x1bf)]({'result':_0x48a1b1},_0x496861(0x1e3));},_0x4fb305=>{const _0x14442b=_0x5f3dcf;_0x4fb305?.[_0x14442b(0x1c6)]==='webhook_nao_encontrado'?createWebHook(_0x5f4185):logger_1[_0x14442b(0x1a3)]['error'](_0x4fb305,_0x14442b(0x1a2));});}}catch(_0x289eab){logger_1[_0x5f3dcf(0x1a3)][_0x5f3dcf(0x1e5)](_0x289eab,'efiInitialize:\x20');}};exports[a483_0xa8cdd1(0x1a5)]=efiInitialize;const efiWebhook=async(_0x3a7680,_0x3e390e)=>{const _0x2ec83e=a483_0xa8cdd1,{evento:_0x1d8a54}=_0x3a7680[_0x2ec83e(0x1d4)];if(_0x1d8a54===_0x2ec83e(0x19f))return _0x3e390e[_0x2ec83e(0x1b6)]({'ok':!![]});return _0x3a7680['body']['pix']&&await Promise[_0x2ec83e(0x198)](_0x3a7680[_0x2ec83e(0x1d4)][_0x2ec83e(0x1cc)]['map'](async _0xe55f4c=>{const _0xce17ae=_0x2ec83e;logger_1[_0xce17ae(0x1a3)]['debug'](_0xe55f4c,_0xce17ae(0x1d3));const _0x120dd7=await Invoices_1[_0xce17ae(0x1b0)]['findOne']({'where':{'txId':_0xe55f4c[_0xce17ae(0x19a)],'status':'open'},'include':[{'model':Company_1['default'],'as':'company'}]});if(!_0x120dd7){logger_1[_0xce17ae(0x1a3)][_0xce17ae(0x1bf)]('efiWebhook:\x20Invoice\x20not\x20found\x20or\x20already\x20paid');return;}const _0x20ad88=parseFloat(_0xe55f4c[_0xce17ae(0x1b2)]);if(_0x20ad88<_0x120dd7[_0xce17ae(0x1d1)]){logger_1[_0xce17ae(0x1a3)]['debug'](_0xce17ae(0x1d0));return;}await(0x0,PaymentGatewayServices_1[_0xce17ae(0x1bd)])(_0x120dd7);})),_0x3e390e[_0x2ec83e(0x1b6)]({'ok':!![]});};exports[a483_0xa8cdd1(0x1d6)]=efiWebhook;function a483_0x37a2(){const _0x3b81c7=['https://','../../models/Company','3324937gZKBAC','path','txId','processInvoicePaid','Invoice\x20not\x20found','debug','_efiCertFile','efiCheckStatus','search','replace','../../utils/logger','CONCLUIDA','nome','processInvoiceExpired','259760mjcRIV','526185IJdrim','efi','#Fatura:','pix','../../models/Invoices','6boBEXf','_paymentGateway','Recebido\x20valor\x20menor','value','sdk-node-apis-efi','Processando\x20pagamento','body','stringify','efiWebhook','_efiClientId','415KylveW','reload','pixConfigWebhook','pixCreateImmediateCharge','join','Error\x20getting\x20detail\x20of\x20txid','Problema\x20encontrado,\x20entre\x20em\x20contato\x20com\x20o\x20suporte!','\x20already\x20paid,\x20finishing\x20polling','675742XhZTKt','74238BCSllD','efiCreateSubscription\x20error','efiInitialize:\x20webhook\x20correto\x20jÃ¡\x20instalado','efiCreateSubscription','error','3297035yuzibV','pixConfigWebhook\x20error:','findByPk','../../errors/AppError','all','90UNMQaX','txid','88zCrmrM','info','/subscription/aa/webhook','pixDetailCharge','teste_webhook','defineProperty','apply','efiInitialize:\x20fail\x20to\x20verify\x20current\x20webhook','logger','_efiClientSecret','efiInitialize','toLocaleString','status','../SettingServices/GetSuperSettingService','paid','__esModule','then','_efiPixKey','startsWith','constructor','env','default','232078GsaWWg','valor','toString','update','BACKEND_URL','json','pixConfigWebhook\x20ok'];a483_0x37a2=function(){return _0x3b81c7;};return a483_0x37a2();}const efiCheckStatus=async(_0x81845,_0x489441=null)=>{const _0x23fba6=a483_0xa8cdd1;try{!_0x489441&&(_0x489441=await newEfiPayInstance());const _0x15061b=await _0x489441[_0x23fba6(0x19e)]({'txid':_0x81845[_0x23fba6(0x1bc)]});if(_0x15061b[_0x23fba6(0x1a7)]!==_0x23fba6(0x1c5))return![];const {pix:_0x4966b4}=_0x15061b,_0x1f8b45=parseFloat(_0x4966b4[0x0][_0x23fba6(0x1b2)]);if(_0x1f8b45>=_0x81845['value'])return await(0x0,PaymentGatewayServices_1[_0x23fba6(0x1bd)])(_0x81845),!![];return![];}catch(_0x5701d6){logger_1['logger']['error'](_0x5701d6,_0x23fba6(0x1dd));}return![];};exports['efiCheckStatus']=efiCheckStatus;const efiPollCheckStatus=async(_0x3393c3,_0x28b314,_0xccb234=0xa,_0x51cb81=0x7530)=>{let _0x5920d4=0x0;async function _0x4b1a93(){const _0x4003fe=a483_0x47b6;await _0x28b314[_0x4003fe(0x1d9)]();if(_0x28b314[_0x4003fe(0x1a7)]===_0x4003fe(0x1a9)){logger_1[_0x4003fe(0x1a3)][_0x4003fe(0x1bf)]('efiPollCheckStatus:\x20Invoice\x20'+_0x28b314['id']+_0x4003fe(0x1df));return;}const _0x4b5a9b=await(0x0,exports[_0x4003fe(0x1c1)])(_0x28b314,_0x3393c3);if(_0x4b5a9b)return;_0x5920d4+=0x1;if(_0x5920d4>=_0xccb234){(0x0,PaymentGatewayServices_1[_0x4003fe(0x1c7)])(_0x28b314);return;}await new Promise(_0x304c00=>setTimeout(_0x304c00,_0x51cb81)),await _0x4b1a93();}return _0x4b1a93();},efiCreateSubscription=async(_0x44d485,_0x4ce22b)=>{const _0x57397b=a483_0xa8cdd1,{price:_0x1a6e3b,invoiceId:_0x1971d7}=_0x44d485[_0x57397b(0x1d4)],_0x18ad4f=parseFloat(_0x1a6e3b),_0x806000={'calendario':{'expiracao':0x12c},'valor':{'original':_0x18ad4f[_0x57397b(0x1a6)]('pt-br',{'minimumFractionDigits':0x2})[_0x57397b(0x1c3)](',','.')},'chave':await(0x0,GetSuperSettingService_1[_0x57397b(0x1b0)])({'key':_0x57397b(0x1ac)}),'solicitacaoPagador':_0x57397b(0x1cb)+_0x1971d7},_0x2f1cc0=await getEfiOptions();try{const _0x1cc44c=await Invoices_1[_0x57397b(0x1b0)][_0x57397b(0x196)](_0x1971d7);if(!_0x1cc44c)throw new Error(_0x57397b(0x1be));await(0x0,exports[_0x57397b(0x1a5)])();const _0x4423ae=new sdk_node_apis_efi_1[(_0x57397b(0x1b0))](_0x2f1cc0),_0x5e08fc=await _0x4423ae[_0x57397b(0x1db)]([],_0x806000);return await _0x1cc44c[_0x57397b(0x1b4)]({'txId':_0x5e08fc[_0x57397b(0x19a)],'payGw':_0x57397b(0x1ca),'payGwData':JSON[_0x57397b(0x1d5)](_0x5e08fc)}),await _0x1cc44c[_0x57397b(0x1d9)](),efiPollCheckStatus(_0x4423ae,_0x1cc44c),_0x4ce22b[_0x57397b(0x1b6)]({'qrcode':{'qrcode':_0x5e08fc['pixCopiaECola']},'valor':{'original':_0x806000[_0x57397b(0x1b2)]['original']}});}catch(_0x1722cc){logger_1[_0x57397b(0x1a3)][_0x57397b(0x1e5)]({'efiOptions':_0x2f1cc0,'error':_0x1722cc},_0x57397b(0x1e2));throw new AppError_1[(_0x57397b(0x1b0))](_0x57397b(0x1de),0x190);}};exports['efiCreateSubscription']=efiCreateSubscription;