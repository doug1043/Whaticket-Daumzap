const a586_0x148601=a586_0x5ab3;(function(_0x5f596e,_0x206412){const _0x11b175=a586_0x5ab3,_0x9df7ca=_0x5f596e();while(!![]){try{const _0x2ed39a=-parseInt(_0x11b175(0xd0))/0x1*(parseInt(_0x11b175(0xf4))/0x2)+-parseInt(_0x11b175(0xfd))/0x3*(-parseInt(_0x11b175(0xd6))/0x4)+-parseInt(_0x11b175(0xd3))/0x5+parseInt(_0x11b175(0xe9))/0x6*(-parseInt(_0x11b175(0xdc))/0x7)+-parseInt(_0x11b175(0xd8))/0x8*(parseInt(_0x11b175(0xd7))/0x9)+parseInt(_0x11b175(0xf7))/0xa*(-parseInt(_0x11b175(0x112))/0xb)+parseInt(_0x11b175(0xf6))/0xc;if(_0x2ed39a===_0x206412)break;else _0x9df7ca['push'](_0x9df7ca['shift']());}catch(_0x5d10f3){_0x9df7ca['push'](_0x9df7ca['shift']());}}}(a586_0x2318,0xe2adf));const a586_0x16f741=(function(){let _0x33809a=!![];return function(_0x28d3ea,_0x5bbc08){const _0x1a0147=_0x33809a?function(){const _0x475ec0=a586_0x5ab3;if(_0x5bbc08){const _0xec39d6=_0x5bbc08[_0x475ec0(0xda)](_0x28d3ea,arguments);return _0x5bbc08=null,_0xec39d6;}}:function(){};return _0x33809a=![],_0x1a0147;};}()),a586_0x12ae42=a586_0x16f741(this,function(){const _0x5eaf26=a586_0x5ab3;return a586_0x12ae42[_0x5eaf26(0x10c)]()[_0x5eaf26(0xde)](_0x5eaf26(0xd2))[_0x5eaf26(0x10c)]()[_0x5eaf26(0xee)](a586_0x12ae42)[_0x5eaf26(0xde)](_0x5eaf26(0xd2));});a586_0x12ae42();function a586_0x5ab3(_0x56dce0,_0x1ceeaf){const _0x37c5a3=a586_0x2318();return a586_0x5ab3=function(_0x12ae42,_0x16f741){_0x12ae42=_0x12ae42-0xcb;let _0x231801=_0x37c5a3[_0x12ae42];return _0x231801;},a586_0x5ab3(_0x56dce0,_0x1ceeaf);}'use strict';var __importDefault=this&&this['__importDefault']||function(_0x40ba97){const _0x31f099=a586_0x5ab3;return _0x40ba97&&_0x40ba97[_0x31f099(0xed)]?_0x40ba97:{'default':_0x40ba97};};Object['defineProperty'](exports,a586_0x148601(0xed),{'value':!![]}),exports[a586_0x148601(0x103)]=exports[a586_0x148601(0xe2)]=exports['efiWebhook']=exports[a586_0x148601(0xe1)]=void 0x0;const sdk_node_apis_efi_1=__importDefault(require(a586_0x148601(0xef))),path_1=__importDefault(require(a586_0x148601(0xdf))),GetSuperSettingService_1=__importDefault(require('../SettingServices/GetSuperSettingService')),logger_1=require(a586_0x148601(0x117)),Invoices_1=__importDefault(require(a586_0x148601(0xe7))),Company_1=__importDefault(require(a586_0x148601(0xfc))),AppError_1=__importDefault(require(a586_0x148601(0x11f))),PaymentGatewayServices_1=require(a586_0x148601(0xd5)),webhookUrl=process[a586_0x148601(0xe0)]['BACKEND_URL']+'/subscription/aa/webhook';async function getEfiOptions(){const _0x5733c8=a586_0x148601,_0x35e18e=path_1[_0x5733c8(0x10a)][_0x5733c8(0xff)](__dirname,_0x5733c8(0xf8)+await(0x0,GetSuperSettingService_1[_0x5733c8(0x10a)])({'key':_0x5733c8(0xe8)}));return{'sandbox':![],'client_id':await(0x0,GetSuperSettingService_1[_0x5733c8(0x10a)])({'key':_0x5733c8(0xf0)}),'client_secret':await(0x0,GetSuperSettingService_1[_0x5733c8(0x10a)])({'key':_0x5733c8(0x11e)}),'pix_cert':_0x35e18e,'validateMtls':![]};}const newEfiPayInstance=async()=>{const _0x504445=a586_0x148601,_0xe6ad6=await getEfiOptions();return new sdk_node_apis_efi_1[(_0x504445(0x10a))](_0xe6ad6);},createWebHook=async _0x28fa85=>{const _0x82411b=a586_0x148601,_0x524639={'chave':await(0x0,GetSuperSettingService_1['default'])({'key':_0x82411b(0x122)})},_0xdd92f0={'webhookUrl':webhookUrl};return _0x28fa85[_0x82411b(0x10e)](_0x524639,_0xdd92f0)[_0x82411b(0x105)](_0x3d9654=>{const _0x27d83d=_0x82411b;logger_1[_0x27d83d(0x100)][_0x27d83d(0x116)]({'result':_0x3d9654},_0x27d83d(0xfe));},_0x17adb7=>{const _0xabc781=_0x82411b;logger_1[_0xabc781(0x100)][_0xabc781(0x109)]({'result':_0x17adb7},_0xabc781(0x115));});},efiInitialize=async()=>{const _0x373bf3=a586_0x148601,_0x4888e3=await(0x0,GetSuperSettingService_1[_0x373bf3(0x10a)])({'key':_0x373bf3(0xd1)});if(!webhookUrl[_0x373bf3(0x11d)](_0x373bf3(0x106))){logger_1[_0x373bf3(0x100)][_0x373bf3(0x113)](_0x373bf3(0x11b));return;}try{if(_0x4888e3===_0x373bf3(0xfa)){const _0xf90ec9=await getEfiOptions(),_0x3a5084=new sdk_node_apis_efi_1[(_0x373bf3(0x10a))](_0xf90ec9),_0x552570={'chave':await(0x0,GetSuperSettingService_1[_0x373bf3(0x10a)])({'key':_0x373bf3(0x122)})};_0x3a5084[_0x373bf3(0x10d)](_0x552570)[_0x373bf3(0x105)](_0x5700d9=>{const _0x424565=_0x373bf3;_0x5700d9?.[_0x424565(0xea)]!==webhookUrl?createWebHook(_0x3a5084):logger_1[_0x424565(0x100)][_0x424565(0x113)]({'result':_0x5700d9},'efiInitialize:\x20webhook\x20correto\x20jÃ¡\x20instalado');},_0x47a488=>{const _0x460a85=_0x373bf3;_0x47a488?.[_0x460a85(0x11a)]===_0x460a85(0xe4)?createWebHook(_0x3a5084):logger_1[_0x460a85(0x100)][_0x460a85(0x109)](_0x47a488,'efiInitialize:\x20fail\x20to\x20verify\x20current\x20webhook');});}}catch(_0x3bfe20){logger_1[_0x373bf3(0x100)][_0x373bf3(0x109)](_0x3bfe20,_0x373bf3(0xd9));}};exports[a586_0x148601(0xe1)]=efiInitialize;const efiWebhook=async(_0x2aa65c,_0x347025)=>{const _0x4e0f42=a586_0x148601,{evento:_0x6828fd}=_0x2aa65c[_0x4e0f42(0xec)];if(_0x6828fd===_0x4e0f42(0xcf))return _0x347025[_0x4e0f42(0xdd)]({'ok':!![]});return _0x2aa65c[_0x4e0f42(0xec)][_0x4e0f42(0x120)]&&await Promise[_0x4e0f42(0xcd)](_0x2aa65c[_0x4e0f42(0xec)][_0x4e0f42(0x120)]['map'](async _0x536478=>{const _0x34aafc=_0x4e0f42;logger_1[_0x34aafc(0x100)][_0x34aafc(0x113)](_0x536478,_0x34aafc(0x11c));const _0x6b475b=await Invoices_1['default'][_0x34aafc(0x102)]({'where':{'txId':_0x536478[_0x34aafc(0xce)],'status':_0x34aafc(0x101)},'include':[{'model':Company_1[_0x34aafc(0x10a)],'as':_0x34aafc(0x107)}]});if(!_0x6b475b){logger_1[_0x34aafc(0x100)][_0x34aafc(0x113)](_0x34aafc(0xe3));return;}const _0x463403=parseFloat(_0x536478[_0x34aafc(0x118)]);if(_0x463403<_0x6b475b[_0x34aafc(0x111)]){logger_1['logger']['debug'](_0x34aafc(0xdb));return;}await(0x0,PaymentGatewayServices_1[_0x34aafc(0xcb)])(_0x6b475b);})),_0x347025[_0x4e0f42(0xdd)]({'ok':!![]});};function a586_0x2318(){const _0x313724=['efiPollCheckStatus:\x20Invoice\x20','pixConfigWebhook\x20error:','info','../../utils/logger','valor','efiCreateSubscription\x20error','nome','efiInitialize:\x20only\x20SSL\x20webhooks\x20are\x20supported','Processando\x20pagamento','startsWith','_efiClientSecret','../../errors/AppError','pix','stringify','_efiPixKey','processInvoicePaid','toLocaleString','all','txid','teste_webhook','216061FYBgoh','_paymentGateway','(((.+)+)+)+$','7978515wFLVHo','pixCreateImmediateCharge','./PaymentGatewayServices','116OwyFtw','243234RQRHEu','240hFbLIy','efiInitialize:\x20','apply','Recebido\x20valor\x20menor','7SXDMIG','json','search','path','env','efiInitialize','efiCheckStatus','efiWebhook:\x20Invoice\x20not\x20found\x20or\x20already\x20paid','webhook_nao_encontrado','paid','status','../../models/Invoices','_efiCertFile','7602084dFVJzC','webhookUrl','efiWebhook','body','__esModule','constructor','sdk-node-apis-efi','_efiClientId','Problema\x20encontrado,\x20entre\x20em\x20contato\x20com\x20o\x20suporte!','processInvoiceExpired','original','2XBXsqk','CONCLUIDA','50693484KxgbKp','10jjOieC','../../../private/','Error\x20getting\x20detail\x20of\x20txid','efi','txId','../../models/Company','122127clMGZG','pixConfigWebhook\x20ok','join','logger','open','findOne','efiCreateSubscription','replace','then','https://','company','reload','error','default','findByPk','toString','pixDetailWebhook','pixConfigWebhook','pixCopiaECola','update','value','6456791MePwiM','debug'];a586_0x2318=function(){return _0x313724;};return a586_0x2318();}exports[a586_0x148601(0xeb)]=efiWebhook;const efiCheckStatus=async(_0x35fd34,_0x58867c=null)=>{const _0x5478fa=a586_0x148601;try{!_0x58867c&&(_0x58867c=await newEfiPayInstance());const _0x35dc28=await _0x58867c['pixDetailCharge']({'txid':_0x35fd34[_0x5478fa(0xfb)]});if(_0x35dc28[_0x5478fa(0xe6)]!==_0x5478fa(0xf5))return![];const {pix:_0x1a0213}=_0x35dc28,_0x391e12=parseFloat(_0x1a0213[0x0][_0x5478fa(0x118)]);if(_0x391e12>=_0x35fd34['value'])return await(0x0,PaymentGatewayServices_1[_0x5478fa(0xcb)])(_0x35fd34),!![];return![];}catch(_0x3b1ed6){logger_1[_0x5478fa(0x100)][_0x5478fa(0x109)](_0x3b1ed6,_0x5478fa(0xf9));}return![];};exports[a586_0x148601(0xe2)]=efiCheckStatus;const efiPollCheckStatus=async(_0x19c07f,_0x42ed13,_0x4aca66=0xa,_0x20431b=0x7530)=>{let _0x40ac9f=0x0;async function _0x2d11f9(){const _0x5eff7d=a586_0x5ab3;await _0x42ed13['reload']();if(_0x42ed13[_0x5eff7d(0xe6)]===_0x5eff7d(0xe5)){logger_1[_0x5eff7d(0x100)]['debug'](_0x5eff7d(0x114)+_0x42ed13['id']+'\x20already\x20paid,\x20finishing\x20polling');return;}const _0x24fc04=await(0x0,exports[_0x5eff7d(0xe2)])(_0x42ed13,_0x19c07f);if(_0x24fc04)return;_0x40ac9f+=0x1;if(_0x40ac9f>=_0x4aca66){(0x0,PaymentGatewayServices_1[_0x5eff7d(0xf2)])(_0x42ed13);return;}await new Promise(_0x48ac7f=>setTimeout(_0x48ac7f,_0x20431b)),await _0x2d11f9();}return _0x2d11f9();},efiCreateSubscription=async(_0xf12be8,_0x19ea43)=>{const _0x516daf=a586_0x148601,{price:_0x281187,invoiceId:_0xa6d9f3}=_0xf12be8[_0x516daf(0xec)],_0xd09ce6=parseFloat(_0x281187),_0x25d6d3={'calendario':{'expiracao':0x12c},'valor':{'original':_0xd09ce6[_0x516daf(0xcc)]('pt-br',{'minimumFractionDigits':0x2})[_0x516daf(0x104)](',','.')},'chave':await(0x0,GetSuperSettingService_1['default'])({'key':_0x516daf(0x122)}),'solicitacaoPagador':'#Fatura:'+_0xa6d9f3},_0x1ee458=await getEfiOptions();try{const _0xd9faff=await Invoices_1[_0x516daf(0x10a)][_0x516daf(0x10b)](_0xa6d9f3);if(!_0xd9faff)throw new Error('Invoice\x20not\x20found');await(0x0,exports[_0x516daf(0xe1)])();const _0x52fa30=new sdk_node_apis_efi_1['default'](_0x1ee458),_0x1fa2e4=await _0x52fa30[_0x516daf(0xd4)]([],_0x25d6d3);return await _0xd9faff[_0x516daf(0x110)]({'txId':_0x1fa2e4[_0x516daf(0xce)],'payGw':_0x516daf(0xfa),'payGwData':JSON[_0x516daf(0x121)](_0x1fa2e4)}),await _0xd9faff[_0x516daf(0x108)](),efiPollCheckStatus(_0x52fa30,_0xd9faff),_0x19ea43[_0x516daf(0xdd)]({'qrcode':{'qrcode':_0x1fa2e4[_0x516daf(0x10f)]},'valor':{'original':_0x25d6d3[_0x516daf(0x118)][_0x516daf(0xf3)]}});}catch(_0x58ccf8){logger_1['logger'][_0x516daf(0x109)]({'efiOptions':_0x1ee458,'error':_0x58ccf8},_0x516daf(0x119));throw new AppError_1[(_0x516daf(0x10a))](_0x516daf(0xf1),0x190);}};exports[a586_0x148601(0x103)]=efiCreateSubscription;