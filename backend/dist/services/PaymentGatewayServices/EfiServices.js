const a587_0x574a12=a587_0x14ba;(function(_0x2f92ad,_0x590988){const _0x191eb9=a587_0x14ba,_0x135bd=_0x2f92ad();while(!![]){try{const _0x42e28a=-parseInt(_0x191eb9(0x1fe))/0x1*(parseInt(_0x191eb9(0x1cc))/0x2)+parseInt(_0x191eb9(0x1e0))/0x3+parseInt(_0x191eb9(0x1dd))/0x4+-parseInt(_0x191eb9(0x1f4))/0x5+-parseInt(_0x191eb9(0x1d2))/0x6*(-parseInt(_0x191eb9(0x1f0))/0x7)+parseInt(_0x191eb9(0x219))/0x8*(-parseInt(_0x191eb9(0x210))/0x9)+parseInt(_0x191eb9(0x209))/0xa;if(_0x42e28a===_0x590988)break;else _0x135bd['push'](_0x135bd['shift']());}catch(_0xd0ca9){_0x135bd['push'](_0x135bd['shift']());}}}(a587_0x1386,0x2a739));function a587_0x1386(){const _0x569503=['webhook_nao_encontrado','CONCLUIDA','join','processInvoiceExpired','replace','pixCreateImmediateCharge','\x20already\x20paid,\x20finishing\x20polling','webhookUrl','debug','1381576LJKLrK','Invoice\x20not\x20found','pix','74610xAuGrM','efiInitialize:\x20fail\x20to\x20verify\x20current\x20webhook','json','_paymentGateway','efiInitialize:\x20webhook\x20correto\x20jÃ¡\x20instalado','/subscription/aa/webhook','../../../private/','path','efi','body','paid','_efiClientId','efiCreateSubscription\x20error','_efiCertFile','pt-br','efiCreateSubscription','1834TtDyTM','findOne','Recebido\x20valor\x20menor','./PaymentGatewayServices','1314705vKhdcl','status','BACKEND_URL','efiPollCheckStatus:\x20Invoice\x20','toLocaleString','error','then','search','constructor','pixConfigWebhook\x20ok','42jcXwUL','stringify','valor','map','_efiPixKey','Processando\x20pagamento','original','txid','efiCheckStatus','toString','teste_webhook','1418660OUIdNz','efiInitialize:\x20','__esModule','efiInitialize','default','info','Error\x20getting\x20detail\x20of\x20txid','36GgltcK','findByPk','txId','../../errors/AppError','efiInitialize:\x20only\x20SSL\x20webhooks\x20are\x20supported','pixCopiaECola','(((.+)+)+)+$','pixConfigWebhook','../../models/Invoices','582784CQRkeA','logger','reload','value','864bknZBZ','__importDefault','startsWith','_efiClientSecret','processInvoicePaid','apply','5364frlVWM','efiWebhook'];a587_0x1386=function(){return _0x569503;};return a587_0x1386();}const a587_0x177ec1=(function(){let _0x3dda97=!![];return function(_0xdc3135,_0xd0585f){const _0x1b04d9=_0x3dda97?function(){const _0x2d1a6a=a587_0x14ba;if(_0xd0585f){const _0x5651ca=_0xd0585f[_0x2d1a6a(0x1d1)](_0xdc3135,arguments);return _0xd0585f=null,_0x5651ca;}}:function(){};return _0x3dda97=![],_0x1b04d9;};}()),a587_0x422166=a587_0x177ec1(this,function(){const _0x445d1b=a587_0x14ba;return a587_0x422166[_0x445d1b(0x207)]()[_0x445d1b(0x1fb)](_0x445d1b(0x216))['toString']()[_0x445d1b(0x1fc)](a587_0x422166)[_0x445d1b(0x1fb)](_0x445d1b(0x216));});a587_0x422166();'use strict';var __importDefault=this&&this[a587_0x574a12(0x1cd)]||function(_0x1d4176){const _0x5d1666=a587_0x574a12;return _0x1d4176&&_0x1d4176[_0x5d1666(0x20b)]?_0x1d4176:{'default':_0x1d4176};};function a587_0x14ba(_0x1611fd,_0x289c94){const _0x35c958=a587_0x1386();return a587_0x14ba=function(_0x422166,_0x177ec1){_0x422166=_0x422166-0x1cb;let _0x13863c=_0x35c958[_0x422166];return _0x13863c;},a587_0x14ba(_0x1611fd,_0x289c94);}Object['defineProperty'](exports,a587_0x574a12(0x20b),{'value':!![]}),exports[a587_0x574a12(0x1ef)]=exports[a587_0x574a12(0x206)]=exports[a587_0x574a12(0x1d3)]=exports[a587_0x574a12(0x20c)]=void 0x0;const sdk_node_apis_efi_1=__importDefault(require('sdk-node-apis-efi')),path_1=__importDefault(require(a587_0x574a12(0x1e7))),GetSuperSettingService_1=__importDefault(require('../SettingServices/GetSuperSettingService')),logger_1=require('../../utils/logger'),Invoices_1=__importDefault(require(a587_0x574a12(0x218))),Company_1=__importDefault(require('../../models/Company')),AppError_1=__importDefault(require(a587_0x574a12(0x213))),PaymentGatewayServices_1=require(a587_0x574a12(0x1f3)),webhookUrl=process['env'][a587_0x574a12(0x1f6)]+a587_0x574a12(0x1e5);async function getEfiOptions(){const _0x5889a5=a587_0x574a12,_0x53c77c=path_1[_0x5889a5(0x20d)][_0x5889a5(0x1d6)](__dirname,_0x5889a5(0x1e6)+await(0x0,GetSuperSettingService_1[_0x5889a5(0x20d)])({'key':_0x5889a5(0x1ed)}));return{'sandbox':![],'client_id':await(0x0,GetSuperSettingService_1['default'])({'key':_0x5889a5(0x1eb)}),'client_secret':await(0x0,GetSuperSettingService_1[_0x5889a5(0x20d)])({'key':_0x5889a5(0x1cf)}),'pix_cert':_0x53c77c,'validateMtls':![]};}const newEfiPayInstance=async()=>{const _0x4060d8=await getEfiOptions();return new sdk_node_apis_efi_1['default'](_0x4060d8);},createWebHook=async _0x258e48=>{const _0x27324c=a587_0x574a12,_0x55eb35={'chave':await(0x0,GetSuperSettingService_1[_0x27324c(0x20d)])({'key':_0x27324c(0x202)})},_0x5f44c9={'webhookUrl':webhookUrl};return _0x258e48[_0x27324c(0x217)](_0x55eb35,_0x5f44c9)[_0x27324c(0x1fa)](_0x191631=>{const _0x4749db=_0x27324c;logger_1[_0x4749db(0x21a)][_0x4749db(0x20e)]({'result':_0x191631},_0x4749db(0x1fd));},_0xb9bc6f=>{const _0x301d97=_0x27324c;logger_1['logger'][_0x301d97(0x1f9)]({'result':_0xb9bc6f},'pixConfigWebhook\x20error:');});},efiInitialize=async()=>{const _0x40ab06=a587_0x574a12,_0x186894=await(0x0,GetSuperSettingService_1['default'])({'key':_0x40ab06(0x1e3)});if(!webhookUrl[_0x40ab06(0x1ce)]('https://')){logger_1['logger']['debug'](_0x40ab06(0x214));return;}try{if(_0x186894===_0x40ab06(0x1e8)){const _0x1bdaca=await getEfiOptions(),_0x3bff19=new sdk_node_apis_efi_1[(_0x40ab06(0x20d))](_0x1bdaca),_0x1deaf3={'chave':await(0x0,GetSuperSettingService_1[_0x40ab06(0x20d)])({'key':_0x40ab06(0x202)})};_0x3bff19['pixDetailWebhook'](_0x1deaf3)[_0x40ab06(0x1fa)](_0x210db6=>{const _0x2d9d82=_0x40ab06;_0x210db6?.[_0x2d9d82(0x1db)]!==webhookUrl?createWebHook(_0x3bff19):logger_1[_0x2d9d82(0x21a)][_0x2d9d82(0x1dc)]({'result':_0x210db6},_0x2d9d82(0x1e4));},_0x23e342=>{const _0x29fae4=_0x40ab06;_0x23e342?.['nome']===_0x29fae4(0x1d4)?createWebHook(_0x3bff19):logger_1[_0x29fae4(0x21a)][_0x29fae4(0x1f9)](_0x23e342,_0x29fae4(0x1e1));});}}catch(_0x478cfe){logger_1[_0x40ab06(0x21a)][_0x40ab06(0x1f9)](_0x478cfe,_0x40ab06(0x20a));}};exports[a587_0x574a12(0x20c)]=efiInitialize;const efiWebhook=async(_0x1f4cdb,_0x4fbccf)=>{const _0x246c33=a587_0x574a12,{evento:_0xc1ca4}=_0x1f4cdb[_0x246c33(0x1e9)];if(_0xc1ca4===_0x246c33(0x208))return _0x4fbccf['json']({'ok':!![]});return _0x1f4cdb['body'][_0x246c33(0x1df)]&&await Promise['all'](_0x1f4cdb['body'][_0x246c33(0x1df)][_0x246c33(0x201)](async _0x15a1fe=>{const _0x232ec0=_0x246c33;logger_1[_0x232ec0(0x21a)][_0x232ec0(0x1dc)](_0x15a1fe,_0x232ec0(0x203));const _0x28151b=await Invoices_1['default'][_0x232ec0(0x1f1)]({'where':{'txId':_0x15a1fe[_0x232ec0(0x205)],'status':'open'},'include':[{'model':Company_1['default'],'as':'company'}]});if(!_0x28151b){logger_1[_0x232ec0(0x21a)][_0x232ec0(0x1dc)]('efiWebhook:\x20Invoice\x20not\x20found\x20or\x20already\x20paid');return;}const _0x4d8111=parseFloat(_0x15a1fe[_0x232ec0(0x200)]);if(_0x4d8111<_0x28151b[_0x232ec0(0x1cb)]){logger_1[_0x232ec0(0x21a)][_0x232ec0(0x1dc)](_0x232ec0(0x1f2));return;}await(0x0,PaymentGatewayServices_1[_0x232ec0(0x1d0)])(_0x28151b);})),_0x4fbccf['json']({'ok':!![]});};exports['efiWebhook']=efiWebhook;const efiCheckStatus=async(_0x46e40e,_0xe9aa86=null)=>{const _0x280951=a587_0x574a12;try{!_0xe9aa86&&(_0xe9aa86=await newEfiPayInstance());const _0x20fc80=await _0xe9aa86['pixDetailCharge']({'txid':_0x46e40e[_0x280951(0x212)]});if(_0x20fc80[_0x280951(0x1f5)]!==_0x280951(0x1d5))return![];const {pix:_0x2d85ae}=_0x20fc80,_0x2b2b07=parseFloat(_0x2d85ae[0x0][_0x280951(0x200)]);if(_0x2b2b07>=_0x46e40e[_0x280951(0x1cb)])return await(0x0,PaymentGatewayServices_1['processInvoicePaid'])(_0x46e40e),!![];return![];}catch(_0x15809f){logger_1[_0x280951(0x21a)]['error'](_0x15809f,_0x280951(0x20f));}return![];};exports[a587_0x574a12(0x206)]=efiCheckStatus;const efiPollCheckStatus=async(_0x52d509,_0x3965bb,_0x50200d=0xa,_0xb72963=0x7530)=>{let _0x58a23c=0x0;async function _0x2a1c60(){const _0x28205e=a587_0x14ba;await _0x3965bb[_0x28205e(0x21b)]();if(_0x3965bb[_0x28205e(0x1f5)]===_0x28205e(0x1ea)){logger_1['logger'][_0x28205e(0x1dc)](_0x28205e(0x1f7)+_0x3965bb['id']+_0x28205e(0x1da));return;}const _0x2c485a=await(0x0,exports[_0x28205e(0x206)])(_0x3965bb,_0x52d509);if(_0x2c485a)return;_0x58a23c+=0x1;if(_0x58a23c>=_0x50200d){(0x0,PaymentGatewayServices_1[_0x28205e(0x1d7)])(_0x3965bb);return;}await new Promise(_0x2db466=>setTimeout(_0x2db466,_0xb72963)),await _0x2a1c60();}return _0x2a1c60();},efiCreateSubscription=async(_0x1dad41,_0x413dcc)=>{const _0x5cd5c9=a587_0x574a12,{price:_0x47b5d4,invoiceId:_0x513b8b}=_0x1dad41[_0x5cd5c9(0x1e9)],_0x28c115=parseFloat(_0x47b5d4),_0x32bcf2={'calendario':{'expiracao':0x12c},'valor':{'original':_0x28c115[_0x5cd5c9(0x1f8)](_0x5cd5c9(0x1ee),{'minimumFractionDigits':0x2})[_0x5cd5c9(0x1d8)](',','.')},'chave':await(0x0,GetSuperSettingService_1['default'])({'key':_0x5cd5c9(0x202)}),'solicitacaoPagador':'#Fatura:'+_0x513b8b},_0x791e7c=await getEfiOptions();try{const _0x35f5db=await Invoices_1['default'][_0x5cd5c9(0x211)](_0x513b8b);if(!_0x35f5db)throw new Error(_0x5cd5c9(0x1de));await(0x0,exports[_0x5cd5c9(0x20c)])();const _0x51d7d1=new sdk_node_apis_efi_1[(_0x5cd5c9(0x20d))](_0x791e7c),_0x10160a=await _0x51d7d1[_0x5cd5c9(0x1d9)]([],_0x32bcf2);return await _0x35f5db['update']({'txId':_0x10160a[_0x5cd5c9(0x205)],'payGw':_0x5cd5c9(0x1e8),'payGwData':JSON[_0x5cd5c9(0x1ff)](_0x10160a)}),await _0x35f5db[_0x5cd5c9(0x21b)](),efiPollCheckStatus(_0x51d7d1,_0x35f5db),_0x413dcc[_0x5cd5c9(0x1e2)]({'qrcode':{'qrcode':_0x10160a[_0x5cd5c9(0x215)]},'valor':{'original':_0x32bcf2[_0x5cd5c9(0x200)][_0x5cd5c9(0x204)]}});}catch(_0x5bc5f4){logger_1['logger'][_0x5cd5c9(0x1f9)]({'efiOptions':_0x791e7c,'error':_0x5bc5f4},_0x5cd5c9(0x1ec));throw new AppError_1[(_0x5cd5c9(0x20d))]('Problema\x20encontrado,\x20entre\x20em\x20contato\x20com\x20o\x20suporte!',0x190);}};exports[a587_0x574a12(0x1ef)]=efiCreateSubscription;