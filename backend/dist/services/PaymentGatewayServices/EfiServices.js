const a451_0x54e9fe=a451_0x7439;(function(_0x86733c,_0xecd87a){const _0x326ed4=a451_0x7439,_0x5b5212=_0x86733c();while(!![]){try{const _0x1f69f9=-parseInt(_0x326ed4(0x1b2))/0x1*(parseInt(_0x326ed4(0x1ae))/0x2)+-parseInt(_0x326ed4(0x197))/0x3+parseInt(_0x326ed4(0x184))/0x4*(parseInt(_0x326ed4(0x1b0))/0x5)+parseInt(_0x326ed4(0x196))/0x6+parseInt(_0x326ed4(0x176))/0x7*(parseInt(_0x326ed4(0x17c))/0x8)+parseInt(_0x326ed4(0x18e))/0x9*(parseInt(_0x326ed4(0x19c))/0xa)+parseInt(_0x326ed4(0x1c1))/0xb*(-parseInt(_0x326ed4(0x1a7))/0xc);if(_0x1f69f9===_0xecd87a)break;else _0x5b5212['push'](_0x5b5212['shift']());}catch(_0x2b7b26){_0x5b5212['push'](_0x5b5212['shift']());}}}(a451_0x153a,0xa575c));function a451_0x7439(_0x3fb812,_0x9f1c9c){const _0x5f5ac8=a451_0x153a();return a451_0x7439=function(_0x2a21f0,_0x46473d){_0x2a21f0=_0x2a21f0-0x171;let _0x153a06=_0x5f5ac8[_0x2a21f0];return _0x153a06;},a451_0x7439(_0x3fb812,_0x9f1c9c);}const a451_0x46473d=(function(){let _0x200778=!![];return function(_0x130c0d,_0x2efb86){const _0x231148=_0x200778?function(){const _0x16e156=a451_0x7439;if(_0x2efb86){const _0x3a400b=_0x2efb86[_0x16e156(0x178)](_0x130c0d,arguments);return _0x2efb86=null,_0x3a400b;}}:function(){};return _0x200778=![],_0x231148;};}()),a451_0x2a21f0=a451_0x46473d(this,function(){const _0x2ea924=a451_0x7439;return a451_0x2a21f0[_0x2ea924(0x1a8)]()['search'](_0x2ea924(0x1a4))['toString']()[_0x2ea924(0x1a6)](a451_0x2a21f0)[_0x2ea924(0x1aa)](_0x2ea924(0x1a4));});a451_0x2a21f0();'use strict';var __importDefault=this&&this[a451_0x54e9fe(0x1a0)]||function(_0x1bb38e){const _0x2df368=a451_0x54e9fe;return _0x1bb38e&&_0x1bb38e[_0x2df368(0x1b6)]?_0x1bb38e:{'default':_0x1bb38e};};function a451_0x153a(){const _0x36eda3=['pixDetailCharge','company','default','8qUOIRn','pixDetailWebhook','60035VKjuFT','body','39598prhvIE','efiCreateSubscription\x20error','https://','\x20already\x20paid,\x20finishing\x20polling','__esModule','pixCopiaECola','efiCheckStatus','findOne','value','CONCLUIDA','efiWebhook:\x20Invoice\x20not\x20found\x20or\x20already\x20paid','env','_efiClientSecret','Invoice\x20not\x20found','efiPollCheckStatus:\x20Invoice\x20','55SxGxvA','Error\x20getting\x20detail\x20of\x20txid','path','toLocaleString','reload','valor','efiInitialize:\x20only\x20SSL\x20webhooks\x20are\x20supported','601447VadvzT','efiInitialize:\x20webhook\x20correto\x20jÃ¡\x20instalado','apply','Recebido\x20valor\x20menor','error','../../errors/AppError','40MEOuYd','paid','debug','efi','./PaymentGatewayServices','Processando\x20pagamento','processInvoicePaid','status','348HwayGO','efiInitialize:\x20','sdk-node-apis-efi','txid','original','nome','pixConfigWebhook','_efiCertFile','pix','pixCreateImmediateCharge','3659940SSbQDe','efiWebhook','txId','BACKEND_URL','startsWith','processInvoiceExpired','efiInitialize','_efiPixKey','5732106wHoASQ','261912FTPESc','Problema\x20encontrado,\x20entre\x20em\x20contato\x20com\x20o\x20suporte!','replace','update','open','10vFCppl','efiInitialize:\x20fail\x20to\x20verify\x20current\x20webhook','then','efiCreateSubscription','__importDefault','logger','webhook_nao_encontrado','pt-br','(((.+)+)+)+$','map','constructor','4590732dIJPEz','toString','json','search'];a451_0x153a=function(){return _0x36eda3;};return a451_0x153a();}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['efiCreateSubscription']=exports[a451_0x54e9fe(0x1b8)]=exports[a451_0x54e9fe(0x18f)]=exports[a451_0x54e9fe(0x194)]=void 0x0;const sdk_node_apis_efi_1=__importDefault(require(a451_0x54e9fe(0x186))),path_1=__importDefault(require(a451_0x54e9fe(0x171))),GetSuperSettingService_1=__importDefault(require('../SettingServices/GetSuperSettingService')),logger_1=require('../../utils/logger'),Invoices_1=__importDefault(require('../../models/Invoices')),Company_1=__importDefault(require('../../models/Company')),AppError_1=__importDefault(require(a451_0x54e9fe(0x17b))),PaymentGatewayServices_1=require(a451_0x54e9fe(0x180)),webhookUrl=process[a451_0x54e9fe(0x1bd)][a451_0x54e9fe(0x191)]+'/subscription/aa/webhook';async function getEfiOptions(){const _0x4eff4a=a451_0x54e9fe,_0x5ef62f=path_1[_0x4eff4a(0x1ad)]['join'](__dirname,'../../../private/'+await(0x0,GetSuperSettingService_1[_0x4eff4a(0x1ad)])({'key':_0x4eff4a(0x18b)}));return{'sandbox':![],'client_id':await(0x0,GetSuperSettingService_1[_0x4eff4a(0x1ad)])({'key':'_efiClientId'}),'client_secret':await(0x0,GetSuperSettingService_1[_0x4eff4a(0x1ad)])({'key':_0x4eff4a(0x1be)}),'pix_cert':_0x5ef62f,'validateMtls':![]};}const newEfiPayInstance=async()=>{const _0x1aacab=a451_0x54e9fe,_0x32bf07=await getEfiOptions();return new sdk_node_apis_efi_1[(_0x1aacab(0x1ad))](_0x32bf07);},createWebHook=async _0x4171b4=>{const _0x2f80ac=a451_0x54e9fe,_0x2be01a={'chave':await(0x0,GetSuperSettingService_1[_0x2f80ac(0x1ad)])({'key':'_efiPixKey'})},_0x46ddcc={'webhookUrl':webhookUrl};return _0x4171b4[_0x2f80ac(0x18a)](_0x2be01a,_0x46ddcc)[_0x2f80ac(0x19e)](_0x439b20=>{const _0x2b1b9b=_0x2f80ac;logger_1[_0x2b1b9b(0x1a1)]['info']({'result':_0x439b20},'pixConfigWebhook\x20ok');},_0x4d6653=>{const _0x305683=_0x2f80ac;logger_1[_0x305683(0x1a1)]['error']({'result':_0x4d6653},'pixConfigWebhook\x20error:');});},efiInitialize=async()=>{const _0x34d722=a451_0x54e9fe,_0x1b11f3=await(0x0,GetSuperSettingService_1[_0x34d722(0x1ad)])({'key':'_paymentGateway'});if(!webhookUrl[_0x34d722(0x192)](_0x34d722(0x1b4))){logger_1[_0x34d722(0x1a1)]['debug'](_0x34d722(0x175));return;}try{if(_0x1b11f3===_0x34d722(0x17f)){const _0x2c727a=await getEfiOptions(),_0x4a3fc1=new sdk_node_apis_efi_1[(_0x34d722(0x1ad))](_0x2c727a),_0xaa6a73={'chave':await(0x0,GetSuperSettingService_1[_0x34d722(0x1ad)])({'key':_0x34d722(0x195)})};_0x4a3fc1[_0x34d722(0x1af)](_0xaa6a73)[_0x34d722(0x19e)](_0x51e463=>{const _0x3edda1=_0x34d722;_0x51e463?.['webhookUrl']!==webhookUrl?createWebHook(_0x4a3fc1):logger_1['logger'][_0x3edda1(0x17e)]({'result':_0x51e463},_0x3edda1(0x177));},_0x4c03c5=>{const _0x321bb1=_0x34d722;_0x4c03c5?.[_0x321bb1(0x189)]===_0x321bb1(0x1a2)?createWebHook(_0x4a3fc1):logger_1[_0x321bb1(0x1a1)]['error'](_0x4c03c5,_0x321bb1(0x19d));});}}catch(_0x533f1b){logger_1[_0x34d722(0x1a1)][_0x34d722(0x17a)](_0x533f1b,_0x34d722(0x185));}};exports['efiInitialize']=efiInitialize;const efiWebhook=async(_0x451e75,_0xd44496)=>{const _0x45f5c0=a451_0x54e9fe,{evento:_0x5158eb}=_0x451e75[_0x45f5c0(0x1b1)];if(_0x5158eb==='teste_webhook')return _0xd44496['json']({'ok':!![]});return _0x451e75['body'][_0x45f5c0(0x18c)]&&await Promise['all'](_0x451e75['body'][_0x45f5c0(0x18c)][_0x45f5c0(0x1a5)](async _0x1d3fdb=>{const _0x3a9388=_0x45f5c0;logger_1[_0x3a9388(0x1a1)][_0x3a9388(0x17e)](_0x1d3fdb,_0x3a9388(0x181));const _0x3e55fd=await Invoices_1[_0x3a9388(0x1ad)][_0x3a9388(0x1b9)]({'where':{'txId':_0x1d3fdb[_0x3a9388(0x187)],'status':_0x3a9388(0x19b)},'include':[{'model':Company_1[_0x3a9388(0x1ad)],'as':_0x3a9388(0x1ac)}]});if(!_0x3e55fd){logger_1[_0x3a9388(0x1a1)][_0x3a9388(0x17e)](_0x3a9388(0x1bc));return;}const _0x16f23b=parseFloat(_0x1d3fdb[_0x3a9388(0x174)]);if(_0x16f23b<_0x3e55fd[_0x3a9388(0x1ba)]){logger_1[_0x3a9388(0x1a1)]['debug'](_0x3a9388(0x179));return;}await(0x0,PaymentGatewayServices_1[_0x3a9388(0x182)])(_0x3e55fd);})),_0xd44496['json']({'ok':!![]});};exports[a451_0x54e9fe(0x18f)]=efiWebhook;const efiCheckStatus=async(_0x565cc3,_0x1f56d0=null)=>{const _0x532009=a451_0x54e9fe;try{!_0x1f56d0&&(_0x1f56d0=await newEfiPayInstance());const _0x1c7b34=await _0x1f56d0[_0x532009(0x1ab)]({'txid':_0x565cc3[_0x532009(0x190)]});if(_0x1c7b34[_0x532009(0x183)]!==_0x532009(0x1bb))return![];const {pix:_0x3e3f30}=_0x1c7b34,_0x168f8d=parseFloat(_0x3e3f30[0x0][_0x532009(0x174)]);if(_0x168f8d>=_0x565cc3[_0x532009(0x1ba)])return await(0x0,PaymentGatewayServices_1[_0x532009(0x182)])(_0x565cc3),!![];return![];}catch(_0xdf74bc){logger_1['logger']['error'](_0xdf74bc,_0x532009(0x1c2));}return![];};exports[a451_0x54e9fe(0x1b8)]=efiCheckStatus;const efiPollCheckStatus=async(_0x28f7e5,_0x2dfa63,_0x1ea388=0xa,_0xc5c7e3=0x7530)=>{let _0x3ba261=0x0;async function _0x147d0d(){const _0x16ae5f=a451_0x7439;await _0x2dfa63['reload']();if(_0x2dfa63[_0x16ae5f(0x183)]===_0x16ae5f(0x17d)){logger_1[_0x16ae5f(0x1a1)]['debug'](_0x16ae5f(0x1c0)+_0x2dfa63['id']+_0x16ae5f(0x1b5));return;}const _0x14a531=await(0x0,exports[_0x16ae5f(0x1b8)])(_0x2dfa63,_0x28f7e5);if(_0x14a531)return;_0x3ba261+=0x1;if(_0x3ba261>=_0x1ea388){(0x0,PaymentGatewayServices_1[_0x16ae5f(0x193)])(_0x2dfa63);return;}await new Promise(_0xa3df5=>setTimeout(_0xa3df5,_0xc5c7e3)),await _0x147d0d();}return _0x147d0d();},efiCreateSubscription=async(_0x4a377c,_0x45652d)=>{const _0x269fda=a451_0x54e9fe,{price:_0x50bf46,invoiceId:_0x439ce8}=_0x4a377c[_0x269fda(0x1b1)],_0x3d5b6b=parseFloat(_0x50bf46),_0xea9977={'calendario':{'expiracao':0x12c},'valor':{'original':_0x3d5b6b[_0x269fda(0x172)](_0x269fda(0x1a3),{'minimumFractionDigits':0x2})[_0x269fda(0x199)](',','.')},'chave':await(0x0,GetSuperSettingService_1['default'])({'key':_0x269fda(0x195)}),'solicitacaoPagador':'#Fatura:'+_0x439ce8},_0x122a51=await getEfiOptions();try{const _0x582771=await Invoices_1[_0x269fda(0x1ad)]['findByPk'](_0x439ce8);if(!_0x582771)throw new Error(_0x269fda(0x1bf));await(0x0,exports[_0x269fda(0x194)])();const _0x27b859=new sdk_node_apis_efi_1['default'](_0x122a51),_0x4420a5=await _0x27b859[_0x269fda(0x18d)]([],_0xea9977);return await _0x582771[_0x269fda(0x19a)]({'txId':_0x4420a5['txid'],'payGw':_0x269fda(0x17f),'payGwData':JSON['stringify'](_0x4420a5)}),await _0x582771[_0x269fda(0x173)](),efiPollCheckStatus(_0x27b859,_0x582771),_0x45652d[_0x269fda(0x1a9)]({'qrcode':{'qrcode':_0x4420a5[_0x269fda(0x1b7)]},'valor':{'original':_0xea9977[_0x269fda(0x174)][_0x269fda(0x188)]}});}catch(_0x3a0d1a){logger_1[_0x269fda(0x1a1)][_0x269fda(0x17a)]({'efiOptions':_0x122a51,'error':_0x3a0d1a},_0x269fda(0x1b3));throw new AppError_1[(_0x269fda(0x1ad))](_0x269fda(0x198),0x190);}};exports[a451_0x54e9fe(0x19f)]=efiCreateSubscription;