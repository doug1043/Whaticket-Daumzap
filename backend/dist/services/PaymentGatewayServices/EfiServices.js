const a483_0x558cf7=a483_0x33bc;function a483_0x33bc(_0xe06d3d,_0x54c4d2){const _0x9929ad=a483_0x5404();return a483_0x33bc=function(_0x34c832,_0x3ee21d){_0x34c832=_0x34c832-0x13b;let _0x54046e=_0x9929ad[_0x34c832];return _0x54046e;},a483_0x33bc(_0xe06d3d,_0x54c4d2);}(function(_0x2c8cb8,_0x390704){const _0x446879=a483_0x33bc,_0x5b5f0e=_0x2c8cb8();while(!![]){try{const _0x321cf=-parseInt(_0x446879(0x145))/0x1*(-parseInt(_0x446879(0x181))/0x2)+-parseInt(_0x446879(0x156))/0x3+parseInt(_0x446879(0x171))/0x4*(parseInt(_0x446879(0x154))/0x5)+-parseInt(_0x446879(0x155))/0x6*(parseInt(_0x446879(0x14c))/0x7)+-parseInt(_0x446879(0x163))/0x8+-parseInt(_0x446879(0x150))/0x9*(parseInt(_0x446879(0x159))/0xa)+-parseInt(_0x446879(0x179))/0xb*(-parseInt(_0x446879(0x16a))/0xc);if(_0x321cf===_0x390704)break;else _0x5b5f0e['push'](_0x5b5f0e['shift']());}catch(_0x181bc5){_0x5b5f0e['push'](_0x5b5f0e['shift']());}}}(a483_0x5404,0x4fccc));const a483_0x3ee21d=(function(){let _0x57b778=!![];return function(_0x2b9f85,_0x14b0ea){const _0x1676a8=_0x57b778?function(){if(_0x14b0ea){const _0x55e9ed=_0x14b0ea['apply'](_0x2b9f85,arguments);return _0x14b0ea=null,_0x55e9ed;}}:function(){};return _0x57b778=![],_0x1676a8;};}()),a483_0x34c832=a483_0x3ee21d(this,function(){const _0x3799ad=a483_0x33bc;return a483_0x34c832['toString']()[_0x3799ad(0x143)](_0x3799ad(0x164))[_0x3799ad(0x151)]()['constructor'](a483_0x34c832)[_0x3799ad(0x143)](_0x3799ad(0x164));});a483_0x34c832();'use strict';function a483_0x5404(){const _0x3a6958=['findByPk','all','join','webhook_nao_encontrado','update','efiPollCheckStatus:\x20Invoice\x20','49XVOSRq','pixCreateImmediateCharge','value','efi','9gIxgqO','toString','Problema\x20encontrado,\x20entre\x20em\x20contato\x20com\x20o\x20suporte!','defineProperty','375VovWxw','11082ToKoLF','1016697DmuLlM','error','../../errors/AppError','5732390mhqqgd','/subscription/aa/webhook','valor','../SettingServices/GetSuperSettingService','Error\x20getting\x20detail\x20of\x20txid','efiCheckStatus','__esModule','nome','map','efiCreateSubscription','4085328skSnBU','(((.+)+)+)+$','stringify','BACKEND_URL','efiInitialize','open','_efiClientId','1475220iUvEGi','processInvoiceExpired','../../models/Company','reload','#Fatura:','pixCopiaECola','efiInitialize:\x20webhook\x20correto\x20jÃ¡\x20instalado','23568TimXMS','efiWebhook','status','logger','pixDetailWebhook','processInvoicePaid','pix','https://','77klcrxd','paid','toLocaleString','_efiClientSecret','json','txId','txid','efiWebhook:\x20Invoice\x20not\x20found\x20or\x20already\x20paid','230074caAvtd','body','teste_webhook','original','../../utils/logger','Recebido\x20valor\x20menor','env','Invoice\x20not\x20found','Processando\x20pagamento','debug','info','efiInitialize:\x20fail\x20to\x20verify\x20current\x20webhook','default','__importDefault','_efiPixKey','search','webhookUrl','4AMZHdd'];a483_0x5404=function(){return _0x3a6958;};return a483_0x5404();}var __importDefault=this&&this[a483_0x558cf7(0x141)]||function(_0x16ccb7){return _0x16ccb7&&_0x16ccb7['__esModule']?_0x16ccb7:{'default':_0x16ccb7};};Object[a483_0x558cf7(0x153)](exports,a483_0x558cf7(0x15f),{'value':!![]}),exports[a483_0x558cf7(0x162)]=exports['efiCheckStatus']=exports[a483_0x558cf7(0x172)]=exports[a483_0x558cf7(0x167)]=void 0x0;const sdk_node_apis_efi_1=__importDefault(require('sdk-node-apis-efi')),path_1=__importDefault(require('path')),GetSuperSettingService_1=__importDefault(require(a483_0x558cf7(0x15c))),logger_1=require(a483_0x558cf7(0x185)),Invoices_1=__importDefault(require('../../models/Invoices')),Company_1=__importDefault(require(a483_0x558cf7(0x16c))),AppError_1=__importDefault(require(a483_0x558cf7(0x158))),PaymentGatewayServices_1=require('./PaymentGatewayServices'),webhookUrl=process[a483_0x558cf7(0x187)][a483_0x558cf7(0x166)]+a483_0x558cf7(0x15a);async function getEfiOptions(){const _0x306d58=a483_0x558cf7,_0x2d37df=path_1['default'][_0x306d58(0x148)](__dirname,'../../../private/'+await(0x0,GetSuperSettingService_1[_0x306d58(0x140)])({'key':'_efiCertFile'}));return{'sandbox':![],'client_id':await(0x0,GetSuperSettingService_1['default'])({'key':_0x306d58(0x169)}),'client_secret':await(0x0,GetSuperSettingService_1['default'])({'key':_0x306d58(0x17c)}),'pix_cert':_0x2d37df,'validateMtls':![]};}const newEfiPayInstance=async()=>{const _0x1dee48=a483_0x558cf7,_0x198764=await getEfiOptions();return new sdk_node_apis_efi_1[(_0x1dee48(0x140))](_0x198764);},createWebHook=async _0x2178d9=>{const _0x2a3ae7=a483_0x558cf7,_0x5d630c={'chave':await(0x0,GetSuperSettingService_1[_0x2a3ae7(0x140)])({'key':_0x2a3ae7(0x142)})},_0x592439={'webhookUrl':webhookUrl};return _0x2178d9['pixConfigWebhook'](_0x5d630c,_0x592439)['then'](_0x2834c6=>{const _0x7c4bd1=_0x2a3ae7;logger_1['logger'][_0x7c4bd1(0x13e)]({'result':_0x2834c6},'pixConfigWebhook\x20ok');},_0x3a5ad4=>{const _0x5ebcc3=_0x2a3ae7;logger_1['logger'][_0x5ebcc3(0x157)]({'result':_0x3a5ad4},'pixConfigWebhook\x20error:');});},efiInitialize=async()=>{const _0x3fec4f=a483_0x558cf7,_0x1155a4=await(0x0,GetSuperSettingService_1[_0x3fec4f(0x140)])({'key':'_paymentGateway'});if(!webhookUrl['startsWith'](_0x3fec4f(0x178))){logger_1['logger']['debug']('efiInitialize:\x20only\x20SSL\x20webhooks\x20are\x20supported');return;}try{if(_0x1155a4===_0x3fec4f(0x14f)){const _0x4d63ea=await getEfiOptions(),_0x8c7ad3=new sdk_node_apis_efi_1[(_0x3fec4f(0x140))](_0x4d63ea),_0x2976b0={'chave':await(0x0,GetSuperSettingService_1[_0x3fec4f(0x140)])({'key':_0x3fec4f(0x142)})};_0x8c7ad3[_0x3fec4f(0x175)](_0x2976b0)['then'](_0xfd0627=>{const _0x205f77=_0x3fec4f;_0xfd0627?.[_0x205f77(0x144)]!==webhookUrl?createWebHook(_0x8c7ad3):logger_1[_0x205f77(0x174)][_0x205f77(0x13d)]({'result':_0xfd0627},_0x205f77(0x170));},_0x433cf4=>{const _0x4c597d=_0x3fec4f;_0x433cf4?.[_0x4c597d(0x160)]===_0x4c597d(0x149)?createWebHook(_0x8c7ad3):logger_1[_0x4c597d(0x174)][_0x4c597d(0x157)](_0x433cf4,_0x4c597d(0x13f));});}}catch(_0x49a2b){logger_1[_0x3fec4f(0x174)][_0x3fec4f(0x157)](_0x49a2b,'efiInitialize:\x20');}};exports[a483_0x558cf7(0x167)]=efiInitialize;const efiWebhook=async(_0x49abec,_0x5c1b1f)=>{const _0x51a617=a483_0x558cf7,{evento:_0x253927}=_0x49abec['body'];if(_0x253927===_0x51a617(0x183))return _0x5c1b1f['json']({'ok':!![]});return _0x49abec['body'][_0x51a617(0x177)]&&await Promise[_0x51a617(0x147)](_0x49abec['body'][_0x51a617(0x177)][_0x51a617(0x161)](async _0x503149=>{const _0x163a86=_0x51a617;logger_1[_0x163a86(0x174)][_0x163a86(0x13d)](_0x503149,_0x163a86(0x13c));const _0x258425=await Invoices_1['default']['findOne']({'where':{'txId':_0x503149[_0x163a86(0x17f)],'status':_0x163a86(0x168)},'include':[{'model':Company_1[_0x163a86(0x140)],'as':'company'}]});if(!_0x258425){logger_1[_0x163a86(0x174)][_0x163a86(0x13d)](_0x163a86(0x180));return;}const _0x255de3=parseFloat(_0x503149[_0x163a86(0x15b)]);if(_0x255de3<_0x258425[_0x163a86(0x14e)]){logger_1[_0x163a86(0x174)]['debug'](_0x163a86(0x186));return;}await(0x0,PaymentGatewayServices_1[_0x163a86(0x176)])(_0x258425);})),_0x5c1b1f['json']({'ok':!![]});};exports[a483_0x558cf7(0x172)]=efiWebhook;const efiCheckStatus=async(_0x494d09,_0x41088e=null)=>{const _0x160c1e=a483_0x558cf7;try{!_0x41088e&&(_0x41088e=await newEfiPayInstance());const _0x1ae62c=await _0x41088e['pixDetailCharge']({'txid':_0x494d09[_0x160c1e(0x17e)]});if(_0x1ae62c[_0x160c1e(0x173)]!=='CONCLUIDA')return![];const {pix:_0x3ffb02}=_0x1ae62c,_0x352bee=parseFloat(_0x3ffb02[0x0][_0x160c1e(0x15b)]);if(_0x352bee>=_0x494d09[_0x160c1e(0x14e)])return await(0x0,PaymentGatewayServices_1[_0x160c1e(0x176)])(_0x494d09),!![];return![];}catch(_0x18af7b){logger_1[_0x160c1e(0x174)][_0x160c1e(0x157)](_0x18af7b,_0x160c1e(0x15d));}return![];};exports['efiCheckStatus']=efiCheckStatus;const efiPollCheckStatus=async(_0x228820,_0x3324f8,_0x453d4d=0xa,_0x4d3af0=0x7530)=>{let _0x2a5283=0x0;async function _0x152a47(){const _0x4f1e1f=a483_0x33bc;await _0x3324f8[_0x4f1e1f(0x16d)]();if(_0x3324f8['status']===_0x4f1e1f(0x17a)){logger_1[_0x4f1e1f(0x174)][_0x4f1e1f(0x13d)](_0x4f1e1f(0x14b)+_0x3324f8['id']+'\x20already\x20paid,\x20finishing\x20polling');return;}const _0x49b395=await(0x0,exports[_0x4f1e1f(0x15e)])(_0x3324f8,_0x228820);if(_0x49b395)return;_0x2a5283+=0x1;if(_0x2a5283>=_0x453d4d){(0x0,PaymentGatewayServices_1[_0x4f1e1f(0x16b)])(_0x3324f8);return;}await new Promise(_0xc03890=>setTimeout(_0xc03890,_0x4d3af0)),await _0x152a47();}return _0x152a47();},efiCreateSubscription=async(_0x48b5df,_0x316c0f)=>{const _0x2a558f=a483_0x558cf7,{price:_0x1b3dbc,invoiceId:_0x169776}=_0x48b5df[_0x2a558f(0x182)],_0x24ae84=parseFloat(_0x1b3dbc),_0x556715={'calendario':{'expiracao':0x12c},'valor':{'original':_0x24ae84[_0x2a558f(0x17b)]('pt-br',{'minimumFractionDigits':0x2})['replace'](',','.')},'chave':await(0x0,GetSuperSettingService_1[_0x2a558f(0x140)])({'key':_0x2a558f(0x142)}),'solicitacaoPagador':_0x2a558f(0x16e)+_0x169776},_0x2c11e7=await getEfiOptions();try{const _0x4cb7d7=await Invoices_1[_0x2a558f(0x140)][_0x2a558f(0x146)](_0x169776);if(!_0x4cb7d7)throw new Error(_0x2a558f(0x13b));await(0x0,exports[_0x2a558f(0x167)])();const _0x416dcc=new sdk_node_apis_efi_1[(_0x2a558f(0x140))](_0x2c11e7),_0x156f89=await _0x416dcc[_0x2a558f(0x14d)]([],_0x556715);return await _0x4cb7d7[_0x2a558f(0x14a)]({'txId':_0x156f89[_0x2a558f(0x17f)],'payGw':_0x2a558f(0x14f),'payGwData':JSON[_0x2a558f(0x165)](_0x156f89)}),await _0x4cb7d7['reload'](),efiPollCheckStatus(_0x416dcc,_0x4cb7d7),_0x316c0f[_0x2a558f(0x17d)]({'qrcode':{'qrcode':_0x156f89[_0x2a558f(0x16f)]},'valor':{'original':_0x556715[_0x2a558f(0x15b)][_0x2a558f(0x184)]}});}catch(_0x7bfed3){logger_1['logger'][_0x2a558f(0x157)]({'efiOptions':_0x2c11e7,'error':_0x7bfed3},'efiCreateSubscription\x20error');throw new AppError_1[(_0x2a558f(0x140))](_0x2a558f(0x152),0x190);}};exports[a483_0x558cf7(0x162)]=efiCreateSubscription;