const a486_0x17ef70=a486_0x5506;function a486_0x3d4a(){const _0x2d531f=['all','pixCreateImmediateCharge','__importDefault','error','txid','pixDetailWebhook','pixConfigWebhook\x20ok','then','../SettingServices/GetSuperSettingService','debug','efiWebhook','#Fatura:','value','_efiClientSecret','102535ZXGPvy','10DARPMy','info','update','valor','_efiPixKey','../../utils/logger','replace','pt-br','efiInitialize:\x20','\x20already\x20paid,\x20finishing\x20polling','efiInitialize:\x20webhook\x20correto\x20jÃ¡\x20instalado','./PaymentGatewayServices','https://','8653275kjSMOF','pixConfigWebhook\x20error:','(((.+)+)+)+$','_efiClientId','efi','body','map','efiCheckStatus','Recebido\x20valor\x20menor','logger','1213716flBQIy','460546aybJGn','CONCLUIDA','efiCreateSubscription','efiWebhook:\x20Invoice\x20not\x20found\x20or\x20already\x20paid','paid','findByPk','stringify','original','default','Invoice\x20not\x20found','path','__esModule','935720DvPAHY','reload','defineProperty','6RJmKxL','efiInitialize','join','424131MtHTtm','efiInitialize:\x20fail\x20to\x20verify\x20current\x20webhook','../../../private/','processInvoicePaid','96CcoBca','../../models/Company','Processando\x20pagamento','env','_efiCertFile','efiInitialize:\x20only\x20SSL\x20webhooks\x20are\x20supported','/subscription/aa/webhook','efiPollCheckStatus:\x20Invoice\x20','search','status','company','BACKEND_URL','teste_webhook','pix','../../models/Invoices','2126696XLudoo','pixConfigWebhook','sdk-node-apis-efi','json','constructor','pixDetailCharge'];a486_0x3d4a=function(){return _0x2d531f;};return a486_0x3d4a();}(function(_0x32b21e,_0x4b1007){const _0x27803e=a486_0x5506,_0x493eaf=_0x32b21e();while(!![]){try{const _0x2e2e69=parseInt(_0x27803e(0x1ec))/0x1+-parseInt(_0x27803e(0x1fb))/0x2*(-parseInt(_0x27803e(0x1fe))/0x3)+parseInt(_0x27803e(0x1f8))/0x4+parseInt(_0x27803e(0x1d3))/0x5*(-parseInt(_0x27803e(0x202))/0x6)+parseInt(_0x27803e(0x1eb))/0x7+parseInt(_0x27803e(0x211))/0x8+parseInt(_0x27803e(0x1e1))/0x9*(-parseInt(_0x27803e(0x1d4))/0xa);if(_0x2e2e69===_0x4b1007)break;else _0x493eaf['push'](_0x493eaf['shift']());}catch(_0x34c8c1){_0x493eaf['push'](_0x493eaf['shift']());}}}(a486_0x3d4a,0x417d5));const a486_0x4defa4=(function(){let _0x4747d8=!![];return function(_0x3b6988,_0x3c2b93){const _0x52f041=_0x4747d8?function(){if(_0x3c2b93){const _0x12460e=_0x3c2b93['apply'](_0x3b6988,arguments);return _0x3c2b93=null,_0x12460e;}}:function(){};return _0x4747d8=![],_0x52f041;};}()),a486_0x547441=a486_0x4defa4(this,function(){const _0x231af3=a486_0x5506;return a486_0x547441['toString']()[_0x231af3(0x20a)](_0x231af3(0x1e3))['toString']()[_0x231af3(0x1c3)](a486_0x547441)[_0x231af3(0x20a)](_0x231af3(0x1e3));});a486_0x547441();'use strict';var __importDefault=this&&this[a486_0x17ef70(0x1c7)]||function(_0x40f50c){const _0x4bcf53=a486_0x17ef70;return _0x40f50c&&_0x40f50c[_0x4bcf53(0x1f7)]?_0x40f50c:{'default':_0x40f50c};};Object[a486_0x17ef70(0x1fa)](exports,'__esModule',{'value':!![]}),exports[a486_0x17ef70(0x1ee)]=exports['efiCheckStatus']=exports[a486_0x17ef70(0x1cf)]=exports[a486_0x17ef70(0x1fc)]=void 0x0;const sdk_node_apis_efi_1=__importDefault(require(a486_0x17ef70(0x213))),path_1=__importDefault(require(a486_0x17ef70(0x1f6))),GetSuperSettingService_1=__importDefault(require(a486_0x17ef70(0x1cd))),logger_1=require(a486_0x17ef70(0x1d9)),Invoices_1=__importDefault(require(a486_0x17ef70(0x210))),Company_1=__importDefault(require(a486_0x17ef70(0x203))),AppError_1=__importDefault(require('../../errors/AppError')),PaymentGatewayServices_1=require(a486_0x17ef70(0x1df)),webhookUrl=process[a486_0x17ef70(0x205)][a486_0x17ef70(0x20d)]+a486_0x17ef70(0x208);async function getEfiOptions(){const _0x4f9cdc=a486_0x17ef70,_0x50a205=path_1[_0x4f9cdc(0x1f4)][_0x4f9cdc(0x1fd)](__dirname,_0x4f9cdc(0x200)+await(0x0,GetSuperSettingService_1[_0x4f9cdc(0x1f4)])({'key':_0x4f9cdc(0x206)}));return{'sandbox':![],'client_id':await(0x0,GetSuperSettingService_1[_0x4f9cdc(0x1f4)])({'key':_0x4f9cdc(0x1e4)}),'client_secret':await(0x0,GetSuperSettingService_1[_0x4f9cdc(0x1f4)])({'key':_0x4f9cdc(0x1d2)}),'pix_cert':_0x50a205,'validateMtls':![]};}const newEfiPayInstance=async()=>{const _0x14e876=await getEfiOptions();return new sdk_node_apis_efi_1['default'](_0x14e876);},createWebHook=async _0x554568=>{const _0x17819d=a486_0x17ef70,_0x290ba4={'chave':await(0x0,GetSuperSettingService_1['default'])({'key':_0x17819d(0x1d8)})},_0xbf358b={'webhookUrl':webhookUrl};return _0x554568[_0x17819d(0x212)](_0x290ba4,_0xbf358b)[_0x17819d(0x1cc)](_0x4b4375=>{const _0x352957=_0x17819d;logger_1[_0x352957(0x1ea)][_0x352957(0x1d5)]({'result':_0x4b4375},_0x352957(0x1cb));},_0x526525=>{const _0x3aa8ba=_0x17819d;logger_1[_0x3aa8ba(0x1ea)][_0x3aa8ba(0x1c8)]({'result':_0x526525},_0x3aa8ba(0x1e2));});},efiInitialize=async()=>{const _0x22d2dd=a486_0x17ef70,_0x22761e=await(0x0,GetSuperSettingService_1[_0x22d2dd(0x1f4)])({'key':'_paymentGateway'});if(!webhookUrl['startsWith'](_0x22d2dd(0x1e0))){logger_1[_0x22d2dd(0x1ea)][_0x22d2dd(0x1ce)](_0x22d2dd(0x207));return;}try{if(_0x22761e==='efi'){const _0x42941d=await getEfiOptions(),_0x219135=new sdk_node_apis_efi_1['default'](_0x42941d),_0x584cfc={'chave':await(0x0,GetSuperSettingService_1[_0x22d2dd(0x1f4)])({'key':_0x22d2dd(0x1d8)})};_0x219135[_0x22d2dd(0x1ca)](_0x584cfc)[_0x22d2dd(0x1cc)](_0x45ffb5=>{const _0x1c2622=_0x22d2dd;_0x45ffb5?.['webhookUrl']!==webhookUrl?createWebHook(_0x219135):logger_1[_0x1c2622(0x1ea)][_0x1c2622(0x1ce)]({'result':_0x45ffb5},_0x1c2622(0x1de));},_0x2e7eaf=>{const _0x724a68=_0x22d2dd;_0x2e7eaf?.['nome']==='webhook_nao_encontrado'?createWebHook(_0x219135):logger_1[_0x724a68(0x1ea)][_0x724a68(0x1c8)](_0x2e7eaf,_0x724a68(0x1ff));});}}catch(_0x4e9714){logger_1[_0x22d2dd(0x1ea)]['error'](_0x4e9714,_0x22d2dd(0x1dc));}};function a486_0x5506(_0x209004,_0x4ee55d){const _0x327569=a486_0x3d4a();return a486_0x5506=function(_0x547441,_0x4defa4){_0x547441=_0x547441-0x1c3;let _0x3d4a1a=_0x327569[_0x547441];return _0x3d4a1a;},a486_0x5506(_0x209004,_0x4ee55d);}exports[a486_0x17ef70(0x1fc)]=efiInitialize;const efiWebhook=async(_0x56cdec,_0x5c22d9)=>{const _0x149897=a486_0x17ef70,{evento:_0x19394a}=_0x56cdec[_0x149897(0x1e6)];if(_0x19394a===_0x149897(0x20e))return _0x5c22d9[_0x149897(0x214)]({'ok':!![]});return _0x56cdec[_0x149897(0x1e6)][_0x149897(0x20f)]&&await Promise[_0x149897(0x1c5)](_0x56cdec['body'][_0x149897(0x20f)][_0x149897(0x1e7)](async _0x1c3ef4=>{const _0x11bc20=_0x149897;logger_1[_0x11bc20(0x1ea)]['debug'](_0x1c3ef4,_0x11bc20(0x204));const _0x238ff2=await Invoices_1[_0x11bc20(0x1f4)]['findOne']({'where':{'txId':_0x1c3ef4[_0x11bc20(0x1c9)],'status':'open'},'include':[{'model':Company_1[_0x11bc20(0x1f4)],'as':_0x11bc20(0x20c)}]});if(!_0x238ff2){logger_1[_0x11bc20(0x1ea)][_0x11bc20(0x1ce)](_0x11bc20(0x1ef));return;}const _0x27eee8=parseFloat(_0x1c3ef4[_0x11bc20(0x1d7)]);if(_0x27eee8<_0x238ff2[_0x11bc20(0x1d1)]){logger_1[_0x11bc20(0x1ea)][_0x11bc20(0x1ce)](_0x11bc20(0x1e9));return;}await(0x0,PaymentGatewayServices_1[_0x11bc20(0x201)])(_0x238ff2);})),_0x5c22d9[_0x149897(0x214)]({'ok':!![]});};exports['efiWebhook']=efiWebhook;const efiCheckStatus=async(_0x3a60fe,_0x48fc34=null)=>{const _0x158ffb=a486_0x17ef70;try{!_0x48fc34&&(_0x48fc34=await newEfiPayInstance());const _0x4a7f43=await _0x48fc34[_0x158ffb(0x1c4)]({'txid':_0x3a60fe['txId']});if(_0x4a7f43[_0x158ffb(0x20b)]!==_0x158ffb(0x1ed))return![];const {pix:_0x3c8547}=_0x4a7f43,_0x4d8ede=parseFloat(_0x3c8547[0x0][_0x158ffb(0x1d7)]);if(_0x4d8ede>=_0x3a60fe['value'])return await(0x0,PaymentGatewayServices_1[_0x158ffb(0x201)])(_0x3a60fe),!![];return![];}catch(_0x40a2a3){logger_1[_0x158ffb(0x1ea)]['error'](_0x40a2a3,'Error\x20getting\x20detail\x20of\x20txid');}return![];};exports[a486_0x17ef70(0x1e8)]=efiCheckStatus;const efiPollCheckStatus=async(_0x295cbf,_0x3b9be0,_0x248771=0xa,_0x331580=0x7530)=>{let _0x42af56=0x0;async function _0x9c2441(){const _0x427dc=a486_0x5506;await _0x3b9be0[_0x427dc(0x1f9)]();if(_0x3b9be0[_0x427dc(0x20b)]===_0x427dc(0x1f0)){logger_1[_0x427dc(0x1ea)][_0x427dc(0x1ce)](_0x427dc(0x209)+_0x3b9be0['id']+_0x427dc(0x1dd));return;}const _0x47789a=await(0x0,exports[_0x427dc(0x1e8)])(_0x3b9be0,_0x295cbf);if(_0x47789a)return;_0x42af56+=0x1;if(_0x42af56>=_0x248771){(0x0,PaymentGatewayServices_1['processInvoiceExpired'])(_0x3b9be0);return;}await new Promise(_0x5199ff=>setTimeout(_0x5199ff,_0x331580)),await _0x9c2441();}return _0x9c2441();},efiCreateSubscription=async(_0x1a9d38,_0x2b3c3e)=>{const _0x6cf4fd=a486_0x17ef70,{price:_0xa6d90f,invoiceId:_0x5d3b27}=_0x1a9d38['body'],_0x1f2487=parseFloat(_0xa6d90f),_0x5cb720={'calendario':{'expiracao':0x12c},'valor':{'original':_0x1f2487['toLocaleString'](_0x6cf4fd(0x1db),{'minimumFractionDigits':0x2})[_0x6cf4fd(0x1da)](',','.')},'chave':await(0x0,GetSuperSettingService_1[_0x6cf4fd(0x1f4)])({'key':_0x6cf4fd(0x1d8)}),'solicitacaoPagador':_0x6cf4fd(0x1d0)+_0x5d3b27},_0xdb5ddd=await getEfiOptions();try{const _0x17fd3f=await Invoices_1[_0x6cf4fd(0x1f4)][_0x6cf4fd(0x1f1)](_0x5d3b27);if(!_0x17fd3f)throw new Error(_0x6cf4fd(0x1f5));await(0x0,exports[_0x6cf4fd(0x1fc)])();const _0x263951=new sdk_node_apis_efi_1[(_0x6cf4fd(0x1f4))](_0xdb5ddd),_0x388156=await _0x263951[_0x6cf4fd(0x1c6)]([],_0x5cb720);return await _0x17fd3f[_0x6cf4fd(0x1d6)]({'txId':_0x388156['txid'],'payGw':_0x6cf4fd(0x1e5),'payGwData':JSON[_0x6cf4fd(0x1f2)](_0x388156)}),await _0x17fd3f[_0x6cf4fd(0x1f9)](),efiPollCheckStatus(_0x263951,_0x17fd3f),_0x2b3c3e['json']({'qrcode':{'qrcode':_0x388156['pixCopiaECola']},'valor':{'original':_0x5cb720[_0x6cf4fd(0x1d7)][_0x6cf4fd(0x1f3)]}});}catch(_0x2e15eb){logger_1[_0x6cf4fd(0x1ea)][_0x6cf4fd(0x1c8)]({'efiOptions':_0xdb5ddd,'error':_0x2e15eb},'efiCreateSubscription\x20error');throw new AppError_1['default']('Problema\x20encontrado,\x20entre\x20em\x20contato\x20com\x20o\x20suporte!',0x190);}};exports[a486_0x17ef70(0x1ee)]=efiCreateSubscription;