const a486_0x490bb8=a486_0x509e;(function(_0x3bc222,_0x2b7051){const _0x1e0acd=a486_0x509e,_0x2494a9=_0x3bc222();while(!![]){try{const _0x19ad30=-parseInt(_0x1e0acd(0xed))/0x1+-parseInt(_0x1e0acd(0xb7))/0x2*(-parseInt(_0x1e0acd(0xf0))/0x3)+-parseInt(_0x1e0acd(0xb4))/0x4*(-parseInt(_0x1e0acd(0xc8))/0x5)+-parseInt(_0x1e0acd(0xe8))/0x6+-parseInt(_0x1e0acd(0xbf))/0x7+-parseInt(_0x1e0acd(0xe3))/0x8+parseInt(_0x1e0acd(0xce))/0x9*(parseInt(_0x1e0acd(0xb8))/0xa);if(_0x19ad30===_0x2b7051)break;else _0x2494a9['push'](_0x2494a9['shift']());}catch(_0xbdef63){_0x2494a9['push'](_0x2494a9['shift']());}}}(a486_0xc0d4,0xc1c04));const a486_0xa0c7cc=(function(){let _0x201369=!![];return function(_0x5459bb,_0x12b20c){const _0xb3b363=_0x201369?function(){if(_0x12b20c){const _0x3a59b1=_0x12b20c['apply'](_0x5459bb,arguments);return _0x12b20c=null,_0x3a59b1;}}:function(){};return _0x201369=![],_0xb3b363;};}()),a486_0x25b376=a486_0xa0c7cc(this,function(){const _0x1acee6=a486_0x509e;return a486_0x25b376[_0x1acee6(0xd7)]()[_0x1acee6(0xd5)](_0x1acee6(0xdf))[_0x1acee6(0xd7)]()[_0x1acee6(0xd8)](a486_0x25b376)[_0x1acee6(0xd5)]('(((.+)+)+)+$');});a486_0x25b376();'use strict';var __importDefault=this&&this[a486_0x490bb8(0xd9)]||function(_0x3bbfc8){const _0x594d00=a486_0x490bb8;return _0x3bbfc8&&_0x3bbfc8[_0x594d00(0xa4)]?_0x3bbfc8:{'default':_0x3bbfc8};};Object[a486_0x490bb8(0xdd)](exports,a486_0x490bb8(0xa4),{'value':!![]}),exports[a486_0x490bb8(0xc4)]=exports[a486_0x490bb8(0xae)]=exports[a486_0x490bb8(0xb6)]=exports[a486_0x490bb8(0xb0)]=void 0x0;const sdk_node_apis_efi_1=__importDefault(require(a486_0x490bb8(0xf3))),path_1=__importDefault(require(a486_0x490bb8(0xc7))),GetSuperSettingService_1=__importDefault(require('../SettingServices/GetSuperSettingService')),logger_1=require(a486_0x490bb8(0xab)),Invoices_1=__importDefault(require(a486_0x490bb8(0xd6))),Company_1=__importDefault(require(a486_0x490bb8(0xca))),AppError_1=__importDefault(require(a486_0x490bb8(0xd0))),PaymentGatewayServices_1=require(a486_0x490bb8(0xad)),webhookUrl=process[a486_0x490bb8(0xee)][a486_0x490bb8(0xbb)]+a486_0x490bb8(0xe7);async function getEfiOptions(){const _0x27b076=a486_0x490bb8,_0x119b53=path_1[_0x27b076(0xdc)][_0x27b076(0xc1)](__dirname,_0x27b076(0xb9)+await(0x0,GetSuperSettingService_1['default'])({'key':_0x27b076(0xaa)}));return{'sandbox':![],'client_id':await(0x0,GetSuperSettingService_1['default'])({'key':_0x27b076(0xe5)}),'client_secret':await(0x0,GetSuperSettingService_1['default'])({'key':'_efiClientSecret'}),'pix_cert':_0x119b53,'validateMtls':![]};}function a486_0xc0d4(){const _0x504162=['stringify','https://','sdk-node-apis-efi','__esModule','body','valor','reload','pixConfigWebhook\x20error:','Invoice\x20not\x20found','_efiCertFile','../../utils/logger','_efiPixKey','./PaymentGatewayServices','efiCheckStatus','processInvoiceExpired','efiInitialize','debug','Problema\x20encontrado,\x20entre\x20em\x20contato\x20com\x20o\x20suporte!','txid','916iMNilF','original','efiWebhook','10tKnJNR','5480kRGeZo','../../../private/','CONCLUIDA','BACKEND_URL','pixConfigWebhook','findByPk','logger','7299635KVjtkE','webhook_nao_encontrado','join','toLocaleString','then','efiCreateSubscription','error','map','path','2315ayJNEB','Processando\x20pagamento','../../models/Company','efiInitialize:\x20fail\x20to\x20verify\x20current\x20webhook','status','pixCopiaECola','39906bPNZpK','#Fatura:','../../errors/AppError','value','open','findOne','all','search','../../models/Invoices','toString','constructor','__importDefault','efiInitialize:\x20only\x20SSL\x20webhooks\x20are\x20supported','json','default','defineProperty','efiCreateSubscription\x20error','(((.+)+)+)+$','nome','txId','Recebido\x20valor\x20menor','3674600fYfFQa','Error\x20getting\x20detail\x20of\x20txid','_efiClientId','\x20already\x20paid,\x20finishing\x20polling','/subscription/aa/webhook','8013162roeubA','pix','pt-br','efi','info','331358FHgVau','env','update','856056HKbNrA'];a486_0xc0d4=function(){return _0x504162;};return a486_0xc0d4();}const newEfiPayInstance=async()=>{const _0xbbcdf0=await getEfiOptions();return new sdk_node_apis_efi_1['default'](_0xbbcdf0);},createWebHook=async _0x1d597f=>{const _0xa53de0=a486_0x490bb8,_0x107027={'chave':await(0x0,GetSuperSettingService_1[_0xa53de0(0xdc)])({'key':_0xa53de0(0xac)})},_0xe20236={'webhookUrl':webhookUrl};return _0x1d597f[_0xa53de0(0xbc)](_0x107027,_0xe20236)[_0xa53de0(0xc3)](_0x570ff0=>{const _0x517c83=_0xa53de0;logger_1[_0x517c83(0xbe)][_0x517c83(0xec)]({'result':_0x570ff0},'pixConfigWebhook\x20ok');},_0x4b226e=>{const _0x18c33e=_0xa53de0;logger_1['logger'][_0x18c33e(0xc5)]({'result':_0x4b226e},_0x18c33e(0xa8));});},efiInitialize=async()=>{const _0x167679=a486_0x490bb8,_0x5758e3=await(0x0,GetSuperSettingService_1[_0x167679(0xdc)])({'key':'_paymentGateway'});if(!webhookUrl['startsWith'](_0x167679(0xf2))){logger_1['logger']['debug'](_0x167679(0xda));return;}try{if(_0x5758e3===_0x167679(0xeb)){const _0x59eaf2=await getEfiOptions(),_0x5af968=new sdk_node_apis_efi_1[(_0x167679(0xdc))](_0x59eaf2),_0x3cbf2c={'chave':await(0x0,GetSuperSettingService_1[_0x167679(0xdc)])({'key':_0x167679(0xac)})};_0x5af968['pixDetailWebhook'](_0x3cbf2c)[_0x167679(0xc3)](_0x352e8e=>{_0x352e8e?.['webhookUrl']!==webhookUrl?createWebHook(_0x5af968):logger_1['logger']['debug']({'result':_0x352e8e},'efiInitialize:\x20webhook\x20correto\x20jÃ¡\x20instalado');},_0x13f6dc=>{const _0x9e2d3a=_0x167679;_0x13f6dc?.[_0x9e2d3a(0xe0)]===_0x9e2d3a(0xc0)?createWebHook(_0x5af968):logger_1[_0x9e2d3a(0xbe)][_0x9e2d3a(0xc5)](_0x13f6dc,_0x9e2d3a(0xcb));});}}catch(_0x353c08){logger_1[_0x167679(0xbe)][_0x167679(0xc5)](_0x353c08,'efiInitialize:\x20');}};exports[a486_0x490bb8(0xb0)]=efiInitialize;const efiWebhook=async(_0x2bd989,_0x39a1bd)=>{const _0x217ddc=a486_0x490bb8,{evento:_0x36d652}=_0x2bd989[_0x217ddc(0xa5)];if(_0x36d652==='teste_webhook')return _0x39a1bd['json']({'ok':!![]});return _0x2bd989['body'][_0x217ddc(0xe9)]&&await Promise[_0x217ddc(0xd4)](_0x2bd989[_0x217ddc(0xa5)][_0x217ddc(0xe9)][_0x217ddc(0xc6)](async _0x5617b6=>{const _0xad7a47=_0x217ddc;logger_1['logger'][_0xad7a47(0xb1)](_0x5617b6,_0xad7a47(0xc9));const _0x2de751=await Invoices_1[_0xad7a47(0xdc)][_0xad7a47(0xd3)]({'where':{'txId':_0x5617b6[_0xad7a47(0xb3)],'status':_0xad7a47(0xd2)},'include':[{'model':Company_1[_0xad7a47(0xdc)],'as':'company'}]});if(!_0x2de751){logger_1[_0xad7a47(0xbe)][_0xad7a47(0xb1)]('efiWebhook:\x20Invoice\x20not\x20found\x20or\x20already\x20paid');return;}const _0x688308=parseFloat(_0x5617b6['valor']);if(_0x688308<_0x2de751[_0xad7a47(0xd1)]){logger_1[_0xad7a47(0xbe)]['debug'](_0xad7a47(0xe2));return;}await(0x0,PaymentGatewayServices_1['processInvoicePaid'])(_0x2de751);})),_0x39a1bd[_0x217ddc(0xdb)]({'ok':!![]});};exports[a486_0x490bb8(0xb6)]=efiWebhook;function a486_0x509e(_0x2bce8b,_0x47d78e){const _0xbb3055=a486_0xc0d4();return a486_0x509e=function(_0x25b376,_0xa0c7cc){_0x25b376=_0x25b376-0xa4;let _0xc0d422=_0xbb3055[_0x25b376];return _0xc0d422;},a486_0x509e(_0x2bce8b,_0x47d78e);}const efiCheckStatus=async(_0x419ee7,_0x9ad3d6=null)=>{const _0x24db6=a486_0x490bb8;try{!_0x9ad3d6&&(_0x9ad3d6=await newEfiPayInstance());const _0x535fad=await _0x9ad3d6['pixDetailCharge']({'txid':_0x419ee7[_0x24db6(0xe1)]});if(_0x535fad['status']!==_0x24db6(0xba))return![];const {pix:_0x142233}=_0x535fad,_0x5356a8=parseFloat(_0x142233[0x0][_0x24db6(0xa6)]);if(_0x5356a8>=_0x419ee7[_0x24db6(0xd1)])return await(0x0,PaymentGatewayServices_1['processInvoicePaid'])(_0x419ee7),!![];return![];}catch(_0x5e2946){logger_1[_0x24db6(0xbe)][_0x24db6(0xc5)](_0x5e2946,_0x24db6(0xe4));}return![];};exports[a486_0x490bb8(0xae)]=efiCheckStatus;const efiPollCheckStatus=async(_0x37fb26,_0x5bc22c,_0x159eb2=0xa,_0x3d6795=0x7530)=>{let _0x588f14=0x0;async function _0x3a4b48(){const _0x29885e=a486_0x509e;await _0x5bc22c[_0x29885e(0xa7)]();if(_0x5bc22c[_0x29885e(0xcc)]==='paid'){logger_1[_0x29885e(0xbe)]['debug']('efiPollCheckStatus:\x20Invoice\x20'+_0x5bc22c['id']+_0x29885e(0xe6));return;}const _0x2a9e8c=await(0x0,exports[_0x29885e(0xae)])(_0x5bc22c,_0x37fb26);if(_0x2a9e8c)return;_0x588f14+=0x1;if(_0x588f14>=_0x159eb2){(0x0,PaymentGatewayServices_1[_0x29885e(0xaf)])(_0x5bc22c);return;}await new Promise(_0x315f0c=>setTimeout(_0x315f0c,_0x3d6795)),await _0x3a4b48();}return _0x3a4b48();},efiCreateSubscription=async(_0xedac8e,_0x74eebd)=>{const _0x3b94eb=a486_0x490bb8,{price:_0x11307f,invoiceId:_0x27544e}=_0xedac8e[_0x3b94eb(0xa5)],_0x44886b=parseFloat(_0x11307f),_0x174a5a={'calendario':{'expiracao':0x12c},'valor':{'original':_0x44886b[_0x3b94eb(0xc2)](_0x3b94eb(0xea),{'minimumFractionDigits':0x2})['replace'](',','.')},'chave':await(0x0,GetSuperSettingService_1[_0x3b94eb(0xdc)])({'key':_0x3b94eb(0xac)}),'solicitacaoPagador':_0x3b94eb(0xcf)+_0x27544e},_0x1271ea=await getEfiOptions();try{const _0x48d77f=await Invoices_1['default'][_0x3b94eb(0xbd)](_0x27544e);if(!_0x48d77f)throw new Error(_0x3b94eb(0xa9));await(0x0,exports[_0x3b94eb(0xb0)])();const _0x3a210e=new sdk_node_apis_efi_1[(_0x3b94eb(0xdc))](_0x1271ea),_0x37006f=await _0x3a210e['pixCreateImmediateCharge']([],_0x174a5a);return await _0x48d77f[_0x3b94eb(0xef)]({'txId':_0x37006f[_0x3b94eb(0xb3)],'payGw':_0x3b94eb(0xeb),'payGwData':JSON[_0x3b94eb(0xf1)](_0x37006f)}),await _0x48d77f[_0x3b94eb(0xa7)](),efiPollCheckStatus(_0x3a210e,_0x48d77f),_0x74eebd[_0x3b94eb(0xdb)]({'qrcode':{'qrcode':_0x37006f[_0x3b94eb(0xcd)]},'valor':{'original':_0x174a5a[_0x3b94eb(0xa6)][_0x3b94eb(0xb5)]}});}catch(_0x35e06d){logger_1['logger'][_0x3b94eb(0xc5)]({'efiOptions':_0x1271ea,'error':_0x35e06d},_0x3b94eb(0xde));throw new AppError_1[(_0x3b94eb(0xdc))](_0x3b94eb(0xb2),0x190);}};exports['efiCreateSubscription']=efiCreateSubscription;