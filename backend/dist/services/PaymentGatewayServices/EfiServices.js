const a481_0x296444=a481_0x517b;(function(_0x2af650,_0x171a62){const _0x51a588=a481_0x517b,_0x4e1944=_0x2af650();while(!![]){try{const _0xb9758=-parseInt(_0x51a588(0x170))/0x1*(-parseInt(_0x51a588(0x15e))/0x2)+-parseInt(_0x51a588(0x14b))/0x3*(-parseInt(_0x51a588(0x16d))/0x4)+parseInt(_0x51a588(0x153))/0x5+parseInt(_0x51a588(0x137))/0x6*(parseInt(_0x51a588(0x122))/0x7)+parseInt(_0x51a588(0x14c))/0x8+parseInt(_0x51a588(0x124))/0x9*(parseInt(_0x51a588(0x11e))/0xa)+parseInt(_0x51a588(0x12a))/0xb*(-parseInt(_0x51a588(0x12f))/0xc);if(_0xb9758===_0x171a62)break;else _0x4e1944['push'](_0x4e1944['shift']());}catch(_0x5d668b){_0x4e1944['push'](_0x4e1944['shift']());}}}(a481_0x2eed,0x5e2ba));const a481_0x55bb85=(function(){let _0x1526fa=!![];return function(_0x3fb4c4,_0x4b3759){const _0x599e9b=_0x1526fa?function(){const _0x1fed0b=a481_0x517b;if(_0x4b3759){const _0x45be68=_0x4b3759[_0x1fed0b(0x158)](_0x3fb4c4,arguments);return _0x4b3759=null,_0x45be68;}}:function(){};return _0x1526fa=![],_0x599e9b;};}()),a481_0x352ede=a481_0x55bb85(this,function(){const _0x4892bb=a481_0x517b;return a481_0x352ede['toString']()[_0x4892bb(0x141)](_0x4892bb(0x157))['toString']()[_0x4892bb(0x167)](a481_0x352ede)[_0x4892bb(0x141)](_0x4892bb(0x157));});a481_0x352ede();'use strict';var __importDefault=this&&this[a481_0x296444(0x16f)]||function(_0x5364d6){const _0x2ef618=a481_0x296444;return _0x5364d6&&_0x5364d6[_0x2ef618(0x13d)]?_0x5364d6:{'default':_0x5364d6};};Object['defineProperty'](exports,a481_0x296444(0x13d),{'value':!![]}),exports[a481_0x296444(0x15c)]=exports[a481_0x296444(0x139)]=exports[a481_0x296444(0x154)]=exports[a481_0x296444(0x13c)]=void 0x0;const sdk_node_apis_efi_1=__importDefault(require('sdk-node-apis-efi')),path_1=__importDefault(require('path')),GetSuperSettingService_1=__importDefault(require(a481_0x296444(0x16a))),logger_1=require(a481_0x296444(0x123)),Invoices_1=__importDefault(require('../../models/Invoices')),Company_1=__importDefault(require('../../models/Company')),AppError_1=__importDefault(require('../../errors/AppError')),PaymentGatewayServices_1=require(a481_0x296444(0x15a)),webhookUrl=process[a481_0x296444(0x151)][a481_0x296444(0x134)]+a481_0x296444(0x15b);async function getEfiOptions(){const _0x4b636a=a481_0x296444,_0x18fb3a=path_1[_0x4b636a(0x168)][_0x4b636a(0x145)](__dirname,_0x4b636a(0x136)+await(0x0,GetSuperSettingService_1[_0x4b636a(0x168)])({'key':_0x4b636a(0x149)}));return{'sandbox':![],'client_id':await(0x0,GetSuperSettingService_1[_0x4b636a(0x168)])({'key':_0x4b636a(0x148)}),'client_secret':await(0x0,GetSuperSettingService_1[_0x4b636a(0x168)])({'key':_0x4b636a(0x143)}),'pix_cert':_0x18fb3a,'validateMtls':![]};}function a481_0x2eed(){const _0x1a3c61=['_efiPixKey','23298616uHKGHU','status','logger','CONCLUIDA','pixDetailCharge','12kRegko','debug','Invoice\x20not\x20found','pt-br','https://','BACKEND_URL','pixDetailWebhook','../../../private/','10872KheJtx','nome','efiCheckStatus','value','pixConfigWebhook\x20ok','efiInitialize','__esModule','efiCreateSubscription\x20error','#Fatura:','all','search','Problema\x20encontrado,\x20entre\x20em\x20contato\x20com\x20o\x20suporte!','_efiClientSecret','pixConfigWebhook\x20error:','join','info','json','_efiClientId','_efiCertFile','efi','6uQcoNt','3857656fliVGv','toLocaleString','webhook_nao_encontrado','original','startsWith','env','Error\x20getting\x20detail\x20of\x20txid','3156410RxaHOg','efiWebhook','body','efiWebhook:\x20Invoice\x20not\x20found\x20or\x20already\x20paid','(((.+)+)+)+$','apply','map','./PaymentGatewayServices','/subscription/aa/webhook','efiCreateSubscription','findByPk','274RJSEoM','efiInitialize:\x20fail\x20to\x20verify\x20current\x20webhook','pixCopiaECola','processInvoiceExpired','processInvoicePaid','efiInitialize:\x20','error','valor','txid','constructor','default','update','../SettingServices/GetSuperSettingService','pix','then','12396YnkuVI','webhookUrl','__importDefault','2185BQawCw','findOne','410IqnnPu','paid','stringify','company','2555wljIFn','../../utils/logger','92934oWquue','_paymentGateway','Recebido\x20valor\x20menor','teste_webhook','efiPollCheckStatus:\x20Invoice\x20'];a481_0x2eed=function(){return _0x1a3c61;};return a481_0x2eed();}const newEfiPayInstance=async()=>{const _0x24324e=await getEfiOptions();return new sdk_node_apis_efi_1['default'](_0x24324e);},createWebHook=async _0x5bee35=>{const _0x172e67=a481_0x296444,_0x40d318={'chave':await(0x0,GetSuperSettingService_1['default'])({'key':'_efiPixKey'})},_0x1ab85d={'webhookUrl':webhookUrl};return _0x5bee35['pixConfigWebhook'](_0x40d318,_0x1ab85d)[_0x172e67(0x16c)](_0x3d0608=>{const _0x4ad5f5=_0x172e67;logger_1[_0x4ad5f5(0x12c)][_0x4ad5f5(0x146)]({'result':_0x3d0608},_0x4ad5f5(0x13b));},_0x2f3a21=>{const _0x346e79=_0x172e67;logger_1['logger'][_0x346e79(0x164)]({'result':_0x2f3a21},_0x346e79(0x144));});},efiInitialize=async()=>{const _0x28defc=a481_0x296444,_0x2388e6=await(0x0,GetSuperSettingService_1[_0x28defc(0x168)])({'key':_0x28defc(0x125)});if(!webhookUrl[_0x28defc(0x150)](_0x28defc(0x133))){logger_1[_0x28defc(0x12c)][_0x28defc(0x130)]('efiInitialize:\x20only\x20SSL\x20webhooks\x20are\x20supported');return;}try{if(_0x2388e6==='efi'){const _0x14c167=await getEfiOptions(),_0x17eb1d=new sdk_node_apis_efi_1[(_0x28defc(0x168))](_0x14c167),_0x272d37={'chave':await(0x0,GetSuperSettingService_1['default'])({'key':_0x28defc(0x129)})};_0x17eb1d[_0x28defc(0x135)](_0x272d37)[_0x28defc(0x16c)](_0x44bf54=>{const _0x5ce727=_0x28defc;_0x44bf54?.[_0x5ce727(0x16e)]!==webhookUrl?createWebHook(_0x17eb1d):logger_1[_0x5ce727(0x12c)]['debug']({'result':_0x44bf54},'efiInitialize:\x20webhook\x20correto\x20jÃ¡\x20instalado');},_0x173ad7=>{const _0x547707=_0x28defc;_0x173ad7?.[_0x547707(0x138)]===_0x547707(0x14e)?createWebHook(_0x17eb1d):logger_1[_0x547707(0x12c)][_0x547707(0x164)](_0x173ad7,_0x547707(0x15f));});}}catch(_0x29ca0e){logger_1[_0x28defc(0x12c)][_0x28defc(0x164)](_0x29ca0e,_0x28defc(0x163));}};exports[a481_0x296444(0x13c)]=efiInitialize;const efiWebhook=async(_0x48b13b,_0x29984b)=>{const _0x1a7434=a481_0x296444,{evento:_0x453e31}=_0x48b13b[_0x1a7434(0x155)];if(_0x453e31===_0x1a7434(0x127))return _0x29984b[_0x1a7434(0x147)]({'ok':!![]});return _0x48b13b['body']['pix']&&await Promise[_0x1a7434(0x140)](_0x48b13b[_0x1a7434(0x155)][_0x1a7434(0x16b)][_0x1a7434(0x159)](async _0x36a1a7=>{const _0x4744e9=_0x1a7434;logger_1[_0x4744e9(0x12c)]['debug'](_0x36a1a7,'Processando\x20pagamento');const _0x1aa3be=await Invoices_1[_0x4744e9(0x168)][_0x4744e9(0x11d)]({'where':{'txId':_0x36a1a7[_0x4744e9(0x166)],'status':'open'},'include':[{'model':Company_1[_0x4744e9(0x168)],'as':_0x4744e9(0x121)}]});if(!_0x1aa3be){logger_1[_0x4744e9(0x12c)][_0x4744e9(0x130)](_0x4744e9(0x156));return;}const _0x86764e=parseFloat(_0x36a1a7['valor']);if(_0x86764e<_0x1aa3be[_0x4744e9(0x13a)]){logger_1['logger'][_0x4744e9(0x130)](_0x4744e9(0x126));return;}await(0x0,PaymentGatewayServices_1[_0x4744e9(0x162)])(_0x1aa3be);})),_0x29984b[_0x1a7434(0x147)]({'ok':!![]});};exports['efiWebhook']=efiWebhook;const efiCheckStatus=async(_0x53f214,_0x3263c9=null)=>{const _0x40637b=a481_0x296444;try{!_0x3263c9&&(_0x3263c9=await newEfiPayInstance());const _0x6fd927=await _0x3263c9[_0x40637b(0x12e)]({'txid':_0x53f214['txId']});if(_0x6fd927['status']!==_0x40637b(0x12d))return![];const {pix:_0x2062fc}=_0x6fd927,_0x8d0437=parseFloat(_0x2062fc[0x0][_0x40637b(0x165)]);if(_0x8d0437>=_0x53f214[_0x40637b(0x13a)])return await(0x0,PaymentGatewayServices_1[_0x40637b(0x162)])(_0x53f214),!![];return![];}catch(_0x44cde3){logger_1[_0x40637b(0x12c)][_0x40637b(0x164)](_0x44cde3,_0x40637b(0x152));}return![];};function a481_0x517b(_0x1149fe,_0x13f6d6){const _0x55042d=a481_0x2eed();return a481_0x517b=function(_0x352ede,_0x55bb85){_0x352ede=_0x352ede-0x11d;let _0x2eede8=_0x55042d[_0x352ede];return _0x2eede8;},a481_0x517b(_0x1149fe,_0x13f6d6);}exports[a481_0x296444(0x139)]=efiCheckStatus;const efiPollCheckStatus=async(_0x4ad6cb,_0xbd0963,_0x41e1bf=0xa,_0x880c80=0x7530)=>{let _0x4031f0=0x0;async function _0x4b78f3(){const _0x2a9425=a481_0x517b;await _0xbd0963['reload']();if(_0xbd0963[_0x2a9425(0x12b)]===_0x2a9425(0x11f)){logger_1[_0x2a9425(0x12c)][_0x2a9425(0x130)](_0x2a9425(0x128)+_0xbd0963['id']+'\x20already\x20paid,\x20finishing\x20polling');return;}const _0x4816cd=await(0x0,exports[_0x2a9425(0x139)])(_0xbd0963,_0x4ad6cb);if(_0x4816cd)return;_0x4031f0+=0x1;if(_0x4031f0>=_0x41e1bf){(0x0,PaymentGatewayServices_1[_0x2a9425(0x161)])(_0xbd0963);return;}await new Promise(_0x40ae0d=>setTimeout(_0x40ae0d,_0x880c80)),await _0x4b78f3();}return _0x4b78f3();},efiCreateSubscription=async(_0x4c3ce4,_0x54ee2b)=>{const _0x5d7996=a481_0x296444,{price:_0x152814,invoiceId:_0x280668}=_0x4c3ce4['body'],_0x2b7b1a=parseFloat(_0x152814),_0x211137={'calendario':{'expiracao':0x12c},'valor':{'original':_0x2b7b1a[_0x5d7996(0x14d)](_0x5d7996(0x132),{'minimumFractionDigits':0x2})['replace'](',','.')},'chave':await(0x0,GetSuperSettingService_1[_0x5d7996(0x168)])({'key':'_efiPixKey'}),'solicitacaoPagador':_0x5d7996(0x13f)+_0x280668},_0x48c366=await getEfiOptions();try{const _0x4e5613=await Invoices_1['default'][_0x5d7996(0x15d)](_0x280668);if(!_0x4e5613)throw new Error(_0x5d7996(0x131));await(0x0,exports[_0x5d7996(0x13c)])();const _0x465514=new sdk_node_apis_efi_1[(_0x5d7996(0x168))](_0x48c366),_0x560647=await _0x465514['pixCreateImmediateCharge']([],_0x211137);return await _0x4e5613[_0x5d7996(0x169)]({'txId':_0x560647[_0x5d7996(0x166)],'payGw':_0x5d7996(0x14a),'payGwData':JSON[_0x5d7996(0x120)](_0x560647)}),await _0x4e5613['reload'](),efiPollCheckStatus(_0x465514,_0x4e5613),_0x54ee2b[_0x5d7996(0x147)]({'qrcode':{'qrcode':_0x560647[_0x5d7996(0x160)]},'valor':{'original':_0x211137[_0x5d7996(0x165)][_0x5d7996(0x14f)]}});}catch(_0x1a3878){logger_1[_0x5d7996(0x12c)][_0x5d7996(0x164)]({'efiOptions':_0x48c366,'error':_0x1a3878},_0x5d7996(0x13e));throw new AppError_1['default'](_0x5d7996(0x142),0x190);}};exports[a481_0x296444(0x15c)]=efiCreateSubscription;