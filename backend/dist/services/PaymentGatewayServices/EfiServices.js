const a452_0x28f02e=a452_0x3b8b;(function(_0x508be5,_0x6b36bc){const _0x4cbde5=a452_0x3b8b,_0x200f8b=_0x508be5();while(!![]){try{const _0x550509=-parseInt(_0x4cbde5(0x11d))/0x1+-parseInt(_0x4cbde5(0x157))/0x2*(parseInt(_0x4cbde5(0x15d))/0x3)+parseInt(_0x4cbde5(0x165))/0x4+-parseInt(_0x4cbde5(0x143))/0x5+-parseInt(_0x4cbde5(0x15a))/0x6*(-parseInt(_0x4cbde5(0x11c))/0x7)+-parseInt(_0x4cbde5(0x155))/0x8*(-parseInt(_0x4cbde5(0x14d))/0x9)+-parseInt(_0x4cbde5(0x152))/0xa*(parseInt(_0x4cbde5(0x13e))/0xb);if(_0x550509===_0x6b36bc)break;else _0x200f8b['push'](_0x200f8b['shift']());}catch(_0x3d775e){_0x200f8b['push'](_0x200f8b['shift']());}}}(a452_0x53d6,0xe735e));const a452_0x46c101=(function(){let _0xc0b10a=!![];return function(_0x957d92,_0x2757ff){const _0x2321ac=_0xc0b10a?function(){const _0x43a71f=a452_0x3b8b;if(_0x2757ff){const _0x11c5bf=_0x2757ff[_0x43a71f(0x160)](_0x957d92,arguments);return _0x2757ff=null,_0x11c5bf;}}:function(){};return _0xc0b10a=![],_0x2321ac;};}()),a452_0x1b1a21=a452_0x46c101(this,function(){const _0x10fa83=a452_0x3b8b;return a452_0x1b1a21[_0x10fa83(0x14a)]()[_0x10fa83(0x136)](_0x10fa83(0x128))[_0x10fa83(0x14a)]()['constructor'](a452_0x1b1a21)[_0x10fa83(0x136)](_0x10fa83(0x128));});a452_0x1b1a21();'use strict';function a452_0x53d6(){const _0x4c187a=['pixConfigWebhook\x20ok','__importDefault','pixConfigWebhook\x20error:','json','logger','then','toLocaleString','Problema\x20encontrado,\x20entre\x20em\x20contato\x20com\x20o\x20suporte!','default','(((.+)+)+)+$','error','findOne','pixDetailWebhook','efiWebhook:\x20Invoice\x20not\x20found\x20or\x20already\x20paid','Processando\x20pagamento','Error\x20getting\x20detail\x20of\x20txid','_efiClientSecret','info','../../utils/logger','body','efiCheckStatus','env','status','search','efiInitialize:\x20webhook\x20correto\x20jÃ¡\x20instalado','webhookUrl','reload','path','pixDetailCharge','txid','value','139018Icgngx','teste_webhook','efiWebhook','efiPollCheckStatus:\x20Invoice\x20','https://','4458605NoeUGv','efiInitialize:\x20','/subscription/aa/webhook','efiInitialize:\x20fail\x20to\x20verify\x20current\x20webhook','pix','efiInitialize:\x20only\x20SSL\x20webhooks\x20are\x20supported','sdk-node-apis-efi','toString','CONCLUIDA','processInvoiceExpired','7168275YBjCAt','replace','join','efiInitialize','_efiClientId','1330BZncZW','update','__esModule','8tGqczh','Invoice\x20not\x20found','55972IkhPbU','Recebido\x20valor\x20menor','BACKEND_URL','6822KsXJsx','../../../private/','pt-br','27zIkQwe','paid','map','apply','txId','_efiPixKey','debug','efiCreateSubscription','6709400erIkDe','valor','defineProperty','processInvoicePaid','open','nome','original','stringify','findByPk','9849PbCQox','302097ahbzQt','webhook_nao_encontrado'];a452_0x53d6=function(){return _0x4c187a;};return a452_0x53d6();}var __importDefault=this&&this[a452_0x28f02e(0x120)]||function(_0x37e30e){const _0x5e714d=a452_0x28f02e;return _0x37e30e&&_0x37e30e[_0x5e714d(0x154)]?_0x37e30e:{'default':_0x37e30e};};Object[a452_0x28f02e(0x167)](exports,a452_0x28f02e(0x154),{'value':!![]}),exports[a452_0x28f02e(0x164)]=exports[a452_0x28f02e(0x133)]=exports[a452_0x28f02e(0x140)]=exports[a452_0x28f02e(0x150)]=void 0x0;function a452_0x3b8b(_0x3ea1f1,_0x8bf882){const _0x11c62c=a452_0x53d6();return a452_0x3b8b=function(_0x1b1a21,_0x46c101){_0x1b1a21=_0x1b1a21-0x118;let _0x53d6f9=_0x11c62c[_0x1b1a21];return _0x53d6f9;},a452_0x3b8b(_0x3ea1f1,_0x8bf882);}const sdk_node_apis_efi_1=__importDefault(require(a452_0x28f02e(0x149))),path_1=__importDefault(require(a452_0x28f02e(0x13a))),GetSuperSettingService_1=__importDefault(require('../SettingServices/GetSuperSettingService')),logger_1=require(a452_0x28f02e(0x131)),Invoices_1=__importDefault(require('../../models/Invoices')),Company_1=__importDefault(require('../../models/Company')),AppError_1=__importDefault(require('../../errors/AppError')),PaymentGatewayServices_1=require('./PaymentGatewayServices'),webhookUrl=process[a452_0x28f02e(0x134)][a452_0x28f02e(0x159)]+a452_0x28f02e(0x145);async function getEfiOptions(){const _0x3be926=a452_0x28f02e,_0x430ce2=path_1['default'][_0x3be926(0x14f)](__dirname,_0x3be926(0x15b)+await(0x0,GetSuperSettingService_1[_0x3be926(0x127)])({'key':'_efiCertFile'}));return{'sandbox':![],'client_id':await(0x0,GetSuperSettingService_1[_0x3be926(0x127)])({'key':_0x3be926(0x151)}),'client_secret':await(0x0,GetSuperSettingService_1[_0x3be926(0x127)])({'key':_0x3be926(0x12f)}),'pix_cert':_0x430ce2,'validateMtls':![]};}const newEfiPayInstance=async()=>{const _0x395707=a452_0x28f02e,_0x18cf40=await getEfiOptions();return new sdk_node_apis_efi_1[(_0x395707(0x127))](_0x18cf40);},createWebHook=async _0x27fe12=>{const _0x525c5c=a452_0x28f02e,_0x473503={'chave':await(0x0,GetSuperSettingService_1[_0x525c5c(0x127)])({'key':'_efiPixKey'})},_0x3e6e3a={'webhookUrl':webhookUrl};return _0x27fe12['pixConfigWebhook'](_0x473503,_0x3e6e3a)[_0x525c5c(0x124)](_0x3b52fa=>{const _0x48ed35=_0x525c5c;logger_1[_0x48ed35(0x123)][_0x48ed35(0x130)]({'result':_0x3b52fa},_0x48ed35(0x11f));},_0x68212e=>{const _0x3d687d=_0x525c5c;logger_1[_0x3d687d(0x123)][_0x3d687d(0x129)]({'result':_0x68212e},_0x3d687d(0x121));});},efiInitialize=async()=>{const _0x261d8f=a452_0x28f02e,_0x5dd1b6=await(0x0,GetSuperSettingService_1[_0x261d8f(0x127)])({'key':'_paymentGateway'});if(!webhookUrl['startsWith'](_0x261d8f(0x142))){logger_1[_0x261d8f(0x123)][_0x261d8f(0x163)](_0x261d8f(0x148));return;}try{if(_0x5dd1b6==='efi'){const _0x14b9bc=await getEfiOptions(),_0x2eda38=new sdk_node_apis_efi_1[(_0x261d8f(0x127))](_0x14b9bc),_0x519a68={'chave':await(0x0,GetSuperSettingService_1[_0x261d8f(0x127)])({'key':_0x261d8f(0x162)})};_0x2eda38[_0x261d8f(0x12b)](_0x519a68)[_0x261d8f(0x124)](_0x1fe4ad=>{const _0x2ae48c=_0x261d8f;_0x1fe4ad?.[_0x2ae48c(0x138)]!==webhookUrl?createWebHook(_0x2eda38):logger_1[_0x2ae48c(0x123)]['debug']({'result':_0x1fe4ad},_0x2ae48c(0x137));},_0x451a0e=>{const _0x2a6e7f=_0x261d8f;_0x451a0e?.[_0x2a6e7f(0x118)]===_0x2a6e7f(0x11e)?createWebHook(_0x2eda38):logger_1['logger'][_0x2a6e7f(0x129)](_0x451a0e,_0x2a6e7f(0x146));});}}catch(_0x198f86){logger_1[_0x261d8f(0x123)][_0x261d8f(0x129)](_0x198f86,_0x261d8f(0x144));}};exports[a452_0x28f02e(0x150)]=efiInitialize;const efiWebhook=async(_0x2645a8,_0x406f34)=>{const _0x558549=a452_0x28f02e,{evento:_0x244ab7}=_0x2645a8[_0x558549(0x132)];if(_0x244ab7===_0x558549(0x13f))return _0x406f34['json']({'ok':!![]});return _0x2645a8[_0x558549(0x132)][_0x558549(0x147)]&&await Promise['all'](_0x2645a8[_0x558549(0x132)][_0x558549(0x147)][_0x558549(0x15f)](async _0x3efe78=>{const _0xa89b03=_0x558549;logger_1[_0xa89b03(0x123)][_0xa89b03(0x163)](_0x3efe78,_0xa89b03(0x12d));const _0x142630=await Invoices_1[_0xa89b03(0x127)][_0xa89b03(0x12a)]({'where':{'txId':_0x3efe78[_0xa89b03(0x13c)],'status':_0xa89b03(0x169)},'include':[{'model':Company_1['default'],'as':'company'}]});if(!_0x142630){logger_1[_0xa89b03(0x123)][_0xa89b03(0x163)](_0xa89b03(0x12c));return;}const _0xd3374c=parseFloat(_0x3efe78[_0xa89b03(0x166)]);if(_0xd3374c<_0x142630[_0xa89b03(0x13d)]){logger_1[_0xa89b03(0x123)][_0xa89b03(0x163)](_0xa89b03(0x158));return;}await(0x0,PaymentGatewayServices_1[_0xa89b03(0x168)])(_0x142630);})),_0x406f34[_0x558549(0x122)]({'ok':!![]});};exports[a452_0x28f02e(0x140)]=efiWebhook;const efiCheckStatus=async(_0x3d8276,_0xc9d471=null)=>{const _0x16a00e=a452_0x28f02e;try{!_0xc9d471&&(_0xc9d471=await newEfiPayInstance());const _0x427917=await _0xc9d471[_0x16a00e(0x13b)]({'txid':_0x3d8276[_0x16a00e(0x161)]});if(_0x427917[_0x16a00e(0x135)]!==_0x16a00e(0x14b))return![];const {pix:_0xb1c5a6}=_0x427917,_0x5306c9=parseFloat(_0xb1c5a6[0x0]['valor']);if(_0x5306c9>=_0x3d8276[_0x16a00e(0x13d)])return await(0x0,PaymentGatewayServices_1[_0x16a00e(0x168)])(_0x3d8276),!![];return![];}catch(_0xff4851){logger_1['logger'][_0x16a00e(0x129)](_0xff4851,_0x16a00e(0x12e));}return![];};exports[a452_0x28f02e(0x133)]=efiCheckStatus;const efiPollCheckStatus=async(_0x6d5714,_0xb631bb,_0x574493=0xa,_0xdca928=0x7530)=>{let _0x162db0=0x0;async function _0x3cfe01(){const _0xd162a6=a452_0x3b8b;await _0xb631bb[_0xd162a6(0x139)]();if(_0xb631bb[_0xd162a6(0x135)]===_0xd162a6(0x15e)){logger_1[_0xd162a6(0x123)][_0xd162a6(0x163)](_0xd162a6(0x141)+_0xb631bb['id']+'\x20already\x20paid,\x20finishing\x20polling');return;}const _0x4518b3=await(0x0,exports[_0xd162a6(0x133)])(_0xb631bb,_0x6d5714);if(_0x4518b3)return;_0x162db0+=0x1;if(_0x162db0>=_0x574493){(0x0,PaymentGatewayServices_1[_0xd162a6(0x14c)])(_0xb631bb);return;}await new Promise(_0x33bc0d=>setTimeout(_0x33bc0d,_0xdca928)),await _0x3cfe01();}return _0x3cfe01();},efiCreateSubscription=async(_0x13c79a,_0x23b033)=>{const _0x72877f=a452_0x28f02e,{price:_0x5ecfbf,invoiceId:_0x1d70a5}=_0x13c79a[_0x72877f(0x132)],_0x40c513=parseFloat(_0x5ecfbf),_0x385f21={'calendario':{'expiracao':0x12c},'valor':{'original':_0x40c513[_0x72877f(0x125)](_0x72877f(0x15c),{'minimumFractionDigits':0x2})[_0x72877f(0x14e)](',','.')},'chave':await(0x0,GetSuperSettingService_1['default'])({'key':_0x72877f(0x162)}),'solicitacaoPagador':'#Fatura:'+_0x1d70a5},_0x4b40d3=await getEfiOptions();try{const _0x14d08f=await Invoices_1[_0x72877f(0x127)][_0x72877f(0x11b)](_0x1d70a5);if(!_0x14d08f)throw new Error(_0x72877f(0x156));await(0x0,exports[_0x72877f(0x150)])();const _0xda7677=new sdk_node_apis_efi_1[(_0x72877f(0x127))](_0x4b40d3),_0x26b223=await _0xda7677['pixCreateImmediateCharge']([],_0x385f21);return await _0x14d08f[_0x72877f(0x153)]({'txId':_0x26b223[_0x72877f(0x13c)],'payGw':'efi','payGwData':JSON[_0x72877f(0x11a)](_0x26b223)}),await _0x14d08f[_0x72877f(0x139)](),efiPollCheckStatus(_0xda7677,_0x14d08f),_0x23b033['json']({'qrcode':{'qrcode':_0x26b223['pixCopiaECola']},'valor':{'original':_0x385f21[_0x72877f(0x166)][_0x72877f(0x119)]}});}catch(_0x52e698){logger_1['logger']['error']({'efiOptions':_0x4b40d3,'error':_0x52e698},'efiCreateSubscription\x20error');throw new AppError_1[(_0x72877f(0x127))](_0x72877f(0x126),0x190);}};exports['efiCreateSubscription']=efiCreateSubscription;