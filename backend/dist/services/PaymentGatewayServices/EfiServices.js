function a588_0x1e2a(_0x435bba,_0x42a397){const _0x43e0de=a588_0x1ceb();return a588_0x1e2a=function(_0x7e6d07,_0x467d09){_0x7e6d07=_0x7e6d07-0x14a;let _0x1ceb29=_0x43e0de[_0x7e6d07];return _0x1ceb29;},a588_0x1e2a(_0x435bba,_0x42a397);}const a588_0x392605=a588_0x1e2a;(function(_0x268d7b,_0x102f78){const _0x4593e1=a588_0x1e2a,_0x3b6f4d=_0x268d7b();while(!![]){try{const _0x2b30c3=-parseInt(_0x4593e1(0x14c))/0x1+parseInt(_0x4593e1(0x171))/0x2*(-parseInt(_0x4593e1(0x169))/0x3)+-parseInt(_0x4593e1(0x193))/0x4+-parseInt(_0x4593e1(0x155))/0x5*(-parseInt(_0x4593e1(0x14f))/0x6)+parseInt(_0x4593e1(0x164))/0x7*(parseInt(_0x4593e1(0x14a))/0x8)+-parseInt(_0x4593e1(0x15f))/0x9+parseInt(_0x4593e1(0x17a))/0xa*(parseInt(_0x4593e1(0x17b))/0xb);if(_0x2b30c3===_0x102f78)break;else _0x3b6f4d['push'](_0x3b6f4d['shift']());}catch(_0x4d53ec){_0x3b6f4d['push'](_0x3b6f4d['shift']());}}}(a588_0x1ceb,0x6a0f8));const a588_0x467d09=(function(){let _0x58be46=!![];return function(_0x12472c,_0x30c70a){const _0x55339a=_0x58be46?function(){const _0x4dc486=a588_0x1e2a;if(_0x30c70a){const _0x5e6d6b=_0x30c70a[_0x4dc486(0x16c)](_0x12472c,arguments);return _0x30c70a=null,_0x5e6d6b;}}:function(){};return _0x58be46=![],_0x55339a;};}()),a588_0x7e6d07=a588_0x467d09(this,function(){const _0x4897a5=a588_0x1e2a;return a588_0x7e6d07['toString']()[_0x4897a5(0x168)](_0x4897a5(0x178))['toString']()[_0x4897a5(0x159)](a588_0x7e6d07)[_0x4897a5(0x168)]('(((.+)+)+)+$');});a588_0x7e6d07();'use strict';var __importDefault=this&&this['__importDefault']||function(_0xb117){const _0x2f6b6c=a588_0x1e2a;return _0xb117&&_0xb117[_0x2f6b6c(0x14d)]?_0xb117:{'default':_0xb117};};Object['defineProperty'](exports,a588_0x392605(0x14d),{'value':!![]}),exports[a588_0x392605(0x188)]=exports[a588_0x392605(0x18c)]=exports['efiWebhook']=exports[a588_0x392605(0x165)]=void 0x0;const sdk_node_apis_efi_1=__importDefault(require('sdk-node-apis-efi')),path_1=__importDefault(require(a588_0x392605(0x14b))),GetSuperSettingService_1=__importDefault(require('../SettingServices/GetSuperSettingService')),logger_1=require(a588_0x392605(0x173)),Invoices_1=__importDefault(require(a588_0x392605(0x153))),Company_1=__importDefault(require(a588_0x392605(0x19b))),AppError_1=__importDefault(require(a588_0x392605(0x15d))),PaymentGatewayServices_1=require(a588_0x392605(0x152)),webhookUrl=process['env']['BACKEND_URL']+a588_0x392605(0x183);async function getEfiOptions(){const _0x2eea01=a588_0x392605,_0x264c11=path_1[_0x2eea01(0x186)][_0x2eea01(0x174)](__dirname,_0x2eea01(0x187)+await(0x0,GetSuperSettingService_1[_0x2eea01(0x186)])({'key':_0x2eea01(0x150)}));return{'sandbox':![],'client_id':await(0x0,GetSuperSettingService_1[_0x2eea01(0x186)])({'key':_0x2eea01(0x15a)}),'client_secret':await(0x0,GetSuperSettingService_1[_0x2eea01(0x186)])({'key':_0x2eea01(0x191)}),'pix_cert':_0x264c11,'validateMtls':![]};}const newEfiPayInstance=async()=>{const _0x296d99=a588_0x392605,_0x29106f=await getEfiOptions();return new sdk_node_apis_efi_1[(_0x296d99(0x186))](_0x29106f);},createWebHook=async _0x5d5aa1=>{const _0x51b711=a588_0x392605,_0x3c0a87={'chave':await(0x0,GetSuperSettingService_1[_0x51b711(0x186)])({'key':'_efiPixKey'})},_0x4c7df7={'webhookUrl':webhookUrl};return _0x5d5aa1[_0x51b711(0x19a)](_0x3c0a87,_0x4c7df7)[_0x51b711(0x170)](_0xdf138a=>{const _0x5f0d2a=_0x51b711;logger_1['logger'][_0x5f0d2a(0x190)]({'result':_0xdf138a},'pixConfigWebhook\x20ok');},_0x4d5211=>{const _0x245454=_0x51b711;logger_1[_0x245454(0x180)][_0x245454(0x19d)]({'result':_0x4d5211},_0x245454(0x163));});},efiInitialize=async()=>{const _0x42b69f=a588_0x392605,_0x39fac2=await(0x0,GetSuperSettingService_1[_0x42b69f(0x186)])({'key':_0x42b69f(0x15e)});if(!webhookUrl[_0x42b69f(0x189)]('https://')){logger_1['logger'][_0x42b69f(0x15b)](_0x42b69f(0x158));return;}try{if(_0x39fac2===_0x42b69f(0x194)){const _0x3f5795=await getEfiOptions(),_0x1254c3=new sdk_node_apis_efi_1[(_0x42b69f(0x186))](_0x3f5795),_0x3c3554={'chave':await(0x0,GetSuperSettingService_1['default'])({'key':_0x42b69f(0x18b)})};_0x1254c3[_0x42b69f(0x16b)](_0x3c3554)[_0x42b69f(0x170)](_0x5a95ad=>{const _0x4e472c=_0x42b69f;_0x5a95ad?.[_0x4e472c(0x185)]!==webhookUrl?createWebHook(_0x1254c3):logger_1['logger'][_0x4e472c(0x15b)]({'result':_0x5a95ad},_0x4e472c(0x18d));},_0x394520=>{const _0x1fffa9=_0x42b69f;_0x394520?.[_0x1fffa9(0x16a)]===_0x1fffa9(0x16f)?createWebHook(_0x1254c3):logger_1[_0x1fffa9(0x180)]['error'](_0x394520,_0x1fffa9(0x167));});}}catch(_0x1e89e9){logger_1[_0x42b69f(0x180)][_0x42b69f(0x19d)](_0x1e89e9,'efiInitialize:\x20');}};exports[a588_0x392605(0x165)]=efiInitialize;const efiWebhook=async(_0x45aaff,_0x1b45c7)=>{const _0x1d7b0d=a588_0x392605,{evento:_0x38d9bd}=_0x45aaff[_0x1d7b0d(0x14e)];if(_0x38d9bd===_0x1d7b0d(0x17f))return _0x1b45c7[_0x1d7b0d(0x192)]({'ok':!![]});return _0x45aaff[_0x1d7b0d(0x14e)]['pix']&&await Promise[_0x1d7b0d(0x16e)](_0x45aaff[_0x1d7b0d(0x14e)][_0x1d7b0d(0x195)][_0x1d7b0d(0x182)](async _0x83b233=>{const _0x102192=_0x1d7b0d;logger_1[_0x102192(0x180)]['debug'](_0x83b233,_0x102192(0x18a));const _0x3def8d=await Invoices_1['default'][_0x102192(0x175)]({'where':{'txId':_0x83b233['txid'],'status':_0x102192(0x15c)},'include':[{'model':Company_1[_0x102192(0x186)],'as':_0x102192(0x197)}]});if(!_0x3def8d){logger_1[_0x102192(0x180)][_0x102192(0x15b)](_0x102192(0x166));return;}const _0x18a3fc=parseFloat(_0x83b233['valor']);if(_0x18a3fc<_0x3def8d[_0x102192(0x17c)]){logger_1['logger'][_0x102192(0x15b)](_0x102192(0x160));return;}await(0x0,PaymentGatewayServices_1[_0x102192(0x156)])(_0x3def8d);})),_0x1b45c7[_0x1d7b0d(0x192)]({'ok':!![]});};function a588_0x1ceb(){const _0x28f880=['_efiCertFile','status','./PaymentGatewayServices','../../models/Invoices','txId','211155KfbYoD','processInvoicePaid','paid','efiInitialize:\x20only\x20SSL\x20webhooks\x20are\x20supported','constructor','_efiClientId','debug','open','../../errors/AppError','_paymentGateway','2739924bsiqTg','Recebido\x20valor\x20menor','original','Problema\x20encontrado,\x20entre\x20em\x20contato\x20com\x20o\x20suporte!','pixConfigWebhook\x20error:','91DLwCpV','efiInitialize','efiWebhook:\x20Invoice\x20not\x20found\x20or\x20already\x20paid','efiInitialize:\x20fail\x20to\x20verify\x20current\x20webhook','search','2017800oRkUIW','nome','pixDetailWebhook','apply','update','all','webhook_nao_encontrado','then','2WBelim','Invoice\x20not\x20found','../../utils/logger','join','findOne','txid','efiWebhook','(((.+)+)+)+$','valor','3104330TeIAMY','55wgzgoS','value','\x20already\x20paid,\x20finishing\x20polling','pixCreateImmediateCharge','teste_webhook','logger','reload','map','/subscription/aa/webhook','replace','webhookUrl','default','../../../private/','efiCreateSubscription','startsWith','Processando\x20pagamento','_efiPixKey','efiCheckStatus','efiInitialize:\x20webhook\x20correto\x20jÃ¡\x20instalado','stringify','efiPollCheckStatus:\x20Invoice\x20','info','_efiClientSecret','json','1130640YZmPYx','efi','pix','findByPk','company','efiCreateSubscription\x20error','pt-br','pixConfigWebhook','../../models/Company','Error\x20getting\x20detail\x20of\x20txid','error','310744kdeANp','path','405235zZhhpa','__esModule','body','6ESbyvo'];a588_0x1ceb=function(){return _0x28f880;};return a588_0x1ceb();}exports[a588_0x392605(0x177)]=efiWebhook;const efiCheckStatus=async(_0x271fb8,_0x2d8cfb=null)=>{const _0xab79cb=a588_0x392605;try{!_0x2d8cfb&&(_0x2d8cfb=await newEfiPayInstance());const _0x594474=await _0x2d8cfb['pixDetailCharge']({'txid':_0x271fb8[_0xab79cb(0x154)]});if(_0x594474[_0xab79cb(0x151)]!=='CONCLUIDA')return![];const {pix:_0xf21e16}=_0x594474,_0x50f340=parseFloat(_0xf21e16[0x0][_0xab79cb(0x179)]);if(_0x50f340>=_0x271fb8['value'])return await(0x0,PaymentGatewayServices_1[_0xab79cb(0x156)])(_0x271fb8),!![];return![];}catch(_0x2619e2){logger_1[_0xab79cb(0x180)][_0xab79cb(0x19d)](_0x2619e2,_0xab79cb(0x19c));}return![];};exports['efiCheckStatus']=efiCheckStatus;const efiPollCheckStatus=async(_0xac14a6,_0x1dd101,_0xea9845=0xa,_0x5e8afa=0x7530)=>{let _0x4583c6=0x0;async function _0x264c17(){const _0x112125=a588_0x1e2a;await _0x1dd101['reload']();if(_0x1dd101['status']===_0x112125(0x157)){logger_1[_0x112125(0x180)]['debug'](_0x112125(0x18f)+_0x1dd101['id']+_0x112125(0x17d));return;}const _0x2a081c=await(0x0,exports['efiCheckStatus'])(_0x1dd101,_0xac14a6);if(_0x2a081c)return;_0x4583c6+=0x1;if(_0x4583c6>=_0xea9845){(0x0,PaymentGatewayServices_1['processInvoiceExpired'])(_0x1dd101);return;}await new Promise(_0x5383f1=>setTimeout(_0x5383f1,_0x5e8afa)),await _0x264c17();}return _0x264c17();},efiCreateSubscription=async(_0x150f5e,_0x385ba8)=>{const _0xeb6089=a588_0x392605,{price:_0xa3e8bb,invoiceId:_0x23d571}=_0x150f5e[_0xeb6089(0x14e)],_0x589f35=parseFloat(_0xa3e8bb),_0x1f3393={'calendario':{'expiracao':0x12c},'valor':{'original':_0x589f35['toLocaleString'](_0xeb6089(0x199),{'minimumFractionDigits':0x2})[_0xeb6089(0x184)](',','.')},'chave':await(0x0,GetSuperSettingService_1[_0xeb6089(0x186)])({'key':_0xeb6089(0x18b)}),'solicitacaoPagador':'#Fatura:'+_0x23d571},_0x1e1996=await getEfiOptions();try{const _0x276c5e=await Invoices_1[_0xeb6089(0x186)][_0xeb6089(0x196)](_0x23d571);if(!_0x276c5e)throw new Error(_0xeb6089(0x172));await(0x0,exports[_0xeb6089(0x165)])();const _0x14aa39=new sdk_node_apis_efi_1[(_0xeb6089(0x186))](_0x1e1996),_0x5367b0=await _0x14aa39[_0xeb6089(0x17e)]([],_0x1f3393);return await _0x276c5e[_0xeb6089(0x16d)]({'txId':_0x5367b0[_0xeb6089(0x176)],'payGw':_0xeb6089(0x194),'payGwData':JSON[_0xeb6089(0x18e)](_0x5367b0)}),await _0x276c5e[_0xeb6089(0x181)](),efiPollCheckStatus(_0x14aa39,_0x276c5e),_0x385ba8['json']({'qrcode':{'qrcode':_0x5367b0['pixCopiaECola']},'valor':{'original':_0x1f3393['valor'][_0xeb6089(0x161)]}});}catch(_0x2eeafd){logger_1['logger'][_0xeb6089(0x19d)]({'efiOptions':_0x1e1996,'error':_0x2eeafd},_0xeb6089(0x198));throw new AppError_1[(_0xeb6089(0x186))](_0xeb6089(0x162),0x190);}};exports['efiCreateSubscription']=efiCreateSubscription;