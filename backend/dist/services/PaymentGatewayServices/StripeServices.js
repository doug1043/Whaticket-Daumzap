const a452_0x5f049e=a452_0x4292;(function(_0x4ede46,_0x49a9a5){const _0xcfecb6=a452_0x4292,_0x4a3cd2=_0x4ede46();while(!![]){try{const _0x27d86c=-parseInt(_0xcfecb6(0x1c8))/0x1*(parseInt(_0xcfecb6(0x1ca))/0x2)+parseInt(_0xcfecb6(0x1bf))/0x3*(parseInt(_0xcfecb6(0x1c7))/0x4)+-parseInt(_0xcfecb6(0x189))/0x5+-parseInt(_0xcfecb6(0x1aa))/0x6+-parseInt(_0xcfecb6(0x1c0))/0x7*(-parseInt(_0xcfecb6(0x1c2))/0x8)+parseInt(_0xcfecb6(0x1cc))/0x9*(parseInt(_0xcfecb6(0x194))/0xa)+-parseInt(_0xcfecb6(0x1b1))/0xb*(parseInt(_0xcfecb6(0x188))/0xc);if(_0x27d86c===_0x49a9a5)break;else _0x4a3cd2['push'](_0x4a3cd2['shift']());}catch(_0x52c7de){_0x4a3cd2['push'](_0x4a3cd2['shift']());}}}(a452_0x2219,0xb3729));const a452_0x35541d=(function(){let _0x113d31=!![];return function(_0x45d91d,_0x330e00){const _0x435440=_0x113d31?function(){if(_0x330e00){const _0x18b782=_0x330e00['apply'](_0x45d91d,arguments);return _0x330e00=null,_0x18b782;}}:function(){};return _0x113d31=![],_0x435440;};}()),a452_0x2221f2=a452_0x35541d(this,function(){const _0x3bf753=a452_0x4292;return a452_0x2221f2['toString']()[_0x3bf753(0x1c1)](_0x3bf753(0x18b))['toString']()[_0x3bf753(0x1bd)](a452_0x2221f2)[_0x3bf753(0x1c1)]('(((.+)+)+)+$');});a452_0x2221f2();'use strict';var __importDefault=this&&this[a452_0x5f049e(0x192)]||function(_0x2ffe65){const _0x43be5a=a452_0x5f049e;return _0x2ffe65&&_0x2ffe65[_0x43be5a(0x1cb)]?_0x2ffe65:{'default':_0x2ffe65};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a452_0x5f049e(0x1ab)]=exports[a452_0x5f049e(0x1a9)]=exports[a452_0x5f049e(0x197)]=exports[a452_0x5f049e(0x1b6)]=void 0x0;const stripe_1=__importDefault(require('stripe')),GetSuperSettingService_1=__importDefault(require(a452_0x5f049e(0x19e))),logger_1=require(a452_0x5f049e(0x1bb)),Invoices_1=__importDefault(require(a452_0x5f049e(0x18a))),AppError_1=__importDefault(require(a452_0x5f049e(0x1a0))),PaymentGatewayServices_1=require('./PaymentGatewayServices'),stripe=new stripe_1[(a452_0x5f049e(0x1bc))](process[a452_0x5f049e(0x19a)][a452_0x5f049e(0x1b8)],{'apiVersion':a452_0x5f049e(0x1b2)});async function createStripeWebhook(){const _0x2c16b9=a452_0x5f049e;try{const _0x1f47f9=await stripe[_0x2c16b9(0x1a6)][_0x2c16b9(0x1a7)]({'url':process[_0x2c16b9(0x19a)][_0x2c16b9(0x1ac)]+'/subscription/aa/webhook','enabled_events':[_0x2c16b9(0x18d),_0x2c16b9(0x1a2)]});return logger_1[_0x2c16b9(0x19f)][_0x2c16b9(0x1b4)]({'webhookEndpoint':_0x1f47f9},_0x2c16b9(0x1b7)),_0x1f47f9;}catch(_0x5f5112){logger_1[_0x2c16b9(0x19f)][_0x2c16b9(0x193)]({'error':_0x5f5112},_0x2c16b9(0x1a3));throw new AppError_1[(_0x2c16b9(0x1bc))](_0x2c16b9(0x1a3),0x1f4);}}const stripeInitialize=async()=>{const _0x12ccd6=a452_0x5f049e,_0x517d34=await(0x0,GetSuperSettingService_1[_0x12ccd6(0x1bc)])({'key':_0x12ccd6(0x19c)});if(_0x517d34!==_0x12ccd6(0x195)){logger_1[_0x12ccd6(0x19f)][_0x12ccd6(0x1be)](_0x12ccd6(0x1b5));return;}if(!process['env'][_0x12ccd6(0x1ac)][_0x12ccd6(0x1c6)]('https://')){logger_1['logger']['debug']('stripeInitialize:\x20only\x20SSL\x20webhooks\x20are\x20supported');return;}await createStripeWebhook();};exports[a452_0x5f049e(0x1b6)]=stripeInitialize;function a452_0x4292(_0x5c43b7,_0x21609f){const _0x42e98a=a452_0x2219();return a452_0x4292=function(_0x2221f2,_0x35541d){_0x2221f2=_0x2221f2-0x188;let _0x221955=_0x42e98a[_0x2221f2];return _0x221955;},a452_0x4292(_0x5c43b7,_0x21609f);}const stripeWebhookHandler=async(_0xa613f,_0x261660)=>{const _0x493051=a452_0x5f049e,_0x1b5166=_0xa613f[_0x493051(0x1c3)];try{switch(_0x1b5166[_0x493051(0x199)]){case _0x493051(0x18d):const _0x202660=_0x1b5166[_0x493051(0x1af)][_0x493051(0x1b0)];await(0x0,PaymentGatewayServices_1['processInvoicePaid'])(_0x202660[_0x493051(0x1ba)][_0x493051(0x191)]);break;case _0x493051(0x1a2):const _0x25cf15=_0x1b5166[_0x493051(0x1af)][_0x493051(0x1b0)];logger_1[_0x493051(0x19f)][_0x493051(0x1b4)]({'failedIntent':_0x25cf15},_0x493051(0x19b));break;default:logger_1[_0x493051(0x19f)][_0x493051(0x1c5)]({'event':_0x1b5166},_0x493051(0x1cd));}return _0x261660[_0x493051(0x1a8)](0xc8)[_0x493051(0x1a4)]({'received':!![]});}catch(_0x24b9e3){return logger_1[_0x493051(0x19f)][_0x493051(0x193)]({'error':_0x24b9e3},_0x493051(0x18f)),_0x261660[_0x493051(0x1a8)](0x190)['json']({'error':_0x493051(0x1c4)});}};exports[a452_0x5f049e(0x197)]=stripeWebhookHandler;const stripeCreateSubscription=async(_0x29e46c,_0x3ce583)=>{const _0xb2cb35=a452_0x5f049e,{price:_0x49fca9,invoiceId:_0x9ffb08}=_0x29e46c['body'];try{const _0x3706ec=await stripe['paymentIntents']['create']({'amount':Math[_0xb2cb35(0x1a1)](parseFloat(_0x49fca9)*0x64),'currency':_0xb2cb35(0x18e),'metadata':{'invoiceId':_0x9ffb08}});return await Invoices_1[_0xb2cb35(0x1bc)][_0xb2cb35(0x1b3)]({'stripePaymentIntentId':_0x3706ec['id']},{'where':{'id':_0x9ffb08}}),_0x3ce583['json']({'clientSecret':_0x3706ec[_0xb2cb35(0x190)],'status':_0xb2cb35(0x1ad)});}catch(_0x703898){logger_1[_0xb2cb35(0x19f)][_0xb2cb35(0x193)]({'error':_0x703898},_0xb2cb35(0x19d));throw new AppError_1[(_0xb2cb35(0x1bc))](_0xb2cb35(0x19d),0x190);}};exports['stripeCreateSubscription']=stripeCreateSubscription;const stripeCheckStatus=async _0x41b0d7=>{const _0x172448=a452_0x5f049e;try{const _0x5a2142=await Invoices_1['default'][_0x172448(0x1c9)](_0x41b0d7);if(!_0x5a2142||!_0x5a2142[_0x172448(0x196)])return logger_1[_0x172448(0x19f)][_0x172448(0x193)]('Invoice\x20not\x20found\x20or\x20missing\x20Stripe\x20PaymentIntent\x20ID.'),![];const _0x4d080d=await stripe[_0x172448(0x1b9)][_0x172448(0x1a5)](_0x5a2142[_0x172448(0x196)]);if(_0x4d080d[_0x172448(0x1a8)]===_0x172448(0x1ae))return await(0x0,PaymentGatewayServices_1[_0x172448(0x18c)])(_0x5a2142),!![];return![];}catch(_0x31b155){return logger_1['logger'][_0x172448(0x193)]({'error':_0x31b155},_0x172448(0x198)),![];}};function a452_0x2219(){const _0x57883a=['Failed\x20to\x20create\x20subscription.','../SettingServices/GetSuperSettingService','logger','../../errors/AppError','round','payment_intent.payment_failed','Failed\x20to\x20create\x20webhook.','json','retrieve','webhookEndpoints','create','status','stripeCreateSubscription','407892oEDQed','stripeCheckStatus','BACKEND_URL','success','succeeded','data','object','707641mUZjnh','2022-11-15','update','info','stripeInitialize:\x20not\x20configured\x20for\x20Stripe.','stripeInitialize','Webhook\x20created\x20successfully.','STRIPE_PRIVATE','paymentIntents','metadata','../../utils/logger','default','constructor','debug','2406171HJCIth','11081Cgaelu','search','5048DURLfi','body','Webhook\x20handler\x20failed.','warn','startsWith','4NKwJcO','1ODOstx','findByPk','2653402LDeCqF','__esModule','711ShnUrD','Unhandled\x20event\x20type.','84MgQxnE','3317660xVPaBc','../../models/Invoices','(((.+)+)+)+$','processInvoicePaid','payment_intent.succeeded','usd','Error\x20handling\x20webhook\x20event.','client_secret','invoiceId','__importDefault','error','182610TBjgUi','stripe','stripePaymentIntentId','stripeWebhookHandler','Failed\x20to\x20check\x20payment\x20status.','type','env','Payment\x20failed.','_paymentGateway'];a452_0x2219=function(){return _0x57883a;};return a452_0x2219();}exports['stripeCheckStatus']=stripeCheckStatus;