const a450_0x271a65=a450_0x435f;(function(_0x5f12cd,_0x1cbbd8){const _0x47533e=a450_0x435f,_0x231a86=_0x5f12cd();while(!![]){try{const _0x27d31b=parseInt(_0x47533e(0xef))/0x1+parseInt(_0x47533e(0xf5))/0x2+-parseInt(_0x47533e(0xd0))/0x3*(-parseInt(_0x47533e(0xe0))/0x4)+parseInt(_0x47533e(0xca))/0x5*(-parseInt(_0x47533e(0xfa))/0x6)+parseInt(_0x47533e(0x103))/0x7+parseInt(_0x47533e(0x100))/0x8+-parseInt(_0x47533e(0xfe))/0x9;if(_0x27d31b===_0x1cbbd8)break;else _0x231a86['push'](_0x231a86['shift']());}catch(_0x1c83a8){_0x231a86['push'](_0x231a86['shift']());}}}(a450_0x3871,0xf081c));function a450_0x435f(_0x45724a,_0x32280e){const _0x20b98a=a450_0x3871();return a450_0x435f=function(_0x4ae98a,_0x561ffc){_0x4ae98a=_0x4ae98a-0xca;let _0x387143=_0x20b98a[_0x4ae98a];return _0x387143;},a450_0x435f(_0x45724a,_0x32280e);}const a450_0x561ffc=(function(){let _0x8a5c1d=!![];return function(_0x37d02c,_0x48b6ae){const _0xa3a3eb=_0x8a5c1d?function(){const _0x551263=a450_0x435f;if(_0x48b6ae){const _0x4fdd8b=_0x48b6ae[_0x551263(0x101)](_0x37d02c,arguments);return _0x48b6ae=null,_0x4fdd8b;}}:function(){};return _0x8a5c1d=![],_0xa3a3eb;};}()),a450_0x4ae98a=a450_0x561ffc(this,function(){const _0x2ca68a=a450_0x435f;return a450_0x4ae98a[_0x2ca68a(0xd3)]()[_0x2ca68a(0x108)](_0x2ca68a(0x106))[_0x2ca68a(0xd3)]()[_0x2ca68a(0xd8)](a450_0x4ae98a)[_0x2ca68a(0x108)](_0x2ca68a(0x106));});a450_0x4ae98a();'use strict';function a450_0x3871(){const _0x44331d=['defineProperty','75SbolqB','Error\x20handling\x20webhook\x20event.','stripeInitialize','toString','usd','succeeded','type','update','constructor','warn','Payment\x20failed.','../../utils/logger','logger','__esModule','default','BACKEND_URL','186692puVEbk','json','startsWith','__importDefault','../../models/Invoices','metadata','round','stripeInitialize:\x20not\x20configured\x20for\x20Stripe.','payment_intent.succeeded','Failed\x20to\x20create\x20webhook.','create','env','Failed\x20to\x20create\x20subscription.','stripeWebhookHandler','processInvoicePaid','311373WGSFMh','object','/subscription/aa/webhook','./PaymentGatewayServices','2022-11-15','info','2318374FeDYTp','paymentIntents','payment_intent.payment_failed','../../errors/AppError','STRIPE_PRIVATE','150fnBFiW','error','success','status','24327288pNceGB','stripeCheckStatus','14384920qQJPpP','apply','../SettingServices/GetSuperSettingService','4554011cwvOzc','stripePaymentIntentId','data','(((.+)+)+)+$','Webhook\x20created\x20successfully.','search','debug','stripeCreateSubscription','279585XcGCFC','body','retrieve','stripe','Webhook\x20handler\x20failed.'];a450_0x3871=function(){return _0x44331d;};return a450_0x3871();}var __importDefault=this&&this[a450_0x271a65(0xe3)]||function(_0xca7d5a){const _0x234ffc=a450_0x271a65;return _0xca7d5a&&_0xca7d5a[_0x234ffc(0xdd)]?_0xca7d5a:{'default':_0xca7d5a};};Object[a450_0x271a65(0xcf)](exports,'__esModule',{'value':!![]}),exports[a450_0x271a65(0xff)]=exports['stripeCreateSubscription']=exports[a450_0x271a65(0xed)]=exports[a450_0x271a65(0xd2)]=void 0x0;const stripe_1=__importDefault(require('stripe')),GetSuperSettingService_1=__importDefault(require(a450_0x271a65(0x102))),logger_1=require(a450_0x271a65(0xdb)),Invoices_1=__importDefault(require(a450_0x271a65(0xe4))),AppError_1=__importDefault(require(a450_0x271a65(0xf8))),PaymentGatewayServices_1=require(a450_0x271a65(0xf2)),stripe=new stripe_1[(a450_0x271a65(0xde))](process[a450_0x271a65(0xeb)][a450_0x271a65(0xf9)],{'apiVersion':a450_0x271a65(0xf3)});async function createStripeWebhook(){const _0x2ce128=a450_0x271a65;try{const _0x353111=await stripe['webhookEndpoints'][_0x2ce128(0xea)]({'url':process['env'][_0x2ce128(0xdf)]+_0x2ce128(0xf1),'enabled_events':[_0x2ce128(0xe8),_0x2ce128(0xf7)]});return logger_1[_0x2ce128(0xdc)][_0x2ce128(0xf4)]({'webhookEndpoint':_0x353111},_0x2ce128(0x107)),_0x353111;}catch(_0x2f7d00){logger_1[_0x2ce128(0xdc)][_0x2ce128(0xfb)]({'error':_0x2f7d00},_0x2ce128(0xe9));throw new AppError_1[(_0x2ce128(0xde))](_0x2ce128(0xe9),0x1f4);}}const stripeInitialize=async()=>{const _0x4f011e=a450_0x271a65,_0x2af259=await(0x0,GetSuperSettingService_1[_0x4f011e(0xde)])({'key':'_paymentGateway'});if(_0x2af259!==_0x4f011e(0xcd)){logger_1['logger'][_0x4f011e(0x109)](_0x4f011e(0xe7));return;}if(!process[_0x4f011e(0xeb)][_0x4f011e(0xdf)][_0x4f011e(0xe2)]('https://')){logger_1[_0x4f011e(0xdc)]['debug']('stripeInitialize:\x20only\x20SSL\x20webhooks\x20are\x20supported');return;}await createStripeWebhook();};exports[a450_0x271a65(0xd2)]=stripeInitialize;const stripeWebhookHandler=async(_0x1a7a06,_0x234ab5)=>{const _0x47e9ec=a450_0x271a65,_0x529133=_0x1a7a06[_0x47e9ec(0xcb)];try{switch(_0x529133[_0x47e9ec(0xd6)]){case _0x47e9ec(0xe8):const _0x53337b=_0x529133['data'][_0x47e9ec(0xf0)];await(0x0,PaymentGatewayServices_1[_0x47e9ec(0xee)])(_0x53337b[_0x47e9ec(0xe5)]['invoiceId']);break;case _0x47e9ec(0xf7):const _0x48fe64=_0x529133[_0x47e9ec(0x105)][_0x47e9ec(0xf0)];logger_1[_0x47e9ec(0xdc)][_0x47e9ec(0xf4)]({'failedIntent':_0x48fe64},_0x47e9ec(0xda));break;default:logger_1['logger'][_0x47e9ec(0xd9)]({'event':_0x529133},'Unhandled\x20event\x20type.');}return _0x234ab5[_0x47e9ec(0xfd)](0xc8)['json']({'received':!![]});}catch(_0x189fec){return logger_1[_0x47e9ec(0xdc)]['error']({'error':_0x189fec},_0x47e9ec(0xd1)),_0x234ab5[_0x47e9ec(0xfd)](0x190)['json']({'error':_0x47e9ec(0xce)});}};exports[a450_0x271a65(0xed)]=stripeWebhookHandler;const stripeCreateSubscription=async(_0x4adf66,_0x3ee214)=>{const _0x2c7202=a450_0x271a65,{price:_0x143914,invoiceId:_0x40c834}=_0x4adf66[_0x2c7202(0xcb)];try{const _0x5ab55f=await stripe['paymentIntents']['create']({'amount':Math[_0x2c7202(0xe6)](parseFloat(_0x143914)*0x64),'currency':_0x2c7202(0xd4),'metadata':{'invoiceId':_0x40c834}});return await Invoices_1[_0x2c7202(0xde)][_0x2c7202(0xd7)]({'stripePaymentIntentId':_0x5ab55f['id']},{'where':{'id':_0x40c834}}),_0x3ee214[_0x2c7202(0xe1)]({'clientSecret':_0x5ab55f['client_secret'],'status':_0x2c7202(0xfc)});}catch(_0x594a4a){logger_1['logger'][_0x2c7202(0xfb)]({'error':_0x594a4a},_0x2c7202(0xec));throw new AppError_1['default'](_0x2c7202(0xec),0x190);}};exports[a450_0x271a65(0x10a)]=stripeCreateSubscription;const stripeCheckStatus=async _0x19f3f8=>{const _0x1d0a7a=a450_0x271a65;try{const _0x30665a=await Invoices_1['default']['findByPk'](_0x19f3f8);if(!_0x30665a||!_0x30665a[_0x1d0a7a(0x104)])return logger_1[_0x1d0a7a(0xdc)][_0x1d0a7a(0xfb)]('Invoice\x20not\x20found\x20or\x20missing\x20Stripe\x20PaymentIntent\x20ID.'),![];const _0x1b790c=await stripe[_0x1d0a7a(0xf6)][_0x1d0a7a(0xcc)](_0x30665a['stripePaymentIntentId']);if(_0x1b790c[_0x1d0a7a(0xfd)]===_0x1d0a7a(0xd5))return await(0x0,PaymentGatewayServices_1[_0x1d0a7a(0xee)])(_0x30665a),!![];return![];}catch(_0x5bcabc){return logger_1[_0x1d0a7a(0xdc)][_0x1d0a7a(0xfb)]({'error':_0x5bcabc},'Failed\x20to\x20check\x20payment\x20status.'),![];}};exports[a450_0x271a65(0xff)]=stripeCheckStatus;