const a453_0xa57f36=a453_0x2f20;(function(_0x3a36af,_0x2521c4){const _0x2003ab=a453_0x2f20,_0x3ed60b=_0x3a36af();while(!![]){try{const _0xf04cfe=-parseInt(_0x2003ab(0xeb))/0x1*(parseInt(_0x2003ab(0xdf))/0x2)+parseInt(_0x2003ab(0xde))/0x3*(parseInt(_0x2003ab(0xd9))/0x4)+-parseInt(_0x2003ab(0xdc))/0x5*(-parseInt(_0x2003ab(0x103))/0x6)+-parseInt(_0x2003ab(0xcf))/0x7*(-parseInt(_0x2003ab(0x106))/0x8)+parseInt(_0x2003ab(0xe7))/0x9+-parseInt(_0x2003ab(0x109))/0xa+-parseInt(_0x2003ab(0xee))/0xb*(-parseInt(_0x2003ab(0x105))/0xc);if(_0xf04cfe===_0x2521c4)break;else _0x3ed60b['push'](_0x3ed60b['shift']());}catch(_0x37bc8c){_0x3ed60b['push'](_0x3ed60b['shift']());}}}(a453_0x373b,0x2bfd5));const a453_0x19698f=(function(){let _0x883784=!![];return function(_0x2f8466,_0x5b06cd){const _0x26e141=_0x883784?function(){const _0x18afa2=a453_0x2f20;if(_0x5b06cd){const _0x4008dc=_0x5b06cd[_0x18afa2(0x102)](_0x2f8466,arguments);return _0x5b06cd=null,_0x4008dc;}}:function(){};return _0x883784=![],_0x26e141;};}()),a453_0x3de9e7=a453_0x19698f(this,function(){const _0x59b715=a453_0x2f20;return a453_0x3de9e7[_0x59b715(0x108)]()['search'](_0x59b715(0xd5))[_0x59b715(0x108)]()[_0x59b715(0xcb)](a453_0x3de9e7)[_0x59b715(0xf7)](_0x59b715(0xd5));});function a453_0x373b(){const _0x47f067=['stripe','search','payment_intent.succeeded','stripeCheckStatus','env','warn','client_secret','logger','invoiceId','default','Invoice\x20not\x20found\x20or\x20missing\x20Stripe\x20PaymentIntent\x20ID.','error','apply','148758IqzQMz','Webhook\x20handler\x20failed.','552smAJFw','529944yOCemX','../../utils/logger','toString','3533650jnOWug','data','success','debug','object','constructor','webhookEndpoints','Failed\x20to\x20check\x20payment\x20status.','./PaymentGatewayServices','21AXPCKi','type','Payment\x20failed.','body','_paymentGateway','STRIPE_PRIVATE','(((.+)+)+)+$','info','retrieve','create','144824hpysXU','metadata','processInvoicePaid','5VxRlGZ','json','12tTJbyL','20890aSGNze','stripeInitialize:\x20only\x20SSL\x20webhooks\x20are\x20supported','paymentIntents','Failed\x20to\x20create\x20subscription.','Webhook\x20created\x20successfully.','status','payment_intent.payment_failed','__esModule','1448172UxpPTb','Failed\x20to\x20create\x20webhook.','stripeInitialize:\x20not\x20configured\x20for\x20Stripe.','findByPk','26qpomTK','stripePaymentIntentId','update','65967CfVjRE','BACKEND_URL','Unhandled\x20event\x20type.','round','../SettingServices/GetSuperSettingService','succeeded','stripeCreateSubscription','/subscription/aa/webhook'];a453_0x373b=function(){return _0x47f067;};return a453_0x373b();}a453_0x3de9e7();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x4f8460){const _0x113c22=a453_0x2f20;return _0x4f8460&&_0x4f8460[_0x113c22(0xe6)]?_0x4f8460:{'default':_0x4f8460};};function a453_0x2f20(_0x58a72e,_0x5e71eb){const _0x1c5db0=a453_0x373b();return a453_0x2f20=function(_0x3de9e7,_0x19698f){_0x3de9e7=_0x3de9e7-0xc9;let _0x373bee=_0x1c5db0[_0x3de9e7];return _0x373bee;},a453_0x2f20(_0x58a72e,_0x5e71eb);}Object['defineProperty'](exports,a453_0xa57f36(0xe6),{'value':!![]}),exports[a453_0xa57f36(0xf9)]=exports[a453_0xa57f36(0xf4)]=exports['stripeWebhookHandler']=exports['stripeInitialize']=void 0x0;const stripe_1=__importDefault(require(a453_0xa57f36(0xf6))),GetSuperSettingService_1=__importDefault(require(a453_0xa57f36(0xf2))),logger_1=require(a453_0xa57f36(0x107)),Invoices_1=__importDefault(require('../../models/Invoices')),AppError_1=__importDefault(require('../../errors/AppError')),PaymentGatewayServices_1=require(a453_0xa57f36(0xce)),stripe=new stripe_1['default'](process[a453_0xa57f36(0xfa)][a453_0xa57f36(0xd4)],{'apiVersion':'2022-11-15'});async function createStripeWebhook(){const _0x30b3c3=a453_0xa57f36;try{const _0x4be734=await stripe[_0x30b3c3(0xcc)][_0x30b3c3(0xd8)]({'url':process[_0x30b3c3(0xfa)][_0x30b3c3(0xef)]+_0x30b3c3(0xf5),'enabled_events':[_0x30b3c3(0xf8),_0x30b3c3(0xe5)]});return logger_1[_0x30b3c3(0xfd)][_0x30b3c3(0xd6)]({'webhookEndpoint':_0x4be734},_0x30b3c3(0xe3)),_0x4be734;}catch(_0x597612){logger_1['logger'][_0x30b3c3(0x101)]({'error':_0x597612},_0x30b3c3(0xe8));throw new AppError_1[(_0x30b3c3(0xff))](_0x30b3c3(0xe8),0x1f4);}}const stripeInitialize=async()=>{const _0x2f6ec6=a453_0xa57f36,_0x15bd13=await(0x0,GetSuperSettingService_1[_0x2f6ec6(0xff)])({'key':_0x2f6ec6(0xd3)});if(_0x15bd13!=='stripe'){logger_1[_0x2f6ec6(0xfd)]['debug'](_0x2f6ec6(0xe9));return;}if(!process[_0x2f6ec6(0xfa)][_0x2f6ec6(0xef)]['startsWith']('https://')){logger_1['logger'][_0x2f6ec6(0xc9)](_0x2f6ec6(0xe0));return;}await createStripeWebhook();};exports['stripeInitialize']=stripeInitialize;const stripeWebhookHandler=async(_0x4126a5,_0x1da8e2)=>{const _0xbbf201=a453_0xa57f36,_0x36453b=_0x4126a5[_0xbbf201(0xd2)];try{switch(_0x36453b[_0xbbf201(0xd0)]){case _0xbbf201(0xf8):const _0x4f9a60=_0x36453b[_0xbbf201(0x10a)][_0xbbf201(0xca)];await(0x0,PaymentGatewayServices_1[_0xbbf201(0xdb)])(_0x4f9a60[_0xbbf201(0xda)][_0xbbf201(0xfe)]);break;case _0xbbf201(0xe5):const _0x55f4d7=_0x36453b[_0xbbf201(0x10a)]['object'];logger_1['logger'][_0xbbf201(0xd6)]({'failedIntent':_0x55f4d7},_0xbbf201(0xd1));break;default:logger_1['logger'][_0xbbf201(0xfb)]({'event':_0x36453b},_0xbbf201(0xf0));}return _0x1da8e2[_0xbbf201(0xe4)](0xc8)[_0xbbf201(0xdd)]({'received':!![]});}catch(_0xca0f46){return logger_1['logger'][_0xbbf201(0x101)]({'error':_0xca0f46},'Error\x20handling\x20webhook\x20event.'),_0x1da8e2[_0xbbf201(0xe4)](0x190)[_0xbbf201(0xdd)]({'error':_0xbbf201(0x104)});}};exports['stripeWebhookHandler']=stripeWebhookHandler;const stripeCreateSubscription=async(_0x442a8a,_0x1fcb1d)=>{const _0x1ba264=a453_0xa57f36,{price:_0x530ee5,invoiceId:_0x266cc3}=_0x442a8a[_0x1ba264(0xd2)];try{const _0x505e41=await stripe[_0x1ba264(0xe1)][_0x1ba264(0xd8)]({'amount':Math[_0x1ba264(0xf1)](parseFloat(_0x530ee5)*0x64),'currency':'usd','metadata':{'invoiceId':_0x266cc3}});return await Invoices_1['default'][_0x1ba264(0xed)]({'stripePaymentIntentId':_0x505e41['id']},{'where':{'id':_0x266cc3}}),_0x1fcb1d[_0x1ba264(0xdd)]({'clientSecret':_0x505e41[_0x1ba264(0xfc)],'status':_0x1ba264(0x10b)});}catch(_0x3e5fb0){logger_1[_0x1ba264(0xfd)][_0x1ba264(0x101)]({'error':_0x3e5fb0},_0x1ba264(0xe2));throw new AppError_1['default'](_0x1ba264(0xe2),0x190);}};exports['stripeCreateSubscription']=stripeCreateSubscription;const stripeCheckStatus=async _0x277737=>{const _0x1ec8f5=a453_0xa57f36;try{const _0x305a32=await Invoices_1[_0x1ec8f5(0xff)][_0x1ec8f5(0xea)](_0x277737);if(!_0x305a32||!_0x305a32['stripePaymentIntentId'])return logger_1[_0x1ec8f5(0xfd)][_0x1ec8f5(0x101)](_0x1ec8f5(0x100)),![];const _0x2be9e4=await stripe['paymentIntents'][_0x1ec8f5(0xd7)](_0x305a32[_0x1ec8f5(0xec)]);if(_0x2be9e4[_0x1ec8f5(0xe4)]===_0x1ec8f5(0xf3))return await(0x0,PaymentGatewayServices_1[_0x1ec8f5(0xdb)])(_0x305a32),!![];return![];}catch(_0x48b591){return logger_1['logger'][_0x1ec8f5(0x101)]({'error':_0x48b591},_0x1ec8f5(0xcd)),![];}};exports[a453_0xa57f36(0xf9)]=stripeCheckStatus;