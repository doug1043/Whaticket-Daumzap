const a454_0x54271a=a454_0x3d26;(function(_0x280e85,_0x4b796a){const _0x356edf=a454_0x3d26,_0x5083a0=_0x280e85();while(!![]){try{const _0xf4ef36=-parseInt(_0x356edf(0x1ba))/0x1*(-parseInt(_0x356edf(0x1a9))/0x2)+-parseInt(_0x356edf(0x1d6))/0x3*(parseInt(_0x356edf(0x1c2))/0x4)+-parseInt(_0x356edf(0x1e1))/0x5*(parseInt(_0x356edf(0x1e4))/0x6)+parseInt(_0x356edf(0x1cd))/0x7*(-parseInt(_0x356edf(0x1b8))/0x8)+parseInt(_0x356edf(0x1e6))/0x9+-parseInt(_0x356edf(0x1a8))/0xa*(-parseInt(_0x356edf(0x1d2))/0xb)+parseInt(_0x356edf(0x1e5))/0xc*(parseInt(_0x356edf(0x1d3))/0xd);if(_0xf4ef36===_0x4b796a)break;else _0x5083a0['push'](_0x5083a0['shift']());}catch(_0x82f6e1){_0x5083a0['push'](_0x5083a0['shift']());}}}(a454_0x3212,0x36449));const a454_0x4bdbc2=(function(){let _0x4c12ae=!![];return function(_0x1f2b0b,_0x806c45){const _0x59a6ac=_0x4c12ae?function(){const _0x3abfcb=a454_0x3d26;if(_0x806c45){const _0x3e4f64=_0x806c45[_0x3abfcb(0x1c4)](_0x1f2b0b,arguments);return _0x806c45=null,_0x3e4f64;}}:function(){};return _0x4c12ae=![],_0x59a6ac;};}()),a454_0x1812e6=a454_0x4bdbc2(this,function(){const _0x56bbbe=a454_0x3d26;return a454_0x1812e6['toString']()['search']('(((.+)+)+)+$')[_0x56bbbe(0x1cc)]()['constructor'](a454_0x1812e6)[_0x56bbbe(0x1e2)]('(((.+)+)+)+$');});a454_0x1812e6();'use strict';function a454_0x3d26(_0x31a6c3,_0xc0343a){const _0x950b20=a454_0x3212();return a454_0x3d26=function(_0x1812e6,_0x4bdbc2){_0x1812e6=_0x1812e6-0x1a7;let _0x321234=_0x950b20[_0x1812e6];return _0x321234;},a454_0x3d26(_0x31a6c3,_0xc0343a);}var __importDefault=this&&this[a454_0x54271a(0x1c6)]||function(_0x4852f9){const _0xe58d7a=a454_0x54271a;return _0x4852f9&&_0x4852f9[_0xe58d7a(0x1dc)]?_0x4852f9:{'default':_0x4852f9};};Object[a454_0x54271a(0x1c5)](exports,a454_0x54271a(0x1dc),{'value':!![]}),exports[a454_0x54271a(0x1e3)]=exports[a454_0x54271a(0x1d8)]=exports[a454_0x54271a(0x1be)]=exports['stripeInitialize']=void 0x0;const stripe_1=__importDefault(require(a454_0x54271a(0x1b3))),GetSuperSettingService_1=__importDefault(require('../SettingServices/GetSuperSettingService')),logger_1=require(a454_0x54271a(0x1de)),Invoices_1=__importDefault(require(a454_0x54271a(0x1bb))),AppError_1=__importDefault(require(a454_0x54271a(0x1e7))),PaymentGatewayServices_1=require(a454_0x54271a(0x1b9)),stripe=new stripe_1[(a454_0x54271a(0x1c0))](process[a454_0x54271a(0x1c7)][a454_0x54271a(0x1ca)],{'apiVersion':a454_0x54271a(0x1ac)});async function createStripeWebhook(){const _0x3b6ac9=a454_0x54271a;try{const _0x343d8d=await stripe[_0x3b6ac9(0x1ad)][_0x3b6ac9(0x1d4)]({'url':process[_0x3b6ac9(0x1c7)][_0x3b6ac9(0x1b4)]+'/subscription/aa/webhook','enabled_events':[_0x3b6ac9(0x1d9),_0x3b6ac9(0x1b2)]});return logger_1[_0x3b6ac9(0x1e8)][_0x3b6ac9(0x1cb)]({'webhookEndpoint':_0x343d8d},'Webhook\x20created\x20successfully.'),_0x343d8d;}catch(_0xcce360){logger_1[_0x3b6ac9(0x1e8)]['error']({'error':_0xcce360},_0x3b6ac9(0x1b6));throw new AppError_1[(_0x3b6ac9(0x1c0))](_0x3b6ac9(0x1b6),0x1f4);}}function a454_0x3212(){const _0x26fa05=['stripeInitialize:\x20not\x20configured\x20for\x20Stripe.','payment_intent.payment_failed','stripe','BACKEND_URL','paymentIntents','Failed\x20to\x20create\x20webhook.','succeeded','128vWYdqQ','./PaymentGatewayServices','400965klkaed','../../models/Invoices','startsWith','https://','stripeWebhookHandler','status','default','round','92iZwaKU','processInvoicePaid','apply','defineProperty','__importDefault','env','Failed\x20to\x20create\x20subscription.','Payment\x20failed.','STRIPE_PRIVATE','info','toString','159334uKYUWG','Unhandled\x20event\x20type.','warn','object','stripeInitialize:\x20only\x20SSL\x20webhooks\x20are\x20supported','2838407xSguYc','347867NDDPMA','create','debug','55956RjlQZy','retrieve','stripeCreateSubscription','payment_intent.succeeded','success','findByPk','__esModule','Webhook\x20handler\x20failed.','../../utils/logger','stripeInitialize','json','345MKAaeo','search','stripeCheckStatus','36402TszDFF','168hbfVoV','3604176zdNpmt','../../errors/AppError','logger','invoiceId','10LOVmZl','2lGVnyy','Invoice\x20not\x20found\x20or\x20missing\x20Stripe\x20PaymentIntent\x20ID.','Failed\x20to\x20check\x20payment\x20status.','2022-11-15','webhookEndpoints','Error\x20handling\x20webhook\x20event.','error','body'];a454_0x3212=function(){return _0x26fa05;};return a454_0x3212();}const stripeInitialize=async()=>{const _0x82a244=a454_0x54271a,_0x19fdf6=await(0x0,GetSuperSettingService_1[_0x82a244(0x1c0)])({'key':'_paymentGateway'});if(_0x19fdf6!==_0x82a244(0x1b3)){logger_1[_0x82a244(0x1e8)][_0x82a244(0x1d5)](_0x82a244(0x1b1));return;}if(!process[_0x82a244(0x1c7)]['BACKEND_URL'][_0x82a244(0x1bc)](_0x82a244(0x1bd))){logger_1[_0x82a244(0x1e8)][_0x82a244(0x1d5)](_0x82a244(0x1d1));return;}await createStripeWebhook();};exports[a454_0x54271a(0x1df)]=stripeInitialize;const stripeWebhookHandler=async(_0x19c693,_0x5d7b67)=>{const _0x3064f9=a454_0x54271a,_0x19d1f0=_0x19c693[_0x3064f9(0x1b0)];try{switch(_0x19d1f0['type']){case _0x3064f9(0x1d9):const _0x1240ce=_0x19d1f0['data'][_0x3064f9(0x1d0)];await(0x0,PaymentGatewayServices_1[_0x3064f9(0x1c3)])(_0x1240ce['metadata'][_0x3064f9(0x1a7)]);break;case _0x3064f9(0x1b2):const _0x32a62d=_0x19d1f0['data'][_0x3064f9(0x1d0)];logger_1[_0x3064f9(0x1e8)][_0x3064f9(0x1cb)]({'failedIntent':_0x32a62d},_0x3064f9(0x1c9));break;default:logger_1['logger'][_0x3064f9(0x1cf)]({'event':_0x19d1f0},_0x3064f9(0x1ce));}return _0x5d7b67[_0x3064f9(0x1bf)](0xc8)[_0x3064f9(0x1e0)]({'received':!![]});}catch(_0x4e0aea){return logger_1[_0x3064f9(0x1e8)]['error']({'error':_0x4e0aea},_0x3064f9(0x1ae)),_0x5d7b67[_0x3064f9(0x1bf)](0x190)[_0x3064f9(0x1e0)]({'error':_0x3064f9(0x1dd)});}};exports[a454_0x54271a(0x1be)]=stripeWebhookHandler;const stripeCreateSubscription=async(_0x229717,_0x21c780)=>{const _0x58a924=a454_0x54271a,{price:_0xaa78e8,invoiceId:_0x12d026}=_0x229717[_0x58a924(0x1b0)];try{const _0x218b77=await stripe[_0x58a924(0x1b5)][_0x58a924(0x1d4)]({'amount':Math[_0x58a924(0x1c1)](parseFloat(_0xaa78e8)*0x64),'currency':'usd','metadata':{'invoiceId':_0x12d026}});return await Invoices_1[_0x58a924(0x1c0)]['update']({'stripePaymentIntentId':_0x218b77['id']},{'where':{'id':_0x12d026}}),_0x21c780[_0x58a924(0x1e0)]({'clientSecret':_0x218b77['client_secret'],'status':_0x58a924(0x1da)});}catch(_0x537dfd){logger_1['logger']['error']({'error':_0x537dfd},'Failed\x20to\x20create\x20subscription.');throw new AppError_1[(_0x58a924(0x1c0))](_0x58a924(0x1c8),0x190);}};exports['stripeCreateSubscription']=stripeCreateSubscription;const stripeCheckStatus=async _0xb1348c=>{const _0x2e4d40=a454_0x54271a;try{const _0x1524c7=await Invoices_1[_0x2e4d40(0x1c0)][_0x2e4d40(0x1db)](_0xb1348c);if(!_0x1524c7||!_0x1524c7['stripePaymentIntentId'])return logger_1[_0x2e4d40(0x1e8)][_0x2e4d40(0x1af)](_0x2e4d40(0x1aa)),![];const _0x2aba82=await stripe[_0x2e4d40(0x1b5)][_0x2e4d40(0x1d7)](_0x1524c7['stripePaymentIntentId']);if(_0x2aba82[_0x2e4d40(0x1bf)]===_0x2e4d40(0x1b7))return await(0x0,PaymentGatewayServices_1[_0x2e4d40(0x1c3)])(_0x1524c7),!![];return![];}catch(_0x733892){return logger_1['logger'][_0x2e4d40(0x1af)]({'error':_0x733892},_0x2e4d40(0x1ab)),![];}};exports[a454_0x54271a(0x1e3)]=stripeCheckStatus;