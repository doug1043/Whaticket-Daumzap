const a454_0x11f915=a454_0x111d;(function(_0x3c2a1a,_0x18f595){const _0x5e168a=a454_0x111d,_0x409400=_0x3c2a1a();while(!![]){try{const _0x3538b0=-parseInt(_0x5e168a(0x112))/0x1+-parseInt(_0x5e168a(0x10b))/0x2*(parseInt(_0x5e168a(0x102))/0x3)+-parseInt(_0x5e168a(0xf6))/0x4*(-parseInt(_0x5e168a(0x11a))/0x5)+parseInt(_0x5e168a(0x125))/0x6+-parseInt(_0x5e168a(0x116))/0x7+parseInt(_0x5e168a(0xf1))/0x8+parseInt(_0x5e168a(0xec))/0x9*(parseInt(_0x5e168a(0xfc))/0xa);if(_0x3538b0===_0x18f595)break;else _0x409400['push'](_0x409400['shift']());}catch(_0x7dfd76){_0x409400['push'](_0x409400['shift']());}}}(a454_0x8c82,0x40a2d));const a454_0xd7df41=(function(){let _0x266094=!![];return function(_0x3de962,_0x341cfa){const _0x1db9b3=_0x266094?function(){const _0x2c989e=a454_0x111d;if(_0x341cfa){const _0x1de1c2=_0x341cfa[_0x2c989e(0x11e)](_0x3de962,arguments);return _0x341cfa=null,_0x1de1c2;}}:function(){};return _0x266094=![],_0x1db9b3;};}()),a454_0x42b935=a454_0xd7df41(this,function(){const _0x2217cd=a454_0x111d;return a454_0x42b935['toString']()[_0x2217cd(0xf0)]('(((.+)+)+)+$')['toString']()[_0x2217cd(0x104)](a454_0x42b935)['search'](_0x2217cd(0xeb));});a454_0x42b935();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x193cb4){const _0x58cb1b=a454_0x111d;return _0x193cb4&&_0x193cb4[_0x58cb1b(0x127)]?_0x193cb4:{'default':_0x193cb4};};Object[a454_0x11f915(0xee)](exports,a454_0x11f915(0x127),{'value':!![]}),exports[a454_0x11f915(0xf8)]=exports['stripeCreateSubscription']=exports['stripeWebhookHandler']=exports[a454_0x11f915(0x10d)]=void 0x0;const stripe_1=__importDefault(require(a454_0x11f915(0x106))),GetSuperSettingService_1=__importDefault(require(a454_0x11f915(0x109))),logger_1=require(a454_0x11f915(0x120)),Invoices_1=__importDefault(require(a454_0x11f915(0x105))),AppError_1=__importDefault(require(a454_0x11f915(0xf7))),PaymentGatewayServices_1=require(a454_0x11f915(0xfd)),stripe=new stripe_1[(a454_0x11f915(0xf5))](process[a454_0x11f915(0x11f)][a454_0x11f915(0x115)],{'apiVersion':a454_0x11f915(0x126)});async function createStripeWebhook(){const _0x483e01=a454_0x11f915;try{const _0x203163=await stripe[_0x483e01(0x11d)][_0x483e01(0x108)]({'url':process['env'][_0x483e01(0x100)]+_0x483e01(0xfb),'enabled_events':['payment_intent.succeeded','payment_intent.payment_failed']});return logger_1[_0x483e01(0xed)][_0x483e01(0xf9)]({'webhookEndpoint':_0x203163},_0x483e01(0x118)),_0x203163;}catch(_0x5da51b){logger_1['logger'][_0x483e01(0x122)]({'error':_0x5da51b},_0x483e01(0xf2));throw new AppError_1[(_0x483e01(0xf5))]('Failed\x20to\x20create\x20webhook.',0x1f4);}}const stripeInitialize=async()=>{const _0x46fa54=a454_0x11f915,_0x121e8b=await(0x0,GetSuperSettingService_1[_0x46fa54(0xf5)])({'key':'_paymentGateway'});if(_0x121e8b!==_0x46fa54(0x106)){logger_1[_0x46fa54(0xed)][_0x46fa54(0xff)]('stripeInitialize:\x20not\x20configured\x20for\x20Stripe.');return;}if(!process[_0x46fa54(0x11f)][_0x46fa54(0x100)]['startsWith'](_0x46fa54(0x124))){logger_1['logger'][_0x46fa54(0xff)](_0x46fa54(0xfa));return;}await createStripeWebhook();};exports['stripeInitialize']=stripeInitialize;function a454_0x8c82(){const _0x2d4df6=['info','stripeInitialize:\x20only\x20SSL\x20webhooks\x20are\x20supported','/subscription/aa/webhook','20fgFVXc','./PaymentGatewayServices','body','debug','BACKEND_URL','Unhandled\x20event\x20type.','327sOLhLY','stripePaymentIntentId','constructor','../../models/Invoices','stripe','status','create','../SettingServices/GetSuperSettingService','findByPk','4482IIdUMH','Payment\x20failed.','stripeInitialize','stripeWebhookHandler','paymentIntents','Failed\x20to\x20create\x20subscription.','invoiceId','487522AIkvfx','update','Webhook\x20handler\x20failed.','STRIPE_PRIVATE','2904594lmqemY','usd','Webhook\x20created\x20successfully.','type','1738305qHnSmc','json','succeeded','webhookEndpoints','apply','env','../../utils/logger','object','error','processInvoicePaid','https://','819246jfBPvi','2022-11-15','__esModule','retrieve','data','(((.+)+)+)+$','2323269TuoCMJ','logger','defineProperty','payment_intent.succeeded','search','3287984QXMjqU','Failed\x20to\x20create\x20webhook.','Failed\x20to\x20check\x20payment\x20status.','warn','default','4KanJgP','../../errors/AppError','stripeCheckStatus'];a454_0x8c82=function(){return _0x2d4df6;};return a454_0x8c82();}const stripeWebhookHandler=async(_0x2bba73,_0x53bf1f)=>{const _0x413449=a454_0x11f915,_0x5ea660=_0x2bba73[_0x413449(0xfe)];try{switch(_0x5ea660[_0x413449(0x119)]){case _0x413449(0xef):const _0x135d4a=_0x5ea660[_0x413449(0xea)][_0x413449(0x121)];await(0x0,PaymentGatewayServices_1[_0x413449(0x123)])(_0x135d4a['metadata'][_0x413449(0x111)]);break;case'payment_intent.payment_failed':const _0x1d41f5=_0x5ea660[_0x413449(0xea)][_0x413449(0x121)];logger_1[_0x413449(0xed)]['info']({'failedIntent':_0x1d41f5},_0x413449(0x10c));break;default:logger_1[_0x413449(0xed)][_0x413449(0xf4)]({'event':_0x5ea660},_0x413449(0x101));}return _0x53bf1f[_0x413449(0x107)](0xc8)['json']({'received':!![]});}catch(_0x38660b){return logger_1[_0x413449(0xed)]['error']({'error':_0x38660b},'Error\x20handling\x20webhook\x20event.'),_0x53bf1f[_0x413449(0x107)](0x190)[_0x413449(0x11b)]({'error':_0x413449(0x114)});}};function a454_0x111d(_0x547b90,_0x3150b1){const _0x2b8895=a454_0x8c82();return a454_0x111d=function(_0x42b935,_0xd7df41){_0x42b935=_0x42b935-0xe9;let _0x8c82fe=_0x2b8895[_0x42b935];return _0x8c82fe;},a454_0x111d(_0x547b90,_0x3150b1);}exports[a454_0x11f915(0x10e)]=stripeWebhookHandler;const stripeCreateSubscription=async(_0x3c4dd7,_0x5f4b8f)=>{const _0x4205bc=a454_0x11f915,{price:_0x224ab4,invoiceId:_0x5823fe}=_0x3c4dd7[_0x4205bc(0xfe)];try{const _0x36fa44=await stripe[_0x4205bc(0x10f)][_0x4205bc(0x108)]({'amount':Math['round'](parseFloat(_0x224ab4)*0x64),'currency':_0x4205bc(0x117),'metadata':{'invoiceId':_0x5823fe}});return await Invoices_1[_0x4205bc(0xf5)][_0x4205bc(0x113)]({'stripePaymentIntentId':_0x36fa44['id']},{'where':{'id':_0x5823fe}}),_0x5f4b8f[_0x4205bc(0x11b)]({'clientSecret':_0x36fa44['client_secret'],'status':'success'});}catch(_0x47dfc3){logger_1[_0x4205bc(0xed)]['error']({'error':_0x47dfc3},_0x4205bc(0x110));throw new AppError_1[(_0x4205bc(0xf5))](_0x4205bc(0x110),0x190);}};exports['stripeCreateSubscription']=stripeCreateSubscription;const stripeCheckStatus=async _0x5d2e6b=>{const _0x2f2c6d=a454_0x11f915;try{const _0x148487=await Invoices_1[_0x2f2c6d(0xf5)][_0x2f2c6d(0x10a)](_0x5d2e6b);if(!_0x148487||!_0x148487[_0x2f2c6d(0x103)])return logger_1[_0x2f2c6d(0xed)][_0x2f2c6d(0x122)]('Invoice\x20not\x20found\x20or\x20missing\x20Stripe\x20PaymentIntent\x20ID.'),![];const _0xf9d1a1=await stripe[_0x2f2c6d(0x10f)][_0x2f2c6d(0xe9)](_0x148487[_0x2f2c6d(0x103)]);if(_0xf9d1a1[_0x2f2c6d(0x107)]===_0x2f2c6d(0x11c))return await(0x0,PaymentGatewayServices_1[_0x2f2c6d(0x123)])(_0x148487),!![];return![];}catch(_0x299ebe){return logger_1[_0x2f2c6d(0xed)]['error']({'error':_0x299ebe},_0x2f2c6d(0xf3)),![];}};exports[a454_0x11f915(0xf8)]=stripeCheckStatus;