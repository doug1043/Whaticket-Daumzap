const a452_0x2bffc2=a452_0x2037;(function(_0x2bbb7d,_0x324b0f){const _0x48b2ee=a452_0x2037,_0x4018cd=_0x2bbb7d();while(!![]){try{const _0x1cbb8e=parseInt(_0x48b2ee(0x108))/0x1+-parseInt(_0x48b2ee(0x109))/0x2*(-parseInt(_0x48b2ee(0x103))/0x3)+parseInt(_0x48b2ee(0xe8))/0x4+parseInt(_0x48b2ee(0xde))/0x5*(parseInt(_0x48b2ee(0xdf))/0x6)+parseInt(_0x48b2ee(0xdb))/0x7+parseInt(_0x48b2ee(0xed))/0x8+-parseInt(_0x48b2ee(0xf1))/0x9;if(_0x1cbb8e===_0x324b0f)break;else _0x4018cd['push'](_0x4018cd['shift']());}catch(_0x1b691d){_0x4018cd['push'](_0x4018cd['shift']());}}}(a452_0x49da,0xf1c71));function a452_0x49da(){const _0xafe71c=['stripeInitialize:\x20only\x20SSL\x20webhooks\x20are\x20supported','__importDefault','Error\x20handling\x20webhook\x20event.','payment_intent.payment_failed','body','logger','stripePaymentIntentId','../SettingServices/GetSuperSettingService','/subscription/aa/webhook','stripeCheckStatus','Webhook\x20handler\x20failed.','success','Failed\x20to\x20create\x20subscription.','paymentIntents','Webhook\x20created\x20successfully.','Invoice\x20not\x20found\x20or\x20missing\x20Stripe\x20PaymentIntent\x20ID.','__esModule','21vpgvMx','error','round','../../models/Invoices','object','368734DJIgkc','378258tSIKQn','payment_intent.succeeded','env','../../utils/logger','stripeWebhookHandler','debug','https://','stripeCreateSubscription','create','info','Payment\x20failed.','toString','default','stripeInitialize','search','client_secret','type','defineProperty','9701776vIzOlu','data','succeeded','5iCbIKN','3008202EHccsc','Failed\x20to\x20check\x20payment\x20status.','constructor','json','processInvoicePaid','status','usd','_paymentGateway','Failed\x20to\x20create\x20webhook.','7604964luMJuB','(((.+)+)+)+$','BACKEND_URL','webhookEndpoints','Unhandled\x20event\x20type.','2873064lBaKKS','STRIPE_PRIVATE','stripe','findByPk','43650225YRmJHr'];a452_0x49da=function(){return _0xafe71c;};return a452_0x49da();}const a452_0x4c4f42=(function(){let _0x50dae4=!![];return function(_0x1cbaa8,_0xa60a1b){const _0x4c281a=_0x50dae4?function(){if(_0xa60a1b){const _0x2d38af=_0xa60a1b['apply'](_0x1cbaa8,arguments);return _0xa60a1b=null,_0x2d38af;}}:function(){};return _0x50dae4=![],_0x4c281a;};}()),a452_0x4cf5c4=a452_0x4c4f42(this,function(){const _0xdf84af=a452_0x2037;return a452_0x4cf5c4[_0xdf84af(0x114)]()[_0xdf84af(0xd7)](_0xdf84af(0xe9))['toString']()[_0xdf84af(0xe1)](a452_0x4cf5c4)[_0xdf84af(0xd7)](_0xdf84af(0xe9));});a452_0x4cf5c4();'use strict';var __importDefault=this&&this[a452_0x2bffc2(0xf3)]||function(_0x4513b1){const _0x32cbed=a452_0x2bffc2;return _0x4513b1&&_0x4513b1[_0x32cbed(0x102)]?_0x4513b1:{'default':_0x4513b1};};Object[a452_0x2bffc2(0xda)](exports,a452_0x2bffc2(0x102),{'value':!![]}),exports[a452_0x2bffc2(0xfb)]=exports['stripeCreateSubscription']=exports[a452_0x2bffc2(0x10d)]=exports[a452_0x2bffc2(0xd6)]=void 0x0;const stripe_1=__importDefault(require(a452_0x2bffc2(0xef))),GetSuperSettingService_1=__importDefault(require(a452_0x2bffc2(0xf9))),logger_1=require(a452_0x2bffc2(0x10c)),Invoices_1=__importDefault(require(a452_0x2bffc2(0x106))),AppError_1=__importDefault(require('../../errors/AppError')),PaymentGatewayServices_1=require('./PaymentGatewayServices'),stripe=new stripe_1[(a452_0x2bffc2(0x115))](process[a452_0x2bffc2(0x10b)][a452_0x2bffc2(0xee)],{'apiVersion':'2022-11-15'});async function createStripeWebhook(){const _0x250cf0=a452_0x2bffc2;try{const _0x198764=await stripe[_0x250cf0(0xeb)][_0x250cf0(0x111)]({'url':process[_0x250cf0(0x10b)][_0x250cf0(0xea)]+_0x250cf0(0xfa),'enabled_events':[_0x250cf0(0x10a),_0x250cf0(0xf5)]});return logger_1['logger']['info']({'webhookEndpoint':_0x198764},_0x250cf0(0x100)),_0x198764;}catch(_0x15cef6){logger_1[_0x250cf0(0xf7)]['error']({'error':_0x15cef6},_0x250cf0(0xe7));throw new AppError_1[(_0x250cf0(0x115))](_0x250cf0(0xe7),0x1f4);}}const stripeInitialize=async()=>{const _0x70c2cd=a452_0x2bffc2,_0x2bc3db=await(0x0,GetSuperSettingService_1['default'])({'key':_0x70c2cd(0xe6)});if(_0x2bc3db!=='stripe'){logger_1[_0x70c2cd(0xf7)][_0x70c2cd(0x10e)]('stripeInitialize:\x20not\x20configured\x20for\x20Stripe.');return;}if(!process[_0x70c2cd(0x10b)][_0x70c2cd(0xea)]['startsWith'](_0x70c2cd(0x10f))){logger_1[_0x70c2cd(0xf7)][_0x70c2cd(0x10e)](_0x70c2cd(0xf2));return;}await createStripeWebhook();};exports[a452_0x2bffc2(0xd6)]=stripeInitialize;const stripeWebhookHandler=async(_0x1d7a87,_0x45fe08)=>{const _0x2f8ff1=a452_0x2bffc2,_0xa69ef5=_0x1d7a87[_0x2f8ff1(0xf6)];try{switch(_0xa69ef5[_0x2f8ff1(0xd9)]){case _0x2f8ff1(0x10a):const _0x111f38=_0xa69ef5[_0x2f8ff1(0xdc)][_0x2f8ff1(0x107)];await(0x0,PaymentGatewayServices_1[_0x2f8ff1(0xe3)])(_0x111f38['metadata']['invoiceId']);break;case _0x2f8ff1(0xf5):const _0x3527d6=_0xa69ef5['data'][_0x2f8ff1(0x107)];logger_1[_0x2f8ff1(0xf7)][_0x2f8ff1(0x112)]({'failedIntent':_0x3527d6},_0x2f8ff1(0x113));break;default:logger_1[_0x2f8ff1(0xf7)]['warn']({'event':_0xa69ef5},_0x2f8ff1(0xec));}return _0x45fe08['status'](0xc8)[_0x2f8ff1(0xe2)]({'received':!![]});}catch(_0x41f54a){return logger_1[_0x2f8ff1(0xf7)][_0x2f8ff1(0x104)]({'error':_0x41f54a},_0x2f8ff1(0xf4)),_0x45fe08['status'](0x190)['json']({'error':_0x2f8ff1(0xfc)});}};function a452_0x2037(_0x2911ae,_0x308464){const _0x1928ee=a452_0x49da();return a452_0x2037=function(_0x4cf5c4,_0x4c4f42){_0x4cf5c4=_0x4cf5c4-0xd6;let _0x49dafb=_0x1928ee[_0x4cf5c4];return _0x49dafb;},a452_0x2037(_0x2911ae,_0x308464);}exports[a452_0x2bffc2(0x10d)]=stripeWebhookHandler;const stripeCreateSubscription=async(_0xe8117,_0x5e55c5)=>{const _0x372c16=a452_0x2bffc2,{price:_0x1985f3,invoiceId:_0x558457}=_0xe8117[_0x372c16(0xf6)];try{const _0xa8306=await stripe[_0x372c16(0xff)]['create']({'amount':Math[_0x372c16(0x105)](parseFloat(_0x1985f3)*0x64),'currency':_0x372c16(0xe5),'metadata':{'invoiceId':_0x558457}});return await Invoices_1[_0x372c16(0x115)]['update']({'stripePaymentIntentId':_0xa8306['id']},{'where':{'id':_0x558457}}),_0x5e55c5[_0x372c16(0xe2)]({'clientSecret':_0xa8306[_0x372c16(0xd8)],'status':_0x372c16(0xfd)});}catch(_0x58df41){logger_1['logger'][_0x372c16(0x104)]({'error':_0x58df41},_0x372c16(0xfe));throw new AppError_1[(_0x372c16(0x115))](_0x372c16(0xfe),0x190);}};exports[a452_0x2bffc2(0x110)]=stripeCreateSubscription;const stripeCheckStatus=async _0x119be3=>{const _0x256b64=a452_0x2bffc2;try{const _0x385c92=await Invoices_1[_0x256b64(0x115)][_0x256b64(0xf0)](_0x119be3);if(!_0x385c92||!_0x385c92[_0x256b64(0xf8)])return logger_1['logger'][_0x256b64(0x104)](_0x256b64(0x101)),![];const _0x448b33=await stripe[_0x256b64(0xff)]['retrieve'](_0x385c92['stripePaymentIntentId']);if(_0x448b33[_0x256b64(0xe4)]===_0x256b64(0xdd))return await(0x0,PaymentGatewayServices_1[_0x256b64(0xe3)])(_0x385c92),!![];return![];}catch(_0x5e58d2){return logger_1[_0x256b64(0xf7)][_0x256b64(0x104)]({'error':_0x5e58d2},_0x256b64(0xe0)),![];}};exports[a452_0x2bffc2(0xfb)]=stripeCheckStatus;