const a483_0x12f30c=a483_0x1077;(function(_0x54fd5e,_0x287270){const _0x2dc7fd=a483_0x1077,_0x12d0e8=_0x54fd5e();while(!![]){try{const _0x511297=-parseInt(_0x2dc7fd(0xf2))/0x1*(-parseInt(_0x2dc7fd(0xf6))/0x2)+parseInt(_0x2dc7fd(0x109))/0x3+-parseInt(_0x2dc7fd(0x111))/0x4*(parseInt(_0x2dc7fd(0xeb))/0x5)+parseInt(_0x2dc7fd(0x10a))/0x6*(parseInt(_0x2dc7fd(0xf5))/0x7)+-parseInt(_0x2dc7fd(0x10d))/0x8*(-parseInt(_0x2dc7fd(0xf0))/0x9)+parseInt(_0x2dc7fd(0x115))/0xa*(parseInt(_0x2dc7fd(0x106))/0xb)+parseInt(_0x2dc7fd(0x11d))/0xc*(-parseInt(_0x2dc7fd(0xe5))/0xd);if(_0x511297===_0x287270)break;else _0x12d0e8['push'](_0x12d0e8['shift']());}catch(_0x54986f){_0x12d0e8['push'](_0x12d0e8['shift']());}}}(a483_0x32d1,0x2b98d));const a483_0x475923=(function(){let _0x2cb4fc=!![];return function(_0x165312,_0x4fe9d6){const _0x3e465b=_0x2cb4fc?function(){const _0x239bd7=a483_0x1077;if(_0x4fe9d6){const _0x5c6ee8=_0x4fe9d6[_0x239bd7(0xdd)](_0x165312,arguments);return _0x4fe9d6=null,_0x5c6ee8;}}:function(){};return _0x2cb4fc=![],_0x3e465b;};}()),a483_0x1d2bf9=a483_0x475923(this,function(){const _0x54eb2b=a483_0x1077;return a483_0x1d2bf9[_0x54eb2b(0xde)]()[_0x54eb2b(0xed)](_0x54eb2b(0xdf))[_0x54eb2b(0xde)]()[_0x54eb2b(0xfd)](a483_0x1d2bf9)[_0x54eb2b(0xed)](_0x54eb2b(0xdf));});a483_0x1d2bf9();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x2c4d0b){const _0x5063dc=a483_0x1077;return _0x2c4d0b&&_0x2c4d0b[_0x5063dc(0x11a)]?_0x2c4d0b:{'default':_0x2c4d0b};};Object[a483_0x12f30c(0xe4)](exports,'__esModule',{'value':!![]}),exports[a483_0x12f30c(0xf9)]=exports[a483_0x12f30c(0x104)]=exports['processInvoiceExpired']=exports[a483_0x12f30c(0x107)]=exports[a483_0x12f30c(0xe2)]=exports[a483_0x12f30c(0x11e)]=exports[a483_0x12f30c(0xe1)]=void 0x0;const sequelize_1=require('sequelize'),moment_1=__importDefault(require(a483_0x12f30c(0x101))),AppError_1=__importDefault(require(a483_0x12f30c(0xf1))),GetSuperSettingService_1=__importDefault(require('../SettingServices/GetSuperSettingService')),EfiServices_1=require(a483_0x12f30c(0x119)),OwenServices_1=require('./OwenServices'),Invoices_1=__importDefault(require(a483_0x12f30c(0xec))),socket_1=require(a483_0x12f30c(0x11c)),Company_1=__importDefault(require('../../models/Company')),payGatewayInitialize=async()=>{const _0x34aa85=a483_0x12f30c,_0x51c5d3=await(0x0,GetSuperSettingService_1[_0x34aa85(0x10c)])({'key':_0x34aa85(0xfc)});if(_0x51c5d3===_0x34aa85(0x10e))return(0x0,EfiServices_1['efiInitialize'])();return null;};exports[a483_0x12f30c(0xe1)]=payGatewayInitialize;const payGatewayCreateSubscription=async(_0x5aa8fa,_0x673d1a)=>{const _0x416879=a483_0x12f30c,_0x130897=await(0x0,GetSuperSettingService_1[_0x416879(0x10c)])({'key':'_paymentGateway'});switch(_0x130897){case _0x416879(0x10e):{return(0x0,EfiServices_1[_0x416879(0xff)])(_0x5aa8fa,_0x673d1a);}case _0x416879(0xfb):{return(0x0,OwenServices_1[_0x416879(0x100)])(_0x5aa8fa,_0x673d1a);}default:{throw new AppError_1[(_0x416879(0x10c))](_0x416879(0xea),0x190);}}};exports[a483_0x12f30c(0x11e)]=payGatewayCreateSubscription;const payGatewayReceiveWebhook=async(_0x1e73e4,_0x1fa1aa)=>{const _0x3d8856=a483_0x12f30c,_0x28793=await(0x0,GetSuperSettingService_1[_0x3d8856(0x10c)])({'key':'_paymentGateway'});switch(_0x28793){case _0x3d8856(0x10e):{return(0x0,EfiServices_1[_0x3d8856(0x117)])(_0x1e73e4,_0x1fa1aa);}case'owen':{return(0x0,OwenServices_1['owenWebhook'])(_0x1e73e4,_0x1fa1aa);}default:{throw new AppError_1[(_0x3d8856(0x10c))]('Unsupported\x20payment\x20gateway',0x190);}}};exports[a483_0x12f30c(0xe2)]=payGatewayReceiveWebhook;const processInvoicePaid=async _0x49f748=>{const _0x1431aa=a483_0x12f30c,_0x4f0017=_0x49f748[_0x1431aa(0xf3)]||await Company_1[_0x1431aa(0x10c)][_0x1431aa(0x118)](_0x49f748[_0x1431aa(0xe3)]);if(_0x4f0017){const _0x5a4bad=(0x0,moment_1['default'])(_0x4f0017[_0x1431aa(0x114)]);let {dueDate:_0x38a228}=_0x4f0017;switch(_0x4f0017[_0x1431aa(0xe8)]){case _0x1431aa(0xfa):_0x38a228=_0x5a4bad[_0x1431aa(0xf4)](0x2,_0x1431aa(0x116))[_0x1431aa(0x11f)](_0x1431aa(0x103));break;case _0x1431aa(0x11b):_0x38a228=_0x5a4bad['add'](0x3,_0x1431aa(0x116))[_0x1431aa(0x11f)](_0x1431aa(0x103));break;case _0x1431aa(0x10b):_0x38a228=_0x5a4bad[_0x1431aa(0xf4)](0x6,_0x1431aa(0x116))[_0x1431aa(0x11f)]('YYYY-MM-DD');break;case _0x1431aa(0x105):_0x38a228=_0x5a4bad[_0x1431aa(0xf4)](0xc,_0x1431aa(0x116))[_0x1431aa(0x11f)]('YYYY-MM-DD');break;case _0x1431aa(0xe9):default:_0x38a228=_0x5a4bad[_0x1431aa(0xf4)](0x1,_0x1431aa(0x116))['format']('YYYY-MM-DD');break;}await _0x4f0017['update']({'dueDate':_0x38a228}),await _0x49f748['update']({'status':_0x1431aa(0xf8)}),await _0x4f0017[_0x1431aa(0xfe)]();const _0x391707=(0x0,socket_1[_0x1431aa(0xe0)])();_0x391707['to']('company-'+_0x49f748['companyId']+'-mainchannel')['to'](_0x1431aa(0xf7))[_0x1431aa(0xef)](_0x1431aa(0x113)+_0x49f748['companyId']+_0x1431aa(0x102),{'action':_0x1431aa(0x10f),'company':_0x4f0017,'invoiceId':_0x49f748['id']});}};exports[a483_0x12f30c(0x107)]=processInvoicePaid;const processInvoiceExpired=async _0x1275e3=>{const _0x3f7eb1=a483_0x12f30c,_0x5e8f56=(0x0,socket_1['getIO'])();await _0x1275e3[_0x3f7eb1(0xe7)]({'txId':null,'payGw':null,'payGwData':null}),await _0x1275e3[_0x3f7eb1(0xfe)](),_0x5e8f56['to']('company-'+_0x1275e3[_0x3f7eb1(0xe3)]+'-mainchannel')['to'](_0x3f7eb1(0xf7))[_0x3f7eb1(0xef)](_0x3f7eb1(0x113)+_0x1275e3[_0x3f7eb1(0xe3)]+'-payment',{'action':'EXPIRADA','company':_0x1275e3[_0x3f7eb1(0xf3)]||await Invoices_1[_0x3f7eb1(0x10c)][_0x3f7eb1(0x118)](_0x1275e3[_0x3f7eb1(0xe3)]),'invoiceId':_0x1275e3['id']});};exports['processInvoiceExpired']=processInvoiceExpired;const checkInvoicePayment=async _0x4cb5ac=>{const _0x437446=a483_0x12f30c;if(_0x4cb5ac[_0x437446(0xee)]===_0x437446(0x10e))(0x0,EfiServices_1['efiCheckStatus'])(_0x4cb5ac);else _0x4cb5ac[_0x437446(0xee)]===_0x437446(0xfb)&&(0x0,OwenServices_1['owenCheckStatus'])(_0x4cb5ac);};function a483_0x1077(_0x3c66e9,_0x1e6c84){const _0x1cc5eb=a483_0x32d1();return a483_0x1077=function(_0x1d2bf9,_0x475923){_0x1d2bf9=_0x1d2bf9-0xdd;let _0x32d1e6=_0x1cc5eb[_0x1d2bf9];return _0x32d1e6;},a483_0x1077(_0x3c66e9,_0x1e6c84);}exports[a483_0x12f30c(0x104)]=checkInvoicePayment;const checkOpenInvoices=async()=>{const _0x19dfb4=a483_0x12f30c,_0x2ce4fd=await Invoices_1[_0x19dfb4(0x10c)][_0x19dfb4(0x112)]({'where':{'status':_0x19dfb4(0x110),'txId':{[sequelize_1['Op']['or']]:[{[sequelize_1['Op']['not']]:''},{[sequelize_1['Op'][_0x19dfb4(0x108)]]:null}]}},'include':{'model':Company_1['default'],'as':'company'}});_0x2ce4fd[_0x19dfb4(0xe6)](_0x526e73=>{(0x0,exports['checkInvoicePayment'])(_0x526e73);});};function a483_0x32d1(){const _0x128bcf=['../../errors/AppError','5wdnTTg','company','add','35dTSWfO','12018NkXBPx','super','paid','checkOpenInvoices','BIMESTRAL','owen','_paymentGateway','constructor','reload','efiCreateSubscription','owenCreateSubscription','moment','-payment','YYYY-MM-DD','checkInvoicePayment','ANUAL','11oRNwPC','processInvoicePaid','not','882831OSJnVZ','44706sDIFhk','SEMESTRAL','default','2556584roqIYX','efi','CONCLUIDA','open','1704thUocH','findAll','company-','dueDate','905230FmDJTZ','month','efiWebhook','findByPk','./EfiServices','__esModule','TRIMESTRAL','../../libs/socket','1136784ruYBma','payGatewayCreateSubscription','format','apply','toString','(((.+)+)+)+$','getIO','payGatewayInitialize','payGatewayReceiveWebhook','companyId','defineProperty','78cPGKHY','forEach','update','recurrence','MENSAL','Unsupported\x20payment\x20gateway','290gtvfHn','../../models/Invoices','search','payGw','emit','9fLbrhq'];a483_0x32d1=function(){return _0x128bcf;};return a483_0x32d1();}exports[a483_0x12f30c(0xf9)]=checkOpenInvoices;