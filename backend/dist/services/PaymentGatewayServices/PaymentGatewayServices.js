const a451_0x351221=a451_0x2490;function a451_0x22af(){const _0x45578b=['emit','setDate','payGatewayCreateSubscription','processInvoicePaid','companyId','2VISWDY','checkInvoicePayment','efiCheckStatus','_paymentGateway','efiCreateSubscription','../../models/Company','-mainchannel','../../models/Invoices','processInvoiceExpired','3997490DJHXHj','defineProperty','reload','company-','20NhkYjS','search','stripe','constructor','efiWebhook','CONCLUIDA','129294wHSTUq','-payment','dueDate','../../errors/AppError','company','3492035ZmSVvq','apply','payGatewayReceiveWebhook','__esModule','paid','getIO','./EfiServices','__importDefault','checkOpenInvoices','stripeCreateSubscription','stripeCheckStatus','../SettingServices/GetSuperSettingService','../InvoicesService/FindOpenInvoiceService','109578dscFso','./StripeServices','2214576lCpmQs','Unsupported\x20payment\x20gateway','3663396kWXdwQ','133079WSLHIy','../../libs/socket','findByPk','payGatewayInitialize','payGw','efi','update','88NvkRwm','default','super'];a451_0x22af=function(){return _0x45578b;};return a451_0x22af();}(function(_0x545009,_0x5bfd20){const _0x54cbd8=a451_0x2490,_0x587a11=_0x545009();while(!![]){try{const _0x33bbf0=parseInt(_0x54cbd8(0x1ed))/0x1*(parseInt(_0x54cbd8(0x1fc))/0x2)+-parseInt(_0x54cbd8(0x20f))/0x3*(parseInt(_0x54cbd8(0x209))/0x4)+parseInt(_0x54cbd8(0x1db))/0x5+parseInt(_0x54cbd8(0x1ea))/0x6+parseInt(_0x54cbd8(0x1e8))/0x7*(parseInt(_0x54cbd8(0x1f4))/0x8)+-parseInt(_0x54cbd8(0x1ec))/0x9+-parseInt(_0x54cbd8(0x205))/0xa;if(_0x33bbf0===_0x5bfd20)break;else _0x587a11['push'](_0x587a11['shift']());}catch(_0x19bed1){_0x587a11['push'](_0x587a11['shift']());}}}(a451_0x22af,0x5591d));const a451_0x576a7c=(function(){let _0x3dbd4c=!![];return function(_0x27c830,_0x72a8c6){const _0x79cfde=_0x3dbd4c?function(){const _0x9ef1df=a451_0x2490;if(_0x72a8c6){const _0x2cff54=_0x72a8c6[_0x9ef1df(0x1dc)](_0x27c830,arguments);return _0x72a8c6=null,_0x2cff54;}}:function(){};return _0x3dbd4c=![],_0x79cfde;};}()),a451_0x1d14e0=a451_0x576a7c(this,function(){const _0x5fcd92=a451_0x2490;return a451_0x1d14e0['toString']()[_0x5fcd92(0x20a)]('(((.+)+)+)+$')['toString']()[_0x5fcd92(0x20c)](a451_0x1d14e0)['search']('(((.+)+)+)+$');});a451_0x1d14e0();function a451_0x2490(_0x279567,_0x513ad7){const _0x3c9359=a451_0x22af();return a451_0x2490=function(_0x1d14e0,_0x576a7c){_0x1d14e0=_0x1d14e0-0x1db;let _0x22af61=_0x3c9359[_0x1d14e0];return _0x22af61;},a451_0x2490(_0x279567,_0x513ad7);}'use strict';var __importDefault=this&&this[a451_0x351221(0x1e2)]||function(_0x1847a3){const _0x45806c=a451_0x351221;return _0x1847a3&&_0x1847a3[_0x45806c(0x1de)]?_0x1847a3:{'default':_0x1847a3};};Object[a451_0x351221(0x206)](exports,'__esModule',{'value':!![]}),exports['checkOpenInvoices']=exports[a451_0x351221(0x1fd)]=exports[a451_0x351221(0x204)]=exports[a451_0x351221(0x1fa)]=exports[a451_0x351221(0x1dd)]=exports[a451_0x351221(0x1f9)]=exports[a451_0x351221(0x1f0)]=void 0x0;const AppError_1=__importDefault(require(a451_0x351221(0x212))),GetSuperSettingService_1=__importDefault(require(a451_0x351221(0x1e6))),EfiServices_1=require(a451_0x351221(0x1e1)),StripeServices_1=require(a451_0x351221(0x1e9)),Invoices_1=__importDefault(require(a451_0x351221(0x203))),socket_1=require(a451_0x351221(0x1ee)),Company_1=__importDefault(require(a451_0x351221(0x201))),FindOpenInvoiceService_1=__importDefault(require(a451_0x351221(0x1e7))),payGatewayInitialize=async()=>{const _0x28ba52=a451_0x351221,_0x3ab6f6=await(0x0,GetSuperSettingService_1[_0x28ba52(0x1f5)])({'key':_0x28ba52(0x1ff)});switch(_0x3ab6f6){case _0x28ba52(0x1f2):return(0x0,EfiServices_1['efiInitialize'])();case'stripe':return(0x0,StripeServices_1['stripeInitialize'])();default:throw new AppError_1[(_0x28ba52(0x1f5))](_0x28ba52(0x1eb),0x190);}};exports[a451_0x351221(0x1f0)]=payGatewayInitialize;const payGatewayCreateSubscription=async(_0x595818,_0x31fe82)=>{const _0x4f048c=a451_0x351221,_0x4daebf=await(0x0,GetSuperSettingService_1[_0x4f048c(0x1f5)])({'key':_0x4f048c(0x1ff)});switch(_0x4daebf){case _0x4f048c(0x1f2):return(0x0,EfiServices_1[_0x4f048c(0x200)])(_0x595818,_0x31fe82);case _0x4f048c(0x20b):return(0x0,StripeServices_1[_0x4f048c(0x1e4)])(_0x595818,_0x31fe82);default:throw new AppError_1[(_0x4f048c(0x1f5))](_0x4f048c(0x1eb),0x190);}};exports[a451_0x351221(0x1f9)]=payGatewayCreateSubscription;const payGatewayReceiveWebhook=async(_0x4ef32d,_0x4a943e)=>{const _0x222df5=a451_0x351221,_0x1d14bd=await(0x0,GetSuperSettingService_1['default'])({'key':'_paymentGateway'});switch(_0x1d14bd){case'efi':return(0x0,EfiServices_1[_0x222df5(0x20d)])(_0x4ef32d,_0x4a943e);case _0x222df5(0x20b):return(0x0,StripeServices_1['stripeWebhookHandler'])(_0x4ef32d,_0x4a943e);default:throw new AppError_1[(_0x222df5(0x1f5))](_0x222df5(0x1eb),0x190);}};exports[a451_0x351221(0x1dd)]=payGatewayReceiveWebhook;const processInvoicePaid=async _0x282631=>{const _0x36fcb3=a451_0x351221,_0x2b9a4d=_0x282631[_0x36fcb3(0x213)]||await Company_1[_0x36fcb3(0x1f5)][_0x36fcb3(0x1ef)](_0x282631[_0x36fcb3(0x1fb)]);if(_0x2b9a4d){const _0x3efc85=new Date(_0x2b9a4d[_0x36fcb3(0x211)]);_0x3efc85[_0x36fcb3(0x1f8)](_0x3efc85['getDate']()+0x1e),await _0x2b9a4d[_0x36fcb3(0x1f3)]({'dueDate':_0x3efc85}),await _0x282631[_0x36fcb3(0x1f3)]({'status':_0x36fcb3(0x1df)}),await _0x2b9a4d[_0x36fcb3(0x207)]();const _0x3315e5=(0x0,socket_1[_0x36fcb3(0x1e0)])();_0x3315e5['to'](_0x36fcb3(0x208)+_0x282631[_0x36fcb3(0x1fb)]+_0x36fcb3(0x202))['to'](_0x36fcb3(0x1f6))[_0x36fcb3(0x1f7)](_0x36fcb3(0x208)+_0x282631['companyId']+_0x36fcb3(0x210),{'action':_0x36fcb3(0x20e),'company':_0x2b9a4d,'invoiceId':_0x282631['id']});}};exports[a451_0x351221(0x1fa)]=processInvoicePaid;const processInvoiceExpired=async _0xf9eace=>{const _0x333452=a451_0x351221,_0x276bc7=(0x0,socket_1['getIO'])();await _0xf9eace['update']({'txId':null,'payGw':null,'payGwData':null}),await _0xf9eace[_0x333452(0x207)](),_0x276bc7['to']('company-'+_0xf9eace['companyId']+_0x333452(0x202))['to'](_0x333452(0x1f6))[_0x333452(0x1f7)](_0x333452(0x208)+_0xf9eace[_0x333452(0x1fb)]+_0x333452(0x210),{'action':'EXPIRADA','company':_0xf9eace[_0x333452(0x213)]||await Invoices_1['default'][_0x333452(0x1ef)](_0xf9eace['companyId']),'invoiceId':_0xf9eace['id']});};exports[a451_0x351221(0x204)]=processInvoiceExpired;const checkInvoicePayment=async _0x39fb28=>{const _0x516a1=a451_0x351221;if(_0x39fb28[_0x516a1(0x1f1)]===_0x516a1(0x1f2))(0x0,EfiServices_1[_0x516a1(0x1fe)])(_0x39fb28);else _0x39fb28[_0x516a1(0x1f1)]===_0x516a1(0x20b)&&(0x0,StripeServices_1[_0x516a1(0x1e5)])(_0x39fb28['id']);};exports['checkInvoicePayment']=checkInvoicePayment;const checkOpenInvoices=async _0x3a41a8=>{const _0x3bb56f=await(0x0,FindOpenInvoiceService_1['default'])(_0x3a41a8);_0x3bb56f['forEach'](_0x2a428b=>{const _0x68f822=a451_0x2490;(0x0,exports[_0x68f822(0x1fd)])(_0x2a428b);});};exports[a451_0x351221(0x1e3)]=checkOpenInvoices;