const a484_0x1aab5c=a484_0x5846;(function(_0x560951,_0x22a48f){const _0x5c3ead=a484_0x5846,_0x4109fe=_0x560951();while(!![]){try{const _0x25c28e=parseInt(_0x5c3ead(0x199))/0x1*(-parseInt(_0x5c3ead(0x1ac))/0x2)+-parseInt(_0x5c3ead(0x185))/0x3*(-parseInt(_0x5c3ead(0x1a5))/0x4)+-parseInt(_0x5c3ead(0x190))/0x5*(-parseInt(_0x5c3ead(0x182))/0x6)+parseInt(_0x5c3ead(0x187))/0x7+-parseInt(_0x5c3ead(0x1b8))/0x8*(parseInt(_0x5c3ead(0x1ab))/0x9)+parseInt(_0x5c3ead(0x181))/0xa*(parseInt(_0x5c3ead(0x1bd))/0xb)+-parseInt(_0x5c3ead(0x1a3))/0xc;if(_0x25c28e===_0x22a48f)break;else _0x4109fe['push'](_0x4109fe['shift']());}catch(_0x2491b3){_0x4109fe['push'](_0x4109fe['shift']());}}}(a484_0x36a2,0x7f464));const a484_0x3b3a7e=(function(){let _0x3fd2e7=!![];return function(_0x150d96,_0x529312){const _0xa1ce08=_0x3fd2e7?function(){if(_0x529312){const _0x3df37b=_0x529312['apply'](_0x150d96,arguments);return _0x529312=null,_0x3df37b;}}:function(){};return _0x3fd2e7=![],_0xa1ce08;};}()),a484_0x238148=a484_0x3b3a7e(this,function(){const _0x423205=a484_0x5846;return a484_0x238148[_0x423205(0x197)]()[_0x423205(0x1ba)]('(((.+)+)+)+$')[_0x423205(0x197)]()[_0x423205(0x18e)](a484_0x238148)[_0x423205(0x1ba)]('(((.+)+)+)+$');});a484_0x238148();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x2c6cd4){const _0x469df5=a484_0x5846;return _0x2c6cd4&&_0x2c6cd4[_0x469df5(0x188)]?_0x2c6cd4:{'default':_0x2c6cd4};};Object[a484_0x1aab5c(0x1b7)](exports,a484_0x1aab5c(0x188),{'value':!![]}),exports['checkOpenInvoices']=exports[a484_0x1aab5c(0x196)]=exports['processInvoiceExpired']=exports[a484_0x1aab5c(0x1b5)]=exports['payGatewayReceiveWebhook']=exports[a484_0x1aab5c(0x1ae)]=exports[a484_0x1aab5c(0x1bc)]=void 0x0;const sequelize_1=require(a484_0x1aab5c(0x19d)),moment_1=__importDefault(require(a484_0x1aab5c(0x1a0))),AppError_1=__importDefault(require(a484_0x1aab5c(0x19b))),GetSuperSettingService_1=__importDefault(require(a484_0x1aab5c(0x1b3))),EfiServices_1=require('./EfiServices'),OwenServices_1=require('./OwenServices'),Invoices_1=__importDefault(require(a484_0x1aab5c(0x195))),socket_1=require(a484_0x1aab5c(0x1a7)),Company_1=__importDefault(require(a484_0x1aab5c(0x18a))),payGatewayInitialize=async()=>{const _0x5126e9=a484_0x1aab5c,_0x31bfae=await(0x0,GetSuperSettingService_1[_0x5126e9(0x1a6)])({'key':_0x5126e9(0x184)});if(_0x31bfae===_0x5126e9(0x1a8))return(0x0,EfiServices_1[_0x5126e9(0x1a1)])();return null;};exports[a484_0x1aab5c(0x1bc)]=payGatewayInitialize;function a484_0x5846(_0x57bda7,_0x45811a){const _0x28d777=a484_0x36a2();return a484_0x5846=function(_0x238148,_0x3b3a7e){_0x238148=_0x238148-0x180;let _0x36a29d=_0x28d777[_0x238148];return _0x36a29d;},a484_0x5846(_0x57bda7,_0x45811a);}const payGatewayCreateSubscription=async(_0x422787,_0x154f9b)=>{const _0x11c92c=a484_0x1aab5c,_0x5046bc=await(0x0,GetSuperSettingService_1[_0x11c92c(0x1a6)])({'key':_0x11c92c(0x184)});switch(_0x5046bc){case _0x11c92c(0x1a8):{return(0x0,EfiServices_1[_0x11c92c(0x1af)])(_0x422787,_0x154f9b);}case _0x11c92c(0x1b0):{return(0x0,OwenServices_1[_0x11c92c(0x189)])(_0x422787,_0x154f9b);}default:{throw new AppError_1['default'](_0x11c92c(0x19a),0x190);}}};exports[a484_0x1aab5c(0x1ae)]=payGatewayCreateSubscription;const payGatewayReceiveWebhook=async(_0x5bd5f3,_0x247fe8)=>{const _0x30e549=a484_0x1aab5c,_0x220afd=await(0x0,GetSuperSettingService_1[_0x30e549(0x1a6)])({'key':_0x30e549(0x184)});switch(_0x220afd){case'efi':{return(0x0,EfiServices_1[_0x30e549(0x1a4)])(_0x5bd5f3,_0x247fe8);}case _0x30e549(0x1b0):{return(0x0,OwenServices_1['owenWebhook'])(_0x5bd5f3,_0x247fe8);}default:{throw new AppError_1[(_0x30e549(0x1a6))]('Unsupported\x20payment\x20gateway',0x190);}}};exports['payGatewayReceiveWebhook']=payGatewayReceiveWebhook;const processInvoicePaid=async _0x374ba1=>{const _0x2997f9=a484_0x1aab5c,_0x2323d2=_0x374ba1[_0x2997f9(0x19e)]||await Company_1[_0x2997f9(0x1a6)][_0x2997f9(0x192)](_0x374ba1[_0x2997f9(0x1b9)]);if(_0x2323d2){const _0x3f9748=(0x0,moment_1[_0x2997f9(0x1a6)])(_0x2323d2[_0x2997f9(0x19c)]);let {dueDate:_0x5d1ce7}=_0x2323d2;switch(_0x2323d2['recurrence']){case _0x2997f9(0x191):_0x5d1ce7=_0x3f9748[_0x2997f9(0x198)](0x2,_0x2997f9(0x1a9))[_0x2997f9(0x1ad)]('YYYY-MM-DD');break;case'TRIMESTRAL':_0x5d1ce7=_0x3f9748[_0x2997f9(0x198)](0x3,_0x2997f9(0x1a9))[_0x2997f9(0x1ad)](_0x2997f9(0x194));break;case'SEMESTRAL':_0x5d1ce7=_0x3f9748[_0x2997f9(0x198)](0x6,_0x2997f9(0x1a9))[_0x2997f9(0x1ad)](_0x2997f9(0x194));break;case _0x2997f9(0x18d):_0x5d1ce7=_0x3f9748[_0x2997f9(0x198)](0xc,_0x2997f9(0x1a9))['format'](_0x2997f9(0x194));break;case _0x2997f9(0x180):default:_0x5d1ce7=_0x3f9748['add'](0x1,_0x2997f9(0x1a9))['format'](_0x2997f9(0x194));break;}await _0x2323d2[_0x2997f9(0x1b4)]({'dueDate':_0x5d1ce7}),await _0x374ba1['update']({'status':_0x2997f9(0x183)}),await _0x2323d2['reload']();const _0x6c5c8c=(0x0,socket_1[_0x2997f9(0x1b6)])();_0x6c5c8c['to'](_0x2997f9(0x18f)+_0x374ba1[_0x2997f9(0x1b9)]+_0x2997f9(0x18c))['to'](_0x2997f9(0x18b))[_0x2997f9(0x1a2)](_0x2997f9(0x18f)+_0x374ba1['companyId']+_0x2997f9(0x1aa),{'action':'CONCLUIDA','company':_0x2323d2,'invoiceId':_0x374ba1['id']});}};exports[a484_0x1aab5c(0x1b5)]=processInvoicePaid;const processInvoiceExpired=async _0x19da95=>{const _0x3e3782=a484_0x1aab5c,_0x3536e2=(0x0,socket_1['getIO'])();await _0x19da95[_0x3e3782(0x1b4)]({'txId':null,'payGw':null,'payGwData':null}),await _0x19da95['reload'](),_0x3536e2['to'](_0x3e3782(0x18f)+_0x19da95[_0x3e3782(0x1b9)]+_0x3e3782(0x18c))['to']('super')[_0x3e3782(0x1a2)](_0x3e3782(0x18f)+_0x19da95['companyId']+_0x3e3782(0x1aa),{'action':'EXPIRADA','company':_0x19da95[_0x3e3782(0x19e)]||await Invoices_1[_0x3e3782(0x1a6)][_0x3e3782(0x192)](_0x19da95[_0x3e3782(0x1b9)]),'invoiceId':_0x19da95['id']});};function a484_0x36a2(){const _0x2e6f20=['findAll','../SettingServices/GetSuperSettingService','update','processInvoicePaid','getIO','defineProperty','599576sYIwsb','companyId','search','payGw','payGatewayInitialize','10359371NsdMYd','MENSAL','10mLuXqP','1176kwVRKx','paid','_paymentGateway','252072jKplhr','forEach','1429337BwkScc','__esModule','owenCreateSubscription','../../models/Company','super','-mainchannel','ANUAL','constructor','company-','12955ftdUya','BIMESTRAL','findByPk','owenCheckStatus','YYYY-MM-DD','../../models/Invoices','checkInvoicePayment','toString','add','879745wNcBJI','Unsupported\x20payment\x20gateway','../../errors/AppError','dueDate','sequelize','company','not','moment','efiInitialize','emit','3795192NrSKzk','efiWebhook','28SROMzo','default','../../libs/socket','efi','month','-payment','63LZiQyl','2pcIQbG','format','payGatewayCreateSubscription','efiCreateSubscription','owen','open'];a484_0x36a2=function(){return _0x2e6f20;};return a484_0x36a2();}exports['processInvoiceExpired']=processInvoiceExpired;const checkInvoicePayment=async _0x36358f=>{const _0x12cf13=a484_0x1aab5c;if(_0x36358f[_0x12cf13(0x1bb)]===_0x12cf13(0x1a8))(0x0,EfiServices_1['efiCheckStatus'])(_0x36358f);else _0x36358f['payGw']==='owen'&&(0x0,OwenServices_1[_0x12cf13(0x193)])(_0x36358f);};exports[a484_0x1aab5c(0x196)]=checkInvoicePayment;const checkOpenInvoices=async()=>{const _0x450ce3=a484_0x1aab5c,_0x1f4ec8=await Invoices_1[_0x450ce3(0x1a6)][_0x450ce3(0x1b2)]({'where':{'status':_0x450ce3(0x1b1),'txId':{[sequelize_1['Op']['or']]:[{[sequelize_1['Op'][_0x450ce3(0x19f)]]:''},{[sequelize_1['Op']['not']]:null}]}},'include':{'model':Company_1['default'],'as':_0x450ce3(0x19e)}});_0x1f4ec8[_0x450ce3(0x186)](_0x1fcae8=>{(0x0,exports['checkInvoicePayment'])(_0x1fcae8);});};exports['checkOpenInvoices']=checkOpenInvoices;