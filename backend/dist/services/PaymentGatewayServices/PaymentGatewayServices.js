const a454_0x302aa8=a454_0x2f9e;function a454_0x2f9e(_0x29879f,_0x451bc2){const _0x1e2518=a454_0x23f2();return a454_0x2f9e=function(_0x428041,_0x194dd3){_0x428041=_0x428041-0x1e5;let _0x23f232=_0x1e2518[_0x428041];return _0x23f232;},a454_0x2f9e(_0x29879f,_0x451bc2);}(function(_0x550641,_0x5653f5){const _0x4c4282=a454_0x2f9e,_0x1b95ee=_0x550641();while(!![]){try{const _0x533593=parseInt(_0x4c4282(0x1f8))/0x1+-parseInt(_0x4c4282(0x215))/0x2+-parseInt(_0x4c4282(0x1fb))/0x3+parseInt(_0x4c4282(0x214))/0x4*(-parseInt(_0x4c4282(0x1f6))/0x5)+-parseInt(_0x4c4282(0x20a))/0x6+parseInt(_0x4c4282(0x1ee))/0x7+parseInt(_0x4c4282(0x1e7))/0x8;if(_0x533593===_0x5653f5)break;else _0x1b95ee['push'](_0x1b95ee['shift']());}catch(_0x4f5031){_0x1b95ee['push'](_0x1b95ee['shift']());}}}(a454_0x23f2,0xe46cb));const a454_0x194dd3=(function(){let _0x2a48c5=!![];return function(_0x214453,_0x2e429e){const _0x16fb60=_0x2a48c5?function(){const _0x435ff7=a454_0x2f9e;if(_0x2e429e){const _0x2ad684=_0x2e429e[_0x435ff7(0x1fc)](_0x214453,arguments);return _0x2e429e=null,_0x2ad684;}}:function(){};return _0x2a48c5=![],_0x16fb60;};}()),a454_0x428041=a454_0x194dd3(this,function(){const _0x54535b=a454_0x2f9e;return a454_0x428041[_0x54535b(0x20b)]()[_0x54535b(0x1f4)](_0x54535b(0x1ea))['toString']()[_0x54535b(0x200)](a454_0x428041)[_0x54535b(0x1f4)](_0x54535b(0x1ea));});a454_0x428041();'use strict';var __importDefault=this&&this[a454_0x302aa8(0x202)]||function(_0x54a03a){return _0x54a03a&&_0x54a03a['__esModule']?_0x54a03a:{'default':_0x54a03a};};Object[a454_0x302aa8(0x206)](exports,'__esModule',{'value':!![]}),exports['checkOpenInvoices']=exports[a454_0x302aa8(0x219)]=exports[a454_0x302aa8(0x1fd)]=exports[a454_0x302aa8(0x203)]=exports[a454_0x302aa8(0x1f1)]=exports[a454_0x302aa8(0x1f0)]=exports[a454_0x302aa8(0x20d)]=void 0x0;const AppError_1=__importDefault(require('../../errors/AppError')),GetSuperSettingService_1=__importDefault(require(a454_0x302aa8(0x218))),EfiServices_1=require(a454_0x302aa8(0x1f7)),StripeServices_1=require(a454_0x302aa8(0x205)),Invoices_1=__importDefault(require(a454_0x302aa8(0x1ef))),socket_1=require('../../libs/socket'),Company_1=__importDefault(require(a454_0x302aa8(0x21a))),FindOpenInvoiceService_1=__importDefault(require(a454_0x302aa8(0x1f2))),payGatewayInitialize=async()=>{const _0x59398b=a454_0x302aa8,_0xc94e75=await(0x0,GetSuperSettingService_1['default'])({'key':'_paymentGateway'});switch(_0xc94e75){case _0x59398b(0x1ec):return(0x0,EfiServices_1[_0x59398b(0x1f9)])();case _0x59398b(0x1eb):return(0x0,StripeServices_1['stripeInitialize'])();default:throw new AppError_1['default'](_0x59398b(0x1e9),0x190);}};exports[a454_0x302aa8(0x20d)]=payGatewayInitialize;const payGatewayCreateSubscription=async(_0x155b42,_0x5c2674)=>{const _0x808069=a454_0x302aa8,_0xc39e92=await(0x0,GetSuperSettingService_1[_0x808069(0x208)])({'key':_0x808069(0x21b)});switch(_0xc39e92){case _0x808069(0x1ec):return(0x0,EfiServices_1[_0x808069(0x21d)])(_0x155b42,_0x5c2674);case _0x808069(0x1eb):return(0x0,StripeServices_1[_0x808069(0x207)])(_0x155b42,_0x5c2674);default:throw new AppError_1[(_0x808069(0x208))](_0x808069(0x1e9),0x190);}};exports['payGatewayCreateSubscription']=payGatewayCreateSubscription;const payGatewayReceiveWebhook=async(_0x495aeb,_0x2655f4)=>{const _0x3d4ce7=a454_0x302aa8,_0x4b3a13=await(0x0,GetSuperSettingService_1['default'])({'key':'_paymentGateway'});switch(_0x4b3a13){case _0x3d4ce7(0x1ec):return(0x0,EfiServices_1[_0x3d4ce7(0x20f)])(_0x495aeb,_0x2655f4);case'stripe':return(0x0,StripeServices_1[_0x3d4ce7(0x20e)])(_0x495aeb,_0x2655f4);default:throw new AppError_1[(_0x3d4ce7(0x208))]('Unsupported\x20payment\x20gateway',0x190);}};exports['payGatewayReceiveWebhook']=payGatewayReceiveWebhook;const processInvoicePaid=async _0xa9ad5f=>{const _0x1e5320=a454_0x302aa8,_0x5c466a=_0xa9ad5f[_0x1e5320(0x212)]||await Company_1['default'][_0x1e5320(0x1ff)](_0xa9ad5f['companyId']);if(_0x5c466a){const _0x4e97ad=new Date(_0x5c466a[_0x1e5320(0x1e5)]);_0x4e97ad['setDate'](_0x4e97ad[_0x1e5320(0x21c)]()+0x1e),await _0x5c466a[_0x1e5320(0x209)]({'dueDate':_0x4e97ad}),await _0xa9ad5f[_0x1e5320(0x209)]({'status':_0x1e5320(0x1ed)}),await _0x5c466a[_0x1e5320(0x216)]();const _0x3b1830=(0x0,socket_1[_0x1e5320(0x1e8)])();_0x3b1830['to'](_0x1e5320(0x1e6)+_0xa9ad5f[_0x1e5320(0x1fa)]+_0x1e5320(0x213))['to'](_0x1e5320(0x210))['emit']('company-'+_0xa9ad5f['companyId']+_0x1e5320(0x1fe),{'action':'CONCLUIDA','company':_0x5c466a,'invoiceId':_0xa9ad5f['id']});}};function a454_0x23f2(){const _0x26f0a9=['../../models/Invoices','payGatewayCreateSubscription','payGatewayReceiveWebhook','../InvoicesService/FindOpenInvoiceService','efiCheckStatus','search','emit','9665UNNhRw','./EfiServices','1801541jcQlIS','efiInitialize','companyId','834078Dtkfpo','apply','processInvoiceExpired','-payment','findByPk','constructor','payGw','__importDefault','processInvoicePaid','checkOpenInvoices','./StripeServices','defineProperty','stripeCreateSubscription','default','update','10349928fmjywz','toString','stripeCheckStatus','payGatewayInitialize','stripeWebhookHandler','efiWebhook','super','forEach','company','-mainchannel','2700NMBGqW','3494864yLvPsY','reload','EXPIRADA','../SettingServices/GetSuperSettingService','checkInvoicePayment','../../models/Company','_paymentGateway','getDate','efiCreateSubscription','dueDate','company-','32985496DlXnvC','getIO','Unsupported\x20payment\x20gateway','(((.+)+)+)+$','stripe','efi','paid','462840YECidl'];a454_0x23f2=function(){return _0x26f0a9;};return a454_0x23f2();}exports['processInvoicePaid']=processInvoicePaid;const processInvoiceExpired=async _0x2e50ad=>{const _0x5ec027=a454_0x302aa8,_0x188bd4=(0x0,socket_1['getIO'])();await _0x2e50ad[_0x5ec027(0x209)]({'txId':null,'payGw':null,'payGwData':null}),await _0x2e50ad[_0x5ec027(0x216)](),_0x188bd4['to'](_0x5ec027(0x1e6)+_0x2e50ad['companyId']+'-mainchannel')['to'](_0x5ec027(0x210))[_0x5ec027(0x1f5)](_0x5ec027(0x1e6)+_0x2e50ad[_0x5ec027(0x1fa)]+_0x5ec027(0x1fe),{'action':_0x5ec027(0x217),'company':_0x2e50ad[_0x5ec027(0x212)]||await Invoices_1[_0x5ec027(0x208)]['findByPk'](_0x2e50ad[_0x5ec027(0x1fa)]),'invoiceId':_0x2e50ad['id']});};exports[a454_0x302aa8(0x1fd)]=processInvoiceExpired;const checkInvoicePayment=async _0x38c0e2=>{const _0x591bef=a454_0x302aa8;if(_0x38c0e2[_0x591bef(0x201)]==='efi')(0x0,EfiServices_1[_0x591bef(0x1f3)])(_0x38c0e2);else _0x38c0e2[_0x591bef(0x201)]===_0x591bef(0x1eb)&&(0x0,StripeServices_1[_0x591bef(0x20c)])(_0x38c0e2['id']);};exports[a454_0x302aa8(0x219)]=checkInvoicePayment;const checkOpenInvoices=async _0x91a82a=>{const _0x4a2216=a454_0x302aa8,_0x2d6397=await(0x0,FindOpenInvoiceService_1['default'])(_0x91a82a);_0x2d6397[_0x4a2216(0x211)](_0x4e0e3e=>{const _0x1669fb=_0x4a2216;(0x0,exports[_0x1669fb(0x219)])(_0x4e0e3e);});};exports[a454_0x302aa8(0x204)]=checkOpenInvoices;