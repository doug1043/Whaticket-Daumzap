'use strict';function a626_0x4af4(){const _0x3941c6=['prototype','has','default','apply','date_from','__importDefault','\x20and\x20tt.\x22createdAt\x22\x20>=\x20?','\x0a\x20\x20\x20\x20with\x0a\x20\x20\x20\x20traking\x20as\x20(\x0a\x20\x20\x20\x20\x20\x20select\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.name\x20\x22companyName\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.name\x20\x22userName\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(select\x20count(*)\x20>\x200\x20as\x20online\x20from\x20\x22UserSocketSessions\x22\x20tu\x20where\x20tu.\x22userId\x22\x20=\x20tt.\x22userId\x22\x20and\x20tu.\x22active\x22\x20is\x20True)\x20\x22userOnline\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20w.name\x20\x22whatsappName\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20ct.name\x20\x22contactName\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20ct.number\x20\x22contactNumber\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(tt.\x22finishedAt\x22\x20is\x20not\x20null)\x20\x22finished\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(tt.\x22userId\x22\x20is\x20null\x20and\x20tt.\x22finishedAt\x22\x20is\x20null)\x20\x22pending\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(tt.\x22startedAt\x22\x20is\x20not\x20null\x20and\x20tt.\x22finishedAt\x22\x20is\x20null)\x20\x22open\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20coalesce((\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(date_part(\x27day\x27,\x20age(coalesce(tt.\x22ratingAt\x22,\x20tt.\x22finishedAt\x22)\x20,\x20tt.\x22startedAt\x22))\x20*\x2024\x20*\x2060)\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(date_part(\x27hour\x27,\x20age(coalesce(tt.\x22ratingAt\x22,\x20tt.\x22finishedAt\x22),\x20tt.\x22startedAt\x22))\x20*\x2060)\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(date_part(\x27minutes\x27,\x20age(coalesce(tt.\x22ratingAt\x22,\x20tt.\x22finishedAt\x22),\x20tt.\x22startedAt\x22)))\x0a\x20\x20\x20\x20\x20\x20\x20\x20),\x200)\x20\x22supportTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20coalesce((\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(date_part(\x27day\x27,\x20age(tt.\x22startedAt\x22,\x20tt.\x22queuedAt\x22))\x20*\x2024\x20*\x2060)\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(date_part(\x27hour\x27,\x20age(tt.\x22startedAt\x22,\x20tt.\x22queuedAt\x22))\x20*\x2060)\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(date_part(\x27minutes\x27,\x20age(tt.\x22startedAt\x22,\x20tt.\x22queuedAt\x22)))\x0a\x20\x20\x20\x20\x20\x20\x20\x20),\x200)\x20\x22waitTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20t.status,\x0a\x20\x20\x20\x20\x20\x20\x20\x20tt.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20ct.\x22id\x22\x20\x22contactId\x22\x0a\x20\x20\x20\x20\x20\x20from\x20\x22TicketTraking\x22\x20tt\x0a\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Companies\x22\x20c\x20on\x20c.id\x20=\x20tt.\x22companyId\x22\x0a\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Users\x22\x20u\x20on\x20u.id\x20=\x20tt.\x22userId\x22\x0a\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Whatsapps\x22\x20w\x20on\x20w.id\x20=\x20tt.\x22whatsappId\x22\x0a\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Tickets\x22\x20t\x20on\x20t.id\x20=\x20tt.\x22ticketId\x22\x0a\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Contacts\x22\x20ct\x20on\x20ct.id\x20=\x20t.\x22contactId\x22\x0a\x20\x20\x20\x20\x20\x20--\x20filterPeriod\x0a\x20\x20\x20\x20),\x0a\x20\x20\x20\x20counters\x20as\x20(\x0a\x20\x20\x20\x20\x20\x20select\x0a\x20\x20\x20\x20\x20\x20\x20\x20(select\x20avg(\x22supportTime\x22)\x20from\x20traking\x20where\x20\x22supportTime\x22\x20>\x200)\x20\x22avgSupportTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(select\x20avg(\x22waitTime\x22)\x20from\x20traking\x20where\x20\x22waitTime\x22\x20>\x200)\x20\x22avgWaitTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20select\x20count(distinct\x20\x22id\x22)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20from\x20\x22Tickets\x22\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20where\x20status\x20like\x20\x27open\x27\x20and\x20\x22companyId\x22\x20=\x20?\x0a\x20\x20\x20\x20\x20\x20\x20\x20)\x20\x22supportHappening\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20select\x20count(distinct\x20\x22id\x22)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20from\x20\x22Tickets\x22\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20where\x20status\x20like\x20\x27pending\x27\x20and\x20\x22companyId\x22\x20=\x20?\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','sequelize','days','getOwnPropertyDescriptor','583807yYxAEk','__esModule','enabled','(((.+)+)+)+$','groupsTab','QueryTypes','create','toString','query','date_to','--\x20filterPeriod','call','getOwnPropertyNames','2493qzQOiu','../../database','__setModuleDefault','947950bhsFGb','push','GetCompanySetting','length','1593hPRBek','defineProperty','replace','constructor','\x2023:59:59','__importStar','1053164WDiqEU','AND\x20NOT\x20\x22isGroup\x22','__createBinding','1382478lneECx','924SAMlGY','14984bOyMVL','1808968fLrLYe','CheckMsgIsGroup'];a626_0x4af4=function(){return _0x3941c6;};return a626_0x4af4();}const a626_0x18d0ca=a626_0x3447;(function(_0x36614a,_0x3d6535){const _0x3a9ed7=a626_0x3447,_0x45dbc1=_0x36614a();while(!![]){try{const _0x5957fb=parseInt(_0x3a9ed7(0xc4))/0x1+parseInt(_0x3a9ed7(0xde))/0x2+parseInt(_0x3a9ed7(0xd1))/0x3*(parseInt(_0x3a9ed7(0xe2))/0x4)+-parseInt(_0x3a9ed7(0xd4))/0x5+-parseInt(_0x3a9ed7(0xe1))/0x6+-parseInt(_0x3a9ed7(0xe4))/0x7+parseInt(_0x3a9ed7(0xe3))/0x8*(-parseInt(_0x3a9ed7(0xd8))/0x9);if(_0x5957fb===_0x3d6535)break;else _0x45dbc1['push'](_0x45dbc1['shift']());}catch(_0x1b8dcd){_0x45dbc1['push'](_0x45dbc1['shift']());}}}(a626_0x4af4,0x47632));function a626_0x3447(_0x22f51a,_0x459baa){const _0x38fc5b=a626_0x4af4();return a626_0x3447=function(_0x2e6abf,_0x1f0e28){_0x2e6abf=_0x2e6abf-0xc3;let _0x4af452=_0x38fc5b[_0x2e6abf];return _0x4af452;},a626_0x3447(_0x22f51a,_0x459baa);}var __createBinding=this&&this[a626_0x18d0ca(0xe0)]||(Object['create']?function(_0x689322,_0x1c579f,_0x50c04d,_0x5158a7){const _0x3a9d6d=a626_0x18d0ca;if(_0x5158a7===undefined)_0x5158a7=_0x50c04d;var _0x54af5b=Object[_0x3a9d6d(0xc3)](_0x1c579f,_0x50c04d);(!_0x54af5b||('get'in _0x54af5b?!_0x1c579f[_0x3a9d6d(0xc5)]:_0x54af5b['writable']||_0x54af5b['configurable']))&&(_0x54af5b={'enumerable':!![],'get':function(){return _0x1c579f[_0x50c04d];}}),Object[_0x3a9d6d(0xd9)](_0x689322,_0x5158a7,_0x54af5b);}:function(_0x4db9eb,_0x2d5485,_0x5b00ce,_0x27d0aa){if(_0x27d0aa===undefined)_0x27d0aa=_0x5b00ce;_0x4db9eb[_0x27d0aa]=_0x2d5485[_0x5b00ce];}),__setModuleDefault=this&&this[a626_0x18d0ca(0xd3)]||(Object[a626_0x18d0ca(0xca)]?function(_0x49a908,_0x2f8efa){const _0x59dce8=a626_0x18d0ca;Object[_0x59dce8(0xd9)](_0x49a908,_0x59dce8(0xe8),{'enumerable':!![],'value':_0x2f8efa});}:function(_0x33eb96,_0x51365e){const _0xd3cf98=a626_0x18d0ca;_0x33eb96[_0xd3cf98(0xe8)]=_0x51365e;}),__importStar=this&&this[a626_0x18d0ca(0xdd)]||(function(){const _0x26ca3c=(function(){let _0x2b4376=!![];return function(_0x3f16f2,_0x5dbbec){const _0x15860f=_0x2b4376?function(){const _0x260ebb=a626_0x3447;if(_0x5dbbec){const _0xa2c9ca=_0x5dbbec[_0x260ebb(0xe9)](_0x3f16f2,arguments);return _0x5dbbec=null,_0xa2c9ca;}}:function(){};return _0x2b4376=![],_0x15860f;};}()),_0x27c06b=_0x26ca3c(this,function(){const _0xf9a184=a626_0x3447;return _0x27c06b[_0xf9a184(0xcb)]()['search']('(((.+)+)+)+$')[_0xf9a184(0xcb)]()[_0xf9a184(0xdb)](_0x27c06b)['search'](_0xf9a184(0xc7));});_0x27c06b();var _0x46f566=function(_0x23f32d){const _0x106fcf=a626_0x3447;return _0x46f566=Object[_0x106fcf(0xd0)]||function(_0x36a841){const _0x3df1e5=_0x106fcf;var _0x45a8cf=[];for(var _0x334e2d in _0x36a841)if(Object[_0x3df1e5(0xe6)]['hasOwnProperty'][_0x3df1e5(0xcf)](_0x36a841,_0x334e2d))_0x45a8cf[_0x45a8cf[_0x3df1e5(0xd7)]]=_0x334e2d;return _0x45a8cf;},_0x46f566(_0x23f32d);};return function(_0x4610f7){const _0x4160db=a626_0x3447;if(_0x4610f7&&_0x4610f7['__esModule'])return _0x4610f7;var _0x963066={};if(_0x4610f7!=null){for(var _0x1a59c3=_0x46f566(_0x4610f7),_0x39744a=0x0;_0x39744a<_0x1a59c3[_0x4160db(0xd7)];_0x39744a++)if(_0x1a59c3[_0x39744a]!==_0x4160db(0xe8))__createBinding(_0x963066,_0x4610f7,_0x1a59c3[_0x39744a]);}return __setModuleDefault(_0x963066,_0x4610f7),_0x963066;};}()),__importDefault=this&&this[a626_0x18d0ca(0xeb)]||function(_0x499074){const _0x5c5921=a626_0x18d0ca;return _0x499074&&_0x499074[_0x5c5921(0xc5)]?_0x499074:{'default':_0x499074};};Object[a626_0x18d0ca(0xd9)](exports,a626_0x18d0ca(0xc5),{'value':!![]}),exports[a626_0x18d0ca(0xe8)]=DashboardDataService;const sequelize_1=require(a626_0x18d0ca(0xee)),_=__importStar(require('lodash')),database_1=__importDefault(require(a626_0x18d0ca(0xd2))),CheckSettings_1=require('../../helpers/CheckSettings');async function DashboardDataService(_0x5c618d,_0x4a7892){const _0x476cd7=a626_0x18d0ca,_0x1e208d=await(0x0,CheckSettings_1[_0x476cd7(0xd6)])(Number(_0x5c618d),_0x476cd7(0xc8),'disabled')===_0x476cd7(0xc6),_0x367815=await(0x0,CheckSettings_1[_0x476cd7(0xd6)])(Number(_0x5c618d),_0x476cd7(0xe5),_0x476cd7(0xc6))===_0x476cd7(0xc6),_0x311e4c=_0x367815||_0x1e208d?_0x476cd7(0xdf):'',_0x21692b=_0x476cd7(0xed)+_0x311e4c+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20)\x20\x22supportPending\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(select\x20count(id)\x20from\x20traking\x20where\x20finished)\x20\x22supportFinished\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20select\x20count(leads.id)\x20from\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20select\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ct1.id,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count(tt1.id)\x20total\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20from\x20traking\x20tt1\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Tickets\x22\x20t1\x20on\x20t1.id\x20=\x20tt1.\x22ticketId\x22\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Contacts\x22\x20ct1\x20on\x20ct1.id\x20=\x20t1.\x22contactId\x22\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20group\x20by\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20having\x20count(tt1.id)\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20)\x20leads\x0a\x20\x20\x20\x20\x20\x20\x20\x20)\x20\x22leads\x22\x0a\x20\x20\x20\x20),\x0a\x20\x20\x20\x20attedants\x20as\x20(\x0a\x20\x20\x20\x20\x20\x20select\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.id,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.name,\x0a\x20\x20\x20\x20\x20\x20\x20\x20coalesce(att.\x22avgSupportTime\x22,\x200)\x20\x22avgSupportTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20coalesce(att.\x22avgWaitTime\x22,\x200)\x20\x22avgWaitTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20att.tickets,\x0a\x20\x20\x20\x20\x20\x20\x20\x20att.rating,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(select\x20count(*)\x20>\x200\x20as\x20online\x20from\x20\x22UserSocketSessions\x22\x20us\x20where\x20us.\x22userId\x22\x20=\x20u.id\x20and\x20us.\x22active\x22\x20is\x20True)\x20online,\x0a\x20\x20\x20\x20\x20\x20\x20\x20att.\x22closeCount\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20att.\x22openCount\x22\x0a\x09from\x20\x22Users\x22\x20u\x0a\x20\x20\x20\x20\x20\x20left\x20join\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20select\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u1.id,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u1.\x22name\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(select\x20count(*)\x20>\x200\x20as\x20online\x20from\x20\x22UserSocketSessions\x22\x20us1\x20where\x20us1.\x22userId\x22\x20=\x20u1.id\x20and\x20us1.\x22active\x22\x20is\x20True)\x20\x22online\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20avg(t.\x22supportTime\x22)\x20\x22avgSupportTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20avg(t.\x22waitTime\x22)\x20\x22avgWaitTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count(t.\x22id\x22)\x20tickets,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20coalesce(avg(ur.rate),\x200)\x20rating,\x0a\x09\x09(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20select\x20count(distinct\x20\x22id\x22)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20from\x20traking\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20where\x20\x22finishedAt\x22\x20is\x20not\x20null\x20and\x20\x22companyId\x22\x20=\x20?\x20and\x20\x22userId\x22\x20=\x20u1.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20)\x20\x20AS\x20\x22closeCount\x22\x20\x20\x20,\x20\x09\x09(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20select\x20count(distinct\x20\x22id\x22)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20from\x20traking\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20where\x20\x22startedAt\x22\x20is\x20not\x20null\x20and\x20\x22finishedAt\x22\x20is\x20null\x20and\x20\x22companyId\x22\x20=\x20?\x20and\x20\x22userId\x22\x20=\x20u1.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20)\x20\x20AS\x20\x22openCount\x22\x0a\x09\x09\x20\x20from\x20\x22Users\x22\x20u1\x0a\x20\x20\x20\x20\x20\x20\x20\x20left\x20join\x20traking\x20t\x20on\x20t.\x22userId\x22\x20=\x20u1.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20left\x20join\x20\x22UserRatings\x22\x20ur\x20on\x20ur.\x22userId\x22\x20=\x20t.\x22userId\x22\x20and\x20ur.\x22createdAt\x22::date\x20=\x20t.\x22finishedAt\x22::date\x0a\x20\x20\x20\x20\x20\x20\x20\x20group\x20by\x201,\x202\x0a\x20\x20\x20\x20\x20\x20)\x20att\x20on\x20att.id\x20=\x20u.id\x0a\x20\x20\x20\x20\x20\x20where\x20u.\x22companyId\x22\x20=\x20?\x0a\x20\x20\x20\x20\x20\x20order\x20by\x20att.name\x0a\x20\x20\x20\x20)\x0a\x20\x20\x20\x20select\x0a\x20\x20\x20\x20\x20\x20(select\x20coalesce(jsonb_build_object(\x27counters\x27,\x20c.*)->>\x27counters\x27,\x20\x27{}\x27)::jsonb\x20from\x20counters\x20c)\x20counters,\x0a\x20\x20\x20\x20\x20\x20(select\x20coalesce(json_agg(a.*),\x20\x27[]\x27)::jsonb\x20from\x20attedants\x20a)\x20attendants;\x0a\x20\x20';let _0x131716='where\x20tt.\x22companyId\x22\x20=\x20?';const _0x4e2896=[_0x5c618d];_[_0x476cd7(0xe7)](_0x4a7892,_0x476cd7(0xef))&&(_0x131716+='\x20and\x20tt.\x22createdAt\x22\x20>=\x20(now()\x20-\x20\x27?\x20days\x27::interval)',_0x4e2896[_0x476cd7(0xd5)](parseInt((''+_0x4a7892[_0x476cd7(0xef)])[_0x476cd7(0xda)](/\D/g,''),0xa)));_[_0x476cd7(0xe7)](_0x4a7892,_0x476cd7(0xea))&&(_0x131716+=_0x476cd7(0xec),_0x4e2896[_0x476cd7(0xd5)](_0x4a7892[_0x476cd7(0xea)]+'\x2000:00:00'));_[_0x476cd7(0xe7)](_0x4a7892,_0x476cd7(0xcd))&&(_0x131716+='\x20and\x20tt.\x22createdAt\x22\x20<=\x20?',_0x4e2896['push'](_0x4a7892[_0x476cd7(0xcd)]+_0x476cd7(0xdc)));_0x4e2896['push'](_0x5c618d),_0x4e2896[_0x476cd7(0xd5)](_0x5c618d),_0x4e2896['push'](_0x5c618d),_0x4e2896['push'](_0x5c618d),_0x4e2896[_0x476cd7(0xd5)](_0x5c618d);const _0x23dadc=_0x21692b[_0x476cd7(0xda)](_0x476cd7(0xce),_0x131716),_0x5c00d3=await database_1['default'][_0x476cd7(0xcc)](_0x23dadc,{'replacements':_0x4e2896,'type':sequelize_1[_0x476cd7(0xc9)]['SELECT'],'plain':!![]});return _0x5c00d3;}