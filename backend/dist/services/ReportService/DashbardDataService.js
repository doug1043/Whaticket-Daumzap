'use strict';const a520_0x63cf83=a520_0x1fb6;(function(_0x448ffa,_0x5c6af5){const _0x579f4d=a520_0x1fb6,_0x5af19f=_0x448ffa();while(!![]){try{const _0x507ee8=-parseInt(_0x579f4d(0x12f))/0x1*(-parseInt(_0x579f4d(0x129))/0x2)+parseInt(_0x579f4d(0x14e))/0x3+parseInt(_0x579f4d(0x135))/0x4+parseInt(_0x579f4d(0x14c))/0x5+parseInt(_0x579f4d(0x125))/0x6+-parseInt(_0x579f4d(0x13e))/0x7*(-parseInt(_0x579f4d(0x14f))/0x8)+-parseInt(_0x579f4d(0x141))/0x9;if(_0x507ee8===_0x5c6af5)break;else _0x5af19f['push'](_0x5af19f['shift']());}catch(_0x5f277b){_0x5af19f['push'](_0x5af19f['shift']());}}}(a520_0xe655,0x88564));var __createBinding=this&&this[a520_0x63cf83(0x137)]||(Object[a520_0x63cf83(0x130)]?function(_0x33c40b,_0x26c94e,_0x2b8f83,_0x3005a3){const _0x11c715=a520_0x63cf83;if(_0x3005a3===undefined)_0x3005a3=_0x2b8f83;var _0x487503=Object['getOwnPropertyDescriptor'](_0x26c94e,_0x2b8f83);(!_0x487503||(_0x11c715(0x12a)in _0x487503?!_0x26c94e[_0x11c715(0x126)]:_0x487503[_0x11c715(0x133)]||_0x487503['configurable']))&&(_0x487503={'enumerable':!![],'get':function(){return _0x26c94e[_0x2b8f83];}}),Object['defineProperty'](_0x33c40b,_0x3005a3,_0x487503);}:function(_0x4d0c79,_0x4f41f4,_0x132c97,_0x21970a){if(_0x21970a===undefined)_0x21970a=_0x132c97;_0x4d0c79[_0x21970a]=_0x4f41f4[_0x132c97];}),__setModuleDefault=this&&this[a520_0x63cf83(0x150)]||(Object[a520_0x63cf83(0x130)]?function(_0x4cbbbf,_0x22a6c3){Object['defineProperty'](_0x4cbbbf,'default',{'enumerable':!![],'value':_0x22a6c3});}:function(_0x1a38df,_0x47132c){const _0x22469f=a520_0x63cf83;_0x1a38df[_0x22469f(0x146)]=_0x47132c;}),__importStar=this&&this[a520_0x63cf83(0x12d)]||(function(){const _0x336279=(function(){let _0xe4ea8a=!![];return function(_0x25d696,_0x49edbb){const _0x4c6e18=_0xe4ea8a?function(){const _0x5bc1d4=a520_0x1fb6;if(_0x49edbb){const _0x32d74f=_0x49edbb[_0x5bc1d4(0x13d)](_0x25d696,arguments);return _0x49edbb=null,_0x32d74f;}}:function(){};return _0xe4ea8a=![],_0x4c6e18;};}()),_0x2f834a=_0x336279(this,function(){const _0x1fa617=a520_0x1fb6;return _0x2f834a[_0x1fa617(0x12e)]()[_0x1fa617(0x151)](_0x1fa617(0x13b))[_0x1fa617(0x12e)]()[_0x1fa617(0x128)](_0x2f834a)[_0x1fa617(0x151)](_0x1fa617(0x13b));});_0x2f834a();var _0x254f29=function(_0x8a9219){const _0x478464=a520_0x1fb6;return _0x254f29=Object[_0x478464(0x138)]||function(_0x422586){const _0x2c1942=_0x478464;var _0x4416a1=[];for(var _0x52e4ca in _0x422586)if(Object['prototype'][_0x2c1942(0x12c)]['call'](_0x422586,_0x52e4ca))_0x4416a1[_0x4416a1[_0x2c1942(0x14b)]]=_0x52e4ca;return _0x4416a1;},_0x254f29(_0x8a9219);};return function(_0x572934){const _0xde8a4d=a520_0x1fb6;if(_0x572934&&_0x572934[_0xde8a4d(0x126)])return _0x572934;var _0x39ed95={};if(_0x572934!=null){for(var _0x1c32d4=_0x254f29(_0x572934),_0x47898d=0x0;_0x47898d<_0x1c32d4[_0xde8a4d(0x14b)];_0x47898d++)if(_0x1c32d4[_0x47898d]!=='default')__createBinding(_0x39ed95,_0x572934,_0x1c32d4[_0x47898d]);}return __setModuleDefault(_0x39ed95,_0x572934),_0x39ed95;};}()),__importDefault=this&&this[a520_0x63cf83(0x152)]||function(_0x40bc93){return _0x40bc93&&_0x40bc93['__esModule']?_0x40bc93:{'default':_0x40bc93};};Object[a520_0x63cf83(0x149)](exports,'__esModule',{'value':!![]}),exports[a520_0x63cf83(0x146)]=DashboardDataService;function a520_0x1fb6(_0x343387,_0xa78ddb){const _0x512a81=a520_0xe655();return a520_0x1fb6=function(_0x40e09e,_0x5341ed){_0x40e09e=_0x40e09e-0x125;let _0xe65519=_0x512a81[_0x40e09e];return _0xe65519;},a520_0x1fb6(_0x343387,_0xa78ddb);}function a520_0xe655(){const _0x4c4d7d=['date_to','\x20and\x20tt.\x22createdAt\x22\x20<=\x20?','(((.+)+)+)+$','days','apply','7QizuLn','SELECT','\x0a\x20\x20\x20\x20\x20\x20\x20\x20)\x20\x22supportPending\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(select\x20count(id)\x20from\x20traking\x20where\x20finished)\x20\x22supportFinished\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20select\x20count(leads.id)\x20from\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20select\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ct1.id,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count(tt1.id)\x20total\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20from\x20traking\x20tt1\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Tickets\x22\x20t1\x20on\x20t1.id\x20=\x20tt1.\x22ticketId\x22\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Contacts\x22\x20ct1\x20on\x20ct1.id\x20=\x20t1.\x22contactId\x22\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20group\x20by\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20having\x20count(tt1.id)\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20)\x20leads\x0a\x20\x20\x20\x20\x20\x20\x20\x20)\x20\x22leads\x22\x0a\x20\x20\x20\x20),\x0a\x20\x20\x20\x20attedants\x20as\x20(\x0a\x20\x20\x20\x20\x20\x20select\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.id,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.name,\x0a\x20\x20\x20\x20\x20\x20\x20\x20coalesce(att.\x22avgSupportTime\x22,\x200)\x20\x22avgSupportTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20coalesce(att.\x22avgWaitTime\x22,\x200)\x20\x22avgWaitTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20att.tickets,\x0a\x20\x20\x20\x20\x20\x20\x20\x20att.rating,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(select\x20count(*)\x20>\x200\x20as\x20online\x20from\x20\x22UserSocketSessions\x22\x20us\x20where\x20us.\x22userId\x22\x20=\x20u.id\x20and\x20us.\x22active\x22\x20is\x20True)\x20online,\x0a\x20\x20\x20\x20\x20\x20\x20\x20att.\x22closeCount\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20att.\x22openCount\x22\x0a\x09from\x20\x22Users\x22\x20u\x0a\x20\x20\x20\x20\x20\x20left\x20join\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20select\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u1.id,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u1.\x22name\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(select\x20count(*)\x20>\x200\x20as\x20online\x20from\x20\x22UserSocketSessions\x22\x20us1\x20where\x20us1.\x22userId\x22\x20=\x20u1.id\x20and\x20us1.\x22active\x22\x20is\x20True)\x20\x22online\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20avg(t.\x22supportTime\x22)\x20\x22avgSupportTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20avg(t.\x22waitTime\x22)\x20\x22avgWaitTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count(t.\x22id\x22)\x20tickets,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20coalesce(avg(ur.rate),\x200)\x20rating,\x0a\x09\x09(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20select\x20count(distinct\x20\x22id\x22)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20from\x20traking\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20where\x20\x22finishedAt\x22\x20is\x20not\x20null\x20and\x20\x22companyId\x22\x20=\x20?\x20and\x20\x22userId\x22\x20=\x20u1.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20)\x20\x20AS\x20\x22closeCount\x22\x20\x20\x20,\x20\x09\x09(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20select\x20count(distinct\x20\x22id\x22)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20from\x20traking\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20where\x20\x22startedAt\x22\x20is\x20not\x20null\x20and\x20\x22finishedAt\x22\x20is\x20null\x20and\x20\x22companyId\x22\x20=\x20?\x20and\x20\x22userId\x22\x20=\x20u1.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20)\x20\x20AS\x20\x22openCount\x22\x0a\x09\x09\x20\x20from\x20\x22Users\x22\x20u1\x0a\x20\x20\x20\x20\x20\x20\x20\x20left\x20join\x20traking\x20t\x20on\x20t.\x22userId\x22\x20=\x20u1.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20left\x20join\x20\x22UserRatings\x22\x20ur\x20on\x20ur.\x22userId\x22\x20=\x20t.\x22userId\x22\x20and\x20ur.\x22createdAt\x22::date\x20=\x20t.\x22finishedAt\x22::date\x0a\x20\x20\x20\x20\x20\x20\x20\x20group\x20by\x201,\x202\x0a\x20\x20\x20\x20\x20\x20)\x20att\x20on\x20att.id\x20=\x20u.id\x0a\x20\x20\x20\x20\x20\x20where\x20u.\x22companyId\x22\x20=\x20?\x0a\x20\x20\x20\x20\x20\x20order\x20by\x20att.name\x0a\x20\x20\x20\x20)\x0a\x20\x20\x20\x20select\x0a\x20\x20\x20\x20\x20\x20(select\x20coalesce(jsonb_build_object(\x27counters\x27,\x20c.*)->>\x27counters\x27,\x20\x27{}\x27)::jsonb\x20from\x20counters\x20c)\x20counters,\x0a\x20\x20\x20\x20\x20\x20(select\x20coalesce(json_agg(a.*),\x20\x27[]\x27)::jsonb\x20from\x20attedants\x20a)\x20attendants;\x0a\x20\x20','19084995HmspGk','\x20and\x20tt.\x22createdAt\x22\x20>=\x20(now()\x20-\x20\x27?\x20days\x27::interval)','enabled','where\x20tt.\x22companyId\x22\x20=\x20?','date_from','default','--\x20filterPeriod','CheckMsgIsGroup','defineProperty','push','length','2449020BIYcAO','has','71181owqsiC','2746976kEeNPD','__setModuleDefault','search','__importDefault','2811528XSAxGH','__esModule','disabled','constructor','117482MUzoFa','get','../../database','hasOwnProperty','__importStar','toString','15PvUQlt','create','\x20and\x20tt.\x22createdAt\x22\x20>=\x20?','GetCompanySetting','writable','\x2000:00:00','1889540AVTBtp','AND\x20NOT\x20\x22isGroup\x22','__createBinding','getOwnPropertyNames'];a520_0xe655=function(){return _0x4c4d7d;};return a520_0xe655();}const sequelize_1=require('sequelize'),_=__importStar(require('lodash')),database_1=__importDefault(require(a520_0x63cf83(0x12b))),CheckSettings_1=require('../../helpers/CheckSettings');async function DashboardDataService(_0x5c472a,_0x529e66){const _0x15acef=a520_0x63cf83,_0x81ea2a=await(0x0,CheckSettings_1[_0x15acef(0x132)])(Number(_0x5c472a),'groupsTab',_0x15acef(0x127))===_0x15acef(0x143),_0x5cc2cb=await(0x0,CheckSettings_1['GetCompanySetting'])(Number(_0x5c472a),_0x15acef(0x148),'enabled')===_0x15acef(0x143),_0x36dc7b=_0x5cc2cb||_0x81ea2a?_0x15acef(0x136):'',_0x91d55e='\x0a\x20\x20\x20\x20with\x0a\x20\x20\x20\x20traking\x20as\x20(\x0a\x20\x20\x20\x20\x20\x20select\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.name\x20\x22companyName\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.name\x20\x22userName\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(select\x20count(*)\x20>\x200\x20as\x20online\x20from\x20\x22UserSocketSessions\x22\x20tu\x20where\x20tu.\x22userId\x22\x20=\x20tt.\x22userId\x22\x20and\x20tu.\x22active\x22\x20is\x20True)\x20\x22userOnline\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20w.name\x20\x22whatsappName\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20ct.name\x20\x22contactName\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20ct.number\x20\x22contactNumber\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(tt.\x22finishedAt\x22\x20is\x20not\x20null)\x20\x22finished\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(tt.\x22userId\x22\x20is\x20null\x20and\x20tt.\x22finishedAt\x22\x20is\x20null)\x20\x22pending\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(tt.\x22startedAt\x22\x20is\x20not\x20null\x20and\x20tt.\x22finishedAt\x22\x20is\x20null)\x20\x22open\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20coalesce((\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(date_part(\x27day\x27,\x20age(coalesce(tt.\x22ratingAt\x22,\x20tt.\x22finishedAt\x22)\x20,\x20tt.\x22startedAt\x22))\x20*\x2024\x20*\x2060)\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(date_part(\x27hour\x27,\x20age(coalesce(tt.\x22ratingAt\x22,\x20tt.\x22finishedAt\x22),\x20tt.\x22startedAt\x22))\x20*\x2060)\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(date_part(\x27minutes\x27,\x20age(coalesce(tt.\x22ratingAt\x22,\x20tt.\x22finishedAt\x22),\x20tt.\x22startedAt\x22)))\x0a\x20\x20\x20\x20\x20\x20\x20\x20),\x200)\x20\x22supportTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20coalesce((\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(date_part(\x27day\x27,\x20age(tt.\x22startedAt\x22,\x20tt.\x22queuedAt\x22))\x20*\x2024\x20*\x2060)\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(date_part(\x27hour\x27,\x20age(tt.\x22startedAt\x22,\x20tt.\x22queuedAt\x22))\x20*\x2060)\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(date_part(\x27minutes\x27,\x20age(tt.\x22startedAt\x22,\x20tt.\x22queuedAt\x22)))\x0a\x20\x20\x20\x20\x20\x20\x20\x20),\x200)\x20\x22waitTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20t.status,\x0a\x20\x20\x20\x20\x20\x20\x20\x20tt.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20ct.\x22id\x22\x20\x22contactId\x22\x0a\x20\x20\x20\x20\x20\x20from\x20\x22TicketTraking\x22\x20tt\x0a\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Companies\x22\x20c\x20on\x20c.id\x20=\x20tt.\x22companyId\x22\x0a\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Users\x22\x20u\x20on\x20u.id\x20=\x20tt.\x22userId\x22\x0a\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Whatsapps\x22\x20w\x20on\x20w.id\x20=\x20tt.\x22whatsappId\x22\x0a\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Tickets\x22\x20t\x20on\x20t.id\x20=\x20tt.\x22ticketId\x22\x0a\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Contacts\x22\x20ct\x20on\x20ct.id\x20=\x20t.\x22contactId\x22\x0a\x20\x20\x20\x20\x20\x20--\x20filterPeriod\x0a\x20\x20\x20\x20),\x0a\x20\x20\x20\x20counters\x20as\x20(\x0a\x20\x20\x20\x20\x20\x20select\x0a\x20\x20\x20\x20\x20\x20\x20\x20(select\x20avg(\x22supportTime\x22)\x20from\x20traking\x20where\x20\x22supportTime\x22\x20>\x200)\x20\x22avgSupportTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(select\x20avg(\x22waitTime\x22)\x20from\x20traking\x20where\x20\x22waitTime\x22\x20>\x200)\x20\x22avgWaitTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20select\x20count(distinct\x20\x22id\x22)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20from\x20\x22Tickets\x22\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20where\x20status\x20like\x20\x27open\x27\x20and\x20\x22companyId\x22\x20=\x20?\x0a\x20\x20\x20\x20\x20\x20\x20\x20)\x20\x22supportHappening\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20select\x20count(distinct\x20\x22id\x22)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20from\x20\x22Tickets\x22\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20where\x20status\x20like\x20\x27pending\x27\x20and\x20\x22companyId\x22\x20=\x20?\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+_0x36dc7b+_0x15acef(0x140);let _0x455925=_0x15acef(0x144);const _0x47330e=[_0x5c472a];_[_0x15acef(0x14d)](_0x529e66,_0x15acef(0x13c))&&(_0x455925+=_0x15acef(0x142),_0x47330e[_0x15acef(0x14a)](parseInt((''+_0x529e66[_0x15acef(0x13c)])['replace'](/\D/g,''),0xa)));_[_0x15acef(0x14d)](_0x529e66,_0x15acef(0x145))&&(_0x455925+=_0x15acef(0x131),_0x47330e['push'](_0x529e66['date_from']+_0x15acef(0x134)));_[_0x15acef(0x14d)](_0x529e66,_0x15acef(0x139))&&(_0x455925+=_0x15acef(0x13a),_0x47330e[_0x15acef(0x14a)](_0x529e66['date_to']+'\x2023:59:59'));_0x47330e[_0x15acef(0x14a)](_0x5c472a),_0x47330e[_0x15acef(0x14a)](_0x5c472a),_0x47330e[_0x15acef(0x14a)](_0x5c472a),_0x47330e[_0x15acef(0x14a)](_0x5c472a),_0x47330e[_0x15acef(0x14a)](_0x5c472a);const _0x89892e=_0x91d55e['replace'](_0x15acef(0x147),_0x455925),_0xc20b30=await database_1[_0x15acef(0x146)]['query'](_0x89892e,{'replacements':_0x47330e,'type':sequelize_1['QueryTypes'][_0x15acef(0x13f)],'plain':!![]});return _0xc20b30;}