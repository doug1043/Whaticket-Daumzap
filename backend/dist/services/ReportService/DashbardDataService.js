'use strict';const a625_0x46a90b=a625_0x35fa;(function(_0x10f966,_0xb844f0){const _0x51448a=a625_0x35fa,_0x1beeb7=_0x10f966();while(!![]){try{const _0x39ccb8=-parseInt(_0x51448a(0xc4))/0x1*(parseInt(_0x51448a(0xc5))/0x2)+parseInt(_0x51448a(0xa0))/0x3+parseInt(_0x51448a(0xc7))/0x4+parseInt(_0x51448a(0xa1))/0x5*(-parseInt(_0x51448a(0xb7))/0x6)+parseInt(_0x51448a(0xb8))/0x7*(parseInt(_0x51448a(0xcd))/0x8)+-parseInt(_0x51448a(0xb9))/0x9+parseInt(_0x51448a(0xa5))/0xa*(parseInt(_0x51448a(0xb3))/0xb);if(_0x39ccb8===_0xb844f0)break;else _0x1beeb7['push'](_0x1beeb7['shift']());}catch(_0x3b75e0){_0x1beeb7['push'](_0x1beeb7['shift']());}}}(a625_0x47ff,0x6fc2b));function a625_0x47ff(){const _0x69d013=['(((.+)+)+)+$','enabled','--\x20filterPeriod','\x0a\x20\x20\x20\x20with\x0a\x20\x20\x20\x20traking\x20as\x20(\x0a\x20\x20\x20\x20\x20\x20select\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.name\x20\x22companyName\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.name\x20\x22userName\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(select\x20count(*)\x20>\x200\x20as\x20online\x20from\x20\x22UserSocketSessions\x22\x20tu\x20where\x20tu.\x22userId\x22\x20=\x20tt.\x22userId\x22\x20and\x20tu.\x22active\x22\x20is\x20True)\x20\x22userOnline\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20w.name\x20\x22whatsappName\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20ct.name\x20\x22contactName\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20ct.number\x20\x22contactNumber\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(tt.\x22finishedAt\x22\x20is\x20not\x20null)\x20\x22finished\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(tt.\x22userId\x22\x20is\x20null\x20and\x20tt.\x22finishedAt\x22\x20is\x20null)\x20\x22pending\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(tt.\x22startedAt\x22\x20is\x20not\x20null\x20and\x20tt.\x22finishedAt\x22\x20is\x20null)\x20\x22open\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20coalesce((\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(date_part(\x27day\x27,\x20age(coalesce(tt.\x22ratingAt\x22,\x20tt.\x22finishedAt\x22)\x20,\x20tt.\x22startedAt\x22))\x20*\x2024\x20*\x2060)\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(date_part(\x27hour\x27,\x20age(coalesce(tt.\x22ratingAt\x22,\x20tt.\x22finishedAt\x22),\x20tt.\x22startedAt\x22))\x20*\x2060)\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(date_part(\x27minutes\x27,\x20age(coalesce(tt.\x22ratingAt\x22,\x20tt.\x22finishedAt\x22),\x20tt.\x22startedAt\x22)))\x0a\x20\x20\x20\x20\x20\x20\x20\x20),\x200)\x20\x22supportTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20coalesce((\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(date_part(\x27day\x27,\x20age(tt.\x22startedAt\x22,\x20tt.\x22queuedAt\x22))\x20*\x2024\x20*\x2060)\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(date_part(\x27hour\x27,\x20age(tt.\x22startedAt\x22,\x20tt.\x22queuedAt\x22))\x20*\x2060)\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(date_part(\x27minutes\x27,\x20age(tt.\x22startedAt\x22,\x20tt.\x22queuedAt\x22)))\x0a\x20\x20\x20\x20\x20\x20\x20\x20),\x200)\x20\x22waitTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20t.status,\x0a\x20\x20\x20\x20\x20\x20\x20\x20tt.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20ct.\x22id\x22\x20\x22contactId\x22\x0a\x20\x20\x20\x20\x20\x20from\x20\x22TicketTraking\x22\x20tt\x0a\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Companies\x22\x20c\x20on\x20c.id\x20=\x20tt.\x22companyId\x22\x0a\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Users\x22\x20u\x20on\x20u.id\x20=\x20tt.\x22userId\x22\x0a\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Whatsapps\x22\x20w\x20on\x20w.id\x20=\x20tt.\x22whatsappId\x22\x0a\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Tickets\x22\x20t\x20on\x20t.id\x20=\x20tt.\x22ticketId\x22\x0a\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Contacts\x22\x20ct\x20on\x20ct.id\x20=\x20t.\x22contactId\x22\x0a\x20\x20\x20\x20\x20\x20--\x20filterPeriod\x0a\x20\x20\x20\x20),\x0a\x20\x20\x20\x20counters\x20as\x20(\x0a\x20\x20\x20\x20\x20\x20select\x0a\x20\x20\x20\x20\x20\x20\x20\x20(select\x20avg(\x22supportTime\x22)\x20from\x20traking\x20where\x20\x22supportTime\x22\x20>\x200)\x20\x22avgSupportTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(select\x20avg(\x22waitTime\x22)\x20from\x20traking\x20where\x20\x22waitTime\x22\x20>\x200)\x20\x22avgWaitTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20select\x20count(distinct\x20\x22id\x22)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20from\x20\x22Tickets\x22\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20where\x20status\x20like\x20\x27open\x27\x20and\x20\x22companyId\x22\x20=\x20?\x0a\x20\x20\x20\x20\x20\x20\x20\x20)\x20\x22supportHappening\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20select\x20count(distinct\x20\x22id\x22)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20from\x20\x22Tickets\x22\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20where\x20status\x20like\x20\x27pending\x27\x20and\x20\x22companyId\x22\x20=\x20?\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','has','__importStar','11Dtnkhe','length','replace','constructor','42hoBvil','2534uSBviG','3292047dyRWgV','__esModule','date_to','__setModuleDefault','prototype','writable','apply','../../helpers/CheckSettings','push','lodash','toString','276423rUdJEE','2yxhjVC','query','1275844fwvlXY','call','configurable','\x20and\x20tt.\x22createdAt\x22\x20>=\x20?','disabled','hasOwnProperty','18832HHqIid','CheckMsgIsGroup','QueryTypes','799578kSeOWb','545660ssMNek','date_from','groupsTab','create','4262660eLKUux','__createBinding','\x2000:00:00','defineProperty','default','__importDefault','where\x20tt.\x22companyId\x22\x20=\x20?','SELECT'];a625_0x47ff=function(){return _0x69d013;};return a625_0x47ff();}var __createBinding=this&&this[a625_0x46a90b(0xa6)]||(Object[a625_0x46a90b(0xa4)]?function(_0x3d8131,_0x33f029,_0x3fbc17,_0x5c5dee){const _0x3573d7=a625_0x46a90b;if(_0x5c5dee===undefined)_0x5c5dee=_0x3fbc17;var _0xdc1658=Object['getOwnPropertyDescriptor'](_0x33f029,_0x3fbc17);(!_0xdc1658||('get'in _0xdc1658?!_0x33f029[_0x3573d7(0xba)]:_0xdc1658[_0x3573d7(0xbe)]||_0xdc1658[_0x3573d7(0xc9)]))&&(_0xdc1658={'enumerable':!![],'get':function(){return _0x33f029[_0x3fbc17];}}),Object[_0x3573d7(0xa8)](_0x3d8131,_0x5c5dee,_0xdc1658);}:function(_0x228f7d,_0x477b2c,_0x14d348,_0x543968){if(_0x543968===undefined)_0x543968=_0x14d348;_0x228f7d[_0x543968]=_0x477b2c[_0x14d348];}),__setModuleDefault=this&&this[a625_0x46a90b(0xbc)]||(Object[a625_0x46a90b(0xa4)]?function(_0x2153de,_0x4c4beb){Object['defineProperty'](_0x2153de,'default',{'enumerable':!![],'value':_0x4c4beb});}:function(_0x5245b5,_0x4c7129){_0x5245b5['default']=_0x4c7129;}),__importStar=this&&this[a625_0x46a90b(0xb2)]||(function(){const _0x25178b=(function(){let _0x3b4a1a=!![];return function(_0x559ad7,_0x288e36){const _0x171dd1=_0x3b4a1a?function(){const _0x413dee=a625_0x35fa;if(_0x288e36){const _0x50f76a=_0x288e36[_0x413dee(0xbf)](_0x559ad7,arguments);return _0x288e36=null,_0x50f76a;}}:function(){};return _0x3b4a1a=![],_0x171dd1;};}()),_0x8b34f9=_0x25178b(this,function(){const _0x44435b=a625_0x35fa;return _0x8b34f9[_0x44435b(0xc3)]()['search'](_0x44435b(0xad))[_0x44435b(0xc3)]()[_0x44435b(0xb6)](_0x8b34f9)['search']('(((.+)+)+)+$');});_0x8b34f9();var _0xa41e6a=function(_0x33d0ba){return _0xa41e6a=Object['getOwnPropertyNames']||function(_0x949cac){const _0x154761=a625_0x35fa;var _0x25a9b7=[];for(var _0x1e8520 in _0x949cac)if(Object[_0x154761(0xbd)][_0x154761(0xcc)][_0x154761(0xc8)](_0x949cac,_0x1e8520))_0x25a9b7[_0x25a9b7[_0x154761(0xb4)]]=_0x1e8520;return _0x25a9b7;},_0xa41e6a(_0x33d0ba);};return function(_0x5c71be){const _0x5993b3=a625_0x35fa;if(_0x5c71be&&_0x5c71be[_0x5993b3(0xba)])return _0x5c71be;var _0x3e359e={};if(_0x5c71be!=null){for(var _0x3c708e=_0xa41e6a(_0x5c71be),_0x25c7df=0x0;_0x25c7df<_0x3c708e[_0x5993b3(0xb4)];_0x25c7df++)if(_0x3c708e[_0x25c7df]!==_0x5993b3(0xa9))__createBinding(_0x3e359e,_0x5c71be,_0x3c708e[_0x25c7df]);}return __setModuleDefault(_0x3e359e,_0x5c71be),_0x3e359e;};}()),__importDefault=this&&this[a625_0x46a90b(0xaa)]||function(_0x5a97d8){const _0x3a43df=a625_0x46a90b;return _0x5a97d8&&_0x5a97d8[_0x3a43df(0xba)]?_0x5a97d8:{'default':_0x5a97d8};};Object['defineProperty'](exports,a625_0x46a90b(0xba),{'value':!![]}),exports[a625_0x46a90b(0xa9)]=DashboardDataService;const sequelize_1=require('sequelize'),_=__importStar(require(a625_0x46a90b(0xc2))),database_1=__importDefault(require('../../database')),CheckSettings_1=require(a625_0x46a90b(0xc0));function a625_0x35fa(_0x5cd191,_0x5e6f7e){const _0x3c0542=a625_0x47ff();return a625_0x35fa=function(_0x58fef8,_0x52c272){_0x58fef8=_0x58fef8-0xa0;let _0x47ff96=_0x3c0542[_0x58fef8];return _0x47ff96;},a625_0x35fa(_0x5cd191,_0x5e6f7e);}async function DashboardDataService(_0x51cfcf,_0x233382){const _0x32ed28=a625_0x46a90b,_0xcea194=await(0x0,CheckSettings_1['GetCompanySetting'])(Number(_0x51cfcf),_0x32ed28(0xa3),_0x32ed28(0xcb))===_0x32ed28(0xae),_0x3d67a9=await(0x0,CheckSettings_1['GetCompanySetting'])(Number(_0x51cfcf),_0x32ed28(0xce),_0x32ed28(0xae))===_0x32ed28(0xae),_0x1f56a7=_0x3d67a9||_0xcea194?'AND\x20NOT\x20\x22isGroup\x22':'',_0xb65dae=_0x32ed28(0xb0)+_0x1f56a7+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20)\x20\x22supportPending\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(select\x20count(id)\x20from\x20traking\x20where\x20finished)\x20\x22supportFinished\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20select\x20count(leads.id)\x20from\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20select\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ct1.id,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count(tt1.id)\x20total\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20from\x20traking\x20tt1\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Tickets\x22\x20t1\x20on\x20t1.id\x20=\x20tt1.\x22ticketId\x22\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Contacts\x22\x20ct1\x20on\x20ct1.id\x20=\x20t1.\x22contactId\x22\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20group\x20by\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20having\x20count(tt1.id)\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20)\x20leads\x0a\x20\x20\x20\x20\x20\x20\x20\x20)\x20\x22leads\x22\x0a\x20\x20\x20\x20),\x0a\x20\x20\x20\x20attedants\x20as\x20(\x0a\x20\x20\x20\x20\x20\x20select\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.id,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.name,\x0a\x20\x20\x20\x20\x20\x20\x20\x20coalesce(att.\x22avgSupportTime\x22,\x200)\x20\x22avgSupportTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20coalesce(att.\x22avgWaitTime\x22,\x200)\x20\x22avgWaitTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20att.tickets,\x0a\x20\x20\x20\x20\x20\x20\x20\x20att.rating,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(select\x20count(*)\x20>\x200\x20as\x20online\x20from\x20\x22UserSocketSessions\x22\x20us\x20where\x20us.\x22userId\x22\x20=\x20u.id\x20and\x20us.\x22active\x22\x20is\x20True)\x20online,\x0a\x20\x20\x20\x20\x20\x20\x20\x20att.\x22closeCount\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20att.\x22openCount\x22\x0a\x09from\x20\x22Users\x22\x20u\x0a\x20\x20\x20\x20\x20\x20left\x20join\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20select\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u1.id,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u1.\x22name\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(select\x20count(*)\x20>\x200\x20as\x20online\x20from\x20\x22UserSocketSessions\x22\x20us1\x20where\x20us1.\x22userId\x22\x20=\x20u1.id\x20and\x20us1.\x22active\x22\x20is\x20True)\x20\x22online\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20avg(t.\x22supportTime\x22)\x20\x22avgSupportTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20avg(t.\x22waitTime\x22)\x20\x22avgWaitTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count(t.\x22id\x22)\x20tickets,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20coalesce(avg(ur.rate),\x200)\x20rating,\x0a\x09\x09(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20select\x20count(distinct\x20\x22id\x22)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20from\x20traking\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20where\x20\x22finishedAt\x22\x20is\x20not\x20null\x20and\x20\x22companyId\x22\x20=\x20?\x20and\x20\x22userId\x22\x20=\x20u1.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20)\x20\x20AS\x20\x22closeCount\x22\x20\x20\x20,\x20\x09\x09(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20select\x20count(distinct\x20\x22id\x22)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20from\x20traking\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20where\x20\x22startedAt\x22\x20is\x20not\x20null\x20and\x20\x22finishedAt\x22\x20is\x20null\x20and\x20\x22companyId\x22\x20=\x20?\x20and\x20\x22userId\x22\x20=\x20u1.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20)\x20\x20AS\x20\x22openCount\x22\x0a\x09\x09\x20\x20from\x20\x22Users\x22\x20u1\x0a\x20\x20\x20\x20\x20\x20\x20\x20left\x20join\x20traking\x20t\x20on\x20t.\x22userId\x22\x20=\x20u1.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20left\x20join\x20\x22UserRatings\x22\x20ur\x20on\x20ur.\x22userId\x22\x20=\x20t.\x22userId\x22\x20and\x20ur.\x22createdAt\x22::date\x20=\x20t.\x22finishedAt\x22::date\x0a\x20\x20\x20\x20\x20\x20\x20\x20group\x20by\x201,\x202\x0a\x20\x20\x20\x20\x20\x20)\x20att\x20on\x20att.id\x20=\x20u.id\x0a\x20\x20\x20\x20\x20\x20where\x20u.\x22companyId\x22\x20=\x20?\x0a\x20\x20\x20\x20\x20\x20order\x20by\x20att.name\x0a\x20\x20\x20\x20)\x0a\x20\x20\x20\x20select\x0a\x20\x20\x20\x20\x20\x20(select\x20coalesce(jsonb_build_object(\x27counters\x27,\x20c.*)->>\x27counters\x27,\x20\x27{}\x27)::jsonb\x20from\x20counters\x20c)\x20counters,\x0a\x20\x20\x20\x20\x20\x20(select\x20coalesce(json_agg(a.*),\x20\x27[]\x27)::jsonb\x20from\x20attedants\x20a)\x20attendants;\x0a\x20\x20';let _0x12ee1f=_0x32ed28(0xab);const _0x33526a=[_0x51cfcf];_[_0x32ed28(0xb1)](_0x233382,'days')&&(_0x12ee1f+='\x20and\x20tt.\x22createdAt\x22\x20>=\x20(now()\x20-\x20\x27?\x20days\x27::interval)',_0x33526a[_0x32ed28(0xc1)](parseInt((''+_0x233382['days'])[_0x32ed28(0xb5)](/\D/g,''),0xa)));_[_0x32ed28(0xb1)](_0x233382,_0x32ed28(0xa2))&&(_0x12ee1f+=_0x32ed28(0xca),_0x33526a[_0x32ed28(0xc1)](_0x233382[_0x32ed28(0xa2)]+_0x32ed28(0xa7)));_[_0x32ed28(0xb1)](_0x233382,_0x32ed28(0xbb))&&(_0x12ee1f+='\x20and\x20tt.\x22createdAt\x22\x20<=\x20?',_0x33526a[_0x32ed28(0xc1)](_0x233382[_0x32ed28(0xbb)]+'\x2023:59:59'));_0x33526a['push'](_0x51cfcf),_0x33526a[_0x32ed28(0xc1)](_0x51cfcf),_0x33526a['push'](_0x51cfcf),_0x33526a[_0x32ed28(0xc1)](_0x51cfcf),_0x33526a['push'](_0x51cfcf);const _0xf94fb8=_0xb65dae[_0x32ed28(0xb5)](_0x32ed28(0xaf),_0x12ee1f),_0x39edb2=await database_1[_0x32ed28(0xa9)][_0x32ed28(0xc6)](_0xf94fb8,{'replacements':_0x33526a,'type':sequelize_1[_0x32ed28(0xcf)][_0x32ed28(0xac)],'plain':!![]});return _0x39edb2;}