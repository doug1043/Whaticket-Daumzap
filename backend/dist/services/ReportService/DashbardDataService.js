'use strict';const a511_0x25baf5=a511_0x37c4;(function(_0x4677b6,_0x1d74d6){const _0xaa87a3=a511_0x37c4,_0x37e472=_0x4677b6();while(!![]){try{const _0x7a71a2=parseInt(_0xaa87a3(0x102))/0x1*(-parseInt(_0xaa87a3(0xf7))/0x2)+parseInt(_0xaa87a3(0x11a))/0x3*(parseInt(_0xaa87a3(0x104))/0x4)+-parseInt(_0xaa87a3(0x113))/0x5+-parseInt(_0xaa87a3(0x114))/0x6*(parseInt(_0xaa87a3(0x122))/0x7)+parseInt(_0xaa87a3(0x11f))/0x8+parseInt(_0xaa87a3(0x10d))/0x9+parseInt(_0xaa87a3(0x10f))/0xa;if(_0x7a71a2===_0x1d74d6)break;else _0x37e472['push'](_0x37e472['shift']());}catch(_0x262268){_0x37e472['push'](_0x37e472['shift']());}}}(a511_0x1d0d,0x1928a));function a511_0x1d0d(){const _0x35c030=['push','date_to','\x20and\x20tt.\x22createdAt\x22\x20>=\x20?','515456WgGgtT','enabled','configurable','30779uQIhzj','get','replace','default','search','--\x20filterPeriod','(((.+)+)+)+$','42KqZqYg','\x20and\x20tt.\x22createdAt\x22\x20>=\x20(now()\x20-\x20\x27?\x20days\x27::interval)','__setModuleDefault','call','groupsTab','GetCompanySetting','CheckMsgIsGroup','QueryTypes','../../helpers/CheckSettings','toString','defineProperty','579AbMnFV','create','144feiqgR','days','length','where\x20tt.\x22companyId\x22\x20=\x20?','SELECT','disabled','__importDefault','\x0a\x20\x20\x20\x20with\x0a\x20\x20\x20\x20traking\x20as\x20(\x0a\x20\x20\x20\x20\x20\x20select\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.name\x20\x22companyName\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.name\x20\x22userName\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(select\x20count(*)\x20>\x200\x20as\x20online\x20from\x20\x22UserSocketSessions\x22\x20tu\x20where\x20tu.\x22userId\x22\x20=\x20tt.\x22userId\x22\x20and\x20tu.\x22active\x22\x20is\x20True)\x20\x22userOnline\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20w.name\x20\x22whatsappName\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20ct.name\x20\x22contactName\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20ct.number\x20\x22contactNumber\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(tt.\x22finishedAt\x22\x20is\x20not\x20null)\x20\x22finished\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(tt.\x22userId\x22\x20is\x20null\x20and\x20tt.\x22finishedAt\x22\x20is\x20null)\x20\x22pending\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(tt.\x22startedAt\x22\x20is\x20not\x20null\x20and\x20tt.\x22finishedAt\x22\x20is\x20null)\x20\x22open\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20coalesce((\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(date_part(\x27day\x27,\x20age(coalesce(tt.\x22ratingAt\x22,\x20tt.\x22finishedAt\x22)\x20,\x20tt.\x22startedAt\x22))\x20*\x2024\x20*\x2060)\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(date_part(\x27hour\x27,\x20age(coalesce(tt.\x22ratingAt\x22,\x20tt.\x22finishedAt\x22),\x20tt.\x22startedAt\x22))\x20*\x2060)\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(date_part(\x27minutes\x27,\x20age(coalesce(tt.\x22ratingAt\x22,\x20tt.\x22finishedAt\x22),\x20tt.\x22startedAt\x22)))\x0a\x20\x20\x20\x20\x20\x20\x20\x20),\x200)\x20\x22supportTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20coalesce((\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(date_part(\x27day\x27,\x20age(tt.\x22startedAt\x22,\x20tt.\x22queuedAt\x22))\x20*\x2024\x20*\x2060)\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(date_part(\x27hour\x27,\x20age(tt.\x22startedAt\x22,\x20tt.\x22queuedAt\x22))\x20*\x2060)\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(date_part(\x27minutes\x27,\x20age(tt.\x22startedAt\x22,\x20tt.\x22queuedAt\x22)))\x0a\x20\x20\x20\x20\x20\x20\x20\x20),\x200)\x20\x22waitTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20t.status,\x0a\x20\x20\x20\x20\x20\x20\x20\x20tt.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20ct.\x22id\x22\x20\x22contactId\x22\x0a\x20\x20\x20\x20\x20\x20from\x20\x22TicketTraking\x22\x20tt\x0a\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Companies\x22\x20c\x20on\x20c.id\x20=\x20tt.\x22companyId\x22\x0a\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Users\x22\x20u\x20on\x20u.id\x20=\x20tt.\x22userId\x22\x0a\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Whatsapps\x22\x20w\x20on\x20w.id\x20=\x20tt.\x22whatsappId\x22\x0a\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Tickets\x22\x20t\x20on\x20t.id\x20=\x20tt.\x22ticketId\x22\x0a\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Contacts\x22\x20ct\x20on\x20ct.id\x20=\x20t.\x22contactId\x22\x0a\x20\x20\x20\x20\x20\x20--\x20filterPeriod\x0a\x20\x20\x20\x20),\x0a\x20\x20\x20\x20counters\x20as\x20(\x0a\x20\x20\x20\x20\x20\x20select\x0a\x20\x20\x20\x20\x20\x20\x20\x20(select\x20avg(\x22supportTime\x22)\x20from\x20traking\x20where\x20\x22supportTime\x22\x20>\x200)\x20\x22avgSupportTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(select\x20avg(\x22waitTime\x22)\x20from\x20traking\x20where\x20\x22waitTime\x22\x20>\x200)\x20\x22avgWaitTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20select\x20count(distinct\x20\x22id\x22)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20from\x20\x22Tickets\x22\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20where\x20status\x20like\x20\x27open\x27\x20and\x20\x22companyId\x22\x20=\x20?\x0a\x20\x20\x20\x20\x20\x20\x20\x20)\x20\x22supportHappening\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20select\x20count(distinct\x20\x22id\x22)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20from\x20\x22Tickets\x22\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20where\x20status\x20like\x20\x27pending\x27\x20and\x20\x22companyId\x22\x20=\x20?\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','prototype','274365VZmKCr','\x0a\x20\x20\x20\x20\x20\x20\x20\x20)\x20\x22supportPending\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(select\x20count(id)\x20from\x20traking\x20where\x20finished)\x20\x22supportFinished\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20select\x20count(leads.id)\x20from\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20select\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ct1.id,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count(tt1.id)\x20total\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20from\x20traking\x20tt1\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Tickets\x22\x20t1\x20on\x20t1.id\x20=\x20tt1.\x22ticketId\x22\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Contacts\x22\x20ct1\x20on\x20ct1.id\x20=\x20t1.\x22contactId\x22\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20group\x20by\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20having\x20count(tt1.id)\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20)\x20leads\x0a\x20\x20\x20\x20\x20\x20\x20\x20)\x20\x22leads\x22\x0a\x20\x20\x20\x20),\x0a\x20\x20\x20\x20attedants\x20as\x20(\x0a\x20\x20\x20\x20\x20\x20select\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.id,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.name,\x0a\x20\x20\x20\x20\x20\x20\x20\x20coalesce(att.\x22avgSupportTime\x22,\x200)\x20\x22avgSupportTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20coalesce(att.\x22avgWaitTime\x22,\x200)\x20\x22avgWaitTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20att.tickets,\x0a\x20\x20\x20\x20\x20\x20\x20\x20att.rating,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(select\x20count(*)\x20>\x200\x20as\x20online\x20from\x20\x22UserSocketSessions\x22\x20us\x20where\x20us.\x22userId\x22\x20=\x20u.id\x20and\x20us.\x22active\x22\x20is\x20True)\x20online,\x0a\x20\x20\x20\x20\x20\x20\x20\x20att.\x22closeCount\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20att.\x22openCount\x22\x0a\x09from\x20\x22Users\x22\x20u\x0a\x20\x20\x20\x20\x20\x20left\x20join\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20select\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u1.id,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u1.\x22name\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(select\x20count(*)\x20>\x200\x20as\x20online\x20from\x20\x22UserSocketSessions\x22\x20us1\x20where\x20us1.\x22userId\x22\x20=\x20u1.id\x20and\x20us1.\x22active\x22\x20is\x20True)\x20\x22online\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20avg(t.\x22supportTime\x22)\x20\x22avgSupportTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20avg(t.\x22waitTime\x22)\x20\x22avgWaitTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count(t.\x22id\x22)\x20tickets,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20coalesce(avg(ur.rate),\x200)\x20rating,\x0a\x09\x09(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20select\x20count(distinct\x20\x22id\x22)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20from\x20traking\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20where\x20\x22finishedAt\x22\x20is\x20not\x20null\x20and\x20\x22companyId\x22\x20=\x20?\x20and\x20\x22userId\x22\x20=\x20u1.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20)\x20\x20AS\x20\x22closeCount\x22\x20\x20\x20,\x20\x09\x09(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20select\x20count(distinct\x20\x22id\x22)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20from\x20traking\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20where\x20\x22startedAt\x22\x20is\x20not\x20null\x20and\x20\x22finishedAt\x22\x20is\x20null\x20and\x20\x22companyId\x22\x20=\x20?\x20and\x20\x22userId\x22\x20=\x20u1.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20)\x20\x20AS\x20\x22openCount\x22\x0a\x09\x09\x20\x20from\x20\x22Users\x22\x20u1\x0a\x20\x20\x20\x20\x20\x20\x20\x20left\x20join\x20traking\x20t\x20on\x20t.\x22userId\x22\x20=\x20u1.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20left\x20join\x20\x22UserRatings\x22\x20ur\x20on\x20ur.\x22userId\x22\x20=\x20t.\x22userId\x22\x20and\x20ur.\x22createdAt\x22::date\x20=\x20t.\x22finishedAt\x22::date\x0a\x20\x20\x20\x20\x20\x20\x20\x20group\x20by\x201,\x202\x0a\x20\x20\x20\x20\x20\x20)\x20att\x20on\x20att.id\x20=\x20u.id\x0a\x20\x20\x20\x20\x20\x20where\x20u.\x22companyId\x22\x20=\x20?\x0a\x20\x20\x20\x20\x20\x20order\x20by\x20att.name\x0a\x20\x20\x20\x20)\x0a\x20\x20\x20\x20select\x0a\x20\x20\x20\x20\x20\x20(select\x20coalesce(jsonb_build_object(\x27counters\x27,\x20c.*)->>\x27counters\x27,\x20\x27{}\x27)::jsonb\x20from\x20counters\x20c)\x20counters,\x0a\x20\x20\x20\x20\x20\x20(select\x20coalesce(json_agg(a.*),\x20\x27[]\x27)::jsonb\x20from\x20attedants\x20a)\x20attendants;\x0a\x20\x20','3429880ajzGlZ','__createBinding','AND\x20NOT\x20\x22isGroup\x22','\x2000:00:00','979875qjUDbu','174RRxEXQ','writable','query','__esModule','sequelize','apply','66CaLywd','has'];a511_0x1d0d=function(){return _0x35c030;};return a511_0x1d0d();}var __createBinding=this&&this[a511_0x25baf5(0x110)]||(Object[a511_0x25baf5(0x103)]?function(_0x3edbc4,_0x356309,_0x5c13e7,_0xbad20d){const _0x4d780c=a511_0x25baf5;if(_0xbad20d===undefined)_0xbad20d=_0x5c13e7;var _0x397ad3=Object['getOwnPropertyDescriptor'](_0x356309,_0x5c13e7);(!_0x397ad3||(_0x4d780c(0x123)in _0x397ad3?!_0x356309[_0x4d780c(0x117)]:_0x397ad3[_0x4d780c(0x115)]||_0x397ad3[_0x4d780c(0x121)]))&&(_0x397ad3={'enumerable':!![],'get':function(){return _0x356309[_0x5c13e7];}}),Object['defineProperty'](_0x3edbc4,_0xbad20d,_0x397ad3);}:function(_0x35542b,_0x2f4ce2,_0x1b35b3,_0x1862ff){if(_0x1862ff===undefined)_0x1862ff=_0x1b35b3;_0x35542b[_0x1862ff]=_0x2f4ce2[_0x1b35b3];}),__setModuleDefault=this&&this[a511_0x25baf5(0xf9)]||(Object['create']?function(_0x331807,_0x56380c){Object['defineProperty'](_0x331807,'default',{'enumerable':!![],'value':_0x56380c});}:function(_0xf9abe8,_0x2efa5b){const _0x2f3e56=a511_0x25baf5;_0xf9abe8[_0x2f3e56(0x125)]=_0x2efa5b;}),__importStar=this&&this['__importStar']||(function(){const _0xb1ab7e=(function(){let _0x160d92=!![];return function(_0x37c52c,_0x3caf82){const _0x1a96f6=_0x160d92?function(){const _0x2df9dd=a511_0x37c4;if(_0x3caf82){const _0x31c2bb=_0x3caf82[_0x2df9dd(0x119)](_0x37c52c,arguments);return _0x3caf82=null,_0x31c2bb;}}:function(){};return _0x160d92=![],_0x1a96f6;};}()),_0xbadd29=_0xb1ab7e(this,function(){const _0x3424f8=a511_0x37c4;return _0xbadd29[_0x3424f8(0x100)]()[_0x3424f8(0xf4)]('(((.+)+)+)+$')[_0x3424f8(0x100)]()['constructor'](_0xbadd29)[_0x3424f8(0xf4)](_0x3424f8(0xf6));});_0xbadd29();var _0x3c798a=function(_0x4afb76){return _0x3c798a=Object['getOwnPropertyNames']||function(_0x1804b0){const _0x19173c=a511_0x37c4;var _0x264212=[];for(var _0x204141 in _0x1804b0)if(Object[_0x19173c(0x10c)]['hasOwnProperty'][_0x19173c(0xfa)](_0x1804b0,_0x204141))_0x264212[_0x264212[_0x19173c(0x106)]]=_0x204141;return _0x264212;},_0x3c798a(_0x4afb76);};return function(_0x4bc612){const _0x2e0ce9=a511_0x37c4;if(_0x4bc612&&_0x4bc612[_0x2e0ce9(0x117)])return _0x4bc612;var _0x1c3ec0={};if(_0x4bc612!=null){for(var _0xbb4091=_0x3c798a(_0x4bc612),_0x2f5d43=0x0;_0x2f5d43<_0xbb4091[_0x2e0ce9(0x106)];_0x2f5d43++)if(_0xbb4091[_0x2f5d43]!=='default')__createBinding(_0x1c3ec0,_0x4bc612,_0xbb4091[_0x2f5d43]);}return __setModuleDefault(_0x1c3ec0,_0x4bc612),_0x1c3ec0;};}()),__importDefault=this&&this[a511_0x25baf5(0x10a)]||function(_0x200b12){const _0x3a88f1=a511_0x25baf5;return _0x200b12&&_0x200b12[_0x3a88f1(0x117)]?_0x200b12:{'default':_0x200b12};};Object[a511_0x25baf5(0x101)](exports,'__esModule',{'value':!![]}),exports[a511_0x25baf5(0x125)]=DashboardDataService;function a511_0x37c4(_0xdc1fb6,_0x2fcb6a){const _0x10811d=a511_0x1d0d();return a511_0x37c4=function(_0x2867e2,_0x22bf6d){_0x2867e2=_0x2867e2-0xf4;let _0x1d0db8=_0x10811d[_0x2867e2];return _0x1d0db8;},a511_0x37c4(_0xdc1fb6,_0x2fcb6a);}const sequelize_1=require(a511_0x25baf5(0x118)),_=__importStar(require('lodash')),database_1=__importDefault(require('../../database')),CheckSettings_1=require(a511_0x25baf5(0xff));async function DashboardDataService(_0x513d7a,_0x48a671){const _0x365575=a511_0x25baf5,_0x4e963e=await(0x0,CheckSettings_1[_0x365575(0xfc)])(Number(_0x513d7a),_0x365575(0xfb),_0x365575(0x109))===_0x365575(0x120),_0x318a58=await(0x0,CheckSettings_1[_0x365575(0xfc)])(Number(_0x513d7a),_0x365575(0xfd),_0x365575(0x120))===_0x365575(0x120),_0x2a4666=_0x318a58||_0x4e963e?_0x365575(0x111):'',_0x4a0679=_0x365575(0x10b)+_0x2a4666+_0x365575(0x10e);let _0x3da45a=_0x365575(0x107);const _0x1d68fb=[_0x513d7a];_[_0x365575(0x11b)](_0x48a671,_0x365575(0x105))&&(_0x3da45a+=_0x365575(0xf8),_0x1d68fb[_0x365575(0x11c)](parseInt((''+_0x48a671['days'])['replace'](/\D/g,''),0xa)));_[_0x365575(0x11b)](_0x48a671,'date_from')&&(_0x3da45a+=_0x365575(0x11e),_0x1d68fb[_0x365575(0x11c)](_0x48a671['date_from']+_0x365575(0x112)));_['has'](_0x48a671,_0x365575(0x11d))&&(_0x3da45a+='\x20and\x20tt.\x22createdAt\x22\x20<=\x20?',_0x1d68fb[_0x365575(0x11c)](_0x48a671['date_to']+'\x2023:59:59'));_0x1d68fb[_0x365575(0x11c)](_0x513d7a),_0x1d68fb[_0x365575(0x11c)](_0x513d7a),_0x1d68fb['push'](_0x513d7a),_0x1d68fb['push'](_0x513d7a),_0x1d68fb[_0x365575(0x11c)](_0x513d7a);const _0x24bd92=_0x4a0679[_0x365575(0x124)](_0x365575(0xf5),_0x3da45a),_0x2d6cca=await database_1[_0x365575(0x125)][_0x365575(0x116)](_0x24bd92,{'replacements':_0x1d68fb,'type':sequelize_1[_0x365575(0xfe)][_0x365575(0x108)],'plain':!![]});return _0x2d6cca;}