'use strict';function a520_0xe19c(){const _0xe8d43e=['length','enabled','__esModule','3040728SajYRK','date_to','2277DMNmcT','\x2023:59:59','6029500hEgNab','GetCompanySetting','SELECT','getOwnPropertyDescriptor','../../database','create','AND\x20NOT\x20\x22isGroup\x22','toString','getOwnPropertyNames','default','--\x20filterPeriod','2499386IHjsJV','search','groupsTab','__setModuleDefault','lodash','__importDefault','1396KEDSan','has','disabled','\x20and\x20tt.\x22createdAt\x22\x20<=\x20?','constructor','__createBinding','939127nukKHl','push','QueryTypes','configurable','apply','prototype','query','hasOwnProperty','(((.+)+)+)+$','\x2000:00:00','defineProperty','sequelize','replace','days','14027013GeDqAV','8wkBPpC','48332SpxOdK'];a520_0xe19c=function(){return _0xe8d43e;};return a520_0xe19c();}function a520_0x3ec2(_0x4bca63,_0x1c26f1){const _0xc17fed=a520_0xe19c();return a520_0x3ec2=function(_0x2a63aa,_0x53a41a){_0x2a63aa=_0x2a63aa-0x174;let _0xe19c5b=_0xc17fed[_0x2a63aa];return _0xe19c5b;},a520_0x3ec2(_0x4bca63,_0x1c26f1);}const a520_0x262541=a520_0x3ec2;(function(_0x2b4795,_0x4b189b){const _0x3836bd=a520_0x3ec2,_0x461bc2=_0x2b4795();while(!![]){try{const _0x30d558=parseInt(_0x3836bd(0x1a2))/0x1+-parseInt(_0x3836bd(0x186))/0x2+-parseInt(_0x3836bd(0x179))/0x3*(parseInt(_0x3836bd(0x18c))/0x4)+parseInt(_0x3836bd(0x17b))/0x5+-parseInt(_0x3836bd(0x177))/0x6+parseInt(_0x3836bd(0x192))/0x7*(-parseInt(_0x3836bd(0x1a1))/0x8)+parseInt(_0x3836bd(0x1a0))/0x9;if(_0x30d558===_0x4b189b)break;else _0x461bc2['push'](_0x461bc2['shift']());}catch(_0x1c3fa8){_0x461bc2['push'](_0x461bc2['shift']());}}}(a520_0xe19c,0xa0768));var __createBinding=this&&this[a520_0x262541(0x191)]||(Object[a520_0x262541(0x180)]?function(_0x5443b7,_0x2c8ad7,_0x179360,_0x3f6594){const _0x354368=a520_0x262541;if(_0x3f6594===undefined)_0x3f6594=_0x179360;var _0x44e9e9=Object[_0x354368(0x17e)](_0x2c8ad7,_0x179360);(!_0x44e9e9||('get'in _0x44e9e9?!_0x2c8ad7[_0x354368(0x176)]:_0x44e9e9['writable']||_0x44e9e9[_0x354368(0x195)]))&&(_0x44e9e9={'enumerable':!![],'get':function(){return _0x2c8ad7[_0x179360];}}),Object[_0x354368(0x19c)](_0x5443b7,_0x3f6594,_0x44e9e9);}:function(_0x154ad9,_0x37d851,_0x3c8371,_0x5d8189){if(_0x5d8189===undefined)_0x5d8189=_0x3c8371;_0x154ad9[_0x5d8189]=_0x37d851[_0x3c8371];}),__setModuleDefault=this&&this[a520_0x262541(0x189)]||(Object[a520_0x262541(0x180)]?function(_0x5218f5,_0x1a3bbb){const _0x24a878=a520_0x262541;Object[_0x24a878(0x19c)](_0x5218f5,_0x24a878(0x184),{'enumerable':!![],'value':_0x1a3bbb});}:function(_0x39e96f,_0x10f0ed){_0x39e96f['default']=_0x10f0ed;}),__importStar=this&&this['__importStar']||(function(){const _0x137ec4=(function(){let _0x25db02=!![];return function(_0x3168d4,_0x1af0d5){const _0x50b97f=_0x25db02?function(){const _0x18ffe1=a520_0x3ec2;if(_0x1af0d5){const _0xd251c1=_0x1af0d5[_0x18ffe1(0x196)](_0x3168d4,arguments);return _0x1af0d5=null,_0xd251c1;}}:function(){};return _0x25db02=![],_0x50b97f;};}()),_0x4febf8=_0x137ec4(this,function(){const _0x5ba427=a520_0x3ec2;return _0x4febf8[_0x5ba427(0x182)]()[_0x5ba427(0x187)](_0x5ba427(0x19a))[_0x5ba427(0x182)]()[_0x5ba427(0x190)](_0x4febf8)[_0x5ba427(0x187)]('(((.+)+)+)+$');});_0x4febf8();var _0x4d5179=function(_0x3d85ab){const _0x39f76d=a520_0x3ec2;return _0x4d5179=Object[_0x39f76d(0x183)]||function(_0x245ca2){const _0x15103c=_0x39f76d;var _0x30c668=[];for(var _0x2ca5fe in _0x245ca2)if(Object[_0x15103c(0x197)][_0x15103c(0x199)]['call'](_0x245ca2,_0x2ca5fe))_0x30c668[_0x30c668[_0x15103c(0x174)]]=_0x2ca5fe;return _0x30c668;},_0x4d5179(_0x3d85ab);};return function(_0x4983ff){const _0x3debfa=a520_0x3ec2;if(_0x4983ff&&_0x4983ff[_0x3debfa(0x176)])return _0x4983ff;var _0x4304d7={};if(_0x4983ff!=null){for(var _0xe86bdc=_0x4d5179(_0x4983ff),_0x18f63e=0x0;_0x18f63e<_0xe86bdc[_0x3debfa(0x174)];_0x18f63e++)if(_0xe86bdc[_0x18f63e]!==_0x3debfa(0x184))__createBinding(_0x4304d7,_0x4983ff,_0xe86bdc[_0x18f63e]);}return __setModuleDefault(_0x4304d7,_0x4983ff),_0x4304d7;};}()),__importDefault=this&&this[a520_0x262541(0x18b)]||function(_0x2a7a20){const _0x4a80d6=a520_0x262541;return _0x2a7a20&&_0x2a7a20[_0x4a80d6(0x176)]?_0x2a7a20:{'default':_0x2a7a20};};Object[a520_0x262541(0x19c)](exports,a520_0x262541(0x176),{'value':!![]}),exports[a520_0x262541(0x184)]=DashboardDataService;const sequelize_1=require(a520_0x262541(0x19d)),_=__importStar(require(a520_0x262541(0x18a))),database_1=__importDefault(require(a520_0x262541(0x17f))),CheckSettings_1=require('../../helpers/CheckSettings');async function DashboardDataService(_0x3661f5,_0x1fe266){const _0x46c384=a520_0x262541,_0x1030eb=await(0x0,CheckSettings_1[_0x46c384(0x17c)])(Number(_0x3661f5),_0x46c384(0x188),_0x46c384(0x18e))===_0x46c384(0x175),_0x4f81bd=await(0x0,CheckSettings_1[_0x46c384(0x17c)])(Number(_0x3661f5),'CheckMsgIsGroup',_0x46c384(0x175))===_0x46c384(0x175),_0x16e40b=_0x4f81bd||_0x1030eb?_0x46c384(0x181):'',_0x56e159='\x0a\x20\x20\x20\x20with\x0a\x20\x20\x20\x20traking\x20as\x20(\x0a\x20\x20\x20\x20\x20\x20select\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.name\x20\x22companyName\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.name\x20\x22userName\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(select\x20count(*)\x20>\x200\x20as\x20online\x20from\x20\x22UserSocketSessions\x22\x20tu\x20where\x20tu.\x22userId\x22\x20=\x20tt.\x22userId\x22\x20and\x20tu.\x22active\x22\x20is\x20True)\x20\x22userOnline\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20w.name\x20\x22whatsappName\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20ct.name\x20\x22contactName\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20ct.number\x20\x22contactNumber\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(tt.\x22finishedAt\x22\x20is\x20not\x20null)\x20\x22finished\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(tt.\x22userId\x22\x20is\x20null\x20and\x20tt.\x22finishedAt\x22\x20is\x20null)\x20\x22pending\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(tt.\x22startedAt\x22\x20is\x20not\x20null\x20and\x20tt.\x22finishedAt\x22\x20is\x20null)\x20\x22open\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20coalesce((\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(date_part(\x27day\x27,\x20age(coalesce(tt.\x22ratingAt\x22,\x20tt.\x22finishedAt\x22)\x20,\x20tt.\x22startedAt\x22))\x20*\x2024\x20*\x2060)\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(date_part(\x27hour\x27,\x20age(coalesce(tt.\x22ratingAt\x22,\x20tt.\x22finishedAt\x22),\x20tt.\x22startedAt\x22))\x20*\x2060)\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(date_part(\x27minutes\x27,\x20age(coalesce(tt.\x22ratingAt\x22,\x20tt.\x22finishedAt\x22),\x20tt.\x22startedAt\x22)))\x0a\x20\x20\x20\x20\x20\x20\x20\x20),\x200)\x20\x22supportTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20coalesce((\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(date_part(\x27day\x27,\x20age(tt.\x22startedAt\x22,\x20tt.\x22queuedAt\x22))\x20*\x2024\x20*\x2060)\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(date_part(\x27hour\x27,\x20age(tt.\x22startedAt\x22,\x20tt.\x22queuedAt\x22))\x20*\x2060)\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(date_part(\x27minutes\x27,\x20age(tt.\x22startedAt\x22,\x20tt.\x22queuedAt\x22)))\x0a\x20\x20\x20\x20\x20\x20\x20\x20),\x200)\x20\x22waitTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20t.status,\x0a\x20\x20\x20\x20\x20\x20\x20\x20tt.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20ct.\x22id\x22\x20\x22contactId\x22\x0a\x20\x20\x20\x20\x20\x20from\x20\x22TicketTraking\x22\x20tt\x0a\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Companies\x22\x20c\x20on\x20c.id\x20=\x20tt.\x22companyId\x22\x0a\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Users\x22\x20u\x20on\x20u.id\x20=\x20tt.\x22userId\x22\x0a\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Whatsapps\x22\x20w\x20on\x20w.id\x20=\x20tt.\x22whatsappId\x22\x0a\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Tickets\x22\x20t\x20on\x20t.id\x20=\x20tt.\x22ticketId\x22\x0a\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Contacts\x22\x20ct\x20on\x20ct.id\x20=\x20t.\x22contactId\x22\x0a\x20\x20\x20\x20\x20\x20--\x20filterPeriod\x0a\x20\x20\x20\x20),\x0a\x20\x20\x20\x20counters\x20as\x20(\x0a\x20\x20\x20\x20\x20\x20select\x0a\x20\x20\x20\x20\x20\x20\x20\x20(select\x20avg(\x22supportTime\x22)\x20from\x20traking\x20where\x20\x22supportTime\x22\x20>\x200)\x20\x22avgSupportTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(select\x20avg(\x22waitTime\x22)\x20from\x20traking\x20where\x20\x22waitTime\x22\x20>\x200)\x20\x22avgWaitTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20select\x20count(distinct\x20\x22id\x22)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20from\x20\x22Tickets\x22\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20where\x20status\x20like\x20\x27open\x27\x20and\x20\x22companyId\x22\x20=\x20?\x0a\x20\x20\x20\x20\x20\x20\x20\x20)\x20\x22supportHappening\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20select\x20count(distinct\x20\x22id\x22)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20from\x20\x22Tickets\x22\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20where\x20status\x20like\x20\x27pending\x27\x20and\x20\x22companyId\x22\x20=\x20?\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+_0x16e40b+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20)\x20\x22supportPending\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(select\x20count(id)\x20from\x20traking\x20where\x20finished)\x20\x22supportFinished\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20select\x20count(leads.id)\x20from\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20select\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ct1.id,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count(tt1.id)\x20total\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20from\x20traking\x20tt1\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Tickets\x22\x20t1\x20on\x20t1.id\x20=\x20tt1.\x22ticketId\x22\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20left\x20join\x20\x22Contacts\x22\x20ct1\x20on\x20ct1.id\x20=\x20t1.\x22contactId\x22\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20group\x20by\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20having\x20count(tt1.id)\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20)\x20leads\x0a\x20\x20\x20\x20\x20\x20\x20\x20)\x20\x22leads\x22\x0a\x20\x20\x20\x20),\x0a\x20\x20\x20\x20attedants\x20as\x20(\x0a\x20\x20\x20\x20\x20\x20select\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.id,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.name,\x0a\x20\x20\x20\x20\x20\x20\x20\x20coalesce(att.\x22avgSupportTime\x22,\x200)\x20\x22avgSupportTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20coalesce(att.\x22avgWaitTime\x22,\x200)\x20\x22avgWaitTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20att.tickets,\x0a\x20\x20\x20\x20\x20\x20\x20\x20att.rating,\x0a\x20\x20\x20\x20\x20\x20\x20\x20(select\x20count(*)\x20>\x200\x20as\x20online\x20from\x20\x22UserSocketSessions\x22\x20us\x20where\x20us.\x22userId\x22\x20=\x20u.id\x20and\x20us.\x22active\x22\x20is\x20True)\x20online,\x0a\x20\x20\x20\x20\x20\x20\x20\x20att.\x22closeCount\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20att.\x22openCount\x22\x0a\x09from\x20\x22Users\x22\x20u\x0a\x20\x20\x20\x20\x20\x20left\x20join\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20select\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u1.id,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u1.\x22name\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(select\x20count(*)\x20>\x200\x20as\x20online\x20from\x20\x22UserSocketSessions\x22\x20us1\x20where\x20us1.\x22userId\x22\x20=\x20u1.id\x20and\x20us1.\x22active\x22\x20is\x20True)\x20\x22online\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20avg(t.\x22supportTime\x22)\x20\x22avgSupportTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20avg(t.\x22waitTime\x22)\x20\x22avgWaitTime\x22,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count(t.\x22id\x22)\x20tickets,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20coalesce(avg(ur.rate),\x200)\x20rating,\x0a\x09\x09(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20select\x20count(distinct\x20\x22id\x22)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20from\x20traking\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20where\x20\x22finishedAt\x22\x20is\x20not\x20null\x20and\x20\x22companyId\x22\x20=\x20?\x20and\x20\x22userId\x22\x20=\x20u1.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20)\x20\x20AS\x20\x22closeCount\x22\x20\x20\x20,\x20\x09\x09(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20select\x20count(distinct\x20\x22id\x22)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20from\x20traking\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20where\x20\x22startedAt\x22\x20is\x20not\x20null\x20and\x20\x22finishedAt\x22\x20is\x20null\x20and\x20\x22companyId\x22\x20=\x20?\x20and\x20\x22userId\x22\x20=\x20u1.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20)\x20\x20AS\x20\x22openCount\x22\x0a\x09\x09\x20\x20from\x20\x22Users\x22\x20u1\x0a\x20\x20\x20\x20\x20\x20\x20\x20left\x20join\x20traking\x20t\x20on\x20t.\x22userId\x22\x20=\x20u1.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20left\x20join\x20\x22UserRatings\x22\x20ur\x20on\x20ur.\x22userId\x22\x20=\x20t.\x22userId\x22\x20and\x20ur.\x22createdAt\x22::date\x20=\x20t.\x22finishedAt\x22::date\x0a\x20\x20\x20\x20\x20\x20\x20\x20group\x20by\x201,\x202\x0a\x20\x20\x20\x20\x20\x20)\x20att\x20on\x20att.id\x20=\x20u.id\x0a\x20\x20\x20\x20\x20\x20where\x20u.\x22companyId\x22\x20=\x20?\x0a\x20\x20\x20\x20\x20\x20order\x20by\x20att.name\x0a\x20\x20\x20\x20)\x0a\x20\x20\x20\x20select\x0a\x20\x20\x20\x20\x20\x20(select\x20coalesce(jsonb_build_object(\x27counters\x27,\x20c.*)->>\x27counters\x27,\x20\x27{}\x27)::jsonb\x20from\x20counters\x20c)\x20counters,\x0a\x20\x20\x20\x20\x20\x20(select\x20coalesce(json_agg(a.*),\x20\x27[]\x27)::jsonb\x20from\x20attedants\x20a)\x20attendants;\x0a\x20\x20';let _0x415eef='where\x20tt.\x22companyId\x22\x20=\x20?';const _0x30a85c=[_0x3661f5];_[_0x46c384(0x18d)](_0x1fe266,_0x46c384(0x19f))&&(_0x415eef+='\x20and\x20tt.\x22createdAt\x22\x20>=\x20(now()\x20-\x20\x27?\x20days\x27::interval)',_0x30a85c[_0x46c384(0x193)](parseInt((''+_0x1fe266[_0x46c384(0x19f)])[_0x46c384(0x19e)](/\D/g,''),0xa)));_['has'](_0x1fe266,'date_from')&&(_0x415eef+='\x20and\x20tt.\x22createdAt\x22\x20>=\x20?',_0x30a85c[_0x46c384(0x193)](_0x1fe266['date_from']+_0x46c384(0x19b)));_[_0x46c384(0x18d)](_0x1fe266,_0x46c384(0x178))&&(_0x415eef+=_0x46c384(0x18f),_0x30a85c['push'](_0x1fe266[_0x46c384(0x178)]+_0x46c384(0x17a)));_0x30a85c[_0x46c384(0x193)](_0x3661f5),_0x30a85c['push'](_0x3661f5),_0x30a85c[_0x46c384(0x193)](_0x3661f5),_0x30a85c['push'](_0x3661f5),_0x30a85c[_0x46c384(0x193)](_0x3661f5);const _0x14b9c2=_0x56e159['replace'](_0x46c384(0x185),_0x415eef),_0x1cc4f5=await database_1[_0x46c384(0x184)][_0x46c384(0x198)](_0x14b9c2,{'replacements':_0x30a85c,'type':sequelize_1[_0x46c384(0x194)][_0x46c384(0x17d)],'plain':!![]});return _0x1cc4f5;}