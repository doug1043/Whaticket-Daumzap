'use strict';const a579_0x4bff77=a579_0x2830;function a579_0x4cb4(){const _0x6b7768=['open','terminate','3723000sVWKue','186EnduXh','hasOwnProperty','../../utils/logger','(((.+)+)+)+$','create','contacts.upsert','../../models/Ticket','getOwnPropertyNames','sendMessage','call-id','2521512lKatkF','toString','debug','__importStar','configurable','getMinutes','default','*Mensagem\x20Automática:*\x0a\x0aAs\x20chamadas\x20de\x20voz\x20e\x20vídeo\x20estão\x20desabilitas\x20para\x20esse\x20WhatsApp,\x20favor\x20enviar\x20uma\x20mensagem\x20de\x20texto.\x20Obrigado','__createBinding','runExclusive','call','get','7506170JTPUuu','async-mutex','length','5556Tplxof','pending','value','../../models/Setting','update','search','../MessageServices/CreateMessageService','2HQONVL','__esModule','33690Kvsznt','attrs','Mutex','from','content','376452eCCBkw','Chamada\x20de\x20voz/vídeo\x20perdida\x20às\x20','captureException','1324773ouPBta','429SpkWxV','findOne','logger','constructor','defineProperty','__setModuleDefault','tag','@sentry/node'];a579_0x4cb4=function(){return _0x6b7768;};return a579_0x4cb4();}function a579_0x2830(_0x558b6a,_0x1dce37){const _0x351e55=a579_0x4cb4();return a579_0x2830=function(_0x534718,_0x1964b6){_0x534718=_0x534718-0x1c8;let _0x4cb4aa=_0x351e55[_0x534718];return _0x4cb4aa;},a579_0x2830(_0x558b6a,_0x1dce37);}(function(_0x5b3b97,_0x482586){const _0x4cac7a=a579_0x2830,_0x1915b8=_0x5b3b97();while(!![]){try{const _0x51cb20=parseInt(_0x4cac7a(0x1e2))/0x1*(-parseInt(_0x4cac7a(0x1db))/0x2)+-parseInt(_0x4cac7a(0x1e6))/0x3*(-parseInt(_0x4cac7a(0x1d4))/0x4)+-parseInt(_0x4cac7a(0x1dd))/0x5*(-parseInt(_0x4cac7a(0x1f1))/0x6)+parseInt(_0x4cac7a(0x1fb))/0x7+parseInt(_0x4cac7a(0x1f0))/0x8+parseInt(_0x4cac7a(0x1e5))/0x9+-parseInt(_0x4cac7a(0x1d1))/0xa;if(_0x51cb20===_0x482586)break;else _0x1915b8['push'](_0x1915b8['shift']());}catch(_0x13ece4){_0x1915b8['push'](_0x1915b8['shift']());}}}(a579_0x4cb4,0x3dd28));var __createBinding=this&&this[a579_0x4bff77(0x1cd)]||(Object[a579_0x4bff77(0x1f5)]?function(_0x125e6f,_0x29f542,_0xf59000,_0x5758ee){const _0x3afea7=a579_0x4bff77;if(_0x5758ee===undefined)_0x5758ee=_0xf59000;var _0x468ed4=Object['getOwnPropertyDescriptor'](_0x29f542,_0xf59000);(!_0x468ed4||(_0x3afea7(0x1d0)in _0x468ed4?!_0x29f542[_0x3afea7(0x1dc)]:_0x468ed4['writable']||_0x468ed4[_0x3afea7(0x1c9)]))&&(_0x468ed4={'enumerable':!![],'get':function(){return _0x29f542[_0xf59000];}}),Object[_0x3afea7(0x1ea)](_0x125e6f,_0x5758ee,_0x468ed4);}:function(_0x4d68f2,_0x277f04,_0x1ed9a6,_0x57dfe2){if(_0x57dfe2===undefined)_0x57dfe2=_0x1ed9a6;_0x4d68f2[_0x57dfe2]=_0x277f04[_0x1ed9a6];}),__setModuleDefault=this&&this[a579_0x4bff77(0x1eb)]||(Object[a579_0x4bff77(0x1f5)]?function(_0x18502e,_0x31aff8){const _0x49d9a1=a579_0x4bff77;Object[_0x49d9a1(0x1ea)](_0x18502e,'default',{'enumerable':!![],'value':_0x31aff8});}:function(_0x18a690,_0x409e44){const _0x3c11ab=a579_0x4bff77;_0x18a690[_0x3c11ab(0x1cb)]=_0x409e44;}),__importStar=this&&this[a579_0x4bff77(0x1c8)]||(function(){const _0x4073d0=(function(){let _0x2d5d92=!![];return function(_0x39cc0e,_0x37b83f){const _0x4187fc=_0x2d5d92?function(){if(_0x37b83f){const _0x412707=_0x37b83f['apply'](_0x39cc0e,arguments);return _0x37b83f=null,_0x412707;}}:function(){};return _0x2d5d92=![],_0x4187fc;};}()),_0x540a9f=_0x4073d0(this,function(){const _0x40a2d9=a579_0x2830;return _0x540a9f['toString']()[_0x40a2d9(0x1d9)](_0x40a2d9(0x1f4))[_0x40a2d9(0x1fc)]()[_0x40a2d9(0x1e9)](_0x540a9f)[_0x40a2d9(0x1d9)](_0x40a2d9(0x1f4));});_0x540a9f();var _0x5e2053=function(_0x21b301){const _0x1c82c6=a579_0x2830;return _0x5e2053=Object[_0x1c82c6(0x1f8)]||function(_0x34d729){const _0x58511e=_0x1c82c6;var _0x5b25a5=[];for(var _0x3fa0ef in _0x34d729)if(Object['prototype'][_0x58511e(0x1f2)][_0x58511e(0x1cf)](_0x34d729,_0x3fa0ef))_0x5b25a5[_0x5b25a5[_0x58511e(0x1d3)]]=_0x3fa0ef;return _0x5b25a5;},_0x5e2053(_0x21b301);};return function(_0x3298c5){const _0x569383=a579_0x2830;if(_0x3298c5&&_0x3298c5[_0x569383(0x1dc)])return _0x3298c5;var _0x563dea={};if(_0x3298c5!=null){for(var _0x2dda92=_0x5e2053(_0x3298c5),_0x384e6e=0x0;_0x384e6e<_0x2dda92[_0x569383(0x1d3)];_0x384e6e++)if(_0x2dda92[_0x384e6e]!=='default')__createBinding(_0x563dea,_0x3298c5,_0x2dda92[_0x384e6e]);}return __setModuleDefault(_0x563dea,_0x3298c5),_0x563dea;};}()),__importDefault=this&&this['__importDefault']||function(_0x2a2b75){const _0x17ec4f=a579_0x4bff77;return _0x2a2b75&&_0x2a2b75[_0x17ec4f(0x1dc)]?_0x2a2b75:{'default':_0x2a2b75};};Object[a579_0x4bff77(0x1ea)](exports,'__esModule',{'value':!![]});const Sentry=__importStar(require(a579_0x4bff77(0x1ed))),async_mutex_1=require(a579_0x4bff77(0x1d2)),Contact_1=__importDefault(require('../../models/Contact')),Setting_1=__importDefault(require(a579_0x4bff77(0x1d7))),Ticket_1=__importDefault(require(a579_0x4bff77(0x1f7))),logger_1=require(a579_0x4bff77(0x1f3)),CreateOrUpdateBaileysService_1=__importDefault(require('../BaileysServices/CreateOrUpdateBaileysService')),CreateMessageService_1=__importDefault(require(a579_0x4bff77(0x1da))),contactMutex=new async_mutex_1[(a579_0x4bff77(0x1df))](),wbotMonitor=async(_0x3b82ce,_0x18b16f,_0x205b29)=>{const _0x58d33d=a579_0x4bff77;try{_0x3b82ce['ws']['on']('CB:call',async _0x26cac8=>{const _0x11285c=a579_0x2830,_0x21260f=_0x26cac8[_0x11285c(0x1e1)][0x0];if(_0x21260f[_0x11285c(0x1ec)]===_0x11285c(0x1ef)){const _0x2f4ced=await Setting_1[_0x11285c(0x1cb)][_0x11285c(0x1e7)]({'where':{'key':_0x11285c(0x1cf),'companyId':_0x205b29}});if(_0x2f4ced[_0x11285c(0x1d6)]==='disabled'){await _0x3b82ce[_0x11285c(0x1f9)](_0x26cac8['attrs']['from'],{'text':_0x11285c(0x1cc)});const _0x5259c5=_0x26cac8[_0x11285c(0x1de)][_0x11285c(0x1e0)]['replace'](/\D/g,''),_0x375771=await Contact_1[_0x11285c(0x1cb)][_0x11285c(0x1e7)]({'where':{'companyId':_0x205b29,'number':_0x5259c5}}),_0x150a5a=await Ticket_1[_0x11285c(0x1cb)][_0x11285c(0x1e7)]({'where':{'contactId':_0x375771['id'],'whatsappId':_0x3b82ce['id'],'status':_0x11285c(0x1ee),'companyId':_0x205b29}});if(!_0x150a5a)return;const _0x826855=new Date(),_0x480570=_0x826855['getHours'](),_0x14d3a2=_0x826855[_0x11285c(0x1ca)](),_0x1d7f87=_0x11285c(0x1e3)+_0x480570+':'+_0x14d3a2,_0x1b1f0e={'id':_0x21260f[_0x11285c(0x1de)][_0x11285c(0x1fa)],'ticketId':_0x150a5a['id'],'contactId':_0x375771['id'],'body':_0x1d7f87,'fromMe':![],'mediaType':'call_log','read':!![],'quotedMsgId':null,'ack':0x1};await _0x150a5a[_0x11285c(0x1d8)]({'lastMessage':_0x1d7f87}),_0x150a5a['status']==='closed'&&await _0x150a5a[_0x11285c(0x1d8)]({'status':_0x11285c(0x1d5)}),(0x0,CreateMessageService_1[_0x11285c(0x1cb)])({'messageData':_0x1b1f0e,'companyId':_0x205b29});}}}),_0x3b82ce['ev']['on']('contacts.upsert',async _0x4177f0=>{const _0x5243a0=a579_0x2830;logger_1['logger'][_0x5243a0(0x1fd)]({'contacts':_0x4177f0},_0x5243a0(0x1f6)),contactMutex[_0x5243a0(0x1ce)](async()=>{const _0x1c59c6=_0x5243a0;await(0x0,CreateOrUpdateBaileysService_1[_0x1c59c6(0x1cb)])({'whatsappId':_0x18b16f['id'],'contacts':_0x4177f0});});});}catch(_0x1afa2b){Sentry[_0x58d33d(0x1e4)](_0x1afa2b),logger_1[_0x58d33d(0x1e8)]['error'](_0x1afa2b);}};exports['default']=wbotMonitor;