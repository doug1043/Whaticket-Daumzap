const a559_0x51a41c=a559_0x5c82;(function(_0x1f21e6,_0xeba0e1){const _0x5ac873=a559_0x5c82,_0x28a757=_0x1f21e6();while(!![]){try{const _0x535f5e=parseInt(_0x5ac873(0x12d))/0x1+-parseInt(_0x5ac873(0x147))/0x2+-parseInt(_0x5ac873(0x144))/0x3+parseInt(_0x5ac873(0x11d))/0x4*(-parseInt(_0x5ac873(0x14b))/0x5)+parseInt(_0x5ac873(0x153))/0x6*(parseInt(_0x5ac873(0x157))/0x7)+parseInt(_0x5ac873(0x11b))/0x8+parseInt(_0x5ac873(0x120))/0x9;if(_0x535f5e===_0xeba0e1)break;else _0x28a757['push'](_0x28a757['shift']());}catch(_0x24b84c){_0x28a757['push'](_0x28a757['shift']());}}}(a559_0xb0e0,0x895b4));const a559_0x4c67ce=(function(){let _0x404526=!![];return function(_0x3bb19b,_0x1a3306){const _0x38c83b=_0x404526?function(){const _0x45986e=a559_0x5c82;if(_0x1a3306){const _0x1a91de=_0x1a3306[_0x45986e(0x155)](_0x3bb19b,arguments);return _0x1a3306=null,_0x1a91de;}}:function(){};return _0x404526=![],_0x38c83b;};}()),a559_0xc0024c=a559_0x4c67ce(this,function(){const _0x1d6fb7=a559_0x5c82;return a559_0xc0024c['toString']()[_0x1d6fb7(0x125)](_0x1d6fb7(0x149))[_0x1d6fb7(0x14c)]()[_0x1d6fb7(0x131)](a559_0xc0024c)['search'](_0x1d6fb7(0x149));});a559_0xc0024c();'use strict';var __createBinding=this&&this[a559_0x51a41c(0x14f)]||(Object[a559_0x51a41c(0x12e)]?function(_0x4895c0,_0x46e196,_0x261e46,_0x5f0697){const _0x37b5ac=a559_0x51a41c;if(_0x5f0697===undefined)_0x5f0697=_0x261e46;var _0x3f2a09=Object['getOwnPropertyDescriptor'](_0x46e196,_0x261e46);(!_0x3f2a09||(_0x37b5ac(0x141)in _0x3f2a09?!_0x46e196[_0x37b5ac(0x132)]:_0x3f2a09['writable']||_0x3f2a09[_0x37b5ac(0x145)]))&&(_0x3f2a09={'enumerable':!![],'get':function(){return _0x46e196[_0x261e46];}}),Object[_0x37b5ac(0x128)](_0x4895c0,_0x5f0697,_0x3f2a09);}:function(_0x48ab98,_0x4127f5,_0x5a2e51,_0x479510){if(_0x479510===undefined)_0x479510=_0x5a2e51;_0x48ab98[_0x479510]=_0x4127f5[_0x5a2e51];}),__setModuleDefault=this&&this[a559_0x51a41c(0x158)]||(Object[a559_0x51a41c(0x12e)]?function(_0x1c2c7d,_0x1ed626){const _0x500685=a559_0x51a41c;Object[_0x500685(0x128)](_0x1c2c7d,_0x500685(0x148),{'enumerable':!![],'value':_0x1ed626});}:function(_0x5ed23c,_0x3d3390){const _0x5d1375=a559_0x51a41c;_0x5ed23c[_0x5d1375(0x148)]=_0x3d3390;}),__importStar=this&&this[a559_0x51a41c(0x129)]||function(_0x5ac1c6){const _0x24f6f3=a559_0x51a41c;if(_0x5ac1c6&&_0x5ac1c6[_0x24f6f3(0x132)])return _0x5ac1c6;var _0x40f177={};if(_0x5ac1c6!=null){for(var _0x54ecf2 in _0x5ac1c6)if(_0x54ecf2!=='default'&&Object[_0x24f6f3(0x13f)][_0x24f6f3(0x14a)][_0x24f6f3(0x142)](_0x5ac1c6,_0x54ecf2))__createBinding(_0x40f177,_0x5ac1c6,_0x54ecf2);}return __setModuleDefault(_0x40f177,_0x5ac1c6),_0x40f177;},__importDefault=this&&this['__importDefault']||function(_0x18f7f4){const _0x291a65=a559_0x51a41c;return _0x18f7f4&&_0x18f7f4[_0x291a65(0x132)]?_0x18f7f4:{'default':_0x18f7f4};};Object[a559_0x51a41c(0x128)](exports,a559_0x51a41c(0x132),{'value':!![]});const Sentry=__importStar(require('@sentry/node')),Contact_1=__importDefault(require(a559_0x51a41c(0x13d))),Setting_1=__importDefault(require('../../models/Setting')),Ticket_1=__importDefault(require('../../models/Ticket')),logger_1=require(a559_0x51a41c(0x11a)),CreateOrUpdateBaileysService_1=__importDefault(require(a559_0x51a41c(0x13b))),CreateMessageService_1=__importDefault(require('../MessageServices/CreateMessageService')),SendPresenceStatus_1=require(a559_0x51a41c(0x151));function a559_0x5c82(_0x265269,_0x336bb3){const _0x4db0f5=a559_0xb0e0();return a559_0x5c82=function(_0xc0024c,_0x4c67ce){_0xc0024c=_0xc0024c-0x119;let _0xb0e0bc=_0x4db0f5[_0xc0024c];return _0xb0e0bc;},a559_0x5c82(_0x265269,_0x336bb3);}let messageControl=[];function a559_0xb0e0(){const _0x21ff67=['logger','constructor','__esModule','findOne','filter','length','getTime','call_log','SendPresenceStatus','content','update','../BaileysServices/CreateOrUpdateBaileysService','terminate','../../models/Contact','open','prototype','attrs','get','call','disabled','1983672xZQlpb','configurable','getHours','784496UKYZeo','default','(((.+)+)+)+$','hasOwnProperty','59665doHijS','toString','offer','closed','__createBinding','time','../../helpers/SendPresenceStatus','replace','30rxAaGX','sendMessage','apply','getMinutes','201635kkrWlK','__setModuleDefault','pending','../../utils/logger','2443904FrFXPU','tag','68ySZavN','from','push','3028671HMpjEb','contacts.upsert','string','captureException','find','search','status','body\x20is\x20not\x20a\x20string','defineProperty','__importStar','value','trace','*Mensagem\x20Automática:*\x0a\x0aAs\x20chamadas\x20de\x20voz\x20e\x20vídeo\x20estão\x20desabilitas\x20para\x20esse\x20WhatsApp,\x20favor\x20enviar\x20uma\x20mensagem\x20de\x20texto.\x20Obrigado','1032913IWFdbo','create','Chamada\x20de\x20voz/vídeo\x20perdida\x20às\x20'];a559_0xb0e0=function(){return _0x21ff67;};return a559_0xb0e0();}const wbotMonitor=async(_0x4191f3,_0x585776,_0x13e742)=>{const _0x4afb1c=a559_0x51a41c;try{_0x4191f3['ws']['on']('CB:call',async _0x4c7897=>{const _0x1bab64=a559_0x5c82,_0x4d69da=_0x4c7897[_0x1bab64(0x139)][0x0];if(_0x4d69da[_0x1bab64(0x11c)]===_0x1bab64(0x14d)){const {from:_0x2cb4ca,id:_0x5843fd}=_0x4c7897['attrs'];}if(_0x4d69da[_0x1bab64(0x11c)]===_0x1bab64(0x13c)){const _0x38fa7b=await Setting_1[_0x1bab64(0x148)][_0x1bab64(0x133)]({'where':{'key':'call','companyId':_0x13e742}});if(!_0x38fa7b||_0x38fa7b[_0x1bab64(0x12a)]===_0x1bab64(0x143)){if(messageControl[_0x1bab64(0x135)]>0x1388)messageControl=[];var _0x344b8d=messageControl[_0x1bab64(0x124)](_0x36f09d=>_0x36f09d[_0x1bab64(0x11e)]===_0x4c7897[_0x1bab64(0x140)]['from']);(!_0x344b8d||new Date()['getTime']()-_0x344b8d[_0x1bab64(0x150)]>=0x3e8*0x3c*0x5)&&(await(0x0,SendPresenceStatus_1[_0x1bab64(0x138)])(_0x4191f3,_0x4c7897[_0x1bab64(0x140)][_0x1bab64(0x11e)]),await _0x4191f3[_0x1bab64(0x154)](_0x4c7897['attrs']['from'],{'text':_0x1bab64(0x12c)}),_0x344b8d&&(_0x344b8d=null,messageControl=messageControl[_0x1bab64(0x134)](_0x234a51=>_0x234a51[_0x1bab64(0x11e)]!==_0x4c7897['attrs']['from'])));!_0x344b8d&&messageControl[_0x1bab64(0x11f)]({'from':_0x4c7897[_0x1bab64(0x140)]['from'],'time':new Date()[_0x1bab64(0x136)]()});const _0x515af5=_0x4c7897[_0x1bab64(0x140)]['from'][_0x1bab64(0x152)](/\D/g,''),_0x35978d=await Contact_1[_0x1bab64(0x148)][_0x1bab64(0x133)]({'where':{'companyId':_0x13e742,'number':_0x515af5}}),_0x2d3cbe=await Ticket_1[_0x1bab64(0x148)][_0x1bab64(0x133)]({'where':{'contactId':_0x35978d['id'],'whatsappId':_0x4191f3['id'],'status':_0x1bab64(0x13e),'companyId':_0x13e742}});if(!_0x2d3cbe)return;const _0x38102f=new Date(),_0x3e7482=_0x38102f[_0x1bab64(0x146)](),_0x4313c8=_0x38102f[_0x1bab64(0x156)](),_0x134ce0=_0x1bab64(0x12f)+_0x3e7482+':'+_0x4313c8,_0x170922={'id':_0x4d69da['attrs']['call-id'],'ticketId':_0x2d3cbe['id'],'contactId':_0x35978d['id'],'body':_0x134ce0,'fromMe':![],'mediaType':_0x1bab64(0x137),'read':!![],'quotedMsgId':null,'ack':0x1};return typeof _0x134ce0!==_0x1bab64(0x122)&&console[_0x1bab64(0x12b)](_0x1bab64(0x127),_0x134ce0),await _0x2d3cbe[_0x1bab64(0x13a)]({'lastMessage':_0x134ce0}),_0x2d3cbe[_0x1bab64(0x126)]===_0x1bab64(0x14e)&&await _0x2d3cbe['update']({'status':_0x1bab64(0x119)}),(0x0,CreateMessageService_1[_0x1bab64(0x148)])({'messageData':_0x170922,'ticket':_0x2d3cbe,'companyId':_0x13e742});}}}),_0x4191f3['ev']['on'](_0x4afb1c(0x121),async _0x5e5b35=>{const _0xb8d79a=_0x4afb1c;await(0x0,CreateOrUpdateBaileysService_1[_0xb8d79a(0x148)])({'whatsappId':_0x585776['id'],'contacts':_0x5e5b35});});}catch(_0x583211){Sentry[_0x4afb1c(0x123)](_0x583211),logger_1[_0x4afb1c(0x130)]['error'](_0x583211);}};exports['default']=wbotMonitor;