'use strict';const a588_0x2171bd=a588_0x28b1;function a588_0x28b1(_0xaf7421,_0x849826){const _0x1b93c4=a588_0x2ce2();return a588_0x28b1=function(_0x532595,_0x318b6){_0x532595=_0x532595-0x79;let _0x2ce267=_0x1b93c4[_0x532595];return _0x2ce267;},a588_0x28b1(_0xaf7421,_0x849826);}(function(_0x108a46,_0x59956c){const _0x2cdb9e=a588_0x28b1,_0x49d09d=_0x108a46();while(!![]){try{const _0x278f06=-parseInt(_0x2cdb9e(0xa5))/0x1+-parseInt(_0x2cdb9e(0xb4))/0x2*(parseInt(_0x2cdb9e(0x8d))/0x3)+-parseInt(_0x2cdb9e(0x85))/0x4*(parseInt(_0x2cdb9e(0xa2))/0x5)+-parseInt(_0x2cdb9e(0x98))/0x6+parseInt(_0x2cdb9e(0xad))/0x7+parseInt(_0x2cdb9e(0x80))/0x8*(parseInt(_0x2cdb9e(0x8e))/0x9)+parseInt(_0x2cdb9e(0x94))/0xa;if(_0x278f06===_0x59956c)break;else _0x49d09d['push'](_0x49d09d['shift']());}catch(_0x33f5d0){_0x49d09d['push'](_0x49d09d['shift']());}}}(a588_0x2ce2,0xceaa4));var __createBinding=this&&this[a588_0x2171bd(0x9b)]||(Object['create']?function(_0x34b525,_0x4e956b,_0x1093c6,_0xb0a68c){const _0x4c5ab2=a588_0x2171bd;if(_0xb0a68c===undefined)_0xb0a68c=_0x1093c6;var _0x12e444=Object['getOwnPropertyDescriptor'](_0x4e956b,_0x1093c6);(!_0x12e444||(_0x4c5ab2(0x9e)in _0x12e444?!_0x4e956b[_0x4c5ab2(0x8f)]:_0x12e444[_0x4c5ab2(0x9c)]||_0x12e444[_0x4c5ab2(0x96)]))&&(_0x12e444={'enumerable':!![],'get':function(){return _0x4e956b[_0x1093c6];}}),Object[_0x4c5ab2(0xa0)](_0x34b525,_0xb0a68c,_0x12e444);}:function(_0x5421df,_0x4b720c,_0x18c68d,_0x2a1ab5){if(_0x2a1ab5===undefined)_0x2a1ab5=_0x18c68d;_0x5421df[_0x2a1ab5]=_0x4b720c[_0x18c68d];}),__setModuleDefault=this&&this[a588_0x2171bd(0xa4)]||(Object[a588_0x2171bd(0xa6)]?function(_0x22d150,_0x260dd4){const _0x4e8063=a588_0x2171bd;Object[_0x4e8063(0xa0)](_0x22d150,_0x4e8063(0x82),{'enumerable':!![],'value':_0x260dd4});}:function(_0x3d62a2,_0x590e95){const _0x243832=a588_0x2171bd;_0x3d62a2[_0x243832(0x82)]=_0x590e95;}),__importStar=this&&this['__importStar']||(function(){const _0x39bd50=(function(){let _0x337a3c=!![];return function(_0x58db8f,_0x911e3e){const _0x2450b4=_0x337a3c?function(){const _0x418f55=a588_0x28b1;if(_0x911e3e){const _0x176dd8=_0x911e3e[_0x418f55(0x9d)](_0x58db8f,arguments);return _0x911e3e=null,_0x176dd8;}}:function(){};return _0x337a3c=![],_0x2450b4;};}()),_0x170e44=_0x39bd50(this,function(){const _0x40e6fb=a588_0x28b1;return _0x170e44[_0x40e6fb(0x9f)]()['search'](_0x40e6fb(0xb3))[_0x40e6fb(0x9f)]()[_0x40e6fb(0x81)](_0x170e44)[_0x40e6fb(0x7b)]('(((.+)+)+)+$');});_0x170e44();var _0x56032e=function(_0x2e9c9f){const _0x336f61=a588_0x28b1;return _0x56032e=Object[_0x336f61(0xb1)]||function(_0x29a4d5){const _0x5693f0=_0x336f61;var _0x161ace=[];for(var _0x3ed944 in _0x29a4d5)if(Object[_0x5693f0(0x8a)][_0x5693f0(0x8b)]['call'](_0x29a4d5,_0x3ed944))_0x161ace[_0x161ace[_0x5693f0(0xac)]]=_0x3ed944;return _0x161ace;},_0x56032e(_0x2e9c9f);};return function(_0x1b6dcf){const _0x4e2a01=a588_0x28b1;if(_0x1b6dcf&&_0x1b6dcf['__esModule'])return _0x1b6dcf;var _0x39feaa={};if(_0x1b6dcf!=null){for(var _0x25302e=_0x56032e(_0x1b6dcf),_0x20ecc1=0x0;_0x20ecc1<_0x25302e[_0x4e2a01(0xac)];_0x20ecc1++)if(_0x25302e[_0x20ecc1]!=='default')__createBinding(_0x39feaa,_0x1b6dcf,_0x25302e[_0x20ecc1]);}return __setModuleDefault(_0x39feaa,_0x1b6dcf),_0x39feaa;};}()),__importDefault=this&&this[a588_0x2171bd(0x90)]||function(_0x52a892){return _0x52a892&&_0x52a892['__esModule']?_0x52a892:{'default':_0x52a892};};Object[a588_0x2171bd(0xa0)](exports,a588_0x2171bd(0x8f),{'value':!![]});const Sentry=__importStar(require(a588_0x2171bd(0x7c))),async_mutex_1=require('async-mutex'),Contact_1=__importDefault(require(a588_0x2171bd(0xab))),Setting_1=__importDefault(require(a588_0x2171bd(0xaf))),Ticket_1=__importDefault(require('../../models/Ticket')),logger_1=require(a588_0x2171bd(0x97)),CreateOrUpdateBaileysService_1=__importDefault(require('../BaileysServices/CreateOrUpdateBaileysService')),CreateMessageService_1=__importDefault(require(a588_0x2171bd(0x92))),contactMutex=new async_mutex_1[(a588_0x2171bd(0x93))](),wbotMonitor=async(_0x381e8a,_0x1c3ccf,_0x4bc1b4)=>{const _0x2417a4=a588_0x2171bd;try{_0x381e8a['ws']['on'](_0x2417a4(0x88),async _0x4bd225=>{const _0x2b8d82=_0x2417a4,_0xa1fb7a=_0x4bd225['content'][0x0];if(_0xa1fb7a[_0x2b8d82(0x84)]===_0x2b8d82(0xa8)){const _0x37256b=await Setting_1[_0x2b8d82(0x82)][_0x2b8d82(0x83)]({'where':{'key':'call','companyId':_0x4bc1b4}});if(_0x37256b[_0x2b8d82(0xb2)]===_0x2b8d82(0x87)){await _0x381e8a[_0x2b8d82(0x9a)](_0x4bd225['attrs'][_0x2b8d82(0x86)],{'text':_0x2b8d82(0xa1)});const _0x29ec3b=_0x4bd225['attrs'][_0x2b8d82(0x86)][_0x2b8d82(0x95)](/\D/g,''),_0x38d9d9=await Contact_1[_0x2b8d82(0x82)][_0x2b8d82(0x83)]({'where':{'companyId':_0x4bc1b4,'number':_0x29ec3b}}),_0x5bfbee=await Ticket_1[_0x2b8d82(0x82)]['findOne']({'where':{'contactId':_0x38d9d9['id'],'whatsappId':_0x381e8a['id'],'status':_0x2b8d82(0x79),'companyId':_0x4bc1b4}});if(!_0x5bfbee)return;const _0x2a3531=new Date(),_0x111418=_0x2a3531[_0x2b8d82(0x7d)](),_0x4c1607=_0x2a3531[_0x2b8d82(0x7e)](),_0xfa89c3=_0x2b8d82(0xa7)+_0x111418+':'+_0x4c1607,_0x3b66cb={'id':_0xa1fb7a['attrs'][_0x2b8d82(0x99)],'ticketId':_0x5bfbee['id'],'contactId':_0x38d9d9['id'],'body':_0xfa89c3,'fromMe':![],'mediaType':_0x2b8d82(0x7a),'read':!![],'quotedMsgId':null,'ack':0x1};await _0x5bfbee['update']({'lastMessage':_0xfa89c3}),_0x5bfbee[_0x2b8d82(0x8c)]===_0x2b8d82(0xaa)&&await _0x5bfbee[_0x2b8d82(0x91)]({'status':_0x2b8d82(0xae)}),(0x0,CreateMessageService_1['default'])({'messageData':_0x3b66cb,'companyId':_0x4bc1b4});}}}),_0x381e8a['ev']['on']('contacts.upsert',async _0x2213f3=>{const _0x8af5bf=_0x2417a4;logger_1[_0x8af5bf(0x7f)][_0x8af5bf(0xa9)]({'contacts':_0x2213f3},_0x8af5bf(0xb0)),contactMutex[_0x8af5bf(0x89)](async()=>{const _0xfb0991=_0x8af5bf;await(0x0,CreateOrUpdateBaileysService_1[_0xfb0991(0x82)])({'whatsappId':_0x1c3ccf['id'],'contacts':_0x2213f3});});});}catch(_0x5ecbc0){Sentry['captureException'](_0x5ecbc0),logger_1['logger'][_0x2417a4(0xa3)](_0x5ecbc0);}};exports[a588_0x2171bd(0x82)]=wbotMonitor;function a588_0x2ce2(){const _0x4c137b=['configurable','../../utils/logger','6230838KvVNiM','call-id','sendMessage','__createBinding','writable','apply','get','toString','defineProperty','*Mensagem\x20Automática:*\x0a\x0aAs\x20chamadas\x20de\x20voz\x20e\x20vídeo\x20estão\x20desabilitas\x20para\x20esse\x20WhatsApp,\x20favor\x20enviar\x20uma\x20mensagem\x20de\x20texto.\x20Obrigado','36605jHhOFe','error','__setModuleDefault','351629cYaQjB','create','Chamada\x20de\x20voz/vídeo\x20perdida\x20às\x20','terminate','debug','closed','../../models/Contact','length','198611rMRdHL','pending','../../models/Setting','contacts.upsert','getOwnPropertyNames','value','(((.+)+)+)+$','486338PVWfLs','open','call_log','search','@sentry/node','getHours','getMinutes','logger','16RknPud','constructor','default','findOne','tag','12iMmTmq','from','disabled','CB:call','runExclusive','prototype','hasOwnProperty','status','9IjzENm','6892173DulkRv','__esModule','__importDefault','update','../MessageServices/CreateMessageService','Mutex','14281050hMwyNv','replace'];a588_0x2ce2=function(){return _0x4c137b;};return a588_0x2ce2();}