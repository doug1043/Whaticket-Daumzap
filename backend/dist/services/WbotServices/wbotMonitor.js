'use strict';const a699_0x2888d1=a699_0x4d5c;function a699_0x9b85(){const _0x1d1a67=['default','getOwnPropertyDescriptor','CB:call','32470Cvyzmp','configurable','177048kNujnE','constructor','terminate','error','../../models/Ticket','debug','__createBinding','../../models/Contact','122894FSIQHV','writable','763700aQtGHw','captureException','content','__importStar','Mutex','70647sAVAcf','pending','closed','call','defineProperty','length','getHours','tag','attrs','update','replace','__importDefault','call-id','__esModule','create','apply','getMinutes','logger','status','search','hasOwnProperty','../../utils/logger','Chamada\x20de\x20voz/vídeo\x20perdida\x20às\x20','open','sendRejectCall','@sentry/node','from','256fdNlBT','2634870DsOGHl','contacts.upsert','get','../BaileysServices/CreateOrUpdateBaileysService','4VgBkfJ','../MessageServices/CreateMessageService','791555WQsLJi','runExclusive','sendMessage','findOne','(((.+)+)+)+$','toString'];a699_0x9b85=function(){return _0x1d1a67;};return a699_0x9b85();}(function(_0x2c106e,_0x33d405){const _0x521d74=a699_0x4d5c,_0x220dd5=_0x2c106e();while(!![]){try{const _0x41607e=parseInt(_0x521d74(0x15a))/0x1+-parseInt(_0x521d74(0x150))/0x2+-parseInt(_0x521d74(0x161))/0x3*(-parseInt(_0x521d74(0x145))/0x4)+-parseInt(_0x521d74(0x147))/0x5+-parseInt(_0x521d74(0x141))/0x6+parseInt(_0x521d74(0x15c))/0x7+-parseInt(_0x521d74(0x140))/0x8*(-parseInt(_0x521d74(0x152))/0x9);if(_0x41607e===_0x33d405)break;else _0x220dd5['push'](_0x220dd5['shift']());}catch(_0x5385f4){_0x220dd5['push'](_0x220dd5['shift']());}}}(a699_0x9b85,0x423fc));var __createBinding=this&&this[a699_0x2888d1(0x158)]||(Object[a699_0x2888d1(0x16f)]?function(_0x998dc7,_0x368bb3,_0xd18250,_0x3e20cf){const _0x527ab3=a699_0x2888d1;if(_0x3e20cf===undefined)_0x3e20cf=_0xd18250;var _0x10a875=Object[_0x527ab3(0x14e)](_0x368bb3,_0xd18250);(!_0x10a875||(_0x527ab3(0x143)in _0x10a875?!_0x368bb3[_0x527ab3(0x16e)]:_0x10a875[_0x527ab3(0x15b)]||_0x10a875[_0x527ab3(0x151)]))&&(_0x10a875={'enumerable':!![],'get':function(){return _0x368bb3[_0xd18250];}}),Object[_0x527ab3(0x165)](_0x998dc7,_0x3e20cf,_0x10a875);}:function(_0x266ab1,_0x533603,_0xd0bf8f,_0x4d0276){if(_0x4d0276===undefined)_0x4d0276=_0xd0bf8f;_0x266ab1[_0x4d0276]=_0x533603[_0xd0bf8f];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a699_0x2888d1(0x16f)]?function(_0x3c3ac7,_0x2fe36d){const _0x5dd5c9=a699_0x2888d1;Object['defineProperty'](_0x3c3ac7,_0x5dd5c9(0x14d),{'enumerable':!![],'value':_0x2fe36d});}:function(_0x48e65d,_0xa02e25){const _0x33abc8=a699_0x2888d1;_0x48e65d[_0x33abc8(0x14d)]=_0xa02e25;}),__importStar=this&&this[a699_0x2888d1(0x15f)]||(function(){const _0x48d24d=(function(){let _0x5ad0bd=!![];return function(_0x4dcf9b,_0x301cd5){const _0x569e27=_0x5ad0bd?function(){const _0x514662=a699_0x4d5c;if(_0x301cd5){const _0x4082a3=_0x301cd5[_0x514662(0x170)](_0x4dcf9b,arguments);return _0x301cd5=null,_0x4082a3;}}:function(){};return _0x5ad0bd=![],_0x569e27;};}()),_0x4e45f2=_0x48d24d(this,function(){const _0x2f3293=a699_0x4d5c;return _0x4e45f2['toString']()[_0x2f3293(0x174)](_0x2f3293(0x14b))[_0x2f3293(0x14c)]()[_0x2f3293(0x153)](_0x4e45f2)[_0x2f3293(0x174)](_0x2f3293(0x14b));});_0x4e45f2();var _0x5ce2d6=function(_0x48136f){return _0x5ce2d6=Object['getOwnPropertyNames']||function(_0x401df4){const _0x516576=a699_0x4d5c;var _0x32f842=[];for(var _0xc5441e in _0x401df4)if(Object['prototype'][_0x516576(0x175)][_0x516576(0x164)](_0x401df4,_0xc5441e))_0x32f842[_0x32f842[_0x516576(0x166)]]=_0xc5441e;return _0x32f842;},_0x5ce2d6(_0x48136f);};return function(_0x8f8263){const _0x1ea143=a699_0x4d5c;if(_0x8f8263&&_0x8f8263['__esModule'])return _0x8f8263;var _0x1b46be={};if(_0x8f8263!=null){for(var _0x44c192=_0x5ce2d6(_0x8f8263),_0x1edbe6=0x0;_0x1edbe6<_0x44c192[_0x1ea143(0x166)];_0x1edbe6++)if(_0x44c192[_0x1edbe6]!==_0x1ea143(0x14d))__createBinding(_0x1b46be,_0x8f8263,_0x44c192[_0x1edbe6]);}return __setModuleDefault(_0x1b46be,_0x8f8263),_0x1b46be;};}()),__importDefault=this&&this[a699_0x2888d1(0x16c)]||function(_0xead8f0){const _0x599cf0=a699_0x2888d1;return _0xead8f0&&_0xead8f0[_0x599cf0(0x16e)]?_0xead8f0:{'default':_0xead8f0};};function a699_0x4d5c(_0x46c29e,_0x4bb5e1){const _0xd45b41=a699_0x9b85();return a699_0x4d5c=function(_0x41fec9,_0x19863d){_0x41fec9=_0x41fec9-0x13b;let _0x9b8503=_0xd45b41[_0x41fec9];return _0x9b8503;},a699_0x4d5c(_0x46c29e,_0x4bb5e1);}Object[a699_0x2888d1(0x165)](exports,a699_0x2888d1(0x16e),{'value':!![]});const Sentry=__importStar(require(a699_0x2888d1(0x13e))),async_mutex_1=require('async-mutex'),Contact_1=__importDefault(require(a699_0x2888d1(0x159))),Ticket_1=__importDefault(require(a699_0x2888d1(0x156))),logger_1=require(a699_0x2888d1(0x176)),CreateOrUpdateBaileysService_1=__importDefault(require(a699_0x2888d1(0x144))),CreateMessageService_1=__importDefault(require(a699_0x2888d1(0x146))),contactMutex=new async_mutex_1[(a699_0x2888d1(0x160))](),wbotMonitor=async(_0x5da728,_0xd16d66,_0x71e6ed)=>{const _0x2b8315=a699_0x2888d1;try{_0x5da728['ws']['on'](_0x2b8315(0x14f),async _0x30750a=>{const _0x549705=_0x2b8315,_0x3ae911=_0x30750a[_0x549705(0x15e)][0x0];if(_0x3ae911[_0x549705(0x168)]===_0x549705(0x154)){if(_0xd16d66[_0x549705(0x13d)]&&!_0xd16d66['allowGroup']){const _0x14324c=_0xd16d66['rejectCallMessage']?.['trim']()||'*Mensagem\x20Automática:*\x0a\x0aAs\x20chamadas\x20de\x20voz\x20e\x20vídeo\x20estão\x20desabilitadas\x20para\x20esse\x20WhatsApp,\x20favor\x20enviar\x20uma\x20mensagem\x20de\x20texto.\x20Obrigado';await _0x5da728[_0x549705(0x149)](_0x30750a[_0x549705(0x169)][_0x549705(0x13f)],{'text':_0x14324c});}const _0x458d30=_0x30750a[_0x549705(0x169)][_0x549705(0x13f)][_0x549705(0x16b)](/\D/g,''),_0x162d88=await Contact_1[_0x549705(0x14d)][_0x549705(0x14a)]({'where':{'companyId':_0x71e6ed,'number':_0x458d30}});if(!_0x162d88)return;const _0x419dc9=await Ticket_1[_0x549705(0x14d)]['findOne']({'where':{'contactId':_0x162d88['id'],'whatsappId':_0x5da728['id'],'status':_0x549705(0x13c),'companyId':_0x71e6ed}});if(!_0x419dc9)return;const _0x2ded97=new Date(),_0x3fcc91=_0x2ded97[_0x549705(0x167)](),_0x14aae2=_0x2ded97[_0x549705(0x171)](),_0x2b2f25=_0x549705(0x13b)+_0x3fcc91+':'+_0x14aae2,_0x39474b={'id':_0x3ae911['attrs'][_0x549705(0x16d)],'ticketId':_0x419dc9['id'],'contactId':_0x162d88['id'],'body':_0x2b2f25,'fromMe':![],'mediaType':'call_log','read':!![],'quotedMsgId':null,'ack':0x1};await _0x419dc9[_0x549705(0x16a)]({'lastMessage':_0x2b2f25}),_0x419dc9[_0x549705(0x173)]===_0x549705(0x163)&&await _0x419dc9['update']({'status':_0x549705(0x162)}),(0x0,CreateMessageService_1[_0x549705(0x14d)])({'messageData':_0x39474b,'companyId':_0x71e6ed});}}),_0x5da728['ev']['on'](_0x2b8315(0x142),async _0x173d2a=>{const _0x1787fe=_0x2b8315;logger_1[_0x1787fe(0x172)][_0x1787fe(0x157)]({'contacts':_0x173d2a},_0x1787fe(0x142)),contactMutex[_0x1787fe(0x148)](async()=>{await(0x0,CreateOrUpdateBaileysService_1['default'])({'whatsappId':_0xd16d66['id'],'contacts':_0x173d2a});});});}catch(_0x2bd74d){Sentry[_0x2b8315(0x15d)](_0x2bd74d),logger_1['logger'][_0x2b8315(0x155)](_0x2bd74d);}};exports['default']=wbotMonitor;