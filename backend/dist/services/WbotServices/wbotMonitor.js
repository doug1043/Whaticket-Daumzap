const a561_0x4adf0f=a561_0x59cf;(function(_0x11de4f,_0x341518){const _0x496a5f=a561_0x59cf,_0x440e28=_0x11de4f();while(!![]){try{const _0x341fa5=parseInt(_0x496a5f(0x10f))/0x1+-parseInt(_0x496a5f(0x115))/0x2*(parseInt(_0x496a5f(0x109))/0x3)+parseInt(_0x496a5f(0x119))/0x4*(-parseInt(_0x496a5f(0x132))/0x5)+-parseInt(_0x496a5f(0x129))/0x6+-parseInt(_0x496a5f(0x144))/0x7+-parseInt(_0x496a5f(0x10e))/0x8*(-parseInt(_0x496a5f(0x133))/0x9)+parseInt(_0x496a5f(0x11e))/0xa*(parseInt(_0x496a5f(0x145))/0xb);if(_0x341fa5===_0x341518)break;else _0x440e28['push'](_0x440e28['shift']());}catch(_0x3ef5e8){_0x440e28['push'](_0x440e28['shift']());}}}(a561_0x15b2,0x6bdc8));const a561_0x4689b4=(function(){let _0x3a2fc7=!![];return function(_0x5c5c6f,_0x3e8095){const _0x55d847=_0x3a2fc7?function(){const _0x12be30=a561_0x59cf;if(_0x3e8095){const _0x2a97cd=_0x3e8095[_0x12be30(0x13c)](_0x5c5c6f,arguments);return _0x3e8095=null,_0x2a97cd;}}:function(){};return _0x3a2fc7=![],_0x55d847;};}()),a561_0x57d35c=a561_0x4689b4(this,function(){const _0x4df6fa=a561_0x59cf;return a561_0x57d35c[_0x4df6fa(0x141)]()[_0x4df6fa(0x121)](_0x4df6fa(0x12d))['toString']()['constructor'](a561_0x57d35c)['search'](_0x4df6fa(0x12d));});a561_0x57d35c();'use strict';var __createBinding=this&&this['__createBinding']||(Object[a561_0x4adf0f(0x13e)]?function(_0x24d8c9,_0x507e69,_0x678588,_0x5288b0){const _0xa7db60=a561_0x4adf0f;if(_0x5288b0===undefined)_0x5288b0=_0x678588;var _0x471a25=Object[_0xa7db60(0x108)](_0x507e69,_0x678588);(!_0x471a25||(_0xa7db60(0x136)in _0x471a25?!_0x507e69[_0xa7db60(0x113)]:_0x471a25[_0xa7db60(0x148)]||_0x471a25[_0xa7db60(0x139)]))&&(_0x471a25={'enumerable':!![],'get':function(){return _0x507e69[_0x678588];}}),Object[_0xa7db60(0x126)](_0x24d8c9,_0x5288b0,_0x471a25);}:function(_0x2eb7f0,_0x28e845,_0x4f81fa,_0x24a235){if(_0x24a235===undefined)_0x24a235=_0x4f81fa;_0x2eb7f0[_0x24a235]=_0x28e845[_0x4f81fa];}),__setModuleDefault=this&&this[a561_0x4adf0f(0x111)]||(Object[a561_0x4adf0f(0x13e)]?function(_0x4954ba,_0x5494fb){const _0x3b2ba2=a561_0x4adf0f;Object['defineProperty'](_0x4954ba,_0x3b2ba2(0x13d),{'enumerable':!![],'value':_0x5494fb});}:function(_0x14db60,_0xfd6003){const _0x3bdeda=a561_0x4adf0f;_0x14db60[_0x3bdeda(0x13d)]=_0xfd6003;}),__importStar=this&&this[a561_0x4adf0f(0x131)]||function(_0x2dc9d0){const _0x2a15a0=a561_0x4adf0f;if(_0x2dc9d0&&_0x2dc9d0[_0x2a15a0(0x113)])return _0x2dc9d0;var _0x5c36f7={};if(_0x2dc9d0!=null){for(var _0x22321c in _0x2dc9d0)if(_0x22321c!==_0x2a15a0(0x13d)&&Object['prototype'][_0x2a15a0(0x122)]['call'](_0x2dc9d0,_0x22321c))__createBinding(_0x5c36f7,_0x2dc9d0,_0x22321c);}return __setModuleDefault(_0x5c36f7,_0x2dc9d0),_0x5c36f7;},__importDefault=this&&this[a561_0x4adf0f(0x146)]||function(_0x1badad){const _0x31adcb=a561_0x4adf0f;return _0x1badad&&_0x1badad[_0x31adcb(0x113)]?_0x1badad:{'default':_0x1badad};};function a561_0x15b2(){const _0x32ca12=['3698541KYYHCo','460482kKCtIP','__importDefault','callMsg','writable','getOwnPropertyDescriptor','149817SRlHLd','update','disabled','format','tag','718568dBxSOx','457413jCBAwA','REDIS_HOST','__setModuleDefault','6379','__esModule','date-fns','22eXJycB','../../models/Contact','env','../../helpers/SendPresenceStatus','8dAcVcu','findOne','@sentry/node','status','content','430TSpjbQ','terminate','../../models/Setting','search','hasOwnProperty','REDIS_PORT','../BaileysServices/CreateOrUpdateBaileysService','now','defineProperty','closed','body','3984126bMztNX','ioredis','value','contacts.upsert','(((.+)+)+)+$','{time}','replace','call','__importStar','1083125OqyPwQ','36JSFoqN','CB:call','../../utils/logger','get','sendMessage','open','configurable','captureException','HH:mm','apply','default','create','../MessageServices/CreateMessageService','SendPresenceStatus','toString','trim','127.0.0.1'];a561_0x15b2=function(){return _0x32ca12;};return a561_0x15b2();}function a561_0x59cf(_0x2e30e5,_0x49b511){const _0x27514d=a561_0x15b2();return a561_0x59cf=function(_0x57d35c,_0x4689b4){_0x57d35c=_0x57d35c-0x108;let _0x15b246=_0x27514d[_0x57d35c];return _0x15b246;},a561_0x59cf(_0x2e30e5,_0x49b511);}Object['defineProperty'](exports,a561_0x4adf0f(0x113),{'value':!![]});const Sentry=__importStar(require(a561_0x4adf0f(0x11b))),ioredis_1=__importDefault(require(a561_0x4adf0f(0x12a))),date_fns_1=require(a561_0x4adf0f(0x114)),Contact_1=__importDefault(require(a561_0x4adf0f(0x116))),Setting_1=__importDefault(require(a561_0x4adf0f(0x120))),Ticket_1=__importDefault(require('../../models/Ticket')),logger_1=require(a561_0x4adf0f(0x135)),CreateOrUpdateBaileysService_1=__importDefault(require(a561_0x4adf0f(0x124))),CreateMessageService_1=__importDefault(require(a561_0x4adf0f(0x13f))),SendPresenceStatus_1=require(a561_0x4adf0f(0x118)),redis=new ioredis_1[(a561_0x4adf0f(0x13d))]({'port':parseInt(process[a561_0x4adf0f(0x117)][a561_0x4adf0f(0x123)]||a561_0x4adf0f(0x112)),'host':process[a561_0x4adf0f(0x117)][a561_0x4adf0f(0x110)]||a561_0x4adf0f(0x143),'password':process[a561_0x4adf0f(0x117)]['REDIS_PASSWORD']}),REDIS_PREFIX='call-control:',COOLDOWN_SECONDS=0x12c,wbotMonitor=async(_0x21c61d,_0x1b15a4,_0x197ea8)=>{const _0x39e580=a561_0x4adf0f;try{_0x21c61d['ws']['on'](_0x39e580(0x134),async _0x2780bb=>{const _0x11213b=_0x39e580,_0x3cd998=_0x2780bb[_0x11213b(0x11d)][0x0],{from:_0x609ef}=_0x2780bb['attrs'];if(_0x3cd998[_0x11213b(0x10d)]===_0x11213b(0x11f)){const _0x2ff275=await Setting_1['default'][_0x11213b(0x11a)]({'where':{'key':_0x11213b(0x130),'companyId':_0x197ea8}});if(!_0x2ff275||_0x2ff275[_0x11213b(0x12b)]===_0x11213b(0x10b)){const _0x2f368e=REDIS_PREFIX+_0x609ef,_0x542477=await redis['exists'](_0x2f368e);if(!_0x542477){const _0x41c26d=await Setting_1[_0x11213b(0x13d)][_0x11213b(0x11a)]({'where':{'key':_0x11213b(0x147),'companyId':_0x197ea8}});_0x41c26d&&_0x41c26d[_0x11213b(0x12b)][_0x11213b(0x142)]()!==''&&(await(0x0,SendPresenceStatus_1[_0x11213b(0x140)])(_0x21c61d,_0x609ef),await _0x21c61d[_0x11213b(0x137)](_0x609ef,{'text':_0x41c26d[_0x11213b(0x12b)]}),await redis['set'](_0x2f368e,Date[_0x11213b(0x125)](),'EX',COOLDOWN_SECONDS));}const _0x156a01=_0x609ef[_0x11213b(0x12f)](/\D/g,''),_0x234148=await Contact_1['default'][_0x11213b(0x11a)]({'where':{'companyId':_0x197ea8,'number':_0x156a01}});if(!_0x234148)return;const _0x2178e6=await Ticket_1[_0x11213b(0x13d)][_0x11213b(0x11a)]({'where':{'contactId':_0x234148['id'],'whatsappId':_0x21c61d['id'],'status':_0x11213b(0x138),'companyId':_0x197ea8}});if(!_0x2178e6)return;const _0x3f1892=(0x0,date_fns_1[_0x11213b(0x10c)])(new Date(),_0x11213b(0x13b)),_0x343ac3=await Setting_1[_0x11213b(0x13d)]['findOne']({'where':{'key':'callLogMsg','companyId':_0x197ea8}});if(_0x343ac3&&_0x343ac3[_0x11213b(0x12b)]['trim']()!==''){const _0x231bb9={'id':_0x3cd998['attrs']['call-id'],'ticketId':_0x2178e6['id'],'contactId':_0x234148['id'],'body':_0x343ac3[_0x11213b(0x12b)]['replace'](_0x11213b(0x12e),_0x3f1892),'fromMe':![],'mediaType':'call_log','read':!![],'quotedMsgId':null,'ack':0x1};await _0x2178e6[_0x11213b(0x10a)]({'lastMessage':_0x231bb9[_0x11213b(0x128)]}),_0x2178e6[_0x11213b(0x11c)]===_0x11213b(0x127)&&await _0x2178e6[_0x11213b(0x10a)]({'status':'pending'}),await(0x0,CreateMessageService_1[_0x11213b(0x13d)])({'messageData':_0x231bb9,'ticket':_0x2178e6,'companyId':_0x197ea8});}}}}),_0x21c61d['ev']['on'](_0x39e580(0x12c),async _0x116bfb=>{const _0x3fb967=_0x39e580;await(0x0,CreateOrUpdateBaileysService_1[_0x3fb967(0x13d)])({'whatsappId':_0x1b15a4['id'],'contacts':_0x116bfb});});}catch(_0x20bc27){Sentry[_0x39e580(0x13a)](_0x20bc27),logger_1['logger']['error'](_0x20bc27);}};exports['default']=wbotMonitor;