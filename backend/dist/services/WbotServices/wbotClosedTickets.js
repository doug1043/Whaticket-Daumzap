const a557_0x51e29a=a557_0x5462;(function(_0x61f59,_0x17cc6e){const _0xe564de=a557_0x5462,_0x421fca=_0x61f59();while(!![]){try{const _0x4d259f=-parseInt(_0xe564de(0x155))/0x1+-parseInt(_0xe564de(0x145))/0x2*(-parseInt(_0xe564de(0x13f))/0x3)+parseInt(_0xe564de(0x14d))/0x4*(parseInt(_0xe564de(0x157))/0x5)+parseInt(_0xe564de(0x150))/0x6+parseInt(_0xe564de(0x15e))/0x7*(parseInt(_0xe564de(0x152))/0x8)+parseInt(_0xe564de(0x14f))/0x9*(parseInt(_0xe564de(0x15a))/0xa)+parseInt(_0xe564de(0x13a))/0xb*(-parseInt(_0xe564de(0x15b))/0xc);if(_0x4d259f===_0x17cc6e)break;else _0x421fca['push'](_0x421fca['shift']());}catch(_0x446a18){_0x421fca['push'](_0x421fca['shift']());}}}(a557_0x43d6,0xc7c0a));const a557_0x4dcce0=(function(){let _0x38623a=!![];return function(_0x42fa45,_0x18d38e){const _0x30ad35=_0x38623a?function(){const _0x323e0f=a557_0x5462;if(_0x18d38e){const _0x16c66c=_0x18d38e[_0x323e0f(0x151)](_0x42fa45,arguments);return _0x18d38e=null,_0x16c66c;}}:function(){};return _0x38623a=![],_0x30ad35;};}()),a557_0x43a219=a557_0x4dcce0(this,function(){const _0x5b8d64=a557_0x5462;return a557_0x43a219[_0x5b8d64(0x156)]()[_0x5b8d64(0x134)](_0x5b8d64(0x14a))[_0x5b8d64(0x156)]()['constructor'](a557_0x43a219)['search'](_0x5b8d64(0x14a));});a557_0x43a219();'use strict';var __importDefault=this&&this[a557_0x51e29a(0x13d)]||function(_0x485cb1){const _0x25a410=a557_0x51e29a;return _0x485cb1&&_0x485cb1[_0x25a410(0x167)]?_0x485cb1:{'default':_0x485cb1};};function a557_0x5462(_0x1f7496,_0x3ca41c){const _0x5be033=a557_0x43d6();return a557_0x5462=function(_0x43a219,_0x4dcce0){_0x43a219=_0x43a219-0x131;let _0x43d60b=_0x5be033[_0x43a219];return _0x43d60b;},a557_0x5462(_0x1f7496,_0x3ca41c);}function a557_0x43d6(){const _0x412813=['userId','12CRhFSD','../../models/Ticket','nps','open','default','../../models/TicketTraking','797626JdDOje','-open','verifyMessage','../../models/Whatsapp','whatsappId','(((.+)+)+)+$','companyId','DESC','7244TtdmIW','fromMe','27LPryZZ','2806752ZALJAm','apply','833288dYfSaD','../../helpers/Mustache','toDate','1289379lxUdMZ','toString','625SsbTjh','../../helpers/SendPresenceStatus','string','1735040UAsiiO','312204uemnXa','s.whatsapp.net','g.us','7rBUenf','../TicketServices/ShowTicketService','isGroup','company-','moment','trace','../../libs/socket','findAndCountAll','body\x20is\x20not\x20a\x20string','__esModule','-ticket','sequelize','log','getIO','getWbot','updatedAt','SendPresenceStatus','../../libs/wbot','number','findByPk','getMinutes','search','closed','defineProperty','delete','ClosedAllOpenTickets','contact','341ekFvaN','update','status','__importDefault'];a557_0x43d6=function(){return _0x412813;};return a557_0x43d6();}Object[a557_0x51e29a(0x136)](exports,'__esModule',{'value':!![]}),exports['ClosedAllOpenTickets']=void 0x0;const sequelize_1=require(a557_0x51e29a(0x169)),Ticket_1=__importDefault(require(a557_0x51e29a(0x140))),Whatsapp_1=__importDefault(require(a557_0x51e29a(0x148))),socket_1=require(a557_0x51e29a(0x164)),Mustache_1=__importDefault(require(a557_0x51e29a(0x153))),SendWhatsAppMessage_1=__importDefault(require('./SendWhatsAppMessage')),moment_1=__importDefault(require(a557_0x51e29a(0x162))),ShowTicketService_1=__importDefault(require(a557_0x51e29a(0x15f))),wbotMessageListener_1=require('./wbotMessageListener'),TicketTraking_1=__importDefault(require(a557_0x51e29a(0x144))),SendPresenceStatus_1=require(a557_0x51e29a(0x158)),wbot_1=require(a557_0x51e29a(0x16f)),ClosedAllOpenTickets=async _0x6298cb=>{const _0x44baaa=a557_0x51e29a,_0x1448c2=async(_0x1d4c45,_0x3d56c4,_0x24dd57)=>{const _0x314e74=a557_0x5462;if(_0x3d56c4===_0x314e74(0x141))typeof _0x24dd57!=_0x314e74(0x159)&&console[_0x314e74(0x163)](_0x314e74(0x166),_0x24dd57),await _0x1d4c45[_0x314e74(0x13b)]({'status':'closed','lastMessage':_0x24dd57,'unreadMessages':0x0,'amountUseBotQueues':0x0});else _0x3d56c4===_0x314e74(0x142)?(typeof _0x24dd57!=_0x314e74(0x159)&&console['trace'](_0x314e74(0x166),_0x24dd57),await _0x1d4c45[_0x314e74(0x13b)]({'status':_0x314e74(0x135),'lastMessage':_0x24dd57,'unreadMessages':0x0,'amountUseBotQueues':0x0})):await _0x1d4c45[_0x314e74(0x13b)]({'status':_0x314e74(0x135),'unreadMessages':0x0});},_0x261da4=(0x0,socket_1[_0x44baaa(0x16b)])();try{const {rows:_0x4198b6}=await Ticket_1[_0x44baaa(0x143)][_0x44baaa(0x165)]({'where':{'status':{[sequelize_1['Op']['in']]:[_0x44baaa(0x142)]},'companyId':_0x6298cb},'order':[[_0x44baaa(0x16d),_0x44baaa(0x14c)]]});for(const _0x1d1e71 of _0x4198b6){const _0x1a6122=await(0x0,ShowTicketService_1[_0x44baaa(0x143)])(_0x1d1e71['id'],_0x6298cb),_0x34e75b=await Whatsapp_1[_0x44baaa(0x143)][_0x44baaa(0x132)](_0x1a6122?.[_0x44baaa(0x149)]);if(!_0x34e75b)continue;const _0x433710=await TicketTraking_1[_0x44baaa(0x143)]['findOne']({'where':{'ticketId':_0x1d1e71['id'],'finishedAt':null}});let {expiresInactiveMessage:_0x52330c,expiresTicket:_0x389fdb}=_0x34e75b;if(_0x389fdb&&_0x389fdb!==''&&_0x389fdb!=='0'&&Number(_0x389fdb)>0x0){const _0x31970d=(0x0,Mustache_1[_0x44baaa(0x143)])('â€Ž\x20'+_0x52330c,_0x1a6122),_0x151e5c=new Date();_0x151e5c['setMinutes'](_0x151e5c[_0x44baaa(0x133)]()-Number(_0x389fdb));if(_0x1a6122[_0x44baaa(0x13c)]===_0x44baaa(0x142)&&!_0x1a6122[_0x44baaa(0x160)]){const _0x61be5a=new Date(_0x1a6122[_0x44baaa(0x16d)]);if(_0x61be5a<_0x151e5c&&_0x1a6122[_0x44baaa(0x14e)]){await _0x1448c2(_0x1a6122,_0x1a6122[_0x44baaa(0x13c)],_0x31970d);if(_0x52330c!==''&&_0x52330c!==undefined){await(0x0,SendPresenceStatus_1[_0x44baaa(0x16e)])((0x0,wbot_1[_0x44baaa(0x16c)])(_0x1d1e71[_0x44baaa(0x149)]),_0x1d1e71[_0x44baaa(0x139)][_0x44baaa(0x131)]+'@'+(_0x1d1e71[_0x44baaa(0x160)]?_0x44baaa(0x15d):_0x44baaa(0x15c)));const _0x43ee9d=await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x31970d,'ticket':_0x1a6122});await(0x0,wbotMessageListener_1[_0x44baaa(0x147)])(_0x43ee9d,_0x1a6122,_0x1a6122[_0x44baaa(0x139)]);}await _0x433710[_0x44baaa(0x13b)]({'finishedAt':(0x0,moment_1[_0x44baaa(0x143)])()[_0x44baaa(0x154)](),'closedAt':(0x0,moment_1[_0x44baaa(0x143)])()['toDate'](),'whatsappId':_0x1d1e71[_0x44baaa(0x149)],'userId':_0x1d1e71[_0x44baaa(0x13e)]}),_0x261da4['to'](_0x44baaa(0x161)+_0x1d1e71[_0x44baaa(0x14b)]+_0x44baaa(0x146))['emit'](_0x44baaa(0x161)+_0x6298cb+_0x44baaa(0x168),{'action':_0x44baaa(0x137),'ticketId':_0x1a6122['id']});}}}}}catch(_0x3cd1f2){console[_0x44baaa(0x16a)]('e',_0x3cd1f2);}};exports[a557_0x51e29a(0x138)]=ClosedAllOpenTickets;