const a558_0x31ff93=a558_0x502f;(function(_0x4d8a05,_0x310cd0){const _0x4e5ff3=a558_0x502f,_0x1ba2a7=_0x4d8a05();while(!![]){try{const _0x230b84=-parseInt(_0x4e5ff3(0x15a))/0x1*(-parseInt(_0x4e5ff3(0x166))/0x2)+-parseInt(_0x4e5ff3(0x176))/0x3*(-parseInt(_0x4e5ff3(0x15b))/0x4)+-parseInt(_0x4e5ff3(0x162))/0x5*(-parseInt(_0x4e5ff3(0x15c))/0x6)+-parseInt(_0x4e5ff3(0x16b))/0x7*(parseInt(_0x4e5ff3(0x154))/0x8)+-parseInt(_0x4e5ff3(0x150))/0x9+-parseInt(_0x4e5ff3(0x180))/0xa+parseInt(_0x4e5ff3(0x167))/0xb*(parseInt(_0x4e5ff3(0x171))/0xc);if(_0x230b84===_0x310cd0)break;else _0x1ba2a7['push'](_0x1ba2a7['shift']());}catch(_0x371d3c){_0x1ba2a7['push'](_0x1ba2a7['shift']());}}}(a558_0x1253,0xa6874));const a558_0x4693a0=(function(){let _0x457075=!![];return function(_0x51b8d8,_0x486023){const _0x3c1c26=_0x457075?function(){if(_0x486023){const _0x523128=_0x486023['apply'](_0x51b8d8,arguments);return _0x486023=null,_0x523128;}}:function(){};return _0x457075=![],_0x3c1c26;};}()),a558_0x18b3d1=a558_0x4693a0(this,function(){const _0x47bb2d=a558_0x502f;return a558_0x18b3d1['toString']()[_0x47bb2d(0x186)](_0x47bb2d(0x17a))[_0x47bb2d(0x152)]()['constructor'](a558_0x18b3d1)[_0x47bb2d(0x186)](_0x47bb2d(0x17a));});a558_0x18b3d1();'use strict';var __importDefault=this&&this[a558_0x31ff93(0x178)]||function(_0x55f8db){return _0x55f8db&&_0x55f8db['__esModule']?_0x55f8db:{'default':_0x55f8db};};Object[a558_0x31ff93(0x16d)](exports,a558_0x31ff93(0x183),{'value':!![]}),exports['ClosedAllOpenTickets']=void 0x0;function a558_0x502f(_0xc7e29b,_0x15a60c){const _0x3ca395=a558_0x1253();return a558_0x502f=function(_0x18b3d1,_0x4693a0){_0x18b3d1=_0x18b3d1-0x14d;let _0x1253aa=_0x3ca395[_0x18b3d1];return _0x1253aa;},a558_0x502f(_0xc7e29b,_0x15a60c);}function a558_0x1253(){const _0x5ae2f3=['updatedAt','../../models/Whatsapp','170AZYsVP','23507WAFLgV','emit','log','./SendWhatsAppMessage','425369WROCMw','s.whatsapp.net','defineProperty','company-','getWbot','companyId','10092KGoxKQ','../../libs/wbot','../../libs/socket','setMinutes','contact','3aYprpD','../../models/Ticket','__importDefault','body\x20is\x20not\x20a\x20string','(((.+)+)+)+$','toDate','open','getIO','verifyMessage','getMinutes','2916320PGKaZL','DESC','g.us','__esModule','ClosedAllOpenTickets','fromMe','search','sequelize','isGroup','nps','SendPresenceStatus','../../helpers/Mustache','11994966qJXMeg','default','toString','status','56UoIneO','findAndCountAll','string','findOne','userId','whatsappId','8674XKcCwK','1672CVZAhR','12ydwldy','trace','update','../../models/TicketTraking','../../helpers/SendPresenceStatus','findByPk','492375tWlKHP','closed'];a558_0x1253=function(){return _0x5ae2f3;};return a558_0x1253();}const sequelize_1=require(a558_0x31ff93(0x187)),Ticket_1=__importDefault(require(a558_0x31ff93(0x177))),Whatsapp_1=__importDefault(require(a558_0x31ff93(0x165))),socket_1=require(a558_0x31ff93(0x173)),Mustache_1=__importDefault(require(a558_0x31ff93(0x14f))),SendWhatsAppMessage_1=__importDefault(require(a558_0x31ff93(0x16a))),moment_1=__importDefault(require('moment')),ShowTicketService_1=__importDefault(require('../TicketServices/ShowTicketService')),wbotMessageListener_1=require('./wbotMessageListener'),TicketTraking_1=__importDefault(require(a558_0x31ff93(0x15f))),SendPresenceStatus_1=require(a558_0x31ff93(0x160)),wbot_1=require(a558_0x31ff93(0x172)),ClosedAllOpenTickets=async _0x1c5376=>{const _0x5ead03=a558_0x31ff93,_0x382fae=async(_0xf53ba4,_0x21949e,_0x502a2d)=>{const _0x294a84=a558_0x502f;if(_0x21949e===_0x294a84(0x14d))typeof _0x502a2d!=_0x294a84(0x156)&&console[_0x294a84(0x15d)](_0x294a84(0x179),_0x502a2d),await _0xf53ba4[_0x294a84(0x15e)]({'status':_0x294a84(0x163),'lastMessage':_0x502a2d,'unreadMessages':0x0,'amountUseBotQueues':0x0});else _0x21949e==='open'?(typeof _0x502a2d!='string'&&console[_0x294a84(0x15d)](_0x294a84(0x179),_0x502a2d),await _0xf53ba4[_0x294a84(0x15e)]({'status':_0x294a84(0x163),'lastMessage':_0x502a2d,'unreadMessages':0x0,'amountUseBotQueues':0x0})):await _0xf53ba4['update']({'status':'closed','unreadMessages':0x0});},_0x538a43=(0x0,socket_1[_0x5ead03(0x17d)])();try{const {rows:_0x4ee7df}=await Ticket_1[_0x5ead03(0x151)][_0x5ead03(0x155)]({'where':{'status':{[sequelize_1['Op']['in']]:[_0x5ead03(0x17c)]},'companyId':_0x1c5376},'order':[[_0x5ead03(0x164),_0x5ead03(0x181)]]});for(const _0x14582b of _0x4ee7df){const _0x4ae812=await(0x0,ShowTicketService_1['default'])(_0x14582b['id'],_0x1c5376),_0x1a6ae4=await Whatsapp_1[_0x5ead03(0x151)][_0x5ead03(0x161)](_0x4ae812?.[_0x5ead03(0x159)]);if(!_0x1a6ae4)continue;const _0x28c593=await TicketTraking_1[_0x5ead03(0x151)][_0x5ead03(0x157)]({'where':{'ticketId':_0x14582b['id'],'finishedAt':null}});let {expiresInactiveMessage:_0x493c5d,expiresTicket:_0x5b491a}=_0x1a6ae4;if(_0x5b491a&&_0x5b491a!==''&&_0x5b491a!=='0'&&Number(_0x5b491a)>0x0){const _0x5f4b38=(0x0,Mustache_1[_0x5ead03(0x151)])('â€Ž\x20'+_0x493c5d,_0x4ae812),_0x1848d4=new Date();_0x1848d4[_0x5ead03(0x174)](_0x1848d4[_0x5ead03(0x17f)]()-Number(_0x5b491a));if(_0x4ae812[_0x5ead03(0x153)]==='open'&&!_0x4ae812[_0x5ead03(0x188)]){const _0x137aa7=new Date(_0x4ae812['updatedAt']);if(_0x137aa7<_0x1848d4&&_0x4ae812[_0x5ead03(0x185)]){await _0x382fae(_0x4ae812,_0x4ae812['status'],_0x5f4b38);if(_0x493c5d!==''&&_0x493c5d!==undefined){await(0x0,SendPresenceStatus_1[_0x5ead03(0x14e)])((0x0,wbot_1[_0x5ead03(0x16f)])(_0x14582b[_0x5ead03(0x159)]),_0x14582b['contact']['number']+'@'+(_0x14582b[_0x5ead03(0x188)]?_0x5ead03(0x182):_0x5ead03(0x16c)));const _0x557667=await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x5f4b38,'ticket':_0x4ae812});await(0x0,wbotMessageListener_1[_0x5ead03(0x17e)])(_0x557667,_0x4ae812,_0x4ae812[_0x5ead03(0x175)]);}await _0x28c593['update']({'finishedAt':(0x0,moment_1[_0x5ead03(0x151)])()[_0x5ead03(0x17b)](),'closedAt':(0x0,moment_1[_0x5ead03(0x151)])()[_0x5ead03(0x17b)](),'whatsappId':_0x14582b['whatsappId'],'userId':_0x14582b[_0x5ead03(0x158)]}),_0x538a43['to'](_0x5ead03(0x16e)+_0x14582b[_0x5ead03(0x170)]+'-open')[_0x5ead03(0x168)](_0x5ead03(0x16e)+_0x1c5376+'-ticket',{'action':'delete','ticketId':_0x4ae812['id']});}}}}}catch(_0x516d96){console[_0x5ead03(0x169)]('e',_0x516d96);}};exports[a558_0x31ff93(0x184)]=ClosedAllOpenTickets;