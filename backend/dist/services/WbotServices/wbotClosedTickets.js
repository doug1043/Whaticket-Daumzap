const a556_0x2587d7=a556_0x37e2;(function(_0x4956ab,_0x23a6d2){const _0x1d09ae=a556_0x37e2,_0x588bc4=_0x4956ab();while(!![]){try{const _0x3e84ca=parseInt(_0x1d09ae(0xf6))/0x1*(parseInt(_0x1d09ae(0x102))/0x2)+parseInt(_0x1d09ae(0x10e))/0x3+parseInt(_0x1d09ae(0x112))/0x4*(-parseInt(_0x1d09ae(0x123))/0x5)+-parseInt(_0x1d09ae(0x11b))/0x6+-parseInt(_0x1d09ae(0xf7))/0x7*(parseInt(_0x1d09ae(0x119))/0x8)+parseInt(_0x1d09ae(0x127))/0x9+parseInt(_0x1d09ae(0x107))/0xa;if(_0x3e84ca===_0x23a6d2)break;else _0x588bc4['push'](_0x588bc4['shift']());}catch(_0x20246b){_0x588bc4['push'](_0x588bc4['shift']());}}}(a556_0x44d8,0xed5e5));const a556_0x538579=(function(){let _0x1d3700=!![];return function(_0x3d0dd8,_0x1d3aad){const _0x1968fd=_0x1d3700?function(){const _0x99f3df=a556_0x37e2;if(_0x1d3aad){const _0x164d47=_0x1d3aad[_0x99f3df(0x113)](_0x3d0dd8,arguments);return _0x1d3aad=null,_0x164d47;}}:function(){};return _0x1d3700=![],_0x1968fd;};}()),a556_0xab2e6e=a556_0x538579(this,function(){const _0x4b0c65=a556_0x37e2;return a556_0xab2e6e['toString']()[_0x4b0c65(0x115)]('(((.+)+)+)+$')[_0x4b0c65(0x10a)]()[_0x4b0c65(0x126)](a556_0xab2e6e)[_0x4b0c65(0x115)](_0x4b0c65(0x11d));});a556_0xab2e6e();'use strict';var __importDefault=this&&this[a556_0x2587d7(0x10d)]||function(_0x130cdd){const _0x321bae=a556_0x2587d7;return _0x130cdd&&_0x130cdd[_0x321bae(0x121)]?_0x130cdd:{'default':_0x130cdd};};Object[a556_0x2587d7(0x108)](exports,a556_0x2587d7(0x121),{'value':!![]}),exports['ClosedAllOpenTickets']=void 0x0;function a556_0x37e2(_0x405480,_0x860ee9){const _0x452127=a556_0x44d8();return a556_0x37e2=function(_0xab2e6e,_0x538579){_0xab2e6e=_0xab2e6e-0xf3;let _0x44d822=_0x452127[_0xab2e6e];return _0x44d822;},a556_0x37e2(_0x405480,_0x860ee9);}function a556_0x44d8(){const _0x135112=['8816570TqNane','defineProperty','companyId','toString','default','getIO','__importDefault','4104216aGxnwI','findOne','isGroup','closed','383688kTYPzY','apply','company-','search','string','findByPk','contact','8TQtMzZ','SendPresenceStatus','9073878AsvMkq','moment','(((.+)+)+)+$','getWbot','findAndCountAll','fromMe','__esModule','log','95IKILrW','../TicketServices/ShowTicketService','emit','constructor','12458520FOYaQh','../../libs/wbot','./wbotMessageListener','verifyMessage','update','14lFLyCL','3671241CIDYfg','../../models/TicketTraking','trace','toDate','whatsappId','nps','../../helpers/SendPresenceStatus','../../helpers/Mustache','open','body\x20is\x20not\x20a\x20string','getMinutes','171078hoFxdM','./SendWhatsAppMessage','status','setMinutes','updatedAt'];a556_0x44d8=function(){return _0x135112;};return a556_0x44d8();}const sequelize_1=require('sequelize'),Ticket_1=__importDefault(require('../../models/Ticket')),Whatsapp_1=__importDefault(require('../../models/Whatsapp')),socket_1=require('../../libs/socket'),Mustache_1=__importDefault(require(a556_0x2587d7(0xfe))),SendWhatsAppMessage_1=__importDefault(require(a556_0x2587d7(0x103))),moment_1=__importDefault(require(a556_0x2587d7(0x11c))),ShowTicketService_1=__importDefault(require(a556_0x2587d7(0x124))),wbotMessageListener_1=require(a556_0x2587d7(0xf3)),TicketTraking_1=__importDefault(require(a556_0x2587d7(0xf8))),SendPresenceStatus_1=require(a556_0x2587d7(0xfd)),wbot_1=require(a556_0x2587d7(0x128)),ClosedAllOpenTickets=async _0x554395=>{const _0x2465f9=a556_0x2587d7,_0x4ce5da=async(_0x4b9476,_0x2229c3,_0x528da0)=>{const _0x10e9bc=a556_0x37e2;if(_0x2229c3===_0x10e9bc(0xfc))typeof _0x528da0!=_0x10e9bc(0x116)&&console[_0x10e9bc(0xf9)](_0x10e9bc(0x100),_0x528da0),await _0x4b9476['update']({'status':'closed','lastMessage':_0x528da0,'unreadMessages':0x0,'amountUseBotQueues':0x0});else _0x2229c3===_0x10e9bc(0xff)?(typeof _0x528da0!=_0x10e9bc(0x116)&&console[_0x10e9bc(0xf9)](_0x10e9bc(0x100),_0x528da0),await _0x4b9476[_0x10e9bc(0xf5)]({'status':_0x10e9bc(0x111),'lastMessage':_0x528da0,'unreadMessages':0x0,'amountUseBotQueues':0x0})):await _0x4b9476[_0x10e9bc(0xf5)]({'status':_0x10e9bc(0x111),'unreadMessages':0x0});},_0x2a08f8=(0x0,socket_1[_0x2465f9(0x10c)])();try{const {rows:_0x205e59}=await Ticket_1['default'][_0x2465f9(0x11f)]({'where':{'status':{[sequelize_1['Op']['in']]:[_0x2465f9(0xff)]},'companyId':_0x554395},'order':[[_0x2465f9(0x106),'DESC']]});for(const _0xda2265 of _0x205e59){const _0x5da125=await(0x0,ShowTicketService_1[_0x2465f9(0x10b)])(_0xda2265['id'],_0x554395),_0x1d515b=await Whatsapp_1['default'][_0x2465f9(0x117)](_0x5da125?.[_0x2465f9(0xfb)]);if(!_0x1d515b)continue;const _0x1297d7=await TicketTraking_1[_0x2465f9(0x10b)][_0x2465f9(0x10f)]({'where':{'ticketId':_0xda2265['id'],'finishedAt':null}});let {expiresInactiveMessage:_0x50e2ad,expiresTicket:_0x119d7c}=_0x1d515b;if(_0x119d7c&&_0x119d7c!==''&&_0x119d7c!=='0'&&Number(_0x119d7c)>0x0){const _0x384184=(0x0,Mustache_1[_0x2465f9(0x10b)])('‎\x20'+_0x50e2ad,_0x5da125),_0x3131a9=new Date();_0x3131a9[_0x2465f9(0x105)](_0x3131a9[_0x2465f9(0x101)]()-Number(_0x119d7c));if(_0x5da125['status']===_0x2465f9(0xff)&&!_0x5da125[_0x2465f9(0x110)]){const _0x1572b0=new Date(_0x5da125[_0x2465f9(0x106)]);if(_0x1572b0<_0x3131a9&&_0x5da125[_0x2465f9(0x120)]){await _0x4ce5da(_0x5da125,_0x5da125[_0x2465f9(0x104)],_0x384184);if(_0x50e2ad!==''&&_0x50e2ad!==undefined){await(0x0,SendPresenceStatus_1[_0x2465f9(0x11a)])((0x0,wbot_1[_0x2465f9(0x11e)])(_0xda2265[_0x2465f9(0xfb)]),_0xda2265[_0x2465f9(0x118)]['number']+'@'+(_0xda2265[_0x2465f9(0x110)]?'g.us':'s.whatsapp.net'));const _0x5398a1=await(0x0,SendWhatsAppMessage_1[_0x2465f9(0x10b)])({'body':_0x384184,'ticket':_0x5da125});await(0x0,wbotMessageListener_1[_0x2465f9(0xf4)])(_0x5398a1,_0x5da125,_0x5da125['contact']);}await _0x1297d7['update']({'finishedAt':(0x0,moment_1['default'])()[_0x2465f9(0xfa)](),'closedAt':(0x0,moment_1[_0x2465f9(0x10b)])()[_0x2465f9(0xfa)](),'whatsappId':_0xda2265[_0x2465f9(0xfb)],'userId':_0xda2265['userId']}),_0x2a08f8['to']('company-'+_0xda2265[_0x2465f9(0x109)]+'-open')[_0x2465f9(0x125)](_0x2465f9(0x114)+_0x554395+'-ticket',{'action':'delete','ticketId':_0x5da125['id']});}}}}}catch(_0x69fe99){console[_0x2465f9(0x122)]('e',_0x69fe99);}};exports['ClosedAllOpenTickets']=ClosedAllOpenTickets;