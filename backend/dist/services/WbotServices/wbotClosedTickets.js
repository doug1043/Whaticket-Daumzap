const a559_0x24e732=a559_0x49b5;function a559_0x49b5(_0x4d76df,_0x3e8285){const _0x316aa5=a559_0x5995();return a559_0x49b5=function(_0x48cb93,_0xf1547){_0x48cb93=_0x48cb93-0x166;let _0x5995e3=_0x316aa5[_0x48cb93];return _0x5995e3;},a559_0x49b5(_0x4d76df,_0x3e8285);}(function(_0x5341f9,_0x50ddbc){const _0x3223bd=a559_0x49b5,_0x2cdb6f=_0x5341f9();while(!![]){try{const _0x3d6b61=parseInt(_0x3223bd(0x199))/0x1*(parseInt(_0x3223bd(0x173))/0x2)+parseInt(_0x3223bd(0x189))/0x3*(-parseInt(_0x3223bd(0x18a))/0x4)+-parseInt(_0x3223bd(0x193))/0x5*(-parseInt(_0x3223bd(0x16c))/0x6)+-parseInt(_0x3223bd(0x16d))/0x7*(-parseInt(_0x3223bd(0x198))/0x8)+parseInt(_0x3223bd(0x194))/0x9+parseInt(_0x3223bd(0x18c))/0xa+-parseInt(_0x3223bd(0x172))/0xb;if(_0x3d6b61===_0x50ddbc)break;else _0x2cdb6f['push'](_0x2cdb6f['shift']());}catch(_0x2a84d3){_0x2cdb6f['push'](_0x2cdb6f['shift']());}}}(a559_0x5995,0xbd9f3));function a559_0x5995(){const _0x5e91ea=['ClosedAllOpenTickets','log','contact','s.whatsapp.net','moment','setMinutes','__importDefault','getWbot','(((.+)+)+)+$','./SendWhatsAppMessage','../../helpers/SendPresenceStatus','__esModule','status','../../models/Ticket','getMinutes','sequelize','43899qnndNe','68KPTvwf','findAndCountAll','141980TJpoWM','emit','findOne','isGroup','search','getIO','../../helpers/Mustache','2733495wZuqJO','10602342ePQEMa','closed','updatedAt','trace','8habOUQ','306977QLOcdv','string','toString','open','apply','defineProperty','../../models/Whatsapp','company-','userId','-open','toDate','SendPresenceStatus','12aTWaPp','9111935BlkAmX','../../libs/socket','delete','companyId','update','31557504GWINEp','2vDCNwb','../../models/TicketTraking','default','-ticket','whatsappId','fromMe'];a559_0x5995=function(){return _0x5e91ea;};return a559_0x5995();}const a559_0xf1547=(function(){let _0x61b414=!![];return function(_0x3b4a20,_0x4d292d){const _0x368614=_0x61b414?function(){const _0x41aca5=a559_0x49b5;if(_0x4d292d){const _0x5a58f5=_0x4d292d[_0x41aca5(0x19d)](_0x3b4a20,arguments);return _0x4d292d=null,_0x5a58f5;}}:function(){};return _0x61b414=![],_0x368614;};}()),a559_0x48cb93=a559_0xf1547(this,function(){const _0x137a1a=a559_0x49b5;return a559_0x48cb93[_0x137a1a(0x19b)]()[_0x137a1a(0x190)](_0x137a1a(0x181))[_0x137a1a(0x19b)]()['constructor'](a559_0x48cb93)[_0x137a1a(0x190)]('(((.+)+)+)+$');});a559_0x48cb93();'use strict';var __importDefault=this&&this[a559_0x24e732(0x17f)]||function(_0x23d6bf){return _0x23d6bf&&_0x23d6bf['__esModule']?_0x23d6bf:{'default':_0x23d6bf};};Object[a559_0x24e732(0x19e)](exports,a559_0x24e732(0x184),{'value':!![]}),exports[a559_0x24e732(0x179)]=void 0x0;const sequelize_1=require(a559_0x24e732(0x188)),Ticket_1=__importDefault(require(a559_0x24e732(0x186))),Whatsapp_1=__importDefault(require(a559_0x24e732(0x166))),socket_1=require(a559_0x24e732(0x16e)),Mustache_1=__importDefault(require(a559_0x24e732(0x192))),SendWhatsAppMessage_1=__importDefault(require(a559_0x24e732(0x182))),moment_1=__importDefault(require(a559_0x24e732(0x17d))),ShowTicketService_1=__importDefault(require('../TicketServices/ShowTicketService')),wbotMessageListener_1=require('./wbotMessageListener'),TicketTraking_1=__importDefault(require(a559_0x24e732(0x174))),SendPresenceStatus_1=require(a559_0x24e732(0x183)),wbot_1=require('../../libs/wbot'),ClosedAllOpenTickets=async _0x4723d2=>{const _0x4c249e=a559_0x24e732,_0x6f2b18=async(_0x57a396,_0x2a3fd5,_0x45d4a1)=>{const _0x3069d5=a559_0x49b5;if(_0x2a3fd5==='nps')typeof _0x45d4a1!=_0x3069d5(0x19a)&&console[_0x3069d5(0x197)]('body\x20is\x20not\x20a\x20string',_0x45d4a1),await _0x57a396[_0x3069d5(0x171)]({'status':_0x3069d5(0x195),'lastMessage':_0x45d4a1,'unreadMessages':0x0,'amountUseBotQueues':0x0});else _0x2a3fd5===_0x3069d5(0x19c)?(typeof _0x45d4a1!=_0x3069d5(0x19a)&&console[_0x3069d5(0x197)]('body\x20is\x20not\x20a\x20string',_0x45d4a1),await _0x57a396[_0x3069d5(0x171)]({'status':_0x3069d5(0x195),'lastMessage':_0x45d4a1,'unreadMessages':0x0,'amountUseBotQueues':0x0})):await _0x57a396[_0x3069d5(0x171)]({'status':_0x3069d5(0x195),'unreadMessages':0x0});},_0x9a7b00=(0x0,socket_1[_0x4c249e(0x191)])();try{const {rows:_0x22977a}=await Ticket_1[_0x4c249e(0x175)][_0x4c249e(0x18b)]({'where':{'status':{[sequelize_1['Op']['in']]:[_0x4c249e(0x19c)]},'companyId':_0x4723d2},'order':[[_0x4c249e(0x196),'DESC']]});for(const _0x57fd3a of _0x22977a){const _0x26b62e=await(0x0,ShowTicketService_1[_0x4c249e(0x175)])(_0x57fd3a['id'],_0x4723d2),_0x5306f3=await Whatsapp_1['default']['findByPk'](_0x26b62e?.[_0x4c249e(0x177)]);if(!_0x5306f3)continue;const _0x45ff95=await TicketTraking_1[_0x4c249e(0x175)][_0x4c249e(0x18e)]({'where':{'ticketId':_0x57fd3a['id'],'finishedAt':null}});let {expiresInactiveMessage:_0x24a52c,expiresTicket:_0x459813}=_0x5306f3;if(_0x459813&&_0x459813!==''&&_0x459813!=='0'&&Number(_0x459813)>0x0){const _0x453239=(0x0,Mustache_1[_0x4c249e(0x175)])('â€Ž\x20'+_0x24a52c,_0x26b62e),_0x4f99ce=new Date();_0x4f99ce[_0x4c249e(0x17e)](_0x4f99ce[_0x4c249e(0x187)]()-Number(_0x459813));if(_0x26b62e[_0x4c249e(0x185)]===_0x4c249e(0x19c)&&!_0x26b62e['isGroup']){const _0x1bcaa3=new Date(_0x26b62e['updatedAt']);if(_0x1bcaa3<_0x4f99ce&&_0x26b62e[_0x4c249e(0x178)]){await _0x6f2b18(_0x26b62e,_0x26b62e[_0x4c249e(0x185)],_0x453239);if(_0x24a52c!==''&&_0x24a52c!==undefined){await(0x0,SendPresenceStatus_1[_0x4c249e(0x16b)])((0x0,wbot_1[_0x4c249e(0x180)])(_0x57fd3a[_0x4c249e(0x177)]),_0x57fd3a[_0x4c249e(0x17b)]['number']+'@'+(_0x57fd3a[_0x4c249e(0x18f)]?'g.us':_0x4c249e(0x17c)));const _0xcfb46=await(0x0,SendWhatsAppMessage_1[_0x4c249e(0x175)])({'body':_0x453239,'ticket':_0x26b62e});await(0x0,wbotMessageListener_1['verifyMessage'])(_0xcfb46,_0x26b62e,_0x26b62e[_0x4c249e(0x17b)]);}await _0x45ff95[_0x4c249e(0x171)]({'finishedAt':(0x0,moment_1[_0x4c249e(0x175)])()['toDate'](),'closedAt':(0x0,moment_1[_0x4c249e(0x175)])()[_0x4c249e(0x16a)](),'whatsappId':_0x57fd3a['whatsappId'],'userId':_0x57fd3a[_0x4c249e(0x168)]}),_0x9a7b00['to'](_0x4c249e(0x167)+_0x57fd3a[_0x4c249e(0x170)]+_0x4c249e(0x169))[_0x4c249e(0x18d)]('company-'+_0x4723d2+_0x4c249e(0x176),{'action':_0x4c249e(0x16f),'ticketId':_0x26b62e['id']});}}}}}catch(_0x2fb4eb){console[_0x4c249e(0x17a)]('e',_0x2fb4eb);}};exports[a559_0x24e732(0x179)]=ClosedAllOpenTickets;