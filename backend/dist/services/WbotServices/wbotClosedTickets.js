const a558_0x1811d7=a558_0x2423;function a558_0x3ad0(){const _0x44bc03=['verifyMessage','ClosedAllOpenTickets','company-','3035223yumKTa','9420080zmsBCG','../../helpers/SendPresenceStatus','7026YGbafA','__importDefault','string','search','3677359yOpBXm','trace','default','updatedAt','SendPresenceStatus','status','(((.+)+)+)+$','isGroup','./wbotMessageListener','closed','__esModule','findAndCountAll','findByPk','../../models/Whatsapp','constructor','userId','open','contact','toString','s.whatsapp.net','../../helpers/Mustache','1217038ubiEEZ','3DuCpKj','2545yUtdMD','moment','companyId','findOne','-ticket','body\x20is\x20not\x20a\x20string','../TicketServices/ShowTicketService','DESC','nps','toDate','getWbot','-open','5128908AXFhAc','../../models/Ticket','fromMe','emit','log','getIO','1782944OPogjr','update','g.us','../../libs/wbot','defineProperty','whatsappId'];a558_0x3ad0=function(){return _0x44bc03;};return a558_0x3ad0();}(function(_0x67e501,_0x227ea0){const _0xb21eab=a558_0x2423,_0x37d8d6=_0x67e501();while(!![]){try{const _0x2bcfba=parseInt(_0xb21eab(0x1f9))/0x1+-parseInt(_0xb21eab(0x1d4))/0x2+-parseInt(_0xb21eab(0x1fa))/0x3*(-parseInt(_0xb21eab(0x207))/0x4)+-parseInt(_0xb21eab(0x1fb))/0x5*(parseInt(_0xb21eab(0x1e0))/0x6)+parseInt(_0xb21eab(0x1e4))/0x7+-parseInt(_0xb21eab(0x1de))/0x8+parseInt(_0xb21eab(0x1dd))/0x9;if(_0x2bcfba===_0x227ea0)break;else _0x37d8d6['push'](_0x37d8d6['shift']());}catch(_0x513cc2){_0x37d8d6['push'](_0x37d8d6['shift']());}}}(a558_0x3ad0,0xaa1fc));const a558_0x4ce0d4=(function(){let _0x1b32ad=!![];return function(_0x29f501,_0xa75320){const _0x41abd4=_0x1b32ad?function(){if(_0xa75320){const _0x21db17=_0xa75320['apply'](_0x29f501,arguments);return _0xa75320=null,_0x21db17;}}:function(){};return _0x1b32ad=![],_0x41abd4;};}()),a558_0x1d4cfc=a558_0x4ce0d4(this,function(){const _0x41e979=a558_0x2423;return a558_0x1d4cfc[_0x41e979(0x1f6)]()['search'](_0x41e979(0x1ea))['toString']()[_0x41e979(0x1f2)](a558_0x1d4cfc)[_0x41e979(0x1e3)](_0x41e979(0x1ea));});a558_0x1d4cfc();function a558_0x2423(_0x558297,_0x33e94a){const _0x434e64=a558_0x3ad0();return a558_0x2423=function(_0x1d4cfc,_0x4ce0d4){_0x1d4cfc=_0x1d4cfc-0x1d2;let _0x3ad088=_0x434e64[_0x1d4cfc];return _0x3ad088;},a558_0x2423(_0x558297,_0x33e94a);}'use strict';var __importDefault=this&&this[a558_0x1811d7(0x1e1)]||function(_0x498a16){const _0x5130d7=a558_0x1811d7;return _0x498a16&&_0x498a16[_0x5130d7(0x1ee)]?_0x498a16:{'default':_0x498a16};};Object[a558_0x1811d7(0x1d8)](exports,a558_0x1811d7(0x1ee),{'value':!![]}),exports[a558_0x1811d7(0x1db)]=void 0x0;const sequelize_1=require('sequelize'),Ticket_1=__importDefault(require(a558_0x1811d7(0x208))),Whatsapp_1=__importDefault(require(a558_0x1811d7(0x1f1))),socket_1=require('../../libs/socket'),Mustache_1=__importDefault(require(a558_0x1811d7(0x1f8))),SendWhatsAppMessage_1=__importDefault(require('./SendWhatsAppMessage')),moment_1=__importDefault(require(a558_0x1811d7(0x1fc))),ShowTicketService_1=__importDefault(require(a558_0x1811d7(0x201))),wbotMessageListener_1=require(a558_0x1811d7(0x1ec)),TicketTraking_1=__importDefault(require('../../models/TicketTraking')),SendPresenceStatus_1=require(a558_0x1811d7(0x1df)),wbot_1=require(a558_0x1811d7(0x1d7)),ClosedAllOpenTickets=async _0x54277e=>{const _0x118220=a558_0x1811d7,_0x3ed4ea=async(_0x16d67e,_0x306b23,_0x2b9808)=>{const _0x7dbe4e=a558_0x2423;if(_0x306b23===_0x7dbe4e(0x203))typeof _0x2b9808!=_0x7dbe4e(0x1e2)&&console[_0x7dbe4e(0x1e5)](_0x7dbe4e(0x200),_0x2b9808),await _0x16d67e[_0x7dbe4e(0x1d5)]({'status':_0x7dbe4e(0x1ed),'lastMessage':_0x2b9808,'unreadMessages':0x0,'amountUseBotQueues':0x0});else _0x306b23===_0x7dbe4e(0x1f4)?(typeof _0x2b9808!=_0x7dbe4e(0x1e2)&&console['trace'](_0x7dbe4e(0x200),_0x2b9808),await _0x16d67e['update']({'status':'closed','lastMessage':_0x2b9808,'unreadMessages':0x0,'amountUseBotQueues':0x0})):await _0x16d67e[_0x7dbe4e(0x1d5)]({'status':_0x7dbe4e(0x1ed),'unreadMessages':0x0});},_0x345828=(0x0,socket_1[_0x118220(0x1d3)])();try{const {rows:_0x513fc2}=await Ticket_1[_0x118220(0x1e6)][_0x118220(0x1ef)]({'where':{'status':{[sequelize_1['Op']['in']]:[_0x118220(0x1f4)]},'companyId':_0x54277e},'order':[['updatedAt',_0x118220(0x202)]]});for(const _0x33530a of _0x513fc2){const _0xa8e4bd=await(0x0,ShowTicketService_1['default'])(_0x33530a['id'],_0x54277e),_0x2b2e93=await Whatsapp_1[_0x118220(0x1e6)][_0x118220(0x1f0)](_0xa8e4bd?.[_0x118220(0x1d9)]);if(!_0x2b2e93)continue;const _0x428725=await TicketTraking_1['default'][_0x118220(0x1fe)]({'where':{'ticketId':_0x33530a['id'],'finishedAt':null}});let {expiresInactiveMessage:_0x1edba9,expiresTicket:_0x463fb0}=_0x2b2e93;if(_0x463fb0&&_0x463fb0!==''&&_0x463fb0!=='0'&&Number(_0x463fb0)>0x0){const _0x126c48=(0x0,Mustache_1[_0x118220(0x1e6)])('â€Ž\x20'+_0x1edba9,_0xa8e4bd),_0x5c5c39=new Date();_0x5c5c39['setMinutes'](_0x5c5c39['getMinutes']()-Number(_0x463fb0));if(_0xa8e4bd[_0x118220(0x1e9)]===_0x118220(0x1f4)&&!_0xa8e4bd[_0x118220(0x1eb)]){const _0x34f740=new Date(_0xa8e4bd[_0x118220(0x1e7)]);if(_0x34f740<_0x5c5c39&&_0xa8e4bd[_0x118220(0x209)]){await _0x3ed4ea(_0xa8e4bd,_0xa8e4bd['status'],_0x126c48);if(_0x1edba9!==''&&_0x1edba9!==undefined){await(0x0,SendPresenceStatus_1[_0x118220(0x1e8)])((0x0,wbot_1[_0x118220(0x205)])(_0x33530a[_0x118220(0x1d9)]),_0x33530a[_0x118220(0x1f5)]['number']+'@'+(_0x33530a['isGroup']?_0x118220(0x1d6):_0x118220(0x1f7)));const _0x561364=await(0x0,SendWhatsAppMessage_1[_0x118220(0x1e6)])({'body':_0x126c48,'ticket':_0xa8e4bd});await(0x0,wbotMessageListener_1[_0x118220(0x1da)])(_0x561364,_0xa8e4bd,_0xa8e4bd[_0x118220(0x1f5)]);}await _0x428725[_0x118220(0x1d5)]({'finishedAt':(0x0,moment_1['default'])()['toDate'](),'closedAt':(0x0,moment_1[_0x118220(0x1e6)])()[_0x118220(0x204)](),'whatsappId':_0x33530a[_0x118220(0x1d9)],'userId':_0x33530a[_0x118220(0x1f3)]}),_0x345828['to']('company-'+_0x33530a[_0x118220(0x1fd)]+_0x118220(0x206))[_0x118220(0x20a)](_0x118220(0x1dc)+_0x54277e+_0x118220(0x1ff),{'action':'delete','ticketId':_0xa8e4bd['id']});}}}}}catch(_0x1bc11a){console[_0x118220(0x1d2)]('e',_0x1bc11a);}};exports[a558_0x1811d7(0x1db)]=ClosedAllOpenTickets;