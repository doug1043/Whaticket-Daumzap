const a556_0x177c42=a556_0x4f81;(function(_0x3a0a66,_0x2b8b5e){const _0x323cdc=a556_0x4f81,_0x247d29=_0x3a0a66();while(!![]){try{const _0x52e74e=parseInt(_0x323cdc(0x16f))/0x1+-parseInt(_0x323cdc(0x181))/0x2*(-parseInt(_0x323cdc(0x175))/0x3)+-parseInt(_0x323cdc(0x194))/0x4*(parseInt(_0x323cdc(0x191))/0x5)+parseInt(_0x323cdc(0x16c))/0x6+-parseInt(_0x323cdc(0x17a))/0x7*(parseInt(_0x323cdc(0x197))/0x8)+-parseInt(_0x323cdc(0x173))/0x9+-parseInt(_0x323cdc(0x180))/0xa*(-parseInt(_0x323cdc(0x18d))/0xb);if(_0x52e74e===_0x2b8b5e)break;else _0x247d29['push'](_0x247d29['shift']());}catch(_0x584e90){_0x247d29['push'](_0x247d29['shift']());}}}(a556_0x409d,0x20b79));const a556_0x3800a1=(function(){let _0x5267ec=!![];return function(_0x1f5bea,_0x2afc80){const _0x4fe9bc=_0x5267ec?function(){const _0x4a1ec9=a556_0x4f81;if(_0x2afc80){const _0x32fff5=_0x2afc80[_0x4a1ec9(0x188)](_0x1f5bea,arguments);return _0x2afc80=null,_0x32fff5;}}:function(){};return _0x5267ec=![],_0x4fe9bc;};}()),a556_0x4df0fc=a556_0x3800a1(this,function(){const _0x20ba8e=a556_0x4f81;return a556_0x4df0fc['toString']()['search'](_0x20ba8e(0x195))[_0x20ba8e(0x19e)]()[_0x20ba8e(0x18e)](a556_0x4df0fc)[_0x20ba8e(0x184)](_0x20ba8e(0x195));});function a556_0x409d(){const _0x415d2d=['DESC','body\x20is\x20not\x20a\x20string','642790eZAMbq','4HMRcXp','fromMe','moment','search','getIO','trace','number','apply','./wbotMessageListener','./SendWhatsAppMessage','company-','nps','11FsLzfz','constructor','contact','open','45KeHsaE','toDate','getMinutes','6472ezpZnY','(((.+)+)+)+$','getWbot','14744gvyCOm','defineProperty','findAndCountAll','g.us','setMinutes','whatsappId','../../helpers/SendPresenceStatus','toString','__esModule','../../models/Ticket','__importDefault','ClosedAllOpenTickets','delete','emit','359844JrtZNU','../TicketServices/ShowTicketService','status','228127PkPmWA','closed','update','updatedAt','1737945oeBcFH','userId','210633napgxK','../../models/Whatsapp','-ticket','string','s.whatsapp.net','574lNADPg','isGroup','default','../../helpers/Mustache'];a556_0x409d=function(){return _0x415d2d;};return a556_0x409d();}a556_0x4df0fc();'use strict';function a556_0x4f81(_0x3687ce,_0xd1d7c3){const _0x51b656=a556_0x409d();return a556_0x4f81=function(_0x4df0fc,_0x3800a1){_0x4df0fc=_0x4df0fc-0x166;let _0x409df6=_0x51b656[_0x4df0fc];return _0x409df6;},a556_0x4f81(_0x3687ce,_0xd1d7c3);}var __importDefault=this&&this[a556_0x177c42(0x168)]||function(_0xce4be5){const _0x3032be=a556_0x177c42;return _0xce4be5&&_0xce4be5[_0x3032be(0x166)]?_0xce4be5:{'default':_0xce4be5};};Object[a556_0x177c42(0x198)](exports,a556_0x177c42(0x166),{'value':!![]}),exports[a556_0x177c42(0x169)]=void 0x0;const sequelize_1=require('sequelize'),Ticket_1=__importDefault(require(a556_0x177c42(0x167))),Whatsapp_1=__importDefault(require(a556_0x177c42(0x176))),socket_1=require('../../libs/socket'),Mustache_1=__importDefault(require(a556_0x177c42(0x17d))),SendWhatsAppMessage_1=__importDefault(require(a556_0x177c42(0x18a))),moment_1=__importDefault(require(a556_0x177c42(0x183))),ShowTicketService_1=__importDefault(require(a556_0x177c42(0x16d))),wbotMessageListener_1=require(a556_0x177c42(0x189)),TicketTraking_1=__importDefault(require('../../models/TicketTraking')),SendPresenceStatus_1=require(a556_0x177c42(0x19d)),wbot_1=require('../../libs/wbot'),ClosedAllOpenTickets=async _0x5ffc52=>{const _0x113889=a556_0x177c42,_0x2808d1=async(_0x5cbc0e,_0x50a2bc,_0x11bb8b)=>{const _0x3e576b=a556_0x4f81;if(_0x50a2bc===_0x3e576b(0x18c))typeof _0x11bb8b!='string'&&console[_0x3e576b(0x186)](_0x3e576b(0x17f),_0x11bb8b),await _0x5cbc0e[_0x3e576b(0x171)]({'status':_0x3e576b(0x170),'lastMessage':_0x11bb8b,'unreadMessages':0x0,'amountUseBotQueues':0x0});else _0x50a2bc===_0x3e576b(0x190)?(typeof _0x11bb8b!=_0x3e576b(0x178)&&console['trace'](_0x3e576b(0x17f),_0x11bb8b),await _0x5cbc0e[_0x3e576b(0x171)]({'status':_0x3e576b(0x170),'lastMessage':_0x11bb8b,'unreadMessages':0x0,'amountUseBotQueues':0x0})):await _0x5cbc0e['update']({'status':_0x3e576b(0x170),'unreadMessages':0x0});},_0x4659fe=(0x0,socket_1[_0x113889(0x185)])();try{const {rows:_0x447f61}=await Ticket_1[_0x113889(0x17c)][_0x113889(0x199)]({'where':{'status':{[sequelize_1['Op']['in']]:[_0x113889(0x190)]},'companyId':_0x5ffc52},'order':[[_0x113889(0x172),_0x113889(0x17e)]]});for(const _0x2d34fc of _0x447f61){const _0x2f4b61=await(0x0,ShowTicketService_1[_0x113889(0x17c)])(_0x2d34fc['id'],_0x5ffc52),_0xae86cf=await Whatsapp_1[_0x113889(0x17c)]['findByPk'](_0x2f4b61?.[_0x113889(0x19c)]);if(!_0xae86cf)continue;const _0x53bdda=await TicketTraking_1[_0x113889(0x17c)]['findOne']({'where':{'ticketId':_0x2d34fc['id'],'finishedAt':null}});let {expiresInactiveMessage:_0x1a81cf,expiresTicket:_0x19c2da}=_0xae86cf;if(_0x19c2da&&_0x19c2da!==''&&_0x19c2da!=='0'&&Number(_0x19c2da)>0x0){const _0xa26219=(0x0,Mustache_1[_0x113889(0x17c)])('â€\x20'+_0x1a81cf,_0x2f4b61),_0x1a8ad5=new Date();_0x1a8ad5[_0x113889(0x19b)](_0x1a8ad5[_0x113889(0x193)]()-Number(_0x19c2da));if(_0x2f4b61['status']==='open'&&!_0x2f4b61[_0x113889(0x17b)]){const _0x3eea0a=new Date(_0x2f4b61[_0x113889(0x172)]);if(_0x3eea0a<_0x1a8ad5&&_0x2f4b61[_0x113889(0x182)]){await _0x2808d1(_0x2f4b61,_0x2f4b61[_0x113889(0x16e)],_0xa26219);if(_0x1a81cf!==''&&_0x1a81cf!==undefined){await(0x0,SendPresenceStatus_1['SendPresenceStatus'])((0x0,wbot_1[_0x113889(0x196)])(_0x2d34fc[_0x113889(0x19c)]),_0x2d34fc[_0x113889(0x18f)][_0x113889(0x187)]+'@'+(_0x2d34fc['isGroup']?_0x113889(0x19a):_0x113889(0x179)));const _0x2ebd01=await(0x0,SendWhatsAppMessage_1[_0x113889(0x17c)])({'body':_0xa26219,'ticket':_0x2f4b61});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x2ebd01,_0x2f4b61,_0x2f4b61[_0x113889(0x18f)]);}await _0x53bdda['update']({'finishedAt':(0x0,moment_1['default'])()['toDate'](),'closedAt':(0x0,moment_1['default'])()[_0x113889(0x192)](),'whatsappId':_0x2d34fc[_0x113889(0x19c)],'userId':_0x2d34fc[_0x113889(0x174)]}),_0x4659fe['to']('company-'+_0x2d34fc['companyId']+'-open')[_0x113889(0x16b)](_0x113889(0x18b)+_0x5ffc52+_0x113889(0x177),{'action':_0x113889(0x16a),'ticketId':_0x2f4b61['id']});}}}}}catch(_0x30a8ad){console['log']('e',_0x30a8ad);}};exports[a556_0x177c42(0x169)]=ClosedAllOpenTickets;