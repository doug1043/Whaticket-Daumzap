const a559_0x1e7ddb=a559_0x5dfb;(function(_0x23a028,_0x160614){const _0x594603=a559_0x5dfb,_0xbf542=_0x23a028();while(!![]){try{const _0x3a4b23=-parseInt(_0x594603(0x1bb))/0x1*(parseInt(_0x594603(0x28a))/0x2)+-parseInt(_0x594603(0x17a))/0x3*(-parseInt(_0x594603(0x147))/0x4)+parseInt(_0x594603(0x179))/0x5+parseInt(_0x594603(0x1f1))/0x6*(-parseInt(_0x594603(0x190))/0x7)+-parseInt(_0x594603(0x1e7))/0x8+parseInt(_0x594603(0x1ea))/0x9*(-parseInt(_0x594603(0x257))/0xa)+parseInt(_0x594603(0x23b))/0xb;if(_0x3a4b23===_0x160614)break;else _0xbf542['push'](_0xbf542['shift']());}catch(_0xfe73b8){_0xbf542['push'](_0xbf542['shift']());}}}(a559_0x48e3,0x98a5a));const a559_0xcc47a1=(function(){let _0x4b22fe=!![];return function(_0x2b6d18,_0x1d5513){const _0x3035c4=_0x4b22fe?function(){const _0x139dc9=a559_0x5dfb;if(_0x1d5513){const _0x4c66e2=_0x1d5513[_0x139dc9(0x1d0)](_0x2b6d18,arguments);return _0x1d5513=null,_0x4c66e2;}}:function(){};return _0x4b22fe=![],_0x3035c4;};}()),a559_0x409851=a559_0xcc47a1(this,function(){const _0x793947=a559_0x5dfb;return a559_0x409851['toString']()[_0x793947(0x1db)](_0x793947(0x260))['toString']()[_0x793947(0x294)](a559_0x409851)['search'](_0x793947(0x260));});a559_0x409851();'use strict';var __createBinding=this&&this[a559_0x1e7ddb(0x2a1)]||(Object['create']?function(_0x4ecdd8,_0xc4191,_0x405905,_0x555824){const _0x11a45b=a559_0x1e7ddb;if(_0x555824===undefined)_0x555824=_0x405905;var _0x4492b7=Object['getOwnPropertyDescriptor'](_0xc4191,_0x405905);(!_0x4492b7||(_0x11a45b(0xf3)in _0x4492b7?!_0xc4191[_0x11a45b(0x103)]:_0x4492b7[_0x11a45b(0x284)]||_0x4492b7[_0x11a45b(0x27a)]))&&(_0x4492b7={'enumerable':!![],'get':function(){return _0xc4191[_0x405905];}}),Object[_0x11a45b(0x10e)](_0x4ecdd8,_0x555824,_0x4492b7);}:function(_0xe8f6a3,_0x5472af,_0x251676,_0x42a6e6){if(_0x42a6e6===undefined)_0x42a6e6=_0x251676;_0xe8f6a3[_0x42a6e6]=_0x5472af[_0x251676];}),__setModuleDefault=this&&this[a559_0x1e7ddb(0x270)]||(Object[a559_0x1e7ddb(0x11e)]?function(_0x34843a,_0x3d4cd0){const _0x595904=a559_0x1e7ddb;Object[_0x595904(0x10e)](_0x34843a,_0x595904(0x237),{'enumerable':!![],'value':_0x3d4cd0});}:function(_0x19afc6,_0x2e8450){_0x19afc6['default']=_0x2e8450;}),__importStar=this&&this[a559_0x1e7ddb(0x1a9)]||function(_0x59b7a1){const _0x1443d6=a559_0x1e7ddb;if(_0x59b7a1&&_0x59b7a1[_0x1443d6(0x103)])return _0x59b7a1;var _0xa18fb0={};if(_0x59b7a1!=null){for(var _0x53aaa9 in _0x59b7a1)if(_0x53aaa9!=='default'&&Object[_0x1443d6(0x228)][_0x1443d6(0x1ac)][_0x1443d6(0x139)](_0x59b7a1,_0x53aaa9))__createBinding(_0xa18fb0,_0x59b7a1,_0x53aaa9);}return __setModuleDefault(_0xa18fb0,_0x59b7a1),_0xa18fb0;},__importDefault=this&&this[a559_0x1e7ddb(0x299)]||function(_0x1f285c){return _0x1f285c&&_0x1f285c['__esModule']?_0x1f285c:{'default':_0x1f285c};};Object[a559_0x1e7ddb(0x10e)](exports,a559_0x1e7ddb(0x103),{'value':!![]}),exports['wbotMessageListener']=exports[a559_0x1e7ddb(0x25a)]=exports[a559_0x1e7ddb(0x1b5)]=exports[a559_0x1e7ddb(0x29b)]=exports['handleMessage']=exports[a559_0x1e7ddb(0x1a1)]=exports[a559_0x1e7ddb(0x25b)]=exports[a559_0x1e7ddb(0x289)]=exports[a559_0x1e7ddb(0xf8)]=exports[a559_0x1e7ddb(0x176)]=exports[a559_0x1e7ddb(0x234)]=exports[a559_0x1e7ddb(0x118)]=exports[a559_0x1e7ddb(0x25e)]=exports['getBodyMessage']=exports[a559_0x1e7ddb(0x26b)]=exports['sendMessageLink']=exports[a559_0x1e7ddb(0x232)]=exports['sleep']=exports['validaCpfCnpj']=exports[a559_0x1e7ddb(0x11b)]=exports[a559_0x1e7ddb(0x1fd)]=void 0x0;const path_1=__importStar(require(a559_0x1e7ddb(0x14c))),util_1=require(a559_0x1e7ddb(0x1bd)),fs_1=require('fs'),Sentry=__importStar(require('@sentry/node')),lodash_1=require(a559_0x1e7ddb(0xe6)),baileys_1=require(a559_0x1e7ddb(0x225)),MessageUtils=__importStar(require(a559_0x1e7ddb(0x21b))),stream_throttle_1=require(a559_0x1e7ddb(0xed)),Contact_1=__importDefault(require('../../models/Contact')),Ticket_1=__importDefault(require('../../models/Ticket')),Message_1=__importDefault(require(a559_0x1e7ddb(0x10f))),OldMessage_1=__importDefault(require('../../models/OldMessage')),socket_1=require('../../libs/socket'),CreateMessageService_1=__importDefault(require('../MessageServices/CreateMessageService')),logger_1=require(a559_0x1e7ddb(0xfb)),CreateOrUpdateContactService_1=__importDefault(require(a559_0x1e7ddb(0x1b6))),FindOrCreateTicketService_1=__importDefault(require(a559_0x1e7ddb(0x1d3))),ShowWhatsAppService_1=__importDefault(require('../WhatsappService/ShowWhatsAppService')),UpdateTicketService_1=__importDefault(require(a559_0x1e7ddb(0x1a8))),Mustache_1=__importDefault(require(a559_0x1e7ddb(0x114))),UserRating_1=__importDefault(require('../../models/UserRating')),SendWhatsAppMessage_1=__importDefault(require('./SendWhatsAppMessage')),moment_1=__importDefault(require(a559_0x1e7ddb(0x1ae))),Queue_1=__importDefault(require(a559_0x1e7ddb(0x1c2))),QueueOption_1=__importDefault(require(a559_0x1e7ddb(0x23f))),FindOrCreateATicketTrakingService_1=__importDefault(require(a559_0x1e7ddb(0x1f0))),VerifyCurrentSchedule_1=__importDefault(require(a559_0x1e7ddb(0x242))),Campaign_1=__importDefault(require(a559_0x1e7ddb(0xfc))),CampaignShipping_1=__importDefault(require(a559_0x1e7ddb(0x1a0))),sequelize_1=require(a559_0x1e7ddb(0x1c9)),queues_1=require(a559_0x1e7ddb(0x248)),User_1=__importDefault(require(a559_0x1e7ddb(0x241))),Setting_1=__importDefault(require('../../models/Setting')),cache_1=require(a559_0x1e7ddb(0xe9)),Debounce_1=require('../../helpers/Debounce'),openai_1=require('openai'),fluent_ffmpeg_1=__importDefault(require(a559_0x1e7ddb(0x17b))),microsoft_cognitiveservices_speech_sdk_1=require(a559_0x1e7ddb(0x208)),providers_1=require(a559_0x1e7ddb(0x189)),typebotListener_1=__importDefault(require('../TypebotServices/typebotListener')),ShowQueueIntegrationService_1=__importDefault(require(a559_0x1e7ddb(0x1ad))),SendWhatsAppMedia_1=require(a559_0x1e7ddb(0x194)),fs_2=__importDefault(require('fs')),request_1=__importDefault(require('request')),ffmpeg_static_1=__importDefault(require(a559_0x1e7ddb(0x236))),app_1=__importDefault(require(a559_0x1e7ddb(0x13d))),mime_1=__importDefault(require(a559_0x1e7ddb(0x18f))),wbot_1=require('../../libs/wbot'),SendPresenceStatus_1=require(a559_0x1e7ddb(0x22f)),MakeRandomId_1=require(a559_0x1e7ddb(0x29a));fluent_ffmpeg_1['default'][a559_0x1e7ddb(0x1a7)](ffmpeg_static_1[a559_0x1e7ddb(0x237)]);const sessionsOpenAi=[],isNumeric=_0x23720c=>/^-?\d+$/['test'](_0x23720c);exports[a559_0x1e7ddb(0x1fd)]=isNumeric;let outOfHourMessageControl=[],completionMessageControl=[],greetingMessageControl=[],farewellMessageControl=[];const writeFileAsync=(0x0,util_1[a559_0x1e7ddb(0x171)])(fs_1['writeFile']),getTypeMessage=_0x2cab49=>{const _0x1c7819=a559_0x1e7ddb;return(0x0,baileys_1[_0x1c7819(0x298)])(_0x2cab49[_0x1c7819(0x14e)]);},removeNonPrintableChars=_0x4dbd1a=>{return _0x4dbd1a['replace'](/[\x00-\x1F\x7F-\x9F]/g,'');};exports[a559_0x1e7ddb(0x11b)]=removeNonPrintableChars;async function getQueues(_0x18a1ca){const _0x3e265a=a559_0x1e7ddb;try{const _0x41f13b=await Queue_1[_0x3e265a(0x237)][_0x3e265a(0x2a0)]({'where':{'companyId':_0x18a1ca}});return _0x41f13b;}catch(_0xe3ec3b){return console[_0x3e265a(0x124)](_0x3e265a(0xe8),_0xe3ec3b),[];}}async function getContactFromTicket(_0xbc45c2){const _0x38943b=a559_0x1e7ddb;try{const _0x313f45=await Ticket_1['default'][_0x38943b(0x23e)](_0xbc45c2,{'include':[{'model':Contact_1[_0x38943b(0x237)],'as':_0x38943b(0x268)}]});return _0x313f45&&_0x313f45[_0x38943b(0x268)]?_0x313f45[_0x38943b(0x268)]:(console[_0x38943b(0x17c)](_0x38943b(0x1c4)),null);}catch(_0xfb603a){return console[_0x38943b(0x124)](_0x38943b(0x287),_0xfb603a),null;}}function validaCpfCnpj(_0x255ec4){const _0x4ebda6=a559_0x1e7ddb;if(_0x255ec4[_0x4ebda6(0x1fc)]==0xb){var _0x52d075=_0x255ec4[_0x4ebda6(0x16e)]();_0x52d075=_0x52d075[_0x4ebda6(0x2a5)](/\./g,''),_0x52d075=_0x52d075[_0x4ebda6(0x2a5)]('-',''),_0x52d075=_0x52d075['split']('');var _0x2e3c38=0x0,_0x6610e4=0x0,_0x454b2d=![];for(var _0x2736c6=0x1;_0x52d075[_0x4ebda6(0x1fc)]>_0x2736c6;_0x2736c6++){_0x52d075[_0x2736c6-0x1]!=_0x52d075[_0x2736c6]&&(_0x454b2d=!![]);}if(_0x454b2d==![])return![];for(var _0x2736c6=0x0,_0x3814eb=0xa;_0x52d075[_0x4ebda6(0x1fc)]-0x2>_0x2736c6;_0x2736c6++,_0x3814eb--){_0x2e3c38+=_0x52d075[_0x2736c6]*_0x3814eb;}_0x2e3c38=_0x2e3c38*0xa%0xb;_0x2e3c38==0xa&&(_0x2e3c38=0x0);if(_0x2e3c38!=_0x52d075[0x9])return![];for(var _0x2736c6=0x0,_0x3814eb=0xb;_0x52d075[_0x4ebda6(0x1fc)]-0x1>_0x2736c6;_0x2736c6++,_0x3814eb--){_0x6610e4+=_0x52d075[_0x2736c6]*_0x3814eb;}return _0x6610e4=_0x6610e4*0xa%0xb,_0x6610e4==0xa&&(_0x6610e4=0x0),_0x6610e4!=_0x52d075[0xa]?![]:!![];}else{if(_0x255ec4[_0x4ebda6(0x1fc)]==0xe){var _0x554b83=_0x255ec4[_0x4ebda6(0x16e)]();_0x554b83=_0x554b83[_0x4ebda6(0x2a5)](/\./g,''),_0x554b83=_0x554b83[_0x4ebda6(0x2a5)]('-',''),_0x554b83=_0x554b83['replace']('/',''),_0x554b83=_0x554b83['split']('');var _0x2e3c38=0x0,_0x6610e4=0x0,_0x454b2d=![];for(var _0x2736c6=0x1;_0x554b83[_0x4ebda6(0x1fc)]>_0x2736c6;_0x2736c6++){_0x554b83[_0x2736c6-0x1]!=_0x554b83[_0x2736c6]&&(_0x454b2d=!![]);}if(_0x454b2d==![])return![];for(var _0x2736c6=0x0,_0x12d2eb=0x5,_0x1a3be8=0xd;_0x554b83[_0x4ebda6(0x1fc)]-0x2>_0x2736c6;_0x2736c6++,_0x12d2eb--,_0x1a3be8--){_0x12d2eb>=0x2?_0x2e3c38+=_0x554b83[_0x2736c6]*_0x12d2eb:_0x2e3c38+=_0x554b83[_0x2736c6]*_0x1a3be8;}_0x2e3c38=_0x2e3c38%0xb;_0x2e3c38<0x2?_0x2e3c38=0x0:_0x2e3c38=0xb-_0x2e3c38;if(_0x2e3c38!=_0x554b83[0xc])return![];for(var _0x2736c6=0x0,_0x12d2eb=0x6,_0x1a3be8=0xe;_0x554b83['length']-0x1>_0x2736c6;_0x2736c6++,_0x12d2eb--,_0x1a3be8--){_0x12d2eb>=0x2?_0x6610e4+=_0x554b83[_0x2736c6]*_0x12d2eb:_0x6610e4+=_0x554b83[_0x2736c6]*_0x1a3be8;}return _0x6610e4=_0x6610e4%0xb,_0x6610e4<0x2?_0x6610e4=0x0:_0x6610e4=0xb-_0x6610e4,_0x6610e4!=_0x554b83[0xd]?![]:!![];}else return![];}}exports[a559_0x1e7ddb(0x1f7)]=validaCpfCnpj;function timeout(_0x5133c1){return new Promise(_0xcd5172=>setTimeout(_0xcd5172,_0x5133c1));}async function sleep(_0x5cb8c6){await timeout(_0x5cb8c6);}exports['sleep']=sleep;const sendMessageImage=async(_0x83396d,_0x44cb28,_0x4f391d,_0x5b7275,_0x1ed035)=>{const _0x1c3f20=a559_0x1e7ddb;let _0x47a9b0;try{_0x47a9b0=await _0x83396d[_0x1c3f20(0x19a)](_0x44cb28['number']+'@'+(_0x4f391d['isGroup']?_0x1c3f20(0x250):_0x1c3f20(0x1de)),{'image':_0x5b7275?{'url':_0x5b7275}:fs_2[_0x1c3f20(0x237)][_0x1c3f20(0x293)](_0x1c3f20(0x1b7)+_0x1ed035+'-'+makeid(0xa)),'fileName':_0x1ed035,'caption':_0x1ed035,'mimetype':_0x1c3f20(0x216)});}catch(_0x3dbad4){_0x47a9b0=await _0x83396d[_0x1c3f20(0x19a)](_0x44cb28['number']+'@'+(_0x4f391d['isGroup']?_0x1c3f20(0x250):_0x1c3f20(0x1de)),{'text':(0x0,Mustache_1['default'])(_0x1c3f20(0x155),_0x4f391d)});}(0x0,exports[_0x1c3f20(0x176)])(_0x47a9b0,_0x4f391d,_0x44cb28);};exports[a559_0x1e7ddb(0x232)]=sendMessageImage;const sendMessageLink=async(_0x344354,_0x427808,_0x1894ef,_0x5e0b0b,_0x24283f)=>{const _0x15cde2=a559_0x1e7ddb;let _0x3072bb;try{_0x3072bb=await _0x344354['sendMessage'](_0x427808['number']+'@'+(_0x1894ef[_0x15cde2(0x13b)]?'g.us':_0x15cde2(0x1de)),{'document':_0x5e0b0b?{'url':_0x5e0b0b}:fs_2[_0x15cde2(0x237)][_0x15cde2(0x293)]('public/temp/'+_0x24283f+'-'+makeid(0xa)),'fileName':_0x24283f,'caption':_0x24283f,'mimetype':_0x15cde2(0xf9)});}catch(_0x2daf62){_0x3072bb=await _0x344354[_0x15cde2(0x19a)](_0x427808[_0x15cde2(0x11d)]+'@'+(_0x1894ef['isGroup']?_0x15cde2(0x250):_0x15cde2(0x1de)),{'text':(0x0,Mustache_1[_0x15cde2(0x237)])(_0x15cde2(0x155),_0x1894ef)});}(0x0,exports['verifyMessage'])(_0x3072bb,_0x1894ef,_0x427808);};exports[a559_0x1e7ddb(0x1fe)]=sendMessageLink;function makeid(_0x1cef42){const _0x1983fb=a559_0x1e7ddb;var _0x33f6d7='',_0x43df4b=_0x1983fb(0x247),_0x567c88=_0x43df4b[_0x1983fb(0x1fc)];for(var _0xd15605=0x0;_0xd15605<_0x1cef42;_0xd15605++){_0x33f6d7+=_0x43df4b['charAt'](Math['floor'](Math[_0x1983fb(0x111)]()*_0x567c88));}return _0x33f6d7;}exports[a559_0x1e7ddb(0x26b)]=makeid;const msgLocation=(_0x3c71eb,_0x5eab75,_0x4be373)=>{const _0x4dcd9c=a559_0x1e7ddb;if(_0x3c71eb){var _0x37e6e4=Buffer[_0x4dcd9c(0x297)](_0x3c71eb)[_0x4dcd9c(0x133)](_0x4dcd9c(0x205));let _0x5ac067=_0x4dcd9c(0x1af)+_0x37e6e4+_0x4dcd9c(0x24a)+_0x5eab75+'%2C'+_0x4be373+_0x4dcd9c(0x11a)+_0x5eab75+',\x20'+_0x4be373+'\x20';return _0x5ac067;}},getBodyMessage=_0x3d6d4f=>{const _0x18420d=a559_0x1e7ddb;try{let _0x2416f9=getTypeMessage(_0x3d6d4f);const _0x5f5bfe={'conversation':MessageUtils[_0x18420d(0x25d)](_0x3d6d4f),'editedMessage':_0x3d6d4f?.[_0x18420d(0x14e)]?.[_0x18420d(0x1b4)]?.['message']?.[_0x18420d(0x199)]?.['editedMessage']?.['conversation']||_0x3d6d4f?.[_0x18420d(0x14e)]?.['editedMessage']?.[_0x18420d(0x14e)]?.[_0x18420d(0x107)]?.[_0x18420d(0x19b)],'imageMessage':MessageUtils[_0x18420d(0x222)](_0x3d6d4f),'videoMessage':MessageUtils[_0x18420d(0x256)](_0x3d6d4f),'extendedTextMessage':_0x3d6d4f[_0x18420d(0x14e)]?.[_0x18420d(0x107)]?.['text'],'buttonsResponseMessage':MessageUtils[_0x18420d(0x2ac)](_0x3d6d4f),'templateButtonReplyMessage':_0x3d6d4f[_0x18420d(0x14e)]?.['templateButtonReplyMessage']?.['selectedId'],'messageContextInfo':_0x3d6d4f[_0x18420d(0x14e)]?.[_0x18420d(0x193)]?.[_0x18420d(0x119)]||_0x3d6d4f[_0x18420d(0x14e)]?.[_0x18420d(0x10c)]?.[_0x18420d(0x281)],'buttonsMessage':MessageUtils[_0x18420d(0xe5)](_0x3d6d4f)||_0x3d6d4f[_0x18420d(0x14e)]?.[_0x18420d(0x10c)]?.['singleSelectReply']?.['selectedRowId'],'viewOnceMessage':MessageUtils[_0x18420d(0x1f2)](_0x3d6d4f),'viewOnceMessageV2':MessageUtils['getViewOnceMessageV2'](_0x3d6d4f),'stickerMessage':MessageUtils[_0x18420d(0x23c)](_0x3d6d4f),'contactMessage':MessageUtils['getContactMessage'](_0x3d6d4f),'contactsArrayMessage':_0x3d6d4f[_0x18420d(0x14e)]?.['contactsArrayMessage']?.[_0x18420d(0x21e)]&&MessageUtils[_0x18420d(0x278)](_0x3d6d4f),'pollCreationMessageV2':_0x3d6d4f[_0x18420d(0x14e)]?.[_0x18420d(0x27e)]?.[_0x18420d(0x245)]||_0x18420d(0x101),'pollCreationMessageV3':_0x3d6d4f[_0x18420d(0x14e)]?.['pollCreationMessageV3']?.[_0x18420d(0x245)]||_0x18420d(0x101),'interactiveMessage':_0x3d6d4f['message']?.[_0x18420d(0x254)]?.[_0x18420d(0x1ca)]||_0x3d6d4f[_0x18420d(0x14e)]?.[_0x18420d(0x254)]?.['contextInfo']||'Mensagem\x20interativa\x20não\x20suportada,\x20abra\x20o\x20dispositivo\x20para\x20ler.','locationMessage':MessageUtils[_0x18420d(0x12f)](_0x3d6d4f),'liveLocationMessage':'Latitude:\x20'+_0x3d6d4f['message']?.[_0x18420d(0x2a9)]?.[_0x18420d(0x123)]+'\x20-\x20Longitude:\x20'+_0x3d6d4f[_0x18420d(0x14e)]?.[_0x18420d(0x2a9)]?.['degreesLongitude'],'documentMessage':MessageUtils[_0x18420d(0x145)](_0x3d6d4f),'documentWithCaptionMessage':_0x3d6d4f[_0x18420d(0x14e)]?.[_0x18420d(0x126)]?.[_0x18420d(0x14e)]?.[_0x18420d(0xff)]?.['caption'],'audioMessage':MessageUtils[_0x18420d(0x151)](_0x3d6d4f),'ephemeralMessage':_0x3d6d4f[_0x18420d(0x14e)]?.[_0x18420d(0x188)]?.[_0x18420d(0x14e)]?.[_0x18420d(0x107)]?.[_0x18420d(0x19b)],'listMessage':MessageUtils[_0x18420d(0xe5)](_0x3d6d4f)||_0x3d6d4f[_0x18420d(0x14e)]?.[_0x18420d(0x10c)]?.[_0x18420d(0x281)],'listResponseMessage':MessageUtils[_0x18420d(0x25f)](_0x3d6d4f),'reactionMessage':MessageUtils[_0x18420d(0x12d)](_0x3d6d4f)||_0x18420d(0x1ce),'advertising':MessageUtils['getAd'](_0x3d6d4f)||_0x3d6d4f['message']?.[_0x18420d(0x10c)]?.[_0x18420d(0x106)]?.[_0x18420d(0x102)]?.['title'],'productMessage':_0x3d6d4f[_0x18420d(0x14e)]?.[_0x18420d(0x1c0)]?.['product']?.[_0x18420d(0xea)]?.['caption']||'Produto','multiProductMessage':'Múltiplos\x20Produtos','orderMessage':_0x18420d(0x235),'paymentMessage':MessageUtils[_0x18420d(0x1dd)](_0x3d6d4f),'paymentRequestMessage':'Solicitação\x20de\x20Pagamento','groupInviteMessage':MessageUtils['getGroupInviteMessage'](_0x3d6d4f),'revokeInviteMessage':_0x18420d(0x20b),'protocolMessage':_0x3d6d4f[_0x18420d(0x14e)]?.['protocolMessage']?.[_0x18420d(0x1b4)]?.['conversation']||null,'disappearingMessage':_0x18420d(0x2a4),'callMessage':MessageUtils[_0x18420d(0x125)](_0x3d6d4f),'templateMessage':MessageUtils['getTemplateMessage'](_0x3d6d4f),'statusUpdateMessage':_0x18420d(0x251)};return _0x5f5bfe[_0x2416f9]||null;}catch(_0x47e2a4){return console[_0x18420d(0x124)](_0x18420d(0xee),_0x47e2a4),null;}};function a559_0x5dfb(_0x4e956b,_0x5a5106){const _0x8f2bb9=a559_0x48e3();return a559_0x5dfb=function(_0x409851,_0xcc47a1){_0x409851=_0x409851-0xe4;let _0x48e3e3=_0x8f2bb9[_0x409851];return _0x48e3e3;},a559_0x5dfb(_0x4e956b,_0x5a5106);}exports['getBodyMessage']=getBodyMessage;const getQuotedMessage=_0x1395cd=>{const _0x23a476=a559_0x1e7ddb,_0x34e307=_0x1395cd[_0x23a476(0x14e)][_0x23a476(0x1e9)][_0x23a476(0x106)]||_0x1395cd[_0x23a476(0x14e)][_0x23a476(0x1c7)][_0x23a476(0x106)]||_0x1395cd[_0x23a476(0x14e)]?.[_0x23a476(0xff)]||_0x1395cd[_0x23a476(0x14e)][_0x23a476(0x107)][_0x23a476(0x106)]||_0x1395cd[_0x23a476(0x14e)][_0x23a476(0x193)][_0x23a476(0x106)]||_0x1395cd[_0x23a476(0x14e)][_0x23a476(0x10c)][_0x23a476(0x106)]||_0x1395cd[_0x23a476(0x14e)][_0x23a476(0x264)]['contextInfo']||_0x1395cd[_0x23a476(0x14e)][_0x23a476(0x193)]?.['contextInfo']||_0x1395cd?.[_0x23a476(0x14e)]?.[_0x23a476(0x193)]?.[_0x23a476(0x119)]||_0x1395cd[_0x23a476(0x14e)][_0x23a476(0x10c)]?.[_0x23a476(0x1c1)]?.[_0x23a476(0x13f)]||_0x1395cd?.[_0x23a476(0x14e)]?.[_0x23a476(0x10c)]?.[_0x23a476(0x1c1)]['selectedRowId']||_0x1395cd[_0x23a476(0x14e)][_0x23a476(0x10c)]?.['contextInfo'];return _0x1395cd['message'][_0x23a476(0x285)],(0x0,baileys_1[_0x23a476(0x20d)])(_0x34e307[Object['keys'](_0x34e307)[_0x23a476(0x173)]()[_0x23a476(0x27c)]()[_0x23a476(0x1c5)]]);};exports[a559_0x1e7ddb(0x25e)]=getQuotedMessage;const getQuotedMessageId=_0x461fbd=>{const _0x1b0b33=a559_0x1e7ddb,_0x51bfa6=(0x0,baileys_1[_0x1b0b33(0x20d)])(_0x461fbd[_0x1b0b33(0x14e)])[Object[_0x1b0b33(0x15c)](_0x461fbd?.[_0x1b0b33(0x14e)])['values']()[_0x1b0b33(0x27c)]()[_0x1b0b33(0x1c5)]];let _0x3c73d9=_0x461fbd?.['message']?.[_0x1b0b33(0x1d8)]?_0x461fbd?.[_0x1b0b33(0x14e)]?.['reactionMessage']?.[_0x1b0b33(0x12c)]?.['id']:'';return _0x3c73d9?_0x3c73d9:_0x51bfa6?.[_0x1b0b33(0x106)]?.[_0x1b0b33(0x24c)];};exports['getQuotedMessageId']=getQuotedMessageId;const getMeSocket=_0x5a3596=>{const _0x4f2ce7=a559_0x1e7ddb;return{'id':(0x0,baileys_1['jidNormalizedUser'])(_0x5a3596[_0x4f2ce7(0x20a)]['id']),'name':_0x5a3596[_0x4f2ce7(0x20a)][_0x4f2ce7(0x245)]};},getSenderMessage=(_0x28c1f6,_0x4454f6)=>{const _0x408c3b=a559_0x1e7ddb,_0xa7d976=getMeSocket(_0x4454f6);if(_0x28c1f6[_0x408c3b(0x12c)][_0x408c3b(0x1a2)])return _0xa7d976['id'];const _0x29b139=_0x28c1f6[_0x408c3b(0xf2)]||_0x28c1f6[_0x408c3b(0x12c)]['participant']||_0x28c1f6[_0x408c3b(0x12c)]['remoteJid']||undefined;return _0x29b139&&(0x0,baileys_1[_0x408c3b(0x2a2)])(_0x29b139);},getContactMessage=async(_0x1f5336,_0x298313)=>{const _0xdd7843=a559_0x1e7ddb,_0x429e96=_0x1f5336[_0xdd7843(0x12c)][_0xdd7843(0x13a)][_0xdd7843(0x175)]('g.us'),_0x43d393=_0x1f5336[_0xdd7843(0x12c)][_0xdd7843(0x13a)][_0xdd7843(0x2a5)](/\D/g,'');return _0x429e96?{'id':getSenderMessage(_0x1f5336,_0x298313),'name':_0x1f5336['pushName']}:{'id':_0x1f5336[_0xdd7843(0x12c)][_0xdd7843(0x13a)],'name':_0x1f5336['key']['fromMe']?_0x43d393:_0x1f5336[_0xdd7843(0x27f)]};},getUnpackedMessage=_0x431c11=>{const _0x1e5ceb=a559_0x1e7ddb;return _0x431c11[_0x1e5ceb(0x14e)]?.[_0x1e5ceb(0x126)]?.['message']||_0x431c11[_0x1e5ceb(0x14e)]?.[_0x1e5ceb(0x107)]?.[_0x1e5ceb(0x106)]?.[_0x1e5ceb(0x1d2)]||_0x431c11[_0x1e5ceb(0x14e)]?.['ephemeralMessage']?.[_0x1e5ceb(0x14e)]||_0x431c11[_0x1e5ceb(0x14e)]?.[_0x1e5ceb(0x14b)]?.[_0x1e5ceb(0x14e)]||_0x431c11['message']?.[_0x1e5ceb(0x259)]?.[_0x1e5ceb(0x14e)]||_0x431c11[_0x1e5ceb(0x14e)]?.['ephemeralMessage']?.['message']||_0x431c11[_0x1e5ceb(0x14e)]?.[_0x1e5ceb(0x2a8)]?.[_0x1e5ceb(0x20c)]||_0x431c11['message']?.[_0x1e5ceb(0x2a8)]?.[_0x1e5ceb(0x1cb)]||_0x431c11[_0x1e5ceb(0x14e)]?.[_0x1e5ceb(0x2a8)]?.[_0x1e5ceb(0x105)]||_0x431c11[_0x1e5ceb(0x14e)]?.[_0x1e5ceb(0x254)]?.[_0x1e5ceb(0x203)]||_0x431c11[_0x1e5ceb(0x14e)]?.[_0x1e5ceb(0x240)]?.[_0x1e5ceb(0x292)]?.[_0x1e5ceb(0x20c)]||_0x431c11[_0x1e5ceb(0x14e)];},getMessageMedia=_0x722794=>{const _0x481b7f=a559_0x1e7ddb;return _0x722794?.['imageMessage']||_0x722794?.[_0x481b7f(0x1a6)]||_0x722794?.[_0x481b7f(0x1c7)]||_0x722794?.['stickerMessage']||_0x722794?.[_0x481b7f(0xff)]||null;},downloadMedia=async _0xb50134=>{const _0x1f463b=a559_0x1e7ddb,_0x220f90=getUnpackedMessage(_0xb50134),_0x2a1834=getMessageMedia(_0x220f90);if(!_0x2a1834)return null;const _0x32a42e=_0x220f90?.[_0x1f463b(0xff)]?_0x1f463b(0x283):_0x2a1834[_0x1f463b(0x207)][_0x1f463b(0x116)]('/')[0x0][_0x1f463b(0x2a5)](_0x1f463b(0x1ab),_0x1f463b(0x283))?_0x2a1834[_0x1f463b(0x207)][_0x1f463b(0x116)]('/')[0x0][_0x1f463b(0x2a5)](_0x1f463b(0x1ab),'document'):_0x2a1834['mimetype'][_0x1f463b(0x116)]('/')[0x0];let _0x75bacc,_0xc8dfab=0x0;while(_0xc8dfab<0xa&&!_0x75bacc){try{_0x2a1834?.[_0x1f463b(0x1bf)]&&(_0x2a1834[_0x1f463b(0x14f)]=''),_0x75bacc=await(0x0,baileys_1[_0x1f463b(0x27d)])(_0x2a1834,_0x32a42e);}catch(_0x470d8b){_0xc8dfab+=0x1,await new Promise(_0x58d98c=>{setTimeout(_0x58d98c,0x3e8*_0xc8dfab*0x2);}),logger_1[_0x1f463b(0x1e3)][_0x1f463b(0x141)]('>>>>\x20erro\x20'+_0xc8dfab+_0x1f463b(0x1d6)+_0xb50134?.[_0x1f463b(0x12c)]?.['id']);}}if(!_0x75bacc)throw new Error('Failed\x20to\x20get\x20stream');let _0x434fc5=_0x220f90?.[_0x1f463b(0xff)]?.['fileName']||'';if(!_0x434fc5){const _0x48ad5f=mime_1['default'][_0x1f463b(0x134)](_0x2a1834['mimetype']);_0x434fc5=(0x0,MakeRandomId_1[_0x1f463b(0x1da)])(0x5)+'-'+new Date()[_0x1f463b(0x154)]()+'.'+_0x48ad5f;}else _0x434fc5=_0x434fc5[_0x1f463b(0x116)]('.')[_0x1f463b(0x136)](0x0,-0x1)['join']('.')+'.'+(0x0,MakeRandomId_1[_0x1f463b(0x1da)])(0x5)+'.'+_0x434fc5[_0x1f463b(0x116)]('.')[_0x1f463b(0x136)](-0x1);const _0x3aad07=0x5*0x400*0x400/0x8,_0xd4c99=0x400*0x400/0x8,_0x1873a6=0x400*0x400,_0x2cf7cd=new stream_throttle_1[(_0x1f463b(0x227))]({'rate':_0x3aad07});let _0x19f560=Buffer[_0x1f463b(0x297)]([]),_0x4663d0=0x0;const _0x43e976=Date[_0x1f463b(0x255)]();try{for await(const _0x4197f8 of _0x75bacc[_0x1f463b(0x295)](_0x2cf7cd)){_0x19f560=Buffer[_0x1f463b(0xf7)]([_0x19f560,_0x4197f8]),_0x4663d0+=_0x4197f8[_0x1f463b(0x1fc)],_0x4663d0>_0x1873a6&&(_0x2cf7cd[_0x1f463b(0x1eb)]=_0xd4c99);}}catch(_0x43c627){return{'data':_0x1f463b(0x124),'mimetype':'','filename':''};}const _0x2676a5=Date[_0x1f463b(0x255)](),_0x127e02=(_0x2676a5-_0x43e976)/0x3e8,_0x54c24f=_0x4663d0/_0x127e02;logger_1[_0x1f463b(0x1e3)][_0x1f463b(0x206)](_0x434fc5+_0x1f463b(0x20f)+_0x127e02[_0x1f463b(0x1b1)](0x2)+_0x1f463b(0x16d)+(_0x54c24f/0x400/0x400)[_0x1f463b(0x1b1)](0x2)+_0x1f463b(0x28c));if(!_0x19f560){Sentry[_0x1f463b(0x269)](_0x1f463b(0x230),{'msg':_0xb50134}),Sentry['captureException'](new Error('ERR_WAPP_DOWNLOAD_MEDIA'));throw new Error('ERR_WAPP_DOWNLOAD_MEDIA');}const _0x1214d4={'data':_0x19f560,'mimetype':_0x2a1834['mimetype'],'filename':_0x434fc5};return _0x1214d4;},verifyContact=async(_0x154076,_0x3d8285,_0x5302f1)=>{const _0x4b003c=a559_0x1e7ddb,_0xf3fe8={'name':_0x154076?.[_0x4b003c(0x245)]||_0x154076['id'][_0x4b003c(0x2a5)](/\D/g,''),'number':_0x154076['id'][_0x4b003c(0x158)](0x0,_0x154076['id'][_0x4b003c(0x249)]('@')),'isGroup':_0x154076['id'][_0x4b003c(0x175)](_0x4b003c(0x250)),'companyId':_0x5302f1,'whatsappId':_0x3d8285['id']},_0x5f41a0=(0x0,CreateOrUpdateContactService_1[_0x4b003c(0x237)])(_0xf3fe8,_0x3d8285,_0x154076['id']);return _0x5f41a0;},verifyQuotedMessage=async _0x169d38=>{const _0x525163=a559_0x1e7ddb;if(!_0x169d38)return null;const _0x1f9431=(0x0,exports[_0x525163(0x118)])(_0x169d38);if(!_0x1f9431)return null;const _0x398265=await Message_1['default']['findOne']({'where':{'id':_0x1f9431}});if(!_0x398265)return null;return _0x398265;};exports['verifyQuotedMessage']=verifyQuotedMessage;const sanitizeName=_0x2f9b3e=>{const _0x36e45f=a559_0x1e7ddb;let _0x16fa4e=_0x2f9b3e[_0x36e45f(0x116)]('\x20')[0x0];return _0x16fa4e=_0x16fa4e['replace'](/[^a-zA-Z0-9]/g,''),_0x16fa4e[_0x36e45f(0x158)](0x0,0x3c);},convertTextToSpeechAndSaveToFile=(_0x2d328b,_0x47769c,_0xf70a7f,_0x438121,_0x1abc24=a559_0x1e7ddb(0x1b3),_0x5a22d4=a559_0x1e7ddb(0xfd))=>{return new Promise((_0x36e479,_0x4e39eb)=>{const _0x480c52=a559_0x5dfb,_0x3b5a6d=microsoft_cognitiveservices_speech_sdk_1[_0x480c52(0x1e8)][_0x480c52(0x1e2)](_0xf70a7f,_0x438121);_0x3b5a6d[_0x480c52(0x211)]=_0x1abc24;const _0x28e031=microsoft_cognitiveservices_speech_sdk_1['AudioConfig'][_0x480c52(0x19e)](_0x47769c+_0x480c52(0x286)),_0x5527a6=new microsoft_cognitiveservices_speech_sdk_1['SpeechSynthesizer'](_0x3b5a6d,_0x28e031);_0x5527a6[_0x480c52(0x177)](_0x2d328b,_0x36f07e=>{const _0x43e77c=_0x480c52;_0x36f07e?convertWavToAnotherFormat(_0x47769c+_0x43e77c(0x286),_0x47769c+'.'+_0x5a22d4,_0x5a22d4)[_0x43e77c(0x1f3)](_0x380553=>{_0x36e479();})[_0x43e77c(0x144)](_0x26bcab=>{console['error'](_0x26bcab),_0x4e39eb(_0x26bcab);}):_0x4e39eb(new Error(_0x43e77c(0x217))),_0x5527a6[_0x43e77c(0x29e)]();},_0x5b7e97=>{const _0x19e021=_0x480c52;console[_0x19e021(0x124)](_0x19e021(0x272)+_0x5b7e97),_0x5527a6[_0x19e021(0x29e)](),_0x4e39eb(_0x5b7e97);});});},convertWavToAnotherFormat=(_0x48898c,_0x1cf675,_0x519921)=>{return new Promise((_0x2769e2,_0x174de1)=>{const _0x556651=a559_0x5dfb;(0x0,fluent_ffmpeg_1[_0x556651(0x237)])()[_0x556651(0x21d)](_0x48898c)[_0x556651(0x198)](_0x519921)['on']('end',()=>_0x2769e2(_0x1cf675))['on']('error',_0xdfaf85=>_0x174de1(new Error(_0x556651(0x26c)+_0xdfaf85[_0x556651(0x14e)])))[_0x556651(0x157)](_0x1cf675);});},deleteFileSync=_0x4e237f=>{const _0x44eba2=a559_0x1e7ddb;try{fs_2[_0x44eba2(0x237)][_0x44eba2(0x16f)](_0x4e237f);}catch(_0x1cf943){console['error'](_0x44eba2(0x24f),_0x1cf943);}},keepOnlySpecifiedChars=_0x391323=>{return _0x391323['replace'](/[^a-zA-Z0-9áéíóúÁÉÍÓÚâêîôûÂÊÎÔÛãõÃÕçÇ!?.,;:\s]/g,'');},handleOpenAi=async(_0xc3b1d5,_0x27b9df,_0xdc7215,_0x267b64,_0x5962df)=>{const _0x560086=a559_0x1e7ddb,_0x5e22ab=(0x0,exports[_0x560086(0x115)])(_0xc3b1d5);if(!_0x5e22ab)return;let {prompt:_0x53ca75}=await(0x0,ShowWhatsAppService_1[_0x560086(0x237)])(_0x27b9df['id'],_0xdc7215[_0x560086(0x22a)]);!_0x53ca75&&!(0x0,lodash_1['isNil'])(_0xdc7215?.[_0x560086(0x223)]?.[_0x560086(0x132)])&&(_0x53ca75=_0xdc7215[_0x560086(0x223)]['prompt']);if(!_0x53ca75)return;if(_0xc3b1d5[_0x560086(0x258)])return;const _0x2b8e7c=path_1[_0x560086(0x237)][_0x560086(0x161)](__dirname,'..','..','..',_0x560086(0x150));let _0x19e68f;const _0x1f4efc=sessionsOpenAi[_0x560086(0x172)](_0x3c791d=>_0x3c791d['id']===_0x27b9df['id']);if(_0x1f4efc===-0x1){const _0x4db0e7=new openai_1[(_0x560086(0x100))]({'apiKey':_0x53ca75[_0x560086(0x1dc)]});_0x19e68f=new openai_1[(_0x560086(0x182))](_0x4db0e7),_0x19e68f['id']=_0x27b9df['id'],sessionsOpenAi['push'](_0x19e68f);}else _0x19e68f=sessionsOpenAi[_0x1f4efc];const _0x503b7d=await Message_1[_0x560086(0x237)][_0x560086(0x2a0)]({'where':{'ticketId':_0xdc7215['id']},'order':[[_0x560086(0x117),_0x560086(0x13c)]],'limit':_0x53ca75[_0x560086(0x113)]}),_0x2365bc=_0x560086(0x210)+sanitizeName(_0x267b64[_0x560086(0x245)]||_0x560086(0x2a7))+_0x560086(0xe7)+_0x53ca75['maxTokens']+'\x20tokens\x20e\x20cuide\x20para\x20não\x20truncar\x20o\x20final.\x0aSempre\x20que\x20possível,\x20mencione\x20o\x20nome\x20dele\x20para\x20ser\x20mais\x20personalizado\x20o\x20atendimento\x20e\x20mais\x20educado.\x20Quando\x20a\x20resposta\x20requer\x20uma\x20transferência\x20para\x20o\x20setor\x20de\x20atendimento,\x20comece\x20sua\x20resposta\x20com\x20\x27Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento\x27.\x0a\x0a\x20\x20'+_0x53ca75['prompt']+'\x0a';let _0x20465c=[];if(_0xc3b1d5[_0x560086(0x14e)]?.[_0x560086(0x214)]||_0xc3b1d5['message']?.['extendedTextMessage']?.[_0x560086(0x19b)]){_0x20465c=[],_0x20465c[_0x560086(0x184)]({'role':_0x560086(0x18d),'content':_0x2365bc});for(let _0x1618ab=0x0;_0x1618ab<Math[_0x560086(0x1c6)](_0x53ca75[_0x560086(0x113)],_0x503b7d['length']);_0x1618ab++){const _0x2ccb4b=_0x503b7d[_0x1618ab];_0x2ccb4b[_0x560086(0x12b)]===_0x560086(0x1a5)&&(_0x2ccb4b[_0x560086(0x1a2)]?_0x20465c[_0x560086(0x184)]({'role':_0x560086(0x244),'content':_0x2ccb4b['body']}):_0x20465c[_0x560086(0x184)]({'role':'user','content':_0x2ccb4b[_0x560086(0x1ca)]}));}_0x20465c[_0x560086(0x184)]({'role':'user','content':_0x5e22ab});const _0x44caaa=await _0x19e68f[_0x560086(0x1fa)]({'model':'gpt-3.5-turbo-1106','messages':_0x20465c,'max_tokens':_0x53ca75[_0x560086(0x277)],'temperature':_0x53ca75[_0x560086(0x267)]});let _0x290912=_0x44caaa['data'][_0x560086(0x26a)][0x0]['message']?.[_0x560086(0x279)];_0x290912?.[_0x560086(0x175)](_0x560086(0xf6))&&(await transferQueue(_0x53ca75[_0x560086(0x24d)],_0xdc7215,_0x267b64),_0x290912=_0x290912[_0x560086(0x2a5)](_0x560086(0xf6),'')[_0x560086(0x16e)]());if(_0x53ca75[_0x560086(0x22b)]===_0x560086(0x220)){const _0x323cd5=await _0x27b9df[_0x560086(0x19a)](_0xc3b1d5[_0x560086(0x12c)][_0x560086(0x13a)],{'text':_0x290912});await(0x0,exports[_0x560086(0x176)])(_0x323cd5,_0xdc7215,_0x267b64);}else{const _0x1e787f=_0xdc7215['id']+'_'+Date[_0x560086(0x255)]();convertTextToSpeechAndSaveToFile(keepOnlySpecifiedChars(_0x290912),_0x2b8e7c+'/'+_0x1e787f,_0x53ca75[_0x560086(0x21c)],_0x53ca75[_0x560086(0x162)],_0x53ca75[_0x560086(0x22b)],_0x560086(0xfd))[_0x560086(0x1f3)](async()=>{const _0xfe71f5=_0x560086;try{const _0x3831d1=await _0x27b9df['sendMessage'](_0xc3b1d5[_0xfe71f5(0x12c)]['remoteJid'],{'audio':{'url':_0x2b8e7c+'/'+_0x1e787f+_0xfe71f5(0x135)},'mimetype':_0xfe71f5(0x127),'ptt':!![]});await verifyMediaMessage(_0x3831d1,_0xdc7215,_0x267b64),deleteFileSync(_0x2b8e7c+'/'+_0x1e787f+'.mp3'),deleteFileSync(_0x2b8e7c+'/'+_0x1e787f+_0xfe71f5(0x286));}catch(_0x34f961){console['log'](_0xfe71f5(0x221)+_0x34f961);}});}}else{if(_0xc3b1d5[_0x560086(0x14e)]?.[_0x560086(0x1a6)]){const _0x152153=_0x5962df[_0x560086(0x112)]['split']('/')[_0x560086(0x1e1)](),_0x4d146f=fs_2[_0x560086(0x237)][_0x560086(0x153)](_0x2b8e7c+'/'+_0x152153),_0x2c2046=await _0x19e68f['createTranscription'](_0x4d146f,_0x560086(0xf0));_0x20465c=[],_0x20465c['push']({'role':'system','content':_0x2365bc});for(let _0x53b588=0x0;_0x53b588<Math[_0x560086(0x1c6)](_0x53ca75[_0x560086(0x113)],_0x503b7d[_0x560086(0x1fc)]);_0x53b588++){const _0x1a1dd1=_0x503b7d[_0x53b588];_0x1a1dd1['mediaType']===_0x560086(0x1a5)&&(_0x1a1dd1['fromMe']?_0x20465c[_0x560086(0x184)]({'role':'assistant','content':_0x1a1dd1[_0x560086(0x1ca)]}):_0x20465c[_0x560086(0x184)]({'role':_0x560086(0x20a),'content':_0x1a1dd1[_0x560086(0x1ca)]}));}_0x20465c['push']({'role':'user','content':_0x2c2046['data']['text']});const _0x161a97=await _0x19e68f[_0x560086(0x1fa)]({'model':_0x560086(0x149),'messages':_0x20465c,'max_tokens':_0x53ca75[_0x560086(0x277)],'temperature':_0x53ca75['temperature']});let _0x5a92f0=_0x161a97[_0x560086(0x130)]['choices'][0x0]['message']?.['content'];_0x5a92f0?.[_0x560086(0x175)](_0x560086(0xf6))&&(await transferQueue(_0x53ca75['queueId'],_0xdc7215,_0x267b64),_0x5a92f0=_0x5a92f0[_0x560086(0x2a5)](_0x560086(0xf6),'')[_0x560086(0x16e)]());if(_0x53ca75[_0x560086(0x22b)]===_0x560086(0x220)){const _0x633c39=await _0x27b9df[_0x560086(0x19a)](_0xc3b1d5[_0x560086(0x12c)][_0x560086(0x13a)],{'text':_0x5a92f0});await(0x0,exports['verifyMessage'])(_0x633c39,_0xdc7215,_0x267b64);}else{const _0x3a4e5a=_0xdc7215['id']+'_'+Date[_0x560086(0x255)]();convertTextToSpeechAndSaveToFile(keepOnlySpecifiedChars(_0x5a92f0),_0x2b8e7c+'/'+_0x3a4e5a,_0x53ca75[_0x560086(0x21c)],_0x53ca75['voiceRegion'],_0x53ca75[_0x560086(0x22b)],_0x560086(0xfd))['then'](async()=>{const _0x40d51c=_0x560086;try{const _0x5dc7bc=await _0x27b9df[_0x40d51c(0x19a)](_0xc3b1d5[_0x40d51c(0x12c)][_0x40d51c(0x13a)],{'audio':{'url':_0x2b8e7c+'/'+_0x3a4e5a+_0x40d51c(0x135)},'mimetype':_0x40d51c(0x127),'ptt':!![]});await verifyMediaMessage(_0x5dc7bc,_0xdc7215,_0x267b64),deleteFileSync(_0x2b8e7c+'/'+_0x3a4e5a+_0x40d51c(0x135)),deleteFileSync(_0x2b8e7c+'/'+_0x3a4e5a+_0x40d51c(0x286));}catch(_0x2ebcd4){console['log']('Erro\x20para\x20responder\x20com\x20audio:\x20'+_0x2ebcd4);}});}}}_0x20465c=[];},transferQueue=async(_0xdfe81a,_0x3ec063,_0x58c9d3)=>{const _0x21a1ea=a559_0x1e7ddb;console['trace'](_0x21a1ea(0x10a)),await(0x0,UpdateTicketService_1['default'])({'ticketData':{'queueId':_0xdfe81a,'useIntegration':![],'promptId':null},'ticketId':_0x3ec063['id'],'companyId':_0x3ec063[_0x21a1ea(0x22a)]});},verifyMediaMessage=async(_0x5d2299,_0x16f99d,_0x51d062)=>{const _0x243635=a559_0x1e7ddb,_0x16fc68=(0x0,socket_1[_0x243635(0x239)])();let _0x2bb0d5=await Message_1[_0x243635(0x237)][_0x243635(0x282)]({'where':{'id':_0x5d2299['key']['id']}});if(!_0x2bb0d5){const _0x1dfbfc=await(0x0,exports[_0x243635(0x234)])(_0x5d2299),_0x49fb61=(0x0,wbot_1['getWbot'])(_0x16f99d[_0x243635(0xf1)]),_0x34b9bc=await downloadMedia(_0x5d2299);if(!_0x34b9bc)throw new Error(_0x243635(0x230));if(!_0x34b9bc[_0x243635(0x233)]){const _0x2198a3=typeof _0x34b9bc[_0x243635(0x207)]==='string'&&_0x34b9bc['mimetype'][_0x243635(0x175)]('/')&&_0x34b9bc[_0x243635(0x207)]['includes'](';')?mime_1[_0x243635(0x237)]['extension'](_0x34b9bc[_0x243635(0x207)]):'unknown';_0x34b9bc['filename']=new Date()[_0x243635(0x154)]()+'.'+_0x2198a3;}else{let _0x263a52=_0x34b9bc['filename']?'-'+_0x34b9bc[_0x243635(0x233)]:'';_0x34b9bc['filename']=''+new Date()['getTime']()+_0x263a52;}try{const _0x2928ed=_0x243635(0x273)+_0x16f99d[_0x243635(0x22a)];!fs_2['default'][_0x243635(0x204)](_0x2928ed)&&(fs_2[_0x243635(0x237)][_0x243635(0x266)](_0x2928ed),fs_2['default'][_0x243635(0x163)](_0x2928ed,0x1ff)),await writeFileAsync((0x0,path_1[_0x243635(0x120)])(__dirname,'..','..','..',_0x2928ed,_0x34b9bc[_0x243635(0x233)]),_0x34b9bc[_0x243635(0x130)],'base64');}catch(_0x264fae){Sentry[_0x243635(0x290)](_0x264fae),logger_1[_0x243635(0x1e3)][_0x243635(0x124)](_0x264fae);}const _0x3b98e1=(0x0,exports[_0x243635(0x115)])(_0x5d2299);var _0x475e26=getTypeMessage(_0x5d2299);const _0x484c49={'id':_0x5d2299[_0x243635(0x12c)]['id'],'ticketId':_0x16f99d['id'],'contactId':_0x5d2299[_0x243635(0x12c)][_0x243635(0x1a2)]?undefined:_0x51d062['id'],'body':_0x3b98e1?(0x0,Mustache_1[_0x243635(0x237)])(_0x3b98e1,_0x16f99d):_0x34b9bc['filename'],'fromMe':_0x5d2299[_0x243635(0x12c)][_0x243635(0x1a2)],'read':_0x5d2299['key'][_0x243635(0x1a2)],'mediaUrl':_0x34b9bc['filename'],'mediaType':typeof _0x34b9bc[_0x243635(0x207)]===_0x243635(0x280)?_0x34b9bc[_0x243635(0x207)][_0x243635(0x116)]('/')[0x0]:_0x243635(0x296),'quotedMsgId':_0x1dfbfc?.['id'],'ack':getStatus(_0x5d2299,_0x243635(0x18a)),'remoteJid':_0x5d2299[_0x243635(0x12c)][_0x243635(0x13a)],'participant':_0x5d2299[_0x243635(0x12c)]['participant'],'dataJson':JSON[_0x243635(0x201)](_0x5d2299)};var _0x233b98=_0x3b98e1||_0x34b9bc['filename'];typeof _0x233b98!='string'&&console[_0x243635(0x15f)](_0x243635(0x13e),_0x233b98),await _0x16f99d['update']({'lastMessage':_0x233b98}),_0x2bb0d5=await(0x0,CreateMessageService_1[_0x243635(0x237)])({'messageData':_0x484c49,'ticket':_0x16f99d,'companyId':_0x16f99d[_0x243635(0x22a)]});}else typeof _0x2bb0d5['body']!=_0x243635(0x280)&&console[_0x243635(0x15f)](_0x243635(0x13e),_0x2bb0d5[_0x243635(0x1ca)]),await _0x16f99d[_0x243635(0x291)]({'lastMessage':_0x2bb0d5['body']}),_0x2bb0d5[_0x243635(0x224)]=getStatus(_0x5d2299,_0x243635(0x18a)),_0x2bb0d5['participant']=_0x5d2299['key']['participant'],_0x2bb0d5['dataJson']=JSON['stringify'](_0x5d2299),await _0x2bb0d5[_0x243635(0x157)]();return!_0x5d2299[_0x243635(0x12c)][_0x243635(0x1a2)]&&_0x16f99d[_0x243635(0x143)]===_0x243635(0x1aa)&&(await _0x16f99d['update']({'status':_0x243635(0x128)}),await _0x16f99d[_0x243635(0x2aa)]({'include':[{'model':Queue_1[_0x243635(0x237)],'as':_0x243635(0x223)},{'model':User_1['default'],'as':_0x243635(0x20a)},{'model':Contact_1[_0x243635(0x237)],'as':_0x243635(0x268)}]}),_0x16fc68['to'](_0x243635(0x165)+_0x16f99d['companyId']+_0x243635(0x170))['emit']('company-'+_0x16f99d[_0x243635(0x22a)]+_0x243635(0x261),{'action':_0x243635(0x1a4),'ticket':_0x16f99d,'ticketId':_0x16f99d['id']}),_0x16fc68['to']('company-'+_0x16f99d[_0x243635(0x22a)]+'-'+_0x16f99d['status'])['to'](_0x16f99d['id'][_0x243635(0x133)]())[_0x243635(0x26f)](_0x243635(0x165)+_0x16f99d[_0x243635(0x22a)]+_0x243635(0x261),{'action':_0x243635(0x291),'ticket':_0x16f99d,'ticketId':_0x16f99d['id']})),_0x2bb0d5;};function getStatus(_0x1a448b,_0x4864c9){const _0x58d2e0=a559_0x1e7ddb;if(_0x1a448b[_0x58d2e0(0x143)]==baileys_1[_0x58d2e0(0x28d)]['WebMessageInfo'][_0x58d2e0(0x17f)][_0x58d2e0(0x197)]){if(_0x1a448b[_0x58d2e0(0x12c)]['fromMe']&&_0x4864c9==_0x58d2e0(0x1d8))return 0x3;return 0x1;}else{if(_0x1a448b['status']==baileys_1['proto'][_0x58d2e0(0x212)][_0x58d2e0(0x17f)][_0x58d2e0(0x26e)])return 0x1;else{if(_0x1a448b['status']==baileys_1[_0x58d2e0(0x28d)]['WebMessageInfo'][_0x58d2e0(0x17f)][_0x58d2e0(0x167)])return 0x2;else{if(_0x1a448b[_0x58d2e0(0x143)]==baileys_1[_0x58d2e0(0x28d)][_0x58d2e0(0x212)][_0x58d2e0(0x17f)]['READ']||_0x1a448b[_0x58d2e0(0x143)]==baileys_1[_0x58d2e0(0x28d)][_0x58d2e0(0x212)][_0x58d2e0(0x17f)][_0x58d2e0(0x238)])return 0x3;}}}return 0x0;}const verifyMessage=async(_0x2e9851,_0x559191,_0x2e8ae6)=>{const _0x8fee9c=a559_0x1e7ddb,_0x307547=(0x0,socket_1[_0x8fee9c(0x239)])(),_0x549e15=await(0x0,exports[_0x8fee9c(0x234)])(_0x2e9851),_0x654ecd=(0x0,exports[_0x8fee9c(0x115)])(_0x2e9851);if(!_0x654ecd)return;let _0xeba0b1=getTypeMessage(_0x2e9851);const _0xb4d5eb=_0xeba0b1==_0x8fee9c(0x1b4)||_0x2e9851?.[_0x8fee9c(0x14e)]?.[_0x8fee9c(0x199)]?.[_0x8fee9c(0x24e)]==baileys_1[_0x8fee9c(0x28d)][_0x8fee9c(0x1cd)]['ProtocolMessage']['Type'][_0x8fee9c(0x180)]||_0x2e9851?.['message']?.['protocolMessage']?.[_0x8fee9c(0x1b4)]?.[_0x8fee9c(0x214)]?.[_0x8fee9c(0x1fc)]>0x0;let _0x26bf5b=_0x2e9851[_0x8fee9c(0x12c)]['id'];if(_0xeba0b1==_0x8fee9c(0x199))_0x26bf5b=_0x2e9851?.[_0x8fee9c(0x14e)]?.[_0x8fee9c(0x199)]?.[_0x8fee9c(0x12c)]?.['id']||_0x2e9851['key']['id'];else _0xeba0b1==_0x8fee9c(0x1b4)&&(_0x26bf5b=_0x2e9851?.[_0x8fee9c(0x14e)]?.[_0x8fee9c(0x1b4)]?.[_0x8fee9c(0x14e)]?.[_0x8fee9c(0x199)]?.['key']?.['id']||_0x2e9851[_0x8fee9c(0x12c)]['id']);const _0x3414bf={'id':_0x26bf5b,'ticketId':_0x559191['id'],'contactId':_0x2e9851[_0x8fee9c(0x12c)]['fromMe']?undefined:_0x2e8ae6['id'],'body':_0x654ecd,'fromMe':_0x2e9851[_0x8fee9c(0x12c)][_0x8fee9c(0x1a2)],'mediaType':_0xeba0b1,'read':_0x2e9851[_0x8fee9c(0x12c)][_0x8fee9c(0x1a2)],'quotedMsgId':_0x549e15?.['id'],'ack':getStatus(_0x2e9851,_0xeba0b1),'remoteJid':_0x2e9851[_0x8fee9c(0x12c)]['remoteJid'],'participant':_0x2e9851[_0x8fee9c(0x12c)][_0x8fee9c(0xf2)],'dataJson':JSON[_0x8fee9c(0x201)](_0x2e9851),'isEdited':_0xb4d5eb};typeof _0x654ecd!=_0x8fee9c(0x280)&&console[_0x8fee9c(0x15f)](_0x8fee9c(0x13e),_0x654ecd);await _0x559191[_0x8fee9c(0x291)]({'lastMessage':_0x654ecd});if(_0xb4d5eb){let _0x644edb=await Message_1['default']['findByPk'](_0x3414bf['id']);if(_0x644edb){const _0x4c1606={'messageId':_0x3414bf['id'],'body':_0x644edb[_0x8fee9c(0x1ca)]};await OldMessage_1['default']['upsert'](_0x4c1606);}else console['log'](_0x8fee9c(0x1d5)+_0x3414bf['id']);}await(0x0,CreateMessageService_1[_0x8fee9c(0x237)])({'messageData':_0x3414bf,'ticket':_0x559191,'companyId':_0x559191[_0x8fee9c(0x22a)]}),!_0x2e9851['key'][_0x8fee9c(0x1a2)]&&_0x559191['status']===_0x8fee9c(0x1aa)&&(await _0x559191[_0x8fee9c(0x291)]({'status':'pending'}),await _0x559191[_0x8fee9c(0x2aa)]({'include':[{'model':Queue_1[_0x8fee9c(0x237)],'as':_0x8fee9c(0x223)},{'model':User_1[_0x8fee9c(0x237)],'as':'user'},{'model':Contact_1[_0x8fee9c(0x237)],'as':_0x8fee9c(0x268)}]}),_0x307547['to'](_0x8fee9c(0x165)+_0x559191[_0x8fee9c(0x22a)]+'-closed')[_0x8fee9c(0x26f)](_0x8fee9c(0x165)+_0x559191[_0x8fee9c(0x22a)]+_0x8fee9c(0x261),{'action':_0x8fee9c(0x1a4),'ticket':_0x559191,'ticketId':_0x559191['id']}),_0x307547['to'](_0x8fee9c(0x165)+_0x559191['companyId']+'-'+_0x559191[_0x8fee9c(0x143)])['to'](_0x559191['id']['toString']())[_0x8fee9c(0x26f)]('company-'+_0x559191[_0x8fee9c(0x22a)]+_0x8fee9c(0x261),{'action':_0x8fee9c(0x291),'ticket':_0x559191,'ticketId':_0x559191['id']}));};exports['verifyMessage']=verifyMessage;const isValidMsg=_0x477f43=>{const _0x4df442=a559_0x1e7ddb;if(_0x477f43['key']['remoteJid']===_0x4df442(0xec))return![];try{const _0x4710d9=getTypeMessage(_0x477f43);if(!_0x4710d9)return![];const _0x552ee0=_0x4710d9==='conversation'||_0x4710d9===_0x4df442(0x1b4)||_0x4710d9===_0x4df442(0x107)||_0x4710d9===_0x4df442(0x1a6)||_0x4710d9==='videoMessage'||_0x4710d9===_0x4df442(0x27e)||_0x4710d9===_0x4df442(0x2a8)||_0x4710d9==='pollCreationMessageV3'||_0x4710d9===_0x4df442(0x254)||_0x4710d9===_0x4df442(0x1e9)||_0x4710d9===_0x4df442(0xff)||_0x4710d9===_0x4df442(0x126)||_0x4710d9===_0x4df442(0x1f5)||_0x4710d9===_0x4df442(0x193)||_0x4710d9==='buttonsMessage'||_0x4710d9==='messageContextInfo'||_0x4710d9===_0x4df442(0x22c)||_0x4710d9===_0x4df442(0x2a9)||_0x4710d9===_0x4df442(0x22d)||_0x4710d9===_0x4df442(0x276)||_0x4710d9==='mediaMessage'||_0x4710d9===_0x4df442(0x226)||_0x4710d9===_0x4df442(0x1d8)||_0x4710d9==='ephemeralMessage'||_0x4710d9===_0x4df442(0x199)||_0x4710d9===_0x4df442(0x10c)||_0x4710d9===_0x4df442(0x2a3)||_0x4710d9===_0x4df442(0x14b)||_0x4710d9===_0x4df442(0x259)||_0x4710d9===_0x4df442(0x1e0)||_0x4710d9===_0x4df442(0x240);return!_0x552ee0&&(logger_1[_0x4df442(0x1e3)][_0x4df442(0x141)](_0x4df442(0x187)+_0x4710d9+'\x0a'+JSON[_0x4df442(0x201)](_0x477f43?.['message'])),Sentry[_0x4df442(0x269)](_0x4df442(0x253),{'BodyMsg':_0x477f43[_0x4df442(0x14e)],'msg':_0x477f43,'msgType':_0x4710d9}),Sentry[_0x4df442(0x290)](new Error(_0x4df442(0x169)))),!!_0x552ee0;}catch(_0x4b8362){Sentry['setExtra'](_0x4df442(0x152),{'msg':_0x477f43}),Sentry[_0x4df442(0x290)](_0x4b8362);}return![];};exports[a559_0x1e7ddb(0xf8)]=isValidMsg;const Push=_0x9e46c7=>{return _0x9e46c7['pushName'];},verifyQueue=async(_0x57a2d0,_0x953e9,_0x1d67eb,_0x17be52,_0x5d201a)=>{const _0x2c3843=a559_0x1e7ddb,_0x2b0769=_0x1d67eb['companyId'],{queues:_0x4f2358,greetingMessage:_0x263ddd,maxUseBotQueues:_0x5e98d4,timeUseBotQueues:_0x4fb8dc}=await(0x0,ShowWhatsAppService_1[_0x2c3843(0x237)])(_0x57a2d0['id'],_0x1d67eb['companyId']);if(_0x4f2358['length']===0x1){const _0x471a05=(0x0,lodash_1[_0x2c3843(0x22e)])(_0x4f2358);let _0x23490e=![];_0x471a05?.[_0x2c3843(0x15a)]&&(_0x23490e=_0x471a05['options'][_0x2c3843(0x1fc)]>0x0);const _0x20f8ea=await Setting_1[_0x2c3843(0x237)][_0x2c3843(0x282)]({'where':{'key':_0x2c3843(0x174),'companyId':_0x1d67eb['companyId']}});greetingMessageControl['push']({'ticketId':_0x1d67eb['id'],'greetingMessage':_0x263ddd,'companyId':_0x2b0769});if(_0x263ddd[_0x2c3843(0x1fc)]>0x1&&_0x20f8ea?.[_0x2c3843(0x1c5)]===_0x2c3843(0x186)){const _0x1a65cc=await Message_1[_0x2c3843(0x237)][_0x2c3843(0x282)]({'where':{'ticketId':_0x1d67eb['id'],'fromMe':!![],'createdAt':{[sequelize_1['Op'][_0x2c3843(0x19f)]]:(0x0,moment_1[_0x2c3843(0x237)])()['subtract'](0x5,_0x2c3843(0x1d1))[_0x2c3843(0x16b)]()}}});if(_0x1a65cc)return;const _0x5787c0=(0x0,Mustache_1[_0x2c3843(0x237)])(''+_0x263ddd,_0x1d67eb);await _0x57a2d0[_0x2c3843(0x19a)](_0x17be52[_0x2c3843(0x11d)]+'@'+(_0x1d67eb['isGroup']?'g.us':_0x2c3843(0x1de)),{'text':_0x5787c0});}const _0x25f206=await(0x0,ShowWhatsAppService_1['default'])(_0x57a2d0['id'],_0x2b0769),_0x1b3011=_0x4f2358[0x0]?.[_0x2c3843(0x12e)]||_0x25f206['integrationId'];if(!_0x953e9[_0x2c3843(0x12c)][_0x2c3843(0x1a2)]&&!_0x1d67eb[_0x2c3843(0x13b)]&&!(0x0,lodash_1['isNil'])(_0x1b3011)){const _0x38fb1c=await(0x0,ShowQueueIntegrationService_1[_0x2c3843(0x237)])(_0x1b3011,_0x2b0769);await(0x0,exports[_0x2c3843(0x1a1)])(_0x953e9,_0x57a2d0,_0x38fb1c,_0x1d67eb),await _0x1d67eb[_0x2c3843(0x291)]({'useIntegration':!![],'integrationId':_0x38fb1c['id']});}const _0x3be9d9=_0x4f2358[0x0]?.[_0x2c3843(0x15b)]||_0x25f206[_0x2c3843(0x15b)];!_0x953e9[_0x2c3843(0x12c)][_0x2c3843(0x1a2)]&&!_0x1d67eb[_0x2c3843(0x13b)]&&!(0x0,lodash_1[_0x2c3843(0x18c)])(_0x3be9d9)&&(console['log'](_0x2c3843(0x2a6)),await handleOpenAi(_0x953e9,_0x57a2d0,_0x1d67eb,_0x17be52,_0x5d201a),await _0x1d67eb[_0x2c3843(0x291)]({'useIntegration':!![],'promptId':_0x3be9d9}));await(0x0,UpdateTicketService_1[_0x2c3843(0x237)])({'ticketData':{'queueId':_0x471a05?.['id'],'chatbot':_0x23490e,'status':_0x2c3843(0x128)},'ticketId':_0x1d67eb['id'],'companyId':_0x1d67eb[_0x2c3843(0x22a)]});return;}const _0x715b9=_0x953e9?.[_0x2c3843(0x14e)]?.[_0x2c3843(0x193)]?.[_0x2c3843(0x119)]||_0x953e9?.[_0x2c3843(0x14e)]?.[_0x2c3843(0x10c)]?.[_0x2c3843(0x1c1)]?.[_0x2c3843(0x13f)]||_0x953e9?.[_0x2c3843(0x14e)]?.[_0x2c3843(0x107)]?.[_0x2c3843(0x19b)]||_0x953e9?.[_0x2c3843(0x14e)]?.['conversation'];let _0x4eee97=null;if(_0x715b9&&!(0x0,exports[_0x2c3843(0x1fd)])(_0x715b9)||+_0x715b9>_0x4f2358[_0x2c3843(0x1fc)]){const _0x39be47=_0x715b9[_0x2c3843(0x21f)]();for(let _0x254997 of _0x4f2358){if(_0x254997['name']['toLowerCase']()===_0x39be47){_0x4eee97=_0x254997;break;}if(_0x254997[_0x2c3843(0x1ff)]&&_0x254997[_0x2c3843(0x1ff)]['length']>0x0){let _0x3cd87d=_0x254997['keywords']['split'](',\x20');for(let _0x544d34 of _0x3cd87d){if(_0x544d34[_0x2c3843(0x21f)]()==_0x39be47){_0x4eee97=_0x254997;break;}}}}}else _0x4eee97=_0x4f2358[+_0x715b9-0x1];const _0x581e89=await Setting_1['default'][_0x2c3843(0x282)]({'where':{'key':'chatBotType','companyId':_0x2b0769}}),_0x587121=async()=>{const _0x352df2=_0x2c3843;let _0x4c905f='';if(outOfHourMessageControl[_0x352df2(0x1fc)]>0x1388)outOfHourMessageControl=[];_0x4f2358[_0x352df2(0x2ad)]((_0x40aef6,_0x599189)=>{const _0x1ff9a4=_0x352df2;_0x4c905f+=_0x1ff9a4(0x15e)+(_0x599189+0x1)+_0x1ff9a4(0x122)+_0x40aef6[_0x1ff9a4(0x245)]+'\x0a';});if(process[_0x352df2(0x10b)][_0x352df2(0x181)]?.[_0x352df2(0x1fc)]>=0x8){if(_0x1d67eb[_0x352df2(0x268)][_0x352df2(0x11d)]!=process[_0x352df2(0x10b)]['CHATBOT_RESTRICT_NUMBER']){console['trace'](_0x352df2(0x10d));return;}}const _0x176908={'text':(0x0,Mustache_1[_0x352df2(0x237)])('‎'+_0x263ddd+'\x0a\x0a'+_0x4c905f,_0x1d67eb)};await(0x0,UpdateTicketService_1[_0x352df2(0x237)])({'ticketData':{'amountUsedBotQueues':_0x1d67eb[_0x352df2(0x19d)]+0x1},'ticketId':_0x1d67eb['id'],'companyId':_0x1d67eb['companyId']});const _0x24eea7=await _0x57a2d0[_0x352df2(0x19a)](_0x17be52[_0x352df2(0x11d)]+'@'+(_0x1d67eb[_0x352df2(0x13b)]?'g.us':'s.whatsapp.net'),_0x176908);await(0x0,exports[_0x352df2(0x176)])(_0x24eea7,_0x1d67eb,_0x1d67eb[_0x352df2(0x268)]);};if(_0x4eee97){let _0x3a16f0=![];_0x4eee97?.['options']&&(_0x3a16f0=_0x4eee97['options']['length']>0x0);await(0x0,UpdateTicketService_1['default'])({'ticketData':{'queueId':_0x4eee97['id'],'chatbot':_0x3a16f0,'status':_0x2c3843(0x128),'amountUsedBotQueues':0x0},'ticketId':_0x1d67eb['id'],'companyId':_0x1d67eb[_0x2c3843(0x22a)]}),console[_0x2c3843(0x15f)](_0x4eee97[_0x2c3843(0x15a)]);if(_0x4eee97['options'][_0x2c3843(0x1fc)]===0x0){const _0x502cd8=await Queue_1[_0x2c3843(0x237)][_0x2c3843(0x23e)](_0x4eee97['id']),{schedules:_0x53b03c}=_0x502cd8,_0x33bebb=(0x0,moment_1[_0x2c3843(0x237)])(),_0x87a4ae=_0x33bebb[_0x2c3843(0x1c8)](_0x2c3843(0x1b0))[_0x2c3843(0x21f)]();let _0x449cb4;Array['isArray'](_0x53b03c)&&_0x53b03c[_0x2c3843(0x1fc)]>0x0&&(_0x449cb4=_0x53b03c[_0x2c3843(0x142)](_0x59450c=>_0x59450c['weekdayEn']===_0x87a4ae&&_0x59450c['startTime']!==''&&_0x59450c[_0x2c3843(0x1fb)]!==null&&_0x59450c[_0x2c3843(0x215)]!==''&&_0x59450c[_0x2c3843(0x215)]!==null));if(_0x502cd8['outOfHoursMessage']!==null&&_0x502cd8[_0x2c3843(0x265)]!==''&&!(0x0,lodash_1[_0x2c3843(0x18c)])(_0x449cb4)){var _0x5262ac=outOfHourMessageControl[_0x2c3843(0x142)](_0x3dd88=>_0x3dd88[_0x2c3843(0x11f)]===_0x1d67eb['id']||_0x3dd88[_0x2c3843(0x1d9)]===_0x17be52[_0x2c3843(0x11d)]);if(!_0x5262ac||_0x5262ac&&_0x5262ac[_0x2c3843(0x20e)]+0x3e8*0x3c*0x5<new Date()[_0x2c3843(0x154)]()){_0x5262ac&&(outOfHourMessageControl=outOfHourMessageControl[_0x2c3843(0xfa)](_0x43469b=>_0x43469b[_0x2c3843(0x11f)]!==_0x1d67eb['id']),_0x5262ac=null);const _0x2af318=(0x0,moment_1[_0x2c3843(0x237)])(_0x449cb4['startTime'],_0x2c3843(0x1b8)),_0x378c52=(0x0,moment_1[_0x2c3843(0x237)])(_0x449cb4['endTime'],_0x2c3843(0x1b8));outOfHourMessageControl[_0x2c3843(0x184)]({'ticketId':_0x1d67eb['id'],'time':new Date()['getTime']()});if(_0x33bebb[_0x2c3843(0xfe)](_0x2af318)||_0x33bebb['isAfter'](_0x378c52)){const _0x5c1642=(0x0,Mustache_1['default'])('‎\x20'+_0x502cd8[_0x2c3843(0x265)]+_0x2c3843(0x24b),_0x1d67eb),_0x45d8b3=await _0x57a2d0['sendMessage'](_0x17be52[_0x2c3843(0x11d)]+'@'+(_0x1d67eb['isGroup']?_0x2c3843(0x250):_0x2c3843(0x1de)),{'text':_0x5c1642});await(0x0,exports['verifyMessage'])(_0x45d8b3,_0x1d67eb,_0x17be52),await(0x0,UpdateTicketService_1[_0x2c3843(0x237)])({'ticketData':{'queueId':null,'chatbot':_0x3a16f0},'ticketId':_0x1d67eb['id'],'companyId':_0x1d67eb['companyId']}),console['log'](_0x2c3843(0x288));return;}}!_0x5262ac&&outOfHourMessageControl[_0x2c3843(0x184)]({'ticketId':_0x1d67eb['id'],'dest':_0x17be52[_0x2c3843(0x11d)],'time':new Date()[_0x2c3843(0x154)]()});}console[_0x2c3843(0x15f)](_0x4eee97[_0x2c3843(0x12e)]);if(!_0x953e9['key'][_0x2c3843(0x1a2)]&&!_0x1d67eb[_0x2c3843(0x13b)]&&_0x4eee97[_0x2c3843(0x12e)]){const _0x4b8be4=await(0x0,ShowQueueIntegrationService_1[_0x2c3843(0x237)])(_0x4eee97[_0x2c3843(0x12e)],_0x2b0769);await(0x0,exports['handleMessageIntegration'])(_0x953e9,_0x57a2d0,_0x4b8be4,_0x1d67eb),await _0x1d67eb['update']({'useIntegration':!![],'integrationId':_0x4b8be4['id']});}!_0x953e9[_0x2c3843(0x12c)][_0x2c3843(0x1a2)]&&!_0x1d67eb[_0x2c3843(0x13b)]&&!(0x0,lodash_1['isNil'])(_0x4eee97?.[_0x2c3843(0x15b)])&&(await handleOpenAi(_0x953e9,_0x57a2d0,_0x1d67eb,_0x17be52,_0x5d201a),await _0x1d67eb[_0x2c3843(0x291)]({'useIntegration':!![],'promptId':_0x4eee97?.[_0x2c3843(0x15b)]}));const _0x26c222=(0x0,Mustache_1[_0x2c3843(0x237)])('‎'+_0x4eee97[_0x2c3843(0x26d)],_0x1d67eb);if(_0x4eee97[_0x2c3843(0x26d)]){const _0x1e2922=await _0x57a2d0[_0x2c3843(0x19a)](_0x17be52[_0x2c3843(0x11d)]+'@'+(_0x1d67eb['isGroup']?'g.us':_0x2c3843(0x1de)),{'text':_0x26c222});await(0x0,exports[_0x2c3843(0x176)])(_0x1e2922,_0x1d67eb,_0x17be52);if(_0x4eee97[_0x2c3843(0x160)]!==null&&_0x4eee97[_0x2c3843(0x160)]!==''){const _0x5ab89b=path_1[_0x2c3843(0x237)]['resolve'](_0x2c3843(0x150),_0x2c3843(0x14d)+_0x4eee97['companyId'],_0x4eee97[_0x2c3843(0x160)]),_0x19e2a2=await(0x0,SendWhatsAppMedia_1[_0x2c3843(0x16a)])(_0x4eee97[_0x2c3843(0x25c)],_0x5ab89b,null,_0x1d67eb[_0x2c3843(0x22a)]);let _0x4cdaaf=await _0x57a2d0[_0x2c3843(0x19a)](_0x1d67eb[_0x2c3843(0x268)][_0x2c3843(0x11d)]+'@'+(_0x1d67eb[_0x2c3843(0x13b)]?_0x2c3843(0x250):_0x2c3843(0x1de)),{..._0x19e2a2});await verifyMediaMessage(_0x4cdaaf,_0x1d67eb,_0x17be52);}}}}else{if(_0x5e98d4&&_0x5e98d4!==0x0&&_0x1d67eb[_0x2c3843(0x19d)]>=_0x5e98d4)return;const _0x56702e=await(0x0,FindOrCreateATicketTrakingService_1['default'])({'ticketId':_0x1d67eb['id'],'companyId':_0x2b0769});let _0x3cac92=new Date(),_0x1fe874=new Date();if(_0x56702e[_0x2c3843(0x19c)]!==null){_0x3cac92[_0x2c3843(0x11c)](_0x56702e['chatbotAt']['getMinutes']()+Number(_0x4fb8dc));if(_0x56702e[_0x2c3843(0x19c)]!==null&&_0x1fe874<_0x3cac92&&_0x4fb8dc!=='0'&&_0x1d67eb[_0x2c3843(0x19d)]!==0x0)return;}await _0x56702e[_0x2c3843(0x291)]({'updatedAt':new Date()});if(_0x581e89[_0x2c3843(0x1c5)]==='text')return console[_0x2c3843(0x15f)]('botText'),_0x587121();}},verifyRating=_0x9e4ea5=>{const _0x57dcc5=a559_0x1e7ddb;return _0x9e4ea5&&_0x9e4ea5[_0x57dcc5(0x166)]===null&&_0x9e4ea5[_0x57dcc5(0x14a)]!==null&&_0x9e4ea5[_0x57dcc5(0x18e)]!==null;};function a559_0x48e3(){const _0x3d341c=['Throttle','prototype','webhook','companyId','voice','locationMessage','contactMessage','head','../../helpers/SendPresenceStatus','ERR_WAPP_DOWNLOAD_MEDIA','-open','sendMessageImage','filename','verifyQuotedMessage','Pedido','ffmpeg-static','default','PLAYED','getIO','parentId','18635276HetzDi','getStickerMessage','quotedMsg','findByPk','../../models/QueueOption','highlyStructuredMessage','../../models/User','../CompanyService/VerifyCurrentSchedule','groupMetadata','assistant','name','SendPresenceStatus','ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789','../../queues','indexOf','\x20|\x20https://maps.google.com/maps?q=','\x0a\x0a*[\x20#\x20]*\x20-\x20Voltar\x20ao\x20Menu\x20Principal','stanzaId','queueId','type','Erro\x20ao\x20deletar\x20o\x20arquivo:','g.us','Atualização\x20de\x20Status','*Você\x20encerrou\x20este\x20atendimento\x20usando\x20o\x20comando\x20SAIR*.\x0a\x0a\x0aSe\x20você\x20finalizou\x20o\x20atendimento\x20*ANTES*\x20de\x20receber\x20um\x20retorno\x20do\x20operador,\x20ele\x20*NÃO*\x20irá\x20visualizar\x20sua\x20solicitação!\x0a\x0aVocê\x20deve\x20aguardar\x20o\x20retorno\x20do\x20operador\x20e\x20que\x20ele\x20encerre\x20seu\x20atendimento\x20quando\x20necessário.\x0a\x0aUse\x20a\x20opção\x20*SAIR*\x20somente\x20em\x20casos\x20de\x20emergência\x20ou\x20se\x20ficou\x20preso\x20em\x20algum\x20setor.\x0a\x0a\x0aPara\x20iniciar\x20um\x20novo\x20atendimento\x20basta\x20enviar\x20uma\x20nova\x20mensagem!','Mensagem','interactiveMessage','now','getVideoMessage','9939390NvAHyA','messageStubType','viewOnceMessageV2','verifyCampaignMessageAndCloseTicket','handleRating','mediaName','getTextMessage','getQuotedMessage','getListMessage','(((.+)+)+)+$','-ticket','botText','primeiro\x20if','templateButtonReplyMessage','outOfHoursMessage','mkdirSync','temperature','contact','setExtra','choices','makeid','Error\x20converting\x20file:\x20','greetingMessage','SERVER_ACK','emit','__setModuleDefault','queueOptionId','Error:\x20','public/company','messageQueue','Expected\x20bodyMessage\x20to\x20be\x20a\x20string,\x20got:','voiceMessage','maxTokens','getContactsArrayMessage','content','configurable','isBetween','next','downloadContentFromMessage','pollCreationMessageV2','pushName','string','title','findOne','document','writable','senderKeyDistributionMessage','.wav','Failed\x20to\x20fetch\x20contact\x20from\x20ticket:','fora\x20do\x20horario','verifyRating','1351986bThlLb','DispatchCampaign','\x20MBps','proto','changed','quarto\x20if','captureException','update','hydratedHsm','readFileSync','constructor','pipe','unknown','from','getContentType','__importDefault','../../helpers/MakeRandomId','handleMsgAck','subtract','MessageUpdateJob','close','Erro\x20ao\x20salvar\x20ticket!','findAll','__createBinding','jidNormalizedUser','listMessage','Mensagem\x20que\x20Desaparece','replace','\x201286\x20-\x20Entrei\x20na\x20integracao\x20openai.','Amigo(a)','templateMessage','liveLocationMessage','reload','segundo\x20if','getButtonsMessage','forEach','Erro\x20ao\x20salvar\x20mensagem!','getBodyButton','lodash','\x20para\x20identificar\x20o\x20cliente.\x0aSua\x20resposta\x20deve\x20usar\x20no\x20máximo\x20','Failed\x20to\x20fetch\x20queues:','../../libs/cache','productImage','test','status@broadcast','stream-throttle','Error\x20getting\x20message\x20body:','provider','whisper-1','whatsappId','participant','get','WAMessageStubType','randomValue','Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento','concat','isValidMsg','application/pdf','filter','../../utils/logger','../../models/Campaign','mp3','isBefore','documentMessage','Configuration','Enquete\x20não\x20suportada,\x20abra\x20o\x20dispositivo\x20para\x20ler.','externalAdReply','__esModule','E2E_DEVICE_CHANGED','fourRowTemplate','contextInfo','extendedTextMessage','POST','debounce','update!','env','listResponseMessage','chatbot\x20desativado!','defineProperty','../../models/Message','Mensagem\x20inválida\x208!\x20','random','mediaUrl','maxMessages','../../helpers/Mustache','getBodyMessage','split','createdAt','getQuotedMessageId','selectedButtonId','&z=17&hl=pt-BR|','removeNonPrintableChars','setMinutes','number','create','ticketId','join','DESC','\x20]*\x20-\x20','degreesLatitude','error','getCallMessage','documentWithCaptionMessage','audio/mpeg','pending','chatbot',':unreads','mediaType','key','getReactionMessage','integrationId','getLocationMessage','data','botText\x202','prompt','toString','extension','.mp3','slice','chatBotType','complationMessage','call','remoteJid','isGroup','ASC','../../app','body\x20is\x20not\x20a\x20string','selectedRowId','isNull','warn','find','status','catch','getDocumentMessage','count','188QWSVZP','isAfter','gpt-3.5-turbo-1106','userId','viewOnceMessage','path','company','message','url','public','getAudioMessage','Error\x20isValidMsg','createReadStream','getTime','Não\x20consegui\x20enviar\x20o\x20PDF,\x20tente\x20novamente!','add','save','substring','disableBot','options','promptId','keys','allowGroup','*[\x20','trace','mediaPath','resolve','voiceRegion','chmodSync','isNaN','company-','finishedAt','DELIVERY_ACK','campaignQueue','Novo\x20Tipo\x20de\x20Mensagem\x20em\x20isValidMsg','getMessageOptions','toDate','parseToMilliseconds','\x20seconds\x20with\x20an\x20effective\x20speed\x20of\x20','trim','unlinkSync','-closed','promisify','findIndex','values','sendGreetingMessageOneQueues','includes','verifyMessage','speakTextAsync','endLunchTime','5324570UAeYLG','11595uRKuem','fluent-ffmpeg','log','botText\x203','CIPHERTEXT','Status','MESSAGE_EDIT','CHATBOT_RESTRICT_NUMBER','OpenAIApi','Lista','push','queues','enabled','####\x20Nao\x20achou\x20o\x20type\x20em\x20isValidMsg:\x20','ephemeralMessage','./providers','media','messages','isNil','system','ratingAt','mime','259833HZdSpN','n8n','cacheLayer','buttonsResponseMessage','./SendWhatsAppMedia','inActivity','Error\x20handling\x20message\x20ack.\x20Err:\x20','PENDING','toFormat','protocolMessage','sendMessage','text','chatbotAt','amountUsedBotQueues','fromAudioFileOutput','gte','../../models/CampaignShipping','handleMessageIntegration','fromMe','CheckMsgIsGroup','delete','chat','audioMessage','setFfmpegPath','../TicketServices/UpdateTicketService','__importStar','closed','application','hasOwnProperty','../QueueIntegrationServices/ShowQueueIntegrationService','moment','data:image/png;base64,\x20','dddd','toFixed','Menu\x20inicial\x20*[\x200\x20]*\x20Menu\x20anterior','pt-BR-FabioNeural','editedMessage','verifyRecentCampaign','../ContactServices/CreateOrUpdateContactService','public/temp/','HH:mm','terceiro\x20if','EM_ANDAMENTO','1hXobgN','HandleMessageJob','util','button','directPath','productMessage','singleSelectReply','../../models/Queue','application/json','No\x20contact\x20found\x20for\x20this\x20ticket.','value','min','videoMessage','format','sequelize','body','hydratedFourRowTemplate','contacts:','Message','reaction','messages.update','apply','minutes','quotedMessage','../TicketServices/FindOrCreateTicketService','scheduleType','Mensagem\x20editada\x20não\x20encontrada:\x20','\x20de\x20baixar\x20o\x20arquivo\x20','\x0a*[\x20#\x20]*\x20-\x20Menu\x20inicial','reactionMessage','dest','makeRandomId','search','apiKey','getPaymentMessage','s.whatsapp.net','maxUseBotQueues','advertising','pop','fromSubscription','logger','set','useIntegration','option','115904vHccwW','SpeechConfig','imageMessage','9xousLI','rate','@g.us','urlN8N','Escolha\x20uma\x20opção','greetingMediaAttachment','../TicketServices/FindOrCreateATicketTrakingService','102SQyfNY','getViewOnceMessage','then','E2E_IDENTITY_CHANGED','stickerMessage','-appMessage','validaCpfCnpj','subject','Erro\x20ao\x20salvar\x20avaliação!','createChatCompletion','startTime','length','isNumeric','sendMessageLink','keywords','startLunchTime','stringify','updatedAt','header','existsSync','base64','debug','mimetype','microsoft-cognitiveservices-speech-sdk','weekdayEn','user','Convite\x20Revogado','hydratedTemplate','extractMessageContent','time','\x20Download\x20completed\x20in\x20','Nas\x20respostas\x20utilize\x20o\x20nome\x20','speechSynthesisVoiceName','WebMessageInfo','typebot','conversation','endTime','image/jpeg','No\x20result\x20from\x20synthesizer','Importando\x20mensagens!!','map','Mensagem\x20de\x20grupo\x20bloqueada!','./wbotGetMessageFromType','voiceKey','input','contacts','toLowerCase','texto','Erro\x20para\x20responder\x20com\x20audio:\x20','getImageMessage','queue','ack','@whiskeysockets/baileys','contactsArrayMessage'];a559_0x48e3=function(){return _0x3d341c;};return a559_0x48e3();}exports[a559_0x1e7ddb(0x289)]=verifyRating;const handleRating=async(_0x588e7b,_0x55b133,_0x20e535)=>{const _0x439944=a559_0x1e7ddb,_0x34ce2c=(0x0,socket_1[_0x439944(0x239)])();let _0x542244=null;(_0x588e7b?.[_0x439944(0x14e)]?.[_0x439944(0x214)]||_0x588e7b?.[_0x439944(0x14e)]?.['extendedTextMessage'])&&(_0x542244=parseInt(_0x588e7b['message']['conversation']||_0x588e7b[_0x439944(0x14e)][_0x439944(0x107)][_0x439944(0x19b)],0xa)||null);if(!Number[_0x439944(0x164)](_0x542244)&&Number['isInteger'](_0x542244)&&!(0x0,lodash_1[_0x439944(0x140)])(_0x542244)){const {complationMessage:_0x4784e1}=await(0x0,ShowWhatsAppService_1[_0x439944(0x237)])(_0x55b133[_0x439944(0xf1)],_0x55b133['companyId']);let _0x5ada57=_0x542244;_0x542244<0x1&&(_0x5ada57=0x1);_0x542244>0x5&&(_0x5ada57=0x5);await UserRating_1[_0x439944(0x237)][_0x439944(0x11e)]({'ticketId':_0x20e535[_0x439944(0x11f)],'companyId':_0x20e535[_0x439944(0x22a)],'userId':_0x20e535['userId'],'rate':_0x5ada57});if(_0x4784e1){if(completionMessageControl['length']>=0x9c4)completionMessageControl=[];var _0x2d08cc=completionMessageControl[_0x439944(0x142)](_0x1c8e91=>_0x1c8e91[_0x439944(0x11f)]===_0x55b133['id']||_0x1c8e91['dest']===_0x55b133['contact'][_0x439944(0x11d)]);if(!_0x2d08cc||_0x2d08cc&&_0x2d08cc[_0x439944(0x20e)]+0x3e8*0x3c*0x1e<new Date()[_0x439944(0x154)]()){_0x2d08cc&&(completionMessageControl=completionMessageControl['filter'](_0x58560c=>_0x58560c[_0x439944(0x11f)]!==_0x55b133['id']),_0x2d08cc=null);const _0x11a66d=(0x0,Mustache_1[_0x439944(0x237)])('‎'+_0x4784e1,_0x55b133);await(0x0,SendPresenceStatus_1[_0x439944(0x246)])((0x0,wbot_1['getWbot'])(_0x55b133['whatsappId']),_0x55b133[_0x439944(0x268)][_0x439944(0x11d)]+'@'+(_0x55b133['isGroup']?_0x439944(0x250):_0x439944(0x1de))),await(0x0,SendWhatsAppMessage_1[_0x439944(0x237)])({'body':_0x11a66d,'ticket':_0x55b133});}!_0x2d08cc&&completionMessageControl[_0x439944(0x184)]({'ticketId':_0x55b133['id'],'dest':_0x55b133[_0x439944(0x268)]['number'],'time':new Date()['getTime']()});}await _0x20e535[_0x439944(0x291)]({'finishedAt':(0x0,moment_1[_0x439944(0x237)])()[_0x439944(0x16b)](),'ratedAt':(0x0,moment_1[_0x439944(0x237)])()[_0x439944(0x16b)](),'rated':!![]}),await _0x55b133[_0x439944(0x291)]({'queueId':null,'chatbot':null,'queueOptionId':null,'userId':null,'status':_0x439944(0x1aa)}),_0x34ce2c['to'](_0x439944(0x165)+_0x55b133[_0x439944(0x22a)]+'-open')['emit']('company-'+_0x55b133[_0x439944(0x22a)]+_0x439944(0x261),{'action':_0x439944(0x1a4),'ticket':_0x55b133,'ticketId':_0x55b133['id']}),_0x34ce2c['to']('company-'+_0x55b133[_0x439944(0x22a)]+'-'+_0x55b133[_0x439944(0x143)])['to'](_0x55b133['id'][_0x439944(0x133)]())[_0x439944(0x26f)](_0x439944(0x165)+_0x55b133[_0x439944(0x22a)]+_0x439944(0x261),{'action':_0x439944(0x291),'ticket':_0x55b133,'ticketId':_0x55b133['id']});}};exports[a559_0x1e7ddb(0x25b)]=handleRating;const handleChartbot=async(_0x55171b,_0x9f4608,_0x506b08,_0x47d7ec,_0x38aa9c=![])=>{const _0xce299e=a559_0x1e7ddb;if(!_0x55171b[_0xce299e(0x268)][_0xce299e(0x159)]){const _0x222bcd=await Queue_1[_0xce299e(0x237)][_0xce299e(0x23e)](_0x55171b[_0xce299e(0x24d)],{'include':[{'model':QueueOption_1[_0xce299e(0x237)],'as':'options','where':{'parentId':null},'order':[['option',_0xce299e(0x13c)],[_0xce299e(0x117),_0xce299e(0x13c)]]}]}),_0x3f0cc6=_0x9f4608?.['message']?.[_0xce299e(0x193)]?.['selectedButtonId']||_0x9f4608?.[_0xce299e(0x14e)]?.[_0xce299e(0x10c)]?.[_0xce299e(0x1c1)]?.[_0xce299e(0x13f)]||_0x9f4608?.[_0xce299e(0x14e)]?.[_0xce299e(0x107)]?.[_0xce299e(0x19b)]||_0x9f4608?.[_0xce299e(0x14e)]?.[_0xce299e(0x214)];if(_0x3f0cc6=='#'&&(!_0x55171b[_0xce299e(0x14a)]||_0x55171b['status']==_0xce299e(0x128))){console[_0xce299e(0x15f)]('##\x20if'),await _0x55171b[_0xce299e(0x291)]({'queueOptionId':null,'chatbot':![],'queueId':null,'amountUsedBotQueues':0x0}),await verifyQueue(_0x506b08,_0x9f4608,_0x55171b,_0x55171b[_0xce299e(0x268)]);return;}if(!(0x0,lodash_1['isNil'])(_0x222bcd)&&!(0x0,lodash_1[_0xce299e(0x18c)])(_0x55171b[_0xce299e(0x271)])&&_0x3f0cc6=='0'){console['trace'](_0xce299e(0x263));const _0x29879c=await QueueOption_1[_0xce299e(0x237)][_0xce299e(0x23e)](_0x55171b['queueOptionId']);await _0x55171b[_0xce299e(0x291)]({'queueOptionId':_0x29879c?.[_0xce299e(0x23a)],'amountUsedBotQueues':0x0});}else{if(!(0x0,lodash_1['isNil'])(_0x222bcd)&&!(0x0,lodash_1[_0xce299e(0x18c)])(_0x55171b[_0xce299e(0x271)])){console[_0xce299e(0x15f)](_0xce299e(0x2ab));const _0xb4579f=await QueueOption_1['default']['count']({'where':{'parentId':_0x55171b[_0xce299e(0x271)]}});let _0x20f9b3={};_0xb4579f==0x1?_0x20f9b3=await QueueOption_1[_0xce299e(0x237)][_0xce299e(0x282)]({'where':{'parentId':_0x55171b['queueOptionId']}}):(console[_0xce299e(0x15f)](_0xce299e(0x1b9)),_0x20f9b3=await QueueOption_1[_0xce299e(0x237)][_0xce299e(0x282)]({'where':{[sequelize_1['Op']['or']]:[{'option':_0x3f0cc6||''},{'title':_0x3f0cc6||''}],'parentId':_0x55171b[_0xce299e(0x271)]}})),_0x20f9b3&&await _0x55171b[_0xce299e(0x291)]({'queueOptionId':_0x20f9b3?.['id'],'amountUsedBotQueues':0x0});}else{if(!(0x0,lodash_1[_0xce299e(0x18c)])(_0x222bcd)&&(0x0,lodash_1[_0xce299e(0x18c)])(_0x55171b[_0xce299e(0x271)])&&!_0x38aa9c){console[_0xce299e(0x15f)](_0xce299e(0x28f));const _0x5d498e=_0x222bcd?.['options']['find'](_0x2af9b3=>_0x2af9b3[_0xce299e(0x1e6)]==_0x3f0cc6||_0x2af9b3[_0xce299e(0x281)][_0xce299e(0x21f)]()==_0x3f0cc6[_0xce299e(0x21f)]());if(_0x5d498e)await _0x55171b['update']({'queueOptionId':_0x5d498e?.['id'],'amountUsedBotQueues':0x0});else{if(_0x47d7ec[_0xce299e(0x1df)]&&_0x47d7ec[_0xce299e(0x1df)]!==0x0&&_0x55171b[_0xce299e(0x19d)]>=_0x47d7ec[_0xce299e(0x1df)])return;await _0x55171b[_0xce299e(0x291)]({'amountUsedBotQueues':_0x55171b['amountUsedBotQueues']+0x1});}}else{if(_0x47d7ec[_0xce299e(0x1df)]&&_0x47d7ec['maxUseBotQueues']!==0x0&&_0x55171b[_0xce299e(0x19d)]>=_0x47d7ec[_0xce299e(0x1df)])return;await _0x55171b['update']({'amountUsedBotQueues':_0x55171b[_0xce299e(0x19d)]+0x1});}}}await _0x55171b['reload']();if(!(0x0,lodash_1[_0xce299e(0x18c)])(_0x222bcd)&&(0x0,lodash_1[_0xce299e(0x18c)])(_0x55171b[_0xce299e(0x271)])){const _0x3917b7=await QueueOption_1[_0xce299e(0x237)][_0xce299e(0x2a0)]({'where':{'queueId':_0x55171b[_0xce299e(0x24d)],'parentId':null},'order':[[_0xce299e(0x1e6),_0xce299e(0x13c)],[_0xce299e(0x117),_0xce299e(0x13c)]]}),_0x82980=_0x55171b[_0xce299e(0x22a)],_0x2709c5=await Setting_1['default'][_0xce299e(0x282)]({'where':{'key':_0xce299e(0x137),'companyId':_0x82980}}),_0x426b1a=async()=>{const _0x451a56=_0xce299e,_0x3550c2=[];_0x3917b7[_0x451a56(0x2ad)]((_0x293fe4,_0x5a19c4)=>{const _0x18e381=_0x451a56;_0x3550c2[_0x18e381(0x184)]({'buttonId':''+_0x293fe4[_0x18e381(0x1e6)],'buttonText':{'displayText':_0x293fe4[_0x18e381(0x281)]},'type':0x4});}),_0x3550c2[_0x451a56(0x184)]({'buttonId':'#','buttonText':{'displayText':_0x451a56(0x1b2)},'type':0x4});const _0x251d3b={'text':(0x0,Mustache_1['default'])('‎'+_0x222bcd[_0x451a56(0x26d)],_0x55171b),'buttons':_0x3550c2,'footer':'DAUMZAP','headerType':0x1},_0x27d905=await _0x506b08[_0x451a56(0x19a)](_0x55171b[_0x451a56(0x268)]['number']+'@'+(_0x55171b[_0x451a56(0x13b)]?_0x451a56(0x250):_0x451a56(0x1de)),_0x251d3b);await(0x0,exports[_0x451a56(0x176)])(_0x27d905,_0x55171b,_0x55171b['contact']);},_0x1337a6=async()=>{const _0x4aff06=_0xce299e;let _0x2f4b66='';console['trace'](_0x4aff06(0x262)),console[_0x4aff06(0x17c)](_0x222bcd['mediaPath']),_0x3917b7[_0x4aff06(0x2ad)]((_0x563aa6,_0x37b823)=>{const _0x3bf746=_0x4aff06;_0x2f4b66+=_0x3bf746(0x15e)+_0x563aa6['option']+_0x3bf746(0x122)+_0x563aa6['title']+'\x0a';}),_0x2f4b66+=_0x4aff06(0x1d7);const _0x1f82d6={'text':(0x0,Mustache_1[_0x4aff06(0x237)])('‎'+_0x222bcd['greetingMessage']+'\x0a\x0a'+_0x2f4b66,_0x55171b)};let _0x12593e;if(!_0x222bcd[_0x4aff06(0x160)])_0x12593e=await _0x506b08[_0x4aff06(0x19a)](_0x55171b[_0x4aff06(0x268)][_0x4aff06(0x11d)]+'@'+(_0x55171b[_0x4aff06(0x13b)]?_0x4aff06(0x250):_0x4aff06(0x1de)),_0x1f82d6),await(0x0,exports['verifyMessage'])(_0x12593e,_0x55171b,_0x55171b[_0x4aff06(0x268)]);else{const _0x1fd90b=path_1[_0x4aff06(0x237)][_0x4aff06(0x161)](_0x4aff06(0x150),'company'+_0x55171b[_0x4aff06(0x22a)],_0x222bcd[_0x4aff06(0x160)]),_0x3add62=await(0x0,SendWhatsAppMedia_1[_0x4aff06(0x16a)])(_0x1f82d6['text'],_0x1fd90b,_0x1f82d6['text'],_0x55171b[_0x4aff06(0x22a)]);_0x12593e=await _0x506b08[_0x4aff06(0x19a)](_0x55171b['contact'][_0x4aff06(0x11d)]+'@'+(_0x55171b[_0x4aff06(0x13b)]?_0x4aff06(0x250):_0x4aff06(0x1de)),{..._0x3add62}),await verifyMediaMessage(_0x12593e,_0x55171b,_0x55171b['contact']);}};if(_0x2709c5[_0xce299e(0x1c5)]===_0xce299e(0x1be)&&QueueOption_1['default'][_0xce299e(0x1fc)]<=0x4)return _0x426b1a();if(_0x2709c5[_0xce299e(0x1c5)]===_0xce299e(0x19b))return console[_0xce299e(0x15f)](_0xce299e(0x262)),_0x1337a6();if(_0x2709c5[_0xce299e(0x1c5)]===_0xce299e(0x1be)&&QueueOption_1['default'][_0xce299e(0x1fc)]>0x4)return console['trace'](_0xce299e(0x262)),_0x1337a6();}else{if(!(0x0,lodash_1[_0xce299e(0x18c)])(_0x222bcd)&&!(0x0,lodash_1['isNil'])(_0x55171b[_0xce299e(0x271)])){const _0x4be329=await QueueOption_1[_0xce299e(0x237)][_0xce299e(0x23e)](_0x55171b[_0xce299e(0x271)]),_0x182435=await QueueOption_1['default'][_0xce299e(0x2a0)]({'where':{'parentId':_0x55171b[_0xce299e(0x271)]},'order':[[_0xce299e(0x1e6),_0xce299e(0x13c)],[_0xce299e(0x117),_0xce299e(0x13c)]]});if(_0x182435['length']===0x0){const _0x470260={'text':(0x0,Mustache_1['default'])('‎'+_0x4be329['message'],_0x55171b)},_0x6d21f9=await _0x506b08['sendMessage'](_0x55171b[_0xce299e(0x268)][_0xce299e(0x11d)]+'@'+(_0x55171b[_0xce299e(0x13b)]?_0xce299e(0x250):_0xce299e(0x1de)),_0x470260);await(0x0,exports['verifyMessage'])(_0x6d21f9,_0x55171b,_0x55171b[_0xce299e(0x268)]),await _0x55171b[_0xce299e(0x291)]({'queueOptionId':null,'chatbot':![]});return;}if(_0x182435[_0xce299e(0x1fc)]>-0x1){const _0x7b3a19=_0x55171b[_0xce299e(0x22a)],_0x4cfd55=await Setting_1[_0xce299e(0x237)][_0xce299e(0x282)]({'where':{'key':'chatBotType','companyId':_0x7b3a19}}),_0x3b0adb=async()=>{const _0x14e1de=_0xce299e,_0x279da6=[],_0x34b7eb=_0x55171b[_0x14e1de(0x22a)],_0x4d7441=await getQueues(_0x34b7eb),_0x205fa0=await getContactFromTicket(_0x55171b['id']);_0x4d7441[_0x14e1de(0x2ad)]((_0x5911f2,_0x42b0de)=>{const _0x1af847=_0x14e1de;_0x279da6[_0x1af847(0x184)]({'title':'['+(_0x42b0de+0x1)+']\x20-\x20'+_0x5911f2['name'],'rowId':''+(_0x42b0de+0x1)});});const _0x2de90d=[{'rows':_0x279da6}],_0x4c199c={'text':(0x0,Mustache_1[_0x14e1de(0x237)])('‎'+_0x4be329[_0x14e1de(0x14e)],_0x55171b),'title':_0x14e1de(0x183),'buttonText':_0x14e1de(0x1ee),'sections':_0x2de90d};await sleep(0x3e8);const _0x2ef3a7=await _0x506b08[_0x14e1de(0x19a)]('\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+_0x205fa0[_0x14e1de(0x11d)]+'@'+(_0x55171b['isGroup']?'g.us':_0x14e1de(0x1de)),_0x4c199c);await(0x0,exports[_0x14e1de(0x176)])(_0x2ef3a7,_0x55171b,_0x55171b['contact']);},_0x39e813=async()=>{const _0x35f773=_0xce299e,_0x4b36e0=[];_0x182435[_0x35f773(0x2ad)]((_0x21e036,_0x31aef8)=>{const _0x5e8e37=_0x35f773;_0x4b36e0[_0x5e8e37(0x184)]({'buttonId':''+_0x21e036[_0x5e8e37(0x1e6)],'buttonText':{'displayText':_0x21e036[_0x5e8e37(0x281)]},'type':0x4});}),_0x4b36e0[_0x35f773(0x184)]({'buttonId':'#','buttonText':{'displayText':'Menu\x20inicial\x20*[\x200\x20]*\x20Menu\x20anterior'},'type':0x4});const _0x31f468={'text':(0x0,Mustache_1[_0x35f773(0x237)])('‎'+_0x4be329[_0x35f773(0x14e)],_0x55171b),'buttons':_0x4b36e0,'headerType':0x4};if(process[_0x35f773(0x10b)][_0x35f773(0x181)]?.['length']>=0x8){if(_0x55171b[_0x35f773(0x268)][_0x35f773(0x11d)]!=process[_0x35f773(0x10b)][_0x35f773(0x181)]){console['trace'](_0x35f773(0x10d));return;}}if(!_0x4be329[_0x35f773(0x160)]){const _0x29fd3b=await _0x506b08[_0x35f773(0x19a)](_0x55171b[_0x35f773(0x268)][_0x35f773(0x11d)]+'@'+(_0x55171b[_0x35f773(0x13b)]?_0x35f773(0x250):_0x35f773(0x1de)),_0x31f468);await(0x0,exports['verifyMessage'])(_0x29fd3b,_0x55171b,_0x55171b[_0x35f773(0x268)]);}else{const _0x246da0=path_1[_0x35f773(0x237)][_0x35f773(0x161)](_0x35f773(0x150),_0x35f773(0x14d)+_0x55171b[_0x35f773(0x22a)],_0x4be329[_0x35f773(0x160)]),_0x3e38f3=await(0x0,SendWhatsAppMedia_1[_0x35f773(0x16a)])(_0x4be329[_0x35f773(0x25c)],_0x246da0,_0x31f468[_0x35f773(0x19b)],_0x55171b[_0x35f773(0x22a)]);let _0x44c9eb=await _0x506b08[_0x35f773(0x19a)](_0x55171b[_0x35f773(0x268)][_0x35f773(0x11d)]+'@'+(_0x55171b[_0x35f773(0x13b)]?_0x35f773(0x250):_0x35f773(0x1de)),{..._0x3e38f3});await verifyMediaMessage(_0x44c9eb,_0x55171b,_0x55171b['contact']);}const _0x3b5ddf=await _0x506b08[_0x35f773(0x19a)](_0x55171b['contact'][_0x35f773(0x11d)]+'@'+(_0x55171b['isGroup']?_0x35f773(0x250):'s.whatsapp.net'),_0x31f468);await(0x0,exports[_0x35f773(0x176)])(_0x3b5ddf,_0x55171b,_0x55171b['contact']);},_0x266ae6=async()=>{const _0x5f2857=_0xce299e;let _0x4508c6='';_0x182435['forEach']((_0xfda8a3,_0x5bd739)=>{const _0x44fa9d=a559_0x5dfb;_0x4508c6+=_0x44fa9d(0x15e)+_0xfda8a3['option']+'\x20]*\x20-\x20'+_0xfda8a3[_0x44fa9d(0x281)]+'\x0a';}),_0x4508c6+='\x0a*[\x200\x20]*\x20-\x20Menu\x20anterior',_0x4508c6+=_0x5f2857(0x1d7);const _0x3d662f={'text':(0x0,Mustache_1[_0x5f2857(0x237)])('‎'+_0x4be329[_0x5f2857(0x14e)]+'\x0a\x0a'+_0x4508c6,_0x55171b)};if(process['env'][_0x5f2857(0x181)]?.[_0x5f2857(0x1fc)]>=0x8){if(_0x55171b['contact'][_0x5f2857(0x11d)]!=process[_0x5f2857(0x10b)][_0x5f2857(0x181)]){console[_0x5f2857(0x15f)](_0x5f2857(0x10d));return;}}if(!_0x4be329[_0x5f2857(0x160)]){const _0x5e387b=await _0x506b08[_0x5f2857(0x19a)](_0x55171b[_0x5f2857(0x268)]['number']+'@'+(_0x55171b['isGroup']?_0x5f2857(0x250):'s.whatsapp.net'),_0x3d662f);await(0x0,exports[_0x5f2857(0x176)])(_0x5e387b,_0x55171b,_0x55171b[_0x5f2857(0x268)]);}else{const _0x7fb2c3=path_1['default'][_0x5f2857(0x161)](_0x5f2857(0x150),_0x5f2857(0x14d)+_0x55171b[_0x5f2857(0x22a)],_0x4be329['mediaPath']),_0x368bf0=await(0x0,SendWhatsAppMedia_1[_0x5f2857(0x16a)])(_0x4be329[_0x5f2857(0x25c)],_0x7fb2c3,_0x3d662f[_0x5f2857(0x19b)],_0x55171b['companyId']);let _0x3f8e4a=await _0x506b08['sendMessage'](_0x55171b['contact']['number']+'@'+(_0x55171b[_0x5f2857(0x13b)]?'g.us':_0x5f2857(0x1de)),{..._0x368bf0});await verifyMediaMessage(_0x3f8e4a,_0x55171b,_0x55171b[_0x5f2857(0x268)]);}};if(_0x4cfd55[_0xce299e(0x1c5)]==='list')return _0x3b0adb();if(_0x4cfd55[_0xce299e(0x1c5)]===_0xce299e(0x1be)&&QueueOption_1[_0xce299e(0x237)][_0xce299e(0x1fc)]<=0x4)return _0x39e813();if(_0x4cfd55['value']==='text')return console[_0xce299e(0x15f)](_0xce299e(0x17d)),_0x266ae6();if(_0x4cfd55[_0xce299e(0x1c5)]==='button'&&QueueOption_1[_0xce299e(0x237)][_0xce299e(0x1fc)]>0x4)return console[_0xce299e(0x15f)](_0xce299e(0x131)),_0x266ae6();}}}}},handleMessageIntegration=async(_0x33d140,_0x382866,_0x584208,_0x5b9994)=>{const _0x41f451=a559_0x1e7ddb;if(process['env'][_0x41f451(0x181)]){if(_0x5b9994['contact']['number']!=process[_0x41f451(0x10b)][_0x41f451(0x181)]){console['log'](_0x41f451(0x10d));return;}}const _0x818ae3=getTypeMessage(_0x33d140);if(_0x584208['type']===_0x41f451(0x191)||_0x584208[_0x41f451(0x24e)]===_0x41f451(0x229)){if(_0x584208?.[_0x41f451(0x1ed)]){const _0x18b580={'method':_0x41f451(0x108),'url':_0x584208?.[_0x41f451(0x1ed)],'headers':{'Content-Type':_0x41f451(0x1c3)},'json':_0x33d140};try{(0x0,request_1[_0x41f451(0x237)])(_0x18b580,function(_0x1f8df6,_0x3362d2){const _0x3b4604=_0x41f451;if(_0x1f8df6)throw new Error(_0x1f8df6);else console[_0x3b4604(0x17c)](_0x3362d2['body']);});}catch(_0x54b4b2){throw new Error(_0x54b4b2);}}}else _0x584208['type']===_0x41f451(0x213)&&await(0x0,typebotListener_1[_0x41f451(0x237)])({'ticket':_0x5b9994,'msg':_0x33d140,'wbot':_0x382866,'typebot':_0x584208});};exports['handleMessageIntegration']=handleMessageIntegration;const messageContainsMedia=_0x3266ba=>{const _0xe9e7c2=a559_0x1e7ddb;return _0x3266ba['message']?.['imageMessage']||_0x3266ba[_0xe9e7c2(0x14e)]?.['audioMessage']||_0x3266ba[_0xe9e7c2(0x14e)]?.[_0xe9e7c2(0x1c7)]||_0x3266ba[_0xe9e7c2(0x14e)]?.[_0xe9e7c2(0x1f5)]||_0x3266ba[_0xe9e7c2(0x14e)]?.['documentMessage']||_0x3266ba['message']?.[_0xe9e7c2(0x126)]?.['message']?.[_0xe9e7c2(0xff)]||_0x3266ba[_0xe9e7c2(0x14e)]?.['ephemeralMessage']?.[_0xe9e7c2(0x14e)]?.[_0xe9e7c2(0x1a6)]||_0x3266ba[_0xe9e7c2(0x14e)]?.[_0xe9e7c2(0x188)]?.[_0xe9e7c2(0x14e)]?.[_0xe9e7c2(0xff)]||_0x3266ba[_0xe9e7c2(0x14e)]?.[_0xe9e7c2(0x188)]?.[_0xe9e7c2(0x14e)]?.[_0xe9e7c2(0x1c7)]||_0x3266ba[_0xe9e7c2(0x14e)]?.[_0xe9e7c2(0x188)]?.[_0xe9e7c2(0x14e)]?.[_0xe9e7c2(0x1f5)]||_0x3266ba[_0xe9e7c2(0x14e)]?.['ephemeralMessage']?.[_0xe9e7c2(0x14e)]?.[_0xe9e7c2(0x1e9)]||_0x3266ba[_0xe9e7c2(0x14e)]?.['viewOnceMessage']?.[_0xe9e7c2(0x14e)]?.[_0xe9e7c2(0x1e9)]||_0x3266ba[_0xe9e7c2(0x14e)]?.[_0xe9e7c2(0x14b)]?.[_0xe9e7c2(0x14e)]?.[_0xe9e7c2(0x1c7)]||_0x3266ba[_0xe9e7c2(0x14e)]?.[_0xe9e7c2(0x188)]?.['message']?.[_0xe9e7c2(0x14b)]?.[_0xe9e7c2(0x14e)]?.[_0xe9e7c2(0x1e9)]||_0x3266ba[_0xe9e7c2(0x14e)]?.[_0xe9e7c2(0x188)]?.[_0xe9e7c2(0x14e)]?.[_0xe9e7c2(0x14b)]?.[_0xe9e7c2(0x14e)]?.[_0xe9e7c2(0x1c7)]||_0x3266ba['message']?.[_0xe9e7c2(0x188)]?.[_0xe9e7c2(0x14e)]?.[_0xe9e7c2(0x14b)]?.[_0xe9e7c2(0x14e)]?.['audioMessage']||_0x3266ba[_0xe9e7c2(0x14e)]?.[_0xe9e7c2(0x188)]?.['message']?.[_0xe9e7c2(0x14b)]?.[_0xe9e7c2(0x14e)]?.['documentMessage']||_0x3266ba[_0xe9e7c2(0x14e)]?.[_0xe9e7c2(0x126)]?.[_0xe9e7c2(0x14e)]?.[_0xe9e7c2(0xff)]||_0x3266ba[_0xe9e7c2(0x14e)]?.['templateMessage']?.[_0xe9e7c2(0x20c)]?.['imageMessage']||_0x3266ba['message']?.[_0xe9e7c2(0x2a8)]?.[_0xe9e7c2(0x20c)]?.[_0xe9e7c2(0xff)]||_0x3266ba[_0xe9e7c2(0x14e)]?.[_0xe9e7c2(0x2a8)]?.[_0xe9e7c2(0x20c)]?.[_0xe9e7c2(0x1c7)]||_0x3266ba['message']?.['templateMessage']?.[_0xe9e7c2(0x1cb)]?.['imageMessage']||_0x3266ba[_0xe9e7c2(0x14e)]?.[_0xe9e7c2(0x2a8)]?.[_0xe9e7c2(0x1cb)]?.[_0xe9e7c2(0xff)]||_0x3266ba[_0xe9e7c2(0x14e)]?.[_0xe9e7c2(0x2a8)]?.[_0xe9e7c2(0x1cb)]?.[_0xe9e7c2(0x1c7)]||_0x3266ba[_0xe9e7c2(0x14e)]?.['templateMessage']?.['fourRowTemplate']?.[_0xe9e7c2(0x1e9)]||_0x3266ba['message']?.[_0xe9e7c2(0x2a8)]?.['fourRowTemplate']?.[_0xe9e7c2(0xff)]||_0x3266ba[_0xe9e7c2(0x14e)]?.[_0xe9e7c2(0x2a8)]?.[_0xe9e7c2(0x105)]?.[_0xe9e7c2(0x1c7)]||_0x3266ba['message']?.[_0xe9e7c2(0x254)]?.[_0xe9e7c2(0x203)]?.[_0xe9e7c2(0x1e9)]||_0x3266ba[_0xe9e7c2(0x14e)]?.[_0xe9e7c2(0x254)]?.['header']?.[_0xe9e7c2(0xff)]||_0x3266ba[_0xe9e7c2(0x14e)]?.[_0xe9e7c2(0x254)]?.[_0xe9e7c2(0x203)]?.['videoMessage']||_0x3266ba[_0xe9e7c2(0x14e)]?.[_0xe9e7c2(0x240)]?.[_0xe9e7c2(0x292)]?.[_0xe9e7c2(0x20c)]?.[_0xe9e7c2(0xff)]||_0x3266ba[_0xe9e7c2(0x14e)]?.['highlyStructuredMessage']?.[_0xe9e7c2(0x292)]?.[_0xe9e7c2(0x20c)]?.[_0xe9e7c2(0x1c7)]||_0x3266ba[_0xe9e7c2(0x14e)]?.[_0xe9e7c2(0x240)]?.[_0xe9e7c2(0x292)]?.[_0xe9e7c2(0x20c)]?.[_0xe9e7c2(0x1e9)]||_0x3266ba[_0xe9e7c2(0x14e)]?.[_0xe9e7c2(0x240)]?.['hydratedHsm']?.[_0xe9e7c2(0x20c)]?.[_0xe9e7c2(0x22c)];},handleMessage=async(_0x29f20b,_0x21aa2f,_0x207fe8,_0x5d72c1=![])=>{const _0x52ec2b=a559_0x1e7ddb;if(_0x5d72c1){console[_0x52ec2b(0x17c)](_0x52ec2b(0x218));let _0x5ee359=_0x29f20b[_0x52ec2b(0x12c)]['id'],_0x4f4e7f=await Message_1[_0x52ec2b(0x237)][_0x52ec2b(0x146)]({'where':{'id':_0x5ee359}});if(_0x4f4e7f>0x0){await new Promise(_0x8dc349=>setTimeout(_0x8dc349,0x96));return;}else await new Promise(_0x15d020=>setTimeout(_0x15d020,0x14a));}let _0x4446d4;if(!(0x0,exports['isValidMsg'])(_0x29f20b)){console['log']('Mensagem\x20inválida!'),console[_0x52ec2b(0x17c)](_0x29f20b);return;}_0x29f20b[_0x52ec2b(0x14e)]?.[_0x52ec2b(0x188)]&&(_0x29f20b[_0x52ec2b(0x14e)]=_0x29f20b['message'][_0x52ec2b(0x188)][_0x52ec2b(0x14e)]);try{let _0x44fb80;const _0x2b756e=_0x29f20b[_0x52ec2b(0x12c)][_0x52ec2b(0x13a)]?.['endsWith'](_0x52ec2b(0x1ec)),_0x2c1127=await Setting_1[_0x52ec2b(0x237)][_0x52ec2b(0x282)]({'where':{'companyId':_0x207fe8,'key':_0x52ec2b(0x1a3)}});if(_0x2c1127?.[_0x52ec2b(0x1c5)]===_0x52ec2b(0x186)&&_0x2b756e){console[_0x52ec2b(0x17c)](_0x52ec2b(0x21a));return;}let _0x2bd4ca=(0x0,exports[_0x52ec2b(0x115)])(_0x29f20b);const _0x4be39a=getTypeMessage(_0x29f20b);typeof _0x2bd4ca==='string'&&(_0x2bd4ca=_0x2bd4ca[_0x52ec2b(0x2a5)](/\u200c/,''));const _0x2ab92a=messageContainsMedia(_0x29f20b);if(_0x29f20b[_0x52ec2b(0x12c)][_0x52ec2b(0x1a2)]){if(!_0x2ab92a&&_0x4be39a!==_0x52ec2b(0x214)&&_0x4be39a!==_0x52ec2b(0x107)&&_0x4be39a!=='vcard'&&_0x4be39a!==_0x52ec2b(0x22d)&&_0x4be39a!==_0x52ec2b(0x188)&&_0x4be39a!==_0x52ec2b(0x199)&&_0x4be39a!==_0x52ec2b(0x1d8)&&_0x4be39a!==_0x52ec2b(0x14b)&&_0x4be39a!==_0x52ec2b(0x22c)&&_0x4be39a!=='hydratedContentText'&&_0x4be39a!==_0x52ec2b(0x1e0)){console['trace'](_0x4be39a);return;}}const _0x38911f=await(0x0,ShowWhatsAppService_1[_0x52ec2b(0x237)])(_0x21aa2f['id'],_0x207fe8);let _0x39d512,_0x555b8c=await getContactMessage(_0x29f20b,_0x21aa2f);_0x44fb80=await verifyContact(_0x555b8c,_0x21aa2f,_0x207fe8);if(_0x2b756e){if(!_0x38911f[_0x52ec2b(0x15d)])return;try{const _0x46f923=await _0x21aa2f[_0x52ec2b(0x243)](_0x29f20b[_0x52ec2b(0x12c)][_0x52ec2b(0x13a)]),_0x4619b5={'id':_0x46f923['id'],'name':_0x46f923[_0x52ec2b(0x1f8)]};_0x39d512=await verifyContact(_0x4619b5,_0x21aa2f,_0x207fe8);}catch(_0x52be7c){console['log']('Erro\x20ao\x20buscar\x20grupo!'),console[_0x52ec2b(0x17c)](_0x52be7c);return;}}let _0x54d739=0x0;if(_0x29f20b[_0x52ec2b(0x12c)]['fromMe'])await cache_1[_0x52ec2b(0x192)][_0x52ec2b(0x1e4)]('contacts:'+_0x44fb80['id']+_0x52ec2b(0x12a),'0');else{const _0x3b2843=await cache_1[_0x52ec2b(0x192)]['get'](_0x52ec2b(0x1cc)+_0x44fb80['id']+':unreads');_0x54d739=+_0x3b2843+0x1,await cache_1[_0x52ec2b(0x192)][_0x52ec2b(0x1e4)](_0x52ec2b(0x1cc)+_0x44fb80['id']+_0x52ec2b(0x12a),''+_0x54d739);}const _0x23e6e1=await(0x0,FindOrCreateTicketService_1['default'])(_0x44fb80,_0x21aa2f['id'],_0x54d739,_0x207fe8,_0x39d512,_0x5d72c1),_0xf95a01=await(0x0,FindOrCreateATicketTrakingService_1[_0x52ec2b(0x237)])({'ticketId':_0x23e6e1['id'],'companyId':_0x207fe8,'whatsappId':_0x38911f?.['id']});_0xf95a01[_0x52ec2b(0x28e)](_0x52ec2b(0x202),!![]),await _0xf95a01['update']({'updatedAt':new Date()}),await(0x0,providers_1[_0x52ec2b(0xef)])(_0x23e6e1,_0x29f20b,_0x207fe8,_0x44fb80,_0x21aa2f);if(_0x38911f['complationMessage']&&_0x54d739===0x0){const _0x23645e=await Message_1['default']['findOne']({'where':{'contactId':_0x44fb80['id'],'companyId':_0x207fe8},'order':[['createdAt',_0x52ec2b(0x121)]]});if((0x0,Mustache_1[_0x52ec2b(0x237)])(_0x38911f[_0x52ec2b(0x138)],_0x23e6e1)[_0x52ec2b(0x16e)]()[_0x52ec2b(0x21f)]()===_0x23645e?.['body'][_0x52ec2b(0x16e)]()['toLowerCase']())return;}if(_0x2bd4ca=='#'&&!_0x5d72c1&&(!_0x23e6e1[_0x52ec2b(0x14a)]||_0x23e6e1['status']==_0x52ec2b(0x128))){await _0x23e6e1[_0x52ec2b(0x291)]({'queueOptionId':null,'chatbot':![],'queueId':null,'amountUsedBotQueues':0x0}),await verifyQueue(_0x21aa2f,_0x29f20b,_0x23e6e1,_0x23e6e1[_0x52ec2b(0x268)]);return;}try{if(!_0x29f20b[_0x52ec2b(0x12c)]['fromMe']&&!_0x5d72c1){if(_0x2bd4ca!=null&&typeof _0x2bd4ca!==_0x52ec2b(0x280)){console['log'](_0x2bd4ca),console[_0x52ec2b(0x15f)](_0x52ec2b(0x275),typeof _0x2bd4ca);return;}if(_0x2bd4ca?.['toUpperCase']()==='SAIR'&&_0x23e6e1[_0x52ec2b(0x143)]!=_0x52ec2b(0x1aa)){await(0x0,SendPresenceStatus_1['SendPresenceStatus'])(_0x21aa2f,_0x23e6e1[_0x52ec2b(0x268)][_0x52ec2b(0x11d)]+'@'+(_0x23e6e1[_0x52ec2b(0x13b)]?_0x52ec2b(0x250):'s.whatsapp.net'));const _0x1151d9=await _0x21aa2f[_0x52ec2b(0x19a)](_0x23e6e1[_0x52ec2b(0x268)][_0x52ec2b(0x11d)]+'@'+(_0x23e6e1['isGroup']?_0x52ec2b(0x250):_0x52ec2b(0x1de)),{'text':_0x52ec2b(0x252)});await(0x0,exports[_0x52ec2b(0x176)])(_0x1151d9,_0x23e6e1,_0x23e6e1['contact']),await(0x0,UpdateTicketService_1[_0x52ec2b(0x237)])({'ticketData':{'queueId':null,'status':_0x52ec2b(0x1aa)},'ticketId':_0x23e6e1['id'],'companyId':_0x23e6e1[_0x52ec2b(0x22a)]}),await _0x23e6e1[_0x52ec2b(0x2aa)]();return;}}}catch(_0x1c2161){console[_0x52ec2b(0x17c)](_0x52ec2b(0xe4)),console[_0x52ec2b(0x17c)](_0x1c2161),Sentry[_0x52ec2b(0x290)](_0x1c2161);}try{await _0x23e6e1[_0x52ec2b(0x291)]({'fromMe':_0x29f20b[_0x52ec2b(0x12c)][_0x52ec2b(0x1a2)]});}catch(_0x5db7ce){console[_0x52ec2b(0x17c)](_0x52ec2b(0x29f)),console[_0x52ec2b(0x17c)](_0x5db7ce),Sentry[_0x52ec2b(0x290)](_0x5db7ce);}try{if(!_0x29f20b['key'][_0x52ec2b(0x1a2)]){if((0x0,exports[_0x52ec2b(0x289)])(_0xf95a01)){await(0x0,exports[_0x52ec2b(0x25b)])(_0x29f20b,_0x23e6e1,_0xf95a01),console[_0x52ec2b(0x17c)](_0x52ec2b(0x110)+_0x29f20b);return;}}}catch(_0x15ab18){console[_0x52ec2b(0x17c)](_0x52ec2b(0x1f9)),Sentry[_0x52ec2b(0x290)](_0x15ab18),console[_0x52ec2b(0x17c)](_0x15ab18);}_0x2ab92a?_0x4446d4=await verifyMediaMessage(_0x29f20b,_0x23e6e1,_0x44fb80):await(0x0,exports[_0x52ec2b(0x176)])(_0x29f20b,_0x23e6e1,_0x44fb80);const _0x3ed9f6=await(0x0,VerifyCurrentSchedule_1['default'])(_0x207fe8),_0x536b5c=await Setting_1[_0x52ec2b(0x237)][_0x52ec2b(0x282)]({'where':{'companyId':_0x207fe8,'key':_0x52ec2b(0x1d4)}});if(!_0x29f20b[_0x52ec2b(0x12c)]['fromMe']&&_0x536b5c&&!_0x5d72c1)await handleOutOfHour(_0x21aa2f,_0x23e6e1,_0x536b5c,_0x44fb80,_0x3ed9f6,_0x38911f);!_0x23e6e1['queue']&&!_0x2b756e&&!_0x29f20b['key'][_0x52ec2b(0x1a2)]&&!_0x23e6e1[_0x52ec2b(0x14a)]&&!(0x0,lodash_1[_0x52ec2b(0x18c)])(_0x38911f[_0x52ec2b(0x15b)])&&!_0x5d72c1&&await handleOpenAi(_0x29f20b,_0x21aa2f,_0x23e6e1,_0x44fb80,_0x4446d4);if(!_0x29f20b[_0x52ec2b(0x12c)][_0x52ec2b(0x1a2)]&&!_0x23e6e1[_0x52ec2b(0x13b)]&&!_0x23e6e1['queue']&&!_0x23e6e1[_0x52ec2b(0x20a)]&&_0x23e6e1[_0x52ec2b(0x129)]&&!(0x0,lodash_1['isNil'])(_0x38911f['integrationId'])&&!_0x23e6e1[_0x52ec2b(0x1e5)]&&!_0x5d72c1){const _0x3f3e31=await(0x0,ShowQueueIntegrationService_1['default'])(_0x38911f[_0x52ec2b(0x12e)],_0x207fe8);await(0x0,exports['handleMessageIntegration'])(_0x29f20b,_0x21aa2f,_0x3f3e31,_0x23e6e1);return;}!_0x2b756e&&!_0x29f20b[_0x52ec2b(0x12c)][_0x52ec2b(0x1a2)]&&!_0x23e6e1['userId']&&!(0x0,lodash_1[_0x52ec2b(0x18c)])(_0x23e6e1[_0x52ec2b(0x15b)])&&_0x23e6e1[_0x52ec2b(0x1e5)]&&!_0x5d72c1&&await handleOpenAi(_0x29f20b,_0x21aa2f,_0x23e6e1,_0x44fb80,_0x4446d4);if(!_0x29f20b[_0x52ec2b(0x12c)][_0x52ec2b(0x1a2)]&&!_0x23e6e1[_0x52ec2b(0x13b)]&&!_0x23e6e1['userId']&&_0x23e6e1['integrationId']&&_0x23e6e1[_0x52ec2b(0x1e5)]&&!_0x5d72c1){const _0x1bc7fc=await(0x0,ShowQueueIntegrationService_1[_0x52ec2b(0x237)])(_0x23e6e1[_0x52ec2b(0x12e)],_0x207fe8);await(0x0,exports[_0x52ec2b(0x1a1)])(_0x29f20b,_0x21aa2f,_0x1bc7fc,_0x23e6e1);}!_0x23e6e1[_0x52ec2b(0x223)]&&!_0x23e6e1[_0x52ec2b(0x13b)]&&!_0x29f20b[_0x52ec2b(0x12c)][_0x52ec2b(0x1a2)]&&!_0x23e6e1[_0x52ec2b(0x14a)]&&_0x38911f[_0x52ec2b(0x185)][_0x52ec2b(0x1fc)]>=0x1&&!_0x23e6e1[_0x52ec2b(0x1e5)]&&!_0x5d72c1&&(await verifyQueue(_0x21aa2f,_0x29f20b,_0x23e6e1,_0x44fb80),_0xf95a01['changed'](_0x52ec2b(0x19c),!![]),_0xf95a01[_0x52ec2b(0x28e)](_0x52ec2b(0x202),!![]),await _0xf95a01['update']({'chatbotAt':(0x0,moment_1[_0x52ec2b(0x237)])()[_0x52ec2b(0x16b)](),'updatedAt':new Date()}));const _0x2fc923=_0x23e6e1[_0x52ec2b(0x223)]===null;await _0x23e6e1['reload']();if(!_0x5d72c1&&_0x38911f['greetingMessage'])await greetingMessage(_0x21aa2f,_0x23e6e1,_0x29f20b,_0x38911f,_0x2b756e);_0x38911f[_0x52ec2b(0x185)][_0x52ec2b(0x1fc)]==0x1&&_0x23e6e1[_0x52ec2b(0x223)]&&!_0x5d72c1&&(_0x23e6e1[_0x52ec2b(0x129)]&&!_0x29f20b[_0x52ec2b(0x12c)][_0x52ec2b(0x1a2)]&&!_0x23e6e1[_0x52ec2b(0x14a)]&&await handleChartbot(_0x23e6e1,_0x29f20b,_0x21aa2f,_0x38911f)),_0x38911f[_0x52ec2b(0x185)][_0x52ec2b(0x1fc)]>0x1&&_0x23e6e1[_0x52ec2b(0x223)]&&!_0x5d72c1&&(_0x23e6e1[_0x52ec2b(0x129)]&&!_0x29f20b[_0x52ec2b(0x12c)][_0x52ec2b(0x1a2)]&&!_0x23e6e1[_0x52ec2b(0x14a)]&&await handleChartbot(_0x23e6e1,_0x29f20b,_0x21aa2f,_0x38911f,_0x2fc923));}catch(_0x576b39){console[_0x52ec2b(0x17c)](_0x576b39),Sentry[_0x52ec2b(0x290)](_0x576b39),logger_1[_0x52ec2b(0x1e3)][_0x52ec2b(0x124)]('Error\x20handling\x20whatsapp\x20message:\x20Err:\x20'+_0x576b39);}};exports['handleMessage']=handleMessage;const handleOutOfHour=async(_0x4b2f4a,_0x44a37e,_0x448a08,_0x5cab10,_0xe41312,_0x116967)=>{const _0xa8375f=a559_0x1e7ddb;try{if(outOfHourMessageControl[_0xa8375f(0x1fc)]>0x1388)outOfHourMessageControl=[];let _0x2d764f=outOfHourMessageControl[_0xa8375f(0x142)](_0x39367a=>_0x39367a['ticketId']===_0x44a37e['id']||_0x39367a[_0xa8375f(0x1d9)]===_0x5cab10[_0xa8375f(0x11d)]);if(_0x448a08[_0xa8375f(0x1c5)]===_0xa8375f(0x14d)&&!(0x0,lodash_1[_0xa8375f(0x18c)])(_0xe41312)&&_0x116967[_0xa8375f(0x265)]&&(!_0xe41312||_0xe41312[_0xa8375f(0x195)]===![])){if(!_0x2d764f||_0x2d764f&&_0x2d764f['time']+0x3e8*0x3c*0x5<new Date()[_0xa8375f(0x154)]()){_0x2d764f&&(outOfHourMessageControl=outOfHourMessageControl[_0xa8375f(0xfa)](_0xf2e71e=>_0xf2e71e[_0xa8375f(0x11f)]!==_0x44a37e['id']),_0x2d764f=null);if(!_0x2d764f)outOfHourMessageControl[_0xa8375f(0x184)]({'ticketId':_0x44a37e['id'],'dest':_0x5cab10[_0xa8375f(0x11d)],'time':new Date()[_0xa8375f(0x154)]()});const _0x530b20='‎\x20'+_0x116967['outOfHoursMessage'],_0x522103=(0x0,Debounce_1[_0xa8375f(0x109)])(async()=>{const _0x35095d=_0xa8375f;await _0x4b2f4a[_0x35095d(0x19a)](_0x44a37e[_0x35095d(0x268)][_0x35095d(0x11d)]+'@'+(_0x44a37e['isGroup']?_0x35095d(0x250):'s.whatsapp.net'),{'text':_0x530b20});},(0x0,queues_1[_0xa8375f(0xf5)])(0x5dc,0xdac),_0x44a37e['id']);_0x522103();return;}}if(_0x448a08['value']===_0xa8375f(0x223)&&_0x44a37e[_0xa8375f(0x24d)]!==null){const _0x59824b=await Queue_1[_0xa8375f(0x237)]['findByPk'](_0x44a37e[_0xa8375f(0x24d)]),{schedules:_0x3fe6a9}=_0x59824b,_0x3e5fbc=(0x0,moment_1[_0xa8375f(0x237)])(),_0x40a86e=_0x3e5fbc[_0xa8375f(0x1c8)]('dddd')[_0xa8375f(0x21f)]();let _0x19842e=null;Array['isArray'](_0x3fe6a9)&&_0x3fe6a9[_0xa8375f(0x1fc)]>0x0&&(_0x19842e=_0x3fe6a9[_0xa8375f(0x142)](_0x2fa5bd=>_0x2fa5bd[_0xa8375f(0x209)]===_0x40a86e&&_0x2fa5bd[_0xa8375f(0x1fb)]!==''&&_0x2fa5bd[_0xa8375f(0x1fb)]!==null&&_0x2fa5bd['endTime']!==''&&_0x2fa5bd['endTime']!==null));if(_0x448a08[_0xa8375f(0x1c5)]===_0xa8375f(0x223)&&_0x59824b[_0xa8375f(0x265)]!==null&&_0x59824b[_0xa8375f(0x265)]!==''&&!(0x0,lodash_1['isNil'])(_0x19842e)){const _0x223958=(0x0,moment_1[_0xa8375f(0x237)])(_0x19842e[_0xa8375f(0x1fb)],'HH:mm'),_0x42e73f=(0x0,moment_1[_0xa8375f(0x237)])(_0x19842e['endTime'],_0xa8375f(0x1b8));let _0xe773c0=_0x3e5fbc['isBefore'](_0x223958)||_0x3e5fbc[_0xa8375f(0x148)](_0x42e73f);if(!_0xe773c0){if(_0x19842e[_0xa8375f(0x200)]&&_0x19842e[_0xa8375f(0x178)]){const _0x10cfdf=(0x0,moment_1['default'])(_0x19842e['startLunchTime'],'HH:mm'),_0x154763=(0x0,moment_1[_0xa8375f(0x237)])(_0x19842e[_0xa8375f(0x178)],_0xa8375f(0x1b8));_0xe773c0=_0x3e5fbc[_0xa8375f(0x27b)](_0x10cfdf,_0x154763);}}if(_0xe773c0){if(!_0x2d764f||_0x2d764f&&_0x2d764f[_0xa8375f(0x20e)]+0x3e8*0x3c*0x1e<new Date()[_0xa8375f(0x154)]()){const _0x38c267=_0x59824b[_0xa8375f(0x265)],_0x56b8f4=(0x0,Debounce_1[_0xa8375f(0x109)])(async()=>{const _0xd73d2c=_0xa8375f;await _0x4b2f4a[_0xd73d2c(0x19a)](_0x44a37e['contact'][_0xd73d2c(0x11d)]+'@'+(_0x44a37e[_0xd73d2c(0x13b)]?'g.us':_0xd73d2c(0x1de)),{'text':_0x38c267});},(0x0,queues_1[_0xa8375f(0xf5)])(0x3e8,0xbb8),_0x44a37e['id']);_0x56b8f4();return;}if(!_0x2d764f)outOfHourMessageControl[_0xa8375f(0x184)]({'ticketId':_0x44a37e['id'],'dest':_0x5cab10[_0xa8375f(0x11d)],'time':new Date()['getTime']()});}}}}catch(_0x1d606b){Sentry['captureException'](_0x1d606b),console[_0xa8375f(0x17c)](_0x1d606b);}},greetingMessage=async(_0x129608,_0x56a412,_0xbf84de,_0x339154,_0x109db7)=>{const _0x188614=a559_0x1e7ddb;if(!_0x339154?.[_0x188614(0x185)]?.[_0x188614(0x1fc)]&&!_0x56a412[_0x188614(0x14a)]&&!_0x109db7&&!_0xbf84de[_0x188614(0x12c)][_0x188614(0x1a2)]){if(process['env'][_0x188614(0x181)]?.[_0x188614(0x1fc)]>=0x8){if(_0x56a412[_0x188614(0x268)][_0x188614(0x11d)]!=process[_0x188614(0x10b)]['CHATBOT_RESTRICT_NUMBER'])return;}if(greetingMessageControl['length']>0x1388)greetingMessageControl=[];var _0x352b5b=greetingMessageControl[_0x188614(0x142)](_0x5b3e95=>_0x5b3e95[_0x188614(0x11f)]===_0x56a412['id']||_0x5b3e95['dest']===_0x56a412[_0x188614(0x268)][_0x188614(0x11d)]);if(_0x352b5b&&_0x352b5b[_0x188614(0x20e)]+0x3e8*0x3c*0x5>=new Date()[_0x188614(0x154)]())return;const _0x5694cc=await Message_1[_0x188614(0x237)]['findOne']({'where':{'ticketId':_0x56a412['id'],'fromMe':!![],'createdAt':{[sequelize_1['Op'][_0x188614(0x19f)]]:(0x0,moment_1[_0x188614(0x237)])()[_0x188614(0x29c)](0x5,_0x188614(0x1d1))[_0x188614(0x16b)]()}}});if(_0x5694cc)return;const _0x457e3d=(0x0,Debounce_1[_0x188614(0x109)])(async()=>{const _0xe822e7=_0x188614;if(!_0x339154[_0xe822e7(0x1ef)])await _0x129608[_0xe822e7(0x19a)](_0x56a412['contact'][_0xe822e7(0x11d)]+'@'+(_0x56a412[_0xe822e7(0x13b)]?_0xe822e7(0x250):_0xe822e7(0x1de)),{'text':(0x0,Mustache_1['default'])(_0x339154[_0xe822e7(0x26d)],_0x56a412)});else{const _0x14c584=path_1['default'][_0xe822e7(0x161)](_0xe822e7(0x150),_0xe822e7(0x14d)+_0x56a412[_0xe822e7(0x22a)],_0x339154[_0xe822e7(0x1ef)]),_0x505cef=await(0x0,SendWhatsAppMedia_1[_0xe822e7(0x16a)])(_0x339154[_0xe822e7(0x1ef)],_0x14c584,_0x339154[_0xe822e7(0x26d)],_0x56a412[_0xe822e7(0x22a)]);await _0x129608[_0xe822e7(0x19a)](_0x56a412['contact'][_0xe822e7(0x11d)]+'@'+(_0x56a412[_0xe822e7(0x13b)]?'g.us':_0xe822e7(0x1de)),{..._0x505cef});}},0x3e8,_0x56a412['id']);_0x457e3d();return;}},handleMsgAck=async(_0x140039,_0x67ab1d)=>{const _0xa5a3e9=a559_0x1e7ddb,_0x1cbb25=(0x0,socket_1['getIO'])();try{const _0x225b33=await Message_1[_0xa5a3e9(0x237)][_0xa5a3e9(0x23e)](_0x140039[_0xa5a3e9(0x12c)]['id'],{'include':[_0xa5a3e9(0x268),{'model':Message_1[_0xa5a3e9(0x237)],'as':_0xa5a3e9(0x23d),'include':[_0xa5a3e9(0x268)]}]});if(!_0x225b33){console[_0xa5a3e9(0x17c)](_0x140039),console['log']('Mensagem\x20não\x20encontrada!');return;}await _0x225b33['update']({'ack':_0x67ab1d}),_0x1cbb25['to'](_0x225b33[_0xa5a3e9(0x11f)][_0xa5a3e9(0x133)]())['emit'](_0xa5a3e9(0x165)+_0x225b33[_0xa5a3e9(0x22a)]+_0xa5a3e9(0x1f6),{'action':_0xa5a3e9(0x291),'message':_0x225b33});}catch(_0x5ad46e){Sentry[_0xa5a3e9(0x290)](_0x5ad46e),logger_1['logger'][_0xa5a3e9(0x124)](_0xa5a3e9(0x196)+_0x5ad46e);}};exports[a559_0x1e7ddb(0x29b)]=handleMsgAck;const verifyRecentCampaign=async(_0x1145b8,_0x422d51)=>{const _0x2426aa=a559_0x1e7ddb;if(!_0x1145b8[_0x2426aa(0x12c)][_0x2426aa(0x1a2)]){const _0x1ce49c=_0x1145b8[_0x2426aa(0x12c)][_0x2426aa(0x13a)][_0x2426aa(0x2a5)](/\D/g,''),_0x26c476=await Campaign_1[_0x2426aa(0x237)][_0x2426aa(0x2a0)]({'where':{'companyId':_0x422d51,'status':_0x2426aa(0x1ba),'confirmation':!![]}});if(_0x26c476){const _0x23bf2f=_0x26c476[_0x2426aa(0x219)](_0x13be30=>_0x13be30['id']),_0x4720e3=await CampaignShipping_1[_0x2426aa(0x237)][_0x2426aa(0x282)]({'where':{'campaignId':{[sequelize_1['Op']['in']]:_0x23bf2f},'number':_0x1ce49c,'confirmation':null}});_0x4720e3&&(await _0x4720e3['update']({'confirmedAt':(0x0,moment_1['default'])(),'confirmation':!![]}),await queues_1[_0x2426aa(0x168)][_0x2426aa(0x156)](_0x2426aa(0x28b),{'campaignShippingId':_0x4720e3['id'],'campaignId':_0x4720e3['campaignId']},{'delay':(0x0,queues_1[_0x2426aa(0x16c)])((0x0,queues_1[_0x2426aa(0xf5)])(0x0,0xa))}));}}};exports[a559_0x1e7ddb(0x1b5)]=verifyRecentCampaign;const verifyCampaignMessageAndCloseTicket=async(_0x1b312e,_0x5628b4)=>{const _0xb04ff2=a559_0x1e7ddb,_0x259e7e=(0x0,socket_1[_0xb04ff2(0x239)])(),_0x11999e=(0x0,exports[_0xb04ff2(0x115)])(_0x1b312e),_0x34f427=/\u200c/[_0xb04ff2(0xeb)](_0x11999e);if(_0x1b312e[_0xb04ff2(0x12c)][_0xb04ff2(0x1a2)]&&_0x34f427){const _0x4dc135=await Message_1[_0xb04ff2(0x237)][_0xb04ff2(0x282)]({'where':{'id':_0x1b312e[_0xb04ff2(0x12c)]['id'],'companyId':_0x5628b4}}),_0x162170=await Ticket_1[_0xb04ff2(0x237)]['findByPk'](_0x4dc135[_0xb04ff2(0x11f)]);await _0x162170[_0xb04ff2(0x291)]({'status':_0xb04ff2(0x1aa)}),_0x259e7e['to']('company-'+_0x162170[_0xb04ff2(0x22a)]+_0xb04ff2(0x231))[_0xb04ff2(0x26f)](_0xb04ff2(0x165)+_0x162170[_0xb04ff2(0x22a)]+_0xb04ff2(0x261),{'action':_0xb04ff2(0x1a4),'ticket':_0x162170,'ticketId':_0x162170['id']}),_0x259e7e['to'](_0xb04ff2(0x165)+_0x5628b4+'-'+_0x162170[_0xb04ff2(0x143)])['to'](_0x162170['id'][_0xb04ff2(0x133)]())['emit'](_0xb04ff2(0x165)+_0x162170[_0xb04ff2(0x22a)]+_0xb04ff2(0x261),{'action':_0xb04ff2(0x291),'ticket':_0x162170,'ticketId':_0x162170['id']});}};exports[a559_0x1e7ddb(0x25a)]=verifyCampaignMessageAndCloseTicket;const filterMessages=_0x114f6c=>{const _0x3437f2=a559_0x1e7ddb;if([baileys_1[_0x3437f2(0xf4)]['REVOKE'],baileys_1['WAMessageStubType'][_0x3437f2(0x104)],baileys_1[_0x3437f2(0xf4)][_0x3437f2(0x1f4)],baileys_1[_0x3437f2(0xf4)][_0x3437f2(0x17e)]]['includes'](_0x114f6c['messageStubType']))return![];return!![];},wbotMessageListener=async(_0xe474c1,_0x143003,_0x1e82be)=>{const _0x18d6c3=a559_0x1e7ddb;_0xe474c1['ev']['on']('messages.upsert',async _0xcca8e7=>{const _0x417bab=a559_0x5dfb,_0x28a83c=_0xcca8e7[_0x417bab(0x18b)][_0x417bab(0xfa)](filterMessages);if(!_0x28a83c)return;await app_1[_0x417bab(0x237)][_0x417bab(0xf3)]('queues')['messageQueue'][_0x417bab(0x156)](_0x417bab(0x1bc),{'whatsappId':_0x1e82be['id'],'messages':_0x28a83c,'companyId':_0x143003},{'removeOnComplete':!![],'attempts':0x3});}),_0xe474c1['ev']['on'](_0x18d6c3(0x1cf),async _0x12c490=>{const _0x403970=_0x18d6c3;if(_0x12c490[_0x403970(0x1fc)]===0x0)return;await app_1[_0x403970(0x237)]['get'](_0x403970(0x185))[_0x403970(0x274)][_0x403970(0x156)](_0x403970(0x29d),{'whatsappId':_0x1e82be['id'],'messageUpdate':_0x12c490,'companyId':_0x143003},{'removeOnComplete':!![],'attempts':0x3,'delay':0x64});}),_0xe474c1['ev']['on']('groups.update',async _0x39a2b9=>{const _0x1a81b7=_0x18d6c3;console[_0x1a81b7(0x17c)](_0x39a2b9);if(_0x39a2b9['length']===0x0)return;for(const _0x1e3b7b of _0x39a2b9){const _0x34f6f5=_0x1e3b7b['id'][_0x1a81b7(0x116)]('@')[0x0],_0x477b5e=_0x1e3b7b['subject']||_0x34f6f5,_0x23d0b2={'name':_0x477b5e,'number':_0x34f6f5,'isGroup':!![],'companyId':_0x143003,'remoteJid':_0x1e3b7b['id'],'whatsappId':_0xe474c1['id']};await(0x0,CreateOrUpdateContactService_1[_0x1a81b7(0x237)])(_0x23d0b2,_0xe474c1,_0x1e3b7b['id']);}});};exports['wbotMessageListener']=wbotMessageListener;