'use strict';const a583_0x19fc31=a583_0x5e92;(function(_0x34b15c,_0x562770){const _0x2036c4=a583_0x5e92,_0x48eda1=_0x34b15c();while(!![]){try{const _0x3d87c1=-parseInt(_0x2036c4(0x1ff))/0x1*(-parseInt(_0x2036c4(0x212))/0x2)+parseInt(_0x2036c4(0x203))/0x3+-parseInt(_0x2036c4(0x246))/0x4*(-parseInt(_0x2036c4(0x1d8))/0x5)+-parseInt(_0x2036c4(0x282))/0x6*(parseInt(_0x2036c4(0x29e))/0x7)+-parseInt(_0x2036c4(0x231))/0x8+parseInt(_0x2036c4(0x2af))/0x9*(-parseInt(_0x2036c4(0x1d3))/0xa)+parseInt(_0x2036c4(0x2a8))/0xb*(parseInt(_0x2036c4(0x1d5))/0xc);if(_0x3d87c1===_0x562770)break;else _0x48eda1['push'](_0x48eda1['shift']());}catch(_0x580d6a){_0x48eda1['push'](_0x48eda1['shift']());}}}(a583_0x66c5,0x2ccb8));var __createBinding=this&&this[a583_0x19fc31(0x215)]||(Object[a583_0x19fc31(0x25e)]?function(_0x13671a,_0xd31100,_0xad7584,_0x5a620f){const _0x3749c4=a583_0x19fc31;if(_0x5a620f===undefined)_0x5a620f=_0xad7584;var _0x7730fc=Object[_0x3749c4(0x219)](_0xd31100,_0xad7584);(!_0x7730fc||(_0x3749c4(0x265)in _0x7730fc?!_0xd31100['__esModule']:_0x7730fc[_0x3749c4(0x227)]||_0x7730fc[_0x3749c4(0x23b)]))&&(_0x7730fc={'enumerable':!![],'get':function(){return _0xd31100[_0xad7584];}}),Object[_0x3749c4(0x2b6)](_0x13671a,_0x5a620f,_0x7730fc);}:function(_0x56bdab,_0xb34e4c,_0x1c6f59,_0x3a1c3e){if(_0x3a1c3e===undefined)_0x3a1c3e=_0x1c6f59;_0x56bdab[_0x3a1c3e]=_0xb34e4c[_0x1c6f59];}),__setModuleDefault=this&&this[a583_0x19fc31(0x1c4)]||(Object[a583_0x19fc31(0x25e)]?function(_0x820fef,_0x3596a1){const _0x2fb51e=a583_0x19fc31;Object[_0x2fb51e(0x2b6)](_0x820fef,_0x2fb51e(0x272),{'enumerable':!![],'value':_0x3596a1});}:function(_0x5611d3,_0x51b4f3){const _0x1b6265=a583_0x19fc31;_0x5611d3[_0x1b6265(0x272)]=_0x51b4f3;}),__importStar=this&&this[a583_0x19fc31(0x205)]||(function(){const _0x54d149=(function(){let _0x2b0308=!![];return function(_0x86bb3d,_0x2e7b3a){const _0x32de7f=_0x2b0308?function(){if(_0x2e7b3a){const _0x5578b8=_0x2e7b3a['apply'](_0x86bb3d,arguments);return _0x2e7b3a=null,_0x5578b8;}}:function(){};return _0x2b0308=![],_0x32de7f;};}()),_0x23baec=_0x54d149(this,function(){const _0x586b05=a583_0x5e92;return _0x23baec['toString']()[_0x586b05(0x1cc)](_0x586b05(0x21b))['toString']()['constructor'](_0x23baec)[_0x586b05(0x1cc)](_0x586b05(0x21b));});_0x23baec();var _0x548b6b=function(_0xa5e0e5){const _0x40f174=a583_0x5e92;return _0x548b6b=Object[_0x40f174(0x26a)]||function(_0x4f3824){const _0xc4036a=_0x40f174;var _0x4c7c45=[];for(var _0x19cc84 in _0x4f3824)if(Object[_0xc4036a(0x1c2)][_0xc4036a(0x1ec)][_0xc4036a(0x279)](_0x4f3824,_0x19cc84))_0x4c7c45[_0x4c7c45[_0xc4036a(0x27f)]]=_0x19cc84;return _0x4c7c45;},_0x548b6b(_0xa5e0e5);};return function(_0x20eeb1){const _0xa75354=a583_0x5e92;if(_0x20eeb1&&_0x20eeb1[_0xa75354(0x248)])return _0x20eeb1;var _0xb0ab80={};if(_0x20eeb1!=null){for(var _0xb77f0e=_0x548b6b(_0x20eeb1),_0x35f66c=0x0;_0x35f66c<_0xb77f0e[_0xa75354(0x27f)];_0x35f66c++)if(_0xb77f0e[_0x35f66c]!==_0xa75354(0x272))__createBinding(_0xb0ab80,_0x20eeb1,_0xb77f0e[_0x35f66c]);}return __setModuleDefault(_0xb0ab80,_0x20eeb1),_0xb0ab80;};}()),__importDefault=this&&this[a583_0x19fc31(0x292)]||function(_0x4c6873){return _0x4c6873&&_0x4c6873['__esModule']?_0x4c6873:{'default':_0x4c6873};};Object[a583_0x19fc31(0x2b6)](exports,a583_0x19fc31(0x248),{'value':!![]}),exports[a583_0x19fc31(0x270)]=exports[a583_0x19fc31(0x238)]=exports[a583_0x19fc31(0x1f2)]=exports[a583_0x19fc31(0x274)]=exports[a583_0x19fc31(0x233)]=void 0x0,exports['makeid']=makeid;const path_1=__importDefault(require(a583_0x19fc31(0x28c))),Sentry=__importStar(require(a583_0x19fc31(0x26e))),lodash_1=require('lodash'),baileys_1=require(a583_0x19fc31(0x23c)),async_mutex_1=require(a583_0x19fc31(0x220)),sequelize_1=require(a583_0x19fc31(0x21d)),moment_1=__importDefault(require(a583_0x19fc31(0x296))),Contact_1=__importDefault(require(a583_0x19fc31(0x235))),Ticket_1=__importDefault(require('../../models/Ticket')),Message_1=__importDefault(require(a583_0x19fc31(0x1f3))),socket_1=require(a583_0x19fc31(0x21e)),logger_1=require(a583_0x19fc31(0x2a0)),FindOrCreateTicketService_1=__importDefault(require(a583_0x19fc31(0x26f))),ShowWhatsAppService_1=__importDefault(require(a583_0x19fc31(0x275))),UpdateTicketService_1=__importDefault(require('../TicketServices/UpdateTicketService')),Mustache_1=__importDefault(require(a583_0x19fc31(0x269))),TicketTraking_1=__importDefault(require('../../models/TicketTraking')),UserRating_1=__importDefault(require(a583_0x19fc31(0x1f9))),SendWhatsAppMessage_1=__importDefault(require(a583_0x19fc31(0x244))),Queue_1=__importDefault(require(a583_0x19fc31(0x1cf))),QueueOption_1=__importDefault(require('../../models/QueueOption')),VerifyCurrentSchedule_1=__importDefault(require(a583_0x19fc31(0x213))),User_1=__importDefault(require(a583_0x19fc31(0x1fb))),Setting_1=__importDefault(require(a583_0x19fc31(0x2b0))),cache_1=require(a583_0x19fc31(0x24b)),Debounce_1=require(a583_0x19fc31(0x223)),SendWhatsAppMedia_1=__importDefault(require(a583_0x19fc31(0x29d))),CheckSettings_1=require(a583_0x19fc31(0x23e)),Whatsapp_1=__importDefault(require(a583_0x19fc31(0x254))),simpleObjectCache_1=require(a583_0x19fc31(0x24a)),ShowQueueIntegrationService_1=__importDefault(require(a583_0x19fc31(0x25a))),typebotListener_1=__importDefault(require(a583_0x19fc31(0x1e4))),VerifyHandlers_1=require(a583_0x19fc31(0x2ab)),GetHandlers_1=require(a583_0x19fc31(0x24e)),wbotMutex=new async_mutex_1['Mutex'](),ackMutex=new async_mutex_1[(a583_0x19fc31(0x245))](),groupContactCache=new simpleObjectCache_1[(a583_0x19fc31(0x276))](0x3e8*0x1e,logger_1[a583_0x19fc31(0x283)]),outOfHoursCache=new simpleObjectCache_1[(a583_0x19fc31(0x276))](0x3e8*0x3c*0x5,logger_1[a583_0x19fc31(0x283)]);function makeid(_0x4c558a){const _0x1320d6=a583_0x19fc31;let _0xe0fc05='';const _0x49354f=_0x1320d6(0x290),_0x365eb3=_0x49354f[_0x1320d6(0x27f)];for(let _0x45b197=0x0;_0x45b197<_0x4c558a;_0x45b197+=0x1){_0xe0fc05+=_0x49354f[_0x1320d6(0x2a7)](Math[_0x1320d6(0x2a9)](Math['random']()*_0x365eb3));}return _0xe0fc05;}const isValidMsg=_0x3cf64d=>{const _0x3542e2=a583_0x19fc31;if(_0x3cf64d['key'][_0x3542e2(0x281)]===_0x3542e2(0x1e9))return![];try{const _0x8ca850=(0x0,GetHandlers_1[_0x3542e2(0x207)])(_0x3cf64d);if(!_0x8ca850)return![];const _0x572471=_0x8ca850===_0x3542e2(0x1e2)||_0x8ca850===_0x3542e2(0x250)||_0x8ca850===_0x3542e2(0x20c)||_0x8ca850===_0x3542e2(0x242)||_0x8ca850==='videoMessage'||_0x8ca850===_0x3542e2(0x1d0)||_0x8ca850==='documentMessage'||_0x8ca850==='documentWithCaptionMessage'||_0x8ca850===_0x3542e2(0x211)||_0x8ca850==='buttonsResponseMessage'||_0x8ca850==='buttonsMessage'||_0x8ca850===_0x3542e2(0x209)||_0x8ca850==='locationMessage'||_0x8ca850==='liveLocationMessage'||_0x8ca850===_0x3542e2(0x2b4)||_0x8ca850===_0x3542e2(0x2ad)||_0x8ca850==='mediaMessage'||_0x8ca850==='contactsArrayMessage'||_0x8ca850==='reactionMessage'||_0x8ca850==='ephemeralMessage'||_0x8ca850===_0x3542e2(0x1d6)||_0x8ca850==='listResponseMessage'||_0x8ca850==='listMessage'||_0x8ca850==='templateMessage'||_0x8ca850==='viewOnceMessage'||_0x8ca850===_0x3542e2(0x1e0);return!_0x572471&&(logger_1['logger']['warn'](_0x3542e2(0x249)+_0x8ca850+'\x0a'+JSON['stringify'](_0x3cf64d?.[_0x3542e2(0x1e5)])),Sentry[_0x3542e2(0x26b)](_0x3542e2(0x1e7),{'BodyMsg':_0x3cf64d[_0x3542e2(0x1e5)],'msg':_0x3cf64d,'msgType':_0x8ca850}),Sentry[_0x3542e2(0x256)](new Error(_0x3542e2(0x2a1)))),!!_0x572471;}catch(_0x132f56){return Sentry['setExtra'](_0x3542e2(0x28e),{'msg':_0x3cf64d}),Sentry[_0x3542e2(0x256)](_0x132f56),![];}},handleRating=async(_0x2c4526,_0xe7e2d3,_0x53efb3)=>{const _0x21eeb2=a583_0x19fc31,_0x2ea90e=(0x0,socket_1[_0x21eeb2(0x1f4)])();let _0x492d49=null;(_0x2c4526?.[_0x21eeb2(0x1e5)]?.['conversation']||_0x2c4526?.[_0x21eeb2(0x1e5)]?.[_0x21eeb2(0x20c)])&&(_0x492d49=parseInt(_0x2c4526[_0x21eeb2(0x1e5)][_0x21eeb2(0x1e2)]||_0x2c4526[_0x21eeb2(0x1e5)][_0x21eeb2(0x20c)][_0x21eeb2(0x23f)],0xa)||null);if(!Number['isNaN'](_0x492d49)&&Number[_0x21eeb2(0x27e)](_0x492d49)&&!(0x0,lodash_1[_0x21eeb2(0x226)])(_0x492d49)){const _0x4c3aa2=await(0x0,ShowWhatsAppService_1[_0x21eeb2(0x272)])(_0xe7e2d3['whatsappId'],_0xe7e2d3[_0x21eeb2(0x28a)]);let _0x4774f9=_0x492d49;_0x492d49<0x1&&(_0x4774f9=0x1);_0x492d49>0x5&&(_0x4774f9=0x5);await UserRating_1[_0x21eeb2(0x272)][_0x21eeb2(0x25e)]({'ticketId':_0x53efb3[_0x21eeb2(0x1ee)],'companyId':_0x53efb3[_0x21eeb2(0x28a)],'userId':_0x53efb3[_0x21eeb2(0x25b)],'rate':_0x4774f9});const _0x425b08=_0x4c3aa2[_0x21eeb2(0x1c8)][_0x21eeb2(0x2a6)]()||_0x21eeb2(0x28d);await(0x0,SendWhatsAppMessage_1[_0x21eeb2(0x272)])({'ticket':_0xe7e2d3,'body':_0x425b08}),await _0x53efb3[_0x21eeb2(0x1f5)]({'finishedAt':(0x0,moment_1[_0x21eeb2(0x272)])()[_0x21eeb2(0x22a)](),'rated':!![]});const _0x499a1=await(0x0,CheckSettings_1[_0x21eeb2(0x1ca)])(_0xe7e2d3[_0x21eeb2(0x28a)],_0x21eeb2(0x1c5),_0x21eeb2(0x1c7))===_0x21eeb2(0x1c7);await _0xe7e2d3[_0x21eeb2(0x1f5)]({'queueId':_0x499a1?_0xe7e2d3['queueId']:null,'chatbot':null,'queueOptionId':null,'userId':_0x499a1?_0xe7e2d3[_0x21eeb2(0x25b)]:null,'status':'closed'}),_0x2ea90e['to']('company-'+_0xe7e2d3[_0x21eeb2(0x28a)]+_0x21eeb2(0x200))['to'](_0x21eeb2(0x1df)+_0xe7e2d3[_0x21eeb2(0x262)]+_0x21eeb2(0x200))[_0x21eeb2(0x251)](_0x21eeb2(0x1ea)+_0xe7e2d3[_0x21eeb2(0x28a)]+_0x21eeb2(0x24d),{'action':_0x21eeb2(0x1d7),'ticket':_0xe7e2d3,'ticketId':_0xe7e2d3['id']}),_0x2ea90e['to'](_0x21eeb2(0x1ea)+_0xe7e2d3[_0x21eeb2(0x28a)]+'-'+_0xe7e2d3[_0x21eeb2(0x24c)])['to'](_0x21eeb2(0x1df)+_0xe7e2d3[_0x21eeb2(0x262)]+'-'+_0xe7e2d3[_0x21eeb2(0x24c)])['to'](_0xe7e2d3['id'][_0x21eeb2(0x26c)]())[_0x21eeb2(0x251)](_0x21eeb2(0x1ea)+_0xe7e2d3[_0x21eeb2(0x28a)]+_0x21eeb2(0x24d),{'action':_0x21eeb2(0x1f5),'ticket':_0xe7e2d3,'ticketId':_0xe7e2d3['id']});}};exports[a583_0x19fc31(0x233)]=handleRating;const handleChartbot=async(_0x55f361,_0x6b73c3,_0x3d2660,_0x36454e=![])=>{const _0x32d201=a583_0x19fc31,_0x6a5e47=_0x6b73c3[_0x32d201(0x1f1)]['id'];if(_0x6a5e47&&_0x55f361[_0x32d201(0x240)]===_0x6a5e47){console['log'](_0x32d201(0x1f8)+_0x6a5e47+_0x32d201(0x206)+_0x55f361['id']+'.\x20Ignorando\x20em\x20handleChartbot.');return;}await _0x55f361[_0x32d201(0x1f5)]({'lastProcessedMessageId':_0x6a5e47});const _0x505053=(0x0,GetHandlers_1[_0x32d201(0x266)])(_0x6b73c3);console[_0x32d201(0x294)](_0x32d201(0x230)+_0x505053+_0x32d201(0x2b3)+_0x55f361['id']+',\x20queueOptionId:\x20'+_0x55f361['queueOptionId']);const _0x4bc15a=await Queue_1['default'][_0x32d201(0x286)](_0x55f361[_0x32d201(0x262)],{'include':[{'model':QueueOption_1[_0x32d201(0x272)],'as':_0x32d201(0x241),'where':{'parentId':null},'order':[[_0x32d201(0x291),_0x32d201(0x247)]],'required':![]}]}),_0x54d664=await Whatsapp_1['default'][_0x32d201(0x286)](_0x55f361[_0x32d201(0x22b)]);if(!_0x54d664){console[_0x32d201(0x2ac)](_0x32d201(0x2a4));return;}if(_0x505053==='#'){await _0x55f361[_0x32d201(0x1f5)]({'queueOptionId':null,'chatbot':![],'queueId':null,'amountUsedBotQueues':0x0}),await(0x0,VerifyHandlers_1[_0x32d201(0x2a5)])(_0x3d2660,_0x6b73c3,_0x55f361,_0x55f361[_0x32d201(0x273)]);return;}if(!(0x0,lodash_1[_0x32d201(0x295)])(_0x4bc15a)&&!(0x0,lodash_1[_0x32d201(0x295)])(_0x55f361[_0x32d201(0x299)])&&_0x505053==='0'){const _0x3ce808=await QueueOption_1['default'][_0x32d201(0x286)](_0x55f361['queueOptionId']);_0x3ce808?.[_0x32d201(0x253)]?await _0x55f361['update']({'queueOptionId':_0x3ce808['parentId'],'amountUsedBotQueues':0x0}):await _0x55f361[_0x32d201(0x1f5)]({'queueOptionId':null,'amountUsedBotQueues':0x0});await _0x55f361[_0x32d201(0x243)](),await(0x0,exports[_0x32d201(0x274)])(_0x55f361,_0x3d2660);return;}if(!_0x55f361[_0x32d201(0x234)]&&_0x55f361[_0x32d201(0x25f)]>=_0x54d664[_0x32d201(0x225)])return;if(!(0x0,lodash_1['isNil'])(_0x4bc15a)&&(0x0,lodash_1[_0x32d201(0x295)])(_0x55f361[_0x32d201(0x299)])&&!_0x36454e){if(_0x505053&&_0x4bc15a[_0x32d201(0x241)]?.[_0x32d201(0x27f)]>0x0){const _0x2c3f51=_0x4bc15a['options'][_0x32d201(0x1c3)](_0x165e5c=>_0x165e5c[_0x32d201(0x291)]===_0x505053);if(_0x2c3f51){console[_0x32d201(0x294)]('Opção\x20'+_0x505053+_0x32d201(0x297)+_0x2c3f51['id']),await _0x55f361['update']({'queueOptionId':_0x2c3f51['id'],'amountUsedBotQueues':0x0}),await _0x55f361[_0x32d201(0x243)](),await(0x0,exports[_0x32d201(0x274)])(_0x55f361,_0x3d2660);return;}else console[_0x32d201(0x294)](_0x32d201(0x26d)+_0x505053+'\x20inválida\x20para\x20o\x20menu\x20principal.');}}else{if(!(0x0,lodash_1['isNil'])(_0x4bc15a)&&!(0x0,lodash_1[_0x32d201(0x295)])(_0x55f361[_0x32d201(0x299)])){const _0x24b2eb=await QueueOption_1['default']['findAll']({'where':{'parentId':_0x55f361[_0x32d201(0x299)]},'order':[['option',_0x32d201(0x247)]]});if(_0x505053&&_0x24b2eb['length']>0x0){const _0x26c9f0=_0x24b2eb[_0x32d201(0x1c3)](_0x36a6fa=>_0x36a6fa['option']===_0x505053);if(_0x26c9f0){console[_0x32d201(0x294)](_0x32d201(0x26d)+_0x505053+_0x32d201(0x1f0)+_0x26c9f0['id']),await _0x55f361[_0x32d201(0x1f5)]({'queueOptionId':_0x26c9f0['id'],'amountUsedBotQueues':0x0}),await _0x55f361[_0x32d201(0x243)](),await(0x0,exports[_0x32d201(0x274)])(_0x55f361,_0x3d2660);return;}else console[_0x32d201(0x294)](_0x32d201(0x26d)+_0x505053+'\x20inválida\x20para\x20o\x20submenu\x20atual.');}}}if(_0x505053&&_0x505053!=='0'&&_0x505053!=='#'){console['log'](_0x32d201(0x289)+_0x505053);if(_0x54d664[_0x32d201(0x225)]&&_0x54d664[_0x32d201(0x225)]!==0x0&&_0x55f361[_0x32d201(0x25f)]>=_0x54d664[_0x32d201(0x225)]){await _0x55f361[_0x32d201(0x1f5)]({'chatbot':![],'amountUsedBotQueues':_0x54d664[_0x32d201(0x225)]});_0x54d664[_0x32d201(0x237)]&&await(0x0,SendWhatsAppMessage_1[_0x32d201(0x272)])({'ticket':_0x55f361,'body':_0x54d664[_0x32d201(0x237)]});return;}await _0x55f361[_0x32d201(0x1f5)]({'amountUsedBotQueues':_0x55f361[_0x32d201(0x25f)]+0x1}),await _0x55f361['reload']();}!_0x36454e&&await(0x0,exports['displayCurrentMenu'])(_0x55f361,_0x3d2660);},displayCurrentMenu=async(_0x42d5aa,_0x364c36)=>{const _0x38a319=a583_0x19fc31;console[_0x38a319(0x294)](_0x38a319(0x27b)+_0x42d5aa['id']+',\x20queueOptionId:\x20'+_0x42d5aa[_0x38a319(0x299)]);const _0x48c3fe=await Queue_1[_0x38a319(0x272)][_0x38a319(0x286)](_0x42d5aa[_0x38a319(0x262)]);if(!_0x48c3fe)return;if((0x0,lodash_1[_0x38a319(0x295)])(_0x42d5aa[_0x38a319(0x299)])){const _0x1a2e3e=await QueueOption_1['default'][_0x38a319(0x22e)]({'where':{'queueId':_0x42d5aa['queueId'],'parentId':null},'order':[[_0x38a319(0x291),_0x38a319(0x247)]]});if(_0x1a2e3e[_0x38a319(0x27f)]>0x0){let _0x2c743c=_0x48c3fe[_0x38a319(0x210)]?_0x48c3fe[_0x38a319(0x210)]+'\x0a\x0a':'';_0x1a2e3e['forEach'](_0x26626a=>{const _0x467c21=_0x38a319;_0x2c743c+='*'+_0x26626a[_0x467c21(0x291)]+_0x467c21(0x1d4)+_0x26626a['title']+'\x0a';}),_0x2c743c+=_0x38a319(0x280),await(0x0,SendWhatsAppMessage_1['default'])({'ticket':_0x42d5aa,'body':_0x2c743c}),console[_0x38a319(0x294)](_0x38a319(0x2aa));}return;}const _0x35fac4=await QueueOption_1[_0x38a319(0x272)]['findByPk'](_0x42d5aa[_0x38a319(0x299)],{'include':[{'model':Queue_1[_0x38a319(0x272)],'as':'forwardQueue'}]});if(!_0x35fac4){console[_0x38a319(0x294)](_0x38a319(0x26d)+_0x42d5aa[_0x38a319(0x299)]+_0x38a319(0x258));return;}const _0xb22fab=await QueueOption_1[_0x38a319(0x272)][_0x38a319(0x22e)]({'where':{'parentId':_0x42d5aa[_0x38a319(0x299)]},'order':[['option','ASC']]});if(_0xb22fab[_0x38a319(0x27f)]===0x0){console['log'](_0x38a319(0x1ef));let _0x2e767e=(0x0,Mustache_1[_0x38a319(0x272)])('‎'+_0x35fac4[_0x38a319(0x1e5)],_0x42d5aa);if(_0x35fac4?.[_0x38a319(0x2b2)]){const _0x580bd4=path_1[_0x38a319(0x272)][_0x38a319(0x21f)](_0x38a319(0x236),_0x35fac4['mediaPath']);_0x580bd4?await(0x0,SendWhatsAppMedia_1[_0x38a319(0x272)])({'media':_0x580bd4,'ticket':_0x42d5aa,'body':_0x2e767e}):await(0x0,SendWhatsAppMessage_1[_0x38a319(0x272)])({'ticket':_0x42d5aa,'body':_0x2e767e});}else await(0x0,SendWhatsAppMessage_1[_0x38a319(0x272)])({'ticket':_0x42d5aa,'body':_0x2e767e});if(_0x35fac4[_0x38a319(0x216)])await _0x42d5aa[_0x38a319(0x1f5)]({'queueOptionId':null,'chatbot':![],'amountUsedBotQueues':0x0});else{if(_0x35fac4['forwardQueueId']){await _0x42d5aa[_0x38a319(0x1f5)]({'queueOptionId':null,'chatbot':![],'queueId':_0x35fac4[_0x38a319(0x255)],'amountUsedBotQueues':0x0}),await _0x42d5aa[_0x38a319(0x243)]();if(_0x35fac4[_0x38a319(0x201)]){const _0x2b5ea7=await QueueOption_1[_0x38a319(0x272)][_0x38a319(0x20d)]({'where':{'queueId':_0x35fac4[_0x38a319(0x255)],'parentId':null}});await _0x42d5aa[_0x38a319(0x1f5)]({'chatbot':!!_0x2b5ea7}),_0x35fac4[_0x38a319(0x201)][_0x38a319(0x210)]&&await(0x0,SendWhatsAppMessage_1['default'])({'ticket':_0x42d5aa,'body':_0x35fac4[_0x38a319(0x201)][_0x38a319(0x210)]}),_0x2b5ea7&&await(0x0,exports['displayCurrentMenu'])(_0x42d5aa,_0x364c36);}}else await _0x42d5aa[_0x38a319(0x1f5)]({'queueOptionId':null,'chatbot':![]});}return;}console[_0x38a319(0x294)](_0x38a319(0x21a)+_0xb22fab[_0x38a319(0x27f)]+'\x20opções.\x20Exibindo\x20submenu.');let _0x3d8ba8=_0x35fac4[_0x38a319(0x1e5)]?_0x35fac4['message']+'\x0a\x0a':'';_0xb22fab[_0x38a319(0x1fd)](_0xc5f62c=>{const _0x48c241=_0x38a319;_0x3d8ba8+='*'+_0xc5f62c[_0x48c241(0x291)]+'*\x20-\x20'+_0xc5f62c[_0x48c241(0x1fa)]+'\x0a';}),_0x3d8ba8+=_0x38a319(0x202),_0x3d8ba8+=_0x38a319(0x252);if(_0x35fac4?.[_0x38a319(0x2b2)]){const _0x37feec=path_1[_0x38a319(0x272)][_0x38a319(0x21f)](_0x38a319(0x236),_0x35fac4[_0x38a319(0x2b2)]);_0x37feec?await(0x0,SendWhatsAppMedia_1[_0x38a319(0x272)])({'media':_0x37feec,'ticket':_0x42d5aa,'body':_0x3d8ba8}):await(0x0,SendWhatsAppMessage_1[_0x38a319(0x272)])({'ticket':_0x42d5aa,'body':_0x3d8ba8});}else await(0x0,SendWhatsAppMessage_1[_0x38a319(0x272)])({'ticket':_0x42d5aa,'body':_0x3d8ba8});};exports[a583_0x19fc31(0x274)]=displayCurrentMenu;const handleMessageIntegration=async(_0x41bcda,_0x88350c,_0x191562,_0x2dd246)=>{const _0x30696b=a583_0x19fc31;if(process['env'][_0x30696b(0x1fc)]){if(_0x2dd246[_0x30696b(0x273)][_0x30696b(0x2b5)]!=process[_0x30696b(0x2a2)]['CHATBOT_RESTRICT_NUMBER']){console[_0x30696b(0x294)](_0x30696b(0x277));return;}}console[_0x30696b(0x294)]('typebotStatus:\x20',_0x2dd246[_0x30696b(0x204)]),_0x191562['type']==='typebot'&&!_0x2dd246[_0x30696b(0x204)]?(await(0x0,typebotListener_1[_0x30696b(0x272)])({'ticket':_0x2dd246,'msg':_0x41bcda,'wbot':_0x88350c,'typebot':_0x191562}),!_0x2dd246[_0x30696b(0x1cb)]&&(await _0x2dd246[_0x30696b(0x1f5)]({'useIntegration':!![],'integrationId':_0x191562['id']}),console['log']('Atualizando\x20estado\x20de\x20integração\x20do\x20ticket\x20#'+_0x2dd246['id']))):console[_0x30696b(0x294)](_0x30696b(0x232));};exports['handleMessageIntegration']=handleMessageIntegration;function a583_0x5e92(_0x160297,_0x2bbfeb){const _0x1514f9=a583_0x66c5();return a583_0x5e92=function(_0x5b1745,_0x20be9a){_0x5b1745=_0x5b1745-0x1c2;let _0x66c5e3=_0x1514f9[_0x5b1745];return _0x66c5e3;},a583_0x5e92(_0x160297,_0x2bbfeb);}const handleMessage=async(_0x3d2595,_0x393285,_0x3f1299)=>{const _0x3b6863=a583_0x19fc31;if(!isValidMsg(_0x3d2595))return;_0x3d2595[_0x3b6863(0x1e5)]?.[_0x3b6863(0x2a3)]&&(_0x3d2595[_0x3b6863(0x1e5)]=_0x3d2595[_0x3b6863(0x1e5)]['ephemeralMessage']['message']);try{let _0x50ae60,_0x56e05d;const _0x23b511=_0x3d2595['key'][_0x3b6863(0x281)]?.[_0x3b6863(0x29f)]('@g.us');if(_0x23b511){const _0x46fe04=await Setting_1[_0x3b6863(0x272)]['findOne']({'where':{'companyId':_0x3f1299,'key':_0x3b6863(0x214)}});if(!_0x46fe04||_0x46fe04['value']===_0x3b6863(0x1c7))return;}const _0x91b7ff=(0x0,GetHandlers_1[_0x3b6863(0x266)])(_0x3d2595),_0x411eb2=(0x0,GetHandlers_1[_0x3b6863(0x207)])(_0x3d2595),_0x4968f5=_0x411eb2!==_0x3b6863(0x263)&&(0x0,GetHandlers_1[_0x3b6863(0x1c9)])(_0x3d2595),_0x333dc7=_0x4968f5&&(0x0,GetHandlers_1[_0x3b6863(0x298)])(_0x4968f5);if(_0x3d2595[_0x3b6863(0x1f1)][_0x3b6863(0x1de)]){if(_0x91b7ff?.['startsWith']('‎'))return;if(!_0x333dc7&&_0x411eb2!==_0x3b6863(0x1e2)&&_0x411eb2!==_0x3b6863(0x20c)&&_0x411eb2!=='vcard')return;_0x50ae60=await(0x0,GetHandlers_1[_0x3b6863(0x2b7)])(_0x3d2595,_0x393285);}else _0x50ae60=await(0x0,GetHandlers_1['getContactMessage'])(_0x3d2595,_0x393285);_0x23b511&&(_0x56e05d=await wbotMutex[_0x3b6863(0x260)](async()=>{const _0x22c217=_0x3b6863;let _0x315b3e=groupContactCache['get'](_0x3d2595[_0x22c217(0x1f1)]['remoteJid']);if(!_0x315b3e){const _0x3c00c2=await _0x393285[_0x22c217(0x1ce)](_0x3d2595[_0x22c217(0x1f1)][_0x22c217(0x281)]),_0x1c47c5={'id':_0x3c00c2['id'],'name':_0x3c00c2[_0x22c217(0x20b)]};_0x315b3e=await(0x0,VerifyHandlers_1[_0x22c217(0x2b1)])(_0x1c47c5,_0x393285,_0x3f1299),groupContactCache[_0x22c217(0x20a)](_0x3d2595[_0x22c217(0x1f1)]['remoteJid'],_0x315b3e);}return _0x315b3e;}));const _0x452ce6=await(0x0,ShowWhatsAppService_1[_0x3b6863(0x272)])(_0x393285['id'],_0x3f1299),_0x19d831=await(0x0,VerifyHandlers_1[_0x3b6863(0x2b1)])(_0x50ae60,_0x393285,_0x3f1299);let _0x22e055=0x0;if(_0x3d2595[_0x3b6863(0x1f1)][_0x3b6863(0x1de)])await cache_1[_0x3b6863(0x1fe)][_0x3b6863(0x20a)](_0x3b6863(0x257)+_0x19d831['id']+_0x3b6863(0x287),'0');else{const _0x2f2da7=await cache_1[_0x3b6863(0x1fe)][_0x3b6863(0x265)](_0x3b6863(0x257)+_0x19d831['id']+_0x3b6863(0x287));_0x22e055=+_0x2f2da7+0x1,await cache_1[_0x3b6863(0x1fe)]['set'](_0x3b6863(0x257)+_0x19d831['id']+_0x3b6863(0x287),''+_0x22e055);}const _0x55490=await Message_1[_0x3b6863(0x272)][_0x3b6863(0x20d)]({'where':{'contactId':_0x19d831['id'],'companyId':_0x3f1299,'$ticket.whatsappId$':_0x452ce6['id']},'include':[_0x3b6863(0x27c)],'order':[[_0x3b6863(0x22c),'DESC']]}),_0x139295=_0x452ce6[_0x3b6863(0x1c8)]['trim']()||_0x3b6863(0x28d);if(_0x55490&&_0x22e055===0x0&&_0x139295&&(0x0,Mustache_1[_0x3b6863(0x272)])(_0x139295,_0x55490[_0x3b6863(0x27c)])['trim']()[_0x3b6863(0x22f)]()===_0x55490?.[_0x3b6863(0x1dd)][_0x3b6863(0x2a6)]()[_0x3b6863(0x22f)]())return;if(!_0x3d2595['key'][_0x3b6863(0x1de)]&&!_0x19d831[_0x3b6863(0x2ae)]){if(_0x452ce6[_0x3b6863(0x264)]){const _0x140d4f=await TicketTraking_1[_0x3b6863(0x272)][_0x3b6863(0x20d)]({'where':{'whatsappId':_0x452ce6['id'],'rated':![],'ratingAt':{[sequelize_1['Op'][_0x3b6863(0x27a)]]:null},'finishedAt':null},'include':[{'model':Ticket_1[_0x3b6863(0x272)],'where':{'status':_0x3b6863(0x217),'contactId':_0x19d831['id']},'include':[{'model':Contact_1['default']},{'model':User_1[_0x3b6863(0x272)]},{'model':Queue_1[_0x3b6863(0x272)]}]}]});if(_0x140d4f)try{const _0x411aa6=Number(_0x91b7ff);if(!Number[_0x3b6863(0x29a)](_0x411aa6)){const _0x5a5296=(0x0,Debounce_1[_0x3b6863(0x229)])(async()=>{const _0x53d98d=_0x3b6863,_0x3ec4d4=_0x452ce6[_0x53d98d(0x271)]?.['trim']()||_0x53d98d(0x1d9);await(0x0,SendWhatsAppMessage_1[_0x53d98d(0x272)])({'ticket':_0x4e6aa5,'body':'\x0a*'+_0x3ec4d4+'*'});},0x3e8,_0x140d4f[_0x3b6863(0x27c)]['id']);_0x5a5296();return;}if((0x0,VerifyHandlers_1[_0x3b6863(0x25d)])(_0x140d4f)){(0x0,exports[_0x3b6863(0x233)])(_0x3d2595,_0x140d4f[_0x3b6863(0x27c)],_0x140d4f);return;}}catch(_0x824590){Sentry[_0x3b6863(0x256)](_0x824590),console[_0x3b6863(0x294)](_0x3b6863(0x1da),_0x824590);}}}const {ticket:_0x4e6aa5,justCreated:_0x599a6e}=await(0x0,FindOrCreateTicketService_1['default'])(_0x19d831,_0x393285['id'],_0x22e055,_0x3f1299,_0x56e05d);if(_0x333dc7||_0x3d2595?.['message']?.[_0x3b6863(0x20c)]?.[_0x3b6863(0x1db)])await(0x0,VerifyHandlers_1[_0x3b6863(0x268)])(_0x3d2595,_0x4e6aa5,_0x19d831,_0x393285,_0x333dc7);else{if(_0x3d2595['message']?.['editedMessage']?.[_0x3b6863(0x1e5)]?.[_0x3b6863(0x1d6)]?.[_0x3b6863(0x250)])await(0x0,VerifyHandlers_1[_0x3b6863(0x28f)])(_0x3d2595[_0x3b6863(0x1e5)][_0x3b6863(0x250)]['message'][_0x3b6863(0x1d6)]['editedMessage'],_0x4e6aa5,_0x3d2595['message'][_0x3b6863(0x250)][_0x3b6863(0x1e5)][_0x3b6863(0x1d6)]['key']['id']);else{if(_0x3d2595[_0x3b6863(0x1e5)]?.[_0x3b6863(0x1d6)]?.[_0x3b6863(0x250)])await(0x0,VerifyHandlers_1[_0x3b6863(0x28f)])(_0x3d2595['message'][_0x3b6863(0x1d6)][_0x3b6863(0x250)],_0x4e6aa5,_0x3d2595[_0x3b6863(0x1e5)][_0x3b6863(0x1d6)][_0x3b6863(0x1f1)]['id']);else _0x3d2595['message']?.[_0x3b6863(0x1d6)]?.[_0x3b6863(0x224)]===0x0?await(0x0,VerifyHandlers_1[_0x3b6863(0x1d2)])(_0x3d2595[_0x3b6863(0x1e5)][_0x3b6863(0x1d6)],_0x4e6aa5):await(0x0,VerifyHandlers_1[_0x3b6863(0x29b)])(_0x3d2595,_0x4e6aa5,_0x19d831);}}if(_0x4e6aa5[_0x3b6863(0x1cb)]===!![]&&_0x4e6aa5[_0x3b6863(0x293)]){const _0x1c06ac=await(0x0,ShowQueueIntegrationService_1[_0x3b6863(0x272)])(_0x4e6aa5['integrationId'],_0x3f1299);if(_0x1c06ac){await(0x0,exports[_0x3b6863(0x1f2)])(_0x3d2595,_0x393285,_0x1c06ac,_0x4e6aa5);return;}else await _0x4e6aa5[_0x3b6863(0x1f5)]({'useIntegration':![],'integrationId':null,'typebotSessionId':null});}if(_0x91b7ff==='#'&&!_0x23b511){await _0x4e6aa5['update']({'queueOptionId':null,'chatbot':![],'queueId':null}),await(0x0,VerifyHandlers_1['verifyQueue'])(_0x393285,_0x3d2595,_0x4e6aa5,_0x4e6aa5[_0x3b6863(0x273)]);return;}if(_0x23b511||_0x19d831[_0x3b6863(0x228)])return;const _0x33dc1f=await(0x0,CheckSettings_1[_0x3b6863(0x1ca)])(_0x3f1299,_0x3b6863(0x23a),'disabled');try{if(!_0x3d2595[_0x3b6863(0x1f1)][_0x3b6863(0x1de)]&&_0x33dc1f){const _0xeb41f8=await(0x0,CheckSettings_1['GetCompanySetting'])(_0x3f1299,_0x3b6863(0x1eb),_0x3b6863(0x1ed));let _0x438006=null;const _0x56be46=_0x4e6aa5[_0x3b6863(0x24c)]===_0x3b6863(0x217)&&_0x4e6aa5[_0x3b6863(0x1f6)][_0x3b6863(0x208)][_0x3b6863(0x27f)]>0x0,_0x58fbdc=!_0x56be46&&outOfHoursCache['get'](_0x3b6863(0x239)+_0x4e6aa5['id']);if(_0x33dc1f===_0x3b6863(0x25c)&&!_0x56be46){_0x438006=await(0x0,VerifyCurrentSchedule_1['default'])(_0x3f1299),console[_0x3b6863(0x294)](_0x3b6863(0x218),{'currentSchedule':_0x438006,'isInActivity':_0x438006?.['inActivity']});if(_0x438006&&_0x438006[_0x3b6863(0x20f)]===![]){if(!_0x58fbdc){outOfHoursCache[_0x3b6863(0x20a)](_0x3b6863(0x239)+_0x4e6aa5['id'],!![]);const _0x9b01c=_0x452ce6[_0x3b6863(0x284)][_0x3b6863(0x2a6)]()||'Estamos\x20fora\x20do\x20horário\x20de\x20expediente';await(0x0,SendWhatsAppMessage_1[_0x3b6863(0x272)])({'ticket':_0x4e6aa5,'body':_0x9b01c});}_0x4e6aa5[_0x3b6863(0x24c)]!==_0x3b6863(0x217)&&await(0x0,UpdateTicketService_1[_0x3b6863(0x272)])({'ticketData':{'chatbot':![],'status':_0xeb41f8},'ticketId':_0x4e6aa5['id'],'companyId':_0x4e6aa5[_0x3b6863(0x28a)]});return;}}if(_0x33dc1f===_0x3b6863(0x288)&&_0x4e6aa5[_0x3b6863(0x262)]!==null&&!_0x56be46){_0x438006=await(0x0,VerifyCurrentSchedule_1['default'])(_0x3f1299,_0x4e6aa5[_0x3b6863(0x262)]);const _0x143240=await Queue_1[_0x3b6863(0x272)][_0x3b6863(0x286)](_0x4e6aa5[_0x3b6863(0x262)]);if(!(0x0,lodash_1['isNil'])(_0x438006)&&(!_0x438006||_0x438006[_0x3b6863(0x20f)]===![])){if(!_0x58fbdc){outOfHoursCache[_0x3b6863(0x20a)](_0x3b6863(0x239)+_0x4e6aa5['id'],!![]);const _0x53670c=_0x143240['outOfHoursMessage']?.[_0x3b6863(0x2a6)]()||_0x3b6863(0x285);await(0x0,SendWhatsAppMessage_1['default'])({'ticket':_0x4e6aa5,'body':_0x53670c});}_0x4e6aa5[_0x3b6863(0x24c)]!==_0x3b6863(0x217)&&await(0x0,UpdateTicketService_1[_0x3b6863(0x272)])({'ticketData':{'chatbot':![],'status':_0xeb41f8},'ticketId':_0x4e6aa5['id'],'companyId':_0x4e6aa5['companyId']});return;}}}}catch(_0x512af3){Sentry[_0x3b6863(0x256)](_0x512af3),console[_0x3b6863(0x294)](_0x3b6863(0x23d),_0x512af3);}!_0x4e6aa5[_0x3b6863(0x288)]&&!_0x23b511&&!_0x3d2595[_0x3b6863(0x1f1)][_0x3b6863(0x1de)]&&!_0x4e6aa5[_0x3b6863(0x25b)]&&_0x452ce6[_0x3b6863(0x27d)][_0x3b6863(0x27f)]>=0x1&&await(0x0,VerifyHandlers_1[_0x3b6863(0x2a5)])(_0x393285,_0x3d2595,_0x4e6aa5,_0x4e6aa5[_0x3b6863(0x273)]);const _0x89ec90=_0x4e6aa5[_0x3b6863(0x288)]===null;await _0x4e6aa5[_0x3b6863(0x243)]();if(_0x599a6e&&!_0x452ce6?.['queues']?.[_0x3b6863(0x27f)]&&!_0x4e6aa5[_0x3b6863(0x25b)]&&!_0x23b511&&!_0x3d2595[_0x3b6863(0x1f1)][_0x3b6863(0x1de)]){const _0x3551aa=await Message_1['default']['findOne']({'where':{'ticketId':_0x4e6aa5['id'],'fromMe':!![]},'order':[[_0x3b6863(0x22c),_0x3b6863(0x259)]]});if(_0x3551aa&&_0x3551aa['body'][_0x3b6863(0x1e8)](_0x452ce6['greetingMessage']))return;if(_0x452ce6[_0x3b6863(0x210)]){const _0x2168f5=(0x0,Debounce_1[_0x3b6863(0x229)])(async()=>{const _0x3d8235=_0x3b6863;await(0x0,SendWhatsAppMessage_1[_0x3d8235(0x272)])({'ticket':_0x4e6aa5,'body':''+_0x452ce6[_0x3d8235(0x210)]});},0x3e8,_0x4e6aa5['id']);_0x2168f5();return;}}if(!_0x4e6aa5[_0x3b6863(0x234)]&&_0x4e6aa5['amountUsedBotQueues']>=_0x452ce6?.[_0x3b6863(0x225)])return;if(_0x4e6aa5[_0x3b6863(0x234)]&&!_0x3d2595['key']['fromMe']){await handleChartbot(_0x4e6aa5,_0x3d2595,_0x393285);return;}_0x452ce6[_0x3b6863(0x27d)][_0x3b6863(0x27f)]===0x1&&_0x4e6aa5['queue']&&(_0x4e6aa5[_0x3b6863(0x234)]&&!_0x3d2595[_0x3b6863(0x1f1)]['fromMe']&&!_0x4e6aa5[_0x3b6863(0x1cb)]&&await handleChartbot(_0x4e6aa5,_0x3d2595,_0x393285,_0x89ec90)),_0x452ce6[_0x3b6863(0x27d)][_0x3b6863(0x27f)]>0x1&&_0x4e6aa5['queue']&&(_0x4e6aa5[_0x3b6863(0x234)]&&!_0x3d2595[_0x3b6863(0x1f1)][_0x3b6863(0x1de)]&&!_0x4e6aa5['useIntegration']&&await handleChartbot(_0x4e6aa5,_0x3d2595,_0x393285,_0x89ec90));}catch(_0x297ca4){console[_0x3b6863(0x294)](_0x3b6863(0x21c),_0x297ca4),Sentry['captureException'](_0x297ca4),logger_1[_0x3b6863(0x283)]['error'](_0x3b6863(0x278)+_0x297ca4);}};function a583_0x66c5(){const _0x3bebbb=['endsWith','../../utils/logger','Novo\x20Tipo\x20de\x20Mensagem\x20em\x20isValidMsg','env','ephemeralMessage','Configurações\x20do\x20WhatsApp\x20não\x20encontradas.','verifyQueue','trim','charAt','11cwweZt','floor','Menu\x20principal\x20exibido.','./VerifyHandlers','error','voiceMessage','isGroup','14778ERDKFh','../../models/Setting','verifyContact','mediaPath','\x22\x20para\x20ticket\x20','contactMessage','number','defineProperty','getContactMessage','prototype','find','__setModuleDefault','keepUserAndQueue','REVOKE','enabled','complationMessage','getUnpackedMessage','GetCompanySetting','useIntegration','search','count','groupMetadata','../../models/Queue','imageMessage','map','verifyDeleteMessage','1270rDjiZR','*\x20-\x20','8853108zBdVdR','protocolMessage','delete','18930VazbPQ','Por\x20favor\x20avalie\x20nosso\x20atendimento','Erro\x20ao\x20processar\x20avaliação:','thumbnailDirectPath','-appMessage','body','fromMe','queue-','viewOnceMessageV2','Error\x20handling\x20message\x20ack.\x20Err:\x20','conversation','E2E_IDENTITY_CHANGED','../TypebotServices/typebotListener','message','messages','Mensagem','includes','status@broadcast','company-','outOfHoursAction','hasOwnProperty','pending','ticketId','Nó\x20final\x20encontrado.\x20Exibindo\x20mensagem\x20final.','\x20selecionada\x20no\x20submenu.\x20ID:\x20','key','handleMessageIntegration','../../models/Message','getIO','update','user','WAMessageStubType','Mensagem\x20','../../models/UserRating','title','../../models/User','CHATBOT_RESTRICT_NUMBER','forEach','cacheLayer','1TqEFWi','-open','forwardQueue','\x0a*0*\x20-\x20Voltar\x20ao\x20menu\x20anterior\x0a','349293atMfcq','typebotStatus','__importStar','\x20já\x20processada\x20para\x20o\x20ticket\x20','getTypeMessage','socketSessions','messageContextInfo','set','subject','extendedTextMessage','findOne','E2E_DEVICE_CHANGED','inActivity','greetingMessage','stickerMessage','393932zXQsox','../CompanyService/VerifyCurrentSchedule','CheckMsgIsGroup','__createBinding','exitChatbot','open','Resultado\x20da\x20verificação\x20de\x20horário:','getOwnPropertyDescriptor','Submenu\x20encontrado\x20com\x20','(((.+)+)+)+$','Erro\x20ao\x20processar\x20mensagem\x20do\x20WhatsApp:','sequelize','../../libs/socket','resolve','async-mutex','messages.update','Error\x20handling\x20wbot\x20message\x20listener.\x20Err:\x20','../../helpers/Debounce','type','maxUseBotQueues','isNull','writable','disableBot','debounce','toDate','whatsappId','createdAt','quotedMsg','findAll','toLowerCase','Processando\x20mensagem:\x20\x22','2764144yLpyIf','Tipo\x20de\x20integração\x20não\x20suportada.','handleRating','chatbot','../../models/Contact','public','transferMessage','wbotMessageListener','ticket-','scheduleType','configurable','@whiskeysockets/baileys','Erro\x20ao\x20verificar\x20horário\x20de\x20atendimento:','../../helpers/CheckSettings','text','lastProcessedMessageId','options','audioMessage','reload','./SendWhatsAppMessage','Mutex','40JeLgSQ','ASC','__esModule','####\x20Nao\x20achou\x20o\x20type\x20em\x20isValidMsg:\x20','../../helpers/simpleObjectCache','../../libs/cache','status','-ticket','./GetHandlers','filter','editedMessage','emit','*#*\x20-\x20Voltar\x20Menu\x20Inicial','parentId','../../models/Whatsapp','forwardQueueId','captureException','contacts:','\x20não\x20encontrada.','DESC','../QueueIntegrationServices/ShowQueueIntegrationService','userId','company','verifyRating','create','amountUsedBotQueues','runExclusive','messageStubType','queueId','templateMessage','useRating','get','getBodyMessage','readMessages','verifyMediaMessage','../../helpers/Mustache','getOwnPropertyNames','setExtra','toString','Opção\x20','@sentry/node','../TicketServices/FindOrCreateTicketService','handleMessage','ratingMessage','default','contact','displayCurrentMenu','../WhatsappService/ShowWhatsAppService','SimpleObjectCache','chatbot\x20desativado!','Error\x20handling\x20whatsapp\x20message:\x20Err:\x20','call','not','Exibindo\x20menu\x20para\x20ticket\x20','ticket','queues','isInteger','length','\x0a*#*\x20-\x20Voltar\x20Menu\x20Inicial','remoteJid','6EqFLjt','logger','outOfHoursMessage','Estamos\x20fora\x20do\x20horário\x20de\x20expediente','findByPk',':unreads','queue','Resposta\x20inválida:\x20','companyId','messages.upsert','path','Atendimento\x20finalizado','Error\x20isValidMsg','verifyEditedMessage','ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789','option','__importDefault','integrationId','log','isNil','moment','\x20selecionada\x20no\x20menu\x20principal.\x20ID:\x20','getMessageMedia','queueOptionId','isFinite','verifyMessage','verifyRecentCampaign','./SendWhatsAppMedia','2460388fSCJWs'];a583_0x66c5=function(){return _0x3bebbb;};return a583_0x66c5();}exports[a583_0x19fc31(0x270)]=handleMessage;const handleMsgAck=async(_0x2deee8,_0x10a55a)=>{const _0x359971=a583_0x19fc31;if(!_0x10a55a)return;const _0x3db6fa=(0x0,socket_1[_0x359971(0x1f4)])();try{const _0x9559dc=await Message_1[_0x359971(0x272)]['findByPk'](_0x2deee8[_0x359971(0x1f1)]['id'],{'include':[_0x359971(0x273),{'model':Message_1[_0x359971(0x272)],'as':_0x359971(0x22d),'include':['contact']}]});if(!_0x9559dc||_0x10a55a<=_0x9559dc['ack'])return;await _0x9559dc['update']({'ack':_0x10a55a}),_0x3db6fa['to'](_0x9559dc['ticketId']['toString']())['emit'](_0x359971(0x1ea)+_0x9559dc[_0x359971(0x28a)]+_0x359971(0x1dc),{'action':_0x359971(0x1f5),'message':_0x9559dc});}catch(_0x28fe6c){Sentry[_0x359971(0x256)](_0x28fe6c),logger_1[_0x359971(0x283)][_0x359971(0x2ac)](_0x359971(0x1e1)+_0x28fe6c);}},filterMessages=_0x3657b1=>{const _0x8994d3=a583_0x19fc31;if(_0x3657b1[_0x8994d3(0x1e5)]?.[_0x8994d3(0x1d6)]?.['editedMessage'])return!![];if(_0x3657b1[_0x8994d3(0x1e5)]?.['protocolMessage']?.[_0x8994d3(0x224)]===0x0)return!![];if(_0x3657b1[_0x8994d3(0x1e5)]?.['protocolMessage'])return![];if([baileys_1[_0x8994d3(0x1f7)][_0x8994d3(0x1c6)],baileys_1[_0x8994d3(0x1f7)][_0x8994d3(0x20e)],baileys_1['WAMessageStubType'][_0x8994d3(0x1e3)],baileys_1[_0x8994d3(0x1f7)]['CIPHERTEXT']]['includes'](_0x3657b1[_0x8994d3(0x261)]))return![];return!![];},wbotMessageListener=async(_0x3c0602,_0x2c2712)=>{const _0x24d60a=a583_0x19fc31;try{_0x3c0602['ev']['on'](_0x24d60a(0x28b),async _0x4d43ff=>{const _0x29176c=_0x24d60a,_0x37a034=_0x4d43ff[_0x29176c(0x1e6)][_0x29176c(0x24f)](filterMessages)[_0x29176c(0x1d1)](_0x4bbcc9=>_0x4bbcc9);if(!_0x37a034)return;_0x37a034[_0x29176c(0x1fd)](async _0x52c57a=>{const _0xd87cca=_0x29176c,_0x49c57c=await Message_1[_0xd87cca(0x272)][_0xd87cca(0x1cd)]({'where':{'id':_0x52c57a[_0xd87cca(0x1f1)]['id'],'companyId':_0x2c2712}});if(!_0x49c57c){if(await(0x0,VerifyHandlers_1[_0xd87cca(0x29c)])(_0x52c57a,_0x2c2712))return;await handleMessage(_0x52c57a,_0x3c0602,_0x2c2712);}});}),_0x3c0602['ev']['on'](_0x24d60a(0x221),_0x3bc194=>{const _0x586401=_0x24d60a;if(_0x3bc194[_0x586401(0x27f)]===0x0)return;_0x3bc194['forEach'](async _0x47e1b9=>{const _0x213881=_0x586401;_0x3c0602[_0x213881(0x267)]([_0x47e1b9['key']]),await ackMutex[_0x213881(0x260)](async()=>{const _0x33d579=_0x213881;handleMsgAck(_0x47e1b9,_0x47e1b9[_0x33d579(0x1f5)][_0x33d579(0x24c)]);});});});}catch(_0x14fe4b){Sentry[_0x24d60a(0x256)](_0x14fe4b),logger_1[_0x24d60a(0x283)][_0x24d60a(0x2ac)](_0x24d60a(0x222)+_0x14fe4b);}};exports[a583_0x19fc31(0x238)]=wbotMessageListener;