'use strict';const a584_0x3c00ba=a584_0x1928;function a584_0x3f0d(){const _0x3ae45f=['options','CIPHERTEXT','makeid','getMessageMedia','queueId','includes','\x22\x20para\x20ticket\x20','../WhatsappService/ShowWhatsAppService','amountUsedBotQueues','trim','readMessages','companyId','useIntegration','find','Mensagem','./SendWhatsAppMessage','SimpleObjectCache','exitChatbot','Processando\x20mensagem:\x20\x22','toLowerCase','public','create','resolve','./SendWhatsAppMedia','@g.us','queues','isGroup','getOwnPropertyDescriptor','enabled','forEach','Atualizando\x20estado\x20de\x20integração\x20do\x20ticket\x20#','messages.upsert','Erro\x20ao\x20verificar\x20horário\x20de\x20atendimento:','verifyMessage','conversation','default','captureException','message','isNil','documentMessage','459924Wrngwq','Error\x20handling\x20message\x20ack.\x20Err:\x20','*\x20-\x20','@whiskeysockets/baileys','locationMessage','Atendimento\x20finalizado','ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789','lodash','Por\x20favor\x20avalie\x20nosso\x20atendimento','protocolMessage','cacheLayer','greetingMessage','complationMessage','thumbnailDirectPath','Error\x20handling\x20wbot\x20message\x20listener.\x20Err:\x20','E2E_IDENTITY_CHANGED','typebotStatus','setExtra','pending','GetCompanySetting','REVOKE','70pazvIc','socketSessions','logger','messages.update','messages','scheduleType','remoteJid','435090RulzaN','getContactMessage','../../models/User','verifyQueue','messageContextInfo','chatbot\x20desativado!','mediaMessage','handleMessage','vcard','listMessage','queueOptionId','prototype','ticketId','@sentry/node','15imjqEb','./GetHandlers','lastProcessedMessageId','forwardQueue','Mutex','transferMessage','debounce','writable','isFinite','WAMessageStubType','outOfHoursAction','wbotMessageListener','verifyRecentCampaign','Erro\x20ao\x20processar\x20mensagem\x20do\x20WhatsApp:','ephemeralMessage','-appMessage','whatsappId','moment','call','getOwnPropertyNames','company','contactsArrayMessage','forwardQueueId','status','471122vckvRm','useRating','Error\x20handling\x20whatsapp\x20message:\x20Err:\x20','.\x20Ignorando\x20em\x20handleChartbot.','\x20inválida\x20para\x20o\x20menu\x20principal.','contacts:','E2E_DEVICE_CHANGED','findByPk','ratingMessage','option','disabled','outOfHoursMessage','apply','viewOnceMessageV2','\x20já\x20processada\x20para\x20o\x20ticket\x20','Estamos\x20fora\x20do\x20horário\x20de\x20expediente','charAt','toDate','search','queue-','verifyRating','closed','getBodyMessage','stickerMessage','../../models/Message','startsWith','./VerifyHandlers','toString','templateMessage','verifyContact','isNaN','174556rsFBQQ','fromMe','../TicketServices/FindOrCreateTicketService','length','Opção\x20','user','defineProperty','\x0a*#*\x20-\x20Voltar\x20Menu\x20Inicial','findOne','../TicketServices/UpdateTicketService','####\x20Nao\x20achou\x20o\x20type\x20em\x20isValidMsg:\x20','Novo\x20Tipo\x20de\x20Mensagem\x20em\x20isValidMsg','set','listResponseMessage','videoMessage','filter','get','../QueueIntegrationServices/ShowQueueIntegrationService','env','maxUseBotQueues','sequelize','../CompanyService/VerifyCurrentSchedule','status@broadcast','userId','disableBot',',\x20queueOptionId:\x20','ASC','open','not','../../helpers/Debounce','keepUserAndQueue','\x20opções.\x20Exibindo\x20submenu.','title','groupMetadata','inActivity','__esModule','../../models/TicketTraking',':unreads','messageStubType','CheckMsgIsGroup','runExclusive','error','Tipo\x20de\x20integração\x20não\x20suportada.','*#*\x20-\x20Voltar\x20Menu\x20Inicial','../../models/Ticket','type','buttonsMessage','update','Erro\x20ao\x20processar\x20avaliação:','text','../../models/QueueOption','handleMessageIntegration','emit','getIO','random','constructor','ticket','subject','1410960BLKDPR','Configurações\x20do\x20WhatsApp\x20não\x20encontradas.','ack','path','../../models/Queue','CHATBOT_RESTRICT_NUMBER','imageMessage','__setModuleDefault','stringify','../../models/Whatsapp','(((.+)+)+)+$','body','parentId','ticket-','documentWithCaptionMessage','handleRating','queue','extendedTextMessage','__createBinding','contact','Error\x20isValidMsg','async-mutex','key','../../models/Setting','../../libs/socket','mediaPath','log','displayCurrentMenu','3786hacaAm','../../libs/cache','getTypeMessage','../../models/Contact','10343340jvlXSc','DESC','reload','-ticket','chatbot','Resposta\x20inválida:\x20','../../helpers/CheckSettings','-open','liveLocationMessage','editedMessage','number','company-','findAll','Resultado\x20da\x20verificação\x20de\x20horário:','\x20não\x20encontrada.'];a584_0x3f0d=function(){return _0x3ae45f;};return a584_0x3f0d();}(function(_0x57deb2,_0x33758f){const _0x3bb8ed=a584_0x1928,_0x2a8110=_0x57deb2();while(!![]){try{const _0x254d28=-parseInt(_0x3bb8ed(0x203))/0x1+-parseInt(_0x3bb8ed(0x245))/0x2+-parseInt(_0x3bb8ed(0x21f))/0x3+parseInt(_0x3bb8ed(0x264))/0x4*(parseInt(_0x3bb8ed(0x22d))/0x5)+-parseInt(_0x3bb8ed(0x2ba))/0x6*(-parseInt(_0x3bb8ed(0x218))/0x7)+-parseInt(_0x3bb8ed(0x29e))/0x8+parseInt(_0x3bb8ed(0x2be))/0x9;if(_0x254d28===_0x33758f)break;else _0x2a8110['push'](_0x2a8110['shift']());}catch(_0x36f4c9){_0x2a8110['push'](_0x2a8110['shift']());}}}(a584_0x3f0d,0x41d22));var __createBinding=this&&this[a584_0x3c00ba(0x2b0)]||(Object['create']?function(_0x3ead1f,_0x4fd11c,_0x2ef78d,_0x1174a9){const _0x5bd8c2=a584_0x3c00ba;if(_0x1174a9===undefined)_0x1174a9=_0x2ef78d;var _0x728188=Object[_0x5bd8c2(0x1f6)](_0x4fd11c,_0x2ef78d);(!_0x728188||(_0x5bd8c2(0x274)in _0x728188?!_0x4fd11c[_0x5bd8c2(0x287)]:_0x728188[_0x5bd8c2(0x234)]||_0x728188['configurable']))&&(_0x728188={'enumerable':!![],'get':function(){return _0x4fd11c[_0x2ef78d];}}),Object[_0x5bd8c2(0x26a)](_0x3ead1f,_0x1174a9,_0x728188);}:function(_0x324e16,_0x236538,_0x3fbca3,_0x2becd8){if(_0x2becd8===undefined)_0x2becd8=_0x3fbca3;_0x324e16[_0x2becd8]=_0x236538[_0x3fbca3];}),__setModuleDefault=this&&this[a584_0x3c00ba(0x2a5)]||(Object[a584_0x3c00ba(0x1f0)]?function(_0x3a21e1,_0x243ad2){const _0x4a1ab8=a584_0x3c00ba;Object[_0x4a1ab8(0x26a)](_0x3a21e1,_0x4a1ab8(0x1fe),{'enumerable':!![],'value':_0x243ad2});}:function(_0x4aba61,_0x4cf91d){const _0x15e2ec=a584_0x3c00ba;_0x4aba61[_0x15e2ec(0x1fe)]=_0x4cf91d;}),__importStar=this&&this['__importStar']||(function(){const _0x491ed0=(function(){let _0x206c9b=!![];return function(_0x44f68d,_0x2c8f85){const _0x18a82b=_0x206c9b?function(){const _0x434fe4=a584_0x1928;if(_0x2c8f85){const _0x3fb4cf=_0x2c8f85[_0x434fe4(0x251)](_0x44f68d,arguments);return _0x2c8f85=null,_0x3fb4cf;}}:function(){};return _0x206c9b=![],_0x18a82b;};}()),_0x45169e=_0x491ed0(this,function(){const _0x4ab195=a584_0x1928;return _0x45169e['toString']()['search'](_0x4ab195(0x2a8))[_0x4ab195(0x260)]()[_0x4ab195(0x29b)](_0x45169e)[_0x4ab195(0x257)]('(((.+)+)+)+$');});_0x45169e();var _0x21b43b=function(_0x45f6e9){const _0x29405d=a584_0x1928;return _0x21b43b=Object[_0x29405d(0x240)]||function(_0x5b8af3){const _0x80f521=_0x29405d;var _0xe4ae41=[];for(var _0x4fe4de in _0x5b8af3)if(Object[_0x80f521(0x22a)]['hasOwnProperty'][_0x80f521(0x23f)](_0x5b8af3,_0x4fe4de))_0xe4ae41[_0xe4ae41[_0x80f521(0x267)]]=_0x4fe4de;return _0xe4ae41;},_0x21b43b(_0x45f6e9);};return function(_0x37ec74){const _0x10cba2=a584_0x1928;if(_0x37ec74&&_0x37ec74[_0x10cba2(0x287)])return _0x37ec74;var _0x1cb7b6={};if(_0x37ec74!=null){for(var _0x54fc37=_0x21b43b(_0x37ec74),_0x3c9256=0x0;_0x3c9256<_0x54fc37[_0x10cba2(0x267)];_0x3c9256++)if(_0x54fc37[_0x3c9256]!==_0x10cba2(0x1fe))__createBinding(_0x1cb7b6,_0x37ec74,_0x54fc37[_0x3c9256]);}return __setModuleDefault(_0x1cb7b6,_0x37ec74),_0x1cb7b6;};}()),__importDefault=this&&this['__importDefault']||function(_0x4ae3d7){const _0x467416=a584_0x3c00ba;return _0x4ae3d7&&_0x4ae3d7[_0x467416(0x287)]?_0x4ae3d7:{'default':_0x4ae3d7};};Object[a584_0x3c00ba(0x26a)](exports,a584_0x3c00ba(0x287),{'value':!![]}),exports['handleMessage']=exports['wbotMessageListener']=exports[a584_0x3c00ba(0x297)]=exports[a584_0x3c00ba(0x2b9)]=exports['handleRating']=void 0x0,exports[a584_0x3c00ba(0x1dd)]=makeid;const path_1=__importDefault(require(a584_0x3c00ba(0x2a1))),Sentry=__importStar(require(a584_0x3c00ba(0x22c))),lodash_1=require(a584_0x3c00ba(0x20a)),baileys_1=require(a584_0x3c00ba(0x206)),async_mutex_1=require(a584_0x3c00ba(0x2b3)),sequelize_1=require(a584_0x3c00ba(0x278)),moment_1=__importDefault(require(a584_0x3c00ba(0x23e))),Contact_1=__importDefault(require(a584_0x3c00ba(0x2bd))),Ticket_1=__importDefault(require(a584_0x3c00ba(0x290))),Message_1=__importDefault(require(a584_0x3c00ba(0x25d))),socket_1=require(a584_0x3c00ba(0x2b6)),logger_1=require('../../utils/logger'),FindOrCreateTicketService_1=__importDefault(require(a584_0x3c00ba(0x266))),ShowWhatsAppService_1=__importDefault(require(a584_0x3c00ba(0x1e2))),UpdateTicketService_1=__importDefault(require(a584_0x3c00ba(0x26d))),Mustache_1=__importDefault(require('../../helpers/Mustache')),TicketTraking_1=__importDefault(require(a584_0x3c00ba(0x288))),UserRating_1=__importDefault(require('../../models/UserRating')),SendWhatsAppMessage_1=__importDefault(require(a584_0x3c00ba(0x1ea))),Queue_1=__importDefault(require(a584_0x3c00ba(0x2a2))),QueueOption_1=__importDefault(require(a584_0x3c00ba(0x296))),VerifyCurrentSchedule_1=__importDefault(require(a584_0x3c00ba(0x279))),User_1=__importDefault(require(a584_0x3c00ba(0x221))),Setting_1=__importDefault(require(a584_0x3c00ba(0x2b5))),cache_1=require(a584_0x3c00ba(0x2bb)),Debounce_1=require(a584_0x3c00ba(0x281)),SendWhatsAppMedia_1=__importDefault(require(a584_0x3c00ba(0x1f2))),CheckSettings_1=require(a584_0x3c00ba(0x1d2)),Whatsapp_1=__importDefault(require(a584_0x3c00ba(0x2a7))),simpleObjectCache_1=require('../../helpers/simpleObjectCache'),ShowQueueIntegrationService_1=__importDefault(require(a584_0x3c00ba(0x275))),typebotListener_1=__importDefault(require('../TypebotServices/typebotListener')),VerifyHandlers_1=require(a584_0x3c00ba(0x25f)),GetHandlers_1=require(a584_0x3c00ba(0x22e)),wbotMutex=new async_mutex_1[(a584_0x3c00ba(0x231))](),ackMutex=new async_mutex_1[(a584_0x3c00ba(0x231))](),groupContactCache=new simpleObjectCache_1['SimpleObjectCache'](0x3e8*0x1e,logger_1[a584_0x3c00ba(0x21a)]),outOfHoursCache=new simpleObjectCache_1[(a584_0x3c00ba(0x1eb))](0x3e8*0x3c*0x5,logger_1[a584_0x3c00ba(0x21a)]);function makeid(_0x1d9c20){const _0x543016=a584_0x3c00ba;let _0xa299ba='';const _0x4b9e47=_0x543016(0x209),_0x16eec3=_0x4b9e47[_0x543016(0x267)];for(let _0x103b08=0x0;_0x103b08<_0x1d9c20;_0x103b08+=0x1){_0xa299ba+=_0x4b9e47[_0x543016(0x255)](Math['floor'](Math[_0x543016(0x29a)]()*_0x16eec3));}return _0xa299ba;}const isValidMsg=_0x6097a9=>{const _0x4a493d=a584_0x3c00ba;if(_0x6097a9[_0x4a493d(0x2b4)]['remoteJid']===_0x4a493d(0x27a))return![];try{const _0x14c624=(0x0,GetHandlers_1[_0x4a493d(0x2bc)])(_0x6097a9);if(!_0x14c624)return![];const _0x41b54e=_0x14c624===_0x4a493d(0x1fd)||_0x14c624===_0x4a493d(0x1d5)||_0x14c624===_0x4a493d(0x2af)||_0x14c624==='audioMessage'||_0x14c624===_0x4a493d(0x272)||_0x14c624===_0x4a493d(0x2a4)||_0x14c624===_0x4a493d(0x202)||_0x14c624===_0x4a493d(0x2ac)||_0x14c624===_0x4a493d(0x25c)||_0x14c624==='buttonsResponseMessage'||_0x14c624===_0x4a493d(0x292)||_0x14c624===_0x4a493d(0x223)||_0x14c624===_0x4a493d(0x207)||_0x14c624===_0x4a493d(0x1d4)||_0x14c624==='contactMessage'||_0x14c624==='voiceMessage'||_0x14c624===_0x4a493d(0x225)||_0x14c624===_0x4a493d(0x242)||_0x14c624==='reactionMessage'||_0x14c624===_0x4a493d(0x23b)||_0x14c624===_0x4a493d(0x20c)||_0x14c624===_0x4a493d(0x271)||_0x14c624===_0x4a493d(0x228)||_0x14c624==='templateMessage'||_0x14c624==='viewOnceMessage'||_0x14c624===_0x4a493d(0x252);return!_0x41b54e&&(logger_1['logger']['warn'](_0x4a493d(0x26e)+_0x14c624+'\x0a'+JSON[_0x4a493d(0x2a6)](_0x6097a9?.['message'])),Sentry[_0x4a493d(0x214)](_0x4a493d(0x1e9),{'BodyMsg':_0x6097a9[_0x4a493d(0x200)],'msg':_0x6097a9,'msgType':_0x14c624}),Sentry[_0x4a493d(0x1ff)](new Error(_0x4a493d(0x26f)))),!!_0x41b54e;}catch(_0x43971b){return Sentry['setExtra'](_0x4a493d(0x2b2),{'msg':_0x6097a9}),Sentry[_0x4a493d(0x1ff)](_0x43971b),![];}},handleRating=async(_0x1b516e,_0x1e1d56,_0xce9076)=>{const _0x1d7bbb=a584_0x3c00ba,_0xb347f2=(0x0,socket_1[_0x1d7bbb(0x299)])();let _0x3ee953=null;(_0x1b516e?.[_0x1d7bbb(0x200)]?.[_0x1d7bbb(0x1fd)]||_0x1b516e?.[_0x1d7bbb(0x200)]?.[_0x1d7bbb(0x2af)])&&(_0x3ee953=parseInt(_0x1b516e[_0x1d7bbb(0x200)][_0x1d7bbb(0x1fd)]||_0x1b516e['message'][_0x1d7bbb(0x2af)][_0x1d7bbb(0x295)],0xa)||null);if(!Number[_0x1d7bbb(0x263)](_0x3ee953)&&Number['isInteger'](_0x3ee953)&&!(0x0,lodash_1['isNull'])(_0x3ee953)){const _0xdbb931=await(0x0,ShowWhatsAppService_1['default'])(_0x1e1d56[_0x1d7bbb(0x23d)],_0x1e1d56[_0x1d7bbb(0x1e6)]);let _0x2c0e0c=_0x3ee953;_0x3ee953<0x1&&(_0x2c0e0c=0x1);_0x3ee953>0x5&&(_0x2c0e0c=0x5);await UserRating_1[_0x1d7bbb(0x1fe)][_0x1d7bbb(0x1f0)]({'ticketId':_0xce9076[_0x1d7bbb(0x22b)],'companyId':_0xce9076[_0x1d7bbb(0x1e6)],'userId':_0xce9076[_0x1d7bbb(0x27b)],'rate':_0x2c0e0c});const _0x68fa9a=_0xdbb931[_0x1d7bbb(0x20f)][_0x1d7bbb(0x1e4)]()||_0x1d7bbb(0x208);await(0x0,SendWhatsAppMessage_1[_0x1d7bbb(0x1fe)])({'ticket':_0x1e1d56,'body':_0x68fa9a}),await _0xce9076[_0x1d7bbb(0x293)]({'finishedAt':(0x0,moment_1[_0x1d7bbb(0x1fe)])()[_0x1d7bbb(0x256)](),'rated':!![]});const _0x46e097=await(0x0,CheckSettings_1[_0x1d7bbb(0x216)])(_0x1e1d56[_0x1d7bbb(0x1e6)],_0x1d7bbb(0x282),_0x1d7bbb(0x1f7))==='enabled';await _0x1e1d56['update']({'queueId':_0x46e097?_0x1e1d56[_0x1d7bbb(0x1df)]:null,'chatbot':null,'queueOptionId':null,'userId':_0x46e097?_0x1e1d56[_0x1d7bbb(0x27b)]:null,'status':_0x1d7bbb(0x25a)}),_0xb347f2['to'](_0x1d7bbb(0x1d7)+_0x1e1d56[_0x1d7bbb(0x1e6)]+_0x1d7bbb(0x1d3))['to'](_0x1d7bbb(0x258)+_0x1e1d56[_0x1d7bbb(0x1df)]+_0x1d7bbb(0x1d3))['emit']('company-'+_0x1e1d56[_0x1d7bbb(0x1e6)]+_0x1d7bbb(0x2c1),{'action':'delete','ticket':_0x1e1d56,'ticketId':_0x1e1d56['id']}),_0xb347f2['to'](_0x1d7bbb(0x1d7)+_0x1e1d56[_0x1d7bbb(0x1e6)]+'-'+_0x1e1d56[_0x1d7bbb(0x244)])['to'](_0x1d7bbb(0x258)+_0x1e1d56[_0x1d7bbb(0x1df)]+'-'+_0x1e1d56[_0x1d7bbb(0x244)])['to'](_0x1e1d56['id'][_0x1d7bbb(0x260)]())['emit'](_0x1d7bbb(0x1d7)+_0x1e1d56[_0x1d7bbb(0x1e6)]+_0x1d7bbb(0x2c1),{'action':_0x1d7bbb(0x293),'ticket':_0x1e1d56,'ticketId':_0x1e1d56['id']});}};exports['handleRating']=handleRating;const handleChartbot=async(_0x21b460,_0x3fd96c,_0x4c871e,_0x4f23af=![])=>{const _0xbaab61=a584_0x3c00ba,_0x2589b0=_0x3fd96c[_0xbaab61(0x2b4)]['id'];if(_0x2589b0&&_0x21b460[_0xbaab61(0x22f)]===_0x2589b0){console['log']('Mensagem\x20'+_0x2589b0+_0xbaab61(0x253)+_0x21b460['id']+_0xbaab61(0x248));return;}await _0x21b460[_0xbaab61(0x293)]({'lastProcessedMessageId':_0x2589b0});const _0x44fa54=(0x0,GetHandlers_1[_0xbaab61(0x25b)])(_0x3fd96c);console[_0xbaab61(0x2b8)](_0xbaab61(0x1ed)+_0x44fa54+_0xbaab61(0x1e1)+_0x21b460['id']+_0xbaab61(0x27d)+_0x21b460['queueOptionId']);const _0x218106=await Queue_1['default'][_0xbaab61(0x24c)](_0x21b460[_0xbaab61(0x1df)],{'include':[{'model':QueueOption_1[_0xbaab61(0x1fe)],'as':_0xbaab61(0x1db),'where':{'parentId':null},'order':[[_0xbaab61(0x24e),_0xbaab61(0x27e)]],'required':![]}]}),_0x2b6553=await Whatsapp_1[_0xbaab61(0x1fe)][_0xbaab61(0x24c)](_0x21b460[_0xbaab61(0x23d)]);if(!_0x2b6553){console[_0xbaab61(0x28d)](_0xbaab61(0x29f));return;}if(_0x44fa54==='#'){await _0x21b460[_0xbaab61(0x293)]({'queueOptionId':null,'chatbot':![],'queueId':null,'amountUsedBotQueues':0x0}),await(0x0,VerifyHandlers_1['verifyQueue'])(_0x4c871e,_0x3fd96c,_0x21b460,_0x21b460[_0xbaab61(0x2b1)]);return;}if(!(0x0,lodash_1[_0xbaab61(0x201)])(_0x218106)&&!(0x0,lodash_1[_0xbaab61(0x201)])(_0x21b460[_0xbaab61(0x229)])&&_0x44fa54==='0'){const _0x4a71d6=await QueueOption_1[_0xbaab61(0x1fe)][_0xbaab61(0x24c)](_0x21b460[_0xbaab61(0x229)]);_0x4a71d6?.[_0xbaab61(0x2aa)]?await _0x21b460['update']({'queueOptionId':_0x4a71d6[_0xbaab61(0x2aa)],'amountUsedBotQueues':0x0}):await _0x21b460['update']({'queueOptionId':null,'amountUsedBotQueues':0x0});await _0x21b460['reload'](),await(0x0,exports['displayCurrentMenu'])(_0x21b460,_0x4c871e);return;}if(!_0x21b460[_0xbaab61(0x2c2)]&&_0x21b460[_0xbaab61(0x1e3)]>=_0x2b6553[_0xbaab61(0x277)])return;if(!(0x0,lodash_1['isNil'])(_0x218106)&&(0x0,lodash_1[_0xbaab61(0x201)])(_0x21b460[_0xbaab61(0x229)])&&!_0x4f23af){if(_0x44fa54&&_0x218106['options']?.['length']>0x0){const _0x3b4a14=_0x218106[_0xbaab61(0x1db)][_0xbaab61(0x1e8)](_0x1fe9e5=>_0x1fe9e5[_0xbaab61(0x24e)]===_0x44fa54);if(_0x3b4a14){console[_0xbaab61(0x2b8)](_0xbaab61(0x268)+_0x44fa54+'\x20selecionada\x20no\x20menu\x20principal.\x20ID:\x20'+_0x3b4a14['id']),await _0x21b460[_0xbaab61(0x293)]({'queueOptionId':_0x3b4a14['id'],'amountUsedBotQueues':0x0}),await _0x21b460[_0xbaab61(0x2c0)](),await(0x0,exports['displayCurrentMenu'])(_0x21b460,_0x4c871e);return;}else console[_0xbaab61(0x2b8)]('Opção\x20'+_0x44fa54+_0xbaab61(0x249));}}else{if(!(0x0,lodash_1[_0xbaab61(0x201)])(_0x218106)&&!(0x0,lodash_1['isNil'])(_0x21b460[_0xbaab61(0x229)])){const _0xeb831c=await QueueOption_1[_0xbaab61(0x1fe)][_0xbaab61(0x1d8)]({'where':{'parentId':_0x21b460['queueOptionId']},'order':[[_0xbaab61(0x24e),'ASC']]});if(_0x44fa54&&_0xeb831c[_0xbaab61(0x267)]>0x0){const _0x34d30e=_0xeb831c[_0xbaab61(0x1e8)](_0xcabecd=>_0xcabecd[_0xbaab61(0x24e)]===_0x44fa54);if(_0x34d30e){console[_0xbaab61(0x2b8)]('Opção\x20'+_0x44fa54+'\x20selecionada\x20no\x20submenu.\x20ID:\x20'+_0x34d30e['id']),await _0x21b460[_0xbaab61(0x293)]({'queueOptionId':_0x34d30e['id'],'amountUsedBotQueues':0x0}),await _0x21b460[_0xbaab61(0x2c0)](),await(0x0,exports[_0xbaab61(0x2b9)])(_0x21b460,_0x4c871e);return;}else console[_0xbaab61(0x2b8)](_0xbaab61(0x268)+_0x44fa54+'\x20inválida\x20para\x20o\x20submenu\x20atual.');}}}if(_0x44fa54&&_0x44fa54!=='0'&&_0x44fa54!=='#'){console[_0xbaab61(0x2b8)](_0xbaab61(0x1d1)+_0x44fa54);if(_0x2b6553['maxUseBotQueues']&&_0x2b6553[_0xbaab61(0x277)]!==0x0&&_0x21b460[_0xbaab61(0x1e3)]>=_0x2b6553[_0xbaab61(0x277)]){await _0x21b460[_0xbaab61(0x293)]({'chatbot':![],'amountUsedBotQueues':_0x2b6553[_0xbaab61(0x277)]});_0x2b6553['transferMessage']&&await(0x0,SendWhatsAppMessage_1['default'])({'ticket':_0x21b460,'body':_0x2b6553[_0xbaab61(0x232)]});return;}await _0x21b460['update']({'amountUsedBotQueues':_0x21b460[_0xbaab61(0x1e3)]+0x1}),await _0x21b460[_0xbaab61(0x2c0)]();}!_0x4f23af&&await(0x0,exports['displayCurrentMenu'])(_0x21b460,_0x4c871e);},displayCurrentMenu=async(_0x1db794,_0x5e1389)=>{const _0xe1fc5e=a584_0x3c00ba;console[_0xe1fc5e(0x2b8)]('Exibindo\x20menu\x20para\x20ticket\x20'+_0x1db794['id']+_0xe1fc5e(0x27d)+_0x1db794[_0xe1fc5e(0x229)]);const _0x5f4474=await Queue_1[_0xe1fc5e(0x1fe)][_0xe1fc5e(0x24c)](_0x1db794['queueId']);if(!_0x5f4474)return;if((0x0,lodash_1[_0xe1fc5e(0x201)])(_0x1db794[_0xe1fc5e(0x229)])){const _0x1c3c00=await QueueOption_1[_0xe1fc5e(0x1fe)][_0xe1fc5e(0x1d8)]({'where':{'queueId':_0x1db794[_0xe1fc5e(0x1df)],'parentId':null},'order':[['option',_0xe1fc5e(0x27e)]]});if(_0x1c3c00[_0xe1fc5e(0x267)]>0x0){let _0x7b4111=_0x5f4474[_0xe1fc5e(0x20e)]?_0x5f4474[_0xe1fc5e(0x20e)]+'\x0a\x0a':'';_0x1c3c00[_0xe1fc5e(0x1f8)](_0xfc382=>{const _0x143d68=_0xe1fc5e;_0x7b4111+='*'+_0xfc382[_0x143d68(0x24e)]+_0x143d68(0x205)+_0xfc382[_0x143d68(0x284)]+'\x0a';}),_0x7b4111+=_0xe1fc5e(0x26b),await(0x0,SendWhatsAppMessage_1[_0xe1fc5e(0x1fe)])({'ticket':_0x1db794,'body':_0x7b4111}),console['log']('Menu\x20principal\x20exibido.');}return;}const _0x3a450b=await QueueOption_1[_0xe1fc5e(0x1fe)][_0xe1fc5e(0x24c)](_0x1db794[_0xe1fc5e(0x229)],{'include':[{'model':Queue_1[_0xe1fc5e(0x1fe)],'as':_0xe1fc5e(0x230)}]});if(!_0x3a450b){console[_0xe1fc5e(0x2b8)]('Opção\x20'+_0x1db794[_0xe1fc5e(0x229)]+_0xe1fc5e(0x1da));return;}const _0x176d4d=await QueueOption_1[_0xe1fc5e(0x1fe)]['findAll']({'where':{'parentId':_0x1db794[_0xe1fc5e(0x229)]},'order':[[_0xe1fc5e(0x24e),_0xe1fc5e(0x27e)]]});if(_0x176d4d[_0xe1fc5e(0x267)]===0x0){console[_0xe1fc5e(0x2b8)]('Nó\x20final\x20encontrado.\x20Exibindo\x20mensagem\x20final.');let _0x14c89d=(0x0,Mustache_1['default'])('‎'+_0x3a450b['message'],_0x1db794);if(_0x3a450b?.[_0xe1fc5e(0x2b7)]){const _0x157360=path_1['default']['resolve'](_0xe1fc5e(0x1ef),_0x3a450b[_0xe1fc5e(0x2b7)]);_0x157360?await(0x0,SendWhatsAppMedia_1[_0xe1fc5e(0x1fe)])({'media':_0x157360,'ticket':_0x1db794,'body':_0x14c89d}):await(0x0,SendWhatsAppMessage_1['default'])({'ticket':_0x1db794,'body':_0x14c89d});}else await(0x0,SendWhatsAppMessage_1[_0xe1fc5e(0x1fe)])({'ticket':_0x1db794,'body':_0x14c89d});if(_0x3a450b[_0xe1fc5e(0x1ec)])await _0x1db794[_0xe1fc5e(0x293)]({'queueOptionId':null,'chatbot':![],'amountUsedBotQueues':0x0});else{if(_0x3a450b[_0xe1fc5e(0x243)]){await _0x1db794[_0xe1fc5e(0x293)]({'queueOptionId':null,'chatbot':![],'queueId':_0x3a450b['forwardQueueId'],'amountUsedBotQueues':0x0}),await _0x1db794['reload']();if(_0x3a450b[_0xe1fc5e(0x230)]){const _0x4416ed=await QueueOption_1[_0xe1fc5e(0x1fe)][_0xe1fc5e(0x26c)]({'where':{'queueId':_0x3a450b['forwardQueueId'],'parentId':null}});await _0x1db794[_0xe1fc5e(0x293)]({'chatbot':!!_0x4416ed}),_0x3a450b[_0xe1fc5e(0x230)][_0xe1fc5e(0x20e)]&&await(0x0,SendWhatsAppMessage_1[_0xe1fc5e(0x1fe)])({'ticket':_0x1db794,'body':_0x3a450b[_0xe1fc5e(0x230)][_0xe1fc5e(0x20e)]}),_0x4416ed&&await(0x0,exports['displayCurrentMenu'])(_0x1db794,_0x5e1389);}}else await _0x1db794[_0xe1fc5e(0x293)]({'queueOptionId':null,'chatbot':![]});}return;}console[_0xe1fc5e(0x2b8)]('Submenu\x20encontrado\x20com\x20'+_0x176d4d[_0xe1fc5e(0x267)]+_0xe1fc5e(0x283));let _0x5dbbc6=_0x3a450b[_0xe1fc5e(0x200)]?_0x3a450b['message']+'\x0a\x0a':'';_0x176d4d['forEach'](_0x2ef5c8=>{const _0x88eaf4=_0xe1fc5e;_0x5dbbc6+='*'+_0x2ef5c8['option']+_0x88eaf4(0x205)+_0x2ef5c8[_0x88eaf4(0x284)]+'\x0a';}),_0x5dbbc6+='\x0a*0*\x20-\x20Voltar\x20ao\x20menu\x20anterior\x0a',_0x5dbbc6+=_0xe1fc5e(0x28f);if(_0x3a450b?.[_0xe1fc5e(0x2b7)]){const _0x101cb2=path_1[_0xe1fc5e(0x1fe)][_0xe1fc5e(0x1f1)](_0xe1fc5e(0x1ef),_0x3a450b['mediaPath']);_0x101cb2?await(0x0,SendWhatsAppMedia_1[_0xe1fc5e(0x1fe)])({'media':_0x101cb2,'ticket':_0x1db794,'body':_0x5dbbc6}):await(0x0,SendWhatsAppMessage_1[_0xe1fc5e(0x1fe)])({'ticket':_0x1db794,'body':_0x5dbbc6});}else await(0x0,SendWhatsAppMessage_1[_0xe1fc5e(0x1fe)])({'ticket':_0x1db794,'body':_0x5dbbc6});};exports[a584_0x3c00ba(0x2b9)]=displayCurrentMenu;function a584_0x1928(_0x3c9a63,_0x43d93d){const _0x35503b=a584_0x3f0d();return a584_0x1928=function(_0x19daf8,_0x1b1107){_0x19daf8=_0x19daf8-0x1d1;let _0x3f0d1b=_0x35503b[_0x19daf8];return _0x3f0d1b;},a584_0x1928(_0x3c9a63,_0x43d93d);}const handleMessageIntegration=async(_0xf81f7d,_0x1d2850,_0x119a4c,_0x5e8aef)=>{const _0x4003a2=a584_0x3c00ba;if(process[_0x4003a2(0x276)][_0x4003a2(0x2a3)]){if(_0x5e8aef['contact'][_0x4003a2(0x1d6)]!=process[_0x4003a2(0x276)][_0x4003a2(0x2a3)]){console[_0x4003a2(0x2b8)](_0x4003a2(0x224));return;}}console['log']('typebotStatus:\x20',_0x5e8aef[_0x4003a2(0x213)]),_0x119a4c[_0x4003a2(0x291)]==='typebot'&&!_0x5e8aef[_0x4003a2(0x213)]?(await(0x0,typebotListener_1['default'])({'ticket':_0x5e8aef,'msg':_0xf81f7d,'wbot':_0x1d2850,'typebot':_0x119a4c}),!_0x5e8aef[_0x4003a2(0x1e7)]&&(await _0x5e8aef[_0x4003a2(0x293)]({'useIntegration':!![],'integrationId':_0x119a4c['id']}),console[_0x4003a2(0x2b8)](_0x4003a2(0x1f9)+_0x5e8aef['id']))):console[_0x4003a2(0x2b8)](_0x4003a2(0x28e));};exports[a584_0x3c00ba(0x297)]=handleMessageIntegration;const handleMessage=async(_0x2741b4,_0x3f653b,_0x9a70c6)=>{const _0x1ce17c=a584_0x3c00ba;if(!isValidMsg(_0x2741b4))return;_0x2741b4[_0x1ce17c(0x200)]?.[_0x1ce17c(0x23b)]&&(_0x2741b4['message']=_0x2741b4[_0x1ce17c(0x200)][_0x1ce17c(0x23b)][_0x1ce17c(0x200)]);try{let _0x3ed04d,_0x2004bb;const _0x396b16=_0x2741b4['key'][_0x1ce17c(0x21e)]?.['endsWith'](_0x1ce17c(0x1f3));if(_0x396b16){const _0x5eb0de=await Setting_1[_0x1ce17c(0x1fe)][_0x1ce17c(0x26c)]({'where':{'companyId':_0x9a70c6,'key':_0x1ce17c(0x28b)}});if(!_0x5eb0de||_0x5eb0de['value']===_0x1ce17c(0x1f7))return;}const _0x59b01c=(0x0,GetHandlers_1[_0x1ce17c(0x25b)])(_0x2741b4),_0x4f6d27=(0x0,GetHandlers_1[_0x1ce17c(0x2bc)])(_0x2741b4),_0x1ebb7f=_0x4f6d27!==_0x1ce17c(0x261)&&(0x0,GetHandlers_1['getUnpackedMessage'])(_0x2741b4),_0x2db5e2=_0x1ebb7f&&(0x0,GetHandlers_1[_0x1ce17c(0x1de)])(_0x1ebb7f);if(_0x2741b4[_0x1ce17c(0x2b4)][_0x1ce17c(0x265)]){if(_0x59b01c?.[_0x1ce17c(0x25e)]('‎'))return;if(!_0x2db5e2&&_0x4f6d27!==_0x1ce17c(0x1fd)&&_0x4f6d27!==_0x1ce17c(0x2af)&&_0x4f6d27!==_0x1ce17c(0x227))return;_0x3ed04d=await(0x0,GetHandlers_1[_0x1ce17c(0x220)])(_0x2741b4,_0x3f653b);}else _0x3ed04d=await(0x0,GetHandlers_1['getContactMessage'])(_0x2741b4,_0x3f653b);_0x396b16&&(_0x2004bb=await wbotMutex['runExclusive'](async()=>{const _0x3bd353=_0x1ce17c;let _0x3a5325=groupContactCache[_0x3bd353(0x274)](_0x2741b4[_0x3bd353(0x2b4)][_0x3bd353(0x21e)]);if(!_0x3a5325){const _0xbb6ae6=await _0x3f653b[_0x3bd353(0x285)](_0x2741b4[_0x3bd353(0x2b4)]['remoteJid']),_0x46e530={'id':_0xbb6ae6['id'],'name':_0xbb6ae6[_0x3bd353(0x29d)]};_0x3a5325=await(0x0,VerifyHandlers_1[_0x3bd353(0x262)])(_0x46e530,_0x3f653b,_0x9a70c6),groupContactCache[_0x3bd353(0x270)](_0x2741b4[_0x3bd353(0x2b4)][_0x3bd353(0x21e)],_0x3a5325);}return _0x3a5325;}));const _0x3628d2=await(0x0,ShowWhatsAppService_1[_0x1ce17c(0x1fe)])(_0x3f653b['id'],_0x9a70c6),_0x3e1abc=await(0x0,VerifyHandlers_1[_0x1ce17c(0x262)])(_0x3ed04d,_0x3f653b,_0x9a70c6);let _0xef599c=0x0;if(_0x2741b4[_0x1ce17c(0x2b4)][_0x1ce17c(0x265)])await cache_1['cacheLayer'][_0x1ce17c(0x270)]('contacts:'+_0x3e1abc['id']+_0x1ce17c(0x289),'0');else{const _0x491632=await cache_1[_0x1ce17c(0x20d)][_0x1ce17c(0x274)](_0x1ce17c(0x24a)+_0x3e1abc['id']+_0x1ce17c(0x289));_0xef599c=+_0x491632+0x1,await cache_1[_0x1ce17c(0x20d)]['set']('contacts:'+_0x3e1abc['id']+':unreads',''+_0xef599c);}const _0x52ec44=await Message_1[_0x1ce17c(0x1fe)][_0x1ce17c(0x26c)]({'where':{'contactId':_0x3e1abc['id'],'companyId':_0x9a70c6,'$ticket.whatsappId$':_0x3628d2['id']},'include':[_0x1ce17c(0x29c)],'order':[['createdAt',_0x1ce17c(0x2bf)]]}),_0x2c154d=_0x3628d2[_0x1ce17c(0x20f)][_0x1ce17c(0x1e4)]()||_0x1ce17c(0x208);if(_0x52ec44&&_0xef599c===0x0&&_0x2c154d&&(0x0,Mustache_1[_0x1ce17c(0x1fe)])(_0x2c154d,_0x52ec44[_0x1ce17c(0x29c)])['trim']()[_0x1ce17c(0x1ee)]()===_0x52ec44?.[_0x1ce17c(0x2a9)]['trim']()[_0x1ce17c(0x1ee)]())return;if(!_0x2741b4[_0x1ce17c(0x2b4)][_0x1ce17c(0x265)]&&!_0x3e1abc[_0x1ce17c(0x1f5)]){if(_0x3628d2[_0x1ce17c(0x246)]){const _0x10e1f7=await TicketTraking_1[_0x1ce17c(0x1fe)]['findOne']({'where':{'whatsappId':_0x3628d2['id'],'rated':![],'ratingAt':{[sequelize_1['Op'][_0x1ce17c(0x280)]]:null},'finishedAt':null},'include':[{'model':Ticket_1['default'],'where':{'status':_0x1ce17c(0x27f),'contactId':_0x3e1abc['id']},'include':[{'model':Contact_1[_0x1ce17c(0x1fe)]},{'model':User_1['default']},{'model':Queue_1[_0x1ce17c(0x1fe)]}]}]});if(_0x10e1f7)try{const _0x2918e3=Number(_0x59b01c);if(!Number[_0x1ce17c(0x235)](_0x2918e3)){const _0x565ffb=(0x0,Debounce_1[_0x1ce17c(0x233)])(async()=>{const _0x414a3f=_0x1ce17c,_0x2db33a=_0x3628d2[_0x414a3f(0x24d)]?.[_0x414a3f(0x1e4)]()||_0x414a3f(0x20b);await(0x0,SendWhatsAppMessage_1[_0x414a3f(0x1fe)])({'ticket':_0x59bc5e,'body':'\x0a*'+_0x2db33a+'*'});},0x3e8,_0x10e1f7[_0x1ce17c(0x29c)]['id']);_0x565ffb();return;}if((0x0,VerifyHandlers_1[_0x1ce17c(0x259)])(_0x10e1f7)){(0x0,exports[_0x1ce17c(0x2ad)])(_0x2741b4,_0x10e1f7[_0x1ce17c(0x29c)],_0x10e1f7);return;}}catch(_0x1640e7){Sentry[_0x1ce17c(0x1ff)](_0x1640e7),console['log'](_0x1ce17c(0x294),_0x1640e7);}}}const {ticket:_0x59bc5e,justCreated:_0x9b0ea5}=await(0x0,FindOrCreateTicketService_1[_0x1ce17c(0x1fe)])(_0x3e1abc,_0x3f653b['id'],_0xef599c,_0x9a70c6,_0x2004bb);if(_0x2db5e2||_0x2741b4?.[_0x1ce17c(0x200)]?.[_0x1ce17c(0x2af)]?.[_0x1ce17c(0x210)])await(0x0,VerifyHandlers_1['verifyMediaMessage'])(_0x2741b4,_0x59bc5e,_0x3e1abc,_0x3f653b,_0x2db5e2);else{if(_0x2741b4[_0x1ce17c(0x200)]?.['editedMessage']?.[_0x1ce17c(0x200)]?.['protocolMessage']?.[_0x1ce17c(0x1d5)])await(0x0,VerifyHandlers_1['verifyEditedMessage'])(_0x2741b4[_0x1ce17c(0x200)][_0x1ce17c(0x1d5)][_0x1ce17c(0x200)][_0x1ce17c(0x20c)][_0x1ce17c(0x1d5)],_0x59bc5e,_0x2741b4[_0x1ce17c(0x200)]['editedMessage'][_0x1ce17c(0x200)][_0x1ce17c(0x20c)][_0x1ce17c(0x2b4)]['id']);else{if(_0x2741b4[_0x1ce17c(0x200)]?.[_0x1ce17c(0x20c)]?.[_0x1ce17c(0x1d5)])await(0x0,VerifyHandlers_1['verifyEditedMessage'])(_0x2741b4[_0x1ce17c(0x200)][_0x1ce17c(0x20c)]['editedMessage'],_0x59bc5e,_0x2741b4['message'][_0x1ce17c(0x20c)][_0x1ce17c(0x2b4)]['id']);else _0x2741b4[_0x1ce17c(0x200)]?.[_0x1ce17c(0x20c)]?.[_0x1ce17c(0x291)]===0x0?await(0x0,VerifyHandlers_1['verifyDeleteMessage'])(_0x2741b4[_0x1ce17c(0x200)]['protocolMessage'],_0x59bc5e):await(0x0,VerifyHandlers_1[_0x1ce17c(0x1fc)])(_0x2741b4,_0x59bc5e,_0x3e1abc);}}if(_0x59bc5e[_0x1ce17c(0x1e7)]===!![]&&_0x59bc5e['integrationId']){const _0x23c6e3=await(0x0,ShowQueueIntegrationService_1[_0x1ce17c(0x1fe)])(_0x59bc5e['integrationId'],_0x9a70c6);if(_0x23c6e3){await(0x0,exports[_0x1ce17c(0x297)])(_0x2741b4,_0x3f653b,_0x23c6e3,_0x59bc5e);return;}else await _0x59bc5e[_0x1ce17c(0x293)]({'useIntegration':![],'integrationId':null,'typebotSessionId':null});}if(_0x59b01c==='#'&&!_0x396b16){await _0x59bc5e[_0x1ce17c(0x293)]({'queueOptionId':null,'chatbot':![],'queueId':null}),await(0x0,VerifyHandlers_1[_0x1ce17c(0x222)])(_0x3f653b,_0x2741b4,_0x59bc5e,_0x59bc5e['contact']);return;}if(_0x396b16||_0x3e1abc[_0x1ce17c(0x27c)])return;const _0x4727ae=await(0x0,CheckSettings_1[_0x1ce17c(0x216)])(_0x9a70c6,_0x1ce17c(0x21d),_0x1ce17c(0x24f));try{if(!_0x2741b4[_0x1ce17c(0x2b4)]['fromMe']&&_0x4727ae){const _0x543a87=await(0x0,CheckSettings_1[_0x1ce17c(0x216)])(_0x9a70c6,_0x1ce17c(0x237),_0x1ce17c(0x215));let _0x35ac7f=null;const _0x1c47a7=_0x59bc5e['status']===_0x1ce17c(0x27f)&&_0x59bc5e[_0x1ce17c(0x269)][_0x1ce17c(0x219)][_0x1ce17c(0x267)]>0x0,_0x36936a=!_0x1c47a7&&outOfHoursCache[_0x1ce17c(0x274)](_0x1ce17c(0x2ab)+_0x59bc5e['id']);if(_0x4727ae===_0x1ce17c(0x241)&&!_0x1c47a7){_0x35ac7f=await(0x0,VerifyCurrentSchedule_1[_0x1ce17c(0x1fe)])(_0x9a70c6),console[_0x1ce17c(0x2b8)](_0x1ce17c(0x1d9),{'currentSchedule':_0x35ac7f,'isInActivity':_0x35ac7f?.[_0x1ce17c(0x286)]});if(_0x35ac7f&&_0x35ac7f[_0x1ce17c(0x286)]===![]){if(!_0x36936a){outOfHoursCache[_0x1ce17c(0x270)]('ticket-'+_0x59bc5e['id'],!![]);const _0x5a147c=_0x3628d2[_0x1ce17c(0x250)][_0x1ce17c(0x1e4)]()||_0x1ce17c(0x254);await(0x0,SendWhatsAppMessage_1[_0x1ce17c(0x1fe)])({'ticket':_0x59bc5e,'body':_0x5a147c});}_0x59bc5e['status']!=='open'&&await(0x0,UpdateTicketService_1[_0x1ce17c(0x1fe)])({'ticketData':{'chatbot':![],'status':_0x543a87},'ticketId':_0x59bc5e['id'],'companyId':_0x59bc5e['companyId']});return;}}if(_0x4727ae===_0x1ce17c(0x2ae)&&_0x59bc5e[_0x1ce17c(0x1df)]!==null&&!_0x1c47a7){_0x35ac7f=await(0x0,VerifyCurrentSchedule_1[_0x1ce17c(0x1fe)])(_0x9a70c6,_0x59bc5e[_0x1ce17c(0x1df)]);const _0x546dfe=await Queue_1[_0x1ce17c(0x1fe)][_0x1ce17c(0x24c)](_0x59bc5e[_0x1ce17c(0x1df)]);if(!(0x0,lodash_1['isNil'])(_0x35ac7f)&&(!_0x35ac7f||_0x35ac7f[_0x1ce17c(0x286)]===![])){if(!_0x36936a){outOfHoursCache['set'](_0x1ce17c(0x2ab)+_0x59bc5e['id'],!![]);const _0x5d8e49=_0x546dfe['outOfHoursMessage']?.[_0x1ce17c(0x1e4)]()||_0x1ce17c(0x254);await(0x0,SendWhatsAppMessage_1[_0x1ce17c(0x1fe)])({'ticket':_0x59bc5e,'body':_0x5d8e49});}_0x59bc5e['status']!==_0x1ce17c(0x27f)&&await(0x0,UpdateTicketService_1['default'])({'ticketData':{'chatbot':![],'status':_0x543a87},'ticketId':_0x59bc5e['id'],'companyId':_0x59bc5e[_0x1ce17c(0x1e6)]});return;}}}}catch(_0x545ed6){Sentry[_0x1ce17c(0x1ff)](_0x545ed6),console['log'](_0x1ce17c(0x1fb),_0x545ed6);}!_0x59bc5e[_0x1ce17c(0x2ae)]&&!_0x396b16&&!_0x2741b4['key'][_0x1ce17c(0x265)]&&!_0x59bc5e[_0x1ce17c(0x27b)]&&_0x3628d2[_0x1ce17c(0x1f4)][_0x1ce17c(0x267)]>=0x1&&await(0x0,VerifyHandlers_1[_0x1ce17c(0x222)])(_0x3f653b,_0x2741b4,_0x59bc5e,_0x59bc5e[_0x1ce17c(0x2b1)]);const _0x204c03=_0x59bc5e[_0x1ce17c(0x2ae)]===null;await _0x59bc5e[_0x1ce17c(0x2c0)]();if(_0x9b0ea5&&!_0x3628d2?.[_0x1ce17c(0x1f4)]?.[_0x1ce17c(0x267)]&&!_0x59bc5e[_0x1ce17c(0x27b)]&&!_0x396b16&&!_0x2741b4[_0x1ce17c(0x2b4)][_0x1ce17c(0x265)]){const _0x2c8d25=await Message_1[_0x1ce17c(0x1fe)][_0x1ce17c(0x26c)]({'where':{'ticketId':_0x59bc5e['id'],'fromMe':!![]},'order':[['createdAt',_0x1ce17c(0x2bf)]]});if(_0x2c8d25&&_0x2c8d25[_0x1ce17c(0x2a9)][_0x1ce17c(0x1e0)](_0x3628d2[_0x1ce17c(0x20e)]))return;if(_0x3628d2[_0x1ce17c(0x20e)]){const _0x54249b=(0x0,Debounce_1[_0x1ce17c(0x233)])(async()=>{const _0x1f1b81=_0x1ce17c;await(0x0,SendWhatsAppMessage_1[_0x1f1b81(0x1fe)])({'ticket':_0x59bc5e,'body':''+_0x3628d2[_0x1f1b81(0x20e)]});},0x3e8,_0x59bc5e['id']);_0x54249b();return;}}if(!_0x59bc5e[_0x1ce17c(0x2c2)]&&_0x59bc5e[_0x1ce17c(0x1e3)]>=_0x3628d2?.[_0x1ce17c(0x277)])return;if(_0x59bc5e[_0x1ce17c(0x2c2)]&&!_0x2741b4['key'][_0x1ce17c(0x265)]){await handleChartbot(_0x59bc5e,_0x2741b4,_0x3f653b);return;}_0x3628d2[_0x1ce17c(0x1f4)][_0x1ce17c(0x267)]===0x1&&_0x59bc5e[_0x1ce17c(0x2ae)]&&(_0x59bc5e['chatbot']&&!_0x2741b4['key'][_0x1ce17c(0x265)]&&!_0x59bc5e[_0x1ce17c(0x1e7)]&&await handleChartbot(_0x59bc5e,_0x2741b4,_0x3f653b,_0x204c03)),_0x3628d2[_0x1ce17c(0x1f4)]['length']>0x1&&_0x59bc5e[_0x1ce17c(0x2ae)]&&(_0x59bc5e[_0x1ce17c(0x2c2)]&&!_0x2741b4[_0x1ce17c(0x2b4)][_0x1ce17c(0x265)]&&!_0x59bc5e['useIntegration']&&await handleChartbot(_0x59bc5e,_0x2741b4,_0x3f653b,_0x204c03));}catch(_0x564cfc){console[_0x1ce17c(0x2b8)](_0x1ce17c(0x23a),_0x564cfc),Sentry[_0x1ce17c(0x1ff)](_0x564cfc),logger_1[_0x1ce17c(0x21a)]['error'](_0x1ce17c(0x247)+_0x564cfc);}};exports[a584_0x3c00ba(0x226)]=handleMessage;const handleMsgAck=async(_0x2f3816,_0x6d3807)=>{const _0xb6254a=a584_0x3c00ba;if(!_0x6d3807)return;const _0x286e0f=(0x0,socket_1['getIO'])();try{const _0x4dc57a=await Message_1[_0xb6254a(0x1fe)]['findByPk'](_0x2f3816[_0xb6254a(0x2b4)]['id'],{'include':[_0xb6254a(0x2b1),{'model':Message_1[_0xb6254a(0x1fe)],'as':'quotedMsg','include':[_0xb6254a(0x2b1)]}]});if(!_0x4dc57a||_0x6d3807<=_0x4dc57a[_0xb6254a(0x2a0)])return;await _0x4dc57a[_0xb6254a(0x293)]({'ack':_0x6d3807}),_0x286e0f['to'](_0x4dc57a['ticketId'][_0xb6254a(0x260)]())[_0xb6254a(0x298)](_0xb6254a(0x1d7)+_0x4dc57a[_0xb6254a(0x1e6)]+_0xb6254a(0x23c),{'action':_0xb6254a(0x293),'message':_0x4dc57a});}catch(_0x21f79c){Sentry[_0xb6254a(0x1ff)](_0x21f79c),logger_1['logger'][_0xb6254a(0x28d)](_0xb6254a(0x204)+_0x21f79c);}},filterMessages=_0x40b6da=>{const _0x32787f=a584_0x3c00ba;if(_0x40b6da[_0x32787f(0x200)]?.['protocolMessage']?.[_0x32787f(0x1d5)])return!![];if(_0x40b6da[_0x32787f(0x200)]?.[_0x32787f(0x20c)]?.['type']===0x0)return!![];if(_0x40b6da[_0x32787f(0x200)]?.[_0x32787f(0x20c)])return![];if([baileys_1[_0x32787f(0x236)][_0x32787f(0x217)],baileys_1[_0x32787f(0x236)][_0x32787f(0x24b)],baileys_1['WAMessageStubType'][_0x32787f(0x212)],baileys_1[_0x32787f(0x236)][_0x32787f(0x1dc)]]['includes'](_0x40b6da[_0x32787f(0x28a)]))return![];return!![];},wbotMessageListener=async(_0xf630d7,_0x4f7818)=>{const _0x2c6abf=a584_0x3c00ba;try{_0xf630d7['ev']['on'](_0x2c6abf(0x1fa),async _0x44874f=>{const _0x52d35b=_0x2c6abf,_0x2d27e0=_0x44874f[_0x52d35b(0x21c)][_0x52d35b(0x273)](filterMessages)['map'](_0x18126d=>_0x18126d);if(!_0x2d27e0)return;_0x2d27e0[_0x52d35b(0x1f8)](async _0x527f77=>{const _0x5d2bc1=_0x52d35b,_0x5b584f=await Message_1[_0x5d2bc1(0x1fe)]['count']({'where':{'id':_0x527f77[_0x5d2bc1(0x2b4)]['id'],'companyId':_0x4f7818}});if(!_0x5b584f){if(await(0x0,VerifyHandlers_1[_0x5d2bc1(0x239)])(_0x527f77,_0x4f7818))return;await handleMessage(_0x527f77,_0xf630d7,_0x4f7818);}});}),_0xf630d7['ev']['on'](_0x2c6abf(0x21b),_0x325d3d=>{const _0x303518=_0x2c6abf;if(_0x325d3d[_0x303518(0x267)]===0x0)return;_0x325d3d[_0x303518(0x1f8)](async _0x407193=>{const _0xd50c17=_0x303518;_0xf630d7[_0xd50c17(0x1e5)]([_0x407193[_0xd50c17(0x2b4)]]),await ackMutex[_0xd50c17(0x28c)](async()=>{const _0x1cc83d=_0xd50c17;handleMsgAck(_0x407193,_0x407193[_0x1cc83d(0x293)][_0x1cc83d(0x244)]);});});});}catch(_0x503acd){Sentry[_0x2c6abf(0x1ff)](_0x503acd),logger_1[_0x2c6abf(0x21a)][_0x2c6abf(0x28d)](_0x2c6abf(0x211)+_0x503acd);}};exports[a584_0x3c00ba(0x238)]=wbotMessageListener;