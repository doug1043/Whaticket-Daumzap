'use strict';const a584_0x4389f2=a584_0x3da0;(function(_0x2904c5,_0x22bc5e){const _0xf44b1c=a584_0x3da0,_0x5b42f8=_0x2904c5();while(!![]){try{const _0x5b7cad=parseInt(_0xf44b1c(0x176))/0x1+-parseInt(_0xf44b1c(0xe6))/0x2+-parseInt(_0xf44b1c(0x15f))/0x3+-parseInt(_0xf44b1c(0x163))/0x4+-parseInt(_0xf44b1c(0x12c))/0x5+parseInt(_0xf44b1c(0x118))/0x6*(parseInt(_0xf44b1c(0xd2))/0x7)+-parseInt(_0xf44b1c(0xfb))/0x8*(-parseInt(_0xf44b1c(0xd1))/0x9);if(_0x5b7cad===_0x22bc5e)break;else _0x5b42f8['push'](_0x5b42f8['shift']());}catch(_0x48bf28){_0x5b42f8['push'](_0x5b42f8['shift']());}}}(a584_0x31e6,0xcb45f));var __createBinding=this&&this[a584_0x4389f2(0x147)]||(Object[a584_0x4389f2(0x14e)]?function(_0x36bab1,_0x57b3c8,_0x30c670,_0x3ac6cc){const _0x5268c3=a584_0x4389f2;if(_0x3ac6cc===undefined)_0x3ac6cc=_0x30c670;var _0x2b3e2f=Object[_0x5268c3(0xb1)](_0x57b3c8,_0x30c670);(!_0x2b3e2f||(_0x5268c3(0x18f)in _0x2b3e2f?!_0x57b3c8['__esModule']:_0x2b3e2f[_0x5268c3(0x11c)]||_0x2b3e2f[_0x5268c3(0xe1)]))&&(_0x2b3e2f={'enumerable':!![],'get':function(){return _0x57b3c8[_0x30c670];}}),Object[_0x5268c3(0x10a)](_0x36bab1,_0x3ac6cc,_0x2b3e2f);}:function(_0x4708cb,_0x12983c,_0x32d784,_0x28ff0d){if(_0x28ff0d===undefined)_0x28ff0d=_0x32d784;_0x4708cb[_0x28ff0d]=_0x12983c[_0x32d784];}),__setModuleDefault=this&&this[a584_0x4389f2(0x134)]||(Object['create']?function(_0x4f8bbd,_0x372b6c){const _0x1f75b6=a584_0x4389f2;Object[_0x1f75b6(0x10a)](_0x4f8bbd,_0x1f75b6(0xa8),{'enumerable':!![],'value':_0x372b6c});}:function(_0x4c6a8b,_0x2ec51c){const _0x536b56=a584_0x4389f2;_0x4c6a8b[_0x536b56(0xa8)]=_0x2ec51c;}),__importStar=this&&this[a584_0x4389f2(0x16a)]||(function(){const _0x280253=(function(){let _0x25fa6c=!![];return function(_0x7de848,_0x28e0ca){const _0x2ecb6b=_0x25fa6c?function(){const _0x5e203a=a584_0x3da0;if(_0x28e0ca){const _0x270e6a=_0x28e0ca[_0x5e203a(0x14c)](_0x7de848,arguments);return _0x28e0ca=null,_0x270e6a;}}:function(){};return _0x25fa6c=![],_0x2ecb6b;};}()),_0x41a6de=_0x280253(this,function(){const _0xd01503=a584_0x3da0;return _0x41a6de[_0xd01503(0x128)]()['search'](_0xd01503(0xe2))[_0xd01503(0x128)]()[_0xd01503(0x153)](_0x41a6de)[_0xd01503(0x11e)](_0xd01503(0xe2));});_0x41a6de();var _0x1262de=function(_0xe5c5d0){return _0x1262de=Object['getOwnPropertyNames']||function(_0x6e5b09){const _0x3f47a4=a584_0x3da0;var _0x4b45e8=[];for(var _0x2377d4 in _0x6e5b09)if(Object[_0x3f47a4(0xa7)][_0x3f47a4(0x138)][_0x3f47a4(0x108)](_0x6e5b09,_0x2377d4))_0x4b45e8[_0x4b45e8[_0x3f47a4(0x191)]]=_0x2377d4;return _0x4b45e8;},_0x1262de(_0xe5c5d0);};return function(_0x1ad4c0){const _0x3fcca2=a584_0x3da0;if(_0x1ad4c0&&_0x1ad4c0[_0x3fcca2(0xf9)])return _0x1ad4c0;var _0x3a23fc={};if(_0x1ad4c0!=null){for(var _0xfe5249=_0x1262de(_0x1ad4c0),_0xf84cec=0x0;_0xf84cec<_0xfe5249[_0x3fcca2(0x191)];_0xf84cec++)if(_0xfe5249[_0xf84cec]!==_0x3fcca2(0xa8))__createBinding(_0x3a23fc,_0x1ad4c0,_0xfe5249[_0xf84cec]);}return __setModuleDefault(_0x3a23fc,_0x1ad4c0),_0x3a23fc;};}()),__importDefault=this&&this[a584_0x4389f2(0x140)]||function(_0x3a9eca){const _0x49994f=a584_0x4389f2;return _0x3a9eca&&_0x3a9eca[_0x49994f(0xf9)]?_0x3a9eca:{'default':_0x3a9eca};};Object[a584_0x4389f2(0x10a)](exports,a584_0x4389f2(0xf9),{'value':!![]}),exports[a584_0x4389f2(0xc7)]=exports[a584_0x4389f2(0xc3)]=exports[a584_0x4389f2(0x199)]=exports[a584_0x4389f2(0xec)]=exports[a584_0x4389f2(0xf1)]=void 0x0,exports[a584_0x4389f2(0x109)]=makeid;const path_1=__importDefault(require('path')),Sentry=__importStar(require(a584_0x4389f2(0x192))),lodash_1=require(a584_0x4389f2(0x127)),baileys_1=require(a584_0x4389f2(0xdd)),async_mutex_1=require(a584_0x4389f2(0x189)),sequelize_1=require('sequelize'),moment_1=__importDefault(require(a584_0x4389f2(0xa6))),Contact_1=__importDefault(require(a584_0x4389f2(0x187))),Ticket_1=__importDefault(require(a584_0x4389f2(0x139))),Message_1=__importDefault(require('../../models/Message')),socket_1=require('../../libs/socket'),logger_1=require(a584_0x4389f2(0x135)),FindOrCreateTicketService_1=__importDefault(require(a584_0x4389f2(0xbf))),ShowWhatsAppService_1=__importDefault(require('../WhatsappService/ShowWhatsAppService')),UpdateTicketService_1=__importDefault(require(a584_0x4389f2(0xa5))),Mustache_1=__importDefault(require(a584_0x4389f2(0xeb))),TicketTraking_1=__importDefault(require(a584_0x4389f2(0x15a))),UserRating_1=__importDefault(require('../../models/UserRating')),SendWhatsAppMessage_1=__importDefault(require(a584_0x4389f2(0xca))),Queue_1=__importDefault(require(a584_0x4389f2(0x149))),QueueOption_1=__importDefault(require(a584_0x4389f2(0x164))),VerifyCurrentSchedule_1=__importDefault(require(a584_0x4389f2(0x15b))),User_1=__importDefault(require(a584_0x4389f2(0xdc))),Setting_1=__importDefault(require(a584_0x4389f2(0x169))),cache_1=require(a584_0x4389f2(0xfc)),Debounce_1=require(a584_0x4389f2(0x105)),SendWhatsAppMedia_1=__importDefault(require(a584_0x4389f2(0xe9))),CheckSettings_1=require(a584_0x4389f2(0x16f)),Whatsapp_1=__importDefault(require(a584_0x4389f2(0xba))),simpleObjectCache_1=require(a584_0x4389f2(0x136)),ShowQueueIntegrationService_1=__importDefault(require(a584_0x4389f2(0x14f))),typebotListener_1=__importDefault(require(a584_0x4389f2(0xbd))),VerifyHandlers_1=require(a584_0x4389f2(0xc4)),GetHandlers_1=require('./GetHandlers'),wbotMutex=new async_mutex_1[(a584_0x4389f2(0x197))](),ackMutex=new async_mutex_1['Mutex'](),groupContactCache=new simpleObjectCache_1[(a584_0x4389f2(0x182))](0x3e8*0x1e,logger_1[a584_0x4389f2(0xd7)]),outOfHoursCache=new simpleObjectCache_1[(a584_0x4389f2(0x182))](0x3e8*0x3c*0x5,logger_1[a584_0x4389f2(0xd7)]);function makeid(_0x10c6dd){const _0x2fdcfb=a584_0x4389f2;let _0xa6b9ea='';const _0x2ea27b=_0x2fdcfb(0x114),_0x23c39a=_0x2ea27b['length'];for(let _0x3d3184=0x0;_0x3d3184<_0x10c6dd;_0x3d3184+=0x1){_0xa6b9ea+=_0x2ea27b[_0x2fdcfb(0x155)](Math[_0x2fdcfb(0xc5)](Math['random']()*_0x23c39a));}return _0xa6b9ea;}const isValidMsg=_0x147617=>{const _0x5ede1c=a584_0x4389f2;if(_0x147617['key'][_0x5ede1c(0x116)]==='status@broadcast')return![];try{const _0x2f176f=(0x0,GetHandlers_1[_0x5ede1c(0x194)])(_0x147617);if(!_0x2f176f)return![];const _0x133b63=_0x2f176f==='conversation'||_0x2f176f==='editedMessage'||_0x2f176f==='extendedTextMessage'||_0x2f176f===_0x5ede1c(0xaf)||_0x2f176f==='videoMessage'||_0x2f176f===_0x5ede1c(0xf0)||_0x2f176f===_0x5ede1c(0xe5)||_0x2f176f===_0x5ede1c(0x154)||_0x2f176f===_0x5ede1c(0x12f)||_0x2f176f===_0x5ede1c(0x198)||_0x2f176f===_0x5ede1c(0x15d)||_0x2f176f===_0x5ede1c(0x15c)||_0x2f176f===_0x5ede1c(0xee)||_0x2f176f===_0x5ede1c(0x13b)||_0x2f176f===_0x5ede1c(0x10e)||_0x2f176f===_0x5ede1c(0xe7)||_0x2f176f==='mediaMessage'||_0x2f176f===_0x5ede1c(0x10d)||_0x2f176f===_0x5ede1c(0x16e)||_0x2f176f==='ephemeralMessage'||_0x2f176f===_0x5ede1c(0xc2)||_0x2f176f===_0x5ede1c(0x16d)||_0x2f176f===_0x5ede1c(0x185)||_0x2f176f==='templateMessage'||_0x2f176f==='viewOnceMessage'||_0x2f176f===_0x5ede1c(0xd0);return!_0x133b63&&(logger_1['logger'][_0x5ede1c(0x15e)]('####\x20Nao\x20achou\x20o\x20type\x20em\x20isValidMsg:\x20'+_0x2f176f+'\x0a'+JSON[_0x5ede1c(0x160)](_0x147617?.[_0x5ede1c(0xbb)])),Sentry[_0x5ede1c(0x17f)](_0x5ede1c(0xa3),{'BodyMsg':_0x147617[_0x5ede1c(0xbb)],'msg':_0x147617,'msgType':_0x2f176f}),Sentry[_0x5ede1c(0x112)](new Error(_0x5ede1c(0x179)))),!!_0x133b63;}catch(_0x1fc1be){return Sentry[_0x5ede1c(0x17f)](_0x5ede1c(0x129),{'msg':_0x147617}),Sentry[_0x5ede1c(0x112)](_0x1fc1be),![];}},handleRating=async(_0x5ea0b3,_0x433632,_0x478bfc)=>{const _0x112252=a584_0x4389f2,_0x17ce13=(0x0,socket_1[_0x112252(0xc1)])();let _0x2caebc=null;(_0x5ea0b3?.[_0x112252(0xbb)]?.[_0x112252(0x13f)]||_0x5ea0b3?.['message']?.['extendedTextMessage'])&&(_0x2caebc=parseInt(_0x5ea0b3[_0x112252(0xbb)][_0x112252(0x13f)]||_0x5ea0b3[_0x112252(0xbb)]['extendedTextMessage'][_0x112252(0x115)],0xa)||null);if(!Number[_0x112252(0xa2)](_0x2caebc)&&Number[_0x112252(0xa9)](_0x2caebc)&&!(0x0,lodash_1['isNull'])(_0x2caebc)){const _0x2b072b=await(0x0,ShowWhatsAppService_1[_0x112252(0xa8)])(_0x433632[_0x112252(0x193)],_0x433632[_0x112252(0xb9)]);let _0x5e6745=_0x2caebc;_0x2caebc<0x1&&(_0x5e6745=0x1);_0x2caebc>0x5&&(_0x5e6745=0x5);await UserRating_1[_0x112252(0xa8)][_0x112252(0x14e)]({'ticketId':_0x478bfc[_0x112252(0x126)],'companyId':_0x478bfc[_0x112252(0xb9)],'userId':_0x478bfc[_0x112252(0x159)],'rate':_0x5e6745});const _0x3ce31b=_0x2b072b[_0x112252(0xe4)]['trim']()||_0x112252(0x110);await(0x0,SendWhatsAppMessage_1[_0x112252(0xa8)])({'ticket':_0x433632,'body':_0x3ce31b}),await _0x478bfc[_0x112252(0x10f)]({'finishedAt':(0x0,moment_1[_0x112252(0xa8)])()[_0x112252(0x196)](),'rated':!![]});const _0x44f6d8=await(0x0,CheckSettings_1[_0x112252(0x146)])(_0x433632[_0x112252(0xb9)],_0x112252(0x117),_0x112252(0xb8))===_0x112252(0xb8);await _0x433632[_0x112252(0x10f)]({'queueId':_0x44f6d8?_0x433632[_0x112252(0x148)]:null,'chatbot':null,'queueOptionId':null,'userId':_0x44f6d8?_0x433632[_0x112252(0x159)]:null,'status':'closed'}),_0x17ce13['to']('company-'+_0x433632[_0x112252(0xb9)]+_0x112252(0x144))['to']('queue-'+_0x433632[_0x112252(0x148)]+'-open')['emit'](_0x112252(0x150)+_0x433632['companyId']+'-ticket',{'action':'delete','ticket':_0x433632,'ticketId':_0x433632['id']}),_0x17ce13['to'](_0x112252(0x150)+_0x433632['companyId']+'-'+_0x433632[_0x112252(0x12d)])['to'](_0x112252(0xf5)+_0x433632[_0x112252(0x148)]+'-'+_0x433632[_0x112252(0x12d)])['to'](_0x433632['id'][_0x112252(0x128)]())[_0x112252(0x125)](_0x112252(0x150)+_0x433632[_0x112252(0xb9)]+'-ticket',{'action':_0x112252(0x10f),'ticket':_0x433632,'ticketId':_0x433632['id']});}};exports[a584_0x4389f2(0xf1)]=handleRating;const handleChartbot=async(_0x4d083f,_0x509eb1,_0x1dba18,_0x4d8a45=![])=>{const _0x340e55=a584_0x4389f2,_0x2c31a6=_0x509eb1[_0x340e55(0xf4)]['id'];if(_0x2c31a6&&_0x4d083f[_0x340e55(0x131)]===_0x2c31a6){console[_0x340e55(0xd4)](_0x340e55(0x14d)+_0x2c31a6+_0x340e55(0xb7)+_0x4d083f['id']+_0x340e55(0x17d));return;}await _0x4d083f[_0x340e55(0x10f)]({'lastProcessedMessageId':_0x2c31a6});const _0x253f5a=(0x0,GetHandlers_1[_0x340e55(0x106)])(_0x509eb1);console['log'](_0x340e55(0x122)+_0x253f5a+_0x340e55(0xfe)+_0x4d083f['id']+_0x340e55(0x162)+_0x4d083f[_0x340e55(0x10c)]);const _0x2aa54b=await Queue_1[_0x340e55(0xa8)][_0x340e55(0xea)](_0x4d083f['queueId'],{'include':[{'model':QueueOption_1[_0x340e55(0xa8)],'as':_0x340e55(0x18c),'where':{'parentId':null},'order':[[_0x340e55(0x172),_0x340e55(0x102)]],'required':![]}]}),_0x53941d=await Whatsapp_1[_0x340e55(0xa8)][_0x340e55(0xea)](_0x4d083f[_0x340e55(0x193)]);if(!_0x53941d){console[_0x340e55(0x10b)](_0x340e55(0x107));return;}if(_0x253f5a==='#'){await _0x4d083f[_0x340e55(0x10f)]({'queueOptionId':null,'chatbot':![],'queueId':null,'amountUsedBotQueues':0x0}),await(0x0,VerifyHandlers_1['verifyQueue'])(_0x1dba18,_0x509eb1,_0x4d083f,_0x4d083f['contact']);return;}if(!(0x0,lodash_1[_0x340e55(0xd6)])(_0x2aa54b)&&!(0x0,lodash_1['isNil'])(_0x4d083f[_0x340e55(0x10c)])&&_0x253f5a==='0'){const _0x2203f1=await QueueOption_1[_0x340e55(0xa8)][_0x340e55(0xea)](_0x4d083f[_0x340e55(0x10c)]);_0x2203f1?.[_0x340e55(0xcf)]?await _0x4d083f[_0x340e55(0x10f)]({'queueOptionId':_0x2203f1[_0x340e55(0xcf)],'amountUsedBotQueues':0x0}):await _0x4d083f[_0x340e55(0x10f)]({'queueOptionId':null,'amountUsedBotQueues':0x0});await _0x4d083f['reload'](),await(0x0,exports[_0x340e55(0xec)])(_0x4d083f,_0x1dba18);return;}if(!_0x4d083f[_0x340e55(0x183)]&&_0x4d083f[_0x340e55(0x18a)]>=_0x53941d['maxUseBotQueues'])return;if(!(0x0,lodash_1[_0x340e55(0xd6)])(_0x2aa54b)&&(0x0,lodash_1[_0x340e55(0xd6)])(_0x4d083f[_0x340e55(0x10c)])&&!_0x4d8a45){if(_0x253f5a&&_0x2aa54b['options']?.[_0x340e55(0x191)]>0x0){const _0x559539=_0x2aa54b[_0x340e55(0x18c)][_0x340e55(0x133)](_0x5e4cec=>_0x5e4cec[_0x340e55(0x172)]===_0x253f5a);if(_0x559539){console[_0x340e55(0xd4)]('Opção\x20'+_0x253f5a+_0x340e55(0xf7)+_0x559539['id']),await _0x4d083f[_0x340e55(0x10f)]({'queueOptionId':_0x559539['id'],'amountUsedBotQueues':0x0}),await _0x4d083f['reload'](),await(0x0,exports[_0x340e55(0xec)])(_0x4d083f,_0x1dba18);return;}else console[_0x340e55(0xd4)](_0x340e55(0x124)+_0x253f5a+_0x340e55(0xd9));}}else{if(!(0x0,lodash_1[_0x340e55(0xd6)])(_0x2aa54b)&&!(0x0,lodash_1[_0x340e55(0xd6)])(_0x4d083f[_0x340e55(0x10c)])){const _0x58958b=await QueueOption_1[_0x340e55(0xa8)][_0x340e55(0xae)]({'where':{'parentId':_0x4d083f[_0x340e55(0x10c)]},'order':[[_0x340e55(0x172),_0x340e55(0x102)]]});if(_0x253f5a&&_0x58958b[_0x340e55(0x191)]>0x0){const _0x3b37cc=_0x58958b['find'](_0x444443=>_0x444443['option']===_0x253f5a);if(_0x3b37cc){console['log']('Opção\x20'+_0x253f5a+_0x340e55(0xf3)+_0x3b37cc['id']),await _0x4d083f[_0x340e55(0x10f)]({'queueOptionId':_0x3b37cc['id'],'amountUsedBotQueues':0x0}),await _0x4d083f[_0x340e55(0xcd)](),await(0x0,exports[_0x340e55(0xec)])(_0x4d083f,_0x1dba18);return;}else console[_0x340e55(0xd4)](_0x340e55(0x124)+_0x253f5a+_0x340e55(0xe8));}}}if(_0x253f5a&&_0x253f5a!=='0'&&_0x253f5a!=='#'){console[_0x340e55(0xd4)](_0x340e55(0xf8)+_0x253f5a);if(_0x53941d[_0x340e55(0x195)]&&_0x53941d[_0x340e55(0x195)]!==0x0&&_0x4d083f[_0x340e55(0x18a)]>=_0x53941d['maxUseBotQueues']){await _0x4d083f[_0x340e55(0x10f)]({'chatbot':![],'amountUsedBotQueues':_0x53941d['maxUseBotQueues']});_0x53941d[_0x340e55(0xfd)]&&await(0x0,SendWhatsAppMessage_1['default'])({'ticket':_0x4d083f,'body':_0x53941d[_0x340e55(0xfd)]});return;}await _0x4d083f['update']({'amountUsedBotQueues':_0x4d083f[_0x340e55(0x18a)]+0x1}),await _0x4d083f[_0x340e55(0xcd)]();}!_0x4d8a45&&await(0x0,exports[_0x340e55(0xec)])(_0x4d083f,_0x1dba18);},displayCurrentMenu=async(_0x1efd7a,_0x9dcec5)=>{const _0x159788=a584_0x4389f2;console[_0x159788(0xd4)](_0x159788(0x188)+_0x1efd7a['id']+',\x20queueOptionId:\x20'+_0x1efd7a[_0x159788(0x10c)]);const _0x443c17=await Queue_1['default'][_0x159788(0xea)](_0x1efd7a[_0x159788(0x148)]);if(!_0x443c17)return;if((0x0,lodash_1[_0x159788(0xd6)])(_0x1efd7a[_0x159788(0x10c)])){const _0x2a5a39=await QueueOption_1[_0x159788(0xa8)][_0x159788(0xae)]({'where':{'queueId':_0x1efd7a[_0x159788(0x148)],'parentId':null},'order':[[_0x159788(0x172),_0x159788(0x102)]]});if(_0x2a5a39[_0x159788(0x191)]>0x0){let _0x34e4a1=_0x443c17['greetingMessage']?_0x443c17[_0x159788(0x11b)]+'\x0a\x0a':'';_0x2a5a39[_0x159788(0x156)](_0x4bbe31=>{const _0x46a965=_0x159788;_0x34e4a1+='*'+_0x4bbe31[_0x46a965(0x172)]+_0x46a965(0xda)+_0x4bbe31[_0x46a965(0xef)]+'\x0a';}),_0x34e4a1+=_0x159788(0x17c),await(0x0,SendWhatsAppMessage_1['default'])({'ticket':_0x1efd7a,'body':_0x34e4a1}),console[_0x159788(0xd4)](_0x159788(0xb2));}return;}const _0x853b71=await QueueOption_1[_0x159788(0xa8)][_0x159788(0xea)](_0x1efd7a[_0x159788(0x10c)],{'include':[{'model':Queue_1[_0x159788(0xa8)],'as':_0x159788(0x13a)}]});if(!_0x853b71){console[_0x159788(0xd4)]('Opção\x20'+_0x1efd7a[_0x159788(0x10c)]+_0x159788(0x111));return;}const _0x2826fd=await QueueOption_1[_0x159788(0xa8)][_0x159788(0xae)]({'where':{'parentId':_0x1efd7a['queueOptionId']},'order':[[_0x159788(0x172),_0x159788(0x102)]]});if(_0x2826fd[_0x159788(0x191)]===0x0){console[_0x159788(0xd4)](_0x159788(0x14b));let _0x3b1fca=(0x0,Mustache_1['default'])('‎'+_0x853b71['message'],_0x1efd7a);if(_0x853b71?.[_0x159788(0x142)]){const _0x4b2034=path_1[_0x159788(0xa8)][_0x159788(0x101)](_0x159788(0x19a),_0x853b71[_0x159788(0x142)]);_0x4b2034?await(0x0,SendWhatsAppMedia_1[_0x159788(0xa8)])({'media':_0x4b2034,'ticket':_0x1efd7a,'body':_0x3b1fca}):await(0x0,SendWhatsAppMessage_1[_0x159788(0xa8)])({'ticket':_0x1efd7a,'body':_0x3b1fca});}else await(0x0,SendWhatsAppMessage_1[_0x159788(0xa8)])({'ticket':_0x1efd7a,'body':_0x3b1fca});if(_0x853b71[_0x159788(0x184)])await _0x1efd7a[_0x159788(0x10f)]({'queueOptionId':null,'chatbot':![],'amountUsedBotQueues':0x0});else{if(_0x853b71[_0x159788(0x17a)]){await _0x1efd7a[_0x159788(0x10f)]({'queueOptionId':null,'chatbot':![],'queueId':_0x853b71[_0x159788(0x17a)],'amountUsedBotQueues':0x0}),await _0x1efd7a[_0x159788(0xcd)]();if(_0x853b71[_0x159788(0x13a)]){const _0x331262=await QueueOption_1[_0x159788(0xa8)]['findOne']({'where':{'queueId':_0x853b71[_0x159788(0x17a)],'parentId':null}});await _0x1efd7a[_0x159788(0x10f)]({'chatbot':!!_0x331262}),_0x853b71[_0x159788(0x13a)][_0x159788(0x11b)]&&await(0x0,SendWhatsAppMessage_1[_0x159788(0xa8)])({'ticket':_0x1efd7a,'body':_0x853b71[_0x159788(0x13a)][_0x159788(0x11b)]}),_0x331262&&await(0x0,exports[_0x159788(0xec)])(_0x1efd7a,_0x9dcec5);}}else await _0x1efd7a[_0x159788(0x10f)]({'queueOptionId':null,'chatbot':![]});}return;}console[_0x159788(0xd4)](_0x159788(0x177)+_0x2826fd[_0x159788(0x191)]+_0x159788(0xdb));let _0x359aa7=_0x853b71[_0x159788(0xbb)]?_0x853b71[_0x159788(0xbb)]+'\x0a\x0a':'';_0x2826fd[_0x159788(0x156)](_0xacc0fc=>{const _0x369c90=_0x159788;_0x359aa7+='*'+_0xacc0fc[_0x369c90(0x172)]+_0x369c90(0xda)+_0xacc0fc[_0x369c90(0xef)]+'\x0a';}),_0x359aa7+=_0x159788(0xe0),_0x359aa7+=_0x159788(0x132);if(_0x853b71?.['mediaPath']){const _0x402198=path_1[_0x159788(0xa8)][_0x159788(0x101)]('public',_0x853b71[_0x159788(0x142)]);_0x402198?await(0x0,SendWhatsAppMedia_1[_0x159788(0xa8)])({'media':_0x402198,'ticket':_0x1efd7a,'body':_0x359aa7}):await(0x0,SendWhatsAppMessage_1['default'])({'ticket':_0x1efd7a,'body':_0x359aa7});}else await(0x0,SendWhatsAppMessage_1[_0x159788(0xa8)])({'ticket':_0x1efd7a,'body':_0x359aa7});};exports[a584_0x4389f2(0xec)]=displayCurrentMenu;const handleMessageIntegration=async(_0x48a2f7,_0xd1b113,_0x399b3e,_0x3ea4c5)=>{const _0x1c3408=a584_0x4389f2;if(process[_0x1c3408(0x119)][_0x1c3408(0x165)]){if(_0x3ea4c5['contact'][_0x1c3408(0x11a)]!=process['env']['CHATBOT_RESTRICT_NUMBER']){console[_0x1c3408(0xd4)](_0x1c3408(0xc0));return;}}console[_0x1c3408(0xd4)](_0x1c3408(0xb5),_0x3ea4c5[_0x1c3408(0x141)]),_0x399b3e[_0x1c3408(0x161)]===_0x1c3408(0xce)&&!_0x3ea4c5[_0x1c3408(0x141)]?(await(0x0,typebotListener_1['default'])({'ticket':_0x3ea4c5,'msg':_0x48a2f7,'wbot':_0xd1b113,'typebot':_0x399b3e}),!_0x3ea4c5[_0x1c3408(0xab)]&&(await _0x3ea4c5[_0x1c3408(0x10f)]({'useIntegration':!![],'integrationId':_0x399b3e['id']}),console[_0x1c3408(0xd4)](_0x1c3408(0xf2)+_0x3ea4c5['id']))):console[_0x1c3408(0xd4)](_0x1c3408(0x166));};function a584_0x31e6(){const _0x287a36=['floor','verifyMessage','handleMessage','messages.update','startsWith','./SendWhatsAppMessage','ticket-','count','reload','typebot','parentId','viewOnceMessageV2','491265ijBoBn','7mhAsam','not','log','user','isNil','logger','toLowerCase','\x20inválida\x20para\x20o\x20menu\x20principal.','*\x20-\x20','\x20opções.\x20Exibindo\x20submenu.','../../models/User','@whiskeysockets/baileys','createdAt','integrationId','\x0a*0*\x20-\x20Voltar\x20ao\x20menu\x20anterior\x0a','configurable','(((.+)+)+)+$','debounce','complationMessage','documentMessage','378258ZbnlMM','voiceMessage','\x20inválida\x20para\x20o\x20submenu\x20atual.','./SendWhatsAppMedia','findByPk','../../helpers/Mustache','displayCurrentMenu','outOfHoursAction','locationMessage','title','imageMessage','handleRating','Atualizando\x20estado\x20de\x20integração\x20do\x20ticket\x20#','\x20selecionada\x20no\x20submenu.\x20ID:\x20','key','queue-','verifyDeleteMessage','\x20selecionada\x20no\x20menu\x20principal.\x20ID:\x20','Resposta\x20inválida:\x20','__esModule','Estamos\x20fora\x20do\x20horário\x20de\x20expediente','200XZIjDf','../../libs/cache','transferMessage','\x22\x20para\x20ticket\x20','inActivity','endsWith','resolve','ASC','E2E_DEVICE_CHANGED','groupMetadata','../../helpers/Debounce','getBodyMessage','Configurações\x20do\x20WhatsApp\x20não\x20encontradas.','call','makeid','defineProperty','error','queueOptionId','contactsArrayMessage','contactMessage','update','Atendimento\x20finalizado','\x20não\x20encontrada.','captureException','-appMessage','ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789','text','remoteJid','keepUserAndQueue','8741514svfkeQ','env','number','greetingMessage','writable','socketSessions','search','extendedTextMessage','ticket','disabled','Processando\x20mensagem:\x20\x22','REVOKE','Opção\x20','emit','ticketId','lodash','toString','Error\x20isValidMsg','quotedMsg','trim','6763495NKippN','status','getMessageMedia','stickerMessage','subject','lastProcessedMessageId','*#*\x20-\x20Voltar\x20Menu\x20Inicial','find','__setModuleDefault','../../utils/logger','../../helpers/simpleObjectCache','editedMessage','hasOwnProperty','../../models/Ticket','forwardQueue','liveLocationMessage','queues','ratingMessage','verifyContact','conversation','__importDefault','typebotStatus','mediaPath','Erro\x20ao\x20processar\x20mensagem\x20do\x20WhatsApp:','-open','Resultado\x20da\x20verificação\x20de\x20horário:','GetCompanySetting','__createBinding','queueId','../../models/Queue','verifyRating','Nó\x20final\x20encontrado.\x20Exibindo\x20mensagem\x20final.','apply','Mensagem\x20','create','../QueueIntegrationServices/ShowQueueIntegrationService','company-','Erro\x20ao\x20verificar\x20horário\x20de\x20atendimento:','getContactMessage','constructor','documentWithCaptionMessage','charAt','forEach','value','open','userId','../../models/TicketTraking','../CompanyService/VerifyCurrentSchedule','messageContextInfo','buttonsMessage','warn','3227025PTBfEp','stringify','type',',\x20queueOptionId:\x20','3518960HaFfOU','../../models/QueueOption','CHATBOT_RESTRICT_NUMBER','Tipo\x20de\x20integração\x20não\x20suportada.','useRating','verifyMediaMessage','../../models/Setting','__importStar','WAMessageStubType','isGroup','listResponseMessage','reactionMessage','../../helpers/CheckSettings','queue','verifyEditedMessage','option','Error\x20handling\x20wbot\x20message\x20listener.\x20Err:\x20','filter','Por\x20favor\x20avalie\x20nosso\x20atendimento','1508306NIdsOm','Submenu\x20encontrado\x20com\x20','cacheLayer','Novo\x20Tipo\x20de\x20Mensagem\x20em\x20isValidMsg','forwardQueueId','outOfHoursMessage','\x0a*#*\x20-\x20Voltar\x20Menu\x20Inicial','.\x20Ignorando\x20em\x20handleChartbot.','messages','setExtra','messages.upsert','E2E_IDENTITY_CHANGED','SimpleObjectCache','chatbot','exitChatbot','listMessage','getUnpackedMessage','../../models/Contact','Exibindo\x20menu\x20para\x20ticket\x20','async-mutex','amountUsedBotQueues','scheduleType','options','messageStubType','isFinite','get','verifyRecentCampaign','length','@sentry/node','whatsappId','getTypeMessage','maxUseBotQueues','toDate','Mutex','buttonsResponseMessage','handleMessageIntegration','public','isNaN','Mensagem','set','../TicketServices/UpdateTicketService','moment','prototype','default','isInteger','includes','useIntegration',':unreads','contacts:','findAll','audioMessage','verifyQueue','getOwnPropertyDescriptor','Menu\x20principal\x20exibido.','fromMe','contact','typebotStatus:\x20','findOne','\x20já\x20processada\x20para\x20o\x20ticket\x20','enabled','companyId','../../models/Whatsapp','message','company','../TypebotServices/typebotListener','Erro\x20ao\x20processar\x20avaliação:','../TicketServices/FindOrCreateTicketService','chatbot\x20desativado!','getIO','protocolMessage','wbotMessageListener','./VerifyHandlers'];a584_0x31e6=function(){return _0x287a36;};return a584_0x31e6();}exports['handleMessageIntegration']=handleMessageIntegration;const handleMessage=async(_0x25d470,_0x49b900,_0x333d86)=>{const _0x44a64e=a584_0x4389f2;if(!isValidMsg(_0x25d470))return;_0x25d470[_0x44a64e(0xbb)]?.['ephemeralMessage']&&(_0x25d470[_0x44a64e(0xbb)]=_0x25d470['message']['ephemeralMessage'][_0x44a64e(0xbb)]);try{let _0x48b5fc,_0xd667ed;const _0x279e99=_0x25d470[_0x44a64e(0xf4)][_0x44a64e(0x116)]?.[_0x44a64e(0x100)]('@g.us');if(_0x279e99){const _0x322eed=await Setting_1[_0x44a64e(0xa8)][_0x44a64e(0xb6)]({'where':{'companyId':_0x333d86,'key':'CheckMsgIsGroup'}});if(!_0x322eed||_0x322eed[_0x44a64e(0x157)]===_0x44a64e(0xb8))return;}const _0x427ec9=(0x0,GetHandlers_1['getBodyMessage'])(_0x25d470),_0x570f80=(0x0,GetHandlers_1[_0x44a64e(0x194)])(_0x25d470),_0x384d15=_0x570f80!=='templateMessage'&&(0x0,GetHandlers_1[_0x44a64e(0x186)])(_0x25d470),_0x144ce4=_0x384d15&&(0x0,GetHandlers_1[_0x44a64e(0x12e)])(_0x384d15);if(_0x25d470[_0x44a64e(0xf4)][_0x44a64e(0xb3)]){if(_0x427ec9?.[_0x44a64e(0xc9)]('‎'))return;if(!_0x144ce4&&_0x570f80!==_0x44a64e(0x13f)&&_0x570f80!==_0x44a64e(0x11f)&&_0x570f80!=='vcard')return;_0x48b5fc=await(0x0,GetHandlers_1[_0x44a64e(0x152)])(_0x25d470,_0x49b900);}else _0x48b5fc=await(0x0,GetHandlers_1['getContactMessage'])(_0x25d470,_0x49b900);_0x279e99&&(_0xd667ed=await wbotMutex['runExclusive'](async()=>{const _0x3e5d18=_0x44a64e;let _0x31c8fc=groupContactCache[_0x3e5d18(0x18f)](_0x25d470[_0x3e5d18(0xf4)][_0x3e5d18(0x116)]);if(!_0x31c8fc){const _0x25597=await _0x49b900[_0x3e5d18(0x104)](_0x25d470[_0x3e5d18(0xf4)][_0x3e5d18(0x116)]),_0x3f658e={'id':_0x25597['id'],'name':_0x25597[_0x3e5d18(0x130)]};_0x31c8fc=await(0x0,VerifyHandlers_1[_0x3e5d18(0x13e)])(_0x3f658e,_0x49b900,_0x333d86),groupContactCache[_0x3e5d18(0xa4)](_0x25d470[_0x3e5d18(0xf4)][_0x3e5d18(0x116)],_0x31c8fc);}return _0x31c8fc;}));const _0xa3935b=await(0x0,ShowWhatsAppService_1['default'])(_0x49b900['id'],_0x333d86),_0x4b55af=await(0x0,VerifyHandlers_1[_0x44a64e(0x13e)])(_0x48b5fc,_0x49b900,_0x333d86);let _0x12fe92=0x0;if(_0x25d470[_0x44a64e(0xf4)][_0x44a64e(0xb3)])await cache_1[_0x44a64e(0x178)][_0x44a64e(0xa4)]('contacts:'+_0x4b55af['id']+_0x44a64e(0xac),'0');else{const _0x571add=await cache_1[_0x44a64e(0x178)][_0x44a64e(0x18f)](_0x44a64e(0xad)+_0x4b55af['id']+_0x44a64e(0xac));_0x12fe92=+_0x571add+0x1,await cache_1[_0x44a64e(0x178)][_0x44a64e(0xa4)](_0x44a64e(0xad)+_0x4b55af['id']+_0x44a64e(0xac),''+_0x12fe92);}const _0x1f0ae8=await Message_1[_0x44a64e(0xa8)][_0x44a64e(0xb6)]({'where':{'contactId':_0x4b55af['id'],'companyId':_0x333d86,'$ticket.whatsappId$':_0xa3935b['id']},'include':[_0x44a64e(0x120)],'order':[[_0x44a64e(0xde),'DESC']]}),_0x2e2a2b=_0xa3935b['complationMessage'][_0x44a64e(0x12b)]()||'Atendimento\x20finalizado';if(_0x1f0ae8&&_0x12fe92===0x0&&_0x2e2a2b&&(0x0,Mustache_1[_0x44a64e(0xa8)])(_0x2e2a2b,_0x1f0ae8[_0x44a64e(0x120)])[_0x44a64e(0x12b)]()[_0x44a64e(0xd8)]()===_0x1f0ae8?.['body'][_0x44a64e(0x12b)]()[_0x44a64e(0xd8)]())return;if(!_0x25d470['key'][_0x44a64e(0xb3)]&&!_0x4b55af[_0x44a64e(0x16c)]){if(_0xa3935b[_0x44a64e(0x167)]){const _0x4ad7dc=await TicketTraking_1['default']['findOne']({'where':{'whatsappId':_0xa3935b['id'],'rated':![],'ratingAt':{[sequelize_1['Op'][_0x44a64e(0xd3)]]:null},'finishedAt':null},'include':[{'model':Ticket_1['default'],'where':{'status':_0x44a64e(0x158),'contactId':_0x4b55af['id']},'include':[{'model':Contact_1[_0x44a64e(0xa8)]},{'model':User_1[_0x44a64e(0xa8)]},{'model':Queue_1[_0x44a64e(0xa8)]}]}]});if(_0x4ad7dc)try{const _0x14a1ca=Number(_0x427ec9);if(!Number[_0x44a64e(0x18e)](_0x14a1ca)){const _0x339b4f=(0x0,Debounce_1['debounce'])(async()=>{const _0x1e771b=_0x44a64e,_0x2c03e1=_0xa3935b[_0x1e771b(0x13d)]?.[_0x1e771b(0x12b)]()||_0x1e771b(0x175);await(0x0,SendWhatsAppMessage_1['default'])({'ticket':_0x2a87c6,'body':'\x0a*'+_0x2c03e1+'*'});},0x3e8,_0x4ad7dc[_0x44a64e(0x120)]['id']);_0x339b4f();return;}if((0x0,VerifyHandlers_1[_0x44a64e(0x14a)])(_0x4ad7dc)){(0x0,exports[_0x44a64e(0xf1)])(_0x25d470,_0x4ad7dc[_0x44a64e(0x120)],_0x4ad7dc);return;}}catch(_0x12c657){Sentry[_0x44a64e(0x112)](_0x12c657),console[_0x44a64e(0xd4)](_0x44a64e(0xbe),_0x12c657);}}}const {ticket:_0x2a87c6,justCreated:_0x20b5e4}=await(0x0,FindOrCreateTicketService_1['default'])(_0x4b55af,_0x49b900['id'],_0x12fe92,_0x333d86,_0xd667ed);if(_0x144ce4||_0x25d470?.['message']?.[_0x44a64e(0x11f)]?.['thumbnailDirectPath'])await(0x0,VerifyHandlers_1[_0x44a64e(0x168)])(_0x25d470,_0x2a87c6,_0x4b55af,_0x49b900,_0x144ce4);else{if(_0x25d470[_0x44a64e(0xbb)]?.['editedMessage']?.[_0x44a64e(0xbb)]?.[_0x44a64e(0xc2)]?.[_0x44a64e(0x137)])await(0x0,VerifyHandlers_1[_0x44a64e(0x171)])(_0x25d470['message'][_0x44a64e(0x137)][_0x44a64e(0xbb)][_0x44a64e(0xc2)][_0x44a64e(0x137)],_0x2a87c6,_0x25d470[_0x44a64e(0xbb)][_0x44a64e(0x137)][_0x44a64e(0xbb)]['protocolMessage'][_0x44a64e(0xf4)]['id']);else{if(_0x25d470[_0x44a64e(0xbb)]?.[_0x44a64e(0xc2)]?.[_0x44a64e(0x137)])await(0x0,VerifyHandlers_1[_0x44a64e(0x171)])(_0x25d470['message'][_0x44a64e(0xc2)][_0x44a64e(0x137)],_0x2a87c6,_0x25d470['message'][_0x44a64e(0xc2)][_0x44a64e(0xf4)]['id']);else _0x25d470[_0x44a64e(0xbb)]?.['protocolMessage']?.[_0x44a64e(0x161)]===0x0?await(0x0,VerifyHandlers_1[_0x44a64e(0xf6)])(_0x25d470[_0x44a64e(0xbb)]['protocolMessage'],_0x2a87c6):await(0x0,VerifyHandlers_1[_0x44a64e(0xc6)])(_0x25d470,_0x2a87c6,_0x4b55af);}}if(_0x2a87c6[_0x44a64e(0xab)]===!![]&&_0x2a87c6[_0x44a64e(0xdf)]){const _0x1ccad1=await(0x0,ShowQueueIntegrationService_1[_0x44a64e(0xa8)])(_0x2a87c6[_0x44a64e(0xdf)],_0x333d86);if(_0x1ccad1){await(0x0,exports[_0x44a64e(0x199)])(_0x25d470,_0x49b900,_0x1ccad1,_0x2a87c6);return;}else await _0x2a87c6[_0x44a64e(0x10f)]({'useIntegration':![],'integrationId':null,'typebotSessionId':null});}if(_0x427ec9==='#'&&!_0x279e99){await _0x2a87c6[_0x44a64e(0x10f)]({'queueOptionId':null,'chatbot':![],'queueId':null}),await(0x0,VerifyHandlers_1[_0x44a64e(0xb0)])(_0x49b900,_0x25d470,_0x2a87c6,_0x2a87c6[_0x44a64e(0xb4)]);return;}if(_0x279e99||_0x4b55af['disableBot'])return;const _0x4fc3ce=await(0x0,CheckSettings_1[_0x44a64e(0x146)])(_0x333d86,_0x44a64e(0x18b),_0x44a64e(0x121));try{if(!_0x25d470['key'][_0x44a64e(0xb3)]&&_0x4fc3ce){const _0x5c92b6=await(0x0,CheckSettings_1['GetCompanySetting'])(_0x333d86,_0x44a64e(0xed),'pending');let _0x47e67b=null;const _0x2ba828=_0x2a87c6['status']===_0x44a64e(0x158)&&_0x2a87c6[_0x44a64e(0xd5)][_0x44a64e(0x11d)]['length']>0x0,_0x552ef6=!_0x2ba828&&outOfHoursCache[_0x44a64e(0x18f)](_0x44a64e(0xcb)+_0x2a87c6['id']);if(_0x4fc3ce===_0x44a64e(0xbc)&&!_0x2ba828){_0x47e67b=await(0x0,VerifyCurrentSchedule_1[_0x44a64e(0xa8)])(_0x333d86),console[_0x44a64e(0xd4)](_0x44a64e(0x145),{'currentSchedule':_0x47e67b,'isInActivity':_0x47e67b?.[_0x44a64e(0xff)]});if(_0x47e67b&&_0x47e67b[_0x44a64e(0xff)]===![]){if(!_0x552ef6){outOfHoursCache[_0x44a64e(0xa4)](_0x44a64e(0xcb)+_0x2a87c6['id'],!![]);const _0x23f92b=_0xa3935b['outOfHoursMessage'][_0x44a64e(0x12b)]()||_0x44a64e(0xfa);await(0x0,SendWhatsAppMessage_1[_0x44a64e(0xa8)])({'ticket':_0x2a87c6,'body':_0x23f92b});}_0x2a87c6[_0x44a64e(0x12d)]!=='open'&&await(0x0,UpdateTicketService_1[_0x44a64e(0xa8)])({'ticketData':{'chatbot':![],'status':_0x5c92b6},'ticketId':_0x2a87c6['id'],'companyId':_0x2a87c6['companyId']});return;}}if(_0x4fc3ce===_0x44a64e(0x170)&&_0x2a87c6[_0x44a64e(0x148)]!==null&&!_0x2ba828){_0x47e67b=await(0x0,VerifyCurrentSchedule_1[_0x44a64e(0xa8)])(_0x333d86,_0x2a87c6[_0x44a64e(0x148)]);const _0x409f74=await Queue_1[_0x44a64e(0xa8)][_0x44a64e(0xea)](_0x2a87c6[_0x44a64e(0x148)]);if(!(0x0,lodash_1[_0x44a64e(0xd6)])(_0x47e67b)&&(!_0x47e67b||_0x47e67b[_0x44a64e(0xff)]===![])){if(!_0x552ef6){outOfHoursCache[_0x44a64e(0xa4)](_0x44a64e(0xcb)+_0x2a87c6['id'],!![]);const _0x56c364=_0x409f74[_0x44a64e(0x17b)]?.[_0x44a64e(0x12b)]()||'Estamos\x20fora\x20do\x20horário\x20de\x20expediente';await(0x0,SendWhatsAppMessage_1['default'])({'ticket':_0x2a87c6,'body':_0x56c364});}_0x2a87c6['status']!==_0x44a64e(0x158)&&await(0x0,UpdateTicketService_1[_0x44a64e(0xa8)])({'ticketData':{'chatbot':![],'status':_0x5c92b6},'ticketId':_0x2a87c6['id'],'companyId':_0x2a87c6[_0x44a64e(0xb9)]});return;}}}}catch(_0x52c571){Sentry[_0x44a64e(0x112)](_0x52c571),console['log'](_0x44a64e(0x151),_0x52c571);}!_0x2a87c6[_0x44a64e(0x170)]&&!_0x279e99&&!_0x25d470['key']['fromMe']&&!_0x2a87c6[_0x44a64e(0x159)]&&_0xa3935b[_0x44a64e(0x13c)][_0x44a64e(0x191)]>=0x1&&await(0x0,VerifyHandlers_1['verifyQueue'])(_0x49b900,_0x25d470,_0x2a87c6,_0x2a87c6[_0x44a64e(0xb4)]);const _0x1ca720=_0x2a87c6[_0x44a64e(0x170)]===null;await _0x2a87c6[_0x44a64e(0xcd)]();if(_0x20b5e4&&!_0xa3935b?.[_0x44a64e(0x13c)]?.[_0x44a64e(0x191)]&&!_0x2a87c6[_0x44a64e(0x159)]&&!_0x279e99&&!_0x25d470[_0x44a64e(0xf4)]['fromMe']){const _0x2c5479=await Message_1[_0x44a64e(0xa8)][_0x44a64e(0xb6)]({'where':{'ticketId':_0x2a87c6['id'],'fromMe':!![]},'order':[[_0x44a64e(0xde),'DESC']]});if(_0x2c5479&&_0x2c5479['body'][_0x44a64e(0xaa)](_0xa3935b[_0x44a64e(0x11b)]))return;if(_0xa3935b[_0x44a64e(0x11b)]){const _0x1fa5c7=(0x0,Debounce_1[_0x44a64e(0xe3)])(async()=>{const _0x5f5c5c=_0x44a64e;await(0x0,SendWhatsAppMessage_1[_0x5f5c5c(0xa8)])({'ticket':_0x2a87c6,'body':''+_0xa3935b[_0x5f5c5c(0x11b)]});},0x3e8,_0x2a87c6['id']);_0x1fa5c7();return;}}if(!_0x2a87c6[_0x44a64e(0x183)]&&_0x2a87c6[_0x44a64e(0x18a)]>=_0xa3935b?.[_0x44a64e(0x195)])return;if(_0x2a87c6[_0x44a64e(0x183)]&&!_0x25d470[_0x44a64e(0xf4)][_0x44a64e(0xb3)]){await handleChartbot(_0x2a87c6,_0x25d470,_0x49b900);return;}_0xa3935b[_0x44a64e(0x13c)][_0x44a64e(0x191)]===0x1&&_0x2a87c6[_0x44a64e(0x170)]&&(_0x2a87c6['chatbot']&&!_0x25d470[_0x44a64e(0xf4)][_0x44a64e(0xb3)]&&!_0x2a87c6[_0x44a64e(0xab)]&&await handleChartbot(_0x2a87c6,_0x25d470,_0x49b900,_0x1ca720)),_0xa3935b[_0x44a64e(0x13c)][_0x44a64e(0x191)]>0x1&&_0x2a87c6[_0x44a64e(0x170)]&&(_0x2a87c6[_0x44a64e(0x183)]&&!_0x25d470[_0x44a64e(0xf4)]['fromMe']&&!_0x2a87c6[_0x44a64e(0xab)]&&await handleChartbot(_0x2a87c6,_0x25d470,_0x49b900,_0x1ca720));}catch(_0x35d8be){console[_0x44a64e(0xd4)](_0x44a64e(0x143),_0x35d8be),Sentry[_0x44a64e(0x112)](_0x35d8be),logger_1['logger'][_0x44a64e(0x10b)]('Error\x20handling\x20whatsapp\x20message:\x20Err:\x20'+_0x35d8be);}};exports[a584_0x4389f2(0xc7)]=handleMessage;const handleMsgAck=async(_0x4049a1,_0x5e3b5d)=>{const _0x472ee9=a584_0x4389f2;if(!_0x5e3b5d)return;const _0x1e0ea7=(0x0,socket_1[_0x472ee9(0xc1)])();try{const _0x14ff82=await Message_1['default']['findByPk'](_0x4049a1[_0x472ee9(0xf4)]['id'],{'include':[_0x472ee9(0xb4),{'model':Message_1[_0x472ee9(0xa8)],'as':_0x472ee9(0x12a),'include':[_0x472ee9(0xb4)]}]});if(!_0x14ff82||_0x5e3b5d<=_0x14ff82['ack'])return;await _0x14ff82[_0x472ee9(0x10f)]({'ack':_0x5e3b5d}),_0x1e0ea7['to'](_0x14ff82[_0x472ee9(0x126)][_0x472ee9(0x128)]())['emit'](_0x472ee9(0x150)+_0x14ff82[_0x472ee9(0xb9)]+_0x472ee9(0x113),{'action':'update','message':_0x14ff82});}catch(_0x18e96b){Sentry[_0x472ee9(0x112)](_0x18e96b),logger_1[_0x472ee9(0xd7)]['error']('Error\x20handling\x20message\x20ack.\x20Err:\x20'+_0x18e96b);}},filterMessages=_0x28999a=>{const _0x18a7ea=a584_0x4389f2;if(_0x28999a['message']?.[_0x18a7ea(0xc2)]?.[_0x18a7ea(0x137)])return!![];if(_0x28999a[_0x18a7ea(0xbb)]?.[_0x18a7ea(0xc2)]?.['type']===0x0)return!![];if(_0x28999a[_0x18a7ea(0xbb)]?.[_0x18a7ea(0xc2)])return![];if([baileys_1[_0x18a7ea(0x16b)][_0x18a7ea(0x123)],baileys_1['WAMessageStubType'][_0x18a7ea(0x103)],baileys_1[_0x18a7ea(0x16b)][_0x18a7ea(0x181)],baileys_1[_0x18a7ea(0x16b)]['CIPHERTEXT']][_0x18a7ea(0xaa)](_0x28999a[_0x18a7ea(0x18d)]))return![];return!![];},wbotMessageListener=async(_0x3eb134,_0x2c7e03)=>{const _0x4e036d=a584_0x4389f2;try{_0x3eb134['ev']['on'](_0x4e036d(0x180),async _0x21af69=>{const _0x21206d=_0x4e036d,_0x4f739a=_0x21af69[_0x21206d(0x17e)][_0x21206d(0x174)](filterMessages)['map'](_0x319e7b=>_0x319e7b);if(!_0x4f739a)return;_0x4f739a['forEach'](async _0x26a96=>{const _0x30f98e=_0x21206d,_0x151280=await Message_1['default'][_0x30f98e(0xcc)]({'where':{'id':_0x26a96[_0x30f98e(0xf4)]['id'],'companyId':_0x2c7e03}});if(!_0x151280){if(await(0x0,VerifyHandlers_1[_0x30f98e(0x190)])(_0x26a96,_0x2c7e03))return;await handleMessage(_0x26a96,_0x3eb134,_0x2c7e03);}});}),_0x3eb134['ev']['on'](_0x4e036d(0xc8),_0xc529fa=>{const _0x114741=_0x4e036d;if(_0xc529fa[_0x114741(0x191)]===0x0)return;_0xc529fa[_0x114741(0x156)](async _0x35fcff=>{const _0x4b0d00=_0x114741;_0x3eb134['readMessages']([_0x35fcff[_0x4b0d00(0xf4)]]),await ackMutex['runExclusive'](async()=>{const _0x5e2d9d=_0x4b0d00;handleMsgAck(_0x35fcff,_0x35fcff[_0x5e2d9d(0x10f)][_0x5e2d9d(0x12d)]);});});});}catch(_0x280080){Sentry['captureException'](_0x280080),logger_1[_0x4e036d(0xd7)][_0x4e036d(0x10b)](_0x4e036d(0x173)+_0x280080);}};function a584_0x3da0(_0x4d1ded,_0xc77c2c){const _0x5cf6d7=a584_0x31e6();return a584_0x3da0=function(_0x20b02c,_0x428b54){_0x20b02c=_0x20b02c-0xa2;let _0x31e639=_0x5cf6d7[_0x20b02c];return _0x31e639;},a584_0x3da0(_0x4d1ded,_0xc77c2c);}exports[a584_0x4389f2(0xc3)]=wbotMessageListener;