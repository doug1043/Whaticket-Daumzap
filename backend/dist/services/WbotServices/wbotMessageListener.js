const a558_0x1e95a7=a558_0x2d96;(function(_0x12c584,_0x297896){const _0x354d8b=a558_0x2d96,_0x1a2472=_0x12c584();while(!![]){try{const _0x3fc22e=-parseInt(_0x354d8b(0x32b))/0x1*(parseInt(_0x354d8b(0x371))/0x2)+parseInt(_0x354d8b(0x1ed))/0x3*(-parseInt(_0x354d8b(0x340))/0x4)+-parseInt(_0x354d8b(0x35c))/0x5+parseInt(_0x354d8b(0x281))/0x6+parseInt(_0x354d8b(0x2e8))/0x7+-parseInt(_0x354d8b(0x1fb))/0x8+parseInt(_0x354d8b(0x2a0))/0x9;if(_0x3fc22e===_0x297896)break;else _0x1a2472['push'](_0x1a2472['shift']());}catch(_0x348adf){_0x1a2472['push'](_0x1a2472['shift']());}}}(a558_0x627a,0x95875));const a558_0x5d4308=(function(){let _0x30d284=!![];return function(_0x410509,_0x4cf5ea){const _0x34b010=_0x30d284?function(){const _0x2a3c8f=a558_0x2d96;if(_0x4cf5ea){const _0x1ca083=_0x4cf5ea[_0x2a3c8f(0x238)](_0x410509,arguments);return _0x4cf5ea=null,_0x1ca083;}}:function(){};return _0x30d284=![],_0x34b010;};}()),a558_0x3396bd=a558_0x5d4308(this,function(){const _0x245e40=a558_0x2d96;return a558_0x3396bd[_0x245e40(0x2b2)]()[_0x245e40(0x2f7)](_0x245e40(0x260))['toString']()[_0x245e40(0x2c0)](a558_0x3396bd)[_0x245e40(0x2f7)]('(((.+)+)+)+$');});a558_0x3396bd();'use strict';var __createBinding=this&&this['__createBinding']||(Object[a558_0x1e95a7(0x202)]?function(_0x3fbd23,_0x312e96,_0x150f08,_0x27ef59){const _0x4b8ac9=a558_0x1e95a7;if(_0x27ef59===undefined)_0x27ef59=_0x150f08;var _0xe94541=Object['getOwnPropertyDescriptor'](_0x312e96,_0x150f08);(!_0xe94541||(_0x4b8ac9(0x350)in _0xe94541?!_0x312e96[_0x4b8ac9(0x2df)]:_0xe94541['writable']||_0xe94541['configurable']))&&(_0xe94541={'enumerable':!![],'get':function(){return _0x312e96[_0x150f08];}}),Object[_0x4b8ac9(0x233)](_0x3fbd23,_0x27ef59,_0xe94541);}:function(_0x351ca8,_0x4cde2f,_0x12cc85,_0x44d601){if(_0x44d601===undefined)_0x44d601=_0x12cc85;_0x351ca8[_0x44d601]=_0x4cde2f[_0x12cc85];}),__setModuleDefault=this&&this[a558_0x1e95a7(0x2a9)]||(Object['create']?function(_0x19fccc,_0x50d4c2){const _0x253dfe=a558_0x1e95a7;Object[_0x253dfe(0x233)](_0x19fccc,_0x253dfe(0x378),{'enumerable':!![],'value':_0x50d4c2});}:function(_0x700a1b,_0x4ce5aa){const _0x1e971d=a558_0x1e95a7;_0x700a1b[_0x1e971d(0x378)]=_0x4ce5aa;}),__importStar=this&&this[a558_0x1e95a7(0x343)]||function(_0x56c03c){const _0x337bd1=a558_0x1e95a7;if(_0x56c03c&&_0x56c03c[_0x337bd1(0x2df)])return _0x56c03c;var _0x1c9dc4={};if(_0x56c03c!=null){for(var _0x4e7330 in _0x56c03c)if(_0x4e7330!==_0x337bd1(0x378)&&Object[_0x337bd1(0x265)][_0x337bd1(0x22a)][_0x337bd1(0x218)](_0x56c03c,_0x4e7330))__createBinding(_0x1c9dc4,_0x56c03c,_0x4e7330);}return __setModuleDefault(_0x1c9dc4,_0x56c03c),_0x1c9dc4;},__importDefault=this&&this['__importDefault']||function(_0xad48e8){const _0x9233bd=a558_0x1e95a7;return _0xad48e8&&_0xad48e8[_0x9233bd(0x2df)]?_0xad48e8:{'default':_0xad48e8};};Object[a558_0x1e95a7(0x233)](exports,a558_0x1e95a7(0x2df),{'value':!![]}),exports[a558_0x1e95a7(0x2b3)]=exports[a558_0x1e95a7(0x254)]=exports[a558_0x1e95a7(0x1ef)]=exports['handleMsgAck']=exports['handleMessage']=exports[a558_0x1e95a7(0x342)]=exports['handleRating']=exports['verifyRating']=exports[a558_0x1e95a7(0x230)]=exports[a558_0x1e95a7(0x374)]=exports[a558_0x1e95a7(0x1ee)]=exports[a558_0x1e95a7(0x27e)]=exports['getQuotedMessage']=exports['getBodyMessage']=exports[a558_0x1e95a7(0x251)]=exports[a558_0x1e95a7(0x333)]=exports[a558_0x1e95a7(0x1fa)]=exports['sleep']=exports[a558_0x1e95a7(0x2f6)]=exports['removeNonPrintableChars']=exports[a558_0x1e95a7(0x28f)]=void 0x0;const path_1=__importStar(require(a558_0x1e95a7(0x1dc))),util_1=require(a558_0x1e95a7(0x256)),fs_1=require('fs'),Sentry=__importStar(require('@sentry/node')),lodash_1=require(a558_0x1e95a7(0x2f9)),baileys_1=require(a558_0x1e95a7(0x2c8)),MessageUtils=__importStar(require(a558_0x1e95a7(0x1f5))),stream_throttle_1=require('stream-throttle'),Contact_1=__importDefault(require('../../models/Contact')),Ticket_1=__importDefault(require(a558_0x1e95a7(0x27c))),Message_1=__importDefault(require(a558_0x1e95a7(0x293))),OldMessage_1=__importDefault(require('../../models/OldMessage')),socket_1=require(a558_0x1e95a7(0x338)),CreateMessageService_1=__importDefault(require(a558_0x1e95a7(0x385))),logger_1=require('../../utils/logger'),CreateOrUpdateContactService_1=__importDefault(require('../ContactServices/CreateOrUpdateContactService')),FindOrCreateTicketService_1=__importDefault(require(a558_0x1e95a7(0x375))),ShowWhatsAppService_1=__importDefault(require(a558_0x1e95a7(0x1f2))),UpdateTicketService_1=__importDefault(require(a558_0x1e95a7(0x2f8))),Mustache_1=__importDefault(require('../../helpers/Mustache')),UserRating_1=__importDefault(require(a558_0x1e95a7(0x2ab))),SendWhatsAppMessage_1=__importDefault(require(a558_0x1e95a7(0x31d))),moment_1=__importDefault(require(a558_0x1e95a7(0x1d4))),Queue_1=__importDefault(require(a558_0x1e95a7(0x361))),QueueOption_1=__importDefault(require(a558_0x1e95a7(0x206))),FindOrCreateATicketTrakingService_1=__importDefault(require(a558_0x1e95a7(0x2f2))),VerifyCurrentSchedule_1=__importDefault(require('../CompanyService/VerifyCurrentSchedule')),Campaign_1=__importDefault(require(a558_0x1e95a7(0x2ee))),CampaignShipping_1=__importDefault(require('../../models/CampaignShipping')),sequelize_1=require('sequelize'),queues_1=require(a558_0x1e95a7(0x24d)),User_1=__importDefault(require(a558_0x1e95a7(0x252))),Setting_1=__importDefault(require(a558_0x1e95a7(0x351))),cache_1=require(a558_0x1e95a7(0x21e)),Debounce_1=require(a558_0x1e95a7(0x1e9)),openai_1=require(a558_0x1e95a7(0x255)),fluent_ffmpeg_1=__importDefault(require(a558_0x1e95a7(0x214))),microsoft_cognitiveservices_speech_sdk_1=require(a558_0x1e95a7(0x325)),providers_1=require(a558_0x1e95a7(0x2a3)),typebotListener_1=__importDefault(require('../TypebotServices/typebotListener')),ShowQueueIntegrationService_1=__importDefault(require(a558_0x1e95a7(0x2cf))),SendWhatsAppMedia_1=require(a558_0x1e95a7(0x35a)),fs_2=__importDefault(require('fs')),request_1=__importDefault(require(a558_0x1e95a7(0x388))),ffmpeg_static_1=__importDefault(require(a558_0x1e95a7(0x1ea))),app_1=__importDefault(require(a558_0x1e95a7(0x24e))),mime_1=__importDefault(require('mime')),wbot_1=require(a558_0x1e95a7(0x290)),SendPresenceStatus_1=require(a558_0x1e95a7(0x366)),MakeRandomId_1=require('../../helpers/MakeRandomId');fluent_ffmpeg_1['default']['setFfmpegPath'](ffmpeg_static_1[a558_0x1e95a7(0x378)]);const sessionsOpenAi=[],isNumeric=_0x5ab631=>/^-?\d+$/[a558_0x1e95a7(0x30e)](_0x5ab631);exports[a558_0x1e95a7(0x28f)]=isNumeric;let outOfHourMessageControl=[],completionMessageControl=[],greetingMessageControl=[],farewellMessageControl=[];const writeFileAsync=(0x0,util_1[a558_0x1e95a7(0x209)])(fs_1[a558_0x1e95a7(0x38d)]),getTypeMessage=_0x3d138e=>{const _0x44212a=a558_0x1e95a7;return(0x0,baileys_1[_0x44212a(0x2fd)])(_0x3d138e['message']);},removeNonPrintableChars=_0x51352e=>{const _0xc0e97e=a558_0x1e95a7;return _0x51352e[_0xc0e97e(0x300)](/[\x00-\x1F\x7F-\x9F]/g,'');};exports[a558_0x1e95a7(0x341)]=removeNonPrintableChars;async function getQueues(_0x497377){const _0x548d44=a558_0x1e95a7;try{const _0x2cbc02=await Queue_1[_0x548d44(0x378)][_0x548d44(0x2fc)]({'where':{'companyId':_0x497377}});return _0x2cbc02;}catch(_0x46f7ba){return console[_0x548d44(0x2ce)](_0x548d44(0x225),_0x46f7ba),[];}}async function getContactFromTicket(_0x353c38){const _0x523c08=a558_0x1e95a7;try{const _0x149607=await Ticket_1[_0x523c08(0x378)][_0x523c08(0x1ec)](_0x353c38,{'include':[{'model':Contact_1[_0x523c08(0x378)],'as':'contact'}]});return _0x149607&&_0x149607[_0x523c08(0x244)]?_0x149607[_0x523c08(0x244)]:(console[_0x523c08(0x241)]('No\x20contact\x20found\x20for\x20this\x20ticket.'),null);}catch(_0x3aade9){return console[_0x523c08(0x2ce)](_0x523c08(0x295),_0x3aade9),null;}}function validaCpfCnpj(_0x209ec1){const _0x118ec6=a558_0x1e95a7;if(_0x209ec1[_0x118ec6(0x264)]==0xb){var _0x1a62ef=_0x209ec1['trim']();_0x1a62ef=_0x1a62ef[_0x118ec6(0x300)](/\./g,''),_0x1a62ef=_0x1a62ef['replace']('-',''),_0x1a62ef=_0x1a62ef[_0x118ec6(0x1cc)]('');var _0x130762=0x0,_0x5096b4=0x0,_0xdbdb8d=![];for(var _0xd6dc26=0x1;_0x1a62ef[_0x118ec6(0x264)]>_0xd6dc26;_0xd6dc26++){_0x1a62ef[_0xd6dc26-0x1]!=_0x1a62ef[_0xd6dc26]&&(_0xdbdb8d=!![]);}if(_0xdbdb8d==![])return![];for(var _0xd6dc26=0x0,_0x309069=0xa;_0x1a62ef['length']-0x2>_0xd6dc26;_0xd6dc26++,_0x309069--){_0x130762+=_0x1a62ef[_0xd6dc26]*_0x309069;}_0x130762=_0x130762*0xa%0xb;_0x130762==0xa&&(_0x130762=0x0);if(_0x130762!=_0x1a62ef[0x9])return![];for(var _0xd6dc26=0x0,_0x309069=0xb;_0x1a62ef[_0x118ec6(0x264)]-0x1>_0xd6dc26;_0xd6dc26++,_0x309069--){_0x5096b4+=_0x1a62ef[_0xd6dc26]*_0x309069;}return _0x5096b4=_0x5096b4*0xa%0xb,_0x5096b4==0xa&&(_0x5096b4=0x0),_0x5096b4!=_0x1a62ef[0xa]?![]:!![];}else{if(_0x209ec1[_0x118ec6(0x264)]==0xe){var _0x53d436=_0x209ec1['trim']();_0x53d436=_0x53d436[_0x118ec6(0x300)](/\./g,''),_0x53d436=_0x53d436[_0x118ec6(0x300)]('-',''),_0x53d436=_0x53d436[_0x118ec6(0x300)]('/',''),_0x53d436=_0x53d436[_0x118ec6(0x1cc)]('');var _0x130762=0x0,_0x5096b4=0x0,_0xdbdb8d=![];for(var _0xd6dc26=0x1;_0x53d436['length']>_0xd6dc26;_0xd6dc26++){_0x53d436[_0xd6dc26-0x1]!=_0x53d436[_0xd6dc26]&&(_0xdbdb8d=!![]);}if(_0xdbdb8d==![])return![];for(var _0xd6dc26=0x0,_0x30e1cc=0x5,_0x4838c2=0xd;_0x53d436[_0x118ec6(0x264)]-0x2>_0xd6dc26;_0xd6dc26++,_0x30e1cc--,_0x4838c2--){_0x30e1cc>=0x2?_0x130762+=_0x53d436[_0xd6dc26]*_0x30e1cc:_0x130762+=_0x53d436[_0xd6dc26]*_0x4838c2;}_0x130762=_0x130762%0xb;_0x130762<0x2?_0x130762=0x0:_0x130762=0xb-_0x130762;if(_0x130762!=_0x53d436[0xc])return![];for(var _0xd6dc26=0x0,_0x30e1cc=0x6,_0x4838c2=0xe;_0x53d436['length']-0x1>_0xd6dc26;_0xd6dc26++,_0x30e1cc--,_0x4838c2--){_0x30e1cc>=0x2?_0x5096b4+=_0x53d436[_0xd6dc26]*_0x30e1cc:_0x5096b4+=_0x53d436[_0xd6dc26]*_0x4838c2;}return _0x5096b4=_0x5096b4%0xb,_0x5096b4<0x2?_0x5096b4=0x0:_0x5096b4=0xb-_0x5096b4,_0x5096b4!=_0x53d436[0xd]?![]:!![];}else return![];}}exports['validaCpfCnpj']=validaCpfCnpj;function timeout(_0x3ab486){return new Promise(_0x1b8fdf=>setTimeout(_0x1b8fdf,_0x3ab486));}async function sleep(_0xee85ef){await timeout(_0xee85ef);}exports[a558_0x1e95a7(0x330)]=sleep;const sendMessageImage=async(_0x436047,_0x134e66,_0x5fae44,_0x4e141c,_0x21171d)=>{const _0x19a3af=a558_0x1e95a7;let _0x3528fc;try{_0x3528fc=await _0x436047[_0x19a3af(0x314)](_0x134e66['number']+'@'+(_0x5fae44[_0x19a3af(0x319)]?_0x19a3af(0x205):_0x19a3af(0x352)),{'image':_0x4e141c?{'url':_0x4e141c}:fs_2['default'][_0x19a3af(0x2a8)](_0x19a3af(0x306)+_0x21171d+'-'+makeid(0xa)),'fileName':_0x21171d,'caption':_0x21171d,'mimetype':_0x19a3af(0x1cb)});}catch(_0x1c1c02){_0x3528fc=await _0x436047[_0x19a3af(0x314)](_0x134e66['number']+'@'+(_0x5fae44[_0x19a3af(0x319)]?'g.us':'s.whatsapp.net'),{'text':(0x0,Mustache_1[_0x19a3af(0x378)])(_0x19a3af(0x2ad),_0x5fae44)});}(0x0,exports[_0x19a3af(0x374)])(_0x3528fc,_0x5fae44,_0x134e66);};exports[a558_0x1e95a7(0x1fa)]=sendMessageImage;const sendMessageLink=async(_0x582efe,_0x3543e2,_0x44fa0d,_0x632135,_0x2f4cef)=>{const _0x189d51=a558_0x1e95a7;let _0x103329;try{_0x103329=await _0x582efe[_0x189d51(0x314)](_0x3543e2[_0x189d51(0x1f4)]+'@'+(_0x44fa0d[_0x189d51(0x319)]?_0x189d51(0x205):_0x189d51(0x352)),{'document':_0x632135?{'url':_0x632135}:fs_2['default'][_0x189d51(0x2a8)](_0x189d51(0x306)+_0x2f4cef+'-'+makeid(0xa)),'fileName':_0x2f4cef,'caption':_0x2f4cef,'mimetype':_0x189d51(0x1bf)});}catch(_0x2d217a){_0x103329=await _0x582efe[_0x189d51(0x314)](_0x3543e2[_0x189d51(0x1f4)]+'@'+(_0x44fa0d['isGroup']?_0x189d51(0x205):_0x189d51(0x352)),{'text':(0x0,Mustache_1['default'])('Não\x20consegui\x20enviar\x20o\x20PDF,\x20tente\x20novamente!',_0x44fa0d)});}(0x0,exports[_0x189d51(0x374)])(_0x103329,_0x44fa0d,_0x3543e2);};exports[a558_0x1e95a7(0x333)]=sendMessageLink;function makeid(_0x3ec7db){const _0xc52df1=a558_0x1e95a7;var _0x44b642='',_0xe901bb=_0xc52df1(0x28d),_0x4eb1fc=_0xe901bb['length'];for(var _0x5a2567=0x0;_0x5a2567<_0x3ec7db;_0x5a2567++){_0x44b642+=_0xe901bb['charAt'](Math['floor'](Math[_0xc52df1(0x32c)]()*_0x4eb1fc));}return _0x44b642;}exports[a558_0x1e95a7(0x251)]=makeid;const msgLocation=(_0x476874,_0x44e869,_0x2456a9)=>{const _0x2eb2e4=a558_0x1e95a7;if(_0x476874){var _0x21433d=Buffer[_0x2eb2e4(0x20f)](_0x476874)[_0x2eb2e4(0x2b2)](_0x2eb2e4(0x262));let _0x4e56b0=_0x2eb2e4(0x292)+_0x21433d+_0x2eb2e4(0x248)+_0x44e869+'%2C'+_0x2456a9+_0x2eb2e4(0x32f)+_0x44e869+',\x20'+_0x2456a9+'\x20';return _0x4e56b0;}},getBodyMessage=_0x353d93=>{const _0x22d2c4=a558_0x1e95a7;try{let _0xf82cd9=getTypeMessage(_0x353d93);const _0x571282={'conversation':MessageUtils[_0x22d2c4(0x211)](_0x353d93),'editedMessage':_0x353d93?.[_0x22d2c4(0x2c3)]?.[_0x22d2c4(0x32e)]?.[_0x22d2c4(0x2c3)]?.[_0x22d2c4(0x2e9)]?.[_0x22d2c4(0x32e)]?.[_0x22d2c4(0x284)]||_0x353d93?.[_0x22d2c4(0x2c3)]?.[_0x22d2c4(0x32e)]?.[_0x22d2c4(0x2c3)]?.['extendedTextMessage']?.[_0x22d2c4(0x35f)],'imageMessage':MessageUtils[_0x22d2c4(0x2f4)](_0x353d93),'videoMessage':MessageUtils[_0x22d2c4(0x23c)](_0x353d93),'extendedTextMessage':_0x353d93[_0x22d2c4(0x2c3)]?.['extendedTextMessage']?.[_0x22d2c4(0x35f)],'buttonsResponseMessage':MessageUtils[_0x22d2c4(0x22f)](_0x353d93),'templateButtonReplyMessage':_0x353d93[_0x22d2c4(0x2c3)]?.[_0x22d2c4(0x37c)]?.['selectedId'],'messageContextInfo':_0x353d93[_0x22d2c4(0x2c3)]?.[_0x22d2c4(0x224)]?.[_0x22d2c4(0x37b)]||_0x353d93[_0x22d2c4(0x2c3)]?.[_0x22d2c4(0x1ff)]?.[_0x22d2c4(0x316)],'buttonsMessage':MessageUtils[_0x22d2c4(0x1bc)](_0x353d93)||_0x353d93[_0x22d2c4(0x2c3)]?.['listResponseMessage']?.[_0x22d2c4(0x383)]?.[_0x22d2c4(0x261)],'viewOnceMessage':MessageUtils[_0x22d2c4(0x36e)](_0x353d93),'viewOnceMessageV2':MessageUtils[_0x22d2c4(0x242)](_0x353d93),'stickerMessage':MessageUtils[_0x22d2c4(0x373)](_0x353d93),'contactMessage':MessageUtils[_0x22d2c4(0x318)](_0x353d93),'contactsArrayMessage':_0x353d93[_0x22d2c4(0x2c3)]?.['contactsArrayMessage']?.[_0x22d2c4(0x1c3)]&&MessageUtils[_0x22d2c4(0x2ae)](_0x353d93),'pollCreationMessageV2':_0x353d93[_0x22d2c4(0x2c3)]?.[_0x22d2c4(0x2fa)]?.[_0x22d2c4(0x33c)]||_0x22d2c4(0x24a),'pollCreationMessageV3':_0x353d93[_0x22d2c4(0x2c3)]?.[_0x22d2c4(0x280)]?.[_0x22d2c4(0x33c)]||'Enquete\x20não\x20suportada,\x20abra\x20o\x20dispositivo\x20para\x20ler.','interactiveMessage':_0x353d93[_0x22d2c4(0x2c3)]?.[_0x22d2c4(0x2d8)]?.['body']||_0x353d93[_0x22d2c4(0x2c3)]?.[_0x22d2c4(0x2d8)]?.[_0x22d2c4(0x236)]||_0x22d2c4(0x372),'locationMessage':MessageUtils[_0x22d2c4(0x1de)](_0x353d93),'liveLocationMessage':'Latitude:\x20'+_0x353d93[_0x22d2c4(0x2c3)]?.[_0x22d2c4(0x2a6)]?.['degreesLatitude']+_0x22d2c4(0x1f0)+_0x353d93[_0x22d2c4(0x2c3)]?.[_0x22d2c4(0x2a6)]?.[_0x22d2c4(0x201)],'documentMessage':MessageUtils[_0x22d2c4(0x33b)](_0x353d93),'documentWithCaptionMessage':_0x353d93[_0x22d2c4(0x2c3)]?.[_0x22d2c4(0x331)]?.[_0x22d2c4(0x2c3)]?.[_0x22d2c4(0x1d9)]?.[_0x22d2c4(0x347)],'audioMessage':MessageUtils[_0x22d2c4(0x23a)](_0x353d93),'ephemeralMessage':_0x353d93[_0x22d2c4(0x2c3)]?.[_0x22d2c4(0x2b0)]?.[_0x22d2c4(0x2c3)]?.[_0x22d2c4(0x216)]?.[_0x22d2c4(0x35f)],'listMessage':MessageUtils['getBodyButton'](_0x353d93)||_0x353d93[_0x22d2c4(0x2c3)]?.[_0x22d2c4(0x1ff)]?.['title'],'listResponseMessage':MessageUtils[_0x22d2c4(0x274)](_0x353d93),'reactionMessage':MessageUtils[_0x22d2c4(0x38b)](_0x353d93)||_0x22d2c4(0x2d6),'advertising':MessageUtils[_0x22d2c4(0x245)](_0x353d93)||_0x353d93[_0x22d2c4(0x2c3)]?.[_0x22d2c4(0x1ff)]?.[_0x22d2c4(0x236)]?.[_0x22d2c4(0x2cd)]?.[_0x22d2c4(0x316)],'productMessage':_0x353d93[_0x22d2c4(0x2c3)]?.[_0x22d2c4(0x389)]?.['product']?.[_0x22d2c4(0x1ca)]?.[_0x22d2c4(0x347)]||_0x22d2c4(0x2cb),'multiProductMessage':_0x22d2c4(0x387),'orderMessage':_0x22d2c4(0x368),'paymentMessage':MessageUtils[_0x22d2c4(0x30a)](_0x353d93),'paymentRequestMessage':_0x22d2c4(0x231),'groupInviteMessage':MessageUtils[_0x22d2c4(0x311)](_0x353d93),'revokeInviteMessage':_0x22d2c4(0x32d),'protocolMessage':_0x353d93[_0x22d2c4(0x2c3)]?.[_0x22d2c4(0x2e9)]?.[_0x22d2c4(0x32e)]?.[_0x22d2c4(0x284)]||null,'disappearingMessage':'Mensagem\x20que\x20Desaparece','callMessage':MessageUtils[_0x22d2c4(0x291)](_0x353d93),'templateMessage':MessageUtils[_0x22d2c4(0x1db)](_0x353d93),'statusUpdateMessage':_0x22d2c4(0x1c6)};return _0x571282[_0xf82cd9]||null;}catch(_0x28ffcd){return console['error'](_0x22d2c4(0x38a),_0x28ffcd),null;}};exports['getBodyMessage']=getBodyMessage;const getQuotedMessage=_0x569169=>{const _0x2c0224=a558_0x1e95a7,_0x3f7f62=_0x569169[_0x2c0224(0x2c3)][_0x2c0224(0x1fe)]['contextInfo']||_0x569169['message'][_0x2c0224(0x24f)][_0x2c0224(0x236)]||_0x569169[_0x2c0224(0x2c3)]?.[_0x2c0224(0x1d9)]||_0x569169[_0x2c0224(0x2c3)][_0x2c0224(0x216)][_0x2c0224(0x236)]||_0x569169[_0x2c0224(0x2c3)]['buttonsResponseMessage'][_0x2c0224(0x236)]||_0x569169[_0x2c0224(0x2c3)]['listResponseMessage'][_0x2c0224(0x236)]||_0x569169[_0x2c0224(0x2c3)]['templateButtonReplyMessage'][_0x2c0224(0x236)]||_0x569169[_0x2c0224(0x2c3)]['buttonsResponseMessage']?.['contextInfo']||_0x569169?.[_0x2c0224(0x2c3)]?.[_0x2c0224(0x224)]?.[_0x2c0224(0x37b)]||_0x569169[_0x2c0224(0x2c3)][_0x2c0224(0x1ff)]?.[_0x2c0224(0x383)]?.[_0x2c0224(0x261)]||_0x569169?.[_0x2c0224(0x2c3)]?.[_0x2c0224(0x1ff)]?.[_0x2c0224(0x383)][_0x2c0224(0x261)]||_0x569169[_0x2c0224(0x2c3)]['listResponseMessage']?.[_0x2c0224(0x236)];return _0x569169[_0x2c0224(0x2c3)][_0x2c0224(0x336)],(0x0,baileys_1[_0x2c0224(0x2c1)])(_0x3f7f62[Object[_0x2c0224(0x37a)](_0x3f7f62)['values']()[_0x2c0224(0x2c6)]()[_0x2c0224(0x20b)]]);};exports[a558_0x1e95a7(0x213)]=getQuotedMessage;const getQuotedMessageId=_0x532aee=>{const _0x28a4e9=a558_0x1e95a7,_0x12f431=(0x0,baileys_1[_0x28a4e9(0x2c1)])(_0x532aee[_0x28a4e9(0x2c3)])[Object[_0x28a4e9(0x37a)](_0x532aee?.[_0x28a4e9(0x2c3)])['values']()['next']()[_0x28a4e9(0x20b)]];let _0x483ff5=_0x532aee?.[_0x28a4e9(0x2c3)]?.[_0x28a4e9(0x288)]?_0x532aee?.[_0x28a4e9(0x2c3)]?.[_0x28a4e9(0x288)]?.[_0x28a4e9(0x239)]?.['id']:'';return _0x483ff5?_0x483ff5:_0x12f431?.[_0x28a4e9(0x236)]?.[_0x28a4e9(0x1f9)];};exports[a558_0x1e95a7(0x27e)]=getQuotedMessageId;const getMeSocket=_0x59d8be=>{const _0x2663b4=a558_0x1e95a7;return{'id':(0x0,baileys_1[_0x2663b4(0x35d)])(_0x59d8be[_0x2663b4(0x1be)]['id']),'name':_0x59d8be[_0x2663b4(0x1be)][_0x2663b4(0x33c)]};},getSenderMessage=(_0x574055,_0x4aa1d3)=>{const _0x484630=a558_0x1e95a7,_0x2358a1=getMeSocket(_0x4aa1d3);if(_0x574055[_0x484630(0x239)][_0x484630(0x33d)])return _0x2358a1['id'];const _0x563baf=_0x574055[_0x484630(0x32a)]||_0x574055[_0x484630(0x239)][_0x484630(0x32a)]||_0x574055['key'][_0x484630(0x2d2)]||undefined;return _0x563baf&&(0x0,baileys_1['jidNormalizedUser'])(_0x563baf);},getContactMessage=async(_0x14a24c,_0x55ed4c)=>{const _0x5b0521=a558_0x1e95a7,_0x47ed44=_0x14a24c[_0x5b0521(0x239)]['remoteJid'][_0x5b0521(0x1d5)](_0x5b0521(0x205)),_0x24d0aa=_0x14a24c[_0x5b0521(0x239)][_0x5b0521(0x2d2)][_0x5b0521(0x300)](/\D/g,'');return _0x47ed44?{'id':getSenderMessage(_0x14a24c,_0x55ed4c),'name':_0x14a24c[_0x5b0521(0x21b)]}:{'id':_0x14a24c[_0x5b0521(0x239)][_0x5b0521(0x2d2)],'name':_0x14a24c[_0x5b0521(0x239)][_0x5b0521(0x33d)]?_0x24d0aa:_0x14a24c[_0x5b0521(0x21b)]};},getUnpackedMessage=_0x118133=>{const _0x266024=a558_0x1e95a7;return _0x118133[_0x266024(0x2c3)]?.['documentWithCaptionMessage']?.[_0x266024(0x2c3)]||_0x118133[_0x266024(0x2c3)]?.[_0x266024(0x216)]?.['contextInfo']?.[_0x266024(0x2b5)]||_0x118133[_0x266024(0x2c3)]?.[_0x266024(0x2b0)]?.[_0x266024(0x2c3)]||_0x118133['message']?.['viewOnceMessage']?.[_0x266024(0x2c3)]||_0x118133[_0x266024(0x2c3)]?.[_0x266024(0x22b)]?.[_0x266024(0x2c3)]||_0x118133[_0x266024(0x2c3)]?.[_0x266024(0x2b0)]?.[_0x266024(0x2c3)]||_0x118133[_0x266024(0x2c3)]?.[_0x266024(0x2ef)]?.[_0x266024(0x1c9)]||_0x118133[_0x266024(0x2c3)]?.[_0x266024(0x2ef)]?.[_0x266024(0x381)]||_0x118133[_0x266024(0x2c3)]?.[_0x266024(0x2ef)]?.[_0x266024(0x2dd)]||_0x118133[_0x266024(0x2c3)]?.[_0x266024(0x2d8)]?.[_0x266024(0x23d)]||_0x118133[_0x266024(0x2c3)]?.[_0x266024(0x36d)]?.[_0x266024(0x2e2)]?.[_0x266024(0x1c9)]||_0x118133[_0x266024(0x2c3)];},getMessageMedia=_0x28f002=>{const _0xf0b2b0=a558_0x1e95a7;return _0x28f002?.[_0xf0b2b0(0x1fe)]||_0x28f002?.[_0xf0b2b0(0x1e3)]||_0x28f002?.[_0xf0b2b0(0x24f)]||_0x28f002?.[_0xf0b2b0(0x33e)]||_0x28f002?.[_0xf0b2b0(0x1d9)]||null;},downloadMedia=async _0x2ad4d7=>{const _0x12a272=a558_0x1e95a7,_0x3bd8e9=getUnpackedMessage(_0x2ad4d7),_0x43cc6f=getMessageMedia(_0x3bd8e9);if(!_0x43cc6f)return null;const _0x1ef0ae=_0x3bd8e9?.[_0x12a272(0x1d9)]?_0x12a272(0x27f):_0x43cc6f[_0x12a272(0x30b)][_0x12a272(0x1cc)]('/')[0x0][_0x12a272(0x300)](_0x12a272(0x1ce),_0x12a272(0x27f))?_0x43cc6f[_0x12a272(0x30b)][_0x12a272(0x1cc)]('/')[0x0]['replace'](_0x12a272(0x1ce),'document'):_0x43cc6f['mimetype']['split']('/')[0x0];let _0x2225e5,_0x3da231=0x0;while(_0x3da231<0xa&&!_0x2225e5){try{_0x43cc6f?.[_0x12a272(0x26d)]&&(_0x43cc6f[_0x12a272(0x356)]=''),_0x2225e5=await(0x0,baileys_1['downloadContentFromMessage'])(_0x43cc6f,_0x1ef0ae);}catch(_0x3f3258){_0x3da231+=0x1,await new Promise(_0x46596d=>{setTimeout(_0x46596d,0x3e8*_0x3da231*0x2);}),logger_1[_0x12a272(0x30c)][_0x12a272(0x282)](_0x12a272(0x1c7)+_0x3da231+_0x12a272(0x296)+_0x2ad4d7?.['key']?.['id']);}}if(!_0x2225e5)throw new Error(_0x12a272(0x1d2));let _0x440037=_0x3bd8e9?.[_0x12a272(0x1d9)]?.['fileName']||'';if(!_0x440037){const _0x5bd444=mime_1['default'][_0x12a272(0x382)](_0x43cc6f[_0x12a272(0x30b)]);_0x440037=(0x0,MakeRandomId_1['makeRandomId'])(0x5)+'-'+new Date()[_0x12a272(0x273)]()+'.'+_0x5bd444;}else _0x440037=_0x440037['split']('.')[_0x12a272(0x369)](0x0,-0x1)[_0x12a272(0x370)]('.')+'.'+(0x0,MakeRandomId_1[_0x12a272(0x23f)])(0x5)+'.'+_0x440037[_0x12a272(0x1cc)]('.')[_0x12a272(0x369)](-0x1);const _0x52ec58=0x5*0x400*0x400/0x8,_0xefa8fa=0x400*0x400/0x8,_0x28f551=0x400*0x400,_0x196614=new stream_throttle_1[(_0x12a272(0x344))]({'rate':_0x52ec58});let _0x2c3336=Buffer[_0x12a272(0x20f)]([]),_0x2ff683=0x0;const _0x53b87c=Date[_0x12a272(0x1d7)]();try{for await(const _0x14bc8c of _0x2225e5['pipe'](_0x196614)){_0x2c3336=Buffer['concat']([_0x2c3336,_0x14bc8c]),_0x2ff683+=_0x14bc8c[_0x12a272(0x264)],_0x2ff683>_0x28f551&&(_0x196614[_0x12a272(0x22c)]=_0xefa8fa);}}catch(_0xcae000){return{'data':_0x12a272(0x2ce),'mimetype':'','filename':''};}const _0x132e6e=Date[_0x12a272(0x1d7)](),_0x37dcdf=(_0x132e6e-_0x53b87c)/0x3e8,_0x11f60e=_0x2ff683/_0x37dcdf;logger_1[_0x12a272(0x30c)]['debug'](_0x440037+'\x20Download\x20completed\x20in\x20'+_0x37dcdf[_0x12a272(0x30f)](0x2)+_0x12a272(0x31c)+(_0x11f60e/0x400/0x400)[_0x12a272(0x30f)](0x2)+_0x12a272(0x21c));if(!_0x2c3336){Sentry[_0x12a272(0x26e)](_0x12a272(0x360),{'msg':_0x2ad4d7}),Sentry[_0x12a272(0x323)](new Error('ERR_WAPP_DOWNLOAD_MEDIA'));throw new Error(_0x12a272(0x360));}const _0x57b9b4={'data':_0x2c3336,'mimetype':_0x43cc6f[_0x12a272(0x30b)],'filename':_0x440037};return _0x57b9b4;},verifyContact=async(_0x11975a,_0x3935dc,_0x2553a4)=>{const _0x1a30cd=a558_0x1e95a7,_0x31dc1a={'name':_0x11975a?.[_0x1a30cd(0x33c)]||_0x11975a['id']['replace'](/\D/g,''),'number':_0x11975a['id'][_0x1a30cd(0x2bc)](0x0,_0x11975a['id'][_0x1a30cd(0x29a)]('@')),'isGroup':_0x11975a['id'][_0x1a30cd(0x1d5)](_0x1a30cd(0x205)),'companyId':_0x2553a4,'whatsappId':_0x3935dc['id']},_0x59dc7e=(0x0,CreateOrUpdateContactService_1[_0x1a30cd(0x378)])(_0x31dc1a,_0x3935dc,_0x11975a['id']);return _0x59dc7e;},verifyQuotedMessage=async _0x8dfc00=>{const _0x351605=a558_0x1e95a7;if(!_0x8dfc00)return null;const _0x323874=(0x0,exports[_0x351605(0x27e)])(_0x8dfc00);if(!_0x323874)return null;const _0x403046=await Message_1[_0x351605(0x378)]['findOne']({'where':{'id':_0x323874}});if(!_0x403046)return null;return _0x403046;};exports['verifyQuotedMessage']=verifyQuotedMessage;function a558_0x627a(){const _0x2f6678=['sendGreetingMessageOneQueues','getTemplateMessage','path','hydratedContentText','getLocationMessage','resolve','Escolha\x20uma\x20opção','terceiro\x20if','getIO','audioMessage','maxUseBotQueues','trim','####\x20Nao\x20achou\x20o\x20type\x20em\x20isValidMsg:\x20','save','handleRating','../../helpers/Debounce','ffmpeg-static','userId','findByPk','183561kHomed','verifyQuotedMessage','verifyRecentCampaign','\x20-\x20Longitude:\x20','Mensagem\x20não\x20encontrada!','../WhatsappService/ShowWhatsAppService','listMessage','number','./wbotGetMessageFromType','\x0a*[\x20#\x20]*\x20-\x20Menu\x20inicial','endLunchTime','verifyRating','stanzaId','sendMessageImage','9000104rcYpkS','groups.update','messages','imageMessage','listResponseMessage','Erro\x20para\x20responder\x20com\x20audio:\x20','degreesLongitude','create','add','isNaN','g.us','../../models/QueueOption','greetingMediaAttachment','quarto\x20if','promisify','messages.update','value','filename','emit','fromAudioFileOutput','from','Importando\x20mensagens!!','getTextMessage','typebot','getQuotedMessage','fluent-ffmpeg','voiceKey','extendedTextMessage','button','call','env','REVOKE','pushName','\x20MBps','parentId','../../libs/cache','getMessageOptions','count','chatbot\x20desativado!','audio/mpeg','n8n','buttonsResponseMessage','Failed\x20to\x20fetch\x20queues:','-ticket','maxTokens','vcard','unlinkSync','hasOwnProperty','viewOnceMessageV2','rate','mediaPath','data','getButtonsMessage','isValidMsg','Solicitação\x20de\x20Pagamento','messageContextInfo','defineProperty','gpt-3.5-turbo-1106','.mp3','contextInfo','Error\x20isValidMsg','apply','key','getAudioMessage','botText\x203','getVideoMessage','header','whisper-1','makeRandomId','CIPHERTEXT','log','getViewOnceMessageV2','contacts:','contact','getAd','status','Menu\x20inicial\x20*[\x200\x20]*\x20Menu\x20anterior','\x20|\x20https://maps.google.com/maps?q=','public','Enquete\x20não\x20suportada,\x20abra\x20o\x20dispositivo\x20para\x20ler.','amountUsedBotQueues','botText\x202','../../queues','../../app','videoMessage','update!','makeid','../../models/User','head','verifyCampaignMessageAndCloseTicket','openai','util','content','HandleMessageJob','end','list',']\x20-\x20','\x20para\x20identificar\x20o\x20cliente.\x0aSua\x20resposta\x20deve\x20usar\x20no\x20máximo\x20','apiKey','queue','time','(((.+)+)+)+$','selectedRowId','base64','dddd','length','prototype','maxMessages','parseToMilliseconds','primeiro\x20if','Mensagem\x20inválida!','getBodyMessage','greetingMessage','assistant','directPath','setExtra','prompt','Error\x20converting\x20file:\x20','Mensagem\x20de\x20grupo\x20bloqueada!','queueId','getTime','getListMessage','E2E_IDENTITY_CHANGED','mediaName','delete','existsSync','SendPresenceStatus','proto','dataJson','../../models/Ticket','min','getQuotedMessageId','document','pollCreationMessageV3','402336UOsojo','warn','type','conversation','CheckMsgIsGroup','-appMessage','toFormat','reactionMessage','POST','E2E_DEVICE_CHANGED','webhook','public/company','ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789','set','isNumeric','../../libs/wbot','getCallMessage','data:image/png;base64,\x20','../../models/Message','isInteger','Failed\x20to\x20fetch\x20contact\x20from\x20ticket:','\x20de\x20baixar\x20o\x20arquivo\x20','company-','WebMessageInfo','\x20]*\x20-\x20','indexOf','Message','media','Erro\x20ao\x20salvar\x20avaliação!','subtract','campaignQueue','24092307wJIkkT','toUpperCase','voice','./providers','ASC','fora\x20do\x20horario','liveLocationMessage','Type','readFileSync','__setModuleDefault','viewOnceMessage','../../models/UserRating','stringify','Não\x20consegui\x20enviar\x20o\x20PDF,\x20tente\x20novamente!','getContactsArrayMessage','forEach','ephemeralMessage','voiceRegion','toString','wbotMessageListener','allowGroup','quotedMessage','ProtocolMessage','campaignId','disableBot','DAUMZAP','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Error\x20handling\x20message\x20ack.\x20Err:\x20','substring','Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento','fromSubscription','company','constructor','extractMessageContent','mp3','message','Mensagem\x20editada\x20não\x20encontrada:\x20','CHATBOT_RESTRICT_NUMBER','next','ticketId','@whiskeysockets/baileys','chatbot','temperature','Produto','body\x20is\x20not\x20a\x20string','externalAdReply','error','../QueueIntegrationServices/ShowQueueIntegrationService','createReadStream','then','remoteJid','\x0a*[\x200\x20]*\x20-\x20Menu\x20anterior','OpenAIApi','integrationId','reaction','complationMessage','interactiveMessage','createdAt','Novo\x20Tipo\x20de\x20Mensagem\x20em\x20isValidMsg','debounce','.wav','fourRowTemplate','startTime','__esModule','map','keywords','hydratedHsm','locationMessage','isArray','SpeechConfig','push','endsWith','7340571UZvwbE','protocolMessage','messageQueue','useIntegration','string','weekdayEn','../../models/Campaign','templateMessage','chatBotType','-open','../TicketServices/FindOrCreateATicketTrakingService','isNull','getImageMessage','toDate','validaCpfCnpj','search','../TicketServices/UpdateTicketService','lodash','pollCreationMessageV2','segundo\x20if','findAll','getContentType','SpeechSynthesizer','\x0a\x0a*[\x20#\x20]*\x20-\x20Voltar\x20ao\x20Menu\x20Principal','replace','minutes','AudioConfig','queues','close','Erro\x20ao\x20salvar\x20ticket!','public/temp/','MESSAGE_EDIT','speechSynthesisVoiceName','randomValue','getPaymentMessage','mimetype','logger','-closed','test','toFixed','option','getGroupInviteMessage','EM_ANDAMENTO','getMinutes','sendMessage','Erro\x20ao\x20buscar\x20grupo!','title','mediaType','getContactMessage','isGroup','@g.us','cacheLayer','\x20seconds\x20with\x20an\x20effective\x20speed\x20of\x20','./SendWhatsAppMessage','findIndex','outOfHoursMessage','SERVER_ACK','chatbotAt','body','captureException','getWbot','microsoft-cognitiveservices-speech-sdk','Mensagem\x20inválida\x208!\x20','DESC','promptId','endTime','participant','529Ochhaa','random','Convite\x20Revogado','editedMessage','&z=17&hl=pt-BR|','sleep','documentWithCaptionMessage','voiceMessage','sendMessageLink','HH:mm','changed','senderKeyDistributionMessage','contactMessage','../../libs/socket','Error\x20handling\x20whatsapp\x20message:\x20Err:\x20','isNil','getDocumentMessage','name','fromMe','stickerMessage','SAIR','56aqybuy','removeNonPrintableChars','handleMessageIntegration','__importStar','Throttle','Amigo(a)','messages.upsert','caption','companyId',':unreads','buttonsMessage','urlN8N','*[\x20','\x20tokens\x20e\x20cuide\x20para\x20não\x20truncar\x20o\x20final.\x0aSempre\x20que\x20possível,\x20mencione\x20o\x20nome\x20dele\x20para\x20ser\x20mais\x20personalizado\x20o\x20atendimento\x20e\x20mais\x20educado.\x20Quando\x20a\x20resposta\x20requer\x20uma\x20transferência\x20para\x20o\x20setor\x20de\x20atendimento,\x20comece\x20sua\x20resposta\x20com\x20\x27Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento\x27.\x0a\x0a\x20\x20','application/json','setMinutes','get','../../models/Setting','s.whatsapp.net','findOne','advertising','startLunchTime','url','ack','Lista','botText','./SendWhatsAppMedia','isBefore','149855bqnNou','jidNormalizedUser','texto','text','ERR_WAPP_DOWNLOAD_MEDIA','../../models/Queue','createChatCompletion','Status','choices','trace','../../helpers/SendPresenceStatus','mkdirSync','Pedido','slice','update','find','Mensagem','highlyStructuredMessage','getViewOnceMessage','createTranscription','join','4418LxtrXr','Mensagem\x20interativa\x20não\x20suportada,\x20abra\x20o\x20dispositivo\x20para\x20ler.','getStickerMessage','verifyMessage','../TicketServices/FindOrCreateTicketService','Error:\x20','*Você\x20encerrou\x20este\x20atendimento\x20usando\x20o\x20comando\x20SAIR*.\x0a\x0a\x0aSe\x20você\x20finalizou\x20o\x20atendimento\x20*ANTES*\x20de\x20receber\x20um\x20retorno\x20do\x20operador,\x20ele\x20*NÃO*\x20irá\x20visualizar\x20sua\x20solicitação!\x0a\x0aVocê\x20deve\x20aguardar\x20o\x20retorno\x20do\x20operador\x20e\x20que\x20ele\x20encerre\x20seu\x20atendimento\x20quando\x20necessário.\x0a\x0aUse\x20a\x20opção\x20*SAIR*\x20somente\x20em\x20casos\x20de\x20emergência\x20ou\x20se\x20ficou\x20preso\x20em\x20algum\x20setor.\x0a\x0a\x0aPara\x20iniciar\x20um\x20novo\x20atendimento\x20basta\x20enviar\x20uma\x20nova\x20mensagem!','default','chmodSync','keys','selectedButtonId','templateButtonReplyMessage','isAfter','dest','subject','enabled','hydratedFourRowTemplate','extension','singleSelectReply','gte','../MessageServices/CreateMessageService','upsert','Múltiplos\x20Produtos','request','productMessage','Error\x20getting\x20message\x20body:','getReactionMessage','##\x20if','writeFile','unknown','pending','getBodyButton','updatedAt','user','application/pdf','reload','No\x20result\x20from\x20synthesizer','queueOptionId','contacts','messageStubType','WAMessageStubType','Atualização\x20de\x20Status','>>>>\x20erro\x20','options','hydratedTemplate','productImage','image/jpeg','split','system','application','toLowerCase','closed','Expected\x20bodyMessage\x20to\x20be\x20a\x20string,\x20got:','Failed\x20to\x20get\x20stream','ratingAt','moment','includes','chat','now','MessageUpdateJob','documentMessage'];a558_0x627a=function(){return _0x2f6678;};return a558_0x627a();}const sanitizeName=_0x17e199=>{const _0x5b1f86=a558_0x1e95a7;let _0x35c493=_0x17e199[_0x5b1f86(0x1cc)]('\x20')[0x0];return _0x35c493=_0x35c493['replace'](/[^a-zA-Z0-9]/g,''),_0x35c493[_0x5b1f86(0x2bc)](0x0,0x3c);},convertTextToSpeechAndSaveToFile=(_0x3fcbcf,_0x47413e,_0x1b61fc,_0x2286c0,_0x433913='pt-BR-FabioNeural',_0x1b5714=a558_0x1e95a7(0x2c2))=>{return new Promise((_0x1dc557,_0x459640)=>{const _0x431099=a558_0x2d96,_0x2b4336=microsoft_cognitiveservices_speech_sdk_1[_0x431099(0x2e5)][_0x431099(0x2be)](_0x1b61fc,_0x2286c0);_0x2b4336[_0x431099(0x308)]=_0x433913;const _0x5924af=microsoft_cognitiveservices_speech_sdk_1[_0x431099(0x302)][_0x431099(0x20e)](_0x47413e+_0x431099(0x2dc)),_0x47b8bd=new microsoft_cognitiveservices_speech_sdk_1[(_0x431099(0x2fe))](_0x2b4336,_0x5924af);_0x47b8bd['speakTextAsync'](_0x3fcbcf,_0x141d4c=>{const _0x1d1f76=_0x431099;_0x141d4c?convertWavToAnotherFormat(_0x47413e+_0x1d1f76(0x2dc),_0x47413e+'.'+_0x1b5714,_0x1b5714)[_0x1d1f76(0x2d1)](_0x5768d3=>{_0x1dc557();})['catch'](_0x5cfba3=>{const _0x5af6e6=_0x1d1f76;console[_0x5af6e6(0x2ce)](_0x5cfba3),_0x459640(_0x5cfba3);}):_0x459640(new Error(_0x1d1f76(0x1c1))),_0x47b8bd[_0x1d1f76(0x304)]();},_0x50dab7=>{const _0xcf84bf=_0x431099;console[_0xcf84bf(0x2ce)](_0xcf84bf(0x376)+_0x50dab7),_0x47b8bd['close'](),_0x459640(_0x50dab7);});});},convertWavToAnotherFormat=(_0x438428,_0x21a3aa,_0x4c78c1)=>{return new Promise((_0x3f1cc1,_0x21fa8f)=>{const _0x50431f=a558_0x2d96;(0x0,fluent_ffmpeg_1[_0x50431f(0x378)])()['input'](_0x438428)[_0x50431f(0x287)](_0x4c78c1)['on'](_0x50431f(0x259),()=>_0x3f1cc1(_0x21a3aa))['on'](_0x50431f(0x2ce),_0x18eac2=>_0x21fa8f(new Error(_0x50431f(0x270)+_0x18eac2['message'])))[_0x50431f(0x1e7)](_0x21a3aa);});},deleteFileSync=_0x149134=>{const _0xac9f5e=a558_0x1e95a7;try{fs_2[_0xac9f5e(0x378)][_0xac9f5e(0x229)](_0x149134);}catch(_0x13791a){console[_0xac9f5e(0x2ce)]('Erro\x20ao\x20deletar\x20o\x20arquivo:',_0x13791a);}},keepOnlySpecifiedChars=_0x1dadd0=>{return _0x1dadd0['replace'](/[^a-zA-Z0-9áéíóúÁÉÍÓÚâêîôûÂÊÎÔÛãõÃÕçÇ!?.,;:\s]/g,'');},handleOpenAi=async(_0x1790ba,_0x43afac,_0x295944,_0x297528,_0x117146)=>{const _0x10daaf=a558_0x1e95a7,_0x15b444=(0x0,exports[_0x10daaf(0x26a)])(_0x1790ba);if(!_0x15b444)return;let {prompt:_0x3acb1e}=await(0x0,ShowWhatsAppService_1[_0x10daaf(0x378)])(_0x43afac['id'],_0x295944[_0x10daaf(0x348)]);!_0x3acb1e&&!(0x0,lodash_1[_0x10daaf(0x33a)])(_0x295944?.[_0x10daaf(0x25e)]?.[_0x10daaf(0x26f)])&&(_0x3acb1e=_0x295944[_0x10daaf(0x25e)][_0x10daaf(0x26f)]);if(!_0x3acb1e)return;if(_0x1790ba['messageStubType'])return;const _0x5cbfa0=path_1['default'][_0x10daaf(0x1df)](__dirname,'..','..','..',_0x10daaf(0x249));let _0xd7a6dd;const _0x22dacb=sessionsOpenAi[_0x10daaf(0x31e)](_0x5e8a89=>_0x5e8a89['id']===_0x43afac['id']);if(_0x22dacb===-0x1){const _0x1c7475=new openai_1['Configuration']({'apiKey':_0x3acb1e[_0x10daaf(0x25d)]});_0xd7a6dd=new openai_1[(_0x10daaf(0x2d4))](_0x1c7475),_0xd7a6dd['id']=_0x43afac['id'],sessionsOpenAi[_0x10daaf(0x2e6)](_0xd7a6dd);}else _0xd7a6dd=sessionsOpenAi[_0x22dacb];const _0x4e9030=await Message_1[_0x10daaf(0x378)][_0x10daaf(0x2fc)]({'where':{'ticketId':_0x295944['id']},'order':[[_0x10daaf(0x2d9),_0x10daaf(0x2a4)]],'limit':_0x3acb1e[_0x10daaf(0x266)]}),_0x431227='Nas\x20respostas\x20utilize\x20o\x20nome\x20'+sanitizeName(_0x297528[_0x10daaf(0x33c)]||_0x10daaf(0x345))+_0x10daaf(0x25c)+_0x3acb1e['maxTokens']+_0x10daaf(0x34d)+_0x3acb1e['prompt']+'\x0a';let _0x5f2591=[];if(_0x1790ba[_0x10daaf(0x2c3)]?.['conversation']||_0x1790ba[_0x10daaf(0x2c3)]?.[_0x10daaf(0x216)]?.[_0x10daaf(0x35f)]){_0x5f2591=[],_0x5f2591['push']({'role':'system','content':_0x431227});for(let _0x40a4ea=0x0;_0x40a4ea<Math[_0x10daaf(0x27d)](_0x3acb1e[_0x10daaf(0x266)],_0x4e9030[_0x10daaf(0x264)]);_0x40a4ea++){const _0x571cec=_0x4e9030[_0x40a4ea];_0x571cec['mediaType']===_0x10daaf(0x1d6)&&(_0x571cec[_0x10daaf(0x33d)]?_0x5f2591['push']({'role':_0x10daaf(0x26c),'content':_0x571cec[_0x10daaf(0x322)]}):_0x5f2591[_0x10daaf(0x2e6)]({'role':'user','content':_0x571cec[_0x10daaf(0x322)]}));}_0x5f2591[_0x10daaf(0x2e6)]({'role':_0x10daaf(0x1be),'content':_0x15b444});const _0x3fdf7c=await _0xd7a6dd[_0x10daaf(0x362)]({'model':_0x10daaf(0x234),'messages':_0x5f2591,'max_tokens':_0x3acb1e['maxTokens'],'temperature':_0x3acb1e[_0x10daaf(0x2ca)]});let _0x20fb30=_0x3fdf7c['data'][_0x10daaf(0x364)][0x0]['message']?.['content'];_0x20fb30?.[_0x10daaf(0x1d5)](_0x10daaf(0x2bd))&&(await transferQueue(_0x3acb1e[_0x10daaf(0x272)],_0x295944,_0x297528),_0x20fb30=_0x20fb30[_0x10daaf(0x300)]('Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento','')['trim']());if(_0x3acb1e[_0x10daaf(0x2a2)]===_0x10daaf(0x35e)){const _0x4d16a4=await _0x43afac['sendMessage'](_0x1790ba['key'][_0x10daaf(0x2d2)],{'text':_0x20fb30});await(0x0,exports['verifyMessage'])(_0x4d16a4,_0x295944,_0x297528);}else{const _0x6eac23=_0x295944['id']+'_'+Date[_0x10daaf(0x1d7)]();convertTextToSpeechAndSaveToFile(keepOnlySpecifiedChars(_0x20fb30),_0x5cbfa0+'/'+_0x6eac23,_0x3acb1e[_0x10daaf(0x215)],_0x3acb1e[_0x10daaf(0x2b1)],_0x3acb1e[_0x10daaf(0x2a2)],'mp3')['then'](async()=>{const _0xd9a8a2=_0x10daaf;try{const _0x1a95db=await _0x43afac[_0xd9a8a2(0x314)](_0x1790ba[_0xd9a8a2(0x239)][_0xd9a8a2(0x2d2)],{'audio':{'url':_0x5cbfa0+'/'+_0x6eac23+_0xd9a8a2(0x235)},'mimetype':_0xd9a8a2(0x222),'ptt':!![]});await verifyMediaMessage(_0x1a95db,_0x295944,_0x297528),deleteFileSync(_0x5cbfa0+'/'+_0x6eac23+_0xd9a8a2(0x235)),deleteFileSync(_0x5cbfa0+'/'+_0x6eac23+_0xd9a8a2(0x2dc));}catch(_0xb60e3e){console[_0xd9a8a2(0x241)](_0xd9a8a2(0x200)+_0xb60e3e);}});}}else{if(_0x1790ba['message']?.[_0x10daaf(0x1e3)]){const _0x3906c7=_0x117146['mediaUrl']['split']('/')['pop'](),_0x357b72=fs_2[_0x10daaf(0x378)][_0x10daaf(0x2d0)](_0x5cbfa0+'/'+_0x3906c7),_0x1d7d43=await _0xd7a6dd[_0x10daaf(0x36f)](_0x357b72,_0x10daaf(0x23e));_0x5f2591=[],_0x5f2591[_0x10daaf(0x2e6)]({'role':_0x10daaf(0x1cd),'content':_0x431227});for(let _0x23be8b=0x0;_0x23be8b<Math[_0x10daaf(0x27d)](_0x3acb1e[_0x10daaf(0x266)],_0x4e9030['length']);_0x23be8b++){const _0x161cbd=_0x4e9030[_0x23be8b];_0x161cbd[_0x10daaf(0x317)]===_0x10daaf(0x1d6)&&(_0x161cbd[_0x10daaf(0x33d)]?_0x5f2591[_0x10daaf(0x2e6)]({'role':_0x10daaf(0x26c),'content':_0x161cbd['body']}):_0x5f2591[_0x10daaf(0x2e6)]({'role':_0x10daaf(0x1be),'content':_0x161cbd[_0x10daaf(0x322)]}));}_0x5f2591['push']({'role':'user','content':_0x1d7d43[_0x10daaf(0x22e)][_0x10daaf(0x35f)]});const _0x5a42e3=await _0xd7a6dd['createChatCompletion']({'model':_0x10daaf(0x234),'messages':_0x5f2591,'max_tokens':_0x3acb1e[_0x10daaf(0x227)],'temperature':_0x3acb1e[_0x10daaf(0x2ca)]});let _0x3c8706=_0x5a42e3[_0x10daaf(0x22e)][_0x10daaf(0x364)][0x0]['message']?.[_0x10daaf(0x257)];_0x3c8706?.[_0x10daaf(0x1d5)]('Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento')&&(await transferQueue(_0x3acb1e[_0x10daaf(0x272)],_0x295944,_0x297528),_0x3c8706=_0x3c8706[_0x10daaf(0x300)](_0x10daaf(0x2bd),'')[_0x10daaf(0x1e5)]());if(_0x3acb1e['voice']===_0x10daaf(0x35e)){const _0x33507e=await _0x43afac[_0x10daaf(0x314)](_0x1790ba[_0x10daaf(0x239)][_0x10daaf(0x2d2)],{'text':_0x3c8706});await(0x0,exports[_0x10daaf(0x374)])(_0x33507e,_0x295944,_0x297528);}else{const _0x54c9ed=_0x295944['id']+'_'+Date[_0x10daaf(0x1d7)]();convertTextToSpeechAndSaveToFile(keepOnlySpecifiedChars(_0x3c8706),_0x5cbfa0+'/'+_0x54c9ed,_0x3acb1e[_0x10daaf(0x215)],_0x3acb1e['voiceRegion'],_0x3acb1e[_0x10daaf(0x2a2)],_0x10daaf(0x2c2))[_0x10daaf(0x2d1)](async()=>{const _0x27c75=_0x10daaf;try{const _0x27f4b6=await _0x43afac['sendMessage'](_0x1790ba[_0x27c75(0x239)]['remoteJid'],{'audio':{'url':_0x5cbfa0+'/'+_0x54c9ed+_0x27c75(0x235)},'mimetype':_0x27c75(0x222),'ptt':!![]});await verifyMediaMessage(_0x27f4b6,_0x295944,_0x297528),deleteFileSync(_0x5cbfa0+'/'+_0x54c9ed+_0x27c75(0x235)),deleteFileSync(_0x5cbfa0+'/'+_0x54c9ed+_0x27c75(0x2dc));}catch(_0x589bad){console[_0x27c75(0x241)]('Erro\x20para\x20responder\x20com\x20audio:\x20'+_0x589bad);}});}}}_0x5f2591=[];},transferQueue=async(_0x5ab999,_0x2ba99f,_0x5ca232)=>{const _0x109d32=a558_0x1e95a7;console[_0x109d32(0x365)](_0x109d32(0x250)),await(0x0,UpdateTicketService_1[_0x109d32(0x378)])({'ticketData':{'queueId':_0x5ab999,'useIntegration':![],'promptId':null},'ticketId':_0x2ba99f['id'],'companyId':_0x2ba99f[_0x109d32(0x348)]});},verifyMediaMessage=async(_0x440f26,_0x5c0b9d,_0x531560)=>{const _0x1978af=a558_0x1e95a7,_0x2b211d=(0x0,socket_1[_0x1978af(0x1e2)])();let _0x4b53f9=await Message_1[_0x1978af(0x378)][_0x1978af(0x353)]({'where':{'id':_0x440f26[_0x1978af(0x239)]['id']}});if(!_0x4b53f9){const _0x233ea2=await(0x0,exports[_0x1978af(0x1ee)])(_0x440f26),_0x241415=(0x0,wbot_1[_0x1978af(0x324)])(_0x5c0b9d['whatsappId']),_0x14fc9f=await downloadMedia(_0x440f26);if(!_0x14fc9f)throw new Error(_0x1978af(0x360));if(!_0x14fc9f[_0x1978af(0x20c)]){const _0x112917=typeof _0x14fc9f['mimetype']===_0x1978af(0x2ec)&&_0x14fc9f[_0x1978af(0x30b)][_0x1978af(0x1d5)]('/')&&_0x14fc9f[_0x1978af(0x30b)]['includes'](';')?mime_1[_0x1978af(0x378)][_0x1978af(0x382)](_0x14fc9f[_0x1978af(0x30b)]):_0x1978af(0x1ba);_0x14fc9f[_0x1978af(0x20c)]=new Date()[_0x1978af(0x273)]()+'.'+_0x112917;}else{let _0x12353e=_0x14fc9f[_0x1978af(0x20c)]?'-'+_0x14fc9f[_0x1978af(0x20c)]:'';_0x14fc9f[_0x1978af(0x20c)]=''+new Date()[_0x1978af(0x273)]()+_0x12353e;}try{const _0x5052ce=_0x1978af(0x28c)+_0x5c0b9d[_0x1978af(0x348)];!fs_2['default'][_0x1978af(0x278)](_0x5052ce)&&(fs_2[_0x1978af(0x378)][_0x1978af(0x367)](_0x5052ce),fs_2[_0x1978af(0x378)][_0x1978af(0x379)](_0x5052ce,0x1ff)),await writeFileAsync((0x0,path_1[_0x1978af(0x370)])(__dirname,'..','..','..',_0x5052ce,_0x14fc9f['filename']),_0x14fc9f[_0x1978af(0x22e)],'base64');}catch(_0x285c44){Sentry[_0x1978af(0x323)](_0x285c44),logger_1[_0x1978af(0x30c)]['error'](_0x285c44);}const _0x439cc8=(0x0,exports[_0x1978af(0x26a)])(_0x440f26);var _0x500197=getTypeMessage(_0x440f26);const _0x52acb3={'id':_0x440f26[_0x1978af(0x239)]['id'],'ticketId':_0x5c0b9d['id'],'contactId':_0x440f26[_0x1978af(0x239)][_0x1978af(0x33d)]?undefined:_0x531560['id'],'body':_0x439cc8?(0x0,Mustache_1['default'])(_0x439cc8,_0x5c0b9d):_0x14fc9f[_0x1978af(0x20c)],'fromMe':_0x440f26[_0x1978af(0x239)][_0x1978af(0x33d)],'read':_0x440f26[_0x1978af(0x239)][_0x1978af(0x33d)],'mediaUrl':_0x14fc9f['filename'],'mediaType':typeof _0x14fc9f['mimetype']===_0x1978af(0x2ec)?_0x14fc9f[_0x1978af(0x30b)][_0x1978af(0x1cc)]('/')[0x0]:_0x1978af(0x1ba),'quotedMsgId':_0x233ea2?.['id'],'ack':getStatus(_0x440f26,_0x1978af(0x29c)),'remoteJid':_0x440f26[_0x1978af(0x239)][_0x1978af(0x2d2)],'participant':_0x440f26['key'][_0x1978af(0x32a)],'dataJson':JSON['stringify'](_0x440f26)};var _0x38dd52=_0x439cc8||_0x14fc9f[_0x1978af(0x20c)];typeof _0x38dd52!=_0x1978af(0x2ec)&&console[_0x1978af(0x365)]('body\x20is\x20not\x20a\x20string',_0x38dd52),await _0x5c0b9d[_0x1978af(0x36a)]({'lastMessage':_0x38dd52}),_0x4b53f9=await(0x0,CreateMessageService_1['default'])({'messageData':_0x52acb3,'ticket':_0x5c0b9d,'companyId':_0x5c0b9d[_0x1978af(0x348)]});}else typeof _0x4b53f9[_0x1978af(0x322)]!=_0x1978af(0x2ec)&&console[_0x1978af(0x365)](_0x1978af(0x2cc),_0x4b53f9[_0x1978af(0x322)]),await _0x5c0b9d[_0x1978af(0x36a)]({'lastMessage':_0x4b53f9[_0x1978af(0x322)]}),_0x4b53f9[_0x1978af(0x357)]=getStatus(_0x440f26,_0x1978af(0x29c)),_0x4b53f9['participant']=_0x440f26[_0x1978af(0x239)]['participant'],_0x4b53f9[_0x1978af(0x27b)]=JSON[_0x1978af(0x2ac)](_0x440f26),await _0x4b53f9[_0x1978af(0x1e7)]();return!_0x440f26[_0x1978af(0x239)][_0x1978af(0x33d)]&&_0x5c0b9d[_0x1978af(0x246)]==='closed'&&(await _0x5c0b9d['update']({'status':'pending'}),await _0x5c0b9d['reload']({'include':[{'model':Queue_1['default'],'as':_0x1978af(0x25e)},{'model':User_1[_0x1978af(0x378)],'as':_0x1978af(0x1be)},{'model':Contact_1[_0x1978af(0x378)],'as':_0x1978af(0x244)}]}),_0x2b211d['to'](_0x1978af(0x297)+_0x5c0b9d[_0x1978af(0x348)]+_0x1978af(0x30d))[_0x1978af(0x20d)](_0x1978af(0x297)+_0x5c0b9d['companyId']+_0x1978af(0x226),{'action':_0x1978af(0x277),'ticket':_0x5c0b9d,'ticketId':_0x5c0b9d['id']}),_0x2b211d['to'](_0x1978af(0x297)+_0x5c0b9d[_0x1978af(0x348)]+'-'+_0x5c0b9d['status'])['to'](_0x5c0b9d['id'][_0x1978af(0x2b2)]())[_0x1978af(0x20d)]('company-'+_0x5c0b9d['companyId']+_0x1978af(0x226),{'action':'update','ticket':_0x5c0b9d,'ticketId':_0x5c0b9d['id']})),_0x4b53f9;};function getStatus(_0x5bab69,_0x56364c){const _0x19d887=a558_0x1e95a7;if(_0x5bab69[_0x19d887(0x246)]==baileys_1['proto'][_0x19d887(0x298)][_0x19d887(0x363)]['PENDING']){if(_0x5bab69[_0x19d887(0x239)][_0x19d887(0x33d)]&&_0x56364c=='reactionMessage')return 0x3;return 0x1;}else{if(_0x5bab69[_0x19d887(0x246)]==baileys_1['proto'][_0x19d887(0x298)][_0x19d887(0x363)][_0x19d887(0x320)])return 0x1;else{if(_0x5bab69[_0x19d887(0x246)]==baileys_1[_0x19d887(0x27a)][_0x19d887(0x298)][_0x19d887(0x363)]['DELIVERY_ACK'])return 0x2;else{if(_0x5bab69[_0x19d887(0x246)]==baileys_1[_0x19d887(0x27a)][_0x19d887(0x298)][_0x19d887(0x363)]['READ']||_0x5bab69[_0x19d887(0x246)]==baileys_1[_0x19d887(0x27a)][_0x19d887(0x298)]['Status']['PLAYED'])return 0x3;}}}return 0x0;}const verifyMessage=async(_0x4bc848,_0x1e9199,_0x55b5b7)=>{const _0x450ca0=a558_0x1e95a7,_0x5b5eb8=(0x0,socket_1[_0x450ca0(0x1e2)])(),_0x1695ba=await(0x0,exports[_0x450ca0(0x1ee)])(_0x4bc848),_0x1bafca=(0x0,exports[_0x450ca0(0x26a)])(_0x4bc848);if(!_0x1bafca)return;let _0x391b05=getTypeMessage(_0x4bc848);const _0x38cbdc=_0x391b05==_0x450ca0(0x32e)||_0x4bc848?.[_0x450ca0(0x2c3)]?.[_0x450ca0(0x2e9)]?.[_0x450ca0(0x283)]==baileys_1['proto'][_0x450ca0(0x29b)][_0x450ca0(0x2b6)][_0x450ca0(0x2a7)][_0x450ca0(0x307)]||_0x4bc848?.[_0x450ca0(0x2c3)]?.[_0x450ca0(0x2e9)]?.[_0x450ca0(0x32e)]?.[_0x450ca0(0x284)]?.[_0x450ca0(0x264)]>0x0;let _0x3d1ddc=_0x4bc848[_0x450ca0(0x239)]['id'];if(_0x391b05==_0x450ca0(0x2e9))_0x3d1ddc=_0x4bc848?.[_0x450ca0(0x2c3)]?.[_0x450ca0(0x2e9)]?.[_0x450ca0(0x239)]?.['id']||_0x4bc848[_0x450ca0(0x239)]['id'];else _0x391b05==_0x450ca0(0x32e)&&(_0x3d1ddc=_0x4bc848?.[_0x450ca0(0x2c3)]?.['editedMessage']?.['message']?.['protocolMessage']?.[_0x450ca0(0x239)]?.['id']||_0x4bc848['key']['id']);const _0x3744a9={'id':_0x3d1ddc,'ticketId':_0x1e9199['id'],'contactId':_0x4bc848[_0x450ca0(0x239)][_0x450ca0(0x33d)]?undefined:_0x55b5b7['id'],'body':_0x1bafca,'fromMe':_0x4bc848['key'][_0x450ca0(0x33d)],'mediaType':_0x391b05,'read':_0x4bc848[_0x450ca0(0x239)]['fromMe'],'quotedMsgId':_0x1695ba?.['id'],'ack':getStatus(_0x4bc848,_0x391b05),'remoteJid':_0x4bc848[_0x450ca0(0x239)][_0x450ca0(0x2d2)],'participant':_0x4bc848[_0x450ca0(0x239)][_0x450ca0(0x32a)],'dataJson':JSON[_0x450ca0(0x2ac)](_0x4bc848),'isEdited':_0x38cbdc};typeof _0x1bafca!='string'&&console[_0x450ca0(0x365)]('body\x20is\x20not\x20a\x20string',_0x1bafca);await _0x1e9199['update']({'lastMessage':_0x1bafca});if(_0x38cbdc){let _0x5e48b0=await Message_1[_0x450ca0(0x378)][_0x450ca0(0x1ec)](_0x3744a9['id']);if(_0x5e48b0){const _0x1b7ce7={'messageId':_0x3744a9['id'],'body':_0x5e48b0[_0x450ca0(0x322)]};await OldMessage_1[_0x450ca0(0x378)][_0x450ca0(0x386)](_0x1b7ce7);}else console[_0x450ca0(0x241)](_0x450ca0(0x2c4)+_0x3744a9['id']);}await(0x0,CreateMessageService_1[_0x450ca0(0x378)])({'messageData':_0x3744a9,'ticket':_0x1e9199,'companyId':_0x1e9199[_0x450ca0(0x348)]}),!_0x4bc848[_0x450ca0(0x239)]['fromMe']&&_0x1e9199[_0x450ca0(0x246)]===_0x450ca0(0x1d0)&&(await _0x1e9199[_0x450ca0(0x36a)]({'status':_0x450ca0(0x1bb)}),await _0x1e9199[_0x450ca0(0x1c0)]({'include':[{'model':Queue_1[_0x450ca0(0x378)],'as':'queue'},{'model':User_1['default'],'as':_0x450ca0(0x1be)},{'model':Contact_1[_0x450ca0(0x378)],'as':'contact'}]}),_0x5b5eb8['to'](_0x450ca0(0x297)+_0x1e9199[_0x450ca0(0x348)]+'-closed')['emit'](_0x450ca0(0x297)+_0x1e9199[_0x450ca0(0x348)]+_0x450ca0(0x226),{'action':_0x450ca0(0x277),'ticket':_0x1e9199,'ticketId':_0x1e9199['id']}),_0x5b5eb8['to'](_0x450ca0(0x297)+_0x1e9199['companyId']+'-'+_0x1e9199[_0x450ca0(0x246)])['to'](_0x1e9199['id'][_0x450ca0(0x2b2)]())['emit'](_0x450ca0(0x297)+_0x1e9199[_0x450ca0(0x348)]+_0x450ca0(0x226),{'action':'update','ticket':_0x1e9199,'ticketId':_0x1e9199['id']}));};exports[a558_0x1e95a7(0x374)]=verifyMessage;const isValidMsg=_0x1db485=>{const _0xd5947=a558_0x1e95a7;if(_0x1db485['key']['remoteJid']==='status@broadcast')return![];try{const _0x4509ed=getTypeMessage(_0x1db485);if(!_0x4509ed)return![];const _0x6714f0=_0x4509ed===_0xd5947(0x284)||_0x4509ed===_0xd5947(0x32e)||_0x4509ed===_0xd5947(0x216)||_0x4509ed===_0xd5947(0x1e3)||_0x4509ed===_0xd5947(0x24f)||_0x4509ed==='pollCreationMessageV2'||_0x4509ed===_0xd5947(0x2ef)||_0x4509ed===_0xd5947(0x280)||_0x4509ed==='interactiveMessage'||_0x4509ed===_0xd5947(0x1fe)||_0x4509ed==='documentMessage'||_0x4509ed===_0xd5947(0x331)||_0x4509ed===_0xd5947(0x33e)||_0x4509ed===_0xd5947(0x224)||_0x4509ed===_0xd5947(0x34a)||_0x4509ed===_0xd5947(0x232)||_0x4509ed===_0xd5947(0x2e3)||_0x4509ed===_0xd5947(0x2a6)||_0x4509ed===_0xd5947(0x337)||_0x4509ed===_0xd5947(0x332)||_0x4509ed==='mediaMessage'||_0x4509ed==='contactsArrayMessage'||_0x4509ed==='reactionMessage'||_0x4509ed===_0xd5947(0x2b0)||_0x4509ed===_0xd5947(0x2e9)||_0x4509ed==='listResponseMessage'||_0x4509ed===_0xd5947(0x1f3)||_0x4509ed===_0xd5947(0x2aa)||_0x4509ed==='viewOnceMessageV2'||_0x4509ed===_0xd5947(0x354)||_0x4509ed===_0xd5947(0x36d);return!_0x6714f0&&(logger_1[_0xd5947(0x30c)][_0xd5947(0x282)](_0xd5947(0x1e6)+_0x4509ed+'\x0a'+JSON[_0xd5947(0x2ac)](_0x1db485?.[_0xd5947(0x2c3)])),Sentry['setExtra'](_0xd5947(0x36c),{'BodyMsg':_0x1db485[_0xd5947(0x2c3)],'msg':_0x1db485,'msgType':_0x4509ed}),Sentry[_0xd5947(0x323)](new Error(_0xd5947(0x2da)))),!!_0x6714f0;}catch(_0x454d53){Sentry[_0xd5947(0x26e)](_0xd5947(0x237),{'msg':_0x1db485}),Sentry['captureException'](_0x454d53);}return![];};exports['isValidMsg']=isValidMsg;const Push=_0x586173=>{const _0x27dfde=a558_0x1e95a7;return _0x586173[_0x27dfde(0x21b)];},verifyQueue=async(_0x3af162,_0x2abd0f,_0x3b9959,_0x5669f3,_0x4d3c48)=>{const _0x24357a=a558_0x1e95a7,_0x39cf34=_0x3b9959['companyId'],{queues:_0x393e36,greetingMessage:_0x5bf9c7,maxUseBotQueues:_0x2bd6e7,timeUseBotQueues:_0x43f560}=await(0x0,ShowWhatsAppService_1['default'])(_0x3af162['id'],_0x3b9959['companyId']);if(_0x393e36['length']===0x1){const _0x4a4f35=(0x0,lodash_1[_0x24357a(0x253)])(_0x393e36);let _0x2bb56f=![];_0x4a4f35?.[_0x24357a(0x1c8)]&&(_0x2bb56f=_0x4a4f35['options'][_0x24357a(0x264)]>0x0);const _0xecc59d=await Setting_1[_0x24357a(0x378)][_0x24357a(0x353)]({'where':{'key':_0x24357a(0x1da),'companyId':_0x3b9959[_0x24357a(0x348)]}});greetingMessageControl[_0x24357a(0x2e6)]({'ticketId':_0x3b9959['id'],'greetingMessage':_0x5bf9c7,'companyId':_0x39cf34});if(_0x5bf9c7[_0x24357a(0x264)]>0x1&&_0xecc59d?.[_0x24357a(0x20b)]===_0x24357a(0x380)){const _0x41e238=await Message_1['default'][_0x24357a(0x353)]({'where':{'ticketId':_0x3b9959['id'],'fromMe':!![],'createdAt':{[sequelize_1['Op'][_0x24357a(0x384)]]:(0x0,moment_1['default'])()[_0x24357a(0x29e)](0x5,'minutes')[_0x24357a(0x2f5)]()}}});if(_0x41e238)return;const _0x3dbb79=(0x0,Mustache_1[_0x24357a(0x378)])(''+_0x5bf9c7,_0x3b9959);await _0x3af162[_0x24357a(0x314)](_0x5669f3[_0x24357a(0x1f4)]+'@'+(_0x3b9959['isGroup']?_0x24357a(0x205):_0x24357a(0x352)),{'text':_0x3dbb79});}const _0x38df26=await(0x0,ShowWhatsAppService_1[_0x24357a(0x378)])(_0x3af162['id'],_0x39cf34),_0x4634e2=_0x393e36[0x0]?.[_0x24357a(0x2d5)]||_0x38df26[_0x24357a(0x2d5)];if(!_0x2abd0f['key'][_0x24357a(0x33d)]&&!_0x3b9959[_0x24357a(0x319)]&&!(0x0,lodash_1[_0x24357a(0x33a)])(_0x4634e2)){const _0x3aa9e5=await(0x0,ShowQueueIntegrationService_1[_0x24357a(0x378)])(_0x4634e2,_0x39cf34);await(0x0,exports['handleMessageIntegration'])(_0x2abd0f,_0x3af162,_0x3aa9e5,_0x3b9959),await _0x3b9959[_0x24357a(0x36a)]({'useIntegration':!![],'integrationId':_0x3aa9e5['id']});}const _0x2afac7=_0x393e36[0x0]?.['promptId']||_0x38df26[_0x24357a(0x328)];!_0x2abd0f[_0x24357a(0x239)][_0x24357a(0x33d)]&&!_0x3b9959['isGroup']&&!(0x0,lodash_1['isNil'])(_0x2afac7)&&(console[_0x24357a(0x241)]('\x201286\x20-\x20Entrei\x20na\x20integracao\x20openai.'),await handleOpenAi(_0x2abd0f,_0x3af162,_0x3b9959,_0x5669f3,_0x4d3c48),await _0x3b9959[_0x24357a(0x36a)]({'useIntegration':!![],'promptId':_0x2afac7}));await(0x0,UpdateTicketService_1['default'])({'ticketData':{'queueId':_0x4a4f35?.['id'],'chatbot':_0x2bb56f,'status':_0x24357a(0x1bb)},'ticketId':_0x3b9959['id'],'companyId':_0x3b9959['companyId']});return;}const _0x23f54b=_0x2abd0f?.[_0x24357a(0x2c3)]?.[_0x24357a(0x224)]?.[_0x24357a(0x37b)]||_0x2abd0f?.[_0x24357a(0x2c3)]?.[_0x24357a(0x1ff)]?.['singleSelectReply']?.[_0x24357a(0x261)]||_0x2abd0f?.['message']?.[_0x24357a(0x216)]?.[_0x24357a(0x35f)]||_0x2abd0f?.[_0x24357a(0x2c3)]?.[_0x24357a(0x284)];let _0x440a02=null;if(_0x23f54b&&!(0x0,exports[_0x24357a(0x28f)])(_0x23f54b)||+_0x23f54b>_0x393e36[_0x24357a(0x264)]){const _0x3aefc5=_0x23f54b[_0x24357a(0x1cf)]();for(let _0x451d15 of _0x393e36){if(_0x451d15[_0x24357a(0x33c)]['toLowerCase']()===_0x3aefc5){_0x440a02=_0x451d15;break;}if(_0x451d15[_0x24357a(0x2e1)]&&_0x451d15[_0x24357a(0x2e1)]['length']>0x0){let _0x3e874c=_0x451d15[_0x24357a(0x2e1)]['split'](',\x20');for(let _0x21cedd of _0x3e874c){if(_0x21cedd[_0x24357a(0x1cf)]()==_0x3aefc5){_0x440a02=_0x451d15;break;}}}}}else _0x440a02=_0x393e36[+_0x23f54b-0x1];const _0x52e5c1=await Setting_1[_0x24357a(0x378)][_0x24357a(0x353)]({'where':{'key':_0x24357a(0x2f0),'companyId':_0x39cf34}}),_0x28e9ba=async()=>{const _0x46ece6=_0x24357a;let _0x237a58='';if(outOfHourMessageControl[_0x46ece6(0x264)]>0x1388)outOfHourMessageControl=[];_0x393e36[_0x46ece6(0x2af)]((_0x118bd7,_0x498f7b)=>{const _0x58601d=_0x46ece6;_0x237a58+=_0x58601d(0x34c)+(_0x498f7b+0x1)+'\x20]*\x20-\x20'+_0x118bd7[_0x58601d(0x33c)]+'\x0a';});if(process[_0x46ece6(0x219)]['CHATBOT_RESTRICT_NUMBER']?.[_0x46ece6(0x264)]>=0x8){if(_0x3b9959[_0x46ece6(0x244)][_0x46ece6(0x1f4)]!=process[_0x46ece6(0x219)]['CHATBOT_RESTRICT_NUMBER']){console[_0x46ece6(0x365)](_0x46ece6(0x221));return;}}const _0x23074d={'text':(0x0,Mustache_1[_0x46ece6(0x378)])('‎'+_0x5bf9c7+'\x0a\x0a'+_0x237a58,_0x3b9959)};await(0x0,UpdateTicketService_1[_0x46ece6(0x378)])({'ticketData':{'amountUsedBotQueues':_0x3b9959[_0x46ece6(0x24b)]+0x1},'ticketId':_0x3b9959['id'],'companyId':_0x3b9959['companyId']});const _0x18b779=await _0x3af162[_0x46ece6(0x314)](_0x5669f3[_0x46ece6(0x1f4)]+'@'+(_0x3b9959[_0x46ece6(0x319)]?_0x46ece6(0x205):_0x46ece6(0x352)),_0x23074d);await(0x0,exports[_0x46ece6(0x374)])(_0x18b779,_0x3b9959,_0x3b9959[_0x46ece6(0x244)]);};if(_0x440a02){let _0x10f78d=![];_0x440a02?.[_0x24357a(0x1c8)]&&(_0x10f78d=_0x440a02[_0x24357a(0x1c8)][_0x24357a(0x264)]>0x0);await(0x0,UpdateTicketService_1[_0x24357a(0x378)])({'ticketData':{'queueId':_0x440a02['id'],'chatbot':_0x10f78d,'status':'pending','amountUsedBotQueues':0x0},'ticketId':_0x3b9959['id'],'companyId':_0x3b9959[_0x24357a(0x348)]}),console['trace'](_0x440a02[_0x24357a(0x1c8)]);if(_0x440a02[_0x24357a(0x1c8)][_0x24357a(0x264)]===0x0){const _0x438e1a=await Queue_1['default'][_0x24357a(0x1ec)](_0x440a02['id']),{schedules:_0x2d5671}=_0x438e1a,_0x1aee72=(0x0,moment_1[_0x24357a(0x378)])(),_0x1abc5b=_0x1aee72['format'](_0x24357a(0x263))[_0x24357a(0x1cf)]();let _0x9c720a;Array[_0x24357a(0x2e4)](_0x2d5671)&&_0x2d5671[_0x24357a(0x264)]>0x0&&(_0x9c720a=_0x2d5671[_0x24357a(0x36b)](_0x1a29c6=>_0x1a29c6[_0x24357a(0x2ed)]===_0x1abc5b&&_0x1a29c6[_0x24357a(0x2de)]!==''&&_0x1a29c6[_0x24357a(0x2de)]!==null&&_0x1a29c6[_0x24357a(0x329)]!==''&&_0x1a29c6[_0x24357a(0x329)]!==null));if(_0x438e1a['outOfHoursMessage']!==null&&_0x438e1a['outOfHoursMessage']!==''&&!(0x0,lodash_1[_0x24357a(0x33a)])(_0x9c720a)){var _0x506f7c=outOfHourMessageControl[_0x24357a(0x36b)](_0x3b5934=>_0x3b5934[_0x24357a(0x2c7)]===_0x3b9959['id']||_0x3b5934[_0x24357a(0x37e)]===_0x5669f3[_0x24357a(0x1f4)]);if(!_0x506f7c||_0x506f7c&&_0x506f7c[_0x24357a(0x25f)]+0x3e8*0x3c*0x5<new Date()[_0x24357a(0x273)]()){_0x506f7c&&(outOfHourMessageControl=outOfHourMessageControl['filter'](_0x4660b7=>_0x4660b7[_0x24357a(0x2c7)]!==_0x3b9959['id']),_0x506f7c=null);const _0x575fbc=(0x0,moment_1[_0x24357a(0x378)])(_0x9c720a[_0x24357a(0x2de)],_0x24357a(0x334)),_0x1c007d=(0x0,moment_1[_0x24357a(0x378)])(_0x9c720a['endTime'],_0x24357a(0x334));outOfHourMessageControl[_0x24357a(0x2e6)]({'ticketId':_0x3b9959['id'],'time':new Date()['getTime']()});if(_0x1aee72[_0x24357a(0x35b)](_0x575fbc)||_0x1aee72[_0x24357a(0x37d)](_0x1c007d)){const _0xe88aa0=(0x0,Mustache_1[_0x24357a(0x378)])('‎\x20'+_0x438e1a[_0x24357a(0x31f)]+_0x24357a(0x2ff),_0x3b9959),_0xaeb753=await _0x3af162[_0x24357a(0x314)](_0x5669f3[_0x24357a(0x1f4)]+'@'+(_0x3b9959[_0x24357a(0x319)]?_0x24357a(0x205):'s.whatsapp.net'),{'text':_0xe88aa0});await(0x0,exports[_0x24357a(0x374)])(_0xaeb753,_0x3b9959,_0x5669f3),await(0x0,UpdateTicketService_1['default'])({'ticketData':{'queueId':null,'chatbot':_0x10f78d},'ticketId':_0x3b9959['id'],'companyId':_0x3b9959[_0x24357a(0x348)]}),console[_0x24357a(0x241)](_0x24357a(0x2a5));return;}}!_0x506f7c&&outOfHourMessageControl[_0x24357a(0x2e6)]({'ticketId':_0x3b9959['id'],'dest':_0x5669f3['number'],'time':new Date()[_0x24357a(0x273)]()});}console['trace'](_0x440a02[_0x24357a(0x2d5)]);if(!_0x2abd0f['key'][_0x24357a(0x33d)]&&!_0x3b9959[_0x24357a(0x319)]&&_0x440a02[_0x24357a(0x2d5)]){const _0x4416dd=await(0x0,ShowQueueIntegrationService_1[_0x24357a(0x378)])(_0x440a02[_0x24357a(0x2d5)],_0x39cf34);await(0x0,exports[_0x24357a(0x342)])(_0x2abd0f,_0x3af162,_0x4416dd,_0x3b9959),await _0x3b9959[_0x24357a(0x36a)]({'useIntegration':!![],'integrationId':_0x4416dd['id']});}!_0x2abd0f[_0x24357a(0x239)][_0x24357a(0x33d)]&&!_0x3b9959['isGroup']&&!(0x0,lodash_1['isNil'])(_0x440a02?.[_0x24357a(0x328)])&&(await handleOpenAi(_0x2abd0f,_0x3af162,_0x3b9959,_0x5669f3,_0x4d3c48),await _0x3b9959[_0x24357a(0x36a)]({'useIntegration':!![],'promptId':_0x440a02?.[_0x24357a(0x328)]}));const _0x29d090=(0x0,Mustache_1[_0x24357a(0x378)])('‎'+_0x440a02[_0x24357a(0x26b)],_0x3b9959);if(_0x440a02[_0x24357a(0x26b)]){const _0x412800=await _0x3af162[_0x24357a(0x314)](_0x5669f3[_0x24357a(0x1f4)]+'@'+(_0x3b9959[_0x24357a(0x319)]?_0x24357a(0x205):_0x24357a(0x352)),{'text':_0x29d090});await(0x0,exports[_0x24357a(0x374)])(_0x412800,_0x3b9959,_0x5669f3);if(_0x440a02['mediaPath']!==null&&_0x440a02[_0x24357a(0x22d)]!==''){const _0x4097ef=path_1[_0x24357a(0x378)][_0x24357a(0x1df)](_0x24357a(0x249),_0x24357a(0x2bf)+_0x440a02[_0x24357a(0x348)],_0x440a02['mediaPath']),_0x496c84=await(0x0,SendWhatsAppMedia_1['getMessageOptions'])(_0x440a02[_0x24357a(0x276)],_0x4097ef,null,_0x3b9959[_0x24357a(0x348)]);let _0x164c56=await _0x3af162[_0x24357a(0x314)](_0x3b9959[_0x24357a(0x244)][_0x24357a(0x1f4)]+'@'+(_0x3b9959[_0x24357a(0x319)]?'g.us':'s.whatsapp.net'),{..._0x496c84});await verifyMediaMessage(_0x164c56,_0x3b9959,_0x5669f3);}}}}else{if(_0x2bd6e7&&_0x2bd6e7!==0x0&&_0x3b9959[_0x24357a(0x24b)]>=_0x2bd6e7)return;const _0x14f49b=await(0x0,FindOrCreateATicketTrakingService_1['default'])({'ticketId':_0x3b9959['id'],'companyId':_0x39cf34});let _0xbd836c=new Date(),_0xd86938=new Date();if(_0x14f49b['chatbotAt']!==null){_0xbd836c[_0x24357a(0x34f)](_0x14f49b[_0x24357a(0x321)][_0x24357a(0x313)]()+Number(_0x43f560));if(_0x14f49b[_0x24357a(0x321)]!==null&&_0xd86938<_0xbd836c&&_0x43f560!=='0'&&_0x3b9959[_0x24357a(0x24b)]!==0x0)return;}await _0x14f49b[_0x24357a(0x36a)]({'updatedAt':new Date()});if(_0x52e5c1[_0x24357a(0x20b)]===_0x24357a(0x35f))return console[_0x24357a(0x365)](_0x24357a(0x359)),_0x28e9ba();}},verifyRating=_0x322feb=>{const _0x408dbe=a558_0x1e95a7;return _0x322feb&&_0x322feb['finishedAt']===null&&_0x322feb[_0x408dbe(0x1eb)]!==null&&_0x322feb[_0x408dbe(0x1d3)]!==null;};exports[a558_0x1e95a7(0x1f8)]=verifyRating;const handleRating=async(_0x1fd248,_0x3794e6,_0x3d23aa)=>{const _0xfb5292=a558_0x1e95a7,_0x45f06e=(0x0,socket_1[_0xfb5292(0x1e2)])();let _0x2ca1d1=null;(_0x1fd248?.[_0xfb5292(0x2c3)]?.[_0xfb5292(0x284)]||_0x1fd248?.[_0xfb5292(0x2c3)]?.[_0xfb5292(0x216)])&&(_0x2ca1d1=parseInt(_0x1fd248['message'][_0xfb5292(0x284)]||_0x1fd248['message'][_0xfb5292(0x216)][_0xfb5292(0x35f)],0xa)||null);if(!Number[_0xfb5292(0x204)](_0x2ca1d1)&&Number[_0xfb5292(0x294)](_0x2ca1d1)&&!(0x0,lodash_1[_0xfb5292(0x2f3)])(_0x2ca1d1)){const {complationMessage:_0x4aa0fe}=await(0x0,ShowWhatsAppService_1[_0xfb5292(0x378)])(_0x3794e6['whatsappId'],_0x3794e6['companyId']);let _0x1c85aa=_0x2ca1d1;_0x2ca1d1<0x1&&(_0x1c85aa=0x1);_0x2ca1d1>0x5&&(_0x1c85aa=0x5);await UserRating_1[_0xfb5292(0x378)][_0xfb5292(0x202)]({'ticketId':_0x3d23aa[_0xfb5292(0x2c7)],'companyId':_0x3d23aa[_0xfb5292(0x348)],'userId':_0x3d23aa[_0xfb5292(0x1eb)],'rate':_0x1c85aa});if(_0x4aa0fe){if(completionMessageControl[_0xfb5292(0x264)]>=0x9c4)completionMessageControl=[];var _0x56395e=completionMessageControl[_0xfb5292(0x36b)](_0x2dd22e=>_0x2dd22e[_0xfb5292(0x2c7)]===_0x3794e6['id']||_0x2dd22e[_0xfb5292(0x37e)]===_0x3794e6[_0xfb5292(0x244)][_0xfb5292(0x1f4)]);if(!_0x56395e||_0x56395e&&_0x56395e[_0xfb5292(0x25f)]+0x3e8*0x3c*0x1e<new Date()[_0xfb5292(0x273)]()){_0x56395e&&(completionMessageControl=completionMessageControl['filter'](_0x100348=>_0x100348[_0xfb5292(0x2c7)]!==_0x3794e6['id']),_0x56395e=null);const _0x57e865=(0x0,Mustache_1['default'])('‎'+_0x4aa0fe,_0x3794e6);await(0x0,SendPresenceStatus_1[_0xfb5292(0x279)])((0x0,wbot_1[_0xfb5292(0x324)])(_0x3794e6['whatsappId']),_0x3794e6[_0xfb5292(0x244)]['number']+'@'+(_0x3794e6[_0xfb5292(0x319)]?'g.us':_0xfb5292(0x352))),await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x57e865,'ticket':_0x3794e6});}!_0x56395e&&completionMessageControl['push']({'ticketId':_0x3794e6['id'],'dest':_0x3794e6[_0xfb5292(0x244)]['number'],'time':new Date()[_0xfb5292(0x273)]()});}await _0x3d23aa[_0xfb5292(0x36a)]({'finishedAt':(0x0,moment_1[_0xfb5292(0x378)])()[_0xfb5292(0x2f5)](),'ratedAt':(0x0,moment_1[_0xfb5292(0x378)])()['toDate'](),'rated':!![]}),await _0x3794e6[_0xfb5292(0x36a)]({'queueId':null,'chatbot':null,'queueOptionId':null,'userId':null,'status':'closed'}),_0x45f06e['to'](_0xfb5292(0x297)+_0x3794e6[_0xfb5292(0x348)]+'-open')[_0xfb5292(0x20d)](_0xfb5292(0x297)+_0x3794e6[_0xfb5292(0x348)]+_0xfb5292(0x226),{'action':_0xfb5292(0x277),'ticket':_0x3794e6,'ticketId':_0x3794e6['id']}),_0x45f06e['to'](_0xfb5292(0x297)+_0x3794e6[_0xfb5292(0x348)]+'-'+_0x3794e6[_0xfb5292(0x246)])['to'](_0x3794e6['id'][_0xfb5292(0x2b2)]())[_0xfb5292(0x20d)](_0xfb5292(0x297)+_0x3794e6[_0xfb5292(0x348)]+_0xfb5292(0x226),{'action':_0xfb5292(0x36a),'ticket':_0x3794e6,'ticketId':_0x3794e6['id']});}};exports[a558_0x1e95a7(0x1e8)]=handleRating;const handleChartbot=async(_0x43ddcc,_0x5487fa,_0x532b1c,_0x807535,_0x1abf74=![])=>{const _0x189999=a558_0x1e95a7;if(!_0x43ddcc[_0x189999(0x244)][_0x189999(0x2b8)]){const _0x14fd07=await Queue_1[_0x189999(0x378)][_0x189999(0x1ec)](_0x43ddcc[_0x189999(0x272)],{'include':[{'model':QueueOption_1[_0x189999(0x378)],'as':_0x189999(0x1c8),'where':{'parentId':null},'order':[[_0x189999(0x310),_0x189999(0x2a4)],[_0x189999(0x2d9),_0x189999(0x2a4)]]}]}),_0x5a672b=_0x5487fa?.[_0x189999(0x2c3)]?.[_0x189999(0x224)]?.[_0x189999(0x37b)]||_0x5487fa?.[_0x189999(0x2c3)]?.[_0x189999(0x1ff)]?.[_0x189999(0x383)]?.[_0x189999(0x261)]||_0x5487fa?.[_0x189999(0x2c3)]?.[_0x189999(0x216)]?.[_0x189999(0x35f)]||_0x5487fa?.[_0x189999(0x2c3)]?.[_0x189999(0x284)];if(_0x5a672b=='#'&&(!_0x43ddcc['userId']||_0x43ddcc[_0x189999(0x246)]==_0x189999(0x1bb))){console[_0x189999(0x365)](_0x189999(0x38c)),await _0x43ddcc[_0x189999(0x36a)]({'queueOptionId':null,'chatbot':![],'queueId':null,'amountUsedBotQueues':0x0}),await verifyQueue(_0x532b1c,_0x5487fa,_0x43ddcc,_0x43ddcc[_0x189999(0x244)]);return;}if(!(0x0,lodash_1[_0x189999(0x33a)])(_0x14fd07)&&!(0x0,lodash_1['isNil'])(_0x43ddcc[_0x189999(0x1c2)])&&_0x5a672b=='0'){console[_0x189999(0x365)](_0x189999(0x268));const _0x61d0db=await QueueOption_1[_0x189999(0x378)][_0x189999(0x1ec)](_0x43ddcc[_0x189999(0x1c2)]);await _0x43ddcc[_0x189999(0x36a)]({'queueOptionId':_0x61d0db?.[_0x189999(0x21d)],'amountUsedBotQueues':0x0});}else{if(!(0x0,lodash_1['isNil'])(_0x14fd07)&&!(0x0,lodash_1[_0x189999(0x33a)])(_0x43ddcc['queueOptionId'])){console[_0x189999(0x365)](_0x189999(0x2fb));const _0x39228b=await QueueOption_1[_0x189999(0x378)]['count']({'where':{'parentId':_0x43ddcc[_0x189999(0x1c2)]}});let _0x489fe3={};_0x39228b==0x1?_0x489fe3=await QueueOption_1[_0x189999(0x378)][_0x189999(0x353)]({'where':{'parentId':_0x43ddcc[_0x189999(0x1c2)]}}):(console[_0x189999(0x365)](_0x189999(0x1e1)),_0x489fe3=await QueueOption_1['default'][_0x189999(0x353)]({'where':{[sequelize_1['Op']['or']]:[{'option':_0x5a672b||''},{'title':_0x5a672b||''}],'parentId':_0x43ddcc['queueOptionId']}})),_0x489fe3&&await _0x43ddcc['update']({'queueOptionId':_0x489fe3?.['id'],'amountUsedBotQueues':0x0});}else{if(!(0x0,lodash_1[_0x189999(0x33a)])(_0x14fd07)&&(0x0,lodash_1['isNil'])(_0x43ddcc[_0x189999(0x1c2)])&&!_0x1abf74){console[_0x189999(0x365)](_0x189999(0x208));const _0x182f8f=_0x14fd07?.['options'][_0x189999(0x36b)](_0x378a0a=>_0x378a0a[_0x189999(0x310)]==_0x5a672b||_0x378a0a[_0x189999(0x316)][_0x189999(0x1cf)]()==_0x5a672b[_0x189999(0x1cf)]());if(_0x182f8f)await _0x43ddcc[_0x189999(0x36a)]({'queueOptionId':_0x182f8f?.['id'],'amountUsedBotQueues':0x0});else{if(_0x807535[_0x189999(0x1e4)]&&_0x807535[_0x189999(0x1e4)]!==0x0&&_0x43ddcc[_0x189999(0x24b)]>=_0x807535[_0x189999(0x1e4)])return;await _0x43ddcc[_0x189999(0x36a)]({'amountUsedBotQueues':_0x43ddcc['amountUsedBotQueues']+0x1});}}else{if(_0x807535['maxUseBotQueues']&&_0x807535[_0x189999(0x1e4)]!==0x0&&_0x43ddcc[_0x189999(0x24b)]>=_0x807535[_0x189999(0x1e4)])return;await _0x43ddcc[_0x189999(0x36a)]({'amountUsedBotQueues':_0x43ddcc[_0x189999(0x24b)]+0x1});}}}await _0x43ddcc[_0x189999(0x1c0)]();if(!(0x0,lodash_1[_0x189999(0x33a)])(_0x14fd07)&&(0x0,lodash_1[_0x189999(0x33a)])(_0x43ddcc[_0x189999(0x1c2)])){const _0x3a85ae=await QueueOption_1[_0x189999(0x378)][_0x189999(0x2fc)]({'where':{'queueId':_0x43ddcc[_0x189999(0x272)],'parentId':null},'order':[[_0x189999(0x310),_0x189999(0x2a4)],[_0x189999(0x2d9),_0x189999(0x2a4)]]}),_0x2f4648=_0x43ddcc[_0x189999(0x348)],_0x4b0594=await Setting_1['default'][_0x189999(0x353)]({'where':{'key':'chatBotType','companyId':_0x2f4648}}),_0x46bd3b=async()=>{const _0x2817ad=_0x189999,_0x1da2bb=[];_0x3a85ae[_0x2817ad(0x2af)]((_0x124091,_0x2e24f2)=>{const _0x1a8fc3=_0x2817ad;_0x1da2bb[_0x1a8fc3(0x2e6)]({'buttonId':''+_0x124091['option'],'buttonText':{'displayText':_0x124091['title']},'type':0x4});}),_0x1da2bb['push']({'buttonId':'#','buttonText':{'displayText':_0x2817ad(0x247)},'type':0x4});const _0x487f79={'text':(0x0,Mustache_1[_0x2817ad(0x378)])('‎'+_0x14fd07[_0x2817ad(0x26b)],_0x43ddcc),'buttons':_0x1da2bb,'footer':_0x2817ad(0x2b9),'headerType':0x1},_0x299d0b=await _0x532b1c['sendMessage'](_0x43ddcc[_0x2817ad(0x244)][_0x2817ad(0x1f4)]+'@'+(_0x43ddcc['isGroup']?_0x2817ad(0x205):_0x2817ad(0x352)),_0x487f79);await(0x0,exports[_0x2817ad(0x374)])(_0x299d0b,_0x43ddcc,_0x43ddcc['contact']);},_0x1378c2=async()=>{const _0x183959=_0x189999;let _0xfbf4c0='';console[_0x183959(0x365)](_0x183959(0x359)),console['log'](_0x14fd07['mediaPath']),_0x3a85ae[_0x183959(0x2af)]((_0x3053d4,_0x47e251)=>{const _0x499124=_0x183959;_0xfbf4c0+=_0x499124(0x34c)+_0x3053d4[_0x499124(0x310)]+_0x499124(0x299)+_0x3053d4[_0x499124(0x316)]+'\x0a';}),_0xfbf4c0+=_0x183959(0x1f6);const _0x37c565={'text':(0x0,Mustache_1['default'])('‎'+_0x14fd07[_0x183959(0x26b)]+'\x0a\x0a'+_0xfbf4c0,_0x43ddcc)};let _0x5c4f84;if(!_0x14fd07[_0x183959(0x22d)])_0x5c4f84=await _0x532b1c[_0x183959(0x314)](_0x43ddcc[_0x183959(0x244)][_0x183959(0x1f4)]+'@'+(_0x43ddcc[_0x183959(0x319)]?'g.us':_0x183959(0x352)),_0x37c565),await(0x0,exports[_0x183959(0x374)])(_0x5c4f84,_0x43ddcc,_0x43ddcc[_0x183959(0x244)]);else{const _0x458706=path_1[_0x183959(0x378)]['resolve'](_0x183959(0x249),'company'+_0x43ddcc['companyId'],_0x14fd07[_0x183959(0x22d)]),_0x552e44=await(0x0,SendWhatsAppMedia_1[_0x183959(0x21f)])(_0x37c565[_0x183959(0x35f)],_0x458706,_0x37c565[_0x183959(0x35f)],_0x43ddcc[_0x183959(0x348)]);_0x5c4f84=await _0x532b1c[_0x183959(0x314)](_0x43ddcc[_0x183959(0x244)][_0x183959(0x1f4)]+'@'+(_0x43ddcc[_0x183959(0x319)]?_0x183959(0x205):_0x183959(0x352)),{..._0x552e44}),await verifyMediaMessage(_0x5c4f84,_0x43ddcc,_0x43ddcc['contact']);}};if(_0x4b0594[_0x189999(0x20b)]===_0x189999(0x217)&&QueueOption_1[_0x189999(0x378)][_0x189999(0x264)]<=0x4)return _0x46bd3b();if(_0x4b0594[_0x189999(0x20b)]===_0x189999(0x35f))return console[_0x189999(0x365)](_0x189999(0x359)),_0x1378c2();if(_0x4b0594[_0x189999(0x20b)]===_0x189999(0x217)&&QueueOption_1[_0x189999(0x378)][_0x189999(0x264)]>0x4)return console['trace'](_0x189999(0x359)),_0x1378c2();}else{if(!(0x0,lodash_1[_0x189999(0x33a)])(_0x14fd07)&&!(0x0,lodash_1['isNil'])(_0x43ddcc[_0x189999(0x1c2)])){const _0x5a43ea=await QueueOption_1['default'][_0x189999(0x1ec)](_0x43ddcc[_0x189999(0x1c2)]),_0x54f2fe=await QueueOption_1[_0x189999(0x378)][_0x189999(0x2fc)]({'where':{'parentId':_0x43ddcc[_0x189999(0x1c2)]},'order':[[_0x189999(0x310),_0x189999(0x2a4)],['createdAt','ASC']]});if(_0x54f2fe[_0x189999(0x264)]===0x0){const _0x3a1615={'text':(0x0,Mustache_1[_0x189999(0x378)])('‎'+_0x5a43ea['message'],_0x43ddcc)},_0x7d4d21=await _0x532b1c[_0x189999(0x314)](_0x43ddcc[_0x189999(0x244)][_0x189999(0x1f4)]+'@'+(_0x43ddcc['isGroup']?_0x189999(0x205):_0x189999(0x352)),_0x3a1615);await(0x0,exports['verifyMessage'])(_0x7d4d21,_0x43ddcc,_0x43ddcc[_0x189999(0x244)]),await _0x43ddcc[_0x189999(0x36a)]({'queueOptionId':null,'chatbot':![]});return;}if(_0x54f2fe['length']>-0x1){const _0x62304=_0x43ddcc[_0x189999(0x348)],_0x4dc08e=await Setting_1['default'][_0x189999(0x353)]({'where':{'key':_0x189999(0x2f0),'companyId':_0x62304}}),_0x28bf1a=async()=>{const _0x314a28=_0x189999,_0x57f114=[],_0x559393=_0x43ddcc[_0x314a28(0x348)],_0x229bf9=await getQueues(_0x559393),_0x14e1f7=await getContactFromTicket(_0x43ddcc['id']);_0x229bf9[_0x314a28(0x2af)]((_0x2949c9,_0x3b1e53)=>{const _0xc519e4=_0x314a28;_0x57f114[_0xc519e4(0x2e6)]({'title':'['+(_0x3b1e53+0x1)+_0xc519e4(0x25b)+_0x2949c9[_0xc519e4(0x33c)],'rowId':''+(_0x3b1e53+0x1)});});const _0x47ba8a=[{'rows':_0x57f114}],_0x5a2b36={'text':(0x0,Mustache_1[_0x314a28(0x378)])('‎'+_0x5a43ea[_0x314a28(0x2c3)],_0x43ddcc),'title':_0x314a28(0x358),'buttonText':_0x314a28(0x1e0),'sections':_0x47ba8a};await sleep(0x3e8);const _0x1eddf0=await _0x532b1c[_0x314a28(0x314)](_0x314a28(0x2ba)+_0x14e1f7[_0x314a28(0x1f4)]+'@'+(_0x43ddcc[_0x314a28(0x319)]?_0x314a28(0x205):_0x314a28(0x352)),_0x5a2b36);await(0x0,exports[_0x314a28(0x374)])(_0x1eddf0,_0x43ddcc,_0x43ddcc[_0x314a28(0x244)]);},_0x529b8b=async()=>{const _0x58d247=_0x189999,_0x2130d1=[];_0x54f2fe[_0x58d247(0x2af)]((_0x4fe1bb,_0x3b3a83)=>{const _0x23aedc=_0x58d247;_0x2130d1[_0x23aedc(0x2e6)]({'buttonId':''+_0x4fe1bb[_0x23aedc(0x310)],'buttonText':{'displayText':_0x4fe1bb['title']},'type':0x4});}),_0x2130d1[_0x58d247(0x2e6)]({'buttonId':'#','buttonText':{'displayText':'Menu\x20inicial\x20*[\x200\x20]*\x20Menu\x20anterior'},'type':0x4});const _0x2069ef={'text':(0x0,Mustache_1[_0x58d247(0x378)])('‎'+_0x5a43ea[_0x58d247(0x2c3)],_0x43ddcc),'buttons':_0x2130d1,'headerType':0x4};if(process[_0x58d247(0x219)]['CHATBOT_RESTRICT_NUMBER']?.['length']>=0x8){if(_0x43ddcc[_0x58d247(0x244)]['number']!=process[_0x58d247(0x219)][_0x58d247(0x2c5)]){console['trace'](_0x58d247(0x221));return;}}if(!_0x5a43ea[_0x58d247(0x22d)]){const _0x18f65d=await _0x532b1c[_0x58d247(0x314)](_0x43ddcc['contact'][_0x58d247(0x1f4)]+'@'+(_0x43ddcc[_0x58d247(0x319)]?_0x58d247(0x205):_0x58d247(0x352)),_0x2069ef);await(0x0,exports['verifyMessage'])(_0x18f65d,_0x43ddcc,_0x43ddcc[_0x58d247(0x244)]);}else{const _0x4c2482=path_1[_0x58d247(0x378)][_0x58d247(0x1df)]('public',_0x58d247(0x2bf)+_0x43ddcc[_0x58d247(0x348)],_0x5a43ea['mediaPath']),_0xfcfef3=await(0x0,SendWhatsAppMedia_1[_0x58d247(0x21f)])(_0x5a43ea[_0x58d247(0x276)],_0x4c2482,_0x2069ef['text'],_0x43ddcc[_0x58d247(0x348)]);let _0x3b1f55=await _0x532b1c['sendMessage'](_0x43ddcc['contact']['number']+'@'+(_0x43ddcc['isGroup']?'g.us':_0x58d247(0x352)),{..._0xfcfef3});await verifyMediaMessage(_0x3b1f55,_0x43ddcc,_0x43ddcc[_0x58d247(0x244)]);}const _0x49f746=await _0x532b1c['sendMessage'](_0x43ddcc['contact'][_0x58d247(0x1f4)]+'@'+(_0x43ddcc['isGroup']?_0x58d247(0x205):_0x58d247(0x352)),_0x2069ef);await(0x0,exports[_0x58d247(0x374)])(_0x49f746,_0x43ddcc,_0x43ddcc[_0x58d247(0x244)]);},_0x47ed5b=async()=>{const _0x1eb462=_0x189999;let _0x3d42e0='';_0x54f2fe['forEach']((_0xbe1bfb,_0x323a9e)=>{const _0xf8e6e3=a558_0x2d96;_0x3d42e0+=_0xf8e6e3(0x34c)+_0xbe1bfb[_0xf8e6e3(0x310)]+_0xf8e6e3(0x299)+_0xbe1bfb[_0xf8e6e3(0x316)]+'\x0a';}),_0x3d42e0+=_0x1eb462(0x2d3),_0x3d42e0+=_0x1eb462(0x1f6);const _0x7e649={'text':(0x0,Mustache_1[_0x1eb462(0x378)])('‎'+_0x5a43ea[_0x1eb462(0x2c3)]+'\x0a\x0a'+_0x3d42e0,_0x43ddcc)};if(process[_0x1eb462(0x219)][_0x1eb462(0x2c5)]?.[_0x1eb462(0x264)]>=0x8){if(_0x43ddcc[_0x1eb462(0x244)]['number']!=process[_0x1eb462(0x219)][_0x1eb462(0x2c5)]){console[_0x1eb462(0x365)](_0x1eb462(0x221));return;}}if(!_0x5a43ea['mediaPath']){const _0x92c649=await _0x532b1c['sendMessage'](_0x43ddcc['contact']['number']+'@'+(_0x43ddcc[_0x1eb462(0x319)]?_0x1eb462(0x205):_0x1eb462(0x352)),_0x7e649);await(0x0,exports[_0x1eb462(0x374)])(_0x92c649,_0x43ddcc,_0x43ddcc['contact']);}else{const _0x286948=path_1[_0x1eb462(0x378)][_0x1eb462(0x1df)](_0x1eb462(0x249),'company'+_0x43ddcc[_0x1eb462(0x348)],_0x5a43ea[_0x1eb462(0x22d)]),_0x506434=await(0x0,SendWhatsAppMedia_1[_0x1eb462(0x21f)])(_0x5a43ea[_0x1eb462(0x276)],_0x286948,_0x7e649[_0x1eb462(0x35f)],_0x43ddcc[_0x1eb462(0x348)]);let _0x4e347e=await _0x532b1c[_0x1eb462(0x314)](_0x43ddcc[_0x1eb462(0x244)][_0x1eb462(0x1f4)]+'@'+(_0x43ddcc[_0x1eb462(0x319)]?'g.us':_0x1eb462(0x352)),{..._0x506434});await verifyMediaMessage(_0x4e347e,_0x43ddcc,_0x43ddcc[_0x1eb462(0x244)]);}};if(_0x4dc08e[_0x189999(0x20b)]===_0x189999(0x25a))return _0x28bf1a();if(_0x4dc08e['value']==='button'&&QueueOption_1['default'][_0x189999(0x264)]<=0x4)return _0x529b8b();if(_0x4dc08e[_0x189999(0x20b)]==='text')return console[_0x189999(0x365)](_0x189999(0x23b)),_0x47ed5b();if(_0x4dc08e[_0x189999(0x20b)]==='button'&&QueueOption_1[_0x189999(0x378)][_0x189999(0x264)]>0x4)return console[_0x189999(0x365)](_0x189999(0x24c)),_0x47ed5b();}}}}},handleMessageIntegration=async(_0x21cbb6,_0x382bc3,_0x2e3ad4,_0x1da2cf)=>{const _0xdb15cc=a558_0x1e95a7;if(process[_0xdb15cc(0x219)][_0xdb15cc(0x2c5)]){if(_0x1da2cf[_0xdb15cc(0x244)]['number']!=process[_0xdb15cc(0x219)][_0xdb15cc(0x2c5)]){console['log'](_0xdb15cc(0x221));return;}}const _0x3516d4=getTypeMessage(_0x21cbb6);if(_0x2e3ad4['type']===_0xdb15cc(0x223)||_0x2e3ad4[_0xdb15cc(0x283)]===_0xdb15cc(0x28b)){if(_0x2e3ad4?.[_0xdb15cc(0x34b)]){const _0x158b9d={'method':_0xdb15cc(0x289),'url':_0x2e3ad4?.[_0xdb15cc(0x34b)],'headers':{'Content-Type':_0xdb15cc(0x34e)},'json':_0x21cbb6};try{(0x0,request_1[_0xdb15cc(0x378)])(_0x158b9d,function(_0x2c28d0,_0x3d6336){const _0x1a7452=_0xdb15cc;if(_0x2c28d0)throw new Error(_0x2c28d0);else console[_0x1a7452(0x241)](_0x3d6336['body']);});}catch(_0x574c76){throw new Error(_0x574c76);}}}else _0x2e3ad4['type']===_0xdb15cc(0x212)&&await(0x0,typebotListener_1[_0xdb15cc(0x378)])({'ticket':_0x1da2cf,'msg':_0x21cbb6,'wbot':_0x382bc3,'typebot':_0x2e3ad4});};exports[a558_0x1e95a7(0x342)]=handleMessageIntegration;const messageContainsMedia=_0x37cf40=>{const _0x1b998e=a558_0x1e95a7;return _0x37cf40[_0x1b998e(0x2c3)]?.[_0x1b998e(0x1fe)]||_0x37cf40[_0x1b998e(0x2c3)]?.[_0x1b998e(0x1e3)]||_0x37cf40[_0x1b998e(0x2c3)]?.[_0x1b998e(0x24f)]||_0x37cf40[_0x1b998e(0x2c3)]?.[_0x1b998e(0x33e)]||_0x37cf40[_0x1b998e(0x2c3)]?.[_0x1b998e(0x1d9)]||_0x37cf40[_0x1b998e(0x2c3)]?.[_0x1b998e(0x331)]?.[_0x1b998e(0x2c3)]?.[_0x1b998e(0x1d9)]||_0x37cf40[_0x1b998e(0x2c3)]?.[_0x1b998e(0x2b0)]?.[_0x1b998e(0x2c3)]?.[_0x1b998e(0x1e3)]||_0x37cf40['message']?.[_0x1b998e(0x2b0)]?.[_0x1b998e(0x2c3)]?.[_0x1b998e(0x1d9)]||_0x37cf40[_0x1b998e(0x2c3)]?.[_0x1b998e(0x2b0)]?.['message']?.[_0x1b998e(0x24f)]||_0x37cf40[_0x1b998e(0x2c3)]?.[_0x1b998e(0x2b0)]?.[_0x1b998e(0x2c3)]?.[_0x1b998e(0x33e)]||_0x37cf40[_0x1b998e(0x2c3)]?.[_0x1b998e(0x2b0)]?.['message']?.[_0x1b998e(0x1fe)]||_0x37cf40[_0x1b998e(0x2c3)]?.[_0x1b998e(0x2aa)]?.[_0x1b998e(0x2c3)]?.[_0x1b998e(0x1fe)]||_0x37cf40['message']?.[_0x1b998e(0x2aa)]?.[_0x1b998e(0x2c3)]?.[_0x1b998e(0x24f)]||_0x37cf40[_0x1b998e(0x2c3)]?.[_0x1b998e(0x2b0)]?.[_0x1b998e(0x2c3)]?.[_0x1b998e(0x2aa)]?.[_0x1b998e(0x2c3)]?.['imageMessage']||_0x37cf40[_0x1b998e(0x2c3)]?.[_0x1b998e(0x2b0)]?.[_0x1b998e(0x2c3)]?.[_0x1b998e(0x2aa)]?.['message']?.['videoMessage']||_0x37cf40[_0x1b998e(0x2c3)]?.[_0x1b998e(0x2b0)]?.[_0x1b998e(0x2c3)]?.['viewOnceMessage']?.['message']?.[_0x1b998e(0x1e3)]||_0x37cf40[_0x1b998e(0x2c3)]?.[_0x1b998e(0x2b0)]?.[_0x1b998e(0x2c3)]?.['viewOnceMessage']?.[_0x1b998e(0x2c3)]?.[_0x1b998e(0x1d9)]||_0x37cf40['message']?.['documentWithCaptionMessage']?.[_0x1b998e(0x2c3)]?.[_0x1b998e(0x1d9)]||_0x37cf40[_0x1b998e(0x2c3)]?.['templateMessage']?.[_0x1b998e(0x1c9)]?.[_0x1b998e(0x1fe)]||_0x37cf40[_0x1b998e(0x2c3)]?.[_0x1b998e(0x2ef)]?.[_0x1b998e(0x1c9)]?.[_0x1b998e(0x1d9)]||_0x37cf40[_0x1b998e(0x2c3)]?.[_0x1b998e(0x2ef)]?.[_0x1b998e(0x1c9)]?.[_0x1b998e(0x24f)]||_0x37cf40['message']?.[_0x1b998e(0x2ef)]?.[_0x1b998e(0x381)]?.[_0x1b998e(0x1fe)]||_0x37cf40[_0x1b998e(0x2c3)]?.['templateMessage']?.[_0x1b998e(0x381)]?.['documentMessage']||_0x37cf40[_0x1b998e(0x2c3)]?.[_0x1b998e(0x2ef)]?.[_0x1b998e(0x381)]?.[_0x1b998e(0x24f)]||_0x37cf40[_0x1b998e(0x2c3)]?.[_0x1b998e(0x2ef)]?.[_0x1b998e(0x2dd)]?.[_0x1b998e(0x1fe)]||_0x37cf40[_0x1b998e(0x2c3)]?.[_0x1b998e(0x2ef)]?.[_0x1b998e(0x2dd)]?.[_0x1b998e(0x1d9)]||_0x37cf40[_0x1b998e(0x2c3)]?.[_0x1b998e(0x2ef)]?.['fourRowTemplate']?.[_0x1b998e(0x24f)]||_0x37cf40[_0x1b998e(0x2c3)]?.[_0x1b998e(0x2d8)]?.['header']?.[_0x1b998e(0x1fe)]||_0x37cf40[_0x1b998e(0x2c3)]?.[_0x1b998e(0x2d8)]?.['header']?.['documentMessage']||_0x37cf40[_0x1b998e(0x2c3)]?.[_0x1b998e(0x2d8)]?.[_0x1b998e(0x23d)]?.['videoMessage']||_0x37cf40[_0x1b998e(0x2c3)]?.[_0x1b998e(0x36d)]?.[_0x1b998e(0x2e2)]?.['hydratedTemplate']?.[_0x1b998e(0x1d9)]||_0x37cf40['message']?.[_0x1b998e(0x36d)]?.['hydratedHsm']?.[_0x1b998e(0x1c9)]?.[_0x1b998e(0x24f)]||_0x37cf40[_0x1b998e(0x2c3)]?.['highlyStructuredMessage']?.[_0x1b998e(0x2e2)]?.[_0x1b998e(0x1c9)]?.[_0x1b998e(0x1fe)]||_0x37cf40[_0x1b998e(0x2c3)]?.[_0x1b998e(0x36d)]?.[_0x1b998e(0x2e2)]?.[_0x1b998e(0x1c9)]?.[_0x1b998e(0x2e3)];},handleMessage=async(_0x32604c,_0x3c9e32,_0x3b0925,_0x259345=![])=>{const _0x1da28b=a558_0x1e95a7;if(_0x259345){console[_0x1da28b(0x241)](_0x1da28b(0x210));let _0x58c6a3=_0x32604c['key']['id'],_0x5df968=await Message_1['default'][_0x1da28b(0x220)]({'where':{'id':_0x58c6a3}});if(_0x5df968>0x0){await new Promise(_0x407c91=>setTimeout(_0x407c91,0x96));return;}else await new Promise(_0x15a9a4=>setTimeout(_0x15a9a4,0x14a));}let _0x46feba;if(!(0x0,exports[_0x1da28b(0x230)])(_0x32604c)){console[_0x1da28b(0x241)](_0x1da28b(0x269)),console[_0x1da28b(0x241)](_0x32604c);return;}_0x32604c[_0x1da28b(0x2c3)]?.[_0x1da28b(0x2b0)]&&(_0x32604c[_0x1da28b(0x2c3)]=_0x32604c[_0x1da28b(0x2c3)][_0x1da28b(0x2b0)][_0x1da28b(0x2c3)]);try{let _0x3afd9c;const _0x556384=_0x32604c[_0x1da28b(0x239)][_0x1da28b(0x2d2)]?.[_0x1da28b(0x2e7)](_0x1da28b(0x31a)),_0x74f7ae=await Setting_1['default'][_0x1da28b(0x353)]({'where':{'companyId':_0x3b0925,'key':_0x1da28b(0x285)}});if(_0x74f7ae?.[_0x1da28b(0x20b)]===_0x1da28b(0x380)&&_0x556384){console[_0x1da28b(0x241)](_0x1da28b(0x271));return;}let _0x3caa3e=(0x0,exports[_0x1da28b(0x26a)])(_0x32604c);const _0x2ad900=getTypeMessage(_0x32604c);typeof _0x3caa3e===_0x1da28b(0x2ec)&&(_0x3caa3e=_0x3caa3e[_0x1da28b(0x300)](/\u200c/,''));const _0x516b9d=messageContainsMedia(_0x32604c);if(_0x32604c[_0x1da28b(0x239)][_0x1da28b(0x33d)]){if(!_0x516b9d&&_0x2ad900!=='conversation'&&_0x2ad900!=='extendedTextMessage'&&_0x2ad900!==_0x1da28b(0x228)&&_0x2ad900!==_0x1da28b(0x337)&&_0x2ad900!==_0x1da28b(0x2b0)&&_0x2ad900!=='protocolMessage'&&_0x2ad900!==_0x1da28b(0x288)&&_0x2ad900!=='viewOnceMessage'&&_0x2ad900!==_0x1da28b(0x2e3)&&_0x2ad900!==_0x1da28b(0x1dd)&&_0x2ad900!==_0x1da28b(0x354)){console[_0x1da28b(0x365)](_0x2ad900);return;}}const _0x16c25b=await(0x0,ShowWhatsAppService_1[_0x1da28b(0x378)])(_0x3c9e32['id'],_0x3b0925);let _0x2d1ebb,_0x36d35b=await getContactMessage(_0x32604c,_0x3c9e32);_0x3afd9c=await verifyContact(_0x36d35b,_0x3c9e32,_0x3b0925);if(_0x556384){if(!_0x16c25b[_0x1da28b(0x2b4)])return;try{const _0x16515e=await _0x3c9e32['groupMetadata'](_0x32604c[_0x1da28b(0x239)]['remoteJid']),_0x47119f={'id':_0x16515e['id'],'name':_0x16515e[_0x1da28b(0x37f)]};_0x2d1ebb=await verifyContact(_0x47119f,_0x3c9e32,_0x3b0925);}catch(_0x5b64b1){console[_0x1da28b(0x241)](_0x1da28b(0x315)),console['log'](_0x5b64b1);return;}}let _0x18e84c=0x0;if(_0x32604c[_0x1da28b(0x239)][_0x1da28b(0x33d)])await cache_1[_0x1da28b(0x31b)]['set']('contacts:'+_0x3afd9c['id']+':unreads','0');else{const _0x3b8999=await cache_1[_0x1da28b(0x31b)]['get'](_0x1da28b(0x243)+_0x3afd9c['id']+_0x1da28b(0x349));_0x18e84c=+_0x3b8999+0x1,await cache_1[_0x1da28b(0x31b)][_0x1da28b(0x28e)](_0x1da28b(0x243)+_0x3afd9c['id']+_0x1da28b(0x349),''+_0x18e84c);}const _0xc31eca=await(0x0,FindOrCreateTicketService_1['default'])(_0x3afd9c,_0x3c9e32['id'],_0x18e84c,_0x3b0925,_0x2d1ebb,_0x259345),_0x5b0bde=await(0x0,FindOrCreateATicketTrakingService_1[_0x1da28b(0x378)])({'ticketId':_0xc31eca['id'],'companyId':_0x3b0925,'whatsappId':_0x16c25b?.['id']});_0x5b0bde['changed'](_0x1da28b(0x1bd),!![]),await _0x5b0bde[_0x1da28b(0x36a)]({'updatedAt':new Date()}),await(0x0,providers_1['provider'])(_0xc31eca,_0x32604c,_0x3b0925,_0x3afd9c,_0x3c9e32);if(_0x16c25b[_0x1da28b(0x2d7)]&&_0x18e84c===0x0){const _0x1030d4=await Message_1[_0x1da28b(0x378)][_0x1da28b(0x353)]({'where':{'contactId':_0x3afd9c['id'],'companyId':_0x3b0925},'order':[[_0x1da28b(0x2d9),_0x1da28b(0x327)]]});if((0x0,Mustache_1[_0x1da28b(0x378)])(_0x16c25b['complationMessage'],_0xc31eca)[_0x1da28b(0x1e5)]()['toLowerCase']()===_0x1030d4?.['body'][_0x1da28b(0x1e5)]()[_0x1da28b(0x1cf)]())return;}if(_0x3caa3e=='#'&&!_0x259345&&(!_0xc31eca[_0x1da28b(0x1eb)]||_0xc31eca[_0x1da28b(0x246)]==_0x1da28b(0x1bb))){await _0xc31eca[_0x1da28b(0x36a)]({'queueOptionId':null,'chatbot':![],'queueId':null,'amountUsedBotQueues':0x0}),await verifyQueue(_0x3c9e32,_0x32604c,_0xc31eca,_0xc31eca[_0x1da28b(0x244)]);return;}try{if(!_0x32604c[_0x1da28b(0x239)][_0x1da28b(0x33d)]&&!_0x259345){if(_0x3caa3e!=null&&typeof _0x3caa3e!=='string'){console['log'](_0x3caa3e),console[_0x1da28b(0x365)](_0x1da28b(0x1d1),typeof _0x3caa3e);return;}if(_0x3caa3e?.[_0x1da28b(0x2a1)]()===_0x1da28b(0x33f)&&_0xc31eca[_0x1da28b(0x246)]!=_0x1da28b(0x1d0)){await(0x0,SendPresenceStatus_1['SendPresenceStatus'])(_0x3c9e32,_0xc31eca[_0x1da28b(0x244)][_0x1da28b(0x1f4)]+'@'+(_0xc31eca[_0x1da28b(0x319)]?_0x1da28b(0x205):_0x1da28b(0x352)));const _0x34300c=await _0x3c9e32[_0x1da28b(0x314)](_0xc31eca['contact'][_0x1da28b(0x1f4)]+'@'+(_0xc31eca[_0x1da28b(0x319)]?_0x1da28b(0x205):_0x1da28b(0x352)),{'text':_0x1da28b(0x377)});await(0x0,exports[_0x1da28b(0x374)])(_0x34300c,_0xc31eca,_0xc31eca['contact']),await(0x0,UpdateTicketService_1[_0x1da28b(0x378)])({'ticketData':{'queueId':null,'status':_0x1da28b(0x1d0)},'ticketId':_0xc31eca['id'],'companyId':_0xc31eca[_0x1da28b(0x348)]}),await _0xc31eca['reload']();return;}}}catch(_0x59ae6a){console[_0x1da28b(0x241)]('Erro\x20ao\x20salvar\x20mensagem!'),console['log'](_0x59ae6a),Sentry[_0x1da28b(0x323)](_0x59ae6a);}try{await _0xc31eca['update']({'fromMe':_0x32604c['key'][_0x1da28b(0x33d)]});}catch(_0x2c93cd){console[_0x1da28b(0x241)](_0x1da28b(0x305)),console['log'](_0x2c93cd),Sentry[_0x1da28b(0x323)](_0x2c93cd);}try{if(!_0x32604c[_0x1da28b(0x239)]['fromMe']){if((0x0,exports[_0x1da28b(0x1f8)])(_0x5b0bde)){await(0x0,exports['handleRating'])(_0x32604c,_0xc31eca,_0x5b0bde),console[_0x1da28b(0x241)](_0x1da28b(0x326)+_0x32604c);return;}}}catch(_0x2179bc){console[_0x1da28b(0x241)](_0x1da28b(0x29d)),Sentry[_0x1da28b(0x323)](_0x2179bc),console[_0x1da28b(0x241)](_0x2179bc);}_0x516b9d?_0x46feba=await verifyMediaMessage(_0x32604c,_0xc31eca,_0x3afd9c):await(0x0,exports[_0x1da28b(0x374)])(_0x32604c,_0xc31eca,_0x3afd9c);const _0xc07b22=await(0x0,VerifyCurrentSchedule_1[_0x1da28b(0x378)])(_0x3b0925),_0xfdb2ef=await Setting_1['default'][_0x1da28b(0x353)]({'where':{'companyId':_0x3b0925,'key':'scheduleType'}});if(!_0x32604c[_0x1da28b(0x239)][_0x1da28b(0x33d)]&&_0xfdb2ef&&!_0x259345)await handleOutOfHour(_0x3c9e32,_0xc31eca,_0xfdb2ef,_0x3afd9c,_0xc07b22,_0x16c25b);!_0xc31eca['queue']&&!_0x556384&&!_0x32604c[_0x1da28b(0x239)]['fromMe']&&!_0xc31eca[_0x1da28b(0x1eb)]&&!(0x0,lodash_1['isNil'])(_0x16c25b[_0x1da28b(0x328)])&&!_0x259345&&await handleOpenAi(_0x32604c,_0x3c9e32,_0xc31eca,_0x3afd9c,_0x46feba);if(!_0x32604c[_0x1da28b(0x239)][_0x1da28b(0x33d)]&&!_0xc31eca[_0x1da28b(0x319)]&&!_0xc31eca['queue']&&!_0xc31eca[_0x1da28b(0x1be)]&&_0xc31eca[_0x1da28b(0x2c9)]&&!(0x0,lodash_1[_0x1da28b(0x33a)])(_0x16c25b[_0x1da28b(0x2d5)])&&!_0xc31eca[_0x1da28b(0x2eb)]&&!_0x259345){const _0x25867d=await(0x0,ShowQueueIntegrationService_1[_0x1da28b(0x378)])(_0x16c25b['integrationId'],_0x3b0925);await(0x0,exports[_0x1da28b(0x342)])(_0x32604c,_0x3c9e32,_0x25867d,_0xc31eca);return;}!_0x556384&&!_0x32604c[_0x1da28b(0x239)][_0x1da28b(0x33d)]&&!_0xc31eca['userId']&&!(0x0,lodash_1[_0x1da28b(0x33a)])(_0xc31eca[_0x1da28b(0x328)])&&_0xc31eca[_0x1da28b(0x2eb)]&&!_0x259345&&await handleOpenAi(_0x32604c,_0x3c9e32,_0xc31eca,_0x3afd9c,_0x46feba);if(!_0x32604c[_0x1da28b(0x239)][_0x1da28b(0x33d)]&&!_0xc31eca[_0x1da28b(0x319)]&&!_0xc31eca[_0x1da28b(0x1eb)]&&_0xc31eca['integrationId']&&_0xc31eca[_0x1da28b(0x2eb)]&&!_0x259345){const _0x23969e=await(0x0,ShowQueueIntegrationService_1[_0x1da28b(0x378)])(_0xc31eca['integrationId'],_0x3b0925);await(0x0,exports[_0x1da28b(0x342)])(_0x32604c,_0x3c9e32,_0x23969e,_0xc31eca);}!_0xc31eca[_0x1da28b(0x25e)]&&!_0xc31eca[_0x1da28b(0x319)]&&!_0x32604c[_0x1da28b(0x239)][_0x1da28b(0x33d)]&&!_0xc31eca[_0x1da28b(0x1eb)]&&_0x16c25b[_0x1da28b(0x303)][_0x1da28b(0x264)]>=0x1&&!_0xc31eca['useIntegration']&&!_0x259345&&(await verifyQueue(_0x3c9e32,_0x32604c,_0xc31eca,_0x3afd9c),_0x5b0bde['changed'](_0x1da28b(0x321),!![]),_0x5b0bde[_0x1da28b(0x335)]('updatedAt',!![]),await _0x5b0bde[_0x1da28b(0x36a)]({'chatbotAt':(0x0,moment_1[_0x1da28b(0x378)])()[_0x1da28b(0x2f5)](),'updatedAt':new Date()}));const _0x33939e=_0xc31eca['queue']===null;await _0xc31eca[_0x1da28b(0x1c0)]();if(!_0x259345&&_0x16c25b['greetingMessage'])await greetingMessage(_0x3c9e32,_0xc31eca,_0x32604c,_0x16c25b,_0x556384);_0x16c25b[_0x1da28b(0x303)][_0x1da28b(0x264)]==0x1&&_0xc31eca['queue']&&!_0x259345&&(_0xc31eca[_0x1da28b(0x2c9)]&&!_0x32604c[_0x1da28b(0x239)][_0x1da28b(0x33d)]&&!_0xc31eca[_0x1da28b(0x1eb)]&&await handleChartbot(_0xc31eca,_0x32604c,_0x3c9e32,_0x16c25b)),_0x16c25b[_0x1da28b(0x303)][_0x1da28b(0x264)]>0x1&&_0xc31eca[_0x1da28b(0x25e)]&&!_0x259345&&(_0xc31eca[_0x1da28b(0x2c9)]&&!_0x32604c[_0x1da28b(0x239)][_0x1da28b(0x33d)]&&!_0xc31eca[_0x1da28b(0x1eb)]&&await handleChartbot(_0xc31eca,_0x32604c,_0x3c9e32,_0x16c25b,_0x33939e));}catch(_0x23a645){console[_0x1da28b(0x241)](_0x23a645),Sentry[_0x1da28b(0x323)](_0x23a645),logger_1[_0x1da28b(0x30c)][_0x1da28b(0x2ce)](_0x1da28b(0x339)+_0x23a645);}};exports['handleMessage']=handleMessage;const handleOutOfHour=async(_0x4f2adf,_0x66ccf2,_0x1fbecc,_0x21fa42,_0x44d685,_0xc1ea53)=>{const _0x1d849b=a558_0x1e95a7;try{if(outOfHourMessageControl[_0x1d849b(0x264)]>0x1388)outOfHourMessageControl=[];let _0x4daf6b=outOfHourMessageControl[_0x1d849b(0x36b)](_0x504269=>_0x504269['ticketId']===_0x66ccf2['id']||_0x504269['dest']===_0x21fa42[_0x1d849b(0x1f4)]);if(_0x1fbecc[_0x1d849b(0x20b)]===_0x1d849b(0x2bf)&&!(0x0,lodash_1[_0x1d849b(0x33a)])(_0x44d685)&&_0xc1ea53[_0x1d849b(0x31f)]&&(!_0x44d685||_0x44d685['inActivity']===![])){if(!_0x4daf6b||_0x4daf6b&&_0x4daf6b['time']+0x3e8*0x3c*0x5<new Date()[_0x1d849b(0x273)]()){_0x4daf6b&&(outOfHourMessageControl=outOfHourMessageControl['filter'](_0x4e8b24=>_0x4e8b24[_0x1d849b(0x2c7)]!==_0x66ccf2['id']),_0x4daf6b=null);if(!_0x4daf6b)outOfHourMessageControl[_0x1d849b(0x2e6)]({'ticketId':_0x66ccf2['id'],'dest':_0x21fa42['number'],'time':new Date()[_0x1d849b(0x273)]()});const _0x36db64='‎\x20'+_0xc1ea53[_0x1d849b(0x31f)],_0x39a2de=(0x0,Debounce_1[_0x1d849b(0x2db)])(async()=>{const _0x50bca4=_0x1d849b;await _0x4f2adf[_0x50bca4(0x314)](_0x66ccf2[_0x50bca4(0x244)]['number']+'@'+(_0x66ccf2['isGroup']?_0x50bca4(0x205):_0x50bca4(0x352)),{'text':_0x36db64});},(0x0,queues_1[_0x1d849b(0x309)])(0x5dc,0xdac),_0x66ccf2['id']);_0x39a2de();return;}}if(_0x1fbecc['value']===_0x1d849b(0x25e)&&_0x66ccf2[_0x1d849b(0x272)]!==null){const _0x1df073=await Queue_1[_0x1d849b(0x378)][_0x1d849b(0x1ec)](_0x66ccf2[_0x1d849b(0x272)]),{schedules:_0x45392e}=_0x1df073,_0x34e037=(0x0,moment_1['default'])(),_0x5f4198=_0x34e037['format'](_0x1d849b(0x263))[_0x1d849b(0x1cf)]();let _0x49cd85=null;Array[_0x1d849b(0x2e4)](_0x45392e)&&_0x45392e[_0x1d849b(0x264)]>0x0&&(_0x49cd85=_0x45392e[_0x1d849b(0x36b)](_0x3bedae=>_0x3bedae[_0x1d849b(0x2ed)]===_0x5f4198&&_0x3bedae['startTime']!==''&&_0x3bedae[_0x1d849b(0x2de)]!==null&&_0x3bedae[_0x1d849b(0x329)]!==''&&_0x3bedae['endTime']!==null));if(_0x1fbecc[_0x1d849b(0x20b)]===_0x1d849b(0x25e)&&_0x1df073[_0x1d849b(0x31f)]!==null&&_0x1df073['outOfHoursMessage']!==''&&!(0x0,lodash_1[_0x1d849b(0x33a)])(_0x49cd85)){const _0x51a452=(0x0,moment_1[_0x1d849b(0x378)])(_0x49cd85[_0x1d849b(0x2de)],'HH:mm'),_0x28f311=(0x0,moment_1[_0x1d849b(0x378)])(_0x49cd85['endTime'],_0x1d849b(0x334));let _0x2f52ce=_0x34e037[_0x1d849b(0x35b)](_0x51a452)||_0x34e037[_0x1d849b(0x37d)](_0x28f311);if(!_0x2f52ce){if(_0x49cd85[_0x1d849b(0x355)]&&_0x49cd85[_0x1d849b(0x1f7)]){const _0x5daf68=(0x0,moment_1[_0x1d849b(0x378)])(_0x49cd85[_0x1d849b(0x355)],_0x1d849b(0x334)),_0x41b6aa=(0x0,moment_1['default'])(_0x49cd85[_0x1d849b(0x1f7)],_0x1d849b(0x334));_0x2f52ce=_0x34e037['isBetween'](_0x5daf68,_0x41b6aa);}}if(_0x2f52ce){if(!_0x4daf6b||_0x4daf6b&&_0x4daf6b['time']+0x3e8*0x3c*0x1e<new Date()[_0x1d849b(0x273)]()){const _0x3b69e1=_0x1df073[_0x1d849b(0x31f)],_0x5e4db4=(0x0,Debounce_1[_0x1d849b(0x2db)])(async()=>{const _0xf2a0e2=_0x1d849b;await _0x4f2adf[_0xf2a0e2(0x314)](_0x66ccf2[_0xf2a0e2(0x244)][_0xf2a0e2(0x1f4)]+'@'+(_0x66ccf2[_0xf2a0e2(0x319)]?_0xf2a0e2(0x205):_0xf2a0e2(0x352)),{'text':_0x3b69e1});},(0x0,queues_1[_0x1d849b(0x309)])(0x3e8,0xbb8),_0x66ccf2['id']);_0x5e4db4();return;}if(!_0x4daf6b)outOfHourMessageControl[_0x1d849b(0x2e6)]({'ticketId':_0x66ccf2['id'],'dest':_0x21fa42[_0x1d849b(0x1f4)],'time':new Date()['getTime']()});}}}}catch(_0x30f5aa){Sentry[_0x1d849b(0x323)](_0x30f5aa),console[_0x1d849b(0x241)](_0x30f5aa);}},greetingMessage=async(_0x3d3934,_0x15b135,_0x1bda31,_0x327dbc,_0x440a57)=>{const _0x13c9c0=a558_0x1e95a7;if(!_0x327dbc?.[_0x13c9c0(0x303)]?.[_0x13c9c0(0x264)]&&!_0x15b135[_0x13c9c0(0x1eb)]&&!_0x440a57&&!_0x1bda31[_0x13c9c0(0x239)]['fromMe']){if(process[_0x13c9c0(0x219)][_0x13c9c0(0x2c5)]?.[_0x13c9c0(0x264)]>=0x8){if(_0x15b135[_0x13c9c0(0x244)]['number']!=process[_0x13c9c0(0x219)][_0x13c9c0(0x2c5)])return;}if(greetingMessageControl[_0x13c9c0(0x264)]>0x1388)greetingMessageControl=[];var _0x333083=greetingMessageControl['find'](_0x166bcd=>_0x166bcd[_0x13c9c0(0x2c7)]===_0x15b135['id']||_0x166bcd[_0x13c9c0(0x37e)]===_0x15b135[_0x13c9c0(0x244)]['number']);if(_0x333083&&_0x333083[_0x13c9c0(0x25f)]+0x3e8*0x3c*0x5>=new Date()['getTime']())return;const _0x17a793=await Message_1[_0x13c9c0(0x378)][_0x13c9c0(0x353)]({'where':{'ticketId':_0x15b135['id'],'fromMe':!![],'createdAt':{[sequelize_1['Op'][_0x13c9c0(0x384)]]:(0x0,moment_1[_0x13c9c0(0x378)])()[_0x13c9c0(0x29e)](0x5,_0x13c9c0(0x301))['toDate']()}}});if(_0x17a793)return;const _0x20eeb7=(0x0,Debounce_1[_0x13c9c0(0x2db)])(async()=>{const _0xcda0fa=_0x13c9c0;if(!_0x327dbc['greetingMediaAttachment'])await _0x3d3934[_0xcda0fa(0x314)](_0x15b135['contact']['number']+'@'+(_0x15b135['isGroup']?_0xcda0fa(0x205):'s.whatsapp.net'),{'text':(0x0,Mustache_1[_0xcda0fa(0x378)])(_0x327dbc[_0xcda0fa(0x26b)],_0x15b135)});else{const _0x32f41b=path_1['default'][_0xcda0fa(0x1df)](_0xcda0fa(0x249),_0xcda0fa(0x2bf)+_0x15b135[_0xcda0fa(0x348)],_0x327dbc[_0xcda0fa(0x207)]),_0x5cb74d=await(0x0,SendWhatsAppMedia_1['getMessageOptions'])(_0x327dbc[_0xcda0fa(0x207)],_0x32f41b,_0x327dbc['greetingMessage'],_0x15b135['companyId']);await _0x3d3934[_0xcda0fa(0x314)](_0x15b135[_0xcda0fa(0x244)][_0xcda0fa(0x1f4)]+'@'+(_0x15b135[_0xcda0fa(0x319)]?'g.us':_0xcda0fa(0x352)),{..._0x5cb74d});}},0x3e8,_0x15b135['id']);_0x20eeb7();return;}},handleMsgAck=async(_0x2085c3,_0x2135b8)=>{const _0x2b8739=a558_0x1e95a7,_0x1c5dfe=(0x0,socket_1[_0x2b8739(0x1e2)])();try{const _0x42c1b2=await Message_1[_0x2b8739(0x378)]['findByPk'](_0x2085c3[_0x2b8739(0x239)]['id'],{'include':[_0x2b8739(0x244),{'model':Message_1['default'],'as':'quotedMsg','include':[_0x2b8739(0x244)]}]});if(!_0x42c1b2){console[_0x2b8739(0x241)](_0x2085c3),console[_0x2b8739(0x241)](_0x2b8739(0x1f1));return;}await _0x42c1b2[_0x2b8739(0x36a)]({'ack':_0x2135b8}),_0x1c5dfe['to'](_0x42c1b2['ticketId']['toString']())[_0x2b8739(0x20d)](_0x2b8739(0x297)+_0x42c1b2[_0x2b8739(0x348)]+_0x2b8739(0x286),{'action':'update','message':_0x42c1b2});}catch(_0x369b22){Sentry[_0x2b8739(0x323)](_0x369b22),logger_1[_0x2b8739(0x30c)]['error'](_0x2b8739(0x2bb)+_0x369b22);}};exports['handleMsgAck']=handleMsgAck;function a558_0x2d96(_0x1c89e6,_0x1c0645){const _0x42c125=a558_0x627a();return a558_0x2d96=function(_0x3396bd,_0x5d4308){_0x3396bd=_0x3396bd-0x1ba;let _0x627a49=_0x42c125[_0x3396bd];return _0x627a49;},a558_0x2d96(_0x1c89e6,_0x1c0645);}const verifyRecentCampaign=async(_0x142137,_0x363776)=>{const _0x1147a9=a558_0x1e95a7;if(!_0x142137[_0x1147a9(0x239)][_0x1147a9(0x33d)]){const _0x53ec8a=_0x142137[_0x1147a9(0x239)][_0x1147a9(0x2d2)][_0x1147a9(0x300)](/\D/g,''),_0x3880f7=await Campaign_1['default']['findAll']({'where':{'companyId':_0x363776,'status':_0x1147a9(0x312),'confirmation':!![]}});if(_0x3880f7){const _0x3f24be=_0x3880f7[_0x1147a9(0x2e0)](_0x1856f4=>_0x1856f4['id']),_0x4d1e6d=await CampaignShipping_1[_0x1147a9(0x378)][_0x1147a9(0x353)]({'where':{'campaignId':{[sequelize_1['Op']['in']]:_0x3f24be},'number':_0x53ec8a,'confirmation':null}});_0x4d1e6d&&(await _0x4d1e6d[_0x1147a9(0x36a)]({'confirmedAt':(0x0,moment_1[_0x1147a9(0x378)])(),'confirmation':!![]}),await queues_1[_0x1147a9(0x29f)][_0x1147a9(0x203)]('DispatchCampaign',{'campaignShippingId':_0x4d1e6d['id'],'campaignId':_0x4d1e6d[_0x1147a9(0x2b7)]},{'delay':(0x0,queues_1[_0x1147a9(0x267)])((0x0,queues_1['randomValue'])(0x0,0xa))}));}}};exports[a558_0x1e95a7(0x1ef)]=verifyRecentCampaign;const verifyCampaignMessageAndCloseTicket=async(_0x562f7e,_0xf924ef)=>{const _0x3c2ed0=a558_0x1e95a7,_0x3bb780=(0x0,socket_1[_0x3c2ed0(0x1e2)])(),_0x1ee038=(0x0,exports[_0x3c2ed0(0x26a)])(_0x562f7e),_0x4bfa9a=/\u200c/['test'](_0x1ee038);if(_0x562f7e[_0x3c2ed0(0x239)][_0x3c2ed0(0x33d)]&&_0x4bfa9a){const _0x572a6a=await Message_1[_0x3c2ed0(0x378)][_0x3c2ed0(0x353)]({'where':{'id':_0x562f7e[_0x3c2ed0(0x239)]['id'],'companyId':_0xf924ef}}),_0x27d9ad=await Ticket_1[_0x3c2ed0(0x378)][_0x3c2ed0(0x1ec)](_0x572a6a[_0x3c2ed0(0x2c7)]);await _0x27d9ad['update']({'status':'closed'}),_0x3bb780['to']('company-'+_0x27d9ad[_0x3c2ed0(0x348)]+_0x3c2ed0(0x2f1))['emit']('company-'+_0x27d9ad[_0x3c2ed0(0x348)]+'-ticket',{'action':'delete','ticket':_0x27d9ad,'ticketId':_0x27d9ad['id']}),_0x3bb780['to'](_0x3c2ed0(0x297)+_0xf924ef+'-'+_0x27d9ad[_0x3c2ed0(0x246)])['to'](_0x27d9ad['id']['toString']())['emit'](_0x3c2ed0(0x297)+_0x27d9ad[_0x3c2ed0(0x348)]+_0x3c2ed0(0x226),{'action':_0x3c2ed0(0x36a),'ticket':_0x27d9ad,'ticketId':_0x27d9ad['id']});}};exports[a558_0x1e95a7(0x254)]=verifyCampaignMessageAndCloseTicket;const filterMessages=_0x6dc57f=>{const _0x526e29=a558_0x1e95a7;if([baileys_1[_0x526e29(0x1c5)][_0x526e29(0x21a)],baileys_1[_0x526e29(0x1c5)][_0x526e29(0x28a)],baileys_1[_0x526e29(0x1c5)][_0x526e29(0x275)],baileys_1[_0x526e29(0x1c5)][_0x526e29(0x240)]]['includes'](_0x6dc57f[_0x526e29(0x1c4)]))return![];return!![];},wbotMessageListener=async(_0x293f71,_0x23a2ee,_0x20b4c0)=>{const _0x355367=a558_0x1e95a7;_0x293f71['ev']['on'](_0x355367(0x346),async _0x477e4c=>{const _0x20bab5=_0x355367,_0x3a2d37=_0x477e4c[_0x20bab5(0x1fd)]['filter'](filterMessages);if(!_0x3a2d37)return;await app_1[_0x20bab5(0x378)][_0x20bab5(0x350)](_0x20bab5(0x303))['messageQueue']['add'](_0x20bab5(0x258),{'whatsappId':_0x20b4c0['id'],'messages':_0x3a2d37,'companyId':_0x23a2ee},{'removeOnComplete':!![],'attempts':0x3});}),_0x293f71['ev']['on'](_0x355367(0x20a),async _0x2e634c=>{const _0x3384f0=_0x355367;if(_0x2e634c[_0x3384f0(0x264)]===0x0)return;await app_1[_0x3384f0(0x378)][_0x3384f0(0x350)](_0x3384f0(0x303))[_0x3384f0(0x2ea)][_0x3384f0(0x203)](_0x3384f0(0x1d8),{'whatsappId':_0x20b4c0['id'],'messageUpdate':_0x2e634c,'companyId':_0x23a2ee},{'removeOnComplete':!![],'attempts':0x3,'delay':0x64});}),_0x293f71['ev']['on'](_0x355367(0x1fc),async _0x2feae4=>{const _0x19b0e2=_0x355367;console[_0x19b0e2(0x241)](_0x2feae4);if(_0x2feae4[_0x19b0e2(0x264)]===0x0)return;for(const _0x43d211 of _0x2feae4){const _0x50bbae=_0x43d211['id']['split']('@')[0x0],_0x23f792=_0x43d211[_0x19b0e2(0x37f)]||_0x50bbae,_0x8cee3={'name':_0x23f792,'number':_0x50bbae,'isGroup':!![],'companyId':_0x23a2ee,'remoteJid':_0x43d211['id'],'whatsappId':_0x293f71['id']};await(0x0,CreateOrUpdateContactService_1[_0x19b0e2(0x378)])(_0x8cee3,_0x293f71,_0x43d211['id']);}});};exports['wbotMessageListener']=wbotMessageListener;