'use strict';const a588_0x27676a=a588_0x1b85;(function(_0x1fdce6,_0x47ac2f){const _0x1ba0b8=a588_0x1b85,_0x5a51e0=_0x1fdce6();while(!![]){try{const _0x4c426d=-parseInt(_0x1ba0b8(0x16e))/0x1*(-parseInt(_0x1ba0b8(0x114))/0x2)+-parseInt(_0x1ba0b8(0x1b2))/0x3*(parseInt(_0x1ba0b8(0x156))/0x4)+parseInt(_0x1ba0b8(0xe7))/0x5*(-parseInt(_0x1ba0b8(0x177))/0x6)+-parseInt(_0x1ba0b8(0xbd))/0x7+-parseInt(_0x1ba0b8(0xe9))/0x8*(-parseInt(_0x1ba0b8(0x165))/0x9)+parseInt(_0x1ba0b8(0x128))/0xa+parseInt(_0x1ba0b8(0x1b6))/0xb*(-parseInt(_0x1ba0b8(0x172))/0xc);if(_0x4c426d===_0x47ac2f)break;else _0x5a51e0['push'](_0x5a51e0['shift']());}catch(_0x5bf4cf){_0x5a51e0['push'](_0x5a51e0['shift']());}}}(a588_0x1c1b,0xdf0c9));var __createBinding=this&&this[a588_0x27676a(0x17f)]||(Object[a588_0x27676a(0x1a4)]?function(_0xb49a81,_0x2daacd,_0x232df6,_0x48503a){const _0x102811=a588_0x27676a;if(_0x48503a===undefined)_0x48503a=_0x232df6;var _0x338dea=Object[_0x102811(0x14d)](_0x2daacd,_0x232df6);(!_0x338dea||('get'in _0x338dea?!_0x2daacd[_0x102811(0xf0)]:_0x338dea[_0x102811(0xe8)]||_0x338dea[_0x102811(0x147)]))&&(_0x338dea={'enumerable':!![],'get':function(){return _0x2daacd[_0x232df6];}}),Object[_0x102811(0x1b3)](_0xb49a81,_0x48503a,_0x338dea);}:function(_0x39b891,_0x3d4da4,_0x41e076,_0x4317f1){if(_0x4317f1===undefined)_0x4317f1=_0x41e076;_0x39b891[_0x4317f1]=_0x3d4da4[_0x41e076];}),__setModuleDefault=this&&this[a588_0x27676a(0xdf)]||(Object[a588_0x27676a(0x1a4)]?function(_0x500c05,_0x1e1323){const _0x2ee3e9=a588_0x27676a;Object[_0x2ee3e9(0x1b3)](_0x500c05,_0x2ee3e9(0x163),{'enumerable':!![],'value':_0x1e1323});}:function(_0x386c4f,_0x1ce2be){_0x386c4f['default']=_0x1ce2be;}),__importStar=this&&this[a588_0x27676a(0x185)]||(function(){const _0x5707b4=(function(){let _0x388fce=!![];return function(_0x36da37,_0x58fed2){const _0x4aa127=_0x388fce?function(){const _0x576537=a588_0x1b85;if(_0x58fed2){const _0xd2ca9=_0x58fed2[_0x576537(0x15c)](_0x36da37,arguments);return _0x58fed2=null,_0xd2ca9;}}:function(){};return _0x388fce=![],_0x4aa127;};}()),_0xe70799=_0x5707b4(this,function(){const _0x251c46=a588_0x1b85;return _0xe70799[_0x251c46(0xef)]()[_0x251c46(0xcf)](_0x251c46(0xf6))[_0x251c46(0xef)]()[_0x251c46(0x117)](_0xe70799)[_0x251c46(0xcf)]('(((.+)+)+)+$');});_0xe70799();var _0x4b1e74=function(_0x2c2aa8){const _0x47e129=a588_0x1b85;return _0x4b1e74=Object[_0x47e129(0x120)]||function(_0x59a02a){const _0x547398=_0x47e129;var _0x1fcbc6=[];for(var _0x2bebee in _0x59a02a)if(Object[_0x547398(0x192)][_0x547398(0x183)][_0x547398(0x10a)](_0x59a02a,_0x2bebee))_0x1fcbc6[_0x1fcbc6[_0x547398(0xeb)]]=_0x2bebee;return _0x1fcbc6;},_0x4b1e74(_0x2c2aa8);};return function(_0x172b46){const _0x1c5775=a588_0x1b85;if(_0x172b46&&_0x172b46[_0x1c5775(0xf0)])return _0x172b46;var _0x18ded3={};if(_0x172b46!=null){for(var _0x10b2a9=_0x4b1e74(_0x172b46),_0x2ddcf4=0x0;_0x2ddcf4<_0x10b2a9['length'];_0x2ddcf4++)if(_0x10b2a9[_0x2ddcf4]!==_0x1c5775(0x163))__createBinding(_0x18ded3,_0x172b46,_0x10b2a9[_0x2ddcf4]);}return __setModuleDefault(_0x18ded3,_0x172b46),_0x18ded3;};}()),__importDefault=this&&this['__importDefault']||function(_0x26e104){const _0x106b2b=a588_0x27676a;return _0x26e104&&_0x26e104[_0x106b2b(0xf0)]?_0x26e104:{'default':_0x26e104};};Object[a588_0x27676a(0x1b3)](exports,a588_0x27676a(0xf0),{'value':!![]}),exports[a588_0x27676a(0xc5)]=exports[a588_0x27676a(0x18a)]=exports[a588_0x27676a(0x11e)]=exports[a588_0x27676a(0xe0)]=exports[a588_0x27676a(0xf8)]=void 0x0,exports[a588_0x27676a(0x18b)]=makeid;const path_1=__importDefault(require(a588_0x27676a(0x159))),Sentry=__importStar(require(a588_0x27676a(0x173))),lodash_1=require(a588_0x27676a(0x19e)),baileys_1=require(a588_0x27676a(0x11f)),async_mutex_1=require('async-mutex'),sequelize_1=require('sequelize'),moment_1=__importDefault(require('moment')),Contact_1=__importDefault(require(a588_0x27676a(0x108))),Ticket_1=__importDefault(require(a588_0x27676a(0xd0))),Message_1=__importDefault(require(a588_0x27676a(0x11b))),socket_1=require('../../libs/socket'),logger_1=require(a588_0x27676a(0x1a8)),FindOrCreateTicketService_1=__importDefault(require(a588_0x27676a(0x188))),ShowWhatsAppService_1=__importDefault(require(a588_0x27676a(0x175))),UpdateTicketService_1=__importDefault(require(a588_0x27676a(0xce))),Mustache_1=__importDefault(require(a588_0x27676a(0x179))),TicketTraking_1=__importDefault(require(a588_0x27676a(0x154))),UserRating_1=__importDefault(require(a588_0x27676a(0x150))),SendWhatsAppMessage_1=__importDefault(require(a588_0x27676a(0x146))),Queue_1=__importDefault(require(a588_0x27676a(0x112))),QueueOption_1=__importDefault(require(a588_0x27676a(0xf7))),VerifyCurrentSchedule_1=__importDefault(require(a588_0x27676a(0xdc))),User_1=__importDefault(require('../../models/User')),Setting_1=__importDefault(require(a588_0x27676a(0x151))),cache_1=require(a588_0x27676a(0x19c)),Debounce_1=require(a588_0x27676a(0xee)),SendWhatsAppMedia_1=__importDefault(require(a588_0x27676a(0xb5))),CheckSettings_1=require(a588_0x27676a(0xbc)),Whatsapp_1=__importDefault(require(a588_0x27676a(0x196))),simpleObjectCache_1=require(a588_0x27676a(0xcb)),ShowQueueIntegrationService_1=__importDefault(require(a588_0x27676a(0x113))),typebotListener_1=__importDefault(require(a588_0x27676a(0x111))),VerifyHandlers_1=require(a588_0x27676a(0x110)),GetHandlers_1=require('./GetHandlers'),wbotMutex=new async_mutex_1[(a588_0x27676a(0xc2))](),ackMutex=new async_mutex_1['Mutex'](),groupContactCache=new simpleObjectCache_1['SimpleObjectCache'](0x3e8*0x1e,logger_1[a588_0x27676a(0x1b1)]),outOfHoursCache=new simpleObjectCache_1[(a588_0x27676a(0x161))](0x3e8*0x3c*0x5,logger_1[a588_0x27676a(0x1b1)]);function makeid(_0x4a790d){const _0x3d4778=a588_0x27676a;let _0xe39484='';const _0x42f594=_0x3d4778(0xb3),_0x237e79=_0x42f594['length'];for(let _0x2dfb6f=0x0;_0x2dfb6f<_0x4a790d;_0x2dfb6f+=0x1){_0xe39484+=_0x42f594[_0x3d4778(0x134)](Math[_0x3d4778(0x164)](Math[_0x3d4778(0xc4)]()*_0x237e79));}return _0xe39484;}function a588_0x1c1b(){const _0x1296b1=['findOne','outOfHoursAction','Error\x20handling\x20message\x20ack.\x20Err:\x20','setExtra','\x20já\x20processada\x20para\x20o\x20ticket\x20','*\x20-\x20','Tipo\x20de\x20integração\x20não\x20suportada.','CHATBOT_RESTRICT_NUMBER','queues','*#*\x20-\x20Voltar\x20Menu\x20Inicial','documentWithCaptionMessage','../../models/Contact','inActivity','call','set','mediaPath','Error\x20processing\x20message\x20','queue','keepUserAndQueue','./VerifyHandlers','../TypebotServices/typebotListener','../../models/Queue','../QueueIntegrationServices/ShowQueueIntegrationService','6oGlSdN','transferMessage','parentId','constructor','ASC','key','FRONTEND_URL','../../models/Message','listResponseMessage','E2E_DEVICE_CHANGED','handleMessageIntegration','@whiskeysockets/baileys','getOwnPropertyNames','chatbot','verifyQueue','options','Mensagem','includes','CheckMsgIsGroup','disabled','14482790MXLxqM','Erro\x20de\x20decriptação\x20ignorado\x20para\x20mensagem\x20','forwardQueue','typebot','ticket-','fromMe','toLowerCase','DESC','value','stickerMessage','split','findAll','charAt','queueOptionId','messageStubType','getMessageMedia','filter','message','viewOnceMessageV2','\x20selecionada\x20no\x20menu\x20principal.\x20ID:\x20','outOfHoursMessage','contactMessage','update','isNull','conversation','@s.whatsapp.net','remoteJidAlt','Resultado\x20da\x20verificação\x20de\x20horário:','debounce','not','./SendWhatsAppMessage','configurable','-ticket','chatbot\x20desativado!','closed','env','destroy','getOwnPropertyDescriptor','typebotStatus:\x20','getContactMessage','../../models/UserRating','../../models/Setting','listMessage','find','../../models/TicketTraking','Error\x20handling\x20whatsapp\x20message:\x20Err:\x20','4JBlnYE','contacts:','complationMessage','path','extendedTextMessage','option','apply','reload','keys','userId','enabled','SimpleObjectCache','title','default','floor','837uMOZXT','pending','Erro\x20ao\x20verificar\x20horário\x20de\x20atendimento:','useIntegration','WAMessageStubType','map','trim','companyId','/nopicture.png','239489ItldsY','subject','vcard','getTypeMessage','20652LXXFlc','@sentry/node','locationMessage','../WhatsappService/ShowWhatsAppService','isNil','4470fXqnZd','mediaMessage','../../helpers/Mustache','emit','GetCompanySetting','verifyEditedMessage','E2E_IDENTITY_CHANGED','getIO','__createBinding','verifyRecentCampaign','status','startsWith','hasOwnProperty','integrationId','__importStar','whatsappId','Resposta\x20inválida:\x20','../TicketServices/FindOrCreateTicketService','ack','wbotMessageListener','makeid','readMessages','resolve','Opção\x20','ticketId','number','queueId','prototype','reactionMessage','ephemeralMessage','\x0a*#*\x20-\x20Voltar\x20Menu\x20Inicial','../../models/Whatsapp','greetingMessage','endsWith','warn','audioMessage','-open','../../libs/cache','forEach','lodash','cacheLayer','@newsletter','isNaN','protocolMessage','runExclusive','create','\x20não\x20encontrada.','Mensagem\x20','remoteJid','../../utils/logger','Error\x20isValidMsg','text','documentMessage','createdAt','\x20selecionada\x20no\x20submenu.\x20ID:\x20','user','queue-','exitChatbot','logger','1409655eGfmRh','defineProperty','Estamos\x20fora\x20do\x20horário\x20de\x20expediente','\x20inválida\x20para\x20o\x20menu\x20principal.','2046VWLylY','status@broadcast','type','ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789','@g.us','./SendWhatsAppMedia','socketSessions','ticket','public','Atendimento\x20finalizado','Submenu\x20encontrado\x20com\x20','amountUsedBotQueues','../../helpers/CheckSettings','1639505rupfUg','get','useRating','company-','Mensagem\x20de\x20status\x20ignorada\x20de:\x20','Mutex','templateMessage','random','handleMessage','@lid','editedMessage','imageMessage','failed\x20to\x20decrypt','verifyMessage','../../helpers/simpleObjectCache','Processando\x20mensagem:\x20\x22','log','../TicketServices/UpdateTicketService','search','../../models/Ticket','contactsArrayMessage','.\x20Ignorando\x20em\x20handleChartbot.',':unreads','REVOKE','info','isInteger','count','Atualizando\x20estado\x20de\x20integração\x20do\x20ticket\x20#','contact','Mensagem\x20de\x20canal/newsletter\x20ignorada:\x20','buttonsResponseMessage','../CompanyService/VerifyCurrentSchedule','Exibindo\x20menu\x20para\x20ticket\x20','typebotStatus','__setModuleDefault','displayCurrentMenu','verifyContact','\x20de\x20','body','-appMessage','profilePicUrl','getBodyMessage','2150COhrcj','writable','7864nECdUG','findByPk','length','maxUseBotQueues','forwardQueueId','../../helpers/Debounce','toString','__esModule','debug','liveLocationMessage','captureException','Configurações\x20do\x20WhatsApp\x20não\x20encontradas.','####\x20Nao\x20achou\x20o\x20type\x20em\x20isValidMsg:\x20','(((.+)+)+)+$','../../models/QueueOption','handleRating','verifyMediaMessage','error','disableBot','open'];a588_0x1c1b=function(){return _0x1296b1;};return a588_0x1c1b();}const isValidMsg=_0x2ee5ff=>{const _0xc2c3dd=a588_0x27676a;if(_0x2ee5ff[_0xc2c3dd(0x119)]['remoteJid']===_0xc2c3dd(0xb1))return![];try{const _0x1607df=(0x0,GetHandlers_1[_0xc2c3dd(0x171)])(_0x2ee5ff);if(!_0x1607df)return![];const _0x41d43c=_0x1607df==='conversation'||_0x1607df===_0xc2c3dd(0xc7)||_0x1607df==='extendedTextMessage'||_0x1607df===_0xc2c3dd(0x19a)||_0x1607df==='videoMessage'||_0x1607df===_0xc2c3dd(0xc8)||_0x1607df===_0xc2c3dd(0x1ab)||_0x1607df===_0xc2c3dd(0x107)||_0x1607df===_0xc2c3dd(0x131)||_0x1607df===_0xc2c3dd(0xdb)||_0x1607df==='buttonsMessage'||_0x1607df==='messageContextInfo'||_0x1607df===_0xc2c3dd(0x174)||_0x1607df===_0xc2c3dd(0xf2)||_0x1607df===_0xc2c3dd(0x13d)||_0x1607df==='voiceMessage'||_0x1607df===_0xc2c3dd(0x178)||_0x1607df===_0xc2c3dd(0xd1)||_0x1607df===_0xc2c3dd(0x193)||_0x1607df==='ephemeralMessage'||_0x1607df===_0xc2c3dd(0x1a2)||_0x1607df===_0xc2c3dd(0x11c)||_0x1607df===_0xc2c3dd(0x152)||_0x1607df===_0xc2c3dd(0xc3)||_0x1607df==='viewOnceMessage'||_0x1607df===_0xc2c3dd(0x13a);return!_0x41d43c&&(logger_1[_0xc2c3dd(0x1b1)][_0xc2c3dd(0x199)](_0xc2c3dd(0xf5)+_0x1607df+'\x0a'+JSON['stringify'](_0x2ee5ff?.[_0xc2c3dd(0x139)])),Sentry[_0xc2c3dd(0x100)](_0xc2c3dd(0x124),{'BodyMsg':_0x2ee5ff[_0xc2c3dd(0x139)],'msg':_0x2ee5ff,'msgType':_0x1607df}),Sentry[_0xc2c3dd(0xf3)](new Error('Novo\x20Tipo\x20de\x20Mensagem\x20em\x20isValidMsg'))),!!_0x41d43c;}catch(_0x571cf4){return Sentry[_0xc2c3dd(0x100)](_0xc2c3dd(0x1a9),{'msg':_0x2ee5ff}),Sentry['captureException'](_0x571cf4),![];}},handleRating=async(_0x33d6cd,_0x32132e,_0x59fc80)=>{const _0x2bfcf9=a588_0x27676a,_0x18d8ef=(0x0,socket_1[_0x2bfcf9(0x17e)])();let _0x4d00b1=null;(_0x33d6cd?.[_0x2bfcf9(0x139)]?.[_0x2bfcf9(0x140)]||_0x33d6cd?.[_0x2bfcf9(0x139)]?.['extendedTextMessage'])&&(_0x4d00b1=parseInt(_0x33d6cd[_0x2bfcf9(0x139)][_0x2bfcf9(0x140)]||_0x33d6cd[_0x2bfcf9(0x139)]['extendedTextMessage'][_0x2bfcf9(0x1aa)],0xa)||null);if(!Number[_0x2bfcf9(0x1a1)](_0x4d00b1)&&Number[_0x2bfcf9(0xd6)](_0x4d00b1)&&!(0x0,lodash_1[_0x2bfcf9(0x13f)])(_0x4d00b1)){const _0x172d8a=await(0x0,ShowWhatsAppService_1['default'])(_0x32132e[_0x2bfcf9(0x186)],_0x32132e[_0x2bfcf9(0x16c)]);let _0x2e01e5=_0x4d00b1;_0x4d00b1<0x1&&(_0x2e01e5=0x1);_0x4d00b1>0x5&&(_0x2e01e5=0x5);await UserRating_1[_0x2bfcf9(0x163)][_0x2bfcf9(0x1a4)]({'ticketId':_0x59fc80['ticketId'],'companyId':_0x59fc80[_0x2bfcf9(0x16c)],'userId':_0x59fc80[_0x2bfcf9(0x15f)],'rate':_0x2e01e5});const _0x340a75=_0x172d8a[_0x2bfcf9(0x158)][_0x2bfcf9(0x16b)]()||'Atendimento\x20finalizado';await(0x0,SendWhatsAppMessage_1[_0x2bfcf9(0x163)])({'ticket':_0x32132e,'body':_0x340a75}),await _0x59fc80[_0x2bfcf9(0x13e)]({'finishedAt':(0x0,moment_1[_0x2bfcf9(0x163)])()['toDate'](),'rated':!![]});const _0x353dde=await(0x0,CheckSettings_1[_0x2bfcf9(0x17b)])(_0x32132e[_0x2bfcf9(0x16c)],_0x2bfcf9(0x10f),'enabled')===_0x2bfcf9(0x160);await _0x32132e[_0x2bfcf9(0x13e)]({'queueId':_0x353dde?_0x32132e[_0x2bfcf9(0x191)]:null,'chatbot':null,'queueOptionId':null,'userId':_0x353dde?_0x32132e[_0x2bfcf9(0x15f)]:null,'status':_0x2bfcf9(0x14a)}),_0x18d8ef['to']('company-'+_0x32132e[_0x2bfcf9(0x16c)]+'-open')['to'](_0x2bfcf9(0x1af)+_0x32132e[_0x2bfcf9(0x191)]+_0x2bfcf9(0x19b))['emit']('company-'+_0x32132e[_0x2bfcf9(0x16c)]+_0x2bfcf9(0x148),{'action':'delete','ticket':_0x32132e,'ticketId':_0x32132e['id']}),_0x18d8ef['to'](_0x2bfcf9(0xc0)+_0x32132e[_0x2bfcf9(0x16c)]+'-'+_0x32132e['status'])['to']('queue-'+_0x32132e[_0x2bfcf9(0x191)]+'-'+_0x32132e['status'])['to'](_0x32132e['id'][_0x2bfcf9(0xef)]())[_0x2bfcf9(0x17a)]('company-'+_0x32132e['companyId']+'-ticket',{'action':'update','ticket':_0x32132e,'ticketId':_0x32132e['id']});}};exports['handleRating']=handleRating;const handleChartbot=async(_0x5804b3,_0xe6b8e4,_0x4cfee1,_0x527920=![])=>{const _0x225bbb=a588_0x27676a,_0x1bd6f4=_0xe6b8e4['key']['id'];if(_0x1bd6f4&&_0x5804b3['lastProcessedMessageId']===_0x1bd6f4){console[_0x225bbb(0xcd)](_0x225bbb(0x1a6)+_0x1bd6f4+_0x225bbb(0x101)+_0x5804b3['id']+_0x225bbb(0xd2));return;}await _0x5804b3[_0x225bbb(0x13e)]({'lastProcessedMessageId':_0x1bd6f4});const _0x66c9cb=(0x0,GetHandlers_1['getBodyMessage'])(_0xe6b8e4);console[_0x225bbb(0xcd)](_0x225bbb(0xcc)+_0x66c9cb+'\x22\x20para\x20ticket\x20'+_0x5804b3['id']+',\x20queueOptionId:\x20'+_0x5804b3['queueOptionId']);const _0x3fca21=await Queue_1['default']['findByPk'](_0x5804b3[_0x225bbb(0x191)],{'include':[{'model':QueueOption_1[_0x225bbb(0x163)],'as':_0x225bbb(0x123),'where':{'parentId':null},'order':[[_0x225bbb(0x15b),_0x225bbb(0x118)]],'required':![]}]}),_0x4aced8=await Whatsapp_1[_0x225bbb(0x163)]['findByPk'](_0x5804b3['whatsappId']);if(!_0x4aced8){console[_0x225bbb(0xfa)](_0x225bbb(0xf4));return;}if(_0x66c9cb==='#'){await _0x5804b3[_0x225bbb(0x13e)]({'queueOptionId':null,'chatbot':![],'queueId':null,'amountUsedBotQueues':0x0}),await(0x0,VerifyHandlers_1['verifyQueue'])(_0x4cfee1,_0xe6b8e4,_0x5804b3,_0x5804b3['contact']);return;}if(!(0x0,lodash_1[_0x225bbb(0x176)])(_0x3fca21)&&!(0x0,lodash_1[_0x225bbb(0x176)])(_0x5804b3['queueOptionId'])&&_0x66c9cb==='0'){const _0x2d13c9=await QueueOption_1[_0x225bbb(0x163)]['findByPk'](_0x5804b3[_0x225bbb(0x135)]);_0x2d13c9?.[_0x225bbb(0x116)]?await _0x5804b3[_0x225bbb(0x13e)]({'queueOptionId':_0x2d13c9[_0x225bbb(0x116)],'amountUsedBotQueues':0x0}):await _0x5804b3[_0x225bbb(0x13e)]({'queueOptionId':null,'amountUsedBotQueues':0x0});await _0x5804b3[_0x225bbb(0x15d)](),await(0x0,exports[_0x225bbb(0xe0)])(_0x5804b3,_0x4cfee1);return;}if(!_0x5804b3[_0x225bbb(0x121)]&&_0x5804b3[_0x225bbb(0xbb)]>=_0x4aced8[_0x225bbb(0xec)])return;if(!(0x0,lodash_1['isNil'])(_0x3fca21)&&(0x0,lodash_1['isNil'])(_0x5804b3[_0x225bbb(0x135)])&&!_0x527920){if(_0x66c9cb&&_0x3fca21[_0x225bbb(0x123)]?.[_0x225bbb(0xeb)]>0x0){const _0x18d85f=_0x3fca21[_0x225bbb(0x123)]['find'](_0x57e27e=>_0x57e27e[_0x225bbb(0x15b)]===_0x66c9cb);if(_0x18d85f){console['log']('Opção\x20'+_0x66c9cb+_0x225bbb(0x13b)+_0x18d85f['id']),await _0x5804b3['update']({'queueOptionId':_0x18d85f['id'],'amountUsedBotQueues':0x0}),await _0x5804b3['reload'](),await(0x0,exports[_0x225bbb(0xe0)])(_0x5804b3,_0x4cfee1);return;}else console[_0x225bbb(0xcd)]('Opção\x20'+_0x66c9cb+_0x225bbb(0x1b5));}}else{if(!(0x0,lodash_1[_0x225bbb(0x176)])(_0x3fca21)&&!(0x0,lodash_1[_0x225bbb(0x176)])(_0x5804b3[_0x225bbb(0x135)])){const _0x31f029=await QueueOption_1[_0x225bbb(0x163)][_0x225bbb(0x133)]({'where':{'parentId':_0x5804b3['queueOptionId']},'order':[[_0x225bbb(0x15b),_0x225bbb(0x118)]]});if(_0x66c9cb&&_0x31f029[_0x225bbb(0xeb)]>0x0){const _0x39fd50=_0x31f029[_0x225bbb(0x153)](_0x1d91a6=>_0x1d91a6[_0x225bbb(0x15b)]===_0x66c9cb);if(_0x39fd50){console['log'](_0x225bbb(0x18e)+_0x66c9cb+_0x225bbb(0x1ad)+_0x39fd50['id']),await _0x5804b3['update']({'queueOptionId':_0x39fd50['id'],'amountUsedBotQueues':0x0}),await _0x5804b3[_0x225bbb(0x15d)](),await(0x0,exports[_0x225bbb(0xe0)])(_0x5804b3,_0x4cfee1);return;}else console[_0x225bbb(0xcd)](_0x225bbb(0x18e)+_0x66c9cb+'\x20inválida\x20para\x20o\x20submenu\x20atual.');}}}if(_0x66c9cb&&_0x66c9cb!=='0'&&_0x66c9cb!=='#'){console[_0x225bbb(0xcd)](_0x225bbb(0x187)+_0x66c9cb);if(_0x4aced8[_0x225bbb(0xec)]&&_0x4aced8[_0x225bbb(0xec)]!==0x0&&_0x5804b3[_0x225bbb(0xbb)]>=_0x4aced8[_0x225bbb(0xec)]){await _0x5804b3['update']({'chatbot':![],'amountUsedBotQueues':_0x4aced8[_0x225bbb(0xec)]});_0x4aced8['transferMessage']&&await(0x0,SendWhatsAppMessage_1[_0x225bbb(0x163)])({'ticket':_0x5804b3,'body':_0x4aced8[_0x225bbb(0x115)]});return;}await _0x5804b3[_0x225bbb(0x13e)]({'amountUsedBotQueues':_0x5804b3[_0x225bbb(0xbb)]+0x1}),await _0x5804b3[_0x225bbb(0x15d)]();}!_0x527920&&await(0x0,exports[_0x225bbb(0xe0)])(_0x5804b3,_0x4cfee1);},displayCurrentMenu=async(_0x21e215,_0x294ea4)=>{const _0x5cbbed=a588_0x27676a;console[_0x5cbbed(0xcd)](_0x5cbbed(0xdd)+_0x21e215['id']+',\x20queueOptionId:\x20'+_0x21e215[_0x5cbbed(0x135)]);const _0x6b0047=await Queue_1['default']['findByPk'](_0x21e215[_0x5cbbed(0x191)]);if(!_0x6b0047)return;if((0x0,lodash_1[_0x5cbbed(0x176)])(_0x21e215[_0x5cbbed(0x135)])){const _0x27f025=await QueueOption_1[_0x5cbbed(0x163)][_0x5cbbed(0x133)]({'where':{'queueId':_0x21e215[_0x5cbbed(0x191)],'parentId':null},'order':[[_0x5cbbed(0x15b),_0x5cbbed(0x118)]]});if(_0x27f025['length']>0x0){let _0x40fab6=_0x6b0047['greetingMessage']?_0x6b0047[_0x5cbbed(0x197)]+'\x0a\x0a':'';_0x27f025[_0x5cbbed(0x19d)](_0x3b8279=>{const _0x579a26=_0x5cbbed;_0x40fab6+='*'+_0x3b8279[_0x579a26(0x15b)]+'*\x20-\x20'+_0x3b8279[_0x579a26(0x162)]+'\x0a';}),_0x40fab6+=_0x5cbbed(0x195),await(0x0,SendWhatsAppMessage_1['default'])({'ticket':_0x21e215,'body':_0x40fab6}),console[_0x5cbbed(0xcd)]('Menu\x20principal\x20exibido.');}return;}const _0x392bc4=await QueueOption_1[_0x5cbbed(0x163)]['findByPk'](_0x21e215[_0x5cbbed(0x135)],{'include':[{'model':Queue_1['default'],'as':'forwardQueue'}]});if(!_0x392bc4){console['log'](_0x5cbbed(0x18e)+_0x21e215[_0x5cbbed(0x135)]+_0x5cbbed(0x1a5));return;}const _0x3f9ba2=await QueueOption_1['default'][_0x5cbbed(0x133)]({'where':{'parentId':_0x21e215['queueOptionId']},'order':[[_0x5cbbed(0x15b),'ASC']]});if(_0x3f9ba2[_0x5cbbed(0xeb)]===0x0){console[_0x5cbbed(0xcd)]('Nó\x20final\x20encontrado.\x20Exibindo\x20mensagem\x20final.');let _0x464668=(0x0,Mustache_1['default'])('‎'+_0x392bc4['message'],_0x21e215);if(_0x392bc4?.[_0x5cbbed(0x10c)]){const _0x40928b=path_1[_0x5cbbed(0x163)][_0x5cbbed(0x18d)](_0x5cbbed(0xb8),_0x392bc4[_0x5cbbed(0x10c)]);_0x40928b?await(0x0,SendWhatsAppMedia_1[_0x5cbbed(0x163)])({'media':_0x40928b,'ticket':_0x21e215,'body':_0x464668}):await(0x0,SendWhatsAppMessage_1[_0x5cbbed(0x163)])({'ticket':_0x21e215,'body':_0x464668});}else await(0x0,SendWhatsAppMessage_1['default'])({'ticket':_0x21e215,'body':_0x464668});if(_0x392bc4[_0x5cbbed(0x1b0)])await _0x21e215[_0x5cbbed(0x13e)]({'queueOptionId':null,'chatbot':![],'amountUsedBotQueues':0x0});else{if(_0x392bc4[_0x5cbbed(0xed)]){await _0x21e215[_0x5cbbed(0x13e)]({'queueOptionId':null,'chatbot':![],'queueId':_0x392bc4['forwardQueueId'],'amountUsedBotQueues':0x0}),await _0x21e215[_0x5cbbed(0x15d)]();if(_0x392bc4[_0x5cbbed(0x12a)]){const _0x5a0e66=await QueueOption_1[_0x5cbbed(0x163)][_0x5cbbed(0xfd)]({'where':{'queueId':_0x392bc4[_0x5cbbed(0xed)],'parentId':null}});await _0x21e215[_0x5cbbed(0x13e)]({'chatbot':!!_0x5a0e66}),_0x392bc4[_0x5cbbed(0x12a)][_0x5cbbed(0x197)]&&await(0x0,SendWhatsAppMessage_1['default'])({'ticket':_0x21e215,'body':_0x392bc4['forwardQueue'][_0x5cbbed(0x197)]}),_0x5a0e66&&await(0x0,exports[_0x5cbbed(0xe0)])(_0x21e215,_0x294ea4);}}else await _0x21e215[_0x5cbbed(0x13e)]({'queueOptionId':null,'chatbot':![]});}return;}console[_0x5cbbed(0xcd)](_0x5cbbed(0xba)+_0x3f9ba2[_0x5cbbed(0xeb)]+'\x20opções.\x20Exibindo\x20submenu.');let _0x54dd19=_0x392bc4[_0x5cbbed(0x139)]?_0x392bc4[_0x5cbbed(0x139)]+'\x0a\x0a':'';_0x3f9ba2[_0x5cbbed(0x19d)](_0x4714c6=>{const _0x4031ad=_0x5cbbed;_0x54dd19+='*'+_0x4714c6[_0x4031ad(0x15b)]+_0x4031ad(0x102)+_0x4714c6[_0x4031ad(0x162)]+'\x0a';}),_0x54dd19+='\x0a*0*\x20-\x20Voltar\x20ao\x20menu\x20anterior\x0a',_0x54dd19+=_0x5cbbed(0x106);if(_0x392bc4?.['mediaPath']){const _0x2d763a=path_1[_0x5cbbed(0x163)][_0x5cbbed(0x18d)](_0x5cbbed(0xb8),_0x392bc4['mediaPath']);_0x2d763a?await(0x0,SendWhatsAppMedia_1[_0x5cbbed(0x163)])({'media':_0x2d763a,'ticket':_0x21e215,'body':_0x54dd19}):await(0x0,SendWhatsAppMessage_1['default'])({'ticket':_0x21e215,'body':_0x54dd19});}else await(0x0,SendWhatsAppMessage_1[_0x5cbbed(0x163)])({'ticket':_0x21e215,'body':_0x54dd19});};exports['displayCurrentMenu']=displayCurrentMenu;function a588_0x1b85(_0x4f9a8a,_0x50cda6){const _0x5e6447=a588_0x1c1b();return a588_0x1b85=function(_0x5d4074,_0x481bae){_0x5d4074=_0x5d4074-0xb1;let _0x1c1b5e=_0x5e6447[_0x5d4074];return _0x1c1b5e;},a588_0x1b85(_0x4f9a8a,_0x50cda6);}const handleMessageIntegration=async(_0x172231,_0x6bf129,_0x4b61ad,_0x5350e4)=>{const _0x1dec2c=a588_0x27676a;if(process[_0x1dec2c(0x14b)][_0x1dec2c(0x104)]){if(_0x5350e4[_0x1dec2c(0xd9)][_0x1dec2c(0x190)]!=process[_0x1dec2c(0x14b)][_0x1dec2c(0x104)]){console[_0x1dec2c(0xcd)](_0x1dec2c(0x149));return;}}console[_0x1dec2c(0xcd)](_0x1dec2c(0x14e),_0x5350e4[_0x1dec2c(0xde)]),_0x4b61ad['type']===_0x1dec2c(0x12b)&&!_0x5350e4['typebotStatus']?(await(0x0,typebotListener_1[_0x1dec2c(0x163)])({'ticket':_0x5350e4,'msg':_0x172231,'wbot':_0x6bf129,'typebot':_0x4b61ad}),!_0x5350e4['useIntegration']&&(await _0x5350e4[_0x1dec2c(0x13e)]({'useIntegration':!![],'integrationId':_0x4b61ad['id']}),console[_0x1dec2c(0xcd)](_0x1dec2c(0xd8)+_0x5350e4['id']))):console['log'](_0x1dec2c(0x103));};exports[a588_0x27676a(0x11e)]=handleMessageIntegration;const handleMessage=async(_0x2e0209,_0x4ab7ad,_0x4ff4a7)=>{const _0x3c9af3=a588_0x27676a;if(!isValidMsg(_0x2e0209))return;_0x2e0209[_0x3c9af3(0x139)]?.['ephemeralMessage']&&(_0x2e0209[_0x3c9af3(0x139)]=_0x2e0209['message'][_0x3c9af3(0x194)][_0x3c9af3(0x139)]);try{let _0x5c2793,_0x5042c5;const _0x32f1ac=_0x2e0209[_0x3c9af3(0x119)][_0x3c9af3(0x1a7)]?.[_0x3c9af3(0x198)](_0x3c9af3(0xb4)),_0x15727e=_0x2e0209['key'][_0x3c9af3(0x1a7)]?.[_0x3c9af3(0x198)](_0x3c9af3(0x1a0)),_0xa05923=_0x2e0209[_0x3c9af3(0x119)][_0x3c9af3(0x1a7)]===_0x3c9af3(0xb1);if(_0xa05923){logger_1[_0x3c9af3(0x1b1)][_0x3c9af3(0xf1)](_0x3c9af3(0xc1)+_0x2e0209[_0x3c9af3(0x119)]['participant']);return;}if(_0x15727e){logger_1['logger'][_0x3c9af3(0xd5)](_0x3c9af3(0xda)+_0x2e0209[_0x3c9af3(0x119)][_0x3c9af3(0x1a7)]);return;}if(_0x32f1ac){const _0x4368bf=await Setting_1[_0x3c9af3(0x163)][_0x3c9af3(0xfd)]({'where':{'companyId':_0x4ff4a7,'key':_0x3c9af3(0x126)}});if(!_0x4368bf||_0x4368bf[_0x3c9af3(0x130)]==='enabled')return;}const _0x3b1bd4=(0x0,GetHandlers_1[_0x3c9af3(0xe6)])(_0x2e0209),_0x1e8671=(0x0,GetHandlers_1[_0x3c9af3(0x171)])(_0x2e0209),_0x32ef99=_0x1e8671!==_0x3c9af3(0xc3)&&(0x0,GetHandlers_1['getUnpackedMessage'])(_0x2e0209),_0x2b4fa4=_0x32ef99&&(0x0,GetHandlers_1[_0x3c9af3(0x137)])(_0x32ef99);if(_0x2e0209[_0x3c9af3(0x119)][_0x3c9af3(0x12d)]){if(_0x3b1bd4?.[_0x3c9af3(0x182)]('‎'))return;if(!_0x2b4fa4&&_0x1e8671!==_0x3c9af3(0x140)&&_0x1e8671!==_0x3c9af3(0x15a)&&_0x1e8671!==_0x3c9af3(0x170))return;_0x5c2793=await(0x0,GetHandlers_1['getContactMessage'])(_0x2e0209,_0x4ab7ad);}else _0x5c2793=await(0x0,GetHandlers_1[_0x3c9af3(0x14f)])(_0x2e0209,_0x4ab7ad);_0x32f1ac&&(_0x5042c5=await wbotMutex['runExclusive'](async()=>{const _0x4b9962=_0x3c9af3;let _0x5806f1=groupContactCache[_0x4b9962(0xbe)](_0x2e0209['key']['remoteJid']);if(!_0x5806f1){const _0x4833c2=await _0x4ab7ad['groupMetadata'](_0x2e0209[_0x4b9962(0x119)][_0x4b9962(0x1a7)]),_0x57a992={'id':_0x4833c2['id'],'name':_0x4833c2[_0x4b9962(0x16f)]};_0x5806f1=await(0x0,VerifyHandlers_1[_0x4b9962(0xe1)])(_0x57a992,_0x4ab7ad,_0x4ff4a7),groupContactCache['set'](_0x2e0209[_0x4b9962(0x119)][_0x4b9962(0x1a7)],_0x5806f1);}return _0x5806f1;}));const _0x12fe67=await(0x0,ShowWhatsAppService_1['default'])(_0x4ab7ad['id'],_0x4ff4a7),_0x5ee685=_0x2e0209[_0x3c9af3(0x119)],_0x3b17cf=_0x5ee685['senderPn']||_0x5ee685[_0x3c9af3(0x142)],_0x586d6f=await(0x0,VerifyHandlers_1[_0x3c9af3(0xe1)])(_0x5c2793,_0x4ab7ad,_0x4ff4a7,_0x3b17cf);let _0x2e2a51=_0x586d6f;if(!_0x2e0209[_0x3c9af3(0x119)]['fromMe']){const _0x24ad7e=_0x2e0209['key'],_0x2d52d3=_0x2e0209[_0x3c9af3(0x119)][_0x3c9af3(0x1a7)],_0x4baef3=_0x24ad7e[_0x3c9af3(0x142)];let _0x1a9150=null,_0x4cea01=![];if(_0x2d52d3?.[_0x3c9af3(0x125)](_0x3c9af3(0x141)))_0x1a9150=_0x2d52d3,_0x4cea01=_0x586d6f[_0x3c9af3(0x190)][_0x3c9af3(0xeb)]>0xd;else _0x2d52d3?.[_0x3c9af3(0x125)](_0x3c9af3(0xc6))&&_0x4baef3?.[_0x3c9af3(0x125)]('@s.whatsapp.net')&&(_0x1a9150=_0x4baef3,_0x4cea01=!![]);if(_0x1a9150&&_0x4cea01){const _0x231031=_0x1a9150[_0x3c9af3(0x132)]('@')[0x0],_0x556703=await Contact_1[_0x3c9af3(0x163)][_0x3c9af3(0xfd)]({'where':{'number':_0x231031,'companyId':_0x586d6f[_0x3c9af3(0x16c)]}});if(_0x556703&&_0x556703['id']!==_0x586d6f['id']){_0x2e2a51=_0x556703;const _0x34efb2=_0x2d52d3?.[_0x3c9af3(0x125)](_0x3c9af3(0xc6))?_0x2d52d3:_0x4baef3,_0x4d53f6=_0x34efb2?.[_0x3c9af3(0x132)]('@')[0x0],_0x548791={};_0x4d53f6&&!_0x556703['lid']&&(_0x548791['lid']=_0x4d53f6);_0x1a9150&&!_0x556703['remoteJid']&&(_0x548791[_0x3c9af3(0x1a7)]=_0x1a9150);const _0x500b03=!_0x556703[_0x3c9af3(0xe5)]||_0x556703['profilePicUrl']===''||_0x556703[_0x3c9af3(0xe5)]===process[_0x3c9af3(0x14b)][_0x3c9af3(0x11a)]+_0x3c9af3(0x16d);_0x500b03&&_0x586d6f[_0x3c9af3(0xe5)]&&_0x586d6f['profilePicUrl']!==process[_0x3c9af3(0x14b)][_0x3c9af3(0x11a)]+'/nopicture.png'&&(_0x548791[_0x3c9af3(0xe5)]=_0x586d6f['profilePicUrl']);Object[_0x3c9af3(0x15e)](_0x548791)[_0x3c9af3(0xeb)]>0x0&&await _0x556703[_0x3c9af3(0x13e)](_0x548791);const _0x4b87ac=await Ticket_1[_0x3c9af3(0x163)][_0x3c9af3(0xd7)]({'where':{'contactId':_0x586d6f['id']}});_0x4b87ac===0x0&&await _0x586d6f[_0x3c9af3(0x14c)]();}else!_0x556703&&(await _0x586d6f[_0x3c9af3(0x13e)]({'number':_0x231031,'remoteJid':_0x1a9150}),_0x2e2a51=_0x586d6f);}}let _0xea6a9a=0x0;if(_0x2e0209[_0x3c9af3(0x119)]['fromMe'])await cache_1[_0x3c9af3(0x19f)][_0x3c9af3(0x10b)]('contacts:'+_0x2e2a51['id']+_0x3c9af3(0xd3),'0');else{const _0x4690b1=await cache_1[_0x3c9af3(0x19f)][_0x3c9af3(0xbe)](_0x3c9af3(0x157)+_0x2e2a51['id']+_0x3c9af3(0xd3));_0xea6a9a=+_0x4690b1+0x1,await cache_1[_0x3c9af3(0x19f)][_0x3c9af3(0x10b)](_0x3c9af3(0x157)+_0x2e2a51['id']+_0x3c9af3(0xd3),''+_0xea6a9a);}const _0x46f349=await Message_1[_0x3c9af3(0x163)]['findOne']({'where':{'contactId':_0x2e2a51['id'],'companyId':_0x4ff4a7,'$ticket.whatsappId$':_0x12fe67['id']},'include':[_0x3c9af3(0xb7)],'order':[[_0x3c9af3(0x1ac),_0x3c9af3(0x12f)]]}),_0x40f6c5=_0x12fe67['complationMessage'][_0x3c9af3(0x16b)]()||_0x3c9af3(0xb9);if(_0x46f349&&_0xea6a9a===0x0&&_0x40f6c5&&(0x0,Mustache_1[_0x3c9af3(0x163)])(_0x40f6c5,_0x46f349[_0x3c9af3(0xb7)])[_0x3c9af3(0x16b)]()[_0x3c9af3(0x12e)]()===_0x46f349?.[_0x3c9af3(0xe3)][_0x3c9af3(0x16b)]()['toLowerCase']())return;if(!_0x2e0209[_0x3c9af3(0x119)][_0x3c9af3(0x12d)]&&!_0x2e2a51['isGroup']){if(_0x12fe67[_0x3c9af3(0xbf)]){const _0x1d5132=await TicketTraking_1['default'][_0x3c9af3(0xfd)]({'where':{'whatsappId':_0x12fe67['id'],'rated':![],'ratingAt':{[sequelize_1['Op'][_0x3c9af3(0x145)]]:null},'finishedAt':null},'include':[{'model':Ticket_1[_0x3c9af3(0x163)],'where':{'status':_0x3c9af3(0xfc),'contactId':_0x2e2a51['id']},'include':[{'model':Contact_1[_0x3c9af3(0x163)]},{'model':User_1['default']},{'model':Queue_1['default']}]}]});if(_0x1d5132)try{const _0x277ca4=Number(_0x3b1bd4);if(!Number['isFinite'](_0x277ca4)){const _0x4b0aef=(0x0,Debounce_1[_0x3c9af3(0x144)])(async()=>{const _0x3c941a=_0x3c9af3,_0x2aa23d=_0x12fe67['ratingMessage']?.[_0x3c941a(0x16b)]()||'Por\x20favor\x20avalie\x20nosso\x20atendimento';await(0x0,SendWhatsAppMessage_1[_0x3c941a(0x163)])({'ticket':_0x1a0813,'body':'\x0a*'+_0x2aa23d+'*'});},0x3e8,_0x1d5132[_0x3c9af3(0xb7)]['id']);_0x4b0aef();return;}if((0x0,VerifyHandlers_1['verifyRating'])(_0x1d5132)){(0x0,exports['handleRating'])(_0x2e0209,_0x1d5132['ticket'],_0x1d5132);return;}}catch(_0x13115d){Sentry[_0x3c9af3(0xf3)](_0x13115d),console[_0x3c9af3(0xcd)]('Erro\x20ao\x20processar\x20avaliação:',_0x13115d);}}}const {ticket:_0x1a0813,justCreated:_0x16b57a}=await(0x0,FindOrCreateTicketService_1['default'])(_0x2e2a51,_0x4ab7ad['id'],_0xea6a9a,_0x4ff4a7,_0x5042c5);if(_0x2b4fa4||_0x2e0209?.['message']?.[_0x3c9af3(0x15a)]?.['thumbnailDirectPath'])await(0x0,VerifyHandlers_1[_0x3c9af3(0xf9)])(_0x2e0209,_0x1a0813,_0x2e2a51,_0x4ab7ad,_0x2b4fa4);else{if(_0x2e0209[_0x3c9af3(0x139)]?.[_0x3c9af3(0xc7)]?.[_0x3c9af3(0x139)]?.['protocolMessage']?.[_0x3c9af3(0xc7)])await(0x0,VerifyHandlers_1[_0x3c9af3(0x17c)])(_0x2e0209[_0x3c9af3(0x139)][_0x3c9af3(0xc7)][_0x3c9af3(0x139)]['protocolMessage'][_0x3c9af3(0xc7)],_0x1a0813,_0x2e0209[_0x3c9af3(0x139)][_0x3c9af3(0xc7)]['message'][_0x3c9af3(0x1a2)][_0x3c9af3(0x119)]['id']);else{if(_0x2e0209[_0x3c9af3(0x139)]?.[_0x3c9af3(0x1a2)]?.[_0x3c9af3(0xc7)])await(0x0,VerifyHandlers_1[_0x3c9af3(0x17c)])(_0x2e0209[_0x3c9af3(0x139)]['protocolMessage'][_0x3c9af3(0xc7)],_0x1a0813,_0x2e0209[_0x3c9af3(0x139)]['protocolMessage'][_0x3c9af3(0x119)]['id']);else _0x2e0209['message']?.[_0x3c9af3(0x1a2)]?.[_0x3c9af3(0xb2)]===0x0?await(0x0,VerifyHandlers_1['verifyDeleteMessage'])(_0x2e0209[_0x3c9af3(0x139)]['protocolMessage'],_0x1a0813):await(0x0,VerifyHandlers_1[_0x3c9af3(0xca)])(_0x2e0209,_0x1a0813,_0x2e2a51,null,_0x4ab7ad);}}if(_0x1a0813[_0x3c9af3(0x168)]===!![]&&_0x1a0813[_0x3c9af3(0x184)]){const _0x29fd37=await(0x0,ShowQueueIntegrationService_1[_0x3c9af3(0x163)])(_0x1a0813['integrationId'],_0x4ff4a7);if(_0x29fd37){await(0x0,exports[_0x3c9af3(0x11e)])(_0x2e0209,_0x4ab7ad,_0x29fd37,_0x1a0813);return;}else await _0x1a0813[_0x3c9af3(0x13e)]({'useIntegration':![],'integrationId':null,'typebotSessionId':null});}if(_0x3b1bd4==='#'&&!_0x32f1ac){await _0x1a0813[_0x3c9af3(0x13e)]({'queueOptionId':null,'chatbot':![],'queueId':null}),await(0x0,VerifyHandlers_1['verifyQueue'])(_0x4ab7ad,_0x2e0209,_0x1a0813,_0x1a0813[_0x3c9af3(0xd9)]);return;}if(_0x32f1ac||_0x2e2a51[_0x3c9af3(0xfb)])return;const _0x4ba75c=await(0x0,CheckSettings_1['GetCompanySetting'])(_0x4ff4a7,'scheduleType',_0x3c9af3(0x127));try{if(!_0x2e0209[_0x3c9af3(0x119)][_0x3c9af3(0x12d)]&&_0x4ba75c){const _0xb63234=await(0x0,CheckSettings_1[_0x3c9af3(0x17b)])(_0x4ff4a7,_0x3c9af3(0xfe),_0x3c9af3(0x166));let _0x51d062=null;const _0x5a401c=_0x1a0813[_0x3c9af3(0x181)]===_0x3c9af3(0xfc)&&_0x1a0813[_0x3c9af3(0x1ae)][_0x3c9af3(0xb6)][_0x3c9af3(0xeb)]>0x0,_0x59cafe=!_0x5a401c&&outOfHoursCache[_0x3c9af3(0xbe)](_0x3c9af3(0x12c)+_0x1a0813['id']);if(_0x4ba75c==='company'&&!_0x5a401c){_0x51d062=await(0x0,VerifyCurrentSchedule_1['default'])(_0x4ff4a7),console[_0x3c9af3(0xcd)](_0x3c9af3(0x143),{'currentSchedule':_0x51d062,'isInActivity':_0x51d062?.['inActivity']});if(_0x51d062&&_0x51d062[_0x3c9af3(0x109)]===![]){if(!_0x59cafe){outOfHoursCache[_0x3c9af3(0x10b)]('ticket-'+_0x1a0813['id'],!![]);const _0x1442fc=_0x12fe67['outOfHoursMessage'][_0x3c9af3(0x16b)]()||_0x3c9af3(0x1b4);await(0x0,SendWhatsAppMessage_1[_0x3c9af3(0x163)])({'ticket':_0x1a0813,'body':_0x1442fc});}_0x1a0813[_0x3c9af3(0x181)]!==_0x3c9af3(0xfc)&&await(0x0,UpdateTicketService_1[_0x3c9af3(0x163)])({'ticketData':{'chatbot':![],'status':_0xb63234},'ticketId':_0x1a0813['id'],'companyId':_0x1a0813['companyId']});return;}}if(_0x4ba75c===_0x3c9af3(0x10e)&&_0x1a0813[_0x3c9af3(0x191)]!==null&&!_0x5a401c){_0x51d062=await(0x0,VerifyCurrentSchedule_1[_0x3c9af3(0x163)])(_0x4ff4a7,_0x1a0813['queueId']);const _0x1967fe=await Queue_1[_0x3c9af3(0x163)][_0x3c9af3(0xea)](_0x1a0813[_0x3c9af3(0x191)]);if(!(0x0,lodash_1[_0x3c9af3(0x176)])(_0x51d062)&&(!_0x51d062||_0x51d062['inActivity']===![])){if(!_0x59cafe){outOfHoursCache['set']('ticket-'+_0x1a0813['id'],!![]);const _0x5a0343=_0x1967fe[_0x3c9af3(0x13c)]?.[_0x3c9af3(0x16b)]()||'Estamos\x20fora\x20do\x20horário\x20de\x20expediente';await(0x0,SendWhatsAppMessage_1[_0x3c9af3(0x163)])({'ticket':_0x1a0813,'body':_0x5a0343});}_0x1a0813[_0x3c9af3(0x181)]!==_0x3c9af3(0xfc)&&await(0x0,UpdateTicketService_1['default'])({'ticketData':{'chatbot':![],'status':_0xb63234},'ticketId':_0x1a0813['id'],'companyId':_0x1a0813['companyId']});return;}}}}catch(_0x2abb41){Sentry[_0x3c9af3(0xf3)](_0x2abb41),console[_0x3c9af3(0xcd)](_0x3c9af3(0x167),_0x2abb41);}!_0x1a0813['queue']&&!_0x32f1ac&&!_0x2e0209['key']['fromMe']&&!_0x1a0813[_0x3c9af3(0x15f)]&&_0x12fe67[_0x3c9af3(0x105)]['length']>=0x1&&await(0x0,VerifyHandlers_1[_0x3c9af3(0x122)])(_0x4ab7ad,_0x2e0209,_0x1a0813,_0x1a0813['contact']);const _0x1f4835=_0x1a0813[_0x3c9af3(0x10e)]===null;await _0x1a0813[_0x3c9af3(0x15d)]();if(_0x16b57a&&!_0x12fe67?.[_0x3c9af3(0x105)]?.['length']&&!_0x1a0813[_0x3c9af3(0x15f)]&&!_0x32f1ac&&!_0x2e0209['key'][_0x3c9af3(0x12d)]){const _0x4ebe8d=await Message_1[_0x3c9af3(0x163)][_0x3c9af3(0xfd)]({'where':{'ticketId':_0x1a0813['id'],'fromMe':!![]},'order':[[_0x3c9af3(0x1ac),_0x3c9af3(0x12f)]]});if(_0x4ebe8d&&_0x4ebe8d[_0x3c9af3(0xe3)][_0x3c9af3(0x125)](_0x12fe67[_0x3c9af3(0x197)]))return;if(_0x12fe67[_0x3c9af3(0x197)]){const _0x74caee=(0x0,Debounce_1[_0x3c9af3(0x144)])(async()=>{const _0x32a148=_0x3c9af3;await(0x0,SendWhatsAppMessage_1['default'])({'ticket':_0x1a0813,'body':''+_0x12fe67[_0x32a148(0x197)]});},0x3e8,_0x1a0813['id']);_0x74caee();return;}}if(!_0x1a0813[_0x3c9af3(0x121)]&&_0x1a0813[_0x3c9af3(0xbb)]>=_0x12fe67?.[_0x3c9af3(0xec)])return;if(_0x1a0813[_0x3c9af3(0x121)]&&!_0x2e0209[_0x3c9af3(0x119)][_0x3c9af3(0x12d)]){await handleChartbot(_0x1a0813,_0x2e0209,_0x4ab7ad);return;}_0x12fe67[_0x3c9af3(0x105)][_0x3c9af3(0xeb)]===0x1&&_0x1a0813[_0x3c9af3(0x10e)]&&(_0x1a0813[_0x3c9af3(0x121)]&&!_0x2e0209[_0x3c9af3(0x119)][_0x3c9af3(0x12d)]&&!_0x1a0813[_0x3c9af3(0x168)]&&await handleChartbot(_0x1a0813,_0x2e0209,_0x4ab7ad,_0x1f4835)),_0x12fe67[_0x3c9af3(0x105)][_0x3c9af3(0xeb)]>0x1&&_0x1a0813['queue']&&(_0x1a0813[_0x3c9af3(0x121)]&&!_0x2e0209[_0x3c9af3(0x119)][_0x3c9af3(0x12d)]&&!_0x1a0813[_0x3c9af3(0x168)]&&await handleChartbot(_0x1a0813,_0x2e0209,_0x4ab7ad,_0x1f4835));}catch(_0x47e090){Sentry['captureException'](_0x47e090),logger_1[_0x3c9af3(0x1b1)][_0x3c9af3(0xfa)](_0x3c9af3(0x155)+_0x47e090);}};exports[a588_0x27676a(0xc5)]=handleMessage;const handleMsgAck=async(_0x33e8aa,_0x2cc1fa)=>{const _0x10a3b7=a588_0x27676a;if(!_0x2cc1fa)return;const _0x9401b5=(0x0,socket_1[_0x10a3b7(0x17e)])();try{const _0xc59d40=await Message_1['default'][_0x10a3b7(0xea)](_0x33e8aa[_0x10a3b7(0x119)]['id'],{'include':[_0x10a3b7(0xd9),{'model':Message_1[_0x10a3b7(0x163)],'as':'quotedMsg','include':[_0x10a3b7(0xd9)]}]});if(!_0xc59d40||_0x2cc1fa<=_0xc59d40[_0x10a3b7(0x189)])return;await _0xc59d40['update']({'ack':_0x2cc1fa}),_0x9401b5['to'](_0xc59d40[_0x10a3b7(0x18f)][_0x10a3b7(0xef)]())[_0x10a3b7(0x17a)]('company-'+_0xc59d40[_0x10a3b7(0x16c)]+_0x10a3b7(0xe4),{'action':'update','message':_0xc59d40});}catch(_0x50257c){Sentry['captureException'](_0x50257c),logger_1['logger']['error'](_0x10a3b7(0xff)+_0x50257c);}},filterMessages=_0x2d9017=>{const _0xc80c39=a588_0x27676a;if(_0x2d9017['key'][_0xc80c39(0x1a7)]===_0xc80c39(0xb1))return![];if(_0x2d9017[_0xc80c39(0x119)]['remoteJid']?.[_0xc80c39(0x198)](_0xc80c39(0x1a0)))return![];if(_0x2d9017[_0xc80c39(0x139)]?.[_0xc80c39(0x1a2)]?.[_0xc80c39(0xc7)])return!![];if(_0x2d9017[_0xc80c39(0x139)]?.[_0xc80c39(0x1a2)]?.['type']===0x0)return!![];if(_0x2d9017[_0xc80c39(0x139)]?.[_0xc80c39(0x1a2)])return![];if([baileys_1['WAMessageStubType'][_0xc80c39(0xd4)],baileys_1[_0xc80c39(0x169)][_0xc80c39(0x11d)],baileys_1['WAMessageStubType'][_0xc80c39(0x17d)],baileys_1['WAMessageStubType']['CIPHERTEXT']][_0xc80c39(0x125)](_0x2d9017[_0xc80c39(0x136)]))return![];return!![];},wbotMessageListener=async(_0x14131d,_0x51ceb3)=>{const _0x376c47=a588_0x27676a;try{_0x14131d['ev']['on']('messages.upsert',async _0x5462e4=>{const _0x214ac0=a588_0x1b85,_0x17fdd4=_0x5462e4['messages'][_0x214ac0(0x138)](filterMessages)[_0x214ac0(0x16a)](_0x1f8937=>_0x1f8937);if(!_0x17fdd4)return;_0x17fdd4[_0x214ac0(0x19d)](async _0x4fcf92=>{const _0x4df295=_0x214ac0;try{const _0x58d057=await Message_1['default'][_0x4df295(0xd7)]({'where':{'id':_0x4fcf92[_0x4df295(0x119)]['id'],'companyId':_0x51ceb3}});if(!_0x58d057){if(await(0x0,VerifyHandlers_1[_0x4df295(0x180)])(_0x4fcf92,_0x51ceb3))return;await handleMessage(_0x4fcf92,_0x14131d,_0x51ceb3);}}catch(_0x40e64e){if(_0x40e64e[_0x4df295(0x139)]?.[_0x4df295(0x125)]('serialized\x20is\x20not\x20iterable')||_0x40e64e['message']?.[_0x4df295(0x125)](_0x4df295(0xc9))){logger_1['logger'][_0x4df295(0xf1)](_0x4df295(0x129)+_0x4fcf92[_0x4df295(0x119)]['id']+_0x4df295(0xe2)+_0x4fcf92[_0x4df295(0x119)][_0x4df295(0x1a7)]+':\x20'+_0x40e64e[_0x4df295(0x139)]);return;}Sentry[_0x4df295(0xf3)](_0x40e64e),logger_1[_0x4df295(0x1b1)][_0x4df295(0xfa)](_0x4df295(0x10d)+_0x4fcf92[_0x4df295(0x119)]['id']+':\x20'+_0x40e64e);}});}),_0x14131d['ev']['on']('messages.update',_0x33d59b=>{const _0x26bdc2=a588_0x1b85;if(_0x33d59b[_0x26bdc2(0xeb)]===0x0)return;_0x33d59b[_0x26bdc2(0x19d)](async _0x582146=>{const _0x54ec86=_0x26bdc2;_0x14131d[_0x54ec86(0x18c)]([_0x582146[_0x54ec86(0x119)]]),await ackMutex[_0x54ec86(0x1a3)](async()=>{const _0x3779b7=_0x54ec86;handleMsgAck(_0x582146,_0x582146['update'][_0x3779b7(0x181)]);});});});}catch(_0x28135c){Sentry[_0x376c47(0xf3)](_0x28135c),logger_1['logger'][_0x376c47(0xfa)]('Error\x20handling\x20wbot\x20message\x20listener.\x20Err:\x20'+_0x28135c);}};exports[a588_0x27676a(0x18a)]=wbotMessageListener;