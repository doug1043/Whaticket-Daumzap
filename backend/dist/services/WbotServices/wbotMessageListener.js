const a558_0xd5cd7b=a558_0x94d3;(function(_0x7d932f,_0x1429df){const _0x51517d=a558_0x94d3,_0x52b43d=_0x7d932f();while(!![]){try{const _0x22ae10=-parseInt(_0x51517d(0x27e))/0x1*(parseInt(_0x51517d(0x14f))/0x2)+parseInt(_0x51517d(0x240))/0x3*(parseInt(_0x51517d(0x14b))/0x4)+parseInt(_0x51517d(0x261))/0x5*(parseInt(_0x51517d(0x29d))/0x6)+parseInt(_0x51517d(0x16e))/0x7+parseInt(_0x51517d(0x1f8))/0x8*(-parseInt(_0x51517d(0x28a))/0x9)+-parseInt(_0x51517d(0x193))/0xa*(parseInt(_0x51517d(0x250))/0xb)+parseInt(_0x51517d(0x2f2))/0xc*(-parseInt(_0x51517d(0x2f7))/0xd);if(_0x22ae10===_0x1429df)break;else _0x52b43d['push'](_0x52b43d['shift']());}catch(_0x4824cf){_0x52b43d['push'](_0x52b43d['shift']());}}}(a558_0x376e,0xaa6a1));const a558_0x2402d0=(function(){let _0x52c49e=!![];return function(_0x336730,_0x440e6a){const _0x29925a=_0x52c49e?function(){if(_0x440e6a){const _0x931095=_0x440e6a['apply'](_0x336730,arguments);return _0x440e6a=null,_0x931095;}}:function(){};return _0x52c49e=![],_0x29925a;};}()),a558_0x24a7a6=a558_0x2402d0(this,function(){const _0x35c956=a558_0x94d3;return a558_0x24a7a6[_0x35c956(0x2ce)]()[_0x35c956(0x165)](_0x35c956(0x231))[_0x35c956(0x2ce)]()[_0x35c956(0x204)](a558_0x24a7a6)['search'](_0x35c956(0x231));});a558_0x24a7a6();'use strict';var __createBinding=this&&this[a558_0xd5cd7b(0x21b)]||(Object[a558_0xd5cd7b(0x205)]?function(_0x41050e,_0x213cd5,_0x412c5e,_0x470c7b){const _0x37df58=a558_0xd5cd7b;if(_0x470c7b===undefined)_0x470c7b=_0x412c5e;var _0x29f3ce=Object[_0x37df58(0x2e9)](_0x213cd5,_0x412c5e);(!_0x29f3ce||(_0x37df58(0x176)in _0x29f3ce?!_0x213cd5[_0x37df58(0x2ca)]:_0x29f3ce[_0x37df58(0x1fe)]||_0x29f3ce[_0x37df58(0x264)]))&&(_0x29f3ce={'enumerable':!![],'get':function(){return _0x213cd5[_0x412c5e];}}),Object[_0x37df58(0x287)](_0x41050e,_0x470c7b,_0x29f3ce);}:function(_0x362880,_0x4b0863,_0x34fc17,_0x48e2d4){if(_0x48e2d4===undefined)_0x48e2d4=_0x34fc17;_0x362880[_0x48e2d4]=_0x4b0863[_0x34fc17];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x5cc6a1,_0x1df97e){const _0x4f6ed9=a558_0xd5cd7b;Object[_0x4f6ed9(0x287)](_0x5cc6a1,_0x4f6ed9(0x16c),{'enumerable':!![],'value':_0x1df97e});}:function(_0x262416,_0x88214c){const _0x589705=a558_0xd5cd7b;_0x262416[_0x589705(0x16c)]=_0x88214c;}),__importStar=this&&this[a558_0xd5cd7b(0x1ba)]||function(_0x2472c0){const _0x276504=a558_0xd5cd7b;if(_0x2472c0&&_0x2472c0[_0x276504(0x2ca)])return _0x2472c0;var _0x391c20={};if(_0x2472c0!=null){for(var _0x345511 in _0x2472c0)if(_0x345511!==_0x276504(0x16c)&&Object['prototype'][_0x276504(0x14c)][_0x276504(0x239)](_0x2472c0,_0x345511))__createBinding(_0x391c20,_0x2472c0,_0x345511);}return __setModuleDefault(_0x391c20,_0x2472c0),_0x391c20;},__importDefault=this&&this[a558_0xd5cd7b(0x252)]||function(_0x304af0){const _0x192c08=a558_0xd5cd7b;return _0x304af0&&_0x304af0[_0x192c08(0x2ca)]?_0x304af0:{'default':_0x304af0};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a558_0xd5cd7b(0x1b6)]=exports[a558_0xd5cd7b(0x257)]=exports[a558_0xd5cd7b(0x2cb)]=exports[a558_0xd5cd7b(0x185)]=exports['handleMessage']=exports[a558_0xd5cd7b(0x2a3)]=exports[a558_0xd5cd7b(0x308)]=exports[a558_0xd5cd7b(0x1d7)]=exports[a558_0xd5cd7b(0x2e0)]=exports['verifyMessage']=exports[a558_0xd5cd7b(0x216)]=exports['getQuotedMessageId']=exports['getQuotedMessage']=exports[a558_0xd5cd7b(0x17d)]=exports[a558_0xd5cd7b(0x162)]=exports['sendMessageLink']=exports[a558_0xd5cd7b(0x2f1)]=exports[a558_0xd5cd7b(0x2c9)]=exports[a558_0xd5cd7b(0x192)]=exports[a558_0xd5cd7b(0x2b8)]=exports['isNumeric']=void 0x0;const path_1=__importStar(require(a558_0xd5cd7b(0x23e))),util_1=require(a558_0xd5cd7b(0x280)),fs_1=require('fs'),Sentry=__importStar(require(a558_0xd5cd7b(0x26c))),lodash_1=require('lodash'),baileys_1=require('@whiskeysockets/baileys'),MessageUtils=__importStar(require('./wbotGetMessageFromType')),stream_throttle_1=require(a558_0xd5cd7b(0x174)),Contact_1=__importDefault(require(a558_0xd5cd7b(0x2f8))),Ticket_1=__importDefault(require('../../models/Ticket')),Message_1=__importDefault(require(a558_0xd5cd7b(0x164))),OldMessage_1=__importDefault(require(a558_0xd5cd7b(0x236))),socket_1=require(a558_0xd5cd7b(0x1b9)),CreateMessageService_1=__importDefault(require(a558_0xd5cd7b(0x18f))),logger_1=require('../../utils/logger'),CreateOrUpdateContactService_1=__importDefault(require('../ContactServices/CreateOrUpdateContactService')),FindOrCreateTicketService_1=__importDefault(require(a558_0xd5cd7b(0x2cd))),ShowWhatsAppService_1=__importDefault(require(a558_0xd5cd7b(0x1be))),UpdateTicketService_1=__importDefault(require('../TicketServices/UpdateTicketService')),Mustache_1=__importDefault(require('../../helpers/Mustache')),UserRating_1=__importDefault(require(a558_0xd5cd7b(0x2d6))),SendWhatsAppMessage_1=__importDefault(require(a558_0xd5cd7b(0x2c5))),moment_1=__importDefault(require(a558_0xd5cd7b(0x170))),Queue_1=__importDefault(require(a558_0xd5cd7b(0x230))),QueueOption_1=__importDefault(require(a558_0xd5cd7b(0x1ee))),FindOrCreateATicketTrakingService_1=__importDefault(require('../TicketServices/FindOrCreateATicketTrakingService')),VerifyCurrentSchedule_1=__importDefault(require('../CompanyService/VerifyCurrentSchedule')),Campaign_1=__importDefault(require(a558_0xd5cd7b(0x2cc))),CampaignShipping_1=__importDefault(require('../../models/CampaignShipping')),sequelize_1=require(a558_0xd5cd7b(0x2e8)),queues_1=require(a558_0xd5cd7b(0x229)),User_1=__importDefault(require(a558_0xd5cd7b(0x2d0))),Setting_1=__importDefault(require(a558_0xd5cd7b(0x20b))),cache_1=require(a558_0xd5cd7b(0x175)),Debounce_1=require(a558_0xd5cd7b(0x201)),openai_1=require(a558_0xd5cd7b(0x14e)),fluent_ffmpeg_1=__importDefault(require(a558_0xd5cd7b(0x1bb))),microsoft_cognitiveservices_speech_sdk_1=require(a558_0xd5cd7b(0x2c8)),providers_1=require(a558_0xd5cd7b(0x2f5)),typebotListener_1=__importDefault(require(a558_0xd5cd7b(0x209))),ShowQueueIntegrationService_1=__importDefault(require('../QueueIntegrationServices/ShowQueueIntegrationService')),SendWhatsAppMedia_1=require(a558_0xd5cd7b(0x23d)),fs_2=__importDefault(require('fs')),request_1=__importDefault(require('request')),ffmpeg_static_1=__importDefault(require(a558_0xd5cd7b(0x285))),app_1=__importDefault(require(a558_0xd5cd7b(0x1ab))),mime_1=__importDefault(require(a558_0xd5cd7b(0x223))),wbot_1=require('../../libs/wbot'),SendPresenceStatus_1=require(a558_0xd5cd7b(0x150)),MakeRandomId_1=require(a558_0xd5cd7b(0x2da));fluent_ffmpeg_1[a558_0xd5cd7b(0x16c)][a558_0xd5cd7b(0x2fc)](ffmpeg_static_1['default']);const sessionsOpenAi=[],isNumeric=_0x167b3e=>/^-?\d+$/[a558_0xd5cd7b(0x1b5)](_0x167b3e);exports[a558_0xd5cd7b(0x15b)]=isNumeric;let outOfHourMessageControl=[],completionMessageControl=[],greetingMessageControl=[],farewellMessageControl=[];const writeFileAsync=(0x0,util_1[a558_0xd5cd7b(0x163)])(fs_1[a558_0xd5cd7b(0x247)]),getTypeMessage=_0x2e560e=>{const _0xb214ee=a558_0xd5cd7b;return(0x0,baileys_1[_0xb214ee(0x1e3)])(_0x2e560e[_0xb214ee(0x200)]);},removeNonPrintableChars=_0x3fbc6b=>{return _0x3fbc6b['replace'](/[\x00-\x1F\x7F-\x9F]/g,'');};exports['removeNonPrintableChars']=removeNonPrintableChars;async function getQueues(_0x151bc2){const _0x40a312=a558_0xd5cd7b;try{const _0x307b91=await Queue_1['default']['findAll']({'where':{'companyId':_0x151bc2}});return _0x307b91;}catch(_0x8a3692){return console[_0x40a312(0x160)]('Failed\x20to\x20fetch\x20queues:',_0x8a3692),[];}}async function getContactFromTicket(_0x16f766){const _0x17b001=a558_0xd5cd7b;try{const _0x11be74=await Ticket_1['default']['findByPk'](_0x16f766,{'include':[{'model':Contact_1[_0x17b001(0x16c)],'as':_0x17b001(0x241)}]});return _0x11be74&&_0x11be74['contact']?_0x11be74[_0x17b001(0x241)]:(console[_0x17b001(0x179)](_0x17b001(0x301)),null);}catch(_0x500ed8){return console[_0x17b001(0x160)]('Failed\x20to\x20fetch\x20contact\x20from\x20ticket:',_0x500ed8),null;}}function validaCpfCnpj(_0x42a178){const _0x13a4fa=a558_0xd5cd7b;if(_0x42a178[_0x13a4fa(0x1ef)]==0xb){var _0x5daf45=_0x42a178[_0x13a4fa(0x26d)]();_0x5daf45=_0x5daf45[_0x13a4fa(0x143)](/\./g,''),_0x5daf45=_0x5daf45[_0x13a4fa(0x143)]('-',''),_0x5daf45=_0x5daf45['split']('');var _0xb13b54=0x0,_0xe173ef=0x0,_0x217a45=![];for(var _0x8cd8a6=0x1;_0x5daf45[_0x13a4fa(0x1ef)]>_0x8cd8a6;_0x8cd8a6++){_0x5daf45[_0x8cd8a6-0x1]!=_0x5daf45[_0x8cd8a6]&&(_0x217a45=!![]);}if(_0x217a45==![])return![];for(var _0x8cd8a6=0x0,_0x5d59ae=0xa;_0x5daf45[_0x13a4fa(0x1ef)]-0x2>_0x8cd8a6;_0x8cd8a6++,_0x5d59ae--){_0xb13b54+=_0x5daf45[_0x8cd8a6]*_0x5d59ae;}_0xb13b54=_0xb13b54*0xa%0xb;_0xb13b54==0xa&&(_0xb13b54=0x0);if(_0xb13b54!=_0x5daf45[0x9])return![];for(var _0x8cd8a6=0x0,_0x5d59ae=0xb;_0x5daf45[_0x13a4fa(0x1ef)]-0x1>_0x8cd8a6;_0x8cd8a6++,_0x5d59ae--){_0xe173ef+=_0x5daf45[_0x8cd8a6]*_0x5d59ae;}return _0xe173ef=_0xe173ef*0xa%0xb,_0xe173ef==0xa&&(_0xe173ef=0x0),_0xe173ef!=_0x5daf45[0xa]?![]:!![];}else{if(_0x42a178[_0x13a4fa(0x1ef)]==0xe){var _0x49580e=_0x42a178[_0x13a4fa(0x26d)]();_0x49580e=_0x49580e['replace'](/\./g,''),_0x49580e=_0x49580e['replace']('-',''),_0x49580e=_0x49580e[_0x13a4fa(0x143)]('/',''),_0x49580e=_0x49580e[_0x13a4fa(0x197)]('');var _0xb13b54=0x0,_0xe173ef=0x0,_0x217a45=![];for(var _0x8cd8a6=0x1;_0x49580e['length']>_0x8cd8a6;_0x8cd8a6++){_0x49580e[_0x8cd8a6-0x1]!=_0x49580e[_0x8cd8a6]&&(_0x217a45=!![]);}if(_0x217a45==![])return![];for(var _0x8cd8a6=0x0,_0x5881b8=0x5,_0x2b2c1e=0xd;_0x49580e[_0x13a4fa(0x1ef)]-0x2>_0x8cd8a6;_0x8cd8a6++,_0x5881b8--,_0x2b2c1e--){_0x5881b8>=0x2?_0xb13b54+=_0x49580e[_0x8cd8a6]*_0x5881b8:_0xb13b54+=_0x49580e[_0x8cd8a6]*_0x2b2c1e;}_0xb13b54=_0xb13b54%0xb;_0xb13b54<0x2?_0xb13b54=0x0:_0xb13b54=0xb-_0xb13b54;if(_0xb13b54!=_0x49580e[0xc])return![];for(var _0x8cd8a6=0x0,_0x5881b8=0x6,_0x2b2c1e=0xe;_0x49580e[_0x13a4fa(0x1ef)]-0x1>_0x8cd8a6;_0x8cd8a6++,_0x5881b8--,_0x2b2c1e--){_0x5881b8>=0x2?_0xe173ef+=_0x49580e[_0x8cd8a6]*_0x5881b8:_0xe173ef+=_0x49580e[_0x8cd8a6]*_0x2b2c1e;}return _0xe173ef=_0xe173ef%0xb,_0xe173ef<0x2?_0xe173ef=0x0:_0xe173ef=0xb-_0xe173ef,_0xe173ef!=_0x49580e[0xd]?![]:!![];}else return![];}}exports[a558_0xd5cd7b(0x192)]=validaCpfCnpj;function timeout(_0x5cef56){return new Promise(_0x42fdc6=>setTimeout(_0x42fdc6,_0x5cef56));}async function sleep(_0x3d0943){await timeout(_0x3d0943);}exports['sleep']=sleep;const sendMessageImage=async(_0x96faf3,_0x2d8e0b,_0x1a1554,_0x3f64d4,_0x1fd3d7)=>{const _0x5233a4=a558_0xd5cd7b;let _0x3a55f2;try{_0x3a55f2=await _0x96faf3['sendMessage'](_0x2d8e0b[_0x5233a4(0x20f)]+'@'+(_0x1a1554[_0x5233a4(0x16a)]?_0x5233a4(0x141):_0x5233a4(0x1a2)),{'image':_0x3f64d4?{'url':_0x3f64d4}:fs_2[_0x5233a4(0x16c)]['readFileSync'](_0x5233a4(0x233)+_0x1fd3d7+'-'+makeid(0xa)),'fileName':_0x1fd3d7,'caption':_0x1fd3d7,'mimetype':_0x5233a4(0x13f)});}catch(_0x490d92){_0x3a55f2=await _0x96faf3[_0x5233a4(0x214)](_0x2d8e0b[_0x5233a4(0x20f)]+'@'+(_0x1a1554[_0x5233a4(0x16a)]?_0x5233a4(0x141):_0x5233a4(0x1a2)),{'text':(0x0,Mustache_1['default'])(_0x5233a4(0x20e),_0x1a1554)});}(0x0,exports['verifyMessage'])(_0x3a55f2,_0x1a1554,_0x2d8e0b);};exports[a558_0xd5cd7b(0x2f1)]=sendMessageImage;const sendMessageLink=async(_0x718128,_0x35d244,_0x410d36,_0x47c82d,_0x3033fb)=>{const _0x24212d=a558_0xd5cd7b;let _0x55a755;try{_0x55a755=await _0x718128[_0x24212d(0x214)](_0x35d244[_0x24212d(0x20f)]+'@'+(_0x410d36['isGroup']?_0x24212d(0x141):'s.whatsapp.net'),{'document':_0x47c82d?{'url':_0x47c82d}:fs_2[_0x24212d(0x16c)][_0x24212d(0x28d)]('public/temp/'+_0x3033fb+'-'+makeid(0xa)),'fileName':_0x3033fb,'caption':_0x3033fb,'mimetype':_0x24212d(0x1ac)});}catch(_0xad78f2){_0x55a755=await _0x718128[_0x24212d(0x214)](_0x35d244['number']+'@'+(_0x410d36[_0x24212d(0x16a)]?_0x24212d(0x141):_0x24212d(0x1a2)),{'text':(0x0,Mustache_1[_0x24212d(0x16c)])('Não\x20consegui\x20enviar\x20o\x20PDF,\x20tente\x20novamente!',_0x410d36)});}(0x0,exports[_0x24212d(0x286)])(_0x55a755,_0x410d36,_0x35d244);};exports[a558_0xd5cd7b(0x2a5)]=sendMessageLink;function makeid(_0xb1cea1){const _0x2ce48f=a558_0xd5cd7b;var _0x1310e3='',_0x4b7b7=_0x2ce48f(0x167),_0x40625b=_0x4b7b7['length'];for(var _0x138fa7=0x0;_0x138fa7<_0xb1cea1;_0x138fa7++){_0x1310e3+=_0x4b7b7[_0x2ce48f(0x155)](Math[_0x2ce48f(0x246)](Math[_0x2ce48f(0x1ea)]()*_0x40625b));}return _0x1310e3;}exports['makeid']=makeid;const msgLocation=(_0x447a33,_0x19e0cc,_0x3cf8ab)=>{const _0x5aa686=a558_0xd5cd7b;if(_0x447a33){var _0x4f0a1f=Buffer[_0x5aa686(0x1e1)](_0x447a33)[_0x5aa686(0x2ce)](_0x5aa686(0x224));let _0x4dd0c7=_0x5aa686(0x291)+_0x4f0a1f+'\x20|\x20https://maps.google.com/maps?q='+_0x19e0cc+'%2C'+_0x3cf8ab+_0x5aa686(0x153)+_0x19e0cc+',\x20'+_0x3cf8ab+'\x20';return _0x4dd0c7;}},getBodyMessage=_0x50d313=>{const _0x4ca4c0=a558_0xd5cd7b;try{let _0x21b37a=getTypeMessage(_0x50d313);const _0x2fb7cd={'conversation':MessageUtils[_0x4ca4c0(0x228)](_0x50d313),'editedMessage':_0x50d313?.[_0x4ca4c0(0x200)]?.[_0x4ca4c0(0x27c)]?.['message']?.['protocolMessage']?.['editedMessage']?.[_0x4ca4c0(0x2ed)]||_0x50d313?.[_0x4ca4c0(0x200)]?.['editedMessage']?.[_0x4ca4c0(0x200)]?.[_0x4ca4c0(0x265)]?.[_0x4ca4c0(0x1f6)],'imageMessage':MessageUtils['getImageMessage'](_0x50d313),'videoMessage':MessageUtils['getVideoMessage'](_0x50d313),'extendedTextMessage':_0x50d313[_0x4ca4c0(0x200)]?.[_0x4ca4c0(0x265)]?.[_0x4ca4c0(0x1f6)],'buttonsResponseMessage':MessageUtils[_0x4ca4c0(0x1f4)](_0x50d313),'templateButtonReplyMessage':_0x50d313[_0x4ca4c0(0x200)]?.[_0x4ca4c0(0x151)]?.[_0x4ca4c0(0x181)],'messageContextInfo':_0x50d313[_0x4ca4c0(0x200)]?.[_0x4ca4c0(0x2bc)]?.[_0x4ca4c0(0x29e)]||_0x50d313[_0x4ca4c0(0x200)]?.[_0x4ca4c0(0x194)]?.[_0x4ca4c0(0x147)],'buttonsMessage':MessageUtils[_0x4ca4c0(0x1af)](_0x50d313)||_0x50d313[_0x4ca4c0(0x200)]?.[_0x4ca4c0(0x194)]?.[_0x4ca4c0(0x1f3)]?.[_0x4ca4c0(0x184)],'viewOnceMessage':MessageUtils[_0x4ca4c0(0x1c6)](_0x50d313),'viewOnceMessageV2':MessageUtils[_0x4ca4c0(0x1dc)](_0x50d313),'stickerMessage':MessageUtils[_0x4ca4c0(0x25c)](_0x50d313),'contactMessage':MessageUtils['getContactMessage'](_0x50d313),'contactsArrayMessage':_0x50d313[_0x4ca4c0(0x200)]?.[_0x4ca4c0(0x1c7)]?.[_0x4ca4c0(0x279)]&&MessageUtils[_0x4ca4c0(0x2d4)](_0x50d313),'pollCreationMessageV2':_0x50d313[_0x4ca4c0(0x200)]?.[_0x4ca4c0(0x2c7)]?.[_0x4ca4c0(0x24e)]||_0x4ca4c0(0x238),'pollCreationMessageV3':_0x50d313[_0x4ca4c0(0x200)]?.[_0x4ca4c0(0x1e4)]?.[_0x4ca4c0(0x24e)]||_0x4ca4c0(0x238),'interactiveMessage':_0x50d313[_0x4ca4c0(0x200)]?.[_0x4ca4c0(0x1a9)]?.[_0x4ca4c0(0x1e0)]||_0x50d313[_0x4ca4c0(0x200)]?.['interactiveMessage']?.[_0x4ca4c0(0x1a8)]||_0x4ca4c0(0x1aa),'locationMessage':MessageUtils['getLocationMessage'](_0x50d313),'liveLocationMessage':_0x4ca4c0(0x1a0)+_0x50d313[_0x4ca4c0(0x200)]?.['liveLocationMessage']?.[_0x4ca4c0(0x19f)]+_0x4ca4c0(0x1f5)+_0x50d313[_0x4ca4c0(0x200)]?.[_0x4ca4c0(0x289)]?.['degreesLongitude'],'documentMessage':MessageUtils['getDocumentMessage'](_0x50d313),'documentWithCaptionMessage':_0x50d313[_0x4ca4c0(0x200)]?.[_0x4ca4c0(0x262)]?.[_0x4ca4c0(0x200)]?.[_0x4ca4c0(0x1ed)]?.[_0x4ca4c0(0x152)],'audioMessage':MessageUtils[_0x4ca4c0(0x1de)](_0x50d313),'ephemeralMessage':_0x50d313[_0x4ca4c0(0x200)]?.[_0x4ca4c0(0x161)]?.['message']?.['extendedTextMessage']?.[_0x4ca4c0(0x1f6)],'listMessage':MessageUtils[_0x4ca4c0(0x1af)](_0x50d313)||_0x50d313[_0x4ca4c0(0x200)]?.['listResponseMessage']?.[_0x4ca4c0(0x147)],'listResponseMessage':MessageUtils[_0x4ca4c0(0x187)](_0x50d313),'reactionMessage':MessageUtils[_0x4ca4c0(0x15a)](_0x50d313)||_0x4ca4c0(0x23b),'advertising':MessageUtils['getAd'](_0x50d313)||_0x50d313[_0x4ca4c0(0x200)]?.[_0x4ca4c0(0x194)]?.['contextInfo']?.['externalAdReply']?.[_0x4ca4c0(0x147)],'productMessage':_0x50d313[_0x4ca4c0(0x200)]?.[_0x4ca4c0(0x225)]?.[_0x4ca4c0(0x215)]?.[_0x4ca4c0(0x14a)]?.[_0x4ca4c0(0x152)]||'Produto','multiProductMessage':_0x4ca4c0(0x263),'orderMessage':_0x4ca4c0(0x251),'paymentMessage':MessageUtils[_0x4ca4c0(0x248)](_0x50d313),'paymentRequestMessage':_0x4ca4c0(0x1e2),'groupInviteMessage':MessageUtils[_0x4ca4c0(0x1b0)](_0x50d313),'revokeInviteMessage':_0x4ca4c0(0x1bf),'protocolMessage':_0x50d313[_0x4ca4c0(0x200)]?.[_0x4ca4c0(0x1c3)]?.[_0x4ca4c0(0x27c)]?.[_0x4ca4c0(0x2ed)]||null,'disappearingMessage':'Mensagem\x20que\x20Desaparece','callMessage':MessageUtils[_0x4ca4c0(0x2f3)](_0x50d313),'templateMessage':MessageUtils[_0x4ca4c0(0x27d)](_0x50d313),'statusUpdateMessage':_0x4ca4c0(0x154)};return _0x2fb7cd[_0x21b37a]||null;}catch(_0x3344a9){return console[_0x4ca4c0(0x160)](_0x4ca4c0(0x21c),_0x3344a9),null;}};exports[a558_0xd5cd7b(0x17d)]=getBodyMessage;const getQuotedMessage=_0xc9dcd4=>{const _0x10f6eb=a558_0xd5cd7b,_0xb07ff6=_0xc9dcd4['message'][_0x10f6eb(0x140)][_0x10f6eb(0x1a8)]||_0xc9dcd4[_0x10f6eb(0x200)]['videoMessage'][_0x10f6eb(0x1a8)]||_0xc9dcd4['message']?.[_0x10f6eb(0x1ed)]||_0xc9dcd4[_0x10f6eb(0x200)][_0x10f6eb(0x265)][_0x10f6eb(0x1a8)]||_0xc9dcd4['message'][_0x10f6eb(0x2bc)][_0x10f6eb(0x1a8)]||_0xc9dcd4[_0x10f6eb(0x200)]['listResponseMessage'][_0x10f6eb(0x1a8)]||_0xc9dcd4[_0x10f6eb(0x200)][_0x10f6eb(0x151)][_0x10f6eb(0x1a8)]||_0xc9dcd4[_0x10f6eb(0x200)][_0x10f6eb(0x2bc)]?.[_0x10f6eb(0x1a8)]||_0xc9dcd4?.[_0x10f6eb(0x200)]?.['buttonsResponseMessage']?.[_0x10f6eb(0x29e)]||_0xc9dcd4['message'][_0x10f6eb(0x194)]?.[_0x10f6eb(0x1f3)]?.[_0x10f6eb(0x184)]||_0xc9dcd4?.[_0x10f6eb(0x200)]?.[_0x10f6eb(0x194)]?.['singleSelectReply'][_0x10f6eb(0x184)]||_0xc9dcd4[_0x10f6eb(0x200)][_0x10f6eb(0x194)]?.[_0x10f6eb(0x1a8)];return _0xc9dcd4[_0x10f6eb(0x200)]['senderKeyDistributionMessage'],(0x0,baileys_1['extractMessageContent'])(_0xb07ff6[Object['keys'](_0xb07ff6)[_0x10f6eb(0x2a9)]()[_0x10f6eb(0x1d1)]()['value']]);};exports[a558_0xd5cd7b(0x24b)]=getQuotedMessage;const getQuotedMessageId=_0x3e0f40=>{const _0x5700a4=a558_0xd5cd7b,_0x435d4b=(0x0,baileys_1['extractMessageContent'])(_0x3e0f40['message'])[Object[_0x5700a4(0x2a6)](_0x3e0f40?.[_0x5700a4(0x200)])['values']()[_0x5700a4(0x1d1)]()[_0x5700a4(0x178)]];let _0x54b308=_0x3e0f40?.[_0x5700a4(0x200)]?.['reactionMessage']?_0x3e0f40?.[_0x5700a4(0x200)]?.[_0x5700a4(0x274)]?.['key']?.['id']:'';return _0x54b308?_0x54b308:_0x435d4b?.[_0x5700a4(0x1a8)]?.[_0x5700a4(0x1ec)];};exports[a558_0xd5cd7b(0x219)]=getQuotedMessageId;function a558_0x94d3(_0x32abd2,_0x5c275c){const _0x1fa3cd=a558_0x376e();return a558_0x94d3=function(_0x24a7a6,_0x2402d0){_0x24a7a6=_0x24a7a6-0x13f;let _0x376e3e=_0x1fa3cd[_0x24a7a6];return _0x376e3e;},a558_0x94d3(_0x32abd2,_0x5c275c);}const getMeSocket=_0x193605=>{const _0xa5e5a0=a558_0xd5cd7b;return{'id':(0x0,baileys_1[_0xa5e5a0(0x15f)])(_0x193605[_0xa5e5a0(0x1a6)]['id']),'name':_0x193605['user'][_0xa5e5a0(0x24e)]};},getSenderMessage=(_0x5952d5,_0x24368f)=>{const _0x27fb8a=a558_0xd5cd7b,_0x3d2d68=getMeSocket(_0x24368f);if(_0x5952d5[_0x27fb8a(0x1d2)][_0x27fb8a(0x256)])return _0x3d2d68['id'];const _0x5d6025=_0x5952d5[_0x27fb8a(0x268)]||_0x5952d5['key'][_0x27fb8a(0x268)]||_0x5952d5[_0x27fb8a(0x1d2)]['remoteJid']||undefined;return _0x5d6025&&(0x0,baileys_1[_0x27fb8a(0x15f)])(_0x5d6025);},getContactMessage=async(_0x4b33b2,_0x243cee)=>{const _0x47fccc=a558_0xd5cd7b,_0x1073c1=_0x4b33b2[_0x47fccc(0x1d2)]['remoteJid'][_0x47fccc(0x303)](_0x47fccc(0x141)),_0x52d4d6=_0x4b33b2[_0x47fccc(0x1d2)][_0x47fccc(0x273)][_0x47fccc(0x143)](/\D/g,'');return _0x1073c1?{'id':getSenderMessage(_0x4b33b2,_0x243cee),'name':_0x4b33b2['pushName']}:{'id':_0x4b33b2[_0x47fccc(0x1d2)]['remoteJid'],'name':_0x4b33b2[_0x47fccc(0x1d2)][_0x47fccc(0x256)]?_0x52d4d6:_0x4b33b2[_0x47fccc(0x180)]};},getUnpackedMessage=_0xbd9cf9=>{const _0x574901=a558_0xd5cd7b;return _0xbd9cf9['message']?.[_0x574901(0x262)]?.[_0x574901(0x200)]||_0xbd9cf9['message']?.[_0x574901(0x265)]?.['contextInfo']?.[_0x574901(0x19d)]||_0xbd9cf9[_0x574901(0x200)]?.[_0x574901(0x161)]?.[_0x574901(0x200)]||_0xbd9cf9[_0x574901(0x200)]?.[_0x574901(0x2f6)]?.[_0x574901(0x200)]||_0xbd9cf9[_0x574901(0x200)]?.[_0x574901(0x244)]?.[_0x574901(0x200)]||_0xbd9cf9['message']?.[_0x574901(0x161)]?.[_0x574901(0x200)]||_0xbd9cf9[_0x574901(0x200)]?.['templateMessage']?.[_0x574901(0x206)]||_0xbd9cf9['message']?.[_0x574901(0x19c)]?.['hydratedFourRowTemplate']||_0xbd9cf9[_0x574901(0x200)]?.[_0x574901(0x19c)]?.['fourRowTemplate']||_0xbd9cf9['message']?.['interactiveMessage']?.['header']||_0xbd9cf9[_0x574901(0x200)]?.['highlyStructuredMessage']?.['hydratedHsm']?.[_0x574901(0x206)]||_0xbd9cf9['message'];},getMessageMedia=_0x2b5388=>{const _0x4d3236=a558_0xd5cd7b;return _0x2b5388?.[_0x4d3236(0x140)]||_0x2b5388?.[_0x4d3236(0x2ba)]||_0x2b5388?.[_0x4d3236(0x290)]||_0x2b5388?.[_0x4d3236(0x2c3)]||_0x2b5388?.[_0x4d3236(0x1ed)]||null;},downloadMedia=async _0x1b084c=>{const _0x2d1f0a=a558_0xd5cd7b,_0x13ed47=getUnpackedMessage(_0x1b084c),_0x400a43=getMessageMedia(_0x13ed47);if(!_0x400a43)return null;const _0x4c6555=_0x13ed47?.[_0x2d1f0a(0x1ed)]?_0x2d1f0a(0x26a):_0x400a43[_0x2d1f0a(0x2b4)][_0x2d1f0a(0x197)]('/')[0x0]['replace'](_0x2d1f0a(0x26b),_0x2d1f0a(0x26a))?_0x400a43[_0x2d1f0a(0x2b4)][_0x2d1f0a(0x197)]('/')[0x0][_0x2d1f0a(0x143)]('application',_0x2d1f0a(0x26a)):_0x400a43[_0x2d1f0a(0x2b4)][_0x2d1f0a(0x197)]('/')[0x0];let _0x37ad11,_0x4ae10e=0x0;while(_0x4ae10e<0xa&&!_0x37ad11){try{_0x400a43?.['directPath']&&(_0x400a43[_0x2d1f0a(0x296)]=''),_0x37ad11=await(0x0,baileys_1[_0x2d1f0a(0x168)])(_0x400a43,_0x4c6555);}catch(_0x291480){_0x4ae10e+=0x1,await new Promise(_0x16e0f3=>{setTimeout(_0x16e0f3,0x3e8*_0x4ae10e*0x2);}),logger_1[_0x2d1f0a(0x1e9)][_0x2d1f0a(0x26e)]('>>>>\x20erro\x20'+_0x4ae10e+_0x2d1f0a(0x1c8)+_0x1b084c?.['key']?.['id']);}}if(!_0x37ad11)throw new Error(_0x2d1f0a(0x1a7));let _0x3a8507=_0x13ed47?.[_0x2d1f0a(0x1ed)]?.['fileName']||'';if(!_0x3a8507){const _0x1e4f2b=mime_1[_0x2d1f0a(0x16c)][_0x2d1f0a(0x2e3)](_0x400a43[_0x2d1f0a(0x2b4)]);_0x3a8507=(0x0,MakeRandomId_1[_0x2d1f0a(0x1bd)])(0x5)+'-'+new Date()[_0x2d1f0a(0x22f)]()+'.'+_0x1e4f2b;}else _0x3a8507=_0x3a8507[_0x2d1f0a(0x197)]('.')[_0x2d1f0a(0x207)](0x0,-0x1)[_0x2d1f0a(0x2ae)]('.')+'.'+(0x0,MakeRandomId_1[_0x2d1f0a(0x1bd)])(0x5)+'.'+_0x3a8507[_0x2d1f0a(0x197)]('.')[_0x2d1f0a(0x207)](-0x1);const _0x1978cf=0x5*0x400*0x400/0x8,_0x503711=0x400*0x400/0x8,_0x300e7a=0x400*0x400,_0x3d9c06=new stream_throttle_1[(_0x2d1f0a(0x2e2))]({'rate':_0x1978cf});let _0x3eb83c=Buffer['from']([]),_0x499472=0x0;const _0x1c6ef4=Date[_0x2d1f0a(0x1d8)]();try{for await(const _0x12fd31 of _0x37ad11[_0x2d1f0a(0x1eb)](_0x3d9c06)){_0x3eb83c=Buffer[_0x2d1f0a(0x2d9)]([_0x3eb83c,_0x12fd31]),_0x499472+=_0x12fd31[_0x2d1f0a(0x1ef)],_0x499472>_0x300e7a&&(_0x3d9c06['rate']=_0x503711);}}catch(_0x5c4f02){return{'data':_0x2d1f0a(0x160),'mimetype':'','filename':''};}const _0x9727d1=Date[_0x2d1f0a(0x1d8)](),_0x13fea4=(_0x9727d1-_0x1c6ef4)/0x3e8,_0x13ab6c=_0x499472/_0x13fea4;logger_1[_0x2d1f0a(0x1e9)][_0x2d1f0a(0x278)](_0x3a8507+_0x2d1f0a(0x182)+_0x13fea4['toFixed'](0x2)+_0x2d1f0a(0x22b)+(_0x13ab6c/0x400/0x400)[_0x2d1f0a(0x1dd)](0x2)+_0x2d1f0a(0x234));if(!_0x3eb83c){Sentry['setExtra']('ERR_WAPP_DOWNLOAD_MEDIA',{'msg':_0x1b084c}),Sentry[_0x2d1f0a(0x25d)](new Error(_0x2d1f0a(0x2e4)));throw new Error(_0x2d1f0a(0x2e4));}const _0x47e81b={'data':_0x3eb83c,'mimetype':_0x400a43[_0x2d1f0a(0x2b4)],'filename':_0x3a8507};return _0x47e81b;},verifyContact=async(_0x1875c1,_0x3c27ab,_0x59ee6b)=>{const _0x5df045=a558_0xd5cd7b,_0xbd5f4b={'name':_0x1875c1?.['name']||_0x1875c1['id'][_0x5df045(0x143)](/\D/g,''),'number':_0x1875c1['id'][_0x5df045(0x269)](0x0,_0x1875c1['id'][_0x5df045(0x270)]('@')),'isGroup':_0x1875c1['id'][_0x5df045(0x303)]('g.us'),'companyId':_0x59ee6b,'whatsappId':_0x3c27ab['id']},_0x5eda2f=(0x0,CreateOrUpdateContactService_1[_0x5df045(0x16c)])(_0xbd5f4b,_0x3c27ab,_0x1875c1['id']);return _0x5eda2f;},verifyQuotedMessage=async _0x45febd=>{const _0x13bdee=a558_0xd5cd7b;if(!_0x45febd)return null;const _0x470150=(0x0,exports['getQuotedMessageId'])(_0x45febd);if(!_0x470150)return null;const _0xb4785d=await Message_1[_0x13bdee(0x16c)][_0x13bdee(0x260)]({'where':{'id':_0x470150}});if(!_0xb4785d)return null;return _0xb4785d;};exports[a558_0xd5cd7b(0x216)]=verifyQuotedMessage;const sanitizeName=_0x48c45b=>{const _0x371acd=a558_0xd5cd7b;let _0x561d86=_0x48c45b[_0x371acd(0x197)]('\x20')[0x0];return _0x561d86=_0x561d86['replace'](/[^a-zA-Z0-9]/g,''),_0x561d86['substring'](0x0,0x3c);},convertTextToSpeechAndSaveToFile=(_0x5cb10e,_0x4d47b5,_0x18c488,_0x6fd567,_0x4f6669='pt-BR-FabioNeural',_0x4e8b71=a558_0xd5cd7b(0x1d4))=>{return new Promise((_0x4c6315,_0x2dacd0)=>{const _0x3627e3=a558_0x94d3,_0xfa681a=microsoft_cognitiveservices_speech_sdk_1[_0x3627e3(0x191)]['fromSubscription'](_0x18c488,_0x6fd567);_0xfa681a[_0x3627e3(0x213)]=_0x4f6669;const _0x3688ff=microsoft_cognitiveservices_speech_sdk_1['AudioConfig'][_0x3627e3(0x254)](_0x4d47b5+_0x3627e3(0x2ea)),_0x481f33=new microsoft_cognitiveservices_speech_sdk_1[(_0x3627e3(0x159))](_0xfa681a,_0x3688ff);_0x481f33[_0x3627e3(0x18c)](_0x5cb10e,_0xcfaf63=>{const _0x369c3f=_0x3627e3;_0xcfaf63?convertWavToAnotherFormat(_0x4d47b5+_0x369c3f(0x2ea),_0x4d47b5+'.'+_0x4e8b71,_0x4e8b71)[_0x369c3f(0x2c0)](_0x443251=>{_0x4c6315();})[_0x369c3f(0x15e)](_0x393b9c=>{console['error'](_0x393b9c),_0x2dacd0(_0x393b9c);}):_0x2dacd0(new Error(_0x369c3f(0x2e5))),_0x481f33[_0x369c3f(0x255)]();},_0x595aae=>{const _0x5e4653=_0x3627e3;console[_0x5e4653(0x160)](_0x5e4653(0x2dd)+_0x595aae),_0x481f33[_0x5e4653(0x255)](),_0x2dacd0(_0x595aae);});});},convertWavToAnotherFormat=(_0x40c224,_0x58e346,_0x27631c)=>{return new Promise((_0x30243b,_0x3bb477)=>{const _0x3b5246=a558_0x94d3;(0x0,fluent_ffmpeg_1[_0x3b5246(0x16c)])()[_0x3b5246(0x2c6)](_0x40c224)[_0x3b5246(0x272)](_0x27631c)['on'](_0x3b5246(0x1a4),()=>_0x30243b(_0x58e346))['on'](_0x3b5246(0x160),_0x8eac7a=>_0x3bb477(new Error('Error\x20converting\x20file:\x20'+_0x8eac7a['message'])))[_0x3b5246(0x2a7)](_0x58e346);});},deleteFileSync=_0x41a4ae=>{const _0x4fafa9=a558_0xd5cd7b;try{fs_2['default'][_0x4fafa9(0x1c0)](_0x41a4ae);}catch(_0x426dbc){console['error'](_0x4fafa9(0x1b8),_0x426dbc);}},keepOnlySpecifiedChars=_0x25eedb=>{const _0x488225=a558_0xd5cd7b;return _0x25eedb[_0x488225(0x143)](/[^a-zA-Z0-9áéíóúÁÉÍÓÚâêîôûÂÊÎÔÛãõÃÕçÇ!?.,;:\s]/g,'');},handleOpenAi=async(_0xb252a2,_0x368629,_0xc85ca4,_0x3336b5,_0x4d5331)=>{const _0x5907fc=a558_0xd5cd7b,_0x3c5a9c=(0x0,exports['getBodyMessage'])(_0xb252a2);if(!_0x3c5a9c)return;let {prompt:_0x56130f}=await(0x0,ShowWhatsAppService_1[_0x5907fc(0x16c)])(_0x368629['id'],_0xc85ca4[_0x5907fc(0x1c5)]);!_0x56130f&&!(0x0,lodash_1[_0x5907fc(0x20a)])(_0xc85ca4?.[_0x5907fc(0x1f9)]?.[_0x5907fc(0x22e)])&&(_0x56130f=_0xc85ca4['queue'][_0x5907fc(0x22e)]);if(!_0x56130f)return;if(_0xb252a2['messageStubType'])return;const _0x325a8c=path_1[_0x5907fc(0x16c)][_0x5907fc(0x199)](__dirname,'..','..','..',_0x5907fc(0x300));let _0x2f331a;const _0x55a822=sessionsOpenAi['findIndex'](_0x11d926=>_0x11d926['id']===_0x368629['id']);if(_0x55a822===-0x1){const _0x453921=new openai_1[(_0x5907fc(0x2ab))]({'apiKey':_0x56130f[_0x5907fc(0x2cf)]});_0x2f331a=new openai_1['OpenAIApi'](_0x453921),_0x2f331a['id']=_0x368629['id'],sessionsOpenAi[_0x5907fc(0x2eb)](_0x2f331a);}else _0x2f331a=sessionsOpenAi[_0x55a822];const _0x1b8f57=await Message_1[_0x5907fc(0x16c)]['findAll']({'where':{'ticketId':_0xc85ca4['id']},'order':[['createdAt',_0x5907fc(0x2b1)]],'limit':_0x56130f[_0x5907fc(0x284)]}),_0x1dde64='Nas\x20respostas\x20utilize\x20o\x20nome\x20'+sanitizeName(_0x3336b5[_0x5907fc(0x24e)]||_0x5907fc(0x1a1))+_0x5907fc(0x242)+_0x56130f[_0x5907fc(0x1fd)]+_0x5907fc(0x302)+_0x56130f[_0x5907fc(0x22e)]+'\x0a';let _0x14a3f9=[];if(_0xb252a2[_0x5907fc(0x200)]?.['conversation']||_0xb252a2[_0x5907fc(0x200)]?.[_0x5907fc(0x265)]?.[_0x5907fc(0x1f6)]){_0x14a3f9=[],_0x14a3f9['push']({'role':_0x5907fc(0x198),'content':_0x1dde64});for(let _0x7218b5=0x0;_0x7218b5<Math[_0x5907fc(0x1ff)](_0x56130f[_0x5907fc(0x284)],_0x1b8f57[_0x5907fc(0x1ef)]);_0x7218b5++){const _0x42171e=_0x1b8f57[_0x7218b5];_0x42171e['mediaType']==='chat'&&(_0x42171e[_0x5907fc(0x256)]?_0x14a3f9[_0x5907fc(0x2eb)]({'role':_0x5907fc(0x299),'content':_0x42171e[_0x5907fc(0x1e0)]}):_0x14a3f9[_0x5907fc(0x2eb)]({'role':'user','content':_0x42171e[_0x5907fc(0x1e0)]}));}_0x14a3f9[_0x5907fc(0x2eb)]({'role':_0x5907fc(0x1a6),'content':_0x3c5a9c});const _0x865383=await _0x2f331a[_0x5907fc(0x2e6)]({'model':'gpt-3.5-turbo-1106','messages':_0x14a3f9,'max_tokens':_0x56130f[_0x5907fc(0x1fd)],'temperature':_0x56130f[_0x5907fc(0x220)]});let _0x131796=_0x865383[_0x5907fc(0x2fb)]['choices'][0x0]['message']?.[_0x5907fc(0x1b7)];_0x131796?.[_0x5907fc(0x303)]('Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento')&&(await transferQueue(_0x56130f[_0x5907fc(0x171)],_0xc85ca4,_0x3336b5),_0x131796=_0x131796[_0x5907fc(0x143)]('Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento','')[_0x5907fc(0x26d)]());if(_0x56130f['voice']==='texto'){const _0x2e8034=await _0x368629[_0x5907fc(0x214)](_0xb252a2['key'][_0x5907fc(0x273)],{'text':_0x131796});await(0x0,exports[_0x5907fc(0x286)])(_0x2e8034,_0xc85ca4,_0x3336b5);}else{const _0x3fe87e=_0xc85ca4['id']+'_'+Date[_0x5907fc(0x1d8)]();convertTextToSpeechAndSaveToFile(keepOnlySpecifiedChars(_0x131796),_0x325a8c+'/'+_0x3fe87e,_0x56130f['voiceKey'],_0x56130f[_0x5907fc(0x1e8)],_0x56130f['voice'],'mp3')[_0x5907fc(0x2c0)](async()=>{const _0x3c3f56=_0x5907fc;try{const _0x1d6cea=await _0x368629[_0x3c3f56(0x214)](_0xb252a2[_0x3c3f56(0x1d2)]['remoteJid'],{'audio':{'url':_0x325a8c+'/'+_0x3fe87e+_0x3c3f56(0x1b3)},'mimetype':_0x3c3f56(0x1ca),'ptt':!![]});await verifyMediaMessage(_0x1d6cea,_0xc85ca4,_0x3336b5),deleteFileSync(_0x325a8c+'/'+_0x3fe87e+_0x3c3f56(0x1b3)),deleteFileSync(_0x325a8c+'/'+_0x3fe87e+_0x3c3f56(0x2ea));}catch(_0x4a8ec4){console[_0x3c3f56(0x179)](_0x3c3f56(0x259)+_0x4a8ec4);}});}}else{if(_0xb252a2[_0x5907fc(0x200)]?.[_0x5907fc(0x2ba)]){const _0x595d14=_0x4d5331['mediaUrl'][_0x5907fc(0x197)]('/')[_0x5907fc(0x22d)](),_0x1dfa95=fs_2[_0x5907fc(0x16c)][_0x5907fc(0x1b2)](_0x325a8c+'/'+_0x595d14),_0x654e28=await _0x2f331a[_0x5907fc(0x202)](_0x1dfa95,_0x5907fc(0x1d0));_0x14a3f9=[],_0x14a3f9['push']({'role':_0x5907fc(0x198),'content':_0x1dde64});for(let _0x111e53=0x0;_0x111e53<Math[_0x5907fc(0x1ff)](_0x56130f[_0x5907fc(0x284)],_0x1b8f57[_0x5907fc(0x1ef)]);_0x111e53++){const _0x18fc00=_0x1b8f57[_0x111e53];_0x18fc00[_0x5907fc(0x2a4)]===_0x5907fc(0x282)&&(_0x18fc00['fromMe']?_0x14a3f9[_0x5907fc(0x2eb)]({'role':_0x5907fc(0x299),'content':_0x18fc00[_0x5907fc(0x1e0)]}):_0x14a3f9[_0x5907fc(0x2eb)]({'role':_0x5907fc(0x1a6),'content':_0x18fc00[_0x5907fc(0x1e0)]}));}_0x14a3f9[_0x5907fc(0x2eb)]({'role':_0x5907fc(0x1a6),'content':_0x654e28[_0x5907fc(0x2fb)][_0x5907fc(0x1f6)]});const _0x236a36=await _0x2f331a[_0x5907fc(0x2e6)]({'model':'gpt-3.5-turbo-1106','messages':_0x14a3f9,'max_tokens':_0x56130f['maxTokens'],'temperature':_0x56130f[_0x5907fc(0x220)]});let _0x328483=_0x236a36[_0x5907fc(0x2fb)][_0x5907fc(0x21e)][0x0]['message']?.['content'];_0x328483?.[_0x5907fc(0x303)](_0x5907fc(0x16b))&&(await transferQueue(_0x56130f[_0x5907fc(0x171)],_0xc85ca4,_0x3336b5),_0x328483=_0x328483[_0x5907fc(0x143)](_0x5907fc(0x16b),'')['trim']());if(_0x56130f[_0x5907fc(0x2c1)]===_0x5907fc(0x2fe)){const _0x55cd85=await _0x368629[_0x5907fc(0x214)](_0xb252a2[_0x5907fc(0x1d2)][_0x5907fc(0x273)],{'text':_0x328483});await(0x0,exports[_0x5907fc(0x286)])(_0x55cd85,_0xc85ca4,_0x3336b5);}else{const _0xe223d3=_0xc85ca4['id']+'_'+Date[_0x5907fc(0x1d8)]();convertTextToSpeechAndSaveToFile(keepOnlySpecifiedChars(_0x328483),_0x325a8c+'/'+_0xe223d3,_0x56130f[_0x5907fc(0x166)],_0x56130f[_0x5907fc(0x1e8)],_0x56130f[_0x5907fc(0x2c1)],_0x5907fc(0x1d4))[_0x5907fc(0x2c0)](async()=>{const _0x4f928c=_0x5907fc;try{const _0x3918d6=await _0x368629[_0x4f928c(0x214)](_0xb252a2[_0x4f928c(0x1d2)][_0x4f928c(0x273)],{'audio':{'url':_0x325a8c+'/'+_0xe223d3+_0x4f928c(0x1b3)},'mimetype':_0x4f928c(0x1ca),'ptt':!![]});await verifyMediaMessage(_0x3918d6,_0xc85ca4,_0x3336b5),deleteFileSync(_0x325a8c+'/'+_0xe223d3+_0x4f928c(0x1b3)),deleteFileSync(_0x325a8c+'/'+_0xe223d3+_0x4f928c(0x2ea));}catch(_0x3ad207){console[_0x4f928c(0x179)]('Erro\x20para\x20responder\x20com\x20audio:\x20'+_0x3ad207);}});}}}_0x14a3f9=[];},transferQueue=async(_0x2cac38,_0x2cc222,_0x55d203)=>{const _0x5162ce=a558_0xd5cd7b;console[_0x5162ce(0x156)](_0x5162ce(0x2dc)),await(0x0,UpdateTicketService_1[_0x5162ce(0x16c)])({'ticketData':{'queueId':_0x2cac38,'useIntegration':![],'promptId':null},'ticketId':_0x2cc222['id'],'companyId':_0x2cc222[_0x5162ce(0x1c5)]});},verifyMediaMessage=async(_0x3e7131,_0x29ada5,_0x12ffd1)=>{const _0x3ca0ec=a558_0xd5cd7b,_0x336fdd=(0x0,socket_1[_0x3ca0ec(0x29b)])();let _0x6016ce=await Message_1[_0x3ca0ec(0x16c)][_0x3ca0ec(0x260)]({'where':{'id':_0x3e7131[_0x3ca0ec(0x1d2)]['id']}});if(!_0x6016ce){const _0x3af88e=await(0x0,exports[_0x3ca0ec(0x216)])(_0x3e7131),_0xf1eaa7=(0x0,wbot_1[_0x3ca0ec(0x2be)])(_0x29ada5[_0x3ca0ec(0x1a5)]),_0x2b981a=await downloadMedia(_0x3e7131);if(!_0x2b981a)throw new Error(_0x3ca0ec(0x2e4));if(!_0x2b981a[_0x3ca0ec(0x2de)]){const _0x182632=typeof _0x2b981a['mimetype']==='string'&&_0x2b981a[_0x3ca0ec(0x2b4)][_0x3ca0ec(0x303)]('/')&&_0x2b981a['mimetype'][_0x3ca0ec(0x303)](';')?mime_1[_0x3ca0ec(0x16c)][_0x3ca0ec(0x2e3)](_0x2b981a[_0x3ca0ec(0x2b4)]):'unknown';_0x2b981a[_0x3ca0ec(0x2de)]=new Date()[_0x3ca0ec(0x22f)]()+'.'+_0x182632;}else{let _0x32b4b3=_0x2b981a[_0x3ca0ec(0x2de)]?'-'+_0x2b981a[_0x3ca0ec(0x2de)]:'';_0x2b981a[_0x3ca0ec(0x2de)]=''+new Date()[_0x3ca0ec(0x22f)]()+_0x32b4b3;}try{const _0xf188b3='public/company'+_0x29ada5[_0x3ca0ec(0x1c5)];!fs_2[_0x3ca0ec(0x16c)][_0x3ca0ec(0x24c)](_0xf188b3)&&(fs_2[_0x3ca0ec(0x16c)][_0x3ca0ec(0x2bd)](_0xf188b3),fs_2[_0x3ca0ec(0x16c)][_0x3ca0ec(0x24f)](_0xf188b3,0x1ff)),await writeFileAsync((0x0,path_1[_0x3ca0ec(0x2ae)])(__dirname,'..','..','..',_0xf188b3,_0x2b981a['filename']),_0x2b981a[_0x3ca0ec(0x2fb)],'base64');}catch(_0x247714){Sentry[_0x3ca0ec(0x25d)](_0x247714),logger_1[_0x3ca0ec(0x1e9)]['error'](_0x247714);}const _0x343e76=(0x0,exports['getBodyMessage'])(_0x3e7131);var _0x1c03b1=getTypeMessage(_0x3e7131);const _0xa7f590={'id':_0x3e7131[_0x3ca0ec(0x1d2)]['id'],'ticketId':_0x29ada5['id'],'contactId':_0x3e7131['key']['fromMe']?undefined:_0x12ffd1['id'],'body':_0x343e76?(0x0,Mustache_1[_0x3ca0ec(0x16c)])(_0x343e76,_0x29ada5):_0x2b981a['filename'],'fromMe':_0x3e7131[_0x3ca0ec(0x1d2)]['fromMe'],'read':_0x3e7131[_0x3ca0ec(0x1d2)][_0x3ca0ec(0x256)],'mediaUrl':_0x2b981a[_0x3ca0ec(0x2de)],'mediaType':typeof _0x2b981a['mimetype']===_0x3ca0ec(0x2b9)?_0x2b981a['mimetype'][_0x3ca0ec(0x197)]('/')[0x0]:_0x3ca0ec(0x2b0),'quotedMsgId':_0x3af88e?.['id'],'ack':getStatus(_0x3e7131,_0x3ca0ec(0x189)),'remoteJid':_0x3e7131[_0x3ca0ec(0x1d2)][_0x3ca0ec(0x273)],'participant':_0x3e7131[_0x3ca0ec(0x1d2)][_0x3ca0ec(0x268)],'dataJson':JSON[_0x3ca0ec(0x227)](_0x3e7131)};var _0x3a9cff=_0x343e76||_0x2b981a['filename'];typeof _0x3a9cff!=_0x3ca0ec(0x2b9)&&console[_0x3ca0ec(0x156)](_0x3ca0ec(0x1d9),_0x3a9cff),await _0x29ada5[_0x3ca0ec(0x1e6)]({'lastMessage':_0x3a9cff}),_0x6016ce=await(0x0,CreateMessageService_1['default'])({'messageData':_0xa7f590,'ticket':_0x29ada5,'companyId':_0x29ada5[_0x3ca0ec(0x1c5)]});}else typeof _0x6016ce[_0x3ca0ec(0x1e0)]!='string'&&console[_0x3ca0ec(0x156)](_0x3ca0ec(0x1d9),_0x6016ce[_0x3ca0ec(0x1e0)]),await _0x29ada5[_0x3ca0ec(0x1e6)]({'lastMessage':_0x6016ce[_0x3ca0ec(0x1e0)]}),_0x6016ce[_0x3ca0ec(0x2d1)]=getStatus(_0x3e7131,_0x3ca0ec(0x189)),_0x6016ce[_0x3ca0ec(0x268)]=_0x3e7131[_0x3ca0ec(0x1d2)][_0x3ca0ec(0x268)],_0x6016ce[_0x3ca0ec(0x26f)]=JSON[_0x3ca0ec(0x227)](_0x3e7131),await _0x6016ce[_0x3ca0ec(0x2a7)]();return!_0x3e7131['key'][_0x3ca0ec(0x256)]&&_0x29ada5[_0x3ca0ec(0x25b)]===_0x3ca0ec(0x221)&&(await _0x29ada5[_0x3ca0ec(0x1e6)]({'status':'pending'}),await _0x29ada5[_0x3ca0ec(0x2f4)]({'include':[{'model':Queue_1[_0x3ca0ec(0x16c)],'as':_0x3ca0ec(0x1f9)},{'model':User_1['default'],'as':_0x3ca0ec(0x1a6)},{'model':Contact_1['default'],'as':_0x3ca0ec(0x241)}]}),_0x336fdd['to']('company-'+_0x29ada5[_0x3ca0ec(0x1c5)]+'-closed')[_0x3ca0ec(0x2fa)](_0x3ca0ec(0x307)+_0x29ada5['companyId']+_0x3ca0ec(0x157),{'action':'delete','ticket':_0x29ada5,'ticketId':_0x29ada5['id']}),_0x336fdd['to'](_0x3ca0ec(0x307)+_0x29ada5[_0x3ca0ec(0x1c5)]+'-'+_0x29ada5['status'])['to'](_0x29ada5['id'][_0x3ca0ec(0x2ce)]())[_0x3ca0ec(0x2fa)](_0x3ca0ec(0x307)+_0x29ada5[_0x3ca0ec(0x1c5)]+_0x3ca0ec(0x157),{'action':_0x3ca0ec(0x1e6),'ticket':_0x29ada5,'ticketId':_0x29ada5['id']})),_0x6016ce;};function getStatus(_0x59b816,_0x4ae0b5){const _0xeb45c6=a558_0xd5cd7b;if(_0x59b816[_0xeb45c6(0x25b)]==baileys_1[_0xeb45c6(0x271)][_0xeb45c6(0x18b)][_0xeb45c6(0x29f)][_0xeb45c6(0x305)]){if(_0x59b816[_0xeb45c6(0x1d2)]['fromMe']&&_0x4ae0b5==_0xeb45c6(0x274))return 0x3;return 0x1;}else{if(_0x59b816[_0xeb45c6(0x25b)]==baileys_1[_0xeb45c6(0x271)][_0xeb45c6(0x18b)][_0xeb45c6(0x29f)][_0xeb45c6(0x173)])return 0x1;else{if(_0x59b816[_0xeb45c6(0x25b)]==baileys_1[_0xeb45c6(0x271)][_0xeb45c6(0x18b)][_0xeb45c6(0x29f)][_0xeb45c6(0x2ff)])return 0x2;else{if(_0x59b816[_0xeb45c6(0x25b)]==baileys_1['proto'][_0xeb45c6(0x18b)][_0xeb45c6(0x29f)][_0xeb45c6(0x17b)]||_0x59b816[_0xeb45c6(0x25b)]==baileys_1[_0xeb45c6(0x271)][_0xeb45c6(0x18b)][_0xeb45c6(0x29f)][_0xeb45c6(0x19b)])return 0x3;}}}return 0x0;}const verifyMessage=async(_0x4f856d,_0x1a2768,_0x2f9d8e)=>{const _0x398966=a558_0xd5cd7b,_0x5ef47a=(0x0,socket_1[_0x398966(0x29b)])(),_0x47bd56=await(0x0,exports['verifyQuotedMessage'])(_0x4f856d),_0x4cc4aa=(0x0,exports[_0x398966(0x17d)])(_0x4f856d);if(!_0x4cc4aa)return;let _0x1e8d47=getTypeMessage(_0x4f856d);const _0x3512e0=_0x1e8d47==_0x398966(0x27c)||_0x4f856d?.[_0x398966(0x200)]?.[_0x398966(0x1c3)]?.[_0x398966(0x235)]==baileys_1[_0x398966(0x271)][_0x398966(0x23c)]['ProtocolMessage']['Type']['MESSAGE_EDIT']||_0x4f856d?.[_0x398966(0x200)]?.[_0x398966(0x1c3)]?.[_0x398966(0x27c)]?.[_0x398966(0x2ed)]?.[_0x398966(0x1ef)]>0x0;let _0x1c8235=_0x4f856d[_0x398966(0x1d2)]['id'];if(_0x1e8d47=='protocolMessage')_0x1c8235=_0x4f856d?.[_0x398966(0x200)]?.['protocolMessage']?.[_0x398966(0x1d2)]?.['id']||_0x4f856d[_0x398966(0x1d2)]['id'];else _0x1e8d47=='editedMessage'&&(_0x1c8235=_0x4f856d?.[_0x398966(0x200)]?.[_0x398966(0x27c)]?.[_0x398966(0x200)]?.['protocolMessage']?.[_0x398966(0x1d2)]?.['id']||_0x4f856d[_0x398966(0x1d2)]['id']);const _0x140132={'id':_0x1c8235,'ticketId':_0x1a2768['id'],'contactId':_0x4f856d[_0x398966(0x1d2)]['fromMe']?undefined:_0x2f9d8e['id'],'body':_0x4cc4aa,'fromMe':_0x4f856d['key']['fromMe'],'mediaType':_0x1e8d47,'read':_0x4f856d['key'][_0x398966(0x256)],'quotedMsgId':_0x47bd56?.['id'],'ack':getStatus(_0x4f856d,_0x1e8d47),'remoteJid':_0x4f856d[_0x398966(0x1d2)][_0x398966(0x273)],'participant':_0x4f856d[_0x398966(0x1d2)][_0x398966(0x268)],'dataJson':JSON['stringify'](_0x4f856d),'isEdited':_0x3512e0};typeof _0x4cc4aa!=_0x398966(0x2b9)&&console[_0x398966(0x156)]('body\x20is\x20not\x20a\x20string',_0x4cc4aa);await _0x1a2768[_0x398966(0x1e6)]({'lastMessage':_0x4cc4aa});if(_0x3512e0){let _0x337dac=await Message_1['default'][_0x398966(0x21a)](_0x140132['id']);if(_0x337dac){const _0x3f6a91={'messageId':_0x140132['id'],'body':_0x337dac[_0x398966(0x1e0)]};await OldMessage_1[_0x398966(0x16c)]['upsert'](_0x3f6a91);}else console['log'](_0x398966(0x2b2)+_0x140132['id']);}await(0x0,CreateMessageService_1[_0x398966(0x16c)])({'messageData':_0x140132,'ticket':_0x1a2768,'companyId':_0x1a2768[_0x398966(0x1c5)]}),!_0x4f856d[_0x398966(0x1d2)][_0x398966(0x256)]&&_0x1a2768[_0x398966(0x25b)]==='closed'&&(await _0x1a2768[_0x398966(0x1e6)]({'status':_0x398966(0x16d)}),await _0x1a2768[_0x398966(0x2f4)]({'include':[{'model':Queue_1[_0x398966(0x16c)],'as':'queue'},{'model':User_1[_0x398966(0x16c)],'as':'user'},{'model':Contact_1['default'],'as':_0x398966(0x241)}]}),_0x5ef47a['to'](_0x398966(0x307)+_0x1a2768[_0x398966(0x1c5)]+'-closed')[_0x398966(0x2fa)](_0x398966(0x307)+_0x1a2768[_0x398966(0x1c5)]+_0x398966(0x157),{'action':_0x398966(0x258),'ticket':_0x1a2768,'ticketId':_0x1a2768['id']}),_0x5ef47a['to'](_0x398966(0x307)+_0x1a2768[_0x398966(0x1c5)]+'-'+_0x1a2768[_0x398966(0x25b)])['to'](_0x1a2768['id'][_0x398966(0x2ce)]())['emit'](_0x398966(0x307)+_0x1a2768[_0x398966(0x1c5)]+_0x398966(0x157),{'action':_0x398966(0x1e6),'ticket':_0x1a2768,'ticketId':_0x1a2768['id']}));};exports[a558_0xd5cd7b(0x286)]=verifyMessage;const isValidMsg=_0x388e49=>{const _0x2e695d=a558_0xd5cd7b;if(_0x388e49[_0x2e695d(0x1d2)][_0x2e695d(0x273)]===_0x2e695d(0x1d3))return![];try{const _0x58bb9d=getTypeMessage(_0x388e49);if(!_0x58bb9d)return![];const _0xff055b=_0x58bb9d===_0x2e695d(0x2ed)||_0x58bb9d==='editedMessage'||_0x58bb9d===_0x2e695d(0x265)||_0x58bb9d===_0x2e695d(0x2ba)||_0x58bb9d==='videoMessage'||_0x58bb9d===_0x2e695d(0x2c7)||_0x58bb9d===_0x2e695d(0x19c)||_0x58bb9d==='pollCreationMessageV3'||_0x58bb9d===_0x2e695d(0x1a9)||_0x58bb9d==='imageMessage'||_0x58bb9d===_0x2e695d(0x1ed)||_0x58bb9d===_0x2e695d(0x262)||_0x58bb9d===_0x2e695d(0x2c3)||_0x58bb9d==='buttonsResponseMessage'||_0x58bb9d===_0x2e695d(0x267)||_0x58bb9d==='messageContextInfo'||_0x58bb9d===_0x2e695d(0x17c)||_0x58bb9d===_0x2e695d(0x289)||_0x58bb9d==='contactMessage'||_0x58bb9d===_0x2e695d(0x24d)||_0x58bb9d===_0x2e695d(0x17f)||_0x58bb9d==='contactsArrayMessage'||_0x58bb9d===_0x2e695d(0x274)||_0x58bb9d==='ephemeralMessage'||_0x58bb9d===_0x2e695d(0x1c3)||_0x58bb9d==='listResponseMessage'||_0x58bb9d===_0x2e695d(0x1b1)||_0x58bb9d===_0x2e695d(0x2f6)||_0x58bb9d==='viewOnceMessageV2'||_0x58bb9d===_0x2e695d(0x295)||_0x58bb9d==='highlyStructuredMessage';return!_0xff055b&&(logger_1['logger'][_0x2e695d(0x26e)](_0x2e695d(0x1c9)+_0x58bb9d+'\x0a'+JSON[_0x2e695d(0x227)](_0x388e49?.['message'])),Sentry[_0x2e695d(0x27b)](_0x2e695d(0x1fa),{'BodyMsg':_0x388e49[_0x2e695d(0x200)],'msg':_0x388e49,'msgType':_0x58bb9d}),Sentry['captureException'](new Error(_0x2e695d(0x23a)))),!!_0xff055b;}catch(_0x3f88c7){Sentry[_0x2e695d(0x27b)](_0x2e695d(0x149),{'msg':_0x388e49}),Sentry['captureException'](_0x3f88c7);}return![];};exports[a558_0xd5cd7b(0x2e0)]=isValidMsg;const Push=_0x38db13=>{const _0x1a6fee=a558_0xd5cd7b;return _0x38db13[_0x1a6fee(0x180)];},verifyQueue=async(_0x36099d,_0x1000c4,_0x5097d2,_0x5265b2,_0x236476)=>{const _0x328a05=a558_0xd5cd7b,_0x4e0a5f=_0x5097d2[_0x328a05(0x1c5)],{queues:_0x2ad0d7,greetingMessage:_0x31cf98,maxUseBotQueues:_0x4a884f,timeUseBotQueues:_0x185db4}=await(0x0,ShowWhatsAppService_1['default'])(_0x36099d['id'],_0x5097d2[_0x328a05(0x1c5)]);if(_0x2ad0d7[_0x328a05(0x1ef)]===0x1){const _0x376965=(0x0,lodash_1[_0x328a05(0x2a1)])(_0x2ad0d7);let _0x438f3a=![];_0x376965?.[_0x328a05(0x1cb)]&&(_0x438f3a=_0x376965[_0x328a05(0x1cb)][_0x328a05(0x1ef)]>0x0);const _0x28c072=await Setting_1[_0x328a05(0x16c)]['findOne']({'where':{'key':'sendGreetingMessageOneQueues','companyId':_0x5097d2['companyId']}});greetingMessageControl[_0x328a05(0x2eb)]({'ticketId':_0x5097d2['id'],'greetingMessage':_0x31cf98,'companyId':_0x4e0a5f});if(_0x31cf98['length']>0x1&&_0x28c072?.[_0x328a05(0x178)]===_0x328a05(0x2fd)){const _0x3516a2=await Message_1[_0x328a05(0x16c)][_0x328a05(0x260)]({'where':{'ticketId':_0x5097d2['id'],'fromMe':!![],'createdAt':{[sequelize_1['Op'][_0x328a05(0x2ad)]]:(0x0,moment_1[_0x328a05(0x16c)])()[_0x328a05(0x145)](0x5,_0x328a05(0x1a3))[_0x328a05(0x1f7)]()}}});if(_0x3516a2)return;const _0x4c8b9d=(0x0,Mustache_1[_0x328a05(0x16c)])(''+_0x31cf98,_0x5097d2);await _0x36099d[_0x328a05(0x214)](_0x5265b2['number']+'@'+(_0x5097d2[_0x328a05(0x16a)]?_0x328a05(0x141):_0x328a05(0x1a2)),{'text':_0x4c8b9d});}const _0x4a3879=await(0x0,ShowWhatsAppService_1[_0x328a05(0x16c)])(_0x36099d['id'],_0x4e0a5f),_0x526ec7=_0x2ad0d7[0x0]?.[_0x328a05(0x2e1)]||_0x4a3879[_0x328a05(0x2e1)];if(!_0x1000c4['key'][_0x328a05(0x256)]&&!_0x5097d2[_0x328a05(0x16a)]&&!(0x0,lodash_1[_0x328a05(0x20a)])(_0x526ec7)){const _0x554d83=await(0x0,ShowQueueIntegrationService_1[_0x328a05(0x16c)])(_0x526ec7,_0x4e0a5f);await(0x0,exports[_0x328a05(0x2a3)])(_0x1000c4,_0x36099d,_0x554d83,_0x5097d2),await _0x5097d2['update']({'useIntegration':!![],'integrationId':_0x554d83['id']});}const _0x4a2eaa=_0x2ad0d7[0x0]?.[_0x328a05(0x276)]||_0x4a3879[_0x328a05(0x276)];!_0x1000c4[_0x328a05(0x1d2)][_0x328a05(0x256)]&&!_0x5097d2[_0x328a05(0x16a)]&&!(0x0,lodash_1['isNil'])(_0x4a2eaa)&&(console['log'](_0x328a05(0x1f0)),await handleOpenAi(_0x1000c4,_0x36099d,_0x5097d2,_0x5265b2,_0x236476),await _0x5097d2['update']({'useIntegration':!![],'promptId':_0x4a2eaa}));await(0x0,UpdateTicketService_1[_0x328a05(0x16c)])({'ticketData':{'queueId':_0x376965?.['id'],'chatbot':_0x438f3a,'status':_0x328a05(0x16d)},'ticketId':_0x5097d2['id'],'companyId':_0x5097d2[_0x328a05(0x1c5)]});return;}const _0x1d3d2b=_0x1000c4?.[_0x328a05(0x200)]?.[_0x328a05(0x2bc)]?.[_0x328a05(0x29e)]||_0x1000c4?.[_0x328a05(0x200)]?.[_0x328a05(0x194)]?.['singleSelectReply']?.[_0x328a05(0x184)]||_0x1000c4?.[_0x328a05(0x200)]?.[_0x328a05(0x265)]?.[_0x328a05(0x1f6)]||_0x1000c4?.['message']?.['conversation'];let _0xf6bdc9=null;if(_0x1d3d2b&&!(0x0,exports[_0x328a05(0x15b)])(_0x1d3d2b)||+_0x1d3d2b>_0x2ad0d7[_0x328a05(0x1ef)]){const _0x420c8b=_0x1d3d2b[_0x328a05(0x1d5)]();for(let _0x45bdc9 of _0x2ad0d7){if(_0x45bdc9[_0x328a05(0x24e)]['toLowerCase']()===_0x420c8b){_0xf6bdc9=_0x45bdc9;break;}if(_0x45bdc9['keywords']&&_0x45bdc9[_0x328a05(0x2ee)][_0x328a05(0x1ef)]>0x0){let _0x1bf51a=_0x45bdc9[_0x328a05(0x2ee)]['split'](',\x20');for(let _0x2806aa of _0x1bf51a){if(_0x2806aa[_0x328a05(0x1d5)]()==_0x420c8b){_0xf6bdc9=_0x45bdc9;break;}}}}}else _0xf6bdc9=_0x2ad0d7[+_0x1d3d2b-0x1];const _0xcb53c8=await Setting_1[_0x328a05(0x16c)]['findOne']({'where':{'key':_0x328a05(0x148),'companyId':_0x4e0a5f}}),_0xbba68a=async()=>{const _0x4fe4dc=_0x328a05;let _0x29e5a5='';if(outOfHourMessageControl['length']>0x1388)outOfHourMessageControl=[];_0x2ad0d7[_0x4fe4dc(0x2e7)]((_0x57f05b,_0xf0c6ff)=>{const _0x51b97e=_0x4fe4dc;_0x29e5a5+=_0x51b97e(0x297)+(_0xf0c6ff+0x1)+_0x51b97e(0x2a0)+_0x57f05b['name']+'\x0a';});if(process[_0x4fe4dc(0x1c1)][_0x4fe4dc(0x22c)]?.[_0x4fe4dc(0x1ef)]>=0x8){if(_0x5097d2['contact'][_0x4fe4dc(0x20f)]!=process[_0x4fe4dc(0x1c1)]['CHATBOT_RESTRICT_NUMBER']){console[_0x4fe4dc(0x156)](_0x4fe4dc(0x232));return;}}const _0x214286={'text':(0x0,Mustache_1[_0x4fe4dc(0x16c)])('‎'+_0x31cf98+'\x0a\x0a'+_0x29e5a5,_0x5097d2)};await(0x0,UpdateTicketService_1[_0x4fe4dc(0x16c)])({'ticketData':{'amountUsedBotQueues':_0x5097d2[_0x4fe4dc(0x2db)]+0x1},'ticketId':_0x5097d2['id'],'companyId':_0x5097d2[_0x4fe4dc(0x1c5)]});const _0x153b01=await _0x36099d['sendMessage'](_0x5265b2[_0x4fe4dc(0x20f)]+'@'+(_0x5097d2[_0x4fe4dc(0x16a)]?_0x4fe4dc(0x141):'s.whatsapp.net'),_0x214286);await(0x0,exports['verifyMessage'])(_0x153b01,_0x5097d2,_0x5097d2['contact']);};if(_0xf6bdc9){let _0x15942b=![];_0xf6bdc9?.[_0x328a05(0x1cb)]&&(_0x15942b=_0xf6bdc9['options'][_0x328a05(0x1ef)]>0x0);await(0x0,UpdateTicketService_1['default'])({'ticketData':{'queueId':_0xf6bdc9['id'],'chatbot':_0x15942b,'status':'pending','amountUsedBotQueues':0x0},'ticketId':_0x5097d2['id'],'companyId':_0x5097d2['companyId']}),console[_0x328a05(0x156)](_0xf6bdc9['options']);if(_0xf6bdc9[_0x328a05(0x1cb)]['length']===0x0){const _0x2e55b9=await Queue_1['default'][_0x328a05(0x21a)](_0xf6bdc9['id']),{schedules:_0x341592}=_0x2e55b9,_0x287d07=(0x0,moment_1[_0x328a05(0x16c)])(),_0x2d4fde=_0x287d07[_0x328a05(0x29a)](_0x328a05(0x158))[_0x328a05(0x1d5)]();let _0x226f5a;Array[_0x328a05(0x217)](_0x341592)&&_0x341592[_0x328a05(0x1ef)]>0x0&&(_0x226f5a=_0x341592[_0x328a05(0x2ac)](_0x424529=>_0x424529[_0x328a05(0x1ad)]===_0x2d4fde&&_0x424529[_0x328a05(0x292)]!==''&&_0x424529[_0x328a05(0x292)]!==null&&_0x424529['endTime']!==''&&_0x424529['endTime']!==null));if(_0x2e55b9[_0x328a05(0x1fc)]!==null&&_0x2e55b9[_0x328a05(0x1fc)]!==''&&!(0x0,lodash_1[_0x328a05(0x20a)])(_0x226f5a)){var _0x19bdfe=outOfHourMessageControl[_0x328a05(0x2ac)](_0x2c8413=>_0x2c8413[_0x328a05(0x283)]===_0x5097d2['id']||_0x2c8413['dest']===_0x5265b2[_0x328a05(0x20f)]);if(!_0x19bdfe||_0x19bdfe&&_0x19bdfe['time']+0x3e8*0x3c*0x5<new Date()[_0x328a05(0x22f)]()){_0x19bdfe&&(outOfHourMessageControl=outOfHourMessageControl[_0x328a05(0x2ef)](_0x2c5b3=>_0x2c5b3[_0x328a05(0x283)]!==_0x5097d2['id']),_0x19bdfe=null);const _0x2cb916=(0x0,moment_1['default'])(_0x226f5a[_0x328a05(0x292)],_0x328a05(0x196)),_0x3b8bd6=(0x0,moment_1[_0x328a05(0x16c)])(_0x226f5a[_0x328a05(0x218)],'HH:mm');outOfHourMessageControl[_0x328a05(0x2eb)]({'ticketId':_0x5097d2['id'],'time':new Date()[_0x328a05(0x22f)]()});if(_0x287d07[_0x328a05(0x2b5)](_0x2cb916)||_0x287d07[_0x328a05(0x212)](_0x3b8bd6)){const _0x39fb2d=(0x0,Mustache_1['default'])('‎\x20'+_0x2e55b9[_0x328a05(0x1fc)]+_0x328a05(0x169),_0x5097d2),_0x282986=await _0x36099d[_0x328a05(0x214)](_0x5265b2[_0x328a05(0x20f)]+'@'+(_0x5097d2[_0x328a05(0x16a)]?_0x328a05(0x141):'s.whatsapp.net'),{'text':_0x39fb2d});await(0x0,exports[_0x328a05(0x286)])(_0x282986,_0x5097d2,_0x5265b2),await(0x0,UpdateTicketService_1[_0x328a05(0x16c)])({'ticketData':{'queueId':null,'chatbot':_0x15942b},'ticketId':_0x5097d2['id'],'companyId':_0x5097d2['companyId']}),console['log'](_0x328a05(0x28b));return;}}!_0x19bdfe&&outOfHourMessageControl[_0x328a05(0x2eb)]({'ticketId':_0x5097d2['id'],'dest':_0x5265b2[_0x328a05(0x20f)],'time':new Date()['getTime']()});}console['trace'](_0xf6bdc9[_0x328a05(0x2e1)]);if(!_0x1000c4[_0x328a05(0x1d2)]['fromMe']&&!_0x5097d2['isGroup']&&_0xf6bdc9['integrationId']){const _0x22736d=await(0x0,ShowQueueIntegrationService_1[_0x328a05(0x16c)])(_0xf6bdc9[_0x328a05(0x2e1)],_0x4e0a5f);await(0x0,exports['handleMessageIntegration'])(_0x1000c4,_0x36099d,_0x22736d,_0x5097d2),await _0x5097d2[_0x328a05(0x1e6)]({'useIntegration':!![],'integrationId':_0x22736d['id']});}!_0x1000c4[_0x328a05(0x1d2)][_0x328a05(0x256)]&&!_0x5097d2[_0x328a05(0x16a)]&&!(0x0,lodash_1[_0x328a05(0x20a)])(_0xf6bdc9?.['promptId'])&&(await handleOpenAi(_0x1000c4,_0x36099d,_0x5097d2,_0x5265b2,_0x236476),await _0x5097d2['update']({'useIntegration':!![],'promptId':_0xf6bdc9?.['promptId']}));const _0x379db1=(0x0,Mustache_1['default'])('‎'+_0xf6bdc9['greetingMessage'],_0x5097d2);if(_0xf6bdc9[_0x328a05(0x2c4)]){const _0x143a37=await _0x36099d[_0x328a05(0x214)](_0x5265b2[_0x328a05(0x20f)]+'@'+(_0x5097d2['isGroup']?'g.us':_0x328a05(0x1a2)),{'text':_0x379db1});await(0x0,exports[_0x328a05(0x286)])(_0x143a37,_0x5097d2,_0x5265b2);if(_0xf6bdc9['mediaPath']!==null&&_0xf6bdc9[_0x328a05(0x2aa)]!==''){const _0x51f3ae=path_1['default'][_0x328a05(0x199)]('public',_0x328a05(0x1bc)+_0xf6bdc9[_0x328a05(0x1c5)],_0xf6bdc9[_0x328a05(0x2aa)]),_0x2331b1=await(0x0,SendWhatsAppMedia_1['getMessageOptions'])(_0xf6bdc9[_0x328a05(0x2d5)],_0x51f3ae,null,_0x5097d2['companyId']);let _0x25e911=await _0x36099d[_0x328a05(0x214)](_0x5097d2[_0x328a05(0x241)]['number']+'@'+(_0x5097d2[_0x328a05(0x16a)]?'g.us':_0x328a05(0x1a2)),{..._0x2331b1});await verifyMediaMessage(_0x25e911,_0x5097d2,_0x5265b2);}}}}else{if(_0x4a884f&&_0x4a884f!==0x0&&_0x5097d2['amountUsedBotQueues']>=_0x4a884f)return;const _0x46927f=await(0x0,FindOrCreateATicketTrakingService_1[_0x328a05(0x16c)])({'ticketId':_0x5097d2['id'],'companyId':_0x4e0a5f});let _0x27214c=new Date(),_0x1f01c4=new Date();if(_0x46927f[_0x328a05(0x288)]!==null){_0x27214c[_0x328a05(0x172)](_0x46927f[_0x328a05(0x288)][_0x328a05(0x18a)]()+Number(_0x185db4));if(_0x46927f[_0x328a05(0x288)]!==null&&_0x1f01c4<_0x27214c&&_0x185db4!=='0'&&_0x5097d2[_0x328a05(0x2db)]!==0x0)return;}await _0x46927f['update']({'updatedAt':new Date()});if(_0xcb53c8[_0x328a05(0x178)]===_0x328a05(0x1f6))return console[_0x328a05(0x156)](_0x328a05(0x1e5)),_0xbba68a();}},verifyRating=_0xb9c52c=>{const _0x177a8c=a558_0xd5cd7b;return _0xb9c52c&&_0xb9c52c[_0x177a8c(0x243)]===null&&_0xb9c52c[_0x177a8c(0x16f)]!==null&&_0xb9c52c[_0x177a8c(0x177)]!==null;};exports[a558_0xd5cd7b(0x1d7)]=verifyRating;const handleRating=async(_0x25263f,_0x111331,_0x1862f7)=>{const _0x1baba3=a558_0xd5cd7b,_0x5686fe=(0x0,socket_1[_0x1baba3(0x29b)])();let _0x59cc0e=null;(_0x25263f?.['message']?.['conversation']||_0x25263f?.['message']?.[_0x1baba3(0x265)])&&(_0x59cc0e=parseInt(_0x25263f[_0x1baba3(0x200)][_0x1baba3(0x2ed)]||_0x25263f[_0x1baba3(0x200)][_0x1baba3(0x265)][_0x1baba3(0x1f6)],0xa)||null);if(!Number[_0x1baba3(0x306)](_0x59cc0e)&&Number['isInteger'](_0x59cc0e)&&!(0x0,lodash_1[_0x1baba3(0x195)])(_0x59cc0e)){const {complationMessage:_0x27ef89}=await(0x0,ShowWhatsAppService_1[_0x1baba3(0x16c)])(_0x111331['whatsappId'],_0x111331['companyId']);let _0x118d79=_0x59cc0e;_0x59cc0e<0x1&&(_0x118d79=0x1);_0x59cc0e>0x5&&(_0x118d79=0x5);await UserRating_1[_0x1baba3(0x16c)][_0x1baba3(0x205)]({'ticketId':_0x1862f7[_0x1baba3(0x283)],'companyId':_0x1862f7['companyId'],'userId':_0x1862f7[_0x1baba3(0x16f)],'rate':_0x118d79});if(_0x27ef89){if(completionMessageControl[_0x1baba3(0x1ef)]>=0x9c4)completionMessageControl=[];var _0x4d34fe=completionMessageControl[_0x1baba3(0x2ac)](_0x38b53c=>_0x38b53c[_0x1baba3(0x283)]===_0x111331['id']||_0x38b53c['dest']===_0x111331[_0x1baba3(0x241)][_0x1baba3(0x20f)]);if(!_0x4d34fe||_0x4d34fe&&_0x4d34fe['time']+0x3e8*0x3c*0x1e<new Date()[_0x1baba3(0x22f)]()){_0x4d34fe&&(completionMessageControl=completionMessageControl['filter'](_0x44c964=>_0x44c964[_0x1baba3(0x283)]!==_0x111331['id']),_0x4d34fe=null);const _0x58d361=(0x0,Mustache_1['default'])('‎'+_0x27ef89,_0x111331);await(0x0,SendPresenceStatus_1[_0x1baba3(0x2b3)])((0x0,wbot_1[_0x1baba3(0x2be)])(_0x111331[_0x1baba3(0x1a5)]),_0x111331[_0x1baba3(0x241)][_0x1baba3(0x20f)]+'@'+(_0x111331[_0x1baba3(0x16a)]?_0x1baba3(0x141):_0x1baba3(0x1a2))),await(0x0,SendWhatsAppMessage_1[_0x1baba3(0x16c)])({'body':_0x58d361,'ticket':_0x111331});}!_0x4d34fe&&completionMessageControl['push']({'ticketId':_0x111331['id'],'dest':_0x111331[_0x1baba3(0x241)][_0x1baba3(0x20f)],'time':new Date()[_0x1baba3(0x22f)]()});}await _0x1862f7[_0x1baba3(0x1e6)]({'finishedAt':(0x0,moment_1[_0x1baba3(0x16c)])()[_0x1baba3(0x1f7)](),'ratedAt':(0x0,moment_1[_0x1baba3(0x16c)])()[_0x1baba3(0x1f7)](),'rated':!![]}),await _0x111331[_0x1baba3(0x1e6)]({'queueId':null,'chatbot':null,'queueOptionId':null,'userId':null,'status':_0x1baba3(0x221)}),_0x5686fe['to']('company-'+_0x111331[_0x1baba3(0x1c5)]+_0x1baba3(0x22a))[_0x1baba3(0x2fa)](_0x1baba3(0x307)+_0x111331[_0x1baba3(0x1c5)]+_0x1baba3(0x157),{'action':_0x1baba3(0x258),'ticket':_0x111331,'ticketId':_0x111331['id']}),_0x5686fe['to'](_0x1baba3(0x307)+_0x111331[_0x1baba3(0x1c5)]+'-'+_0x111331['status'])['to'](_0x111331['id'][_0x1baba3(0x2ce)]())[_0x1baba3(0x2fa)]('company-'+_0x111331['companyId']+_0x1baba3(0x157),{'action':_0x1baba3(0x1e6),'ticket':_0x111331,'ticketId':_0x111331['id']});}};exports['handleRating']=handleRating;const handleChartbot=async(_0x35aabd,_0x458643,_0x54f4b8,_0x5d735a,_0x324c23=![])=>{const _0x354022=a558_0xd5cd7b;if(!_0x35aabd['contact'][_0x354022(0x2f9)]){const _0x58ca8c=await Queue_1['default']['findByPk'](_0x35aabd[_0x354022(0x171)],{'include':[{'model':QueueOption_1[_0x354022(0x16c)],'as':'options','where':{'parentId':null},'order':[[_0x354022(0x1cc),'ASC'],['createdAt',_0x354022(0x2b1)]]}]}),_0x39b6b8=_0x458643?.[_0x354022(0x200)]?.[_0x354022(0x2bc)]?.['selectedButtonId']||_0x458643?.['message']?.[_0x354022(0x194)]?.['singleSelectReply']?.[_0x354022(0x184)]||_0x458643?.[_0x354022(0x200)]?.['extendedTextMessage']?.[_0x354022(0x1f6)]||_0x458643?.[_0x354022(0x200)]?.[_0x354022(0x2ed)];if(_0x39b6b8=='#'&&(!_0x35aabd[_0x354022(0x16f)]||_0x35aabd['status']=='pending')){console[_0x354022(0x156)](_0x354022(0x144)),await _0x35aabd[_0x354022(0x1e6)]({'queueOptionId':null,'chatbot':![],'queueId':null,'amountUsedBotQueues':0x0}),await verifyQueue(_0x54f4b8,_0x458643,_0x35aabd,_0x35aabd[_0x354022(0x241)]);return;}if(!(0x0,lodash_1['isNil'])(_0x58ca8c)&&!(0x0,lodash_1[_0x354022(0x20a)])(_0x35aabd[_0x354022(0x23f)])&&_0x39b6b8=='0'){console[_0x354022(0x156)](_0x354022(0x18e));const _0x50aa93=await QueueOption_1[_0x354022(0x16c)][_0x354022(0x21a)](_0x35aabd['queueOptionId']);await _0x35aabd['update']({'queueOptionId':_0x50aa93?.[_0x354022(0x1c2)],'amountUsedBotQueues':0x0});}else{if(!(0x0,lodash_1[_0x354022(0x20a)])(_0x58ca8c)&&!(0x0,lodash_1['isNil'])(_0x35aabd[_0x354022(0x23f)])){console['trace']('segundo\x20if');const _0x860eaf=await QueueOption_1['default']['count']({'where':{'parentId':_0x35aabd[_0x354022(0x23f)]}});let _0x4445ea={};_0x860eaf==0x1?_0x4445ea=await QueueOption_1['default'][_0x354022(0x260)]({'where':{'parentId':_0x35aabd[_0x354022(0x23f)]}}):(console[_0x354022(0x156)](_0x354022(0x294)),_0x4445ea=await QueueOption_1[_0x354022(0x16c)]['findOne']({'where':{[sequelize_1['Op']['or']]:[{'option':_0x39b6b8||''},{'title':_0x39b6b8||''}],'parentId':_0x35aabd[_0x354022(0x23f)]}})),_0x4445ea&&await _0x35aabd[_0x354022(0x1e6)]({'queueOptionId':_0x4445ea?.['id'],'amountUsedBotQueues':0x0});}else{if(!(0x0,lodash_1['isNil'])(_0x58ca8c)&&(0x0,lodash_1[_0x354022(0x20a)])(_0x35aabd[_0x354022(0x23f)])&&!_0x324c23){console[_0x354022(0x156)]('quarto\x20if');const _0x2f0295=_0x58ca8c?.[_0x354022(0x1cb)][_0x354022(0x2ac)](_0x2c4d4c=>_0x2c4d4c[_0x354022(0x1cc)]==_0x39b6b8||_0x2c4d4c[_0x354022(0x147)][_0x354022(0x1d5)]()==_0x39b6b8[_0x354022(0x1d5)]());if(_0x2f0295)await _0x35aabd[_0x354022(0x1e6)]({'queueOptionId':_0x2f0295?.['id'],'amountUsedBotQueues':0x0});else{if(_0x5d735a[_0x354022(0x1ce)]&&_0x5d735a['maxUseBotQueues']!==0x0&&_0x35aabd[_0x354022(0x2db)]>=_0x5d735a['maxUseBotQueues'])return;await _0x35aabd[_0x354022(0x1e6)]({'amountUsedBotQueues':_0x35aabd[_0x354022(0x2db)]+0x1});}}else{if(_0x5d735a[_0x354022(0x1ce)]&&_0x5d735a[_0x354022(0x1ce)]!==0x0&&_0x35aabd[_0x354022(0x2db)]>=_0x5d735a['maxUseBotQueues'])return;await _0x35aabd['update']({'amountUsedBotQueues':_0x35aabd[_0x354022(0x2db)]+0x1});}}}await _0x35aabd[_0x354022(0x2f4)]();if(!(0x0,lodash_1[_0x354022(0x20a)])(_0x58ca8c)&&(0x0,lodash_1[_0x354022(0x20a)])(_0x35aabd['queueOptionId'])){const _0x1d418e=await QueueOption_1[_0x354022(0x16c)][_0x354022(0x188)]({'where':{'queueId':_0x35aabd[_0x354022(0x171)],'parentId':null},'order':[[_0x354022(0x1cc),_0x354022(0x2b1)],['createdAt','ASC']]}),_0x1f3789=_0x35aabd[_0x354022(0x1c5)],_0x3f87a2=await Setting_1[_0x354022(0x16c)]['findOne']({'where':{'key':_0x354022(0x148),'companyId':_0x1f3789}}),_0x4ac4d0=async()=>{const _0x1515db=_0x354022,_0x4aeaef=[];_0x1d418e[_0x1515db(0x2e7)]((_0x210072,_0x504674)=>{const _0x51ce2c=_0x1515db;_0x4aeaef[_0x51ce2c(0x2eb)]({'buttonId':''+_0x210072[_0x51ce2c(0x1cc)],'buttonText':{'displayText':_0x210072[_0x51ce2c(0x147)]},'type':0x4});}),_0x4aeaef[_0x1515db(0x2eb)]({'buttonId':'#','buttonText':{'displayText':'Menu\x20inicial\x20*[\x200\x20]*\x20Menu\x20anterior'},'type':0x4});const _0x157bf2={'text':(0x0,Mustache_1[_0x1515db(0x16c)])('‎'+_0x58ca8c[_0x1515db(0x2c4)],_0x35aabd),'buttons':_0x4aeaef,'footer':'DAUMZAP','headerType':0x1},_0x549d09=await _0x54f4b8['sendMessage'](_0x35aabd['contact'][_0x1515db(0x20f)]+'@'+(_0x35aabd[_0x1515db(0x16a)]?_0x1515db(0x141):_0x1515db(0x1a2)),_0x157bf2);await(0x0,exports[_0x1515db(0x286)])(_0x549d09,_0x35aabd,_0x35aabd[_0x1515db(0x241)]);},_0x98249a=async()=>{const _0x50310a=_0x354022;let _0x41b889='';console[_0x50310a(0x156)]('botText'),console[_0x50310a(0x179)](_0x58ca8c[_0x50310a(0x2aa)]),_0x1d418e[_0x50310a(0x2e7)]((_0x2e8c72,_0x9d4d65)=>{const _0x2d0246=_0x50310a;_0x41b889+=_0x2d0246(0x297)+_0x2e8c72[_0x2d0246(0x1cc)]+'\x20]*\x20-\x20'+_0x2e8c72[_0x2d0246(0x147)]+'\x0a';}),_0x41b889+=_0x50310a(0x15d);const _0x5dd5d7={'text':(0x0,Mustache_1[_0x50310a(0x16c)])('‎'+_0x58ca8c[_0x50310a(0x2c4)]+'\x0a\x0a'+_0x41b889,_0x35aabd)};let _0x1b3f8c;if(!_0x58ca8c[_0x50310a(0x2aa)])_0x1b3f8c=await _0x54f4b8[_0x50310a(0x214)](_0x35aabd[_0x50310a(0x241)]['number']+'@'+(_0x35aabd['isGroup']?_0x50310a(0x141):'s.whatsapp.net'),_0x5dd5d7),await(0x0,exports[_0x50310a(0x286)])(_0x1b3f8c,_0x35aabd,_0x35aabd[_0x50310a(0x241)]);else{const _0x1d3a7b=path_1['default'][_0x50310a(0x199)](_0x50310a(0x300),_0x50310a(0x1bc)+_0x35aabd[_0x50310a(0x1c5)],_0x58ca8c[_0x50310a(0x2aa)]),_0x2f94ef=await(0x0,SendWhatsAppMedia_1[_0x50310a(0x2a8)])(_0x5dd5d7[_0x50310a(0x1f6)],_0x1d3a7b,_0x5dd5d7[_0x50310a(0x1f6)],_0x35aabd[_0x50310a(0x1c5)]);_0x1b3f8c=await _0x54f4b8[_0x50310a(0x214)](_0x35aabd[_0x50310a(0x241)][_0x50310a(0x20f)]+'@'+(_0x35aabd['isGroup']?_0x50310a(0x141):_0x50310a(0x1a2)),{..._0x2f94ef}),await verifyMediaMessage(_0x1b3f8c,_0x35aabd,_0x35aabd[_0x50310a(0x241)]);}};if(_0x3f87a2[_0x354022(0x178)]==='button'&&QueueOption_1[_0x354022(0x16c)][_0x354022(0x1ef)]<=0x4)return _0x4ac4d0();if(_0x3f87a2[_0x354022(0x178)]===_0x354022(0x1f6))return console[_0x354022(0x156)](_0x354022(0x1e5)),_0x98249a();if(_0x3f87a2[_0x354022(0x178)]===_0x354022(0x25a)&&QueueOption_1[_0x354022(0x16c)][_0x354022(0x1ef)]>0x4)return console[_0x354022(0x156)](_0x354022(0x1e5)),_0x98249a();}else{if(!(0x0,lodash_1[_0x354022(0x20a)])(_0x58ca8c)&&!(0x0,lodash_1[_0x354022(0x20a)])(_0x35aabd[_0x354022(0x23f)])){const _0x13b6a2=await QueueOption_1[_0x354022(0x16c)][_0x354022(0x21a)](_0x35aabd[_0x354022(0x23f)]),_0x44e446=await QueueOption_1[_0x354022(0x16c)][_0x354022(0x188)]({'where':{'parentId':_0x35aabd['queueOptionId']},'order':[[_0x354022(0x1cc),_0x354022(0x2b1)],[_0x354022(0x277),'ASC']]});if(_0x44e446[_0x354022(0x1ef)]===0x0){const _0x4ee2c4={'text':(0x0,Mustache_1[_0x354022(0x16c)])('‎'+_0x13b6a2['message'],_0x35aabd)},_0x51ffa0=await _0x54f4b8[_0x354022(0x214)](_0x35aabd[_0x354022(0x241)][_0x354022(0x20f)]+'@'+(_0x35aabd['isGroup']?'g.us':'s.whatsapp.net'),_0x4ee2c4);await(0x0,exports['verifyMessage'])(_0x51ffa0,_0x35aabd,_0x35aabd[_0x354022(0x241)]),await _0x35aabd[_0x354022(0x1e6)]({'queueOptionId':null,'chatbot':![]});return;}if(_0x44e446['length']>-0x1){const _0x382c08=_0x35aabd['companyId'],_0xd0bc83=await Setting_1[_0x354022(0x16c)][_0x354022(0x260)]({'where':{'key':_0x354022(0x148),'companyId':_0x382c08}}),_0x57ccf6=async()=>{const _0x2a75c2=_0x354022,_0x304fc1=[],_0x359709=_0x35aabd[_0x2a75c2(0x1c5)],_0x5e0614=await getQueues(_0x359709),_0x13d2a8=await getContactFromTicket(_0x35aabd['id']);_0x5e0614['forEach']((_0x5ec65a,_0x273349)=>{const _0x246718=_0x2a75c2;_0x304fc1[_0x246718(0x2eb)]({'title':'['+(_0x273349+0x1)+_0x246718(0x2c2)+_0x5ec65a[_0x246718(0x24e)],'rowId':''+(_0x273349+0x1)});});const _0x2572cb=[{'rows':_0x304fc1}],_0x2235ec={'text':(0x0,Mustache_1['default'])('‎'+_0x13b6a2[_0x2a75c2(0x200)],_0x35aabd),'title':_0x2a75c2(0x253),'buttonText':_0x2a75c2(0x304),'sections':_0x2572cb};await sleep(0x3e8);const _0x2c0b3c=await _0x54f4b8[_0x2a75c2(0x214)]('\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+_0x13d2a8[_0x2a75c2(0x20f)]+'@'+(_0x35aabd[_0x2a75c2(0x16a)]?_0x2a75c2(0x141):_0x2a75c2(0x1a2)),_0x2235ec);await(0x0,exports[_0x2a75c2(0x286)])(_0x2c0b3c,_0x35aabd,_0x35aabd[_0x2a75c2(0x241)]);},_0x3015c9=async()=>{const _0x37adad=_0x354022,_0xdc2df3=[];_0x44e446[_0x37adad(0x2e7)]((_0x349efd,_0x2d9a14)=>{const _0x2d6994=_0x37adad;_0xdc2df3['push']({'buttonId':''+_0x349efd['option'],'buttonText':{'displayText':_0x349efd[_0x2d6994(0x147)]},'type':0x4});}),_0xdc2df3[_0x37adad(0x2eb)]({'buttonId':'#','buttonText':{'displayText':'Menu\x20inicial\x20*[\x200\x20]*\x20Menu\x20anterior'},'type':0x4});const _0x1fa8e1={'text':(0x0,Mustache_1[_0x37adad(0x16c)])('‎'+_0x13b6a2[_0x37adad(0x200)],_0x35aabd),'buttons':_0xdc2df3,'headerType':0x4};if(process[_0x37adad(0x1c1)][_0x37adad(0x22c)]?.[_0x37adad(0x1ef)]>=0x8){if(_0x35aabd[_0x37adad(0x241)][_0x37adad(0x20f)]!=process[_0x37adad(0x1c1)][_0x37adad(0x22c)]){console[_0x37adad(0x156)](_0x37adad(0x232));return;}}if(!_0x13b6a2[_0x37adad(0x2aa)]){const _0x514a76=await _0x54f4b8[_0x37adad(0x214)](_0x35aabd[_0x37adad(0x241)][_0x37adad(0x20f)]+'@'+(_0x35aabd['isGroup']?'g.us':_0x37adad(0x1a2)),_0x1fa8e1);await(0x0,exports[_0x37adad(0x286)])(_0x514a76,_0x35aabd,_0x35aabd[_0x37adad(0x241)]);}else{const _0x42809e=path_1[_0x37adad(0x16c)][_0x37adad(0x199)](_0x37adad(0x300),_0x37adad(0x1bc)+_0x35aabd[_0x37adad(0x1c5)],_0x13b6a2['mediaPath']),_0x28cc93=await(0x0,SendWhatsAppMedia_1[_0x37adad(0x2a8)])(_0x13b6a2['mediaName'],_0x42809e,_0x1fa8e1[_0x37adad(0x1f6)],_0x35aabd[_0x37adad(0x1c5)]);let _0x567cd6=await _0x54f4b8['sendMessage'](_0x35aabd[_0x37adad(0x241)]['number']+'@'+(_0x35aabd[_0x37adad(0x16a)]?'g.us':_0x37adad(0x1a2)),{..._0x28cc93});await verifyMediaMessage(_0x567cd6,_0x35aabd,_0x35aabd[_0x37adad(0x241)]);}const _0x5072be=await _0x54f4b8['sendMessage'](_0x35aabd[_0x37adad(0x241)][_0x37adad(0x20f)]+'@'+(_0x35aabd[_0x37adad(0x16a)]?_0x37adad(0x141):'s.whatsapp.net'),_0x1fa8e1);await(0x0,exports[_0x37adad(0x286)])(_0x5072be,_0x35aabd,_0x35aabd['contact']);},_0x146b49=async()=>{const _0x100edd=_0x354022;let _0x5c9346='';_0x44e446[_0x100edd(0x2e7)]((_0x3109fe,_0x47e947)=>{const _0x2da619=_0x100edd;_0x5c9346+=_0x2da619(0x297)+_0x3109fe[_0x2da619(0x1cc)]+_0x2da619(0x2a0)+_0x3109fe[_0x2da619(0x147)]+'\x0a';}),_0x5c9346+=_0x100edd(0x21f),_0x5c9346+='\x0a*[\x20#\x20]*\x20-\x20Menu\x20inicial';const _0x1334bd={'text':(0x0,Mustache_1['default'])('‎'+_0x13b6a2['message']+'\x0a\x0a'+_0x5c9346,_0x35aabd)};if(process['env'][_0x100edd(0x22c)]?.[_0x100edd(0x1ef)]>=0x8){if(_0x35aabd[_0x100edd(0x241)][_0x100edd(0x20f)]!=process[_0x100edd(0x1c1)][_0x100edd(0x22c)]){console['trace']('chatbot\x20desativado!');return;}}if(!_0x13b6a2[_0x100edd(0x2aa)]){const _0x52e68b=await _0x54f4b8[_0x100edd(0x214)](_0x35aabd['contact'][_0x100edd(0x20f)]+'@'+(_0x35aabd[_0x100edd(0x16a)]?'g.us':_0x100edd(0x1a2)),_0x1334bd);await(0x0,exports[_0x100edd(0x286)])(_0x52e68b,_0x35aabd,_0x35aabd['contact']);}else{const _0x24c4db=path_1['default']['resolve'](_0x100edd(0x300),_0x100edd(0x1bc)+_0x35aabd[_0x100edd(0x1c5)],_0x13b6a2[_0x100edd(0x2aa)]),_0x52d19b=await(0x0,SendWhatsAppMedia_1[_0x100edd(0x2a8)])(_0x13b6a2['mediaName'],_0x24c4db,_0x1334bd[_0x100edd(0x1f6)],_0x35aabd[_0x100edd(0x1c5)]);let _0x3a5915=await _0x54f4b8['sendMessage'](_0x35aabd['contact'][_0x100edd(0x20f)]+'@'+(_0x35aabd[_0x100edd(0x16a)]?_0x100edd(0x141):_0x100edd(0x1a2)),{..._0x52d19b});await verifyMediaMessage(_0x3a5915,_0x35aabd,_0x35aabd['contact']);}};if(_0xd0bc83[_0x354022(0x178)]==='list')return _0x57ccf6();if(_0xd0bc83[_0x354022(0x178)]==='button'&&QueueOption_1[_0x354022(0x16c)][_0x354022(0x1ef)]<=0x4)return _0x3015c9();if(_0xd0bc83[_0x354022(0x178)]===_0x354022(0x1f6))return console['trace'](_0x354022(0x1fb)),_0x146b49();if(_0xd0bc83[_0x354022(0x178)]==='button'&&QueueOption_1[_0x354022(0x16c)][_0x354022(0x1ef)]>0x4)return console[_0x354022(0x156)](_0x354022(0x28e)),_0x146b49();}}}}},handleMessageIntegration=async(_0x43b676,_0x4ea795,_0x4984a4,_0x4fb20c)=>{const _0x2c9d67=a558_0xd5cd7b;if(process[_0x2c9d67(0x1c1)]['CHATBOT_RESTRICT_NUMBER']){if(_0x4fb20c['contact']['number']!=process[_0x2c9d67(0x1c1)][_0x2c9d67(0x22c)]){console[_0x2c9d67(0x179)](_0x2c9d67(0x232));return;}}const _0x4d291a=getTypeMessage(_0x43b676);if(_0x4984a4[_0x2c9d67(0x235)]==='n8n'||_0x4984a4['type']===_0x2c9d67(0x245)){if(_0x4984a4?.[_0x2c9d67(0x2bb)]){const _0x7cbf14={'method':_0x2c9d67(0x1db),'url':_0x4984a4?.[_0x2c9d67(0x2bb)],'headers':{'Content-Type':_0x2c9d67(0x20c)},'json':_0x43b676};try{(0x0,request_1[_0x2c9d67(0x16c)])(_0x7cbf14,function(_0x26674d,_0x32f436){const _0x453f82=_0x2c9d67;if(_0x26674d)throw new Error(_0x26674d);else console[_0x453f82(0x179)](_0x32f436[_0x453f82(0x1e0)]);});}catch(_0x4ae6bc){throw new Error(_0x4ae6bc);}}}else _0x4984a4[_0x2c9d67(0x235)]==='typebot'&&await(0x0,typebotListener_1[_0x2c9d67(0x16c)])({'ticket':_0x4fb20c,'msg':_0x43b676,'wbot':_0x4ea795,'typebot':_0x4984a4});};exports[a558_0xd5cd7b(0x2a3)]=handleMessageIntegration;function a558_0x376e(){const _0x5c07ae=['\x20para\x20identificar\x20o\x20cliente.\x0aSua\x20resposta\x20deve\x20usar\x20no\x20máximo\x20','finishedAt','viewOnceMessageV2','webhook','floor','writeFile','getPaymentMessage','Error\x20handling\x20message\x20ack.\x20Err:\x20','SAIR','getQuotedMessage','existsSync','voiceMessage','name','chmodSync','113443lmPLRJ','Pedido','__importDefault','Lista','fromAudioFileOutput','close','fromMe','verifyCampaignMessageAndCloseTicket','delete','Erro\x20para\x20responder\x20com\x20audio:\x20','button','status','getStickerMessage','captureException','endsWith','subject','findOne','38070XTFqpH','documentWithCaptionMessage','Múltiplos\x20Produtos','configurable','extendedTextMessage','Importando\x20mensagens!!','buttonsMessage','participant','substring','document','application','@sentry/node','trim','warn','dataJson','indexOf','proto','toFormat','remoteJid','reactionMessage','useIntegration','promptId','createdAt','debug','contacts','@g.us','setExtra','editedMessage','getTemplateMessage','1QCsXNW','DispatchCampaign','util','hydratedHsm','chat','ticketId','maxMessages','ffmpeg-static','verifyMessage','defineProperty','chatbotAt','liveLocationMessage','1590453YOWdXH','fora\x20do\x20horario','handleMessage','readFileSync','botText\x202','debounce','videoMessage','data:image/png;base64,\x20','startTime','header','terceiro\x20if','advertising','url','*[\x20','quotedMsg','assistant','format','getIO','greetingMediaAttachment','894nrOTUn','selectedButtonId','Status','\x20]*\x20-\x20','head','changed','handleMessageIntegration','mediaType','sendMessageLink','keys','save','getMessageOptions','values','mediaPath','Configuration','find','gte','join','map','unknown','ASC','Mensagem\x20editada\x20não\x20encontrada:\x20','SendPresenceStatus','mimetype','isBefore','Erro\x20ao\x20salvar\x20ticket!','cacheLayer','removeNonPrintableChars','string','audioMessage','urlN8N','buttonsResponseMessage','mkdirSync','getWbot','Mensagem\x20inválida!','then','voice',']\x20-\x20','stickerMessage','greetingMessage','./SendWhatsAppMessage','input','pollCreationMessageV2','microsoft-cognitiveservices-speech-sdk','sleep','__esModule','verifyRecentCampaign','../../models/Campaign','../TicketServices/FindOrCreateTicketService','toString','apiKey','../../models/User','ack','queues','count','getContactsArrayMessage','mediaName','../../models/UserRating','campaignQueue','Erro\x20ao\x20buscar\x20grupo!','concat','../../helpers/MakeRandomId','amountUsedBotQueues','update!','Error:\x20','filename','Mensagem\x20de\x20grupo\x20bloqueada!','isValidMsg','integrationId','Throttle','extension','ERR_WAPP_DOWNLOAD_MEDIA','No\x20result\x20from\x20synthesizer','createChatCompletion','forEach','sequelize','getOwnPropertyDescriptor','.wav','push','-appMessage','conversation','keywords','filter','randomValue','sendMessageImage','215388KpMrKo','getCallMessage','reload','./providers','viewOnceMessage','403YtNebd','../../models/Contact','disableBot','emit','data','setFfmpegPath','enabled','texto','DELIVERY_ACK','public','No\x20contact\x20found\x20for\x20this\x20ticket.','\x20tokens\x20e\x20cuide\x20para\x20não\x20truncar\x20o\x20final.\x0aSempre\x20que\x20possível,\x20mencione\x20o\x20nome\x20dele\x20para\x20ser\x20mais\x20personalizado\x20o\x20atendimento\x20e\x20mais\x20educado.\x20Quando\x20a\x20resposta\x20requer\x20uma\x20transferência\x20para\x20o\x20setor\x20de\x20atendimento,\x20comece\x20sua\x20resposta\x20com\x20\x27Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento\x27.\x0a\x0a\x20\x20','includes','Escolha\x20uma\x20opção','PENDING','isNaN','company-','handleRating','image/jpeg','imageMessage','g.us','Expected\x20bodyMessage\x20to\x20be\x20a\x20string,\x20got:','replace','##\x20if','subtract','E2E_DEVICE_CHANGED','title','chatBotType','Error\x20isValidMsg','productImage','340tOoQUh','hasOwnProperty','Mensagem\x20inválida\x208!\x20','openai','1930130nAuseU','../../helpers/SendPresenceStatus','templateButtonReplyMessage','caption','&z=17&hl=pt-BR|','Atualização\x20de\x20Status','charAt','trace','-ticket','dddd','SpeechSynthesizer','getReactionMessage','isNumeric','highlyStructuredMessage','\x0a*[\x20#\x20]*\x20-\x20Menu\x20inicial','catch','jidNormalizedUser','error','ephemeralMessage','makeid','promisify','../../models/Message','search','voiceKey','ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789','downloadContentFromMessage','\x0a\x0a*[\x20#\x20]*\x20-\x20Voltar\x20ao\x20Menu\x20Principal','isGroup','Ação:\x20Transferir\x20para\x20o\x20setor\x20de\x20atendimento','default','pending','8182916sdbJMl','userId','moment','queueId','setMinutes','SERVER_ACK','stream-throttle','../../libs/cache','get','ratingAt','value','log','startLunchTime','READ','locationMessage','getBodyMessage','contacts:','mediaMessage','pushName','selectedId','\x20Download\x20completed\x20in\x20','WAMessageStubType','selectedRowId','handleMsgAck','CIPHERTEXT','getListMessage','findAll','media','getMinutes','WebMessageInfo','speakTextAsync','toUpperCase','primeiro\x20if','../MessageServices/CreateMessageService','scheduleType','SpeechConfig','validaCpfCnpj','270tXkBAS','listResponseMessage','isNull','HH:mm','split','system','resolve','allowGroup','PLAYED','templateMessage','quotedMessage','dest','degreesLatitude','Latitude:\x20','Amigo(a)','s.whatsapp.net','minutes','end','whatsappId','user','Failed\x20to\x20get\x20stream','contextInfo','interactiveMessage','Mensagem\x20interativa\x20não\x20suportada,\x20abra\x20o\x20dispositivo\x20para\x20ler.','../../app','application/pdf','weekdayEn','REVOKE','getBodyButton','getGroupInviteMessage','listMessage','createReadStream','.mp3','hydratedFourRowTemplate','test','wbotMessageListener','content','Erro\x20ao\x20deletar\x20o\x20arquivo:','../../libs/socket','__importStar','fluent-ffmpeg','company','makeRandomId','../WhatsappService/ShowWhatsAppService','Convite\x20Revogado','unlinkSync','env','parentId','protocolMessage','Erro\x20ao\x20salvar\x20mensagem!','companyId','getViewOnceMessage','contactsArrayMessage','\x20de\x20baixar\x20o\x20arquivo\x20','####\x20Nao\x20achou\x20o\x20type\x20em\x20isValidMsg:\x20','audio/mpeg','options','option','campaignId','maxUseBotQueues','provider','whisper-1','next','key','status@broadcast','mp3','toLowerCase','Erro\x20ao\x20salvar\x20avaliação!','verifyRating','now','body\x20is\x20not\x20a\x20string','contactMessage','POST','getViewOnceMessageV2','toFixed','getAudioMessage','chatbot','body','from','Solicitação\x20de\x20Pagamento','getContentType','pollCreationMessageV3','botText','update','messages','voiceRegion','logger','random','pipe','stanzaId','documentMessage','../../models/QueueOption','length','\x201286\x20-\x20Entrei\x20na\x20integracao\x20openai.','updatedAt','parseToMilliseconds','singleSelectReply','getButtonsMessage','\x20-\x20Longitude:\x20','text','toDate','8IjDovm','queue','Mensagem','botText\x203','outOfHoursMessage','maxTokens','writable','min','message','../../helpers/Debounce','createTranscription','CheckMsgIsGroup','constructor','create','hydratedTemplate','slice','Error\x20handling\x20whatsapp\x20message:\x20Err:\x20','../TypebotServices/typebotListener','isNil','../../models/Setting','application/json',':unreads','Não\x20consegui\x20enviar\x20o\x20PDF,\x20tente\x20novamente!','number','*Você\x20encerrou\x20este\x20atendimento\x20usando\x20o\x20comando\x20SAIR*.\x0a\x0a\x0aSe\x20você\x20finalizou\x20o\x20atendimento\x20*ANTES*\x20de\x20receber\x20um\x20retorno\x20do\x20operador,\x20ele\x20*NÃO*\x20irá\x20visualizar\x20sua\x20solicitação!\x0a\x0aVocê\x20deve\x20aguardar\x20o\x20retorno\x20do\x20operador\x20e\x20que\x20ele\x20encerre\x20seu\x20atendimento\x20quando\x20necessário.\x0a\x0aUse\x20a\x20opção\x20*SAIR*\x20somente\x20em\x20casos\x20de\x20emergência\x20ou\x20se\x20ficou\x20preso\x20em\x20algum\x20setor.\x0a\x0a\x0aPara\x20iniciar\x20um\x20novo\x20atendimento\x20basta\x20enviar\x20uma\x20nova\x20mensagem!','HandleMessageJob','isAfter','speechSynthesisVoiceName','sendMessage','product','verifyQuotedMessage','isArray','endTime','getQuotedMessageId','findByPk','__createBinding','Error\x20getting\x20message\x20body:','add','choices','\x0a*[\x200\x20]*\x20-\x20Menu\x20anterior','temperature','closed','fourRowTemplate','mime','base64','productMessage','inActivity','stringify','getTextMessage','../../queues','-open','\x20seconds\x20with\x20an\x20effective\x20speed\x20of\x20','CHATBOT_RESTRICT_NUMBER','pop','prompt','getTime','../../models/Queue','(((.+)+)+)+$','chatbot\x20desativado!','public/temp/','\x20MBps','type','../../models/OldMessage','endLunchTime','Enquete\x20não\x20suportada,\x20abra\x20o\x20dispositivo\x20para\x20ler.','call','Novo\x20Tipo\x20de\x20Mensagem\x20em\x20isValidMsg','reaction','Message','./SendWhatsAppMedia','path','queueOptionId','13101seuCUj','contact'];a558_0x376e=function(){return _0x5c07ae;};return a558_0x376e();}const messageContainsMedia=_0x1668d4=>{const _0x58d243=a558_0xd5cd7b;return _0x1668d4[_0x58d243(0x200)]?.[_0x58d243(0x140)]||_0x1668d4[_0x58d243(0x200)]?.[_0x58d243(0x2ba)]||_0x1668d4[_0x58d243(0x200)]?.[_0x58d243(0x290)]||_0x1668d4['message']?.[_0x58d243(0x2c3)]||_0x1668d4[_0x58d243(0x200)]?.[_0x58d243(0x1ed)]||_0x1668d4[_0x58d243(0x200)]?.[_0x58d243(0x262)]?.[_0x58d243(0x200)]?.[_0x58d243(0x1ed)]||_0x1668d4[_0x58d243(0x200)]?.[_0x58d243(0x161)]?.[_0x58d243(0x200)]?.[_0x58d243(0x2ba)]||_0x1668d4[_0x58d243(0x200)]?.['ephemeralMessage']?.[_0x58d243(0x200)]?.[_0x58d243(0x1ed)]||_0x1668d4[_0x58d243(0x200)]?.[_0x58d243(0x161)]?.[_0x58d243(0x200)]?.[_0x58d243(0x290)]||_0x1668d4[_0x58d243(0x200)]?.[_0x58d243(0x161)]?.[_0x58d243(0x200)]?.[_0x58d243(0x2c3)]||_0x1668d4[_0x58d243(0x200)]?.[_0x58d243(0x161)]?.['message']?.[_0x58d243(0x140)]||_0x1668d4[_0x58d243(0x200)]?.[_0x58d243(0x2f6)]?.['message']?.[_0x58d243(0x140)]||_0x1668d4[_0x58d243(0x200)]?.[_0x58d243(0x2f6)]?.['message']?.['videoMessage']||_0x1668d4[_0x58d243(0x200)]?.[_0x58d243(0x161)]?.[_0x58d243(0x200)]?.[_0x58d243(0x2f6)]?.[_0x58d243(0x200)]?.[_0x58d243(0x140)]||_0x1668d4[_0x58d243(0x200)]?.[_0x58d243(0x161)]?.[_0x58d243(0x200)]?.[_0x58d243(0x2f6)]?.[_0x58d243(0x200)]?.[_0x58d243(0x290)]||_0x1668d4[_0x58d243(0x200)]?.['ephemeralMessage']?.['message']?.[_0x58d243(0x2f6)]?.['message']?.['audioMessage']||_0x1668d4[_0x58d243(0x200)]?.[_0x58d243(0x161)]?.[_0x58d243(0x200)]?.[_0x58d243(0x2f6)]?.[_0x58d243(0x200)]?.[_0x58d243(0x1ed)]||_0x1668d4[_0x58d243(0x200)]?.[_0x58d243(0x262)]?.['message']?.[_0x58d243(0x1ed)]||_0x1668d4[_0x58d243(0x200)]?.[_0x58d243(0x19c)]?.[_0x58d243(0x206)]?.[_0x58d243(0x140)]||_0x1668d4[_0x58d243(0x200)]?.[_0x58d243(0x19c)]?.[_0x58d243(0x206)]?.[_0x58d243(0x1ed)]||_0x1668d4[_0x58d243(0x200)]?.[_0x58d243(0x19c)]?.[_0x58d243(0x206)]?.[_0x58d243(0x290)]||_0x1668d4[_0x58d243(0x200)]?.['templateMessage']?.['hydratedFourRowTemplate']?.[_0x58d243(0x140)]||_0x1668d4['message']?.['templateMessage']?.[_0x58d243(0x1b4)]?.[_0x58d243(0x1ed)]||_0x1668d4['message']?.[_0x58d243(0x19c)]?.[_0x58d243(0x1b4)]?.[_0x58d243(0x290)]||_0x1668d4[_0x58d243(0x200)]?.[_0x58d243(0x19c)]?.[_0x58d243(0x222)]?.[_0x58d243(0x140)]||_0x1668d4['message']?.[_0x58d243(0x19c)]?.[_0x58d243(0x222)]?.[_0x58d243(0x1ed)]||_0x1668d4['message']?.[_0x58d243(0x19c)]?.[_0x58d243(0x222)]?.[_0x58d243(0x290)]||_0x1668d4['message']?.[_0x58d243(0x1a9)]?.[_0x58d243(0x293)]?.['imageMessage']||_0x1668d4[_0x58d243(0x200)]?.[_0x58d243(0x1a9)]?.[_0x58d243(0x293)]?.[_0x58d243(0x1ed)]||_0x1668d4[_0x58d243(0x200)]?.[_0x58d243(0x1a9)]?.['header']?.[_0x58d243(0x290)]||_0x1668d4[_0x58d243(0x200)]?.[_0x58d243(0x15c)]?.[_0x58d243(0x281)]?.[_0x58d243(0x206)]?.[_0x58d243(0x1ed)]||_0x1668d4[_0x58d243(0x200)]?.['highlyStructuredMessage']?.[_0x58d243(0x281)]?.[_0x58d243(0x206)]?.[_0x58d243(0x290)]||_0x1668d4[_0x58d243(0x200)]?.['highlyStructuredMessage']?.[_0x58d243(0x281)]?.['hydratedTemplate']?.[_0x58d243(0x140)]||_0x1668d4['message']?.[_0x58d243(0x15c)]?.[_0x58d243(0x281)]?.[_0x58d243(0x206)]?.['locationMessage'];},handleMessage=async(_0x554584,_0x348861,_0x464a98,_0x873607=![])=>{const _0x3b9fa2=a558_0xd5cd7b;if(_0x873607){console[_0x3b9fa2(0x179)](_0x3b9fa2(0x266));let _0x14e742=_0x554584[_0x3b9fa2(0x1d2)]['id'],_0x2d2a5b=await Message_1[_0x3b9fa2(0x16c)][_0x3b9fa2(0x2d3)]({'where':{'id':_0x14e742}});if(_0x2d2a5b>0x0){await new Promise(_0x1f729a=>setTimeout(_0x1f729a,0x96));return;}else await new Promise(_0x5336b9=>setTimeout(_0x5336b9,0x14a));}let _0x5128b3;if(!(0x0,exports[_0x3b9fa2(0x2e0)])(_0x554584)){console['log'](_0x3b9fa2(0x2bf)),console[_0x3b9fa2(0x179)](_0x554584);return;}_0x554584[_0x3b9fa2(0x200)]?.[_0x3b9fa2(0x161)]&&(_0x554584[_0x3b9fa2(0x200)]=_0x554584[_0x3b9fa2(0x200)][_0x3b9fa2(0x161)][_0x3b9fa2(0x200)]);try{let _0x38e91f;const _0x4809cc=_0x554584[_0x3b9fa2(0x1d2)][_0x3b9fa2(0x273)]?.[_0x3b9fa2(0x25e)](_0x3b9fa2(0x27a)),_0x522880=await Setting_1['default']['findOne']({'where':{'companyId':_0x464a98,'key':_0x3b9fa2(0x203)}});if(_0x522880?.[_0x3b9fa2(0x178)]==='enabled'&&_0x4809cc){console[_0x3b9fa2(0x179)](_0x3b9fa2(0x2df));return;}let _0x41fd85=(0x0,exports[_0x3b9fa2(0x17d)])(_0x554584);const _0x345984=getTypeMessage(_0x554584);typeof _0x41fd85===_0x3b9fa2(0x2b9)&&(_0x41fd85=_0x41fd85['replace'](/\u200c/,''));const _0x469517=messageContainsMedia(_0x554584);if(_0x554584[_0x3b9fa2(0x1d2)][_0x3b9fa2(0x256)]){if(!_0x469517&&_0x345984!==_0x3b9fa2(0x2ed)&&_0x345984!==_0x3b9fa2(0x265)&&_0x345984!=='vcard'&&_0x345984!==_0x3b9fa2(0x1da)&&_0x345984!==_0x3b9fa2(0x161)&&_0x345984!==_0x3b9fa2(0x1c3)&&_0x345984!==_0x3b9fa2(0x274)&&_0x345984!==_0x3b9fa2(0x2f6)&&_0x345984!==_0x3b9fa2(0x17c)&&_0x345984!=='hydratedContentText'&&_0x345984!=='advertising'){console[_0x3b9fa2(0x156)](_0x345984);return;}}const _0x2875e0=await(0x0,ShowWhatsAppService_1[_0x3b9fa2(0x16c)])(_0x348861['id'],_0x464a98);let _0x4c573f,_0x3d2991=await getContactMessage(_0x554584,_0x348861);_0x38e91f=await verifyContact(_0x3d2991,_0x348861,_0x464a98);if(_0x4809cc){if(!_0x2875e0[_0x3b9fa2(0x19a)])return;try{const _0x2e438a=await _0x348861['groupMetadata'](_0x554584[_0x3b9fa2(0x1d2)][_0x3b9fa2(0x273)]),_0x2140f7={'id':_0x2e438a['id'],'name':_0x2e438a[_0x3b9fa2(0x25f)]};_0x4c573f=await verifyContact(_0x2140f7,_0x348861,_0x464a98);}catch(_0x3cb347){console[_0x3b9fa2(0x179)](_0x3b9fa2(0x2d8)),console[_0x3b9fa2(0x179)](_0x3cb347);return;}}let _0x464065=0x0;if(_0x554584[_0x3b9fa2(0x1d2)][_0x3b9fa2(0x256)])await cache_1['cacheLayer']['set'](_0x3b9fa2(0x17e)+_0x38e91f['id']+_0x3b9fa2(0x20d),'0');else{const _0x230176=await cache_1['cacheLayer'][_0x3b9fa2(0x176)](_0x3b9fa2(0x17e)+_0x38e91f['id']+_0x3b9fa2(0x20d));_0x464065=+_0x230176+0x1,await cache_1[_0x3b9fa2(0x2b7)]['set'](_0x3b9fa2(0x17e)+_0x38e91f['id']+_0x3b9fa2(0x20d),''+_0x464065);}const _0x3bc625=await(0x0,FindOrCreateTicketService_1['default'])(_0x38e91f,_0x348861['id'],_0x464065,_0x464a98,_0x4c573f,_0x873607),_0x7bc92b=await(0x0,FindOrCreateATicketTrakingService_1[_0x3b9fa2(0x16c)])({'ticketId':_0x3bc625['id'],'companyId':_0x464a98,'whatsappId':_0x2875e0?.['id']});_0x7bc92b['changed']('updatedAt',!![]),await _0x7bc92b[_0x3b9fa2(0x1e6)]({'updatedAt':new Date()}),await(0x0,providers_1[_0x3b9fa2(0x1cf)])(_0x3bc625,_0x554584,_0x464a98,_0x38e91f,_0x348861);if(_0x2875e0['complationMessage']&&_0x464065===0x0){const _0x5462c2=await Message_1[_0x3b9fa2(0x16c)][_0x3b9fa2(0x260)]({'where':{'contactId':_0x38e91f['id'],'companyId':_0x464a98},'order':[[_0x3b9fa2(0x277),'DESC']]});if((0x0,Mustache_1[_0x3b9fa2(0x16c)])(_0x2875e0['complationMessage'],_0x3bc625)[_0x3b9fa2(0x26d)]()[_0x3b9fa2(0x1d5)]()===_0x5462c2?.[_0x3b9fa2(0x1e0)]['trim']()[_0x3b9fa2(0x1d5)]())return;}if(_0x41fd85=='#'&&!_0x873607&&(!_0x3bc625[_0x3b9fa2(0x16f)]||_0x3bc625['status']==_0x3b9fa2(0x16d))){await _0x3bc625[_0x3b9fa2(0x1e6)]({'queueOptionId':null,'chatbot':![],'queueId':null,'amountUsedBotQueues':0x0}),await verifyQueue(_0x348861,_0x554584,_0x3bc625,_0x3bc625[_0x3b9fa2(0x241)]);return;}try{if(!_0x554584['key'][_0x3b9fa2(0x256)]&&!_0x873607){if(_0x41fd85!=null&&typeof _0x41fd85!=='string'){console[_0x3b9fa2(0x179)](_0x41fd85),console[_0x3b9fa2(0x156)](_0x3b9fa2(0x142),typeof _0x41fd85);return;}if(_0x41fd85?.[_0x3b9fa2(0x18d)]()===_0x3b9fa2(0x24a)&&_0x3bc625['status']!='closed'){await(0x0,SendPresenceStatus_1[_0x3b9fa2(0x2b3)])(_0x348861,_0x3bc625['contact'][_0x3b9fa2(0x20f)]+'@'+(_0x3bc625[_0x3b9fa2(0x16a)]?_0x3b9fa2(0x141):_0x3b9fa2(0x1a2)));const _0x1898d2=await _0x348861['sendMessage'](_0x3bc625[_0x3b9fa2(0x241)][_0x3b9fa2(0x20f)]+'@'+(_0x3bc625[_0x3b9fa2(0x16a)]?'g.us':_0x3b9fa2(0x1a2)),{'text':_0x3b9fa2(0x210)});await(0x0,exports['verifyMessage'])(_0x1898d2,_0x3bc625,_0x3bc625['contact']),await(0x0,UpdateTicketService_1['default'])({'ticketData':{'queueId':null,'status':_0x3b9fa2(0x221)},'ticketId':_0x3bc625['id'],'companyId':_0x3bc625['companyId']}),await _0x3bc625[_0x3b9fa2(0x2f4)]();return;}}}catch(_0x15c025){console[_0x3b9fa2(0x179)](_0x3b9fa2(0x1c4)),console[_0x3b9fa2(0x179)](_0x15c025),Sentry['captureException'](_0x15c025);}try{await _0x3bc625[_0x3b9fa2(0x1e6)]({'fromMe':_0x554584[_0x3b9fa2(0x1d2)][_0x3b9fa2(0x256)]});}catch(_0x4b98c9){console['log'](_0x3b9fa2(0x2b6)),console[_0x3b9fa2(0x179)](_0x4b98c9),Sentry[_0x3b9fa2(0x25d)](_0x4b98c9);}try{if(!_0x554584[_0x3b9fa2(0x1d2)][_0x3b9fa2(0x256)]){if((0x0,exports['verifyRating'])(_0x7bc92b)){await(0x0,exports[_0x3b9fa2(0x308)])(_0x554584,_0x3bc625,_0x7bc92b),console[_0x3b9fa2(0x179)](_0x3b9fa2(0x14d)+_0x554584);return;}}}catch(_0x3744bd){console[_0x3b9fa2(0x179)](_0x3b9fa2(0x1d6)),Sentry[_0x3b9fa2(0x25d)](_0x3744bd),console[_0x3b9fa2(0x179)](_0x3744bd);}_0x469517?_0x5128b3=await verifyMediaMessage(_0x554584,_0x3bc625,_0x38e91f):await(0x0,exports[_0x3b9fa2(0x286)])(_0x554584,_0x3bc625,_0x38e91f);const _0x4a7b02=await(0x0,VerifyCurrentSchedule_1[_0x3b9fa2(0x16c)])(_0x464a98),_0x355aa9=await Setting_1[_0x3b9fa2(0x16c)]['findOne']({'where':{'companyId':_0x464a98,'key':_0x3b9fa2(0x190)}});if(!_0x554584[_0x3b9fa2(0x1d2)]['fromMe']&&_0x355aa9&&!_0x873607)await handleOutOfHour(_0x348861,_0x3bc625,_0x355aa9,_0x38e91f,_0x4a7b02,_0x2875e0);!_0x3bc625[_0x3b9fa2(0x1f9)]&&!_0x4809cc&&!_0x554584['key']['fromMe']&&!_0x3bc625[_0x3b9fa2(0x16f)]&&!(0x0,lodash_1[_0x3b9fa2(0x20a)])(_0x2875e0[_0x3b9fa2(0x276)])&&!_0x873607&&await handleOpenAi(_0x554584,_0x348861,_0x3bc625,_0x38e91f,_0x5128b3);if(!_0x554584[_0x3b9fa2(0x1d2)][_0x3b9fa2(0x256)]&&!_0x3bc625[_0x3b9fa2(0x16a)]&&!_0x3bc625['queue']&&!_0x3bc625[_0x3b9fa2(0x1a6)]&&_0x3bc625[_0x3b9fa2(0x1df)]&&!(0x0,lodash_1[_0x3b9fa2(0x20a)])(_0x2875e0['integrationId'])&&!_0x3bc625['useIntegration']&&!_0x873607){const _0x4d1698=await(0x0,ShowQueueIntegrationService_1[_0x3b9fa2(0x16c)])(_0x2875e0[_0x3b9fa2(0x2e1)],_0x464a98);await(0x0,exports['handleMessageIntegration'])(_0x554584,_0x348861,_0x4d1698,_0x3bc625);return;}!_0x4809cc&&!_0x554584[_0x3b9fa2(0x1d2)][_0x3b9fa2(0x256)]&&!_0x3bc625[_0x3b9fa2(0x16f)]&&!(0x0,lodash_1[_0x3b9fa2(0x20a)])(_0x3bc625['promptId'])&&_0x3bc625[_0x3b9fa2(0x275)]&&!_0x873607&&await handleOpenAi(_0x554584,_0x348861,_0x3bc625,_0x38e91f,_0x5128b3);if(!_0x554584[_0x3b9fa2(0x1d2)][_0x3b9fa2(0x256)]&&!_0x3bc625['isGroup']&&!_0x3bc625[_0x3b9fa2(0x16f)]&&_0x3bc625['integrationId']&&_0x3bc625['useIntegration']&&!_0x873607){const _0x1bae0e=await(0x0,ShowQueueIntegrationService_1[_0x3b9fa2(0x16c)])(_0x3bc625['integrationId'],_0x464a98);await(0x0,exports[_0x3b9fa2(0x2a3)])(_0x554584,_0x348861,_0x1bae0e,_0x3bc625);}!_0x3bc625['queue']&&!_0x3bc625['isGroup']&&!_0x554584['key'][_0x3b9fa2(0x256)]&&!_0x3bc625['userId']&&_0x2875e0[_0x3b9fa2(0x2d2)]['length']>=0x1&&!_0x3bc625[_0x3b9fa2(0x275)]&&!_0x873607&&(await verifyQueue(_0x348861,_0x554584,_0x3bc625,_0x38e91f),_0x7bc92b[_0x3b9fa2(0x2a2)](_0x3b9fa2(0x288),!![]),_0x7bc92b['changed'](_0x3b9fa2(0x1f1),!![]),await _0x7bc92b['update']({'chatbotAt':(0x0,moment_1[_0x3b9fa2(0x16c)])()[_0x3b9fa2(0x1f7)](),'updatedAt':new Date()}));const _0x177ad8=_0x3bc625[_0x3b9fa2(0x1f9)]===null;await _0x3bc625['reload']();if(!_0x873607&&_0x2875e0[_0x3b9fa2(0x2c4)])await greetingMessage(_0x348861,_0x3bc625,_0x554584,_0x2875e0,_0x4809cc);_0x2875e0[_0x3b9fa2(0x2d2)][_0x3b9fa2(0x1ef)]==0x1&&_0x3bc625[_0x3b9fa2(0x1f9)]&&!_0x873607&&(_0x3bc625[_0x3b9fa2(0x1df)]&&!_0x554584[_0x3b9fa2(0x1d2)][_0x3b9fa2(0x256)]&&!_0x3bc625['userId']&&await handleChartbot(_0x3bc625,_0x554584,_0x348861,_0x2875e0)),_0x2875e0[_0x3b9fa2(0x2d2)][_0x3b9fa2(0x1ef)]>0x1&&_0x3bc625['queue']&&!_0x873607&&(_0x3bc625[_0x3b9fa2(0x1df)]&&!_0x554584[_0x3b9fa2(0x1d2)][_0x3b9fa2(0x256)]&&!_0x3bc625['userId']&&await handleChartbot(_0x3bc625,_0x554584,_0x348861,_0x2875e0,_0x177ad8));}catch(_0x516273){console[_0x3b9fa2(0x179)](_0x516273),Sentry[_0x3b9fa2(0x25d)](_0x516273),logger_1[_0x3b9fa2(0x1e9)]['error'](_0x3b9fa2(0x208)+_0x516273);}};exports[a558_0xd5cd7b(0x28c)]=handleMessage;const handleOutOfHour=async(_0x23bd97,_0x36f4ce,_0x2ea083,_0x393685,_0x35dbca,_0x189471)=>{const _0x1d01a1=a558_0xd5cd7b;try{if(outOfHourMessageControl['length']>0x1388)outOfHourMessageControl=[];let _0x130c8a=outOfHourMessageControl[_0x1d01a1(0x2ac)](_0x4aeace=>_0x4aeace[_0x1d01a1(0x283)]===_0x36f4ce['id']||_0x4aeace[_0x1d01a1(0x19e)]===_0x393685[_0x1d01a1(0x20f)]);if(_0x2ea083['value']===_0x1d01a1(0x1bc)&&!(0x0,lodash_1[_0x1d01a1(0x20a)])(_0x35dbca)&&_0x189471[_0x1d01a1(0x1fc)]&&(!_0x35dbca||_0x35dbca[_0x1d01a1(0x226)]===![])){if(!_0x130c8a||_0x130c8a&&_0x130c8a['time']+0x3e8*0x3c*0x5<new Date()[_0x1d01a1(0x22f)]()){_0x130c8a&&(outOfHourMessageControl=outOfHourMessageControl['filter'](_0x4d42c0=>_0x4d42c0[_0x1d01a1(0x283)]!==_0x36f4ce['id']),_0x130c8a=null);if(!_0x130c8a)outOfHourMessageControl[_0x1d01a1(0x2eb)]({'ticketId':_0x36f4ce['id'],'dest':_0x393685[_0x1d01a1(0x20f)],'time':new Date()[_0x1d01a1(0x22f)]()});const _0x2fd73b='‎\x20'+_0x189471[_0x1d01a1(0x1fc)],_0x301c27=(0x0,Debounce_1[_0x1d01a1(0x28f)])(async()=>{const _0x5874bf=_0x1d01a1;await _0x23bd97[_0x5874bf(0x214)](_0x36f4ce['contact'][_0x5874bf(0x20f)]+'@'+(_0x36f4ce['isGroup']?_0x5874bf(0x141):_0x5874bf(0x1a2)),{'text':_0x2fd73b});},(0x0,queues_1[_0x1d01a1(0x2f0)])(0x5dc,0xdac),_0x36f4ce['id']);_0x301c27();return;}}if(_0x2ea083[_0x1d01a1(0x178)]===_0x1d01a1(0x1f9)&&_0x36f4ce['queueId']!==null){const _0x21aaf6=await Queue_1['default']['findByPk'](_0x36f4ce[_0x1d01a1(0x171)]),{schedules:_0x279cf9}=_0x21aaf6,_0xb33a26=(0x0,moment_1[_0x1d01a1(0x16c)])(),_0x22d4ea=_0xb33a26[_0x1d01a1(0x29a)](_0x1d01a1(0x158))['toLowerCase']();let _0xdc4086=null;Array[_0x1d01a1(0x217)](_0x279cf9)&&_0x279cf9[_0x1d01a1(0x1ef)]>0x0&&(_0xdc4086=_0x279cf9[_0x1d01a1(0x2ac)](_0x2704db=>_0x2704db[_0x1d01a1(0x1ad)]===_0x22d4ea&&_0x2704db[_0x1d01a1(0x292)]!==''&&_0x2704db[_0x1d01a1(0x292)]!==null&&_0x2704db[_0x1d01a1(0x218)]!==''&&_0x2704db['endTime']!==null));if(_0x2ea083['value']===_0x1d01a1(0x1f9)&&_0x21aaf6[_0x1d01a1(0x1fc)]!==null&&_0x21aaf6[_0x1d01a1(0x1fc)]!==''&&!(0x0,lodash_1[_0x1d01a1(0x20a)])(_0xdc4086)){const _0xff3cc3=(0x0,moment_1[_0x1d01a1(0x16c)])(_0xdc4086[_0x1d01a1(0x292)],'HH:mm'),_0x2d0ce3=(0x0,moment_1[_0x1d01a1(0x16c)])(_0xdc4086[_0x1d01a1(0x218)],_0x1d01a1(0x196));let _0x170a89=_0xb33a26[_0x1d01a1(0x2b5)](_0xff3cc3)||_0xb33a26[_0x1d01a1(0x212)](_0x2d0ce3);if(!_0x170a89){if(_0xdc4086[_0x1d01a1(0x17a)]&&_0xdc4086[_0x1d01a1(0x237)]){const _0x220717=(0x0,moment_1[_0x1d01a1(0x16c)])(_0xdc4086[_0x1d01a1(0x17a)],_0x1d01a1(0x196)),_0x4c2ba6=(0x0,moment_1['default'])(_0xdc4086[_0x1d01a1(0x237)],_0x1d01a1(0x196));_0x170a89=_0xb33a26['isBetween'](_0x220717,_0x4c2ba6);}}if(_0x170a89){if(!_0x130c8a||_0x130c8a&&_0x130c8a['time']+0x3e8*0x3c*0x1e<new Date()[_0x1d01a1(0x22f)]()){const _0x14b952=_0x21aaf6[_0x1d01a1(0x1fc)],_0x43fae6=(0x0,Debounce_1['debounce'])(async()=>{const _0x3b0f1f=_0x1d01a1;await _0x23bd97['sendMessage'](_0x36f4ce[_0x3b0f1f(0x241)]['number']+'@'+(_0x36f4ce[_0x3b0f1f(0x16a)]?_0x3b0f1f(0x141):_0x3b0f1f(0x1a2)),{'text':_0x14b952});},(0x0,queues_1[_0x1d01a1(0x2f0)])(0x3e8,0xbb8),_0x36f4ce['id']);_0x43fae6();return;}if(!_0x130c8a)outOfHourMessageControl[_0x1d01a1(0x2eb)]({'ticketId':_0x36f4ce['id'],'dest':_0x393685[_0x1d01a1(0x20f)],'time':new Date()[_0x1d01a1(0x22f)]()});}}}}catch(_0x475165){Sentry[_0x1d01a1(0x25d)](_0x475165),console['log'](_0x475165);}},greetingMessage=async(_0x22c4d1,_0x2c01d5,_0x463a76,_0x23b2de,_0x4ca864)=>{const _0x4a1c6f=a558_0xd5cd7b;if(!_0x23b2de?.[_0x4a1c6f(0x2d2)]?.[_0x4a1c6f(0x1ef)]&&!_0x2c01d5[_0x4a1c6f(0x16f)]&&!_0x4ca864&&!_0x463a76[_0x4a1c6f(0x1d2)][_0x4a1c6f(0x256)]){if(process['env'][_0x4a1c6f(0x22c)]?.[_0x4a1c6f(0x1ef)]>=0x8){if(_0x2c01d5[_0x4a1c6f(0x241)]['number']!=process[_0x4a1c6f(0x1c1)][_0x4a1c6f(0x22c)])return;}if(greetingMessageControl[_0x4a1c6f(0x1ef)]>0x1388)greetingMessageControl=[];var _0x53d75f=greetingMessageControl['find'](_0x20ede0=>_0x20ede0[_0x4a1c6f(0x283)]===_0x2c01d5['id']||_0x20ede0[_0x4a1c6f(0x19e)]===_0x2c01d5[_0x4a1c6f(0x241)][_0x4a1c6f(0x20f)]);if(_0x53d75f&&_0x53d75f['time']+0x3e8*0x3c*0x5>=new Date()['getTime']())return;const _0x136f2b=await Message_1['default'][_0x4a1c6f(0x260)]({'where':{'ticketId':_0x2c01d5['id'],'fromMe':!![],'createdAt':{[sequelize_1['Op'][_0x4a1c6f(0x2ad)]]:(0x0,moment_1[_0x4a1c6f(0x16c)])()['subtract'](0x5,_0x4a1c6f(0x1a3))[_0x4a1c6f(0x1f7)]()}}});if(_0x136f2b)return;const _0xc9b51c=(0x0,Debounce_1[_0x4a1c6f(0x28f)])(async()=>{const _0x768f55=_0x4a1c6f;if(!_0x23b2de['greetingMediaAttachment'])await _0x22c4d1[_0x768f55(0x214)](_0x2c01d5[_0x768f55(0x241)][_0x768f55(0x20f)]+'@'+(_0x2c01d5[_0x768f55(0x16a)]?'g.us':_0x768f55(0x1a2)),{'text':(0x0,Mustache_1[_0x768f55(0x16c)])(_0x23b2de[_0x768f55(0x2c4)],_0x2c01d5)});else{const _0x5c25fc=path_1[_0x768f55(0x16c)]['resolve'](_0x768f55(0x300),_0x768f55(0x1bc)+_0x2c01d5[_0x768f55(0x1c5)],_0x23b2de[_0x768f55(0x29c)]),_0x5df7d4=await(0x0,SendWhatsAppMedia_1['getMessageOptions'])(_0x23b2de[_0x768f55(0x29c)],_0x5c25fc,_0x23b2de[_0x768f55(0x2c4)],_0x2c01d5[_0x768f55(0x1c5)]);await _0x22c4d1[_0x768f55(0x214)](_0x2c01d5[_0x768f55(0x241)][_0x768f55(0x20f)]+'@'+(_0x2c01d5[_0x768f55(0x16a)]?_0x768f55(0x141):_0x768f55(0x1a2)),{..._0x5df7d4});}},0x3e8,_0x2c01d5['id']);_0xc9b51c();return;}},handleMsgAck=async(_0x34f4bc,_0x6cb43c)=>{const _0x2dba8c=a558_0xd5cd7b,_0x127a40=(0x0,socket_1[_0x2dba8c(0x29b)])();try{const _0x274613=await Message_1['default'][_0x2dba8c(0x21a)](_0x34f4bc[_0x2dba8c(0x1d2)]['id'],{'include':[_0x2dba8c(0x241),{'model':Message_1['default'],'as':_0x2dba8c(0x298),'include':[_0x2dba8c(0x241)]}]});if(!_0x274613){console[_0x2dba8c(0x179)](_0x34f4bc),console[_0x2dba8c(0x179)]('Mensagem\x20não\x20encontrada!');return;}await _0x274613[_0x2dba8c(0x1e6)]({'ack':_0x6cb43c}),_0x127a40['to'](_0x274613[_0x2dba8c(0x283)][_0x2dba8c(0x2ce)]())[_0x2dba8c(0x2fa)](_0x2dba8c(0x307)+_0x274613['companyId']+_0x2dba8c(0x2ec),{'action':_0x2dba8c(0x1e6),'message':_0x274613});}catch(_0x3d2fc1){Sentry['captureException'](_0x3d2fc1),logger_1[_0x2dba8c(0x1e9)][_0x2dba8c(0x160)](_0x2dba8c(0x249)+_0x3d2fc1);}};exports[a558_0xd5cd7b(0x185)]=handleMsgAck;const verifyRecentCampaign=async(_0x47742f,_0x39e4de)=>{const _0x1fa1a3=a558_0xd5cd7b;if(!_0x47742f[_0x1fa1a3(0x1d2)][_0x1fa1a3(0x256)]){const _0x249e02=_0x47742f[_0x1fa1a3(0x1d2)][_0x1fa1a3(0x273)][_0x1fa1a3(0x143)](/\D/g,''),_0x2c8552=await Campaign_1['default']['findAll']({'where':{'companyId':_0x39e4de,'status':'EM_ANDAMENTO','confirmation':!![]}});if(_0x2c8552){const _0x280f3b=_0x2c8552[_0x1fa1a3(0x2af)](_0x1329e6=>_0x1329e6['id']),_0x250cc5=await CampaignShipping_1[_0x1fa1a3(0x16c)][_0x1fa1a3(0x260)]({'where':{'campaignId':{[sequelize_1['Op']['in']]:_0x280f3b},'number':_0x249e02,'confirmation':null}});_0x250cc5&&(await _0x250cc5[_0x1fa1a3(0x1e6)]({'confirmedAt':(0x0,moment_1[_0x1fa1a3(0x16c)])(),'confirmation':!![]}),await queues_1[_0x1fa1a3(0x2d7)][_0x1fa1a3(0x21d)](_0x1fa1a3(0x27f),{'campaignShippingId':_0x250cc5['id'],'campaignId':_0x250cc5[_0x1fa1a3(0x1cd)]},{'delay':(0x0,queues_1[_0x1fa1a3(0x1f2)])((0x0,queues_1[_0x1fa1a3(0x2f0)])(0x0,0xa))}));}}};exports[a558_0xd5cd7b(0x2cb)]=verifyRecentCampaign;const verifyCampaignMessageAndCloseTicket=async(_0x495e6c,_0x6280c0)=>{const _0x1c3907=a558_0xd5cd7b,_0x813455=(0x0,socket_1['getIO'])(),_0x5aa4c8=(0x0,exports[_0x1c3907(0x17d)])(_0x495e6c),_0x1213bd=/\u200c/[_0x1c3907(0x1b5)](_0x5aa4c8);if(_0x495e6c[_0x1c3907(0x1d2)][_0x1c3907(0x256)]&&_0x1213bd){const _0x5b5d5d=await Message_1[_0x1c3907(0x16c)][_0x1c3907(0x260)]({'where':{'id':_0x495e6c[_0x1c3907(0x1d2)]['id'],'companyId':_0x6280c0}}),_0x464621=await Ticket_1['default']['findByPk'](_0x5b5d5d[_0x1c3907(0x283)]);await _0x464621['update']({'status':_0x1c3907(0x221)}),_0x813455['to'](_0x1c3907(0x307)+_0x464621['companyId']+_0x1c3907(0x22a))[_0x1c3907(0x2fa)](_0x1c3907(0x307)+_0x464621[_0x1c3907(0x1c5)]+_0x1c3907(0x157),{'action':'delete','ticket':_0x464621,'ticketId':_0x464621['id']}),_0x813455['to'](_0x1c3907(0x307)+_0x6280c0+'-'+_0x464621['status'])['to'](_0x464621['id'][_0x1c3907(0x2ce)]())[_0x1c3907(0x2fa)](_0x1c3907(0x307)+_0x464621[_0x1c3907(0x1c5)]+'-ticket',{'action':_0x1c3907(0x1e6),'ticket':_0x464621,'ticketId':_0x464621['id']});}};exports[a558_0xd5cd7b(0x257)]=verifyCampaignMessageAndCloseTicket;const filterMessages=_0x456991=>{const _0x5681af=a558_0xd5cd7b;if([baileys_1[_0x5681af(0x183)][_0x5681af(0x1ae)],baileys_1[_0x5681af(0x183)][_0x5681af(0x146)],baileys_1[_0x5681af(0x183)]['E2E_IDENTITY_CHANGED'],baileys_1[_0x5681af(0x183)][_0x5681af(0x186)]][_0x5681af(0x303)](_0x456991['messageStubType']))return![];return!![];},wbotMessageListener=async(_0x1f5086,_0x3bdf9e,_0x4b7bb1)=>{_0x1f5086['ev']['on']('messages.upsert',async _0x4a1f26=>{const _0x5f2d06=a558_0x94d3,_0x179f8c=_0x4a1f26[_0x5f2d06(0x1e7)]['filter'](filterMessages);if(!_0x179f8c)return;await app_1[_0x5f2d06(0x16c)][_0x5f2d06(0x176)](_0x5f2d06(0x2d2))['messageQueue'][_0x5f2d06(0x21d)](_0x5f2d06(0x211),{'whatsappId':_0x4b7bb1['id'],'messages':_0x179f8c,'companyId':_0x3bdf9e},{'removeOnComplete':!![],'attempts':0x3});}),_0x1f5086['ev']['on']('messages.update',async _0x4e1f39=>{const _0x46e914=a558_0x94d3;if(_0x4e1f39[_0x46e914(0x1ef)]===0x0)return;await app_1[_0x46e914(0x16c)][_0x46e914(0x176)]('queues')['messageQueue'][_0x46e914(0x21d)]('MessageUpdateJob',{'whatsappId':_0x4b7bb1['id'],'messageUpdate':_0x4e1f39,'companyId':_0x3bdf9e},{'removeOnComplete':!![],'attempts':0x3,'delay':0x64});}),_0x1f5086['ev']['on']('groups.update',async _0x1664cc=>{const _0x47828e=a558_0x94d3;console[_0x47828e(0x179)](_0x1664cc);if(_0x1664cc[_0x47828e(0x1ef)]===0x0)return;for(const _0x3c0dae of _0x1664cc){const _0x1826fd=_0x3c0dae['id'][_0x47828e(0x197)]('@')[0x0],_0xe2592e=_0x3c0dae[_0x47828e(0x25f)]||_0x1826fd,_0x594380={'name':_0xe2592e,'number':_0x1826fd,'isGroup':!![],'companyId':_0x3bdf9e,'remoteJid':_0x3c0dae['id'],'whatsappId':_0x1f5086['id']};await(0x0,CreateOrUpdateContactService_1['default'])(_0x594380,_0x1f5086,_0x3c0dae['id']);}});};exports['wbotMessageListener']=wbotMessageListener;