'use strict';const a587_0x5436c2=a587_0x454b;(function(_0x479ab9,_0x2995e8){const _0x42b26e=a587_0x454b,_0x24a82b=_0x479ab9();while(!![]){try{const _0x371ace=parseInt(_0x42b26e(0x29e))/0x1*(-parseInt(_0x42b26e(0x2bd))/0x2)+parseInt(_0x42b26e(0x1e8))/0x3*(-parseInt(_0x42b26e(0x213))/0x4)+parseInt(_0x42b26e(0x242))/0x5+parseInt(_0x42b26e(0x23a))/0x6+parseInt(_0x42b26e(0x290))/0x7+parseInt(_0x42b26e(0x273))/0x8+parseInt(_0x42b26e(0x2bb))/0x9*(-parseInt(_0x42b26e(0x1fd))/0xa);if(_0x371ace===_0x2995e8)break;else _0x24a82b['push'](_0x24a82b['shift']());}catch(_0x49edc8){_0x24a82b['push'](_0x24a82b['shift']());}}}(a587_0x9307,0x95177));function a587_0x454b(_0x3f3134,_0x21431d){const _0x365bc1=a587_0x9307();return a587_0x454b=function(_0x1c5e8c,_0x400c33){_0x1c5e8c=_0x1c5e8c-0x1dc;let _0x930767=_0x365bc1[_0x1c5e8c];return _0x930767;},a587_0x454b(_0x3f3134,_0x21431d);}var __createBinding=this&&this[a587_0x5436c2(0x2d4)]||(Object[a587_0x5436c2(0x2c8)]?function(_0x2bfbb9,_0x38daec,_0x341494,_0xf306c9){const _0x3dd88a=a587_0x5436c2;if(_0xf306c9===undefined)_0xf306c9=_0x341494;var _0x2705b0=Object['getOwnPropertyDescriptor'](_0x38daec,_0x341494);(!_0x2705b0||(_0x3dd88a(0x23d)in _0x2705b0?!_0x38daec['__esModule']:_0x2705b0['writable']||_0x2705b0[_0x3dd88a(0x253)]))&&(_0x2705b0={'enumerable':!![],'get':function(){return _0x38daec[_0x341494];}}),Object['defineProperty'](_0x2bfbb9,_0xf306c9,_0x2705b0);}:function(_0x297a97,_0x42f59d,_0x5cf64f,_0x20bbdc){if(_0x20bbdc===undefined)_0x20bbdc=_0x5cf64f;_0x297a97[_0x20bbdc]=_0x42f59d[_0x5cf64f];}),__setModuleDefault=this&&this[a587_0x5436c2(0x247)]||(Object['create']?function(_0x26de67,_0x1cee0a){const _0x37d1a0=a587_0x5436c2;Object[_0x37d1a0(0x20f)](_0x26de67,_0x37d1a0(0x24d),{'enumerable':!![],'value':_0x1cee0a});}:function(_0x125c9e,_0xd61351){const _0x1323bd=a587_0x5436c2;_0x125c9e[_0x1323bd(0x24d)]=_0xd61351;}),__importStar=this&&this['__importStar']||(function(){const _0x184462=(function(){let _0x1a408c=!![];return function(_0x8d33be,_0x1a75d5){const _0x1b2274=_0x1a408c?function(){if(_0x1a75d5){const _0x5c79f6=_0x1a75d5['apply'](_0x8d33be,arguments);return _0x1a75d5=null,_0x5c79f6;}}:function(){};return _0x1a408c=![],_0x1b2274;};}()),_0x1334ef=_0x184462(this,function(){const _0x5f067b=a587_0x454b;return _0x1334ef[_0x5f067b(0x202)]()[_0x5f067b(0x29b)]('(((.+)+)+)+$')[_0x5f067b(0x202)]()['constructor'](_0x1334ef)[_0x5f067b(0x29b)](_0x5f067b(0x29a));});_0x1334ef();var _0x29f99b=function(_0x39e932){const _0x56a2a4=a587_0x454b;return _0x29f99b=Object[_0x56a2a4(0x214)]||function(_0x3c282c){const _0xf137f6=_0x56a2a4;var _0x16dd76=[];for(var _0x514309 in _0x3c282c)if(Object[_0xf137f6(0x218)][_0xf137f6(0x272)]['call'](_0x3c282c,_0x514309))_0x16dd76[_0x16dd76[_0xf137f6(0x28a)]]=_0x514309;return _0x16dd76;},_0x29f99b(_0x39e932);};return function(_0x3b14cb){const _0x17cc3f=a587_0x454b;if(_0x3b14cb&&_0x3b14cb[_0x17cc3f(0x279)])return _0x3b14cb;var _0x2a4e41={};if(_0x3b14cb!=null){for(var _0x275a9c=_0x29f99b(_0x3b14cb),_0x28fd37=0x0;_0x28fd37<_0x275a9c['length'];_0x28fd37++)if(_0x275a9c[_0x28fd37]!=='default')__createBinding(_0x2a4e41,_0x3b14cb,_0x275a9c[_0x28fd37]);}return __setModuleDefault(_0x2a4e41,_0x3b14cb),_0x2a4e41;};}()),__importDefault=this&&this[a587_0x5436c2(0x223)]||function(_0x47e6da){const _0x53f2fb=a587_0x5436c2;return _0x47e6da&&_0x47e6da[_0x53f2fb(0x279)]?_0x47e6da:{'default':_0x47e6da};};Object[a587_0x5436c2(0x20f)](exports,a587_0x5436c2(0x279),{'value':!![]}),exports['handleMessage']=exports[a587_0x5436c2(0x2d2)]=exports['handleMessageIntegration']=exports[a587_0x5436c2(0x257)]=exports[a587_0x5436c2(0x25d)]=void 0x0,exports[a587_0x5436c2(0x1ef)]=makeid;const path_1=__importDefault(require(a587_0x5436c2(0x1ec))),Sentry=__importStar(require(a587_0x5436c2(0x22a))),lodash_1=require(a587_0x5436c2(0x21f)),baileys_1=require(a587_0x5436c2(0x237)),async_mutex_1=require(a587_0x5436c2(0x215)),sequelize_1=require(a587_0x5436c2(0x23b)),moment_1=__importDefault(require(a587_0x5436c2(0x2b4))),Contact_1=__importDefault(require(a587_0x5436c2(0x220))),Ticket_1=__importDefault(require(a587_0x5436c2(0x297))),Message_1=__importDefault(require(a587_0x5436c2(0x2d1))),socket_1=require('../../libs/socket'),logger_1=require(a587_0x5436c2(0x201)),FindOrCreateTicketService_1=__importDefault(require(a587_0x5436c2(0x1e4))),ShowWhatsAppService_1=__importDefault(require(a587_0x5436c2(0x285))),UpdateTicketService_1=__importDefault(require(a587_0x5436c2(0x21b))),Mustache_1=__importDefault(require(a587_0x5436c2(0x241))),TicketTraking_1=__importDefault(require(a587_0x5436c2(0x2b1))),UserRating_1=__importDefault(require(a587_0x5436c2(0x2b5))),SendWhatsAppMessage_1=__importDefault(require(a587_0x5436c2(0x28d))),Queue_1=__importDefault(require(a587_0x5436c2(0x233))),QueueOption_1=__importDefault(require(a587_0x5436c2(0x1f2))),VerifyCurrentSchedule_1=__importDefault(require(a587_0x5436c2(0x20a))),User_1=__importDefault(require(a587_0x5436c2(0x206))),Setting_1=__importDefault(require(a587_0x5436c2(0x22e))),cache_1=require(a587_0x5436c2(0x1e7)),Debounce_1=require(a587_0x5436c2(0x2b9)),SendWhatsAppMedia_1=__importDefault(require(a587_0x5436c2(0x277))),CheckSettings_1=require('../../helpers/CheckSettings'),Whatsapp_1=__importDefault(require('../../models/Whatsapp')),simpleObjectCache_1=require(a587_0x5436c2(0x29d)),ShowQueueIntegrationService_1=__importDefault(require(a587_0x5436c2(0x25c))),typebotListener_1=__importDefault(require(a587_0x5436c2(0x296))),VerifyHandlers_1=require('./VerifyHandlers'),GetHandlers_1=require(a587_0x5436c2(0x24b)),wbotMutex=new async_mutex_1[(a587_0x5436c2(0x229))](),ackMutex=new async_mutex_1[(a587_0x5436c2(0x229))](),groupContactCache=new simpleObjectCache_1[(a587_0x5436c2(0x228))](0x3e8*0x1e,logger_1['logger']),outOfHoursCache=new simpleObjectCache_1['SimpleObjectCache'](0x3e8*0x3c*0x5,logger_1[a587_0x5436c2(0x20c)]);function makeid(_0x2725ac){const _0x49e5de=a587_0x5436c2;let _0x2fea4c='';const _0xa92b4f=_0x49e5de(0x1f5),_0x3bc1fd=_0xa92b4f[_0x49e5de(0x28a)];for(let _0x3495fb=0x0;_0x3495fb<_0x2725ac;_0x3495fb+=0x1){_0x2fea4c+=_0xa92b4f[_0x49e5de(0x1f9)](Math[_0x49e5de(0x1f8)](Math[_0x49e5de(0x261)]()*_0x3bc1fd));}return _0x2fea4c;}function a587_0x9307(){const _0x297ff7=['getTypeMessage','setExtra','../../helpers/Mustache','4146150LbfOBp','Error\x20isValidMsg','option','\x20inválida\x20para\x20o\x20submenu\x20atual.','message','__setModuleDefault','getIO','*\x20-\x20','findAll','./GetHandlers','REVOKE','default','useRating','readMessages','Opção\x20','Por\x20favor\x20avalie\x20nosso\x20atendimento','Nó\x20final\x20encontrado.\x20Exibindo\x20mensagem\x20final.','configurable','quotedMsg','Processando\x20mensagem:\x20\x22','set','displayCurrentMenu','Menu\x20principal\x20exibido.','find','maxUseBotQueues','\x0a*#*\x20-\x20Voltar\x20Menu\x20Inicial','../QueueIntegrationServices/ShowQueueIntegrationService','handleRating','typebotStatus:\x20','keepUserAndQueue','pending','random','queueId','remoteJid','transferMessage','viewOnceMessage','queue-','public','handleMessageIntegration','messageStubType','.\x20Ignorando\x20em\x20handleChartbot.','subject','viewOnceMessageV2','verifyQueue','lastProcessedMessageId','typebot','getContactMessage','messages.update','hasOwnProperty','3931416rdVEXq','GetCompanySetting','amountUsedBotQueues','profilePicUrl','./SendWhatsAppMedia','endsWith','__esModule','ephemeralMessage','messages','trim','type','log','isFinite','Atendimento\x20finalizado','mediaMessage','user','forwardQueueId','keys','../WhatsappService/ShowWhatsAppService','captureException','count','thumbnailDirectPath','number','length','findOne','fromMe','./SendWhatsAppMessage','stickerMessage','queue','4131148XFkCZn','videoMessage','findByPk','integrationId','Novo\x20Tipo\x20de\x20Mensagem\x20em\x20isValidMsg','split','../TypebotServices/typebotListener','../../models/Ticket','typebotStatus','listMessage','(((.+)+)+)+$','search','includes','../../helpers/simpleObjectCache','588139toBPRO','\x20já\x20processada\x20para\x20o\x20ticket\x20','Tipo\x20de\x20integração\x20não\x20suportada.','ticket','parentId','\x22\x20para\x20ticket\x20','status@broadcast','Erro\x20ao\x20processar\x20avaliação:','documentWithCaptionMessage','chatbot','complationMessage','####\x20Nao\x20achou\x20o\x20type\x20em\x20isValidMsg:\x20','handleMessage','ticketId','outOfHoursAction','Mensagem\x20','\x20selecionada\x20no\x20menu\x20principal.\x20ID:\x20','conversation','isGroup','../../models/TicketTraking','remoteJidAlt','open','moment','../../models/UserRating','Error\x20handling\x20whatsapp\x20message:\x20Err:\x20','protocolMessage','inActivity','../../helpers/Debounce','value','1575cZJclA','company','2aDtmQc',',\x20queueOptionId:\x20','contactMessage','isNaN','CHATBOT_RESTRICT_NUMBER','status','useIntegration','forwardQueue','isInteger','chatbot\x20desativado!','verifyMessage','create','getUnpackedMessage','imageMessage','-appMessage','outOfHoursMessage','contact','messageContextInfo','startsWith','disabled','../../models/Message','wbotMessageListener','CIPHERTEXT','__createBinding','buttonsResponseMessage','\x20não\x20encontrada.','buttonsMessage','isNil','DESC','listResponseMessage','disableBot','templateMessage','../TicketServices/FindOrCreateTicketService','verifyDeleteMessage','senderPn','../../libs/cache','3iXJjKb','cacheLayer','\x20inválida\x20para\x20o\x20menu\x20principal.','company-','path','@lid','getMessageMedia','makeid','Resposta\x20inválida:\x20','verifyContact','../../models/QueueOption','delete','FRONTEND_URL','ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789','filter','-ticket','floor','charAt','forEach','extendedTextMessage','emit','66860vVdfag','queueOptionId','createdAt','Atualizando\x20estado\x20de\x20integração\x20do\x20ticket\x20#','../../utils/logger','toString','options','title','reload','../../models/User','editedMessage','groupMetadata','mediaPath','../CompanyService/VerifyCurrentSchedule','WAMessageStubType','logger','env','companyId','defineProperty','debounce','*#*\x20-\x20Voltar\x20Menu\x20Inicial','Submenu\x20encontrado\x20com\x20','1744616RzXhry','getOwnPropertyNames','async-mutex','/nopicture.png','whatsappId','prototype','\x0a*0*\x20-\x20Voltar\x20ao\x20menu\x20anterior\x0a','enabled','../TicketServices/UpdateTicketService','error','ack','runExclusive','lodash','../../models/Contact','verifyMediaMessage','contacts:','__importDefault','closed','stringify','ASC','greetingMessage','SimpleObjectCache','Mutex','@sentry/node','Configurações\x20do\x20WhatsApp\x20não\x20encontradas.','userId','-open','../../models/Setting','contactsArrayMessage','update','key',':unreads','../../models/Queue','verifyEditedMessage','reactionMessage','text','@whiskeysockets/baileys','toDate','queues','5365206jepaND','sequelize','isNull','get','verifyRating'];a587_0x9307=function(){return _0x297ff7;};return a587_0x9307();}const isValidMsg=_0x56feb2=>{const _0x5dbfa7=a587_0x5436c2;if(_0x56feb2['key'][_0x5dbfa7(0x263)]===_0x5dbfa7(0x2a4))return![];try{const _0x14de70=(0x0,GetHandlers_1[_0x5dbfa7(0x23f)])(_0x56feb2);if(!_0x14de70)return![];const _0x4e6c7b=_0x14de70===_0x5dbfa7(0x2af)||_0x14de70===_0x5dbfa7(0x207)||_0x14de70==='extendedTextMessage'||_0x14de70==='audioMessage'||_0x14de70===_0x5dbfa7(0x291)||_0x14de70===_0x5dbfa7(0x2ca)||_0x14de70==='documentMessage'||_0x14de70===_0x5dbfa7(0x2a6)||_0x14de70===_0x5dbfa7(0x28e)||_0x14de70===_0x5dbfa7(0x1dc)||_0x14de70===_0x5dbfa7(0x1de)||_0x14de70===_0x5dbfa7(0x2ce)||_0x14de70==='locationMessage'||_0x14de70==='liveLocationMessage'||_0x14de70===_0x5dbfa7(0x2bf)||_0x14de70==='voiceMessage'||_0x14de70===_0x5dbfa7(0x281)||_0x14de70===_0x5dbfa7(0x22f)||_0x14de70===_0x5dbfa7(0x235)||_0x14de70===_0x5dbfa7(0x27a)||_0x14de70===_0x5dbfa7(0x2b7)||_0x14de70===_0x5dbfa7(0x1e1)||_0x14de70===_0x5dbfa7(0x299)||_0x14de70===_0x5dbfa7(0x1e3)||_0x14de70===_0x5dbfa7(0x265)||_0x14de70===_0x5dbfa7(0x26c);return!_0x4e6c7b&&(logger_1[_0x5dbfa7(0x20c)]['warn'](_0x5dbfa7(0x2a9)+_0x14de70+'\x0a'+JSON[_0x5dbfa7(0x225)](_0x56feb2?.[_0x5dbfa7(0x246)])),Sentry[_0x5dbfa7(0x240)]('Mensagem',{'BodyMsg':_0x56feb2[_0x5dbfa7(0x246)],'msg':_0x56feb2,'msgType':_0x14de70}),Sentry[_0x5dbfa7(0x286)](new Error(_0x5dbfa7(0x294)))),!!_0x4e6c7b;}catch(_0x38a406){return Sentry[_0x5dbfa7(0x240)](_0x5dbfa7(0x243),{'msg':_0x56feb2}),Sentry[_0x5dbfa7(0x286)](_0x38a406),![];}},handleRating=async(_0x230c31,_0x2710f8,_0x3be8f8)=>{const _0x27f1aa=a587_0x5436c2,_0x1fa7dd=(0x0,socket_1[_0x27f1aa(0x248)])();let _0x42c407=null;(_0x230c31?.['message']?.['conversation']||_0x230c31?.[_0x27f1aa(0x246)]?.[_0x27f1aa(0x1fb)])&&(_0x42c407=parseInt(_0x230c31[_0x27f1aa(0x246)]['conversation']||_0x230c31[_0x27f1aa(0x246)][_0x27f1aa(0x1fb)][_0x27f1aa(0x236)],0xa)||null);if(!Number[_0x27f1aa(0x2c0)](_0x42c407)&&Number[_0x27f1aa(0x2c5)](_0x42c407)&&!(0x0,lodash_1[_0x27f1aa(0x23c)])(_0x42c407)){const _0x5ee163=await(0x0,ShowWhatsAppService_1[_0x27f1aa(0x24d)])(_0x2710f8['whatsappId'],_0x2710f8['companyId']);let _0x11490f=_0x42c407;_0x42c407<0x1&&(_0x11490f=0x1);_0x42c407>0x5&&(_0x11490f=0x5);await UserRating_1[_0x27f1aa(0x24d)][_0x27f1aa(0x2c8)]({'ticketId':_0x3be8f8[_0x27f1aa(0x2ab)],'companyId':_0x3be8f8[_0x27f1aa(0x20e)],'userId':_0x3be8f8[_0x27f1aa(0x22c)],'rate':_0x11490f});const _0x3aa0c9=_0x5ee163[_0x27f1aa(0x2a8)][_0x27f1aa(0x27c)]()||_0x27f1aa(0x280);await(0x0,SendWhatsAppMessage_1[_0x27f1aa(0x24d)])({'ticket':_0x2710f8,'body':_0x3aa0c9}),await _0x3be8f8[_0x27f1aa(0x230)]({'finishedAt':(0x0,moment_1[_0x27f1aa(0x24d)])()[_0x27f1aa(0x238)](),'rated':!![]});const _0x3757d9=await(0x0,CheckSettings_1[_0x27f1aa(0x274)])(_0x2710f8[_0x27f1aa(0x20e)],_0x27f1aa(0x25f),'enabled')==='enabled';await _0x2710f8[_0x27f1aa(0x230)]({'queueId':_0x3757d9?_0x2710f8[_0x27f1aa(0x262)]:null,'chatbot':null,'queueOptionId':null,'userId':_0x3757d9?_0x2710f8[_0x27f1aa(0x22c)]:null,'status':_0x27f1aa(0x224)}),_0x1fa7dd['to'](_0x27f1aa(0x1eb)+_0x2710f8[_0x27f1aa(0x20e)]+_0x27f1aa(0x22d))['to'](_0x27f1aa(0x266)+_0x2710f8['queueId']+_0x27f1aa(0x22d))['emit']('company-'+_0x2710f8[_0x27f1aa(0x20e)]+'-ticket',{'action':_0x27f1aa(0x1f3),'ticket':_0x2710f8,'ticketId':_0x2710f8['id']}),_0x1fa7dd['to'](_0x27f1aa(0x1eb)+_0x2710f8['companyId']+'-'+_0x2710f8[_0x27f1aa(0x2c2)])['to'](_0x27f1aa(0x266)+_0x2710f8[_0x27f1aa(0x262)]+'-'+_0x2710f8[_0x27f1aa(0x2c2)])['to'](_0x2710f8['id']['toString']())[_0x27f1aa(0x1fc)](_0x27f1aa(0x1eb)+_0x2710f8[_0x27f1aa(0x20e)]+_0x27f1aa(0x1f7),{'action':_0x27f1aa(0x230),'ticket':_0x2710f8,'ticketId':_0x2710f8['id']});}};exports[a587_0x5436c2(0x25d)]=handleRating;const handleChartbot=async(_0x5a0ae6,_0x1fb448,_0x4e360a,_0x533c3a=![])=>{const _0x4c3777=a587_0x5436c2,_0x529ae1=_0x1fb448[_0x4c3777(0x231)]['id'];if(_0x529ae1&&_0x5a0ae6[_0x4c3777(0x26e)]===_0x529ae1){console[_0x4c3777(0x27e)](_0x4c3777(0x2ad)+_0x529ae1+_0x4c3777(0x29f)+_0x5a0ae6['id']+_0x4c3777(0x26a));return;}await _0x5a0ae6[_0x4c3777(0x230)]({'lastProcessedMessageId':_0x529ae1});const _0x5670d0=(0x0,GetHandlers_1['getBodyMessage'])(_0x1fb448);console[_0x4c3777(0x27e)](_0x4c3777(0x255)+_0x5670d0+_0x4c3777(0x2a3)+_0x5a0ae6['id']+_0x4c3777(0x2be)+_0x5a0ae6[_0x4c3777(0x1fe)]);const _0x13b55d=await Queue_1[_0x4c3777(0x24d)][_0x4c3777(0x292)](_0x5a0ae6['queueId'],{'include':[{'model':QueueOption_1['default'],'as':_0x4c3777(0x203),'where':{'parentId':null},'order':[[_0x4c3777(0x244),'ASC']],'required':![]}]}),_0x28fc62=await Whatsapp_1['default'][_0x4c3777(0x292)](_0x5a0ae6[_0x4c3777(0x217)]);if(!_0x28fc62){console[_0x4c3777(0x21c)](_0x4c3777(0x22b));return;}if(_0x5670d0==='#'){await _0x5a0ae6[_0x4c3777(0x230)]({'queueOptionId':null,'chatbot':![],'queueId':null,'amountUsedBotQueues':0x0}),await(0x0,VerifyHandlers_1[_0x4c3777(0x26d)])(_0x4e360a,_0x1fb448,_0x5a0ae6,_0x5a0ae6[_0x4c3777(0x2cd)]);return;}if(!(0x0,lodash_1['isNil'])(_0x13b55d)&&!(0x0,lodash_1[_0x4c3777(0x1df)])(_0x5a0ae6['queueOptionId'])&&_0x5670d0==='0'){const _0xccf89a=await QueueOption_1['default']['findByPk'](_0x5a0ae6[_0x4c3777(0x1fe)]);_0xccf89a?.[_0x4c3777(0x2a2)]?await _0x5a0ae6[_0x4c3777(0x230)]({'queueOptionId':_0xccf89a[_0x4c3777(0x2a2)],'amountUsedBotQueues':0x0}):await _0x5a0ae6[_0x4c3777(0x230)]({'queueOptionId':null,'amountUsedBotQueues':0x0});await _0x5a0ae6[_0x4c3777(0x205)](),await(0x0,exports[_0x4c3777(0x257)])(_0x5a0ae6,_0x4e360a);return;}if(!_0x5a0ae6[_0x4c3777(0x2a7)]&&_0x5a0ae6['amountUsedBotQueues']>=_0x28fc62[_0x4c3777(0x25a)])return;if(!(0x0,lodash_1['isNil'])(_0x13b55d)&&(0x0,lodash_1[_0x4c3777(0x1df)])(_0x5a0ae6['queueOptionId'])&&!_0x533c3a){if(_0x5670d0&&_0x13b55d[_0x4c3777(0x203)]?.[_0x4c3777(0x28a)]>0x0){const _0x4f9bf3=_0x13b55d['options'][_0x4c3777(0x259)](_0x2c640c=>_0x2c640c[_0x4c3777(0x244)]===_0x5670d0);if(_0x4f9bf3){console['log'](_0x4c3777(0x250)+_0x5670d0+_0x4c3777(0x2ae)+_0x4f9bf3['id']),await _0x5a0ae6[_0x4c3777(0x230)]({'queueOptionId':_0x4f9bf3['id'],'amountUsedBotQueues':0x0}),await _0x5a0ae6['reload'](),await(0x0,exports[_0x4c3777(0x257)])(_0x5a0ae6,_0x4e360a);return;}else console[_0x4c3777(0x27e)]('Opção\x20'+_0x5670d0+_0x4c3777(0x1ea));}}else{if(!(0x0,lodash_1[_0x4c3777(0x1df)])(_0x13b55d)&&!(0x0,lodash_1[_0x4c3777(0x1df)])(_0x5a0ae6[_0x4c3777(0x1fe)])){const _0x4b95cb=await QueueOption_1[_0x4c3777(0x24d)]['findAll']({'where':{'parentId':_0x5a0ae6['queueOptionId']},'order':[[_0x4c3777(0x244),_0x4c3777(0x226)]]});if(_0x5670d0&&_0x4b95cb[_0x4c3777(0x28a)]>0x0){const _0x3bfb06=_0x4b95cb[_0x4c3777(0x259)](_0x4f68ca=>_0x4f68ca[_0x4c3777(0x244)]===_0x5670d0);if(_0x3bfb06){console[_0x4c3777(0x27e)]('Opção\x20'+_0x5670d0+'\x20selecionada\x20no\x20submenu.\x20ID:\x20'+_0x3bfb06['id']),await _0x5a0ae6[_0x4c3777(0x230)]({'queueOptionId':_0x3bfb06['id'],'amountUsedBotQueues':0x0}),await _0x5a0ae6[_0x4c3777(0x205)](),await(0x0,exports[_0x4c3777(0x257)])(_0x5a0ae6,_0x4e360a);return;}else console['log'](_0x4c3777(0x250)+_0x5670d0+_0x4c3777(0x245));}}}if(_0x5670d0&&_0x5670d0!=='0'&&_0x5670d0!=='#'){console[_0x4c3777(0x27e)](_0x4c3777(0x1f0)+_0x5670d0);if(_0x28fc62[_0x4c3777(0x25a)]&&_0x28fc62[_0x4c3777(0x25a)]!==0x0&&_0x5a0ae6['amountUsedBotQueues']>=_0x28fc62[_0x4c3777(0x25a)]){await _0x5a0ae6[_0x4c3777(0x230)]({'chatbot':![],'amountUsedBotQueues':_0x28fc62['maxUseBotQueues']});_0x28fc62[_0x4c3777(0x264)]&&await(0x0,SendWhatsAppMessage_1[_0x4c3777(0x24d)])({'ticket':_0x5a0ae6,'body':_0x28fc62[_0x4c3777(0x264)]});return;}await _0x5a0ae6[_0x4c3777(0x230)]({'amountUsedBotQueues':_0x5a0ae6[_0x4c3777(0x275)]+0x1}),await _0x5a0ae6[_0x4c3777(0x205)]();}!_0x533c3a&&await(0x0,exports[_0x4c3777(0x257)])(_0x5a0ae6,_0x4e360a);},displayCurrentMenu=async(_0x43a040,_0x5bb366)=>{const _0x343499=a587_0x5436c2;console[_0x343499(0x27e)]('Exibindo\x20menu\x20para\x20ticket\x20'+_0x43a040['id']+',\x20queueOptionId:\x20'+_0x43a040[_0x343499(0x1fe)]);const _0x2ee29c=await Queue_1[_0x343499(0x24d)][_0x343499(0x292)](_0x43a040['queueId']);if(!_0x2ee29c)return;if((0x0,lodash_1[_0x343499(0x1df)])(_0x43a040[_0x343499(0x1fe)])){const _0x4575f2=await QueueOption_1[_0x343499(0x24d)][_0x343499(0x24a)]({'where':{'queueId':_0x43a040[_0x343499(0x262)],'parentId':null},'order':[[_0x343499(0x244),'ASC']]});if(_0x4575f2[_0x343499(0x28a)]>0x0){let _0x196b09=_0x2ee29c[_0x343499(0x227)]?_0x2ee29c[_0x343499(0x227)]+'\x0a\x0a':'';_0x4575f2[_0x343499(0x1fa)](_0x1148a3=>{const _0x2a9367=_0x343499;_0x196b09+='*'+_0x1148a3[_0x2a9367(0x244)]+_0x2a9367(0x249)+_0x1148a3[_0x2a9367(0x204)]+'\x0a';}),_0x196b09+=_0x343499(0x25b),await(0x0,SendWhatsAppMessage_1[_0x343499(0x24d)])({'ticket':_0x43a040,'body':_0x196b09}),console[_0x343499(0x27e)](_0x343499(0x258));}return;}const _0x45d682=await QueueOption_1[_0x343499(0x24d)][_0x343499(0x292)](_0x43a040['queueOptionId'],{'include':[{'model':Queue_1[_0x343499(0x24d)],'as':_0x343499(0x2c4)}]});if(!_0x45d682){console['log'](_0x343499(0x250)+_0x43a040[_0x343499(0x1fe)]+_0x343499(0x1dd));return;}const _0x139cf5=await QueueOption_1[_0x343499(0x24d)][_0x343499(0x24a)]({'where':{'parentId':_0x43a040[_0x343499(0x1fe)]},'order':[[_0x343499(0x244),'ASC']]});if(_0x139cf5['length']===0x0){console[_0x343499(0x27e)](_0x343499(0x252));let _0x3d0feb=(0x0,Mustache_1[_0x343499(0x24d)])('‎'+_0x45d682[_0x343499(0x246)],_0x43a040);if(_0x45d682?.[_0x343499(0x209)]){const _0x5a56aa=path_1[_0x343499(0x24d)]['resolve'](_0x343499(0x267),_0x45d682[_0x343499(0x209)]);_0x5a56aa?await(0x0,SendWhatsAppMedia_1['default'])({'media':_0x5a56aa,'ticket':_0x43a040,'body':_0x3d0feb}):await(0x0,SendWhatsAppMessage_1[_0x343499(0x24d)])({'ticket':_0x43a040,'body':_0x3d0feb});}else await(0x0,SendWhatsAppMessage_1[_0x343499(0x24d)])({'ticket':_0x43a040,'body':_0x3d0feb});if(_0x45d682['exitChatbot'])await _0x43a040[_0x343499(0x230)]({'queueOptionId':null,'chatbot':![],'amountUsedBotQueues':0x0});else{if(_0x45d682[_0x343499(0x283)]){await _0x43a040[_0x343499(0x230)]({'queueOptionId':null,'chatbot':![],'queueId':_0x45d682[_0x343499(0x283)],'amountUsedBotQueues':0x0}),await _0x43a040[_0x343499(0x205)]();if(_0x45d682[_0x343499(0x2c4)]){const _0x22a45=await QueueOption_1['default'][_0x343499(0x28b)]({'where':{'queueId':_0x45d682['forwardQueueId'],'parentId':null}});await _0x43a040[_0x343499(0x230)]({'chatbot':!!_0x22a45}),_0x45d682['forwardQueue'][_0x343499(0x227)]&&await(0x0,SendWhatsAppMessage_1[_0x343499(0x24d)])({'ticket':_0x43a040,'body':_0x45d682[_0x343499(0x2c4)][_0x343499(0x227)]}),_0x22a45&&await(0x0,exports[_0x343499(0x257)])(_0x43a040,_0x5bb366);}}else await _0x43a040[_0x343499(0x230)]({'queueOptionId':null,'chatbot':![]});}return;}console[_0x343499(0x27e)](_0x343499(0x212)+_0x139cf5[_0x343499(0x28a)]+'\x20opções.\x20Exibindo\x20submenu.');let _0x269649=_0x45d682[_0x343499(0x246)]?_0x45d682[_0x343499(0x246)]+'\x0a\x0a':'';_0x139cf5[_0x343499(0x1fa)](_0x26a5a8=>{const _0x333f6a=_0x343499;_0x269649+='*'+_0x26a5a8['option']+'*\x20-\x20'+_0x26a5a8[_0x333f6a(0x204)]+'\x0a';}),_0x269649+=_0x343499(0x219),_0x269649+=_0x343499(0x211);if(_0x45d682?.['mediaPath']){const _0x2addd8=path_1['default']['resolve'](_0x343499(0x267),_0x45d682[_0x343499(0x209)]);_0x2addd8?await(0x0,SendWhatsAppMedia_1[_0x343499(0x24d)])({'media':_0x2addd8,'ticket':_0x43a040,'body':_0x269649}):await(0x0,SendWhatsAppMessage_1[_0x343499(0x24d)])({'ticket':_0x43a040,'body':_0x269649});}else await(0x0,SendWhatsAppMessage_1['default'])({'ticket':_0x43a040,'body':_0x269649});};exports[a587_0x5436c2(0x257)]=displayCurrentMenu;const handleMessageIntegration=async(_0x3325a2,_0x4a7452,_0x46c96c,_0x33548e)=>{const _0xa413de=a587_0x5436c2;if(process['env'][_0xa413de(0x2c1)]){if(_0x33548e[_0xa413de(0x2cd)][_0xa413de(0x289)]!=process[_0xa413de(0x20d)]['CHATBOT_RESTRICT_NUMBER']){console[_0xa413de(0x27e)](_0xa413de(0x2c6));return;}}console[_0xa413de(0x27e)](_0xa413de(0x25e),_0x33548e[_0xa413de(0x298)]),_0x46c96c[_0xa413de(0x27d)]===_0xa413de(0x26f)&&!_0x33548e[_0xa413de(0x298)]?(await(0x0,typebotListener_1['default'])({'ticket':_0x33548e,'msg':_0x3325a2,'wbot':_0x4a7452,'typebot':_0x46c96c}),!_0x33548e['useIntegration']&&(await _0x33548e[_0xa413de(0x230)]({'useIntegration':!![],'integrationId':_0x46c96c['id']}),console['log'](_0xa413de(0x200)+_0x33548e['id']))):console[_0xa413de(0x27e)](_0xa413de(0x2a0));};exports[a587_0x5436c2(0x268)]=handleMessageIntegration;const handleMessage=async(_0x17084c,_0x4342d3,_0x3c958c)=>{const _0x212c02=a587_0x5436c2;if(!isValidMsg(_0x17084c))return;_0x17084c['message']?.[_0x212c02(0x27a)]&&(_0x17084c[_0x212c02(0x246)]=_0x17084c[_0x212c02(0x246)][_0x212c02(0x27a)][_0x212c02(0x246)]);try{let _0x4861ee,_0xcdf669;const _0x4eea2f=_0x17084c['key']['remoteJid']?.[_0x212c02(0x278)]('@g.us');if(_0x4eea2f){const _0x140b21=await Setting_1[_0x212c02(0x24d)][_0x212c02(0x28b)]({'where':{'companyId':_0x3c958c,'key':'CheckMsgIsGroup'}});if(!_0x140b21||_0x140b21[_0x212c02(0x2ba)]===_0x212c02(0x21a))return;}const _0x4aa572=(0x0,GetHandlers_1['getBodyMessage'])(_0x17084c),_0x2e5888=(0x0,GetHandlers_1[_0x212c02(0x23f)])(_0x17084c),_0x1f7e48=_0x2e5888!==_0x212c02(0x1e3)&&(0x0,GetHandlers_1[_0x212c02(0x2c9)])(_0x17084c),_0x43b3b0=_0x1f7e48&&(0x0,GetHandlers_1[_0x212c02(0x1ee)])(_0x1f7e48);if(_0x17084c[_0x212c02(0x231)][_0x212c02(0x28c)]){if(_0x4aa572?.[_0x212c02(0x2cf)]('‎'))return;if(!_0x43b3b0&&_0x2e5888!==_0x212c02(0x2af)&&_0x2e5888!==_0x212c02(0x1fb)&&_0x2e5888!=='vcard')return;_0x4861ee=await(0x0,GetHandlers_1[_0x212c02(0x270)])(_0x17084c,_0x4342d3);}else _0x4861ee=await(0x0,GetHandlers_1['getContactMessage'])(_0x17084c,_0x4342d3);_0x4eea2f&&(_0xcdf669=await wbotMutex[_0x212c02(0x21e)](async()=>{const _0x2dfef0=_0x212c02;let _0xd0f6a0=groupContactCache[_0x2dfef0(0x23d)](_0x17084c[_0x2dfef0(0x231)][_0x2dfef0(0x263)]);if(!_0xd0f6a0){const _0x46520c=await _0x4342d3[_0x2dfef0(0x208)](_0x17084c[_0x2dfef0(0x231)]['remoteJid']),_0x2a9c4d={'id':_0x46520c['id'],'name':_0x46520c[_0x2dfef0(0x26b)]};_0xd0f6a0=await(0x0,VerifyHandlers_1[_0x2dfef0(0x1f1)])(_0x2a9c4d,_0x4342d3,_0x3c958c),groupContactCache['set'](_0x17084c[_0x2dfef0(0x231)][_0x2dfef0(0x263)],_0xd0f6a0);}return _0xd0f6a0;}));const _0x403a75=await(0x0,ShowWhatsAppService_1[_0x212c02(0x24d)])(_0x4342d3['id'],_0x3c958c),_0xc6385d=_0x17084c[_0x212c02(0x231)],_0x34310c=_0xc6385d[_0x212c02(0x1e6)]||_0xc6385d[_0x212c02(0x2b2)],_0x4383d1=await(0x0,VerifyHandlers_1[_0x212c02(0x1f1)])(_0x4861ee,_0x4342d3,_0x3c958c,_0x34310c);let _0x3dedfa=_0x4383d1;if(!_0x17084c[_0x212c02(0x231)]['fromMe']){const _0x8db7bd=_0x17084c['key'],_0x81bd10=_0x17084c[_0x212c02(0x231)][_0x212c02(0x263)],_0x26d8a2=_0x8db7bd[_0x212c02(0x2b2)];let _0x92f36a=null,_0x4d7ff5=![];if(_0x81bd10?.['includes']('@s.whatsapp.net'))_0x92f36a=_0x81bd10,_0x4d7ff5=_0x4383d1[_0x212c02(0x289)]['length']>0xd;else _0x81bd10?.[_0x212c02(0x29c)](_0x212c02(0x1ed))&&_0x26d8a2?.['includes']('@s.whatsapp.net')&&(_0x92f36a=_0x26d8a2,_0x4d7ff5=!![]);if(_0x92f36a&&_0x4d7ff5){const _0x38bd0c=_0x92f36a[_0x212c02(0x295)]('@')[0x0],_0x381039=await Contact_1[_0x212c02(0x24d)][_0x212c02(0x28b)]({'where':{'number':_0x38bd0c,'companyId':_0x4383d1[_0x212c02(0x20e)]}});if(_0x381039&&_0x381039['id']!==_0x4383d1['id']){_0x3dedfa=_0x381039;const _0x3534ef=_0x81bd10?.[_0x212c02(0x29c)](_0x212c02(0x1ed))?_0x81bd10:_0x26d8a2,_0x60c58d=_0x3534ef?.[_0x212c02(0x295)]('@')[0x0],_0x18d73e={};_0x60c58d&&!_0x381039['lid']&&(_0x18d73e['lid']=_0x60c58d);_0x92f36a&&!_0x381039[_0x212c02(0x263)]&&(_0x18d73e[_0x212c02(0x263)]=_0x92f36a);const _0x4526a0=!_0x381039[_0x212c02(0x276)]||_0x381039[_0x212c02(0x276)]===''||_0x381039[_0x212c02(0x276)]===process['env']['FRONTEND_URL']+_0x212c02(0x216);_0x4526a0&&_0x4383d1[_0x212c02(0x276)]&&_0x4383d1['profilePicUrl']!==process['env'][_0x212c02(0x1f4)]+_0x212c02(0x216)&&(_0x18d73e['profilePicUrl']=_0x4383d1['profilePicUrl']);Object[_0x212c02(0x284)](_0x18d73e)[_0x212c02(0x28a)]>0x0&&await _0x381039[_0x212c02(0x230)](_0x18d73e);const _0xa65502=await Ticket_1[_0x212c02(0x24d)][_0x212c02(0x287)]({'where':{'contactId':_0x4383d1['id']}});_0xa65502===0x0&&await _0x4383d1['destroy']();}else!_0x381039&&(await _0x4383d1[_0x212c02(0x230)]({'number':_0x38bd0c,'remoteJid':_0x92f36a}),_0x3dedfa=_0x4383d1);}}let _0x149816=0x0;if(_0x17084c[_0x212c02(0x231)][_0x212c02(0x28c)])await cache_1[_0x212c02(0x1e9)]['set'](_0x212c02(0x222)+_0x3dedfa['id']+':unreads','0');else{const _0x489527=await cache_1[_0x212c02(0x1e9)][_0x212c02(0x23d)](_0x212c02(0x222)+_0x3dedfa['id']+_0x212c02(0x232));_0x149816=+_0x489527+0x1,await cache_1['cacheLayer'][_0x212c02(0x256)](_0x212c02(0x222)+_0x3dedfa['id']+_0x212c02(0x232),''+_0x149816);}const _0x47fa8c=await Message_1['default']['findOne']({'where':{'contactId':_0x3dedfa['id'],'companyId':_0x3c958c,'$ticket.whatsappId$':_0x403a75['id']},'include':[_0x212c02(0x2a1)],'order':[[_0x212c02(0x1ff),_0x212c02(0x1e0)]]}),_0x55db27=_0x403a75[_0x212c02(0x2a8)][_0x212c02(0x27c)]()||_0x212c02(0x280);if(_0x47fa8c&&_0x149816===0x0&&_0x55db27&&(0x0,Mustache_1[_0x212c02(0x24d)])(_0x55db27,_0x47fa8c[_0x212c02(0x2a1)])[_0x212c02(0x27c)]()['toLowerCase']()===_0x47fa8c?.['body'][_0x212c02(0x27c)]()['toLowerCase']())return;if(!_0x17084c[_0x212c02(0x231)][_0x212c02(0x28c)]&&!_0x3dedfa[_0x212c02(0x2b0)]){if(_0x403a75[_0x212c02(0x24e)]){const _0x404227=await TicketTraking_1[_0x212c02(0x24d)]['findOne']({'where':{'whatsappId':_0x403a75['id'],'rated':![],'ratingAt':{[sequelize_1['Op']['not']]:null},'finishedAt':null},'include':[{'model':Ticket_1[_0x212c02(0x24d)],'where':{'status':_0x212c02(0x2b3),'contactId':_0x3dedfa['id']},'include':[{'model':Contact_1[_0x212c02(0x24d)]},{'model':User_1[_0x212c02(0x24d)]},{'model':Queue_1['default']}]}]});if(_0x404227)try{const _0x1cb677=Number(_0x4aa572);if(!Number[_0x212c02(0x27f)](_0x1cb677)){const _0x50a226=(0x0,Debounce_1[_0x212c02(0x210)])(async()=>{const _0x392079=_0x212c02,_0x590a15=_0x403a75['ratingMessage']?.[_0x392079(0x27c)]()||_0x392079(0x251);await(0x0,SendWhatsAppMessage_1['default'])({'ticket':_0x285eea,'body':'\x0a*'+_0x590a15+'*'});},0x3e8,_0x404227[_0x212c02(0x2a1)]['id']);_0x50a226();return;}if((0x0,VerifyHandlers_1[_0x212c02(0x23e)])(_0x404227)){(0x0,exports[_0x212c02(0x25d)])(_0x17084c,_0x404227[_0x212c02(0x2a1)],_0x404227);return;}}catch(_0x2b0721){Sentry[_0x212c02(0x286)](_0x2b0721),console[_0x212c02(0x27e)](_0x212c02(0x2a5),_0x2b0721);}}}const {ticket:_0x285eea,justCreated:_0x5a3fe3}=await(0x0,FindOrCreateTicketService_1[_0x212c02(0x24d)])(_0x3dedfa,_0x4342d3['id'],_0x149816,_0x3c958c,_0xcdf669);if(_0x43b3b0||_0x17084c?.[_0x212c02(0x246)]?.[_0x212c02(0x1fb)]?.[_0x212c02(0x288)])await(0x0,VerifyHandlers_1[_0x212c02(0x221)])(_0x17084c,_0x285eea,_0x3dedfa,_0x4342d3,_0x43b3b0);else{if(_0x17084c['message']?.[_0x212c02(0x207)]?.['message']?.[_0x212c02(0x2b7)]?.[_0x212c02(0x207)])await(0x0,VerifyHandlers_1[_0x212c02(0x234)])(_0x17084c['message'][_0x212c02(0x207)][_0x212c02(0x246)][_0x212c02(0x2b7)][_0x212c02(0x207)],_0x285eea,_0x17084c[_0x212c02(0x246)]['editedMessage'][_0x212c02(0x246)]['protocolMessage'][_0x212c02(0x231)]['id']);else{if(_0x17084c[_0x212c02(0x246)]?.[_0x212c02(0x2b7)]?.[_0x212c02(0x207)])await(0x0,VerifyHandlers_1[_0x212c02(0x234)])(_0x17084c[_0x212c02(0x246)]['protocolMessage']['editedMessage'],_0x285eea,_0x17084c['message'][_0x212c02(0x2b7)][_0x212c02(0x231)]['id']);else _0x17084c['message']?.['protocolMessage']?.[_0x212c02(0x27d)]===0x0?await(0x0,VerifyHandlers_1[_0x212c02(0x1e5)])(_0x17084c['message'][_0x212c02(0x2b7)],_0x285eea):await(0x0,VerifyHandlers_1[_0x212c02(0x2c7)])(_0x17084c,_0x285eea,_0x3dedfa,null,_0x4342d3);}}if(_0x285eea['useIntegration']===!![]&&_0x285eea[_0x212c02(0x293)]){const _0xf98aeb=await(0x0,ShowQueueIntegrationService_1['default'])(_0x285eea['integrationId'],_0x3c958c);if(_0xf98aeb){await(0x0,exports[_0x212c02(0x268)])(_0x17084c,_0x4342d3,_0xf98aeb,_0x285eea);return;}else await _0x285eea['update']({'useIntegration':![],'integrationId':null,'typebotSessionId':null});}if(_0x4aa572==='#'&&!_0x4eea2f){await _0x285eea[_0x212c02(0x230)]({'queueOptionId':null,'chatbot':![],'queueId':null}),await(0x0,VerifyHandlers_1['verifyQueue'])(_0x4342d3,_0x17084c,_0x285eea,_0x285eea[_0x212c02(0x2cd)]);return;}if(_0x4eea2f||_0x3dedfa[_0x212c02(0x1e2)])return;const _0x27be0e=await(0x0,CheckSettings_1[_0x212c02(0x274)])(_0x3c958c,'scheduleType',_0x212c02(0x2d0));try{if(!_0x17084c[_0x212c02(0x231)][_0x212c02(0x28c)]&&_0x27be0e){const _0x1e6192=await(0x0,CheckSettings_1[_0x212c02(0x274)])(_0x3c958c,_0x212c02(0x2ac),_0x212c02(0x260));let _0x15d28f=null;const _0x4eaa67=_0x285eea[_0x212c02(0x2c2)]==='open'&&_0x285eea[_0x212c02(0x282)]['socketSessions']['length']>0x0,_0x43751e=!_0x4eaa67&&outOfHoursCache['get']('ticket-'+_0x285eea['id']);if(_0x27be0e===_0x212c02(0x2bc)&&!_0x4eaa67){_0x15d28f=await(0x0,VerifyCurrentSchedule_1[_0x212c02(0x24d)])(_0x3c958c),console[_0x212c02(0x27e)]('Resultado\x20da\x20verificação\x20de\x20horário:',{'currentSchedule':_0x15d28f,'isInActivity':_0x15d28f?.[_0x212c02(0x2b8)]});if(_0x15d28f&&_0x15d28f[_0x212c02(0x2b8)]===![]){if(!_0x43751e){outOfHoursCache[_0x212c02(0x256)]('ticket-'+_0x285eea['id'],!![]);const _0x2947d8=_0x403a75[_0x212c02(0x2cc)][_0x212c02(0x27c)]()||'Estamos\x20fora\x20do\x20horário\x20de\x20expediente';await(0x0,SendWhatsAppMessage_1[_0x212c02(0x24d)])({'ticket':_0x285eea,'body':_0x2947d8});}_0x285eea['status']!==_0x212c02(0x2b3)&&await(0x0,UpdateTicketService_1[_0x212c02(0x24d)])({'ticketData':{'chatbot':![],'status':_0x1e6192},'ticketId':_0x285eea['id'],'companyId':_0x285eea[_0x212c02(0x20e)]});return;}}if(_0x27be0e===_0x212c02(0x28f)&&_0x285eea[_0x212c02(0x262)]!==null&&!_0x4eaa67){_0x15d28f=await(0x0,VerifyCurrentSchedule_1[_0x212c02(0x24d)])(_0x3c958c,_0x285eea[_0x212c02(0x262)]);const _0x3cc348=await Queue_1[_0x212c02(0x24d)]['findByPk'](_0x285eea[_0x212c02(0x262)]);if(!(0x0,lodash_1[_0x212c02(0x1df)])(_0x15d28f)&&(!_0x15d28f||_0x15d28f[_0x212c02(0x2b8)]===![])){if(!_0x43751e){outOfHoursCache[_0x212c02(0x256)]('ticket-'+_0x285eea['id'],!![]);const _0xc05c3c=_0x3cc348[_0x212c02(0x2cc)]?.['trim']()||'Estamos\x20fora\x20do\x20horário\x20de\x20expediente';await(0x0,SendWhatsAppMessage_1[_0x212c02(0x24d)])({'ticket':_0x285eea,'body':_0xc05c3c});}_0x285eea[_0x212c02(0x2c2)]!==_0x212c02(0x2b3)&&await(0x0,UpdateTicketService_1['default'])({'ticketData':{'chatbot':![],'status':_0x1e6192},'ticketId':_0x285eea['id'],'companyId':_0x285eea[_0x212c02(0x20e)]});return;}}}}catch(_0x1c7a01){Sentry['captureException'](_0x1c7a01),console[_0x212c02(0x27e)]('Erro\x20ao\x20verificar\x20horário\x20de\x20atendimento:',_0x1c7a01);}!_0x285eea['queue']&&!_0x4eea2f&&!_0x17084c[_0x212c02(0x231)][_0x212c02(0x28c)]&&!_0x285eea[_0x212c02(0x22c)]&&_0x403a75[_0x212c02(0x239)][_0x212c02(0x28a)]>=0x1&&await(0x0,VerifyHandlers_1[_0x212c02(0x26d)])(_0x4342d3,_0x17084c,_0x285eea,_0x285eea[_0x212c02(0x2cd)]);const _0x31fed9=_0x285eea[_0x212c02(0x28f)]===null;await _0x285eea[_0x212c02(0x205)]();if(_0x5a3fe3&&!_0x403a75?.[_0x212c02(0x239)]?.[_0x212c02(0x28a)]&&!_0x285eea[_0x212c02(0x22c)]&&!_0x4eea2f&&!_0x17084c[_0x212c02(0x231)]['fromMe']){const _0x36644b=await Message_1['default']['findOne']({'where':{'ticketId':_0x285eea['id'],'fromMe':!![]},'order':[[_0x212c02(0x1ff),_0x212c02(0x1e0)]]});if(_0x36644b&&_0x36644b['body'][_0x212c02(0x29c)](_0x403a75[_0x212c02(0x227)]))return;if(_0x403a75[_0x212c02(0x227)]){const _0x27b03b=(0x0,Debounce_1[_0x212c02(0x210)])(async()=>{const _0x50ee45=_0x212c02;await(0x0,SendWhatsAppMessage_1[_0x50ee45(0x24d)])({'ticket':_0x285eea,'body':''+_0x403a75[_0x50ee45(0x227)]});},0x3e8,_0x285eea['id']);_0x27b03b();return;}}if(!_0x285eea['chatbot']&&_0x285eea[_0x212c02(0x275)]>=_0x403a75?.[_0x212c02(0x25a)])return;if(_0x285eea[_0x212c02(0x2a7)]&&!_0x17084c[_0x212c02(0x231)][_0x212c02(0x28c)]){await handleChartbot(_0x285eea,_0x17084c,_0x4342d3);return;}_0x403a75[_0x212c02(0x239)]['length']===0x1&&_0x285eea['queue']&&(_0x285eea[_0x212c02(0x2a7)]&&!_0x17084c[_0x212c02(0x231)][_0x212c02(0x28c)]&&!_0x285eea[_0x212c02(0x2c3)]&&await handleChartbot(_0x285eea,_0x17084c,_0x4342d3,_0x31fed9)),_0x403a75[_0x212c02(0x239)]['length']>0x1&&_0x285eea['queue']&&(_0x285eea[_0x212c02(0x2a7)]&&!_0x17084c[_0x212c02(0x231)][_0x212c02(0x28c)]&&!_0x285eea[_0x212c02(0x2c3)]&&await handleChartbot(_0x285eea,_0x17084c,_0x4342d3,_0x31fed9));}catch(_0x4cb335){Sentry[_0x212c02(0x286)](_0x4cb335),logger_1[_0x212c02(0x20c)]['error'](_0x212c02(0x2b6)+_0x4cb335);}};exports[a587_0x5436c2(0x2aa)]=handleMessage;const handleMsgAck=async(_0x463a2b,_0x4d22e5)=>{const _0x417094=a587_0x5436c2;if(!_0x4d22e5)return;const _0x5a0540=(0x0,socket_1[_0x417094(0x248)])();try{const _0x4c135b=await Message_1['default'][_0x417094(0x292)](_0x463a2b['key']['id'],{'include':[_0x417094(0x2cd),{'model':Message_1['default'],'as':_0x417094(0x254),'include':[_0x417094(0x2cd)]}]});if(!_0x4c135b||_0x4d22e5<=_0x4c135b[_0x417094(0x21d)])return;await _0x4c135b[_0x417094(0x230)]({'ack':_0x4d22e5}),_0x5a0540['to'](_0x4c135b[_0x417094(0x2ab)][_0x417094(0x202)]())[_0x417094(0x1fc)](_0x417094(0x1eb)+_0x4c135b[_0x417094(0x20e)]+_0x417094(0x2cb),{'action':'update','message':_0x4c135b});}catch(_0x48a30f){Sentry[_0x417094(0x286)](_0x48a30f),logger_1[_0x417094(0x20c)][_0x417094(0x21c)]('Error\x20handling\x20message\x20ack.\x20Err:\x20'+_0x48a30f);}},filterMessages=_0x4a1258=>{const _0x5d520c=a587_0x5436c2;if(_0x4a1258[_0x5d520c(0x246)]?.[_0x5d520c(0x2b7)]?.['editedMessage'])return!![];if(_0x4a1258['message']?.[_0x5d520c(0x2b7)]?.['type']===0x0)return!![];if(_0x4a1258['message']?.[_0x5d520c(0x2b7)])return![];if([baileys_1['WAMessageStubType'][_0x5d520c(0x24c)],baileys_1[_0x5d520c(0x20b)]['E2E_DEVICE_CHANGED'],baileys_1['WAMessageStubType']['E2E_IDENTITY_CHANGED'],baileys_1[_0x5d520c(0x20b)][_0x5d520c(0x2d3)]][_0x5d520c(0x29c)](_0x4a1258[_0x5d520c(0x269)]))return![];return!![];},wbotMessageListener=async(_0xf1ad2a,_0x4d8be1)=>{const _0x2a0420=a587_0x5436c2;try{_0xf1ad2a['ev']['on']('messages.upsert',async _0x1f28b9=>{const _0x24c238=a587_0x454b,_0x29b506=_0x1f28b9[_0x24c238(0x27b)][_0x24c238(0x1f6)](filterMessages)['map'](_0x83109c=>_0x83109c);if(!_0x29b506)return;_0x29b506[_0x24c238(0x1fa)](async _0x570984=>{const _0x231248=_0x24c238,_0x3031c3=await Message_1[_0x231248(0x24d)][_0x231248(0x287)]({'where':{'id':_0x570984[_0x231248(0x231)]['id'],'companyId':_0x4d8be1}});if(!_0x3031c3){if(await(0x0,VerifyHandlers_1['verifyRecentCampaign'])(_0x570984,_0x4d8be1))return;await handleMessage(_0x570984,_0xf1ad2a,_0x4d8be1);}});}),_0xf1ad2a['ev']['on'](_0x2a0420(0x271),_0x26a1ac=>{const _0x5b7c02=_0x2a0420;if(_0x26a1ac['length']===0x0)return;_0x26a1ac[_0x5b7c02(0x1fa)](async _0x2914e0=>{const _0x1d029d=_0x5b7c02;_0xf1ad2a[_0x1d029d(0x24f)]([_0x2914e0['key']]),await ackMutex[_0x1d029d(0x21e)](async()=>{const _0x2f8935=_0x1d029d;handleMsgAck(_0x2914e0,_0x2914e0[_0x2f8935(0x230)][_0x2f8935(0x2c2)]);});});});}catch(_0x6bc824){Sentry[_0x2a0420(0x286)](_0x6bc824),logger_1[_0x2a0420(0x20c)][_0x2a0420(0x21c)]('Error\x20handling\x20wbot\x20message\x20listener.\x20Err:\x20'+_0x6bc824);}};exports['wbotMessageListener']=wbotMessageListener;