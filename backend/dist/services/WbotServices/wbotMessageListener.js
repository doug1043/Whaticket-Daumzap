'use strict';const a697_0x53c00b=a697_0x9bdf;(function(_0xbd1bac,_0x411bb3){const _0x34a138=a697_0x9bdf,_0x1dee93=_0xbd1bac();while(!![]){try{const _0x38540f=parseInt(_0x34a138(0x232))/0x1*(parseInt(_0x34a138(0x1eb))/0x2)+-parseInt(_0x34a138(0x25f))/0x3*(-parseInt(_0x34a138(0x20d))/0x4)+-parseInt(_0x34a138(0x240))/0x5*(-parseInt(_0x34a138(0x25e))/0x6)+-parseInt(_0x34a138(0x1a7))/0x7*(-parseInt(_0x34a138(0x1c3))/0x8)+parseInt(_0x34a138(0x1f4))/0x9*(parseInt(_0x34a138(0x1ba))/0xa)+-parseInt(_0x34a138(0x1b2))/0xb*(parseInt(_0x34a138(0x26d))/0xc)+parseInt(_0x34a138(0x1bd))/0xd*(-parseInt(_0x34a138(0x1ae))/0xe);if(_0x38540f===_0x411bb3)break;else _0x1dee93['push'](_0x1dee93['shift']());}catch(_0x41c490){_0x1dee93['push'](_0x1dee93['shift']());}}}(a697_0x3a90,0x6057a));function a697_0x9bdf(_0x5c727d,_0x583f88){const _0x5f1d82=a697_0x3a90();return a697_0x9bdf=function(_0x57dd65,_0x38810d){_0x57dd65=_0x57dd65-0x1a1;let _0x3a9003=_0x5f1d82[_0x57dd65];return _0x3a9003;},a697_0x9bdf(_0x5c727d,_0x583f88);}var __createBinding=this&&this['__createBinding']||(Object[a697_0x53c00b(0x22c)]?function(_0x5a9406,_0x33bdde,_0x18eddc,_0x56a61e){const _0x1027fa=a697_0x53c00b;if(_0x56a61e===undefined)_0x56a61e=_0x18eddc;var _0x557b97=Object[_0x1027fa(0x26a)](_0x33bdde,_0x18eddc);(!_0x557b97||(_0x1027fa(0x1fe)in _0x557b97?!_0x33bdde[_0x1027fa(0x23a)]:_0x557b97['writable']||_0x557b97[_0x1027fa(0x294)]))&&(_0x557b97={'enumerable':!![],'get':function(){return _0x33bdde[_0x18eddc];}}),Object[_0x1027fa(0x1d5)](_0x5a9406,_0x56a61e,_0x557b97);}:function(_0x132495,_0x129cd8,_0x1903f8,_0x24c7b6){if(_0x24c7b6===undefined)_0x24c7b6=_0x1903f8;_0x132495[_0x24c7b6]=_0x129cd8[_0x1903f8];}),__setModuleDefault=this&&this[a697_0x53c00b(0x20e)]||(Object[a697_0x53c00b(0x22c)]?function(_0x31ebde,_0x3a104a){const _0x21db77=a697_0x53c00b;Object['defineProperty'](_0x31ebde,_0x21db77(0x21e),{'enumerable':!![],'value':_0x3a104a});}:function(_0x380bf7,_0x512a3f){const _0x3d4564=a697_0x53c00b;_0x380bf7[_0x3d4564(0x21e)]=_0x512a3f;}),__importStar=this&&this[a697_0x53c00b(0x27b)]||(function(){const _0x4c7254=(function(){let _0x1374a9=!![];return function(_0x577c90,_0x5c1fc4){const _0x27df6e=_0x1374a9?function(){const _0x4d0581=a697_0x9bdf;if(_0x5c1fc4){const _0x47afb9=_0x5c1fc4[_0x4d0581(0x1ac)](_0x577c90,arguments);return _0x5c1fc4=null,_0x47afb9;}}:function(){};return _0x1374a9=![],_0x27df6e;};}()),_0x43461a=_0x4c7254(this,function(){const _0x47c3f5=a697_0x9bdf;return _0x43461a[_0x47c3f5(0x1fb)]()[_0x47c3f5(0x1c0)](_0x47c3f5(0x250))['toString']()[_0x47c3f5(0x1f1)](_0x43461a)[_0x47c3f5(0x1c0)]('(((.+)+)+)+$');});_0x43461a();var _0x58b39a=function(_0x5d5518){const _0x810986=a697_0x9bdf;return _0x58b39a=Object[_0x810986(0x1c8)]||function(_0x2c1045){const _0x533687=_0x810986;var _0x2eddd7=[];for(var _0x4de62c in _0x2c1045)if(Object[_0x533687(0x1e4)]['hasOwnProperty'][_0x533687(0x266)](_0x2c1045,_0x4de62c))_0x2eddd7[_0x2eddd7[_0x533687(0x25a)]]=_0x4de62c;return _0x2eddd7;},_0x58b39a(_0x5d5518);};return function(_0x2eb459){const _0x1197f6=a697_0x9bdf;if(_0x2eb459&&_0x2eb459[_0x1197f6(0x23a)])return _0x2eb459;var _0x4c8f29={};if(_0x2eb459!=null){for(var _0x2d7da3=_0x58b39a(_0x2eb459),_0x2dc289=0x0;_0x2dc289<_0x2d7da3['length'];_0x2dc289++)if(_0x2d7da3[_0x2dc289]!==_0x1197f6(0x21e))__createBinding(_0x4c8f29,_0x2eb459,_0x2d7da3[_0x2dc289]);}return __setModuleDefault(_0x4c8f29,_0x2eb459),_0x4c8f29;};}()),__importDefault=this&&this['__importDefault']||function(_0x417288){const _0x4cdbdb=a697_0x53c00b;return _0x417288&&_0x417288[_0x4cdbdb(0x23a)]?_0x417288:{'default':_0x417288};};Object[a697_0x53c00b(0x1d5)](exports,'__esModule',{'value':!![]}),exports['handleMessage']=exports['wbotMessageListener']=exports[a697_0x53c00b(0x1a9)]=exports['handleFlowBuilderExecution']=exports['handleRating']=void 0x0,exports['makeid']=makeid;const Sentry=__importStar(require('@sentry/node')),lodash_1=require(a697_0x53c00b(0x23b)),baileys_1=require(a697_0x53c00b(0x219)),async_mutex_1=require('async-mutex'),sequelize_1=require(a697_0x53c00b(0x281)),moment_1=__importDefault(require(a697_0x53c00b(0x20b))),Contact_1=__importDefault(require(a697_0x53c00b(0x1dc))),Ticket_1=__importDefault(require(a697_0x53c00b(0x278))),Message_1=__importDefault(require(a697_0x53c00b(0x221))),socket_1=require(a697_0x53c00b(0x1fd)),logger_1=require(a697_0x53c00b(0x1a6)),FindOrCreateTicketService_1=__importDefault(require(a697_0x53c00b(0x1cb))),ShowWhatsAppService_1=__importDefault(require('../WhatsappService/ShowWhatsAppService')),UpdateTicketService_1=__importDefault(require(a697_0x53c00b(0x223))),Mustache_1=__importDefault(require(a697_0x53c00b(0x1cd))),TicketTraking_1=__importDefault(require(a697_0x53c00b(0x1c2))),UserRating_1=__importDefault(require('../../models/UserRating')),SendWhatsAppMessage_1=__importDefault(require(a697_0x53c00b(0x239))),Queue_1=__importDefault(require(a697_0x53c00b(0x1e3))),FlowBuilder_1=__importDefault(require('../../models/FlowBuilder')),ActionsWebhookService_1=require(a697_0x53c00b(0x1f2)),VerifyCurrentSchedule_1=__importDefault(require(a697_0x53c00b(0x20c))),User_1=__importDefault(require('../../models/User')),Setting_1=__importDefault(require(a697_0x53c00b(0x236))),cache_1=require('../../libs/cache'),Debounce_1=require(a697_0x53c00b(0x22b)),CheckSettings_1=require(a697_0x53c00b(0x290)),Whatsapp_1=__importDefault(require(a697_0x53c00b(0x213))),simpleObjectCache_1=require(a697_0x53c00b(0x248)),ShowQueueIntegrationService_1=__importDefault(require(a697_0x53c00b(0x217))),typebotListener_1=__importDefault(require(a697_0x53c00b(0x231))),VerifyHandlers_1=require('./VerifyHandlers'),GetHandlers_1=require(a697_0x53c00b(0x27a)),wbotMutex=new async_mutex_1[(a697_0x53c00b(0x1d6))](),ackMutex=new async_mutex_1[(a697_0x53c00b(0x1d6))](),groupContactCache=new simpleObjectCache_1['SimpleObjectCache'](0x3e8*0x1e,logger_1[a697_0x53c00b(0x1c4)]),outOfHoursCache=new simpleObjectCache_1[(a697_0x53c00b(0x1aa))](0x3e8*0x3c*0x5,logger_1[a697_0x53c00b(0x1c4)]);function makeid(_0x53a987){const _0x333505=a697_0x53c00b;let _0xb3c23='';const _0x4c4731=_0x333505(0x244),_0x1038c5=_0x4c4731[_0x333505(0x25a)];for(let _0x196396=0x0;_0x196396<_0x53a987;_0x196396+=0x1){_0xb3c23+=_0x4c4731[_0x333505(0x1cc)](Math[_0x333505(0x1da)](Math[_0x333505(0x1bb)]()*_0x1038c5));}return _0xb3c23;}const isValidMsg=_0x3448ba=>{const _0x28e618=a697_0x53c00b;if(_0x3448ba[_0x28e618(0x274)][_0x28e618(0x262)]===_0x28e618(0x29b))return![];try{const _0xefb90b=(0x0,GetHandlers_1[_0x28e618(0x1d4)])(_0x3448ba);if(!_0xefb90b)return![];const _0x4d78b7=_0xefb90b===_0x28e618(0x1ed)||_0xefb90b===_0x28e618(0x212)||_0xefb90b===_0x28e618(0x1ea)||_0xefb90b===_0x28e618(0x275)||_0xefb90b===_0x28e618(0x1c1)||_0xefb90b===_0x28e618(0x1b0)||_0xefb90b==='documentMessage'||_0xefb90b==='documentWithCaptionMessage'||_0xefb90b===_0x28e618(0x235)||_0xefb90b==='buttonsResponseMessage'||_0xefb90b==='buttonsMessage'||_0xefb90b===_0x28e618(0x1b6)||_0xefb90b===_0x28e618(0x200)||_0xefb90b===_0x28e618(0x1c9)||_0xefb90b==='contactMessage'||_0xefb90b===_0x28e618(0x298)||_0xefb90b===_0x28e618(0x211)||_0xefb90b===_0x28e618(0x28f)||_0xefb90b===_0x28e618(0x222)||_0xefb90b==='ephemeralMessage'||_0xefb90b===_0x28e618(0x288)||_0xefb90b===_0x28e618(0x1d3)||_0xefb90b===_0x28e618(0x263)||_0xefb90b===_0x28e618(0x1e0)||_0xefb90b===_0x28e618(0x28b)||_0xefb90b===_0x28e618(0x24f);return!_0x4d78b7&&(logger_1[_0x28e618(0x1c4)][_0x28e618(0x1a2)]('####\x20Nao\x20achou\x20o\x20type\x20em\x20isValidMsg:\x20'+_0xefb90b+'\x0a'+JSON[_0x28e618(0x1f7)](_0x3448ba?.['message'])),Sentry[_0x28e618(0x267)](_0x28e618(0x1be),{'BodyMsg':_0x3448ba[_0x28e618(0x251)],'msg':_0x3448ba,'msgType':_0xefb90b}),Sentry['captureException'](new Error('Novo\x20Tipo\x20de\x20Mensagem\x20em\x20isValidMsg'))),!!_0x4d78b7;}catch(_0x51962f){return Sentry['setExtra']('Error\x20isValidMsg',{'msg':_0x3448ba}),Sentry[_0x28e618(0x203)](_0x51962f),![];}},handleRating=async(_0x1c5b41,_0x24da4f,_0x1f6bc3)=>{const _0x3351c9=a697_0x53c00b,_0x5890c2=(0x0,socket_1[_0x3351c9(0x26b)])();let _0x1b7013=null;(_0x1c5b41?.['message']?.[_0x3351c9(0x1ed)]||_0x1c5b41?.['message']?.['extendedTextMessage'])&&(_0x1b7013=parseInt(_0x1c5b41['message'][_0x3351c9(0x1ed)]||_0x1c5b41[_0x3351c9(0x251)][_0x3351c9(0x1ea)][_0x3351c9(0x247)],0xa)||null);if(!Number[_0x3351c9(0x24c)](_0x1b7013)&&Number[_0x3351c9(0x1f0)](_0x1b7013)&&!(0x0,lodash_1[_0x3351c9(0x1e7)])(_0x1b7013)){const _0x4800e1=await(0x0,ShowWhatsAppService_1[_0x3351c9(0x21e)])(_0x24da4f[_0x3351c9(0x24d)],_0x24da4f[_0x3351c9(0x234)]);let _0x41bb02=_0x1b7013;_0x1b7013<0x1&&(_0x41bb02=0x1);_0x1b7013>0x5&&(_0x41bb02=0x5);await UserRating_1[_0x3351c9(0x21e)][_0x3351c9(0x22c)]({'ticketId':_0x1f6bc3[_0x3351c9(0x276)],'companyId':_0x1f6bc3[_0x3351c9(0x234)],'userId':_0x1f6bc3[_0x3351c9(0x238)],'rate':_0x41bb02});const _0x21f661=_0x4800e1['complationMessage']['trim']()||_0x3351c9(0x1e6);await(0x0,SendWhatsAppMessage_1['default'])({'ticket':_0x24da4f,'body':_0x21f661}),await _0x1f6bc3[_0x3351c9(0x1db)]({'finishedAt':(0x0,moment_1['default'])()[_0x3351c9(0x295)](),'rated':!![]});const _0x3a7386=await(0x0,CheckSettings_1[_0x3351c9(0x29e)])(_0x24da4f['companyId'],'keepUserAndQueue',_0x3351c9(0x229))===_0x3351c9(0x229);await _0x24da4f[_0x3351c9(0x1db)]({'queueId':_0x3a7386?_0x24da4f[_0x3351c9(0x23f)]:null,'chatbot':null,'userId':_0x3a7386?_0x24da4f[_0x3351c9(0x238)]:null,'status':_0x3351c9(0x285)}),_0x5890c2['to']('company-'+_0x24da4f[_0x3351c9(0x234)]+_0x3351c9(0x208))['to']('queue-'+_0x24da4f[_0x3351c9(0x23f)]+_0x3351c9(0x208))['emit']('company-'+_0x24da4f[_0x3351c9(0x234)]+'-ticket',{'action':_0x3351c9(0x226),'ticket':_0x24da4f,'ticketId':_0x24da4f['id']}),_0x5890c2['to']('company-'+_0x24da4f[_0x3351c9(0x234)]+'-'+_0x24da4f['status'])['to'](_0x3351c9(0x27d)+_0x24da4f[_0x3351c9(0x23f)]+'-'+_0x24da4f[_0x3351c9(0x1bf)])['to'](_0x24da4f['id'][_0x3351c9(0x1fb)]())['emit'](_0x3351c9(0x22d)+_0x24da4f[_0x3351c9(0x234)]+_0x3351c9(0x256),{'action':_0x3351c9(0x1db),'ticket':_0x24da4f,'ticketId':_0x24da4f['id']});}};exports[a697_0x53c00b(0x1f9)]=handleRating;const handleFlowBuilderExecution=async(_0x401337,_0x4e7ed8,_0x2a51bb='')=>{const _0x55c691=a697_0x53c00b;console[_0x55c691(0x21a)]('Iniciando\x20execução\x20do\x20FlowBuilder\x20para\x20ticket\x20'+_0x401337['id']+',\x20flowBuilderId:\x20'+_0x401337['flowBuilderId']);const _0x4a1570=await FlowBuilder_1[_0x55c691(0x21e)][_0x55c691(0x1ad)](_0x401337[_0x55c691(0x27f)]);if(!_0x4a1570||!_0x4a1570[_0x55c691(0x220)]){console[_0x55c691(0x1df)](_0x55c691(0x1b8)+_0x401337['flowBuilderId']+_0x55c691(0x1e8));return;}const _0x1a2ecc=await Whatsapp_1['default'][_0x55c691(0x1ad)](_0x401337[_0x55c691(0x24d)]),_0x2832c0=await Contact_1[_0x55c691(0x21e)][_0x55c691(0x1ad)](_0x401337[_0x55c691(0x277)]);if(!_0x1a2ecc||!_0x2832c0){console[_0x55c691(0x1df)](_0x55c691(0x209));return;}const _0x2252f4={'number':_0x2832c0[_0x55c691(0x23e)],'name':_0x2832c0[_0x55c691(0x1a1)],'email':_0x2832c0[_0x55c691(0x28d)]},_0x2c885a=_0x4a1570[_0x55c691(0x220)][_0x55c691(0x21b)],_0xd310e1=_0x4a1570[_0x55c691(0x220)]['edges']||_0x4a1570[_0x55c691(0x220)][_0x55c691(0x265)],_0x4f995f=_0x2c885a[_0x55c691(0x291)](_0x390f28=>_0x390f28[_0x55c691(0x1fa)]==='start'),_0x2fe5e4=_0x4f995f?_0x4f995f['id']:_0x2c885a[0x0]?.['id']||'1';await _0x401337[_0x55c691(0x1db)]({'flowWebhook':!![],'flowStopped':String(_0x401337[_0x55c691(0x27f)])}),await(0x0,ActionsWebhookService_1[_0x55c691(0x245)])(_0x1a2ecc['id'],parseInt(String(_0x401337[_0x55c691(0x27f)])),_0x401337[_0x55c691(0x234)],_0x2c885a,_0xd310e1,_0x2fe5e4,null,'','',_0x2a51bb,_0x401337['id'],_0x2252f4,null);};exports[a697_0x53c00b(0x264)]=handleFlowBuilderExecution;const handleFlowBuilder=async(_0x4669a8,_0x197d13,_0x2fd7ad)=>{const _0x41fc65=a697_0x53c00b,_0x41e75a=_0x197d13[_0x41fc65(0x274)]['id'];if(_0x4669a8['lastProcessedMessageId']===_0x41e75a){console[_0x41fc65(0x21a)](_0x41fc65(0x257)+_0x41e75a+'\x20já\x20processada\x20para\x20o\x20ticket\x20'+_0x4669a8['id']+_0x41fc65(0x253));return;}await _0x4669a8[_0x41fc65(0x1db)]({'lastProcessedMessageId':_0x41e75a});const _0x1ca2f8=(0x0,GetHandlers_1['getBodyMessage'])(_0x197d13);console['log'](_0x41fc65(0x218)+_0x1ca2f8+'\x22\x20para\x20ticket\x20'+_0x4669a8['id']),await(0x0,exports[_0x41fc65(0x264)])(_0x4669a8,_0x2fd7ad,_0x1ca2f8);},handleMessageIntegration=async(_0xb6b4d7,_0x2427cf,_0x3b8855,_0x360df0)=>{const _0x1a85f2=a697_0x53c00b;if(process[_0x1a85f2(0x1d1)][_0x1a85f2(0x25c)]){if(_0x360df0[_0x1a85f2(0x1e9)][_0x1a85f2(0x23e)]!=process[_0x1a85f2(0x1d1)][_0x1a85f2(0x25c)]){console['log'](_0x1a85f2(0x27e));return;}}console[_0x1a85f2(0x21a)](_0x1a85f2(0x1e1),_0x360df0[_0x1a85f2(0x1f5)]),_0x3b8855[_0x1a85f2(0x1fa)]===_0x1a85f2(0x237)&&!_0x360df0['typebotStatus']?(await(0x0,typebotListener_1[_0x1a85f2(0x21e)])({'ticket':_0x360df0,'msg':_0xb6b4d7,'wbot':_0x2427cf,'typebot':_0x3b8855}),!_0x360df0[_0x1a85f2(0x25b)]&&(await _0x360df0[_0x1a85f2(0x1db)]({'useIntegration':!![],'integrationId':_0x3b8855['id']}),console[_0x1a85f2(0x21a)]('Atualizando\x20estado\x20de\x20integração\x20do\x20ticket\x20#'+_0x360df0['id']))):console[_0x1a85f2(0x21a)](_0x1a85f2(0x1f8));};exports[a697_0x53c00b(0x1a9)]=handleMessageIntegration;function a697_0x3a90(){const _0x36e5ba=['ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789','ActionsWebhookService','keys','text','../../helpers/simpleObjectCache','map','messages','DESC','isNaN','whatsappId','inActivity','viewOnceMessageV2','(((.+)+)+)+$','message','Erro\x20de\x20decriptação\x20ignorado\x20para\x20mensagem\x20','.\x20Ignorando\x20em\x20handleFlowBuilder.','collectiveVacationMessage','isNil','-ticket','Mensagem\x20','company','findOne','length','useIntegration','CHATBOT_RESTRICT_NUMBER','greetingMessage','20160YgNUWt','1776123tKoEDy','contacts:','emit','remoteJid','listMessage','handleFlowBuilderExecution','connections','call','setExtra','isFinite','participant','getOwnPropertyDescriptor','getIO','toLowerCase','12sRwoJt','WAMessageStubType','not','failed\x20to\x20decrypt','outOfHoursAction','CheckMsgIsGroup','senderPn','key','audioMessage','ticketId','contactId','../../models/Ticket','Resultado\x20da\x20verificação\x20de\x20horário:','./GetHandlers','__importStar','-appMessage','queue-','chatbot\x20desativado!','flowBuilderId','quotedMsg','sequelize','forEach','getMessageMedia','useRating','closed','value','runExclusive','protocolMessage','verifyMessage','createdAt','viewOnceMessage','outOfHoursMessage','email','@newsletter','contactsArrayMessage','../../helpers/CheckSettings','find','set','Erro\x20ao\x20processar\x20avaliação:','configurable','toDate','destroy','verifyRating','voiceMessage','messages.update','Error\x20handling\x20wbot\x20message\x20listener.\x20Err:\x20','status@broadcast','trim','scheduleType','GetCompanySetting','name','warn','REVOKE','wbotMessageListener','\x20-\x20Enviando\x20mensagem\x20de\x20férias\x20(apenas\x201\x20vez)','../../utils/logger','58492AEHRTe','Ticket\x20#','handleMessageIntegration','SimpleObjectCache','verifyDeleteMessage','apply','findByPk','14IlOvqc','E2E_IDENTITY_CHANGED','imageMessage','readMessages','8292911iPfgYe',':unreads','thumbnailDirectPath','subject','messageContextInfo','\x20está\x20em\x20flow\x20ativo.\x20Processando\x20dentro\x20do\x20flow.','FlowBuilder\x20','Erro\x20ao\x20verificar\x20horário\x20de\x20atendimento:','130ffseJE','random','\x20de\x20','19190639pYfCJh','Mensagem','status','search','videoMessage','../../models/TicketTraking','176BwCzVD','logger','chatbot','debounce','CIPHERTEXT','getOwnPropertyNames','liveLocationMessage','startsWith','../TicketServices/FindOrCreateTicketService','charAt','../../helpers/Mustache','FRONTEND_URL','ticket','Error\x20handling\x20whatsapp\x20message:\x20Err:\x20','env','@s.whatsapp.net','listResponseMessage','getTypeMessage','defineProperty','Mutex','endsWith','debug','profilePicUrl','floor','update','../../models/Contact','\x20-\x20Mensagem\x20enviada,\x20ticket\x20fica\x20pendente\x20para\x20atendimento\x20posterior','remoteJidAlt','error','templateMessage','typebotStatus:\x20','complationMessage','../../models/Queue','prototype','verifyContact','Atendimento\x20finalizado','isNull','\x20não\x20encontrado\x20ou\x20sem\x20flow','contact','extendedTextMessage','1136572tQDqCJ','reload','conversation','queues','ephemeralMessage','isInteger','constructor','../WebhookService/ActionsWebhookService','ticket-','514359ccXlZI','typebotStatus','filter','stringify','Tipo\x20de\x20integração\x20não\x20suportada.','handleRating','type','toString','open','../../libs/socket','get','maxUseBotQueues','locationMessage','messages.upsert','integrationId','captureException','socketSessions','verifyEditedMessage','pending','verifyQueue','-open','WhatsApp\x20ou\x20Contact\x20não\x20encontrado','getContactMessage','moment','../CompanyService/VerifyCurrentSchedule','4EikgMB','__setModuleDefault','body','handleMessage','mediaMessage','editedMessage','../../models/Whatsapp','messageStubType','fromMe','ack','../QueueIntegrationServices/ShowQueueIntegrationService','Processando\x20mensagem\x20do\x20FlowBuilder:\x20\x22','@whiskeysockets/baileys','log','nodes','/nopicture.png','[Férias\x20Coletivas]\x20Novo\x20ticket\x20#','default','split','flow','../../models/Message','reactionMessage','../TicketServices/UpdateTicketService','vcard','includes','delete','flowWebhook','@g.us','enabled','queue','../../helpers/Debounce','create','company-','count','getBodyMessage','disabled','../TypebotServices/typebotListener','1VIjZka','@lid','companyId','stickerMessage','../../models/Setting','typebot','userId','./SendWhatsAppMessage','__esModule','lodash','Mensagem\x20de\x20canal/newsletter\x20ignorada:\x20','verifyMediaMessage','number','queueId','800rmrTRA','Estamos\x20fora\x20do\x20horário\x20de\x20expediente','lid','verifyRecentCampaign'];a697_0x3a90=function(){return _0x36e5ba;};return a697_0x3a90();}const handleMessage=async(_0xfe121a,_0x4935c1,_0x64cb8e)=>{const _0x4e4ecd=a697_0x53c00b;if(!isValidMsg(_0xfe121a))return;_0xfe121a[_0x4e4ecd(0x251)]?.[_0x4e4ecd(0x1ef)]&&(_0xfe121a[_0x4e4ecd(0x251)]=_0xfe121a[_0x4e4ecd(0x251)]['ephemeralMessage'][_0x4e4ecd(0x251)]);try{let _0x126066,_0x345a18;const _0x277242=_0xfe121a[_0x4e4ecd(0x274)][_0x4e4ecd(0x262)]?.[_0x4e4ecd(0x1d7)](_0x4e4ecd(0x228)),_0x321f1a=_0xfe121a[_0x4e4ecd(0x274)][_0x4e4ecd(0x262)]?.['endsWith'](_0x4e4ecd(0x28e)),_0x459042=_0xfe121a[_0x4e4ecd(0x274)]['remoteJid']===_0x4e4ecd(0x29b);if(_0x459042){logger_1[_0x4e4ecd(0x1c4)][_0x4e4ecd(0x1d8)]('Mensagem\x20de\x20status\x20ignorada\x20de:\x20'+_0xfe121a[_0x4e4ecd(0x274)][_0x4e4ecd(0x269)]);return;}if(_0x321f1a){logger_1[_0x4e4ecd(0x1c4)]['info'](_0x4e4ecd(0x23c)+_0xfe121a[_0x4e4ecd(0x274)][_0x4e4ecd(0x262)]);return;}if(_0x277242){const _0x4340ec=await Setting_1['default'][_0x4e4ecd(0x259)]({'where':{'companyId':_0x64cb8e,'key':_0x4e4ecd(0x272)}});if(!_0x4340ec||_0x4340ec[_0x4e4ecd(0x286)]==='enabled')return;}const _0x3b522e=(0x0,GetHandlers_1[_0x4e4ecd(0x22f)])(_0xfe121a),_0x9eed1a=(0x0,GetHandlers_1[_0x4e4ecd(0x1d4)])(_0xfe121a),_0x3c2d05=_0x9eed1a!=='templateMessage'&&(0x0,GetHandlers_1['getUnpackedMessage'])(_0xfe121a),_0x4e6aee=_0x3c2d05&&(0x0,GetHandlers_1[_0x4e4ecd(0x283)])(_0x3c2d05);if(_0xfe121a[_0x4e4ecd(0x274)][_0x4e4ecd(0x215)]){if(_0x3b522e?.[_0x4e4ecd(0x1ca)]('‎'))return;if(!_0x4e6aee&&_0x9eed1a!==_0x4e4ecd(0x1ed)&&_0x9eed1a!==_0x4e4ecd(0x1ea)&&_0x9eed1a!==_0x4e4ecd(0x224))return;_0x126066=await(0x0,GetHandlers_1[_0x4e4ecd(0x20a)])(_0xfe121a,_0x4935c1);}else _0x126066=await(0x0,GetHandlers_1[_0x4e4ecd(0x20a)])(_0xfe121a,_0x4935c1);_0x277242&&(_0x345a18=await wbotMutex[_0x4e4ecd(0x287)](async()=>{const _0x2316be=_0x4e4ecd;let _0x44b726=groupContactCache[_0x2316be(0x1fe)](_0xfe121a['key'][_0x2316be(0x262)]);if(!_0x44b726){const _0x41783a=await _0x4935c1['groupMetadata'](_0xfe121a['key']['remoteJid']),_0x1c249a={'id':_0x41783a['id'],'name':_0x41783a[_0x2316be(0x1b5)]};_0x44b726=await(0x0,VerifyHandlers_1['verifyContact'])(_0x1c249a,_0x4935c1,_0x64cb8e),groupContactCache['set'](_0xfe121a[_0x2316be(0x274)][_0x2316be(0x262)],_0x44b726);}return _0x44b726;}));const _0x1646fe=await(0x0,ShowWhatsAppService_1[_0x4e4ecd(0x21e)])(_0x4935c1['id'],_0x64cb8e),_0x45bf52=_0xfe121a[_0x4e4ecd(0x274)],_0x4a8dbf=_0x45bf52[_0x4e4ecd(0x273)]||_0x45bf52[_0x4e4ecd(0x1de)],_0x348471=await(0x0,VerifyHandlers_1[_0x4e4ecd(0x1e5)])(_0x126066,_0x4935c1,_0x64cb8e,_0x4a8dbf);let _0x16f21c=_0x348471;if(!_0xfe121a['key'][_0x4e4ecd(0x215)]){const _0x1e3f13=_0xfe121a[_0x4e4ecd(0x274)],_0x14e982=_0xfe121a[_0x4e4ecd(0x274)]['remoteJid'],_0x1cb47b=_0x1e3f13[_0x4e4ecd(0x1de)];let _0x245c5a=null,_0x1bcc75=![];if(_0x14e982?.[_0x4e4ecd(0x225)](_0x4e4ecd(0x1d2)))_0x245c5a=_0x14e982,_0x1bcc75=_0x348471[_0x4e4ecd(0x23e)][_0x4e4ecd(0x25a)]>0xd;else _0x14e982?.[_0x4e4ecd(0x225)](_0x4e4ecd(0x233))&&_0x1cb47b?.['includes'](_0x4e4ecd(0x1d2))&&(_0x245c5a=_0x1cb47b,_0x1bcc75=!![]);if(_0x245c5a&&_0x1bcc75){const _0x2827ab=_0x245c5a[_0x4e4ecd(0x21f)]('@')[0x0],_0x17ebd7=await Contact_1['default'][_0x4e4ecd(0x259)]({'where':{'number':_0x2827ab,'companyId':_0x348471[_0x4e4ecd(0x234)]}});if(_0x17ebd7&&_0x17ebd7['id']!==_0x348471['id']){_0x16f21c=_0x17ebd7;const _0x296745=_0x14e982?.[_0x4e4ecd(0x225)](_0x4e4ecd(0x233))?_0x14e982:_0x1cb47b,_0x1172ea=_0x296745?.['split']('@')[0x0],_0x2f0ea6={};_0x1172ea&&!_0x17ebd7[_0x4e4ecd(0x242)]&&(_0x2f0ea6['lid']=_0x1172ea);_0x245c5a&&!_0x17ebd7[_0x4e4ecd(0x262)]&&(_0x2f0ea6[_0x4e4ecd(0x262)]=_0x245c5a);const _0x376d7c=!_0x17ebd7[_0x4e4ecd(0x1d9)]||_0x17ebd7[_0x4e4ecd(0x1d9)]===''||_0x17ebd7['profilePicUrl']===process[_0x4e4ecd(0x1d1)][_0x4e4ecd(0x1ce)]+_0x4e4ecd(0x21c);_0x376d7c&&_0x348471[_0x4e4ecd(0x1d9)]&&_0x348471['profilePicUrl']!==process['env'][_0x4e4ecd(0x1ce)]+_0x4e4ecd(0x21c)&&(_0x2f0ea6['profilePicUrl']=_0x348471['profilePicUrl']);Object[_0x4e4ecd(0x246)](_0x2f0ea6)['length']>0x0&&await _0x17ebd7[_0x4e4ecd(0x1db)](_0x2f0ea6);const _0x56f651=await Ticket_1[_0x4e4ecd(0x21e)][_0x4e4ecd(0x22e)]({'where':{'contactId':_0x348471['id']}});_0x56f651===0x0&&await _0x348471[_0x4e4ecd(0x296)]();}else!_0x17ebd7&&(await _0x348471[_0x4e4ecd(0x1db)]({'number':_0x2827ab,'remoteJid':_0x245c5a}),_0x16f21c=_0x348471);}}let _0x25b006=0x0;if(_0xfe121a['key'][_0x4e4ecd(0x215)])await cache_1['cacheLayer'][_0x4e4ecd(0x292)](_0x4e4ecd(0x260)+_0x16f21c['id']+_0x4e4ecd(0x1b3),'0');else{const _0x418ba3=await cache_1['cacheLayer'][_0x4e4ecd(0x1fe)](_0x4e4ecd(0x260)+_0x16f21c['id']+_0x4e4ecd(0x1b3));_0x25b006=+_0x418ba3+0x1,await cache_1['cacheLayer']['set']('contacts:'+_0x16f21c['id']+':unreads',''+_0x25b006);}const _0x1547bb=await Message_1[_0x4e4ecd(0x21e)]['findOne']({'where':{'contactId':_0x16f21c['id'],'companyId':_0x64cb8e,'$ticket.whatsappId$':_0x1646fe['id']},'include':[_0x4e4ecd(0x1cf)],'order':[[_0x4e4ecd(0x28a),_0x4e4ecd(0x24b)]]}),_0x592a2c=_0x1646fe[_0x4e4ecd(0x1e2)][_0x4e4ecd(0x29c)]()||'Atendimento\x20finalizado';if(_0x1547bb&&_0x25b006===0x0&&_0x592a2c&&(0x0,Mustache_1['default'])(_0x592a2c,_0x1547bb[_0x4e4ecd(0x1cf)])[_0x4e4ecd(0x29c)]()[_0x4e4ecd(0x26c)]()===_0x1547bb?.[_0x4e4ecd(0x20f)][_0x4e4ecd(0x29c)]()[_0x4e4ecd(0x26c)]())return;if(!_0xfe121a[_0x4e4ecd(0x274)]['fromMe']&&!_0x16f21c['isGroup']){if(_0x1646fe[_0x4e4ecd(0x284)]){const _0x2601c8=await TicketTraking_1[_0x4e4ecd(0x21e)][_0x4e4ecd(0x259)]({'where':{'whatsappId':_0x1646fe['id'],'rated':![],'ratingAt':{[sequelize_1['Op'][_0x4e4ecd(0x26f)]]:null},'finishedAt':null},'include':[{'model':Ticket_1[_0x4e4ecd(0x21e)],'where':{'status':'open','contactId':_0x16f21c['id']},'include':[{'model':Contact_1['default']},{'model':User_1[_0x4e4ecd(0x21e)]},{'model':Queue_1[_0x4e4ecd(0x21e)]}]}]});if(_0x2601c8)try{const _0x329cf0=Number(_0x3b522e);if(!Number[_0x4e4ecd(0x268)](_0x329cf0)){const _0x2f0707=(0x0,Debounce_1[_0x4e4ecd(0x1c6)])(async()=>{const _0x39975d=_0x4e4ecd,_0x101d8f=_0x1646fe['ratingMessage']?.[_0x39975d(0x29c)]()||'Por\x20favor\x20avalie\x20nosso\x20atendimento';await(0x0,SendWhatsAppMessage_1[_0x39975d(0x21e)])({'ticket':_0x3c9820,'body':'\x0a*'+_0x101d8f+'*'});},0x3e8,_0x2601c8['ticket']['id']);_0x2f0707();return;}if((0x0,VerifyHandlers_1[_0x4e4ecd(0x297)])(_0x2601c8)){(0x0,exports['handleRating'])(_0xfe121a,_0x2601c8[_0x4e4ecd(0x1cf)],_0x2601c8);return;}}catch(_0x332f40){Sentry[_0x4e4ecd(0x203)](_0x332f40),console[_0x4e4ecd(0x21a)](_0x4e4ecd(0x293),_0x332f40);}}}const {ticket:_0x3c9820,justCreated:_0x56a5e3,inVacation:_0x1664be}=await(0x0,FindOrCreateTicketService_1['default'])(_0x16f21c,_0x4935c1['id'],_0x25b006,_0x64cb8e,_0x345a18);if(_0x1664be&&_0x56a5e3&&!_0x277242){const _0x69659d=await(0x0,ShowWhatsAppService_1[_0x4e4ecd(0x21e)])(_0x4935c1['id'],_0x64cb8e);if(_0x69659d[_0x4e4ecd(0x254)]){console[_0x4e4ecd(0x21a)](_0x4e4ecd(0x21d)+_0x3c9820['id']+_0x4e4ecd(0x1a5));if(_0x4e6aee||_0xfe121a?.['message']?.[_0x4e4ecd(0x1ea)]?.[_0x4e4ecd(0x1b4)])await(0x0,VerifyHandlers_1[_0x4e4ecd(0x23d)])(_0xfe121a,_0x3c9820,_0x16f21c,_0x4935c1,_0x4e6aee);else!_0xfe121a[_0x4e4ecd(0x251)]?.[_0x4e4ecd(0x288)]&&await(0x0,VerifyHandlers_1[_0x4e4ecd(0x289)])(_0xfe121a,_0x3c9820,_0x16f21c,null,_0x4935c1);await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x69659d['collectiveVacationMessage'],'ticket':_0x3c9820,'quotedMsg':null}),console[_0x4e4ecd(0x21a)]('[Férias\x20Coletivas]\x20Ticket\x20#'+_0x3c9820['id']+_0x4e4ecd(0x1dd));return;}}if(_0x4e6aee||_0xfe121a?.[_0x4e4ecd(0x251)]?.['extendedTextMessage']?.[_0x4e4ecd(0x1b4)])await(0x0,VerifyHandlers_1[_0x4e4ecd(0x23d)])(_0xfe121a,_0x3c9820,_0x16f21c,_0x4935c1,_0x4e6aee);else{if(_0xfe121a[_0x4e4ecd(0x251)]?.[_0x4e4ecd(0x212)]?.[_0x4e4ecd(0x251)]?.[_0x4e4ecd(0x288)]?.['editedMessage'])await(0x0,VerifyHandlers_1[_0x4e4ecd(0x205)])(_0xfe121a[_0x4e4ecd(0x251)][_0x4e4ecd(0x212)][_0x4e4ecd(0x251)]['protocolMessage']['editedMessage'],_0x3c9820,_0xfe121a[_0x4e4ecd(0x251)][_0x4e4ecd(0x212)][_0x4e4ecd(0x251)][_0x4e4ecd(0x288)][_0x4e4ecd(0x274)]['id']);else{if(_0xfe121a[_0x4e4ecd(0x251)]?.['protocolMessage']?.['editedMessage'])await(0x0,VerifyHandlers_1['verifyEditedMessage'])(_0xfe121a[_0x4e4ecd(0x251)][_0x4e4ecd(0x288)][_0x4e4ecd(0x212)],_0x3c9820,_0xfe121a[_0x4e4ecd(0x251)][_0x4e4ecd(0x288)][_0x4e4ecd(0x274)]['id']);else _0xfe121a[_0x4e4ecd(0x251)]?.['protocolMessage']?.[_0x4e4ecd(0x1fa)]===0x0?await(0x0,VerifyHandlers_1[_0x4e4ecd(0x1ab)])(_0xfe121a[_0x4e4ecd(0x251)]['protocolMessage'],_0x3c9820):await(0x0,VerifyHandlers_1['verifyMessage'])(_0xfe121a,_0x3c9820,_0x16f21c,null,_0x4935c1);}}if(_0x3c9820['useIntegration']===!![]&&_0x3c9820[_0x4e4ecd(0x202)]){const _0x305381=await(0x0,ShowQueueIntegrationService_1[_0x4e4ecd(0x21e)])(_0x3c9820[_0x4e4ecd(0x202)],_0x64cb8e);if(_0x305381){await(0x0,exports[_0x4e4ecd(0x1a9)])(_0xfe121a,_0x4935c1,_0x305381,_0x3c9820);return;}else await _0x3c9820['update']({'useIntegration':![],'integrationId':null,'typebotSessionId':null});}if(_0x3b522e==='#'&&!_0x277242){await _0x3c9820['update']({'chatbot':![],'queueId':null,'flowBuilderId':null,'flowWebhook':![],'lastFlowId':null,'flowStopped':null,'hashFlowId':null,'dataWebhook':null}),await(0x0,VerifyHandlers_1[_0x4e4ecd(0x207)])(_0x4935c1,_0xfe121a,_0x3c9820,_0x3c9820[_0x4e4ecd(0x1e9)]);return;}const _0x2afbe9=await(0x0,CheckSettings_1['GetCompanySetting'])(_0x64cb8e,_0x4e4ecd(0x29d),_0x4e4ecd(0x230));try{if(!_0xfe121a[_0x4e4ecd(0x274)][_0x4e4ecd(0x215)]&&_0x2afbe9){const _0x1e3e5d=await(0x0,CheckSettings_1[_0x4e4ecd(0x29e)])(_0x64cb8e,_0x4e4ecd(0x271),_0x4e4ecd(0x206));let _0x5264a5=null;const _0x179ee6=_0x3c9820[_0x4e4ecd(0x1bf)]===_0x4e4ecd(0x1fc)&&_0x3c9820['user'][_0x4e4ecd(0x204)][_0x4e4ecd(0x25a)]>0x0,_0xa9cbb6=!_0x179ee6&&outOfHoursCache[_0x4e4ecd(0x1fe)]('ticket-'+_0x3c9820['id']);if(_0x2afbe9===_0x4e4ecd(0x258)&&!_0x179ee6){_0x5264a5=await(0x0,VerifyCurrentSchedule_1[_0x4e4ecd(0x21e)])(_0x64cb8e),console[_0x4e4ecd(0x21a)](_0x4e4ecd(0x279),{'currentSchedule':_0x5264a5,'isInActivity':_0x5264a5?.['inActivity']});if(_0x5264a5&&_0x5264a5[_0x4e4ecd(0x24e)]===![]){if(!_0xa9cbb6){outOfHoursCache[_0x4e4ecd(0x292)](_0x4e4ecd(0x1f3)+_0x3c9820['id'],!![]);const _0x2959fc=_0x1646fe[_0x4e4ecd(0x28c)]['trim']()||_0x4e4ecd(0x241);await(0x0,SendWhatsAppMessage_1[_0x4e4ecd(0x21e)])({'ticket':_0x3c9820,'body':_0x2959fc});}_0x3c9820[_0x4e4ecd(0x1bf)]!==_0x4e4ecd(0x1fc)&&await(0x0,UpdateTicketService_1[_0x4e4ecd(0x21e)])({'ticketData':{'chatbot':![],'status':_0x1e3e5d},'ticketId':_0x3c9820['id'],'companyId':_0x3c9820[_0x4e4ecd(0x234)]});return;}}if(_0x2afbe9===_0x4e4ecd(0x22a)&&_0x3c9820[_0x4e4ecd(0x23f)]!==null&&!_0x179ee6){_0x5264a5=await(0x0,VerifyCurrentSchedule_1['default'])(_0x64cb8e,_0x3c9820['queueId']);const _0x1894b=await Queue_1['default']['findByPk'](_0x3c9820[_0x4e4ecd(0x23f)]);if(!(0x0,lodash_1[_0x4e4ecd(0x255)])(_0x5264a5)&&(!_0x5264a5||_0x5264a5[_0x4e4ecd(0x24e)]===![])){if(!_0xa9cbb6){outOfHoursCache['set'](_0x4e4ecd(0x1f3)+_0x3c9820['id'],!![]);const _0x12119d=_0x1894b[_0x4e4ecd(0x28c)]?.[_0x4e4ecd(0x29c)]()||_0x4e4ecd(0x241);await(0x0,SendWhatsAppMessage_1[_0x4e4ecd(0x21e)])({'ticket':_0x3c9820,'body':_0x12119d});}_0x3c9820[_0x4e4ecd(0x1bf)]!==_0x4e4ecd(0x1fc)&&await(0x0,UpdateTicketService_1[_0x4e4ecd(0x21e)])({'ticketData':{'chatbot':![],'status':_0x1e3e5d},'ticketId':_0x3c9820['id'],'companyId':_0x3c9820['companyId']});return;}}}}catch(_0x2b2515){Sentry['captureException'](_0x2b2515),console[_0x4e4ecd(0x21a)](_0x4e4ecd(0x1b9),_0x2b2515);}if(_0x3c9820[_0x4e4ecd(0x227)]&&_0x3c9820[_0x4e4ecd(0x27f)]&&!_0xfe121a['key']['fromMe']){console[_0x4e4ecd(0x21a)](_0x4e4ecd(0x1a8)+_0x3c9820['id']+_0x4e4ecd(0x1b7)),await handleFlowBuilder(_0x3c9820,_0xfe121a,_0x4935c1);return;}!_0x3c9820[_0x4e4ecd(0x22a)]&&!_0x3c9820[_0x4e4ecd(0x27f)]&&!_0x277242&&!_0xfe121a[_0x4e4ecd(0x274)]['fromMe']&&!_0x3c9820['userId']&&!_0x1664be&&(_0x1646fe[_0x4e4ecd(0x1ee)]&&_0x1646fe[_0x4e4ecd(0x1ee)][_0x4e4ecd(0x25a)]>=0x1&&await(0x0,VerifyHandlers_1[_0x4e4ecd(0x207)])(_0x4935c1,_0xfe121a,_0x3c9820,_0x3c9820[_0x4e4ecd(0x1e9)]));const _0x42d946=_0x3c9820[_0x4e4ecd(0x22a)]===null;await _0x3c9820[_0x4e4ecd(0x1ec)]();if(_0x56a5e3&&!_0x1646fe?.[_0x4e4ecd(0x1ee)]?.[_0x4e4ecd(0x25a)]&&!_0x3c9820[_0x4e4ecd(0x238)]&&!_0x277242&&!_0xfe121a[_0x4e4ecd(0x274)]['fromMe']){const _0x2eb839=await Message_1['default'][_0x4e4ecd(0x259)]({'where':{'ticketId':_0x3c9820['id'],'fromMe':!![]},'order':[[_0x4e4ecd(0x28a),'DESC']]});if(_0x2eb839&&_0x2eb839[_0x4e4ecd(0x20f)]['includes'](_0x1646fe[_0x4e4ecd(0x25d)]))return;if(_0x1646fe[_0x4e4ecd(0x25d)]){const _0xddc142=(0x0,Debounce_1['debounce'])(async()=>{const _0x210a17=_0x4e4ecd;await(0x0,SendWhatsAppMessage_1['default'])({'ticket':_0x3c9820,'body':''+_0x1646fe[_0x210a17(0x25d)]});},0x3e8,_0x3c9820['id']);_0xddc142();return;}}if(!_0x3c9820[_0x4e4ecd(0x1c5)]&&_0x3c9820['amountUsedBotQueues']>=_0x1646fe?.[_0x4e4ecd(0x1ff)])return;if(_0x1646fe['queues'][_0x4e4ecd(0x25a)]===0x1&&_0x3c9820[_0x4e4ecd(0x22a)]){}if(_0x1646fe[_0x4e4ecd(0x1ee)]['length']>0x1&&_0x3c9820[_0x4e4ecd(0x22a)]){}}catch(_0x2a9c24){Sentry[_0x4e4ecd(0x203)](_0x2a9c24),logger_1[_0x4e4ecd(0x1c4)]['error'](_0x4e4ecd(0x1d0)+_0x2a9c24);}};exports[a697_0x53c00b(0x210)]=handleMessage;const handleMsgAck=async(_0x4f3f2c,_0x5d1617)=>{const _0x200d4a=a697_0x53c00b;if(!_0x5d1617)return;const _0x5eca11=(0x0,socket_1[_0x200d4a(0x26b)])();try{const _0x274ab2=await Message_1['default'][_0x200d4a(0x1ad)](_0x4f3f2c[_0x200d4a(0x274)]['id'],{'include':[_0x200d4a(0x1e9),{'model':Message_1[_0x200d4a(0x21e)],'as':_0x200d4a(0x280),'include':[_0x200d4a(0x1e9)]}]});if(!_0x274ab2||_0x5d1617<=_0x274ab2[_0x200d4a(0x216)])return;await _0x274ab2[_0x200d4a(0x1db)]({'ack':_0x5d1617}),_0x5eca11['to'](_0x274ab2[_0x200d4a(0x276)][_0x200d4a(0x1fb)]())[_0x200d4a(0x261)](_0x200d4a(0x22d)+_0x274ab2[_0x200d4a(0x234)]+_0x200d4a(0x27c),{'action':_0x200d4a(0x1db),'message':_0x274ab2});}catch(_0x2a00bb){Sentry['captureException'](_0x2a00bb),logger_1[_0x200d4a(0x1c4)]['error']('Error\x20handling\x20message\x20ack.\x20Err:\x20'+_0x2a00bb);}},filterMessages=_0x13be7e=>{const _0x19fee8=a697_0x53c00b;if(_0x13be7e[_0x19fee8(0x274)][_0x19fee8(0x262)]===_0x19fee8(0x29b))return![];if(_0x13be7e[_0x19fee8(0x274)]['remoteJid']?.['endsWith']('@newsletter'))return![];if(_0x13be7e['message']?.[_0x19fee8(0x288)]?.[_0x19fee8(0x212)])return!![];if(_0x13be7e[_0x19fee8(0x251)]?.['protocolMessage']?.[_0x19fee8(0x1fa)]===0x0)return!![];if(_0x13be7e[_0x19fee8(0x251)]?.['protocolMessage'])return![];if([baileys_1[_0x19fee8(0x26e)][_0x19fee8(0x1a3)],baileys_1[_0x19fee8(0x26e)]['E2E_DEVICE_CHANGED'],baileys_1['WAMessageStubType'][_0x19fee8(0x1af)],baileys_1[_0x19fee8(0x26e)][_0x19fee8(0x1c7)]][_0x19fee8(0x225)](_0x13be7e[_0x19fee8(0x214)]))return![];return!![];},wbotMessageListener=async(_0x1483d4,_0x38b099)=>{const _0x13d405=a697_0x53c00b;try{_0x1483d4['ev']['on'](_0x13d405(0x201),async _0x17c747=>{const _0x551283=_0x13d405,_0x56766d=_0x17c747[_0x551283(0x24a)][_0x551283(0x1f6)](filterMessages)[_0x551283(0x249)](_0x36a7f7=>_0x36a7f7);if(!_0x56766d)return;_0x56766d[_0x551283(0x282)](async _0x272b1e=>{const _0x253bc8=_0x551283;try{const _0xa4bbda=await Message_1[_0x253bc8(0x21e)][_0x253bc8(0x22e)]({'where':{'id':_0x272b1e[_0x253bc8(0x274)]['id'],'companyId':_0x38b099}});if(!_0xa4bbda){if(await(0x0,VerifyHandlers_1[_0x253bc8(0x243)])(_0x272b1e,_0x38b099))return;await handleMessage(_0x272b1e,_0x1483d4,_0x38b099);}}catch(_0x2f7b43){if(_0x2f7b43[_0x253bc8(0x251)]?.[_0x253bc8(0x225)]('serialized\x20is\x20not\x20iterable')||_0x2f7b43[_0x253bc8(0x251)]?.[_0x253bc8(0x225)](_0x253bc8(0x270))){logger_1[_0x253bc8(0x1c4)][_0x253bc8(0x1d8)](_0x253bc8(0x252)+_0x272b1e['key']['id']+_0x253bc8(0x1bc)+_0x272b1e[_0x253bc8(0x274)][_0x253bc8(0x262)]+':\x20'+_0x2f7b43['message']);return;}Sentry['captureException'](_0x2f7b43),logger_1[_0x253bc8(0x1c4)][_0x253bc8(0x1df)]('Error\x20processing\x20message\x20'+_0x272b1e[_0x253bc8(0x274)]['id']+':\x20'+_0x2f7b43);}});}),_0x1483d4['ev']['on'](_0x13d405(0x299),_0x51c01b=>{const _0x4e0b49=_0x13d405;if(_0x51c01b[_0x4e0b49(0x25a)]===0x0)return;_0x51c01b[_0x4e0b49(0x282)](async _0x5b6e06=>{const _0x29149f=_0x4e0b49;_0x1483d4[_0x29149f(0x1b1)]([_0x5b6e06[_0x29149f(0x274)]]),await ackMutex['runExclusive'](async()=>{const _0x321635=_0x29149f;handleMsgAck(_0x5b6e06,_0x5b6e06[_0x321635(0x1db)]['status']);});});});}catch(_0x4c1427){Sentry[_0x13d405(0x203)](_0x4c1427),logger_1[_0x13d405(0x1c4)][_0x13d405(0x1df)](_0x13d405(0x29a)+_0x4c1427);}};exports[a697_0x53c00b(0x1a4)]=wbotMessageListener;