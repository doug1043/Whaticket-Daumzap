'use strict';const a587_0x3068bf=a587_0x14bb;function a587_0xd750(){const _0x2037d4=['runExclusive','not','liveLocationMessage','__importDefault','viewOnceMessageV2','../TicketServices/FindOrCreateTicketService','quotedMsg','getUnpackedMessage','getBodyMessage','Mensagem\x20','displayCurrentMenu','-open','ASC','\x22\x20para\x20ticket\x20','/nopicture.png','\x20já\x20processada\x20para\x20o\x20ticket\x20','length','public','isInteger','\x20selecionada\x20no\x20submenu.\x20ID:\x20','complationMessage','captureException','Error\x20handling\x20message\x20ack.\x20Err:\x20','messageStubType','find','verifyQueue','apply','messages.update','create','CHATBOT_RESTRICT_NUMBER','update','charAt','queueOptionId','findOne','forwardQueueId','listResponseMessage','editedMessage','text','readMessages','Menu\x20principal\x20exibido.','*\x20-\x20','findByPk','E2E_IDENTITY_CHANGED','voiceMessage','useIntegration','createdAt','search','defineProperty','pending','contacts:','*#*\x20-\x20Voltar\x20Menu\x20Inicial','@g.us','isNaN','../TypebotServices/typebotListener','async-mutex','templateMessage','contact','../../models/QueueOption','companyId','message','queues','messages','transferMessage','reactionMessage','maxUseBotQueues','getIO','../../helpers/CheckSettings','locationMessage','audioMessage','5866245IyKJtl','862vXkynG','messageContextInfo','fromMe','ack','map','scheduleType','@s.whatsapp.net','ticket-','../../models/Queue','14624JwzOLT','lid','../TicketServices/UpdateTicketService','startsWith','isNil','Exibindo\x20menu\x20para\x20ticket\x20','logger','queue-','../../helpers/simpleObjectCache','getMessageMedia','extendedTextMessage','company-','__createBinding','env','buttonsMessage','company','typebotStatus','remoteJid','inActivity','Mensagem','ephemeralMessage','documentWithCaptionMessage','contactMessage','verifyEditedMessage','toDate','ticket','mediaPath','includes','FRONTEND_URL','GetCompanySetting','closed','verifyRecentCampaign','status','../../models/Whatsapp','Novo\x20Tipo\x20de\x20Mensagem\x20em\x20isValidMsg','amountUsedBotQueues','trim','./VerifyHandlers','.\x20Ignorando\x20em\x20handleChartbot.','title','Error\x20handling\x20wbot\x20message\x20listener.\x20Err:\x20','CIPHERTEXT','outOfHoursMessage','__setModuleDefault','endsWith','default','getContactMessage','status@broadcast','../../models/UserRating','Mutex','error','getOwnPropertyNames','980830jfcjEt','integrationId','option','../WhatsappService/ShowWhatsAppService','Estamos\x20fora\x20do\x20horário\x20de\x20expediente','typebotStatus:\x20','../../models/User','reload','../../models/Ticket','forwardQueue','-ticket','Tipo\x20de\x20integração\x20não\x20suportada.','chatbot','subject','\x0a*#*\x20-\x20Voltar\x20Menu\x20Inicial','Processando\x20mensagem:\x20\x22','E2E_DEVICE_CHANGED','__importStar','conversation','Opção\x20','groupMetadata','socketSessions','11sEpIEZ','cacheLayer','userId','stringify','../../helpers/Debounce','messages.upsert','2555406vMJpxe','count','forEach','DESC','constructor','\x20inválida\x20para\x20o\x20menu\x20principal.','open','sequelize','disableBot','stickerMessage','key','value','WAMessageStubType','emit','keepUserAndQueue','toLowerCase','profilePicUrl','ticketId','__esModule','setExtra','moment','90RphwCh','keys','debounce','greetingMessage','verifyMediaMessage','warn','queue','../QueueIntegrationServices/ShowQueueIntegrationService','protocolMessage','handleRating','queueId','verifyContact','imageMessage','findAll','delete','set','../../libs/cache','type','\x20selecionada\x20no\x20menu\x20principal.\x20ID:\x20','isFinite','get','(((.+)+)+)+$','Atendimento\x20finalizado','Resposta\x20inválida:\x20','parentId','\x20não\x20encontrada.','disabled','SimpleObjectCache','####\x20Nao\x20achou\x20o\x20type\x20em\x20isValidMsg:\x20','toString','1943jAGAOS','wbotMessageListener','whatsappId','writable',':unreads','../../models/Message','documentMessage','../CompanyService/VerifyCurrentSchedule','enabled','body','contactsArrayMessage','makeid','filter','options','prototype','522196ATQoVX','lastProcessedMessageId','destroy','remoteJidAlt','verifyDeleteMessage','viewOnceMessage','number',',\x20queueOptionId:\x20','path','../../models/Setting','outOfHoursAction','1991052rJzxVA','handleMessageIntegration','10XLTXTF','REVOKE','split','listMessage','log','isGroup'];a587_0xd750=function(){return _0x2037d4;};return a587_0xd750();}(function(_0xa5a734,_0x5786d9){const _0x5e9301=a587_0x14bb,_0x132478=_0xa5a734();while(!![]){try{const _0x3f763e=-parseInt(_0x5e9301(0x201))/0x1*(parseInt(_0x5e9301(0x175))/0x2)+parseInt(_0x5e9301(0x1ce))/0x3+parseInt(_0x5e9301(0x210))/0x4+-parseInt(_0x5e9301(0x21d))/0x5*(parseInt(_0x5e9301(0x21b))/0x6)+parseInt(_0x5e9301(0x174))/0x7+-parseInt(_0x5e9301(0x17e))/0x8*(-parseInt(_0x5e9301(0x1e3))/0x9)+parseInt(_0x5e9301(0x1b2))/0xa*(parseInt(_0x5e9301(0x1c8))/0xb);if(_0x3f763e===_0x5786d9)break;else _0x132478['push'](_0x132478['shift']());}catch(_0x3327fb){_0x132478['push'](_0x132478['shift']());}}}(a587_0xd750,0x6a5b0));var __createBinding=this&&this[a587_0x3068bf(0x18a)]||(Object[a587_0x3068bf(0x14b)]?function(_0x42fd02,_0x22df5a,_0x5832dc,_0x2509aa){const _0x292d03=a587_0x3068bf;if(_0x2509aa===undefined)_0x2509aa=_0x5832dc;var _0x1749c4=Object['getOwnPropertyDescriptor'](_0x22df5a,_0x5832dc);(!_0x1749c4||(_0x292d03(0x1f7)in _0x1749c4?!_0x22df5a[_0x292d03(0x1e0)]:_0x1749c4[_0x292d03(0x204)]||_0x1749c4['configurable']))&&(_0x1749c4={'enumerable':!![],'get':function(){return _0x22df5a[_0x5832dc];}}),Object[_0x292d03(0x15e)](_0x42fd02,_0x2509aa,_0x1749c4);}:function(_0x189acb,_0x196c69,_0x4ab8d0,_0x276d8a){if(_0x276d8a===undefined)_0x276d8a=_0x4ab8d0;_0x189acb[_0x276d8a]=_0x196c69[_0x4ab8d0];}),__setModuleDefault=this&&this[a587_0x3068bf(0x1a9)]||(Object['create']?function(_0x3988e6,_0x34563f){const _0x3391e0=a587_0x3068bf;Object[_0x3391e0(0x15e)](_0x3988e6,'default',{'enumerable':!![],'value':_0x34563f});}:function(_0x28c0ad,_0x29033f){const _0x5b8c62=a587_0x3068bf;_0x28c0ad[_0x5b8c62(0x1ab)]=_0x29033f;}),__importStar=this&&this[a587_0x3068bf(0x1c3)]||(function(){const _0x4ebaf5=(function(){let _0x2ddeee=!![];return function(_0x32c65c,_0x2e532b){const _0x5e3fa2=_0x2ddeee?function(){const _0x3bdb1e=a587_0x14bb;if(_0x2e532b){const _0x35d382=_0x2e532b[_0x3bdb1e(0x149)](_0x32c65c,arguments);return _0x2e532b=null,_0x35d382;}}:function(){};return _0x2ddeee=![],_0x5e3fa2;};}()),_0x12f61c=_0x4ebaf5(this,function(){const _0x460c05=a587_0x14bb;return _0x12f61c[_0x460c05(0x200)]()[_0x460c05(0x15d)](_0x460c05(0x1f8))[_0x460c05(0x200)]()[_0x460c05(0x1d2)](_0x12f61c)[_0x460c05(0x15d)](_0x460c05(0x1f8));});_0x12f61c();var _0x1b01fc=function(_0x53fa4f){const _0x28c006=a587_0x14bb;return _0x1b01fc=Object[_0x28c006(0x1b1)]||function(_0x40891b){const _0x117bed=_0x28c006;var _0x28f7a1=[];for(var _0x41ea92 in _0x40891b)if(Object[_0x117bed(0x20f)]['hasOwnProperty']['call'](_0x40891b,_0x41ea92))_0x28f7a1[_0x28f7a1['length']]=_0x41ea92;return _0x28f7a1;},_0x1b01fc(_0x53fa4f);};return function(_0xfc7bee){const _0x40a591=a587_0x14bb;if(_0xfc7bee&&_0xfc7bee[_0x40a591(0x1e0)])return _0xfc7bee;var _0xa3b78e={};if(_0xfc7bee!=null){for(var _0x2d5911=_0x1b01fc(_0xfc7bee),_0x7fc720=0x0;_0x7fc720<_0x2d5911[_0x40a591(0x233)];_0x7fc720++)if(_0x2d5911[_0x7fc720]!==_0x40a591(0x1ab))__createBinding(_0xa3b78e,_0xfc7bee,_0x2d5911[_0x7fc720]);}return __setModuleDefault(_0xa3b78e,_0xfc7bee),_0xa3b78e;};}()),__importDefault=this&&this[a587_0x3068bf(0x226)]||function(_0x3dbbf7){return _0x3dbbf7&&_0x3dbbf7['__esModule']?_0x3dbbf7:{'default':_0x3dbbf7};};Object['defineProperty'](exports,a587_0x3068bf(0x1e0),{'value':!![]}),exports['handleMessage']=exports[a587_0x3068bf(0x202)]=exports[a587_0x3068bf(0x21c)]=exports[a587_0x3068bf(0x22d)]=exports[a587_0x3068bf(0x1ec)]=void 0x0,exports[a587_0x3068bf(0x20c)]=makeid;const path_1=__importDefault(require(a587_0x3068bf(0x218))),Sentry=__importStar(require('@sentry/node')),lodash_1=require('lodash'),baileys_1=require('@whiskeysockets/baileys'),async_mutex_1=require(a587_0x3068bf(0x165)),sequelize_1=require(a587_0x3068bf(0x1d5)),moment_1=__importDefault(require(a587_0x3068bf(0x1e2))),Contact_1=__importDefault(require('../../models/Contact')),Ticket_1=__importDefault(require(a587_0x3068bf(0x1ba))),Message_1=__importDefault(require(a587_0x3068bf(0x206))),socket_1=require('../../libs/socket'),logger_1=require('../../utils/logger'),FindOrCreateTicketService_1=__importDefault(require(a587_0x3068bf(0x228))),ShowWhatsAppService_1=__importDefault(require(a587_0x3068bf(0x1b5))),UpdateTicketService_1=__importDefault(require(a587_0x3068bf(0x180))),Mustache_1=__importDefault(require('../../helpers/Mustache')),TicketTraking_1=__importDefault(require('../../models/TicketTraking')),UserRating_1=__importDefault(require(a587_0x3068bf(0x1ae))),SendWhatsAppMessage_1=__importDefault(require('./SendWhatsAppMessage')),Queue_1=__importDefault(require(a587_0x3068bf(0x17d))),QueueOption_1=__importDefault(require(a587_0x3068bf(0x168))),VerifyCurrentSchedule_1=__importDefault(require(a587_0x3068bf(0x208))),User_1=__importDefault(require(a587_0x3068bf(0x1b8))),Setting_1=__importDefault(require(a587_0x3068bf(0x219))),cache_1=require(a587_0x3068bf(0x1f3)),Debounce_1=require(a587_0x3068bf(0x1cc)),SendWhatsAppMedia_1=__importDefault(require('./SendWhatsAppMedia')),CheckSettings_1=require(a587_0x3068bf(0x171)),Whatsapp_1=__importDefault(require(a587_0x3068bf(0x19f))),simpleObjectCache_1=require(a587_0x3068bf(0x186)),ShowQueueIntegrationService_1=__importDefault(require(a587_0x3068bf(0x1ea))),typebotListener_1=__importDefault(require(a587_0x3068bf(0x164))),VerifyHandlers_1=require(a587_0x3068bf(0x1a3)),GetHandlers_1=require('./GetHandlers'),wbotMutex=new async_mutex_1[(a587_0x3068bf(0x1af))](),ackMutex=new async_mutex_1[(a587_0x3068bf(0x1af))](),groupContactCache=new simpleObjectCache_1[(a587_0x3068bf(0x1fe))](0x3e8*0x1e,logger_1[a587_0x3068bf(0x184)]),outOfHoursCache=new simpleObjectCache_1[(a587_0x3068bf(0x1fe))](0x3e8*0x3c*0x5,logger_1[a587_0x3068bf(0x184)]);function makeid(_0x523242){const _0x120d8e=a587_0x3068bf;let _0x55989e='';const _0x30f08c='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789',_0x19fdc7=_0x30f08c[_0x120d8e(0x233)];for(let _0x3eb7d9=0x0;_0x3eb7d9<_0x523242;_0x3eb7d9+=0x1){_0x55989e+=_0x30f08c[_0x120d8e(0x14e)](Math['floor'](Math['random']()*_0x19fdc7));}return _0x55989e;}const isValidMsg=_0x2d41e3=>{const _0x3ade7f=a587_0x3068bf;if(_0x2d41e3[_0x3ade7f(0x1d8)][_0x3ade7f(0x18f)]===_0x3ade7f(0x1ad))return![];try{const _0x512fcb=(0x0,GetHandlers_1['getTypeMessage'])(_0x2d41e3);if(!_0x512fcb)return![];const _0x497987=_0x512fcb===_0x3ade7f(0x1c4)||_0x512fcb==='editedMessage'||_0x512fcb===_0x3ade7f(0x188)||_0x512fcb===_0x3ade7f(0x173)||_0x512fcb==='videoMessage'||_0x512fcb===_0x3ade7f(0x1ef)||_0x512fcb===_0x3ade7f(0x207)||_0x512fcb===_0x3ade7f(0x193)||_0x512fcb===_0x3ade7f(0x1d7)||_0x512fcb==='buttonsResponseMessage'||_0x512fcb===_0x3ade7f(0x18c)||_0x512fcb===_0x3ade7f(0x176)||_0x512fcb===_0x3ade7f(0x172)||_0x512fcb===_0x3ade7f(0x225)||_0x512fcb===_0x3ade7f(0x194)||_0x512fcb===_0x3ade7f(0x15a)||_0x512fcb==='mediaMessage'||_0x512fcb===_0x3ade7f(0x20b)||_0x512fcb===_0x3ade7f(0x16e)||_0x512fcb===_0x3ade7f(0x192)||_0x512fcb===_0x3ade7f(0x1eb)||_0x512fcb===_0x3ade7f(0x152)||_0x512fcb===_0x3ade7f(0x220)||_0x512fcb===_0x3ade7f(0x166)||_0x512fcb===_0x3ade7f(0x215)||_0x512fcb===_0x3ade7f(0x227);return!_0x497987&&(logger_1[_0x3ade7f(0x184)][_0x3ade7f(0x1e8)](_0x3ade7f(0x1ff)+_0x512fcb+'\x0a'+JSON[_0x3ade7f(0x1cb)](_0x2d41e3?.[_0x3ade7f(0x16a)])),Sentry[_0x3ade7f(0x1e1)](_0x3ade7f(0x191),{'BodyMsg':_0x2d41e3[_0x3ade7f(0x16a)],'msg':_0x2d41e3,'msgType':_0x512fcb}),Sentry[_0x3ade7f(0x144)](new Error(_0x3ade7f(0x1a0)))),!!_0x497987;}catch(_0x314cc0){return Sentry[_0x3ade7f(0x1e1)]('Error\x20isValidMsg',{'msg':_0x2d41e3}),Sentry[_0x3ade7f(0x144)](_0x314cc0),![];}},handleRating=async(_0x23b0cd,_0xdbcc27,_0x361386)=>{const _0x4482b5=a587_0x3068bf,_0x383484=(0x0,socket_1[_0x4482b5(0x170)])();let _0x3d92af=null;(_0x23b0cd?.[_0x4482b5(0x16a)]?.[_0x4482b5(0x1c4)]||_0x23b0cd?.[_0x4482b5(0x16a)]?.[_0x4482b5(0x188)])&&(_0x3d92af=parseInt(_0x23b0cd['message']['conversation']||_0x23b0cd[_0x4482b5(0x16a)][_0x4482b5(0x188)][_0x4482b5(0x154)],0xa)||null);if(!Number[_0x4482b5(0x163)](_0x3d92af)&&Number[_0x4482b5(0x235)](_0x3d92af)&&!(0x0,lodash_1['isNull'])(_0x3d92af)){const _0x454f4b=await(0x0,ShowWhatsAppService_1[_0x4482b5(0x1ab)])(_0xdbcc27[_0x4482b5(0x203)],_0xdbcc27['companyId']);let _0x252405=_0x3d92af;_0x3d92af<0x1&&(_0x252405=0x1);_0x3d92af>0x5&&(_0x252405=0x5);await UserRating_1['default'][_0x4482b5(0x14b)]({'ticketId':_0x361386[_0x4482b5(0x1df)],'companyId':_0x361386[_0x4482b5(0x169)],'userId':_0x361386['userId'],'rate':_0x252405});const _0x33b424=_0x454f4b[_0x4482b5(0x143)][_0x4482b5(0x1a2)]()||_0x4482b5(0x1f9);await(0x0,SendWhatsAppMessage_1['default'])({'ticket':_0xdbcc27,'body':_0x33b424}),await _0x361386[_0x4482b5(0x14d)]({'finishedAt':(0x0,moment_1[_0x4482b5(0x1ab)])()[_0x4482b5(0x196)](),'rated':!![]});const _0x297f73=await(0x0,CheckSettings_1[_0x4482b5(0x19b)])(_0xdbcc27['companyId'],_0x4482b5(0x1dc),'enabled')===_0x4482b5(0x209);await _0xdbcc27[_0x4482b5(0x14d)]({'queueId':_0x297f73?_0xdbcc27['queueId']:null,'chatbot':null,'queueOptionId':null,'userId':_0x297f73?_0xdbcc27[_0x4482b5(0x1ca)]:null,'status':_0x4482b5(0x19c)}),_0x383484['to']('company-'+_0xdbcc27[_0x4482b5(0x169)]+_0x4482b5(0x22e))['to']('queue-'+_0xdbcc27[_0x4482b5(0x1ed)]+_0x4482b5(0x22e))[_0x4482b5(0x1db)](_0x4482b5(0x189)+_0xdbcc27[_0x4482b5(0x169)]+_0x4482b5(0x1bc),{'action':_0x4482b5(0x1f1),'ticket':_0xdbcc27,'ticketId':_0xdbcc27['id']}),_0x383484['to'](_0x4482b5(0x189)+_0xdbcc27[_0x4482b5(0x169)]+'-'+_0xdbcc27['status'])['to'](_0x4482b5(0x185)+_0xdbcc27[_0x4482b5(0x1ed)]+'-'+_0xdbcc27['status'])['to'](_0xdbcc27['id']['toString']())[_0x4482b5(0x1db)]('company-'+_0xdbcc27[_0x4482b5(0x169)]+_0x4482b5(0x1bc),{'action':_0x4482b5(0x14d),'ticket':_0xdbcc27,'ticketId':_0xdbcc27['id']});}};function a587_0x14bb(_0x1dda85,_0x520acc){const _0x2a61f4=a587_0xd750();return a587_0x14bb=function(_0x2ace18,_0x1dc8a9){_0x2ace18=_0x2ace18-0x142;let _0xd750b8=_0x2a61f4[_0x2ace18];return _0xd750b8;},a587_0x14bb(_0x1dda85,_0x520acc);}exports[a587_0x3068bf(0x1ec)]=handleRating;const handleChartbot=async(_0x127fbc,_0x499c08,_0x4f8a1d,_0x12cd5f=![])=>{const _0x15e351=a587_0x3068bf,_0x217cff=_0x499c08[_0x15e351(0x1d8)]['id'];if(_0x217cff&&_0x127fbc[_0x15e351(0x211)]===_0x217cff){console[_0x15e351(0x221)](_0x15e351(0x22c)+_0x217cff+_0x15e351(0x232)+_0x127fbc['id']+_0x15e351(0x1a4));return;}await _0x127fbc[_0x15e351(0x14d)]({'lastProcessedMessageId':_0x217cff});const _0x7f43e9=(0x0,GetHandlers_1[_0x15e351(0x22b)])(_0x499c08);console[_0x15e351(0x221)](_0x15e351(0x1c1)+_0x7f43e9+_0x15e351(0x230)+_0x127fbc['id']+_0x15e351(0x217)+_0x127fbc[_0x15e351(0x14f)]);const _0x4c5174=await Queue_1[_0x15e351(0x1ab)][_0x15e351(0x158)](_0x127fbc[_0x15e351(0x1ed)],{'include':[{'model':QueueOption_1['default'],'as':_0x15e351(0x20e),'where':{'parentId':null},'order':[[_0x15e351(0x1b4),_0x15e351(0x22f)]],'required':![]}]}),_0x58895a=await Whatsapp_1[_0x15e351(0x1ab)][_0x15e351(0x158)](_0x127fbc[_0x15e351(0x203)]);if(!_0x58895a){console[_0x15e351(0x1b0)]('Configurações\x20do\x20WhatsApp\x20não\x20encontradas.');return;}if(_0x7f43e9==='#'){await _0x127fbc[_0x15e351(0x14d)]({'queueOptionId':null,'chatbot':![],'queueId':null,'amountUsedBotQueues':0x0}),await(0x0,VerifyHandlers_1[_0x15e351(0x148)])(_0x4f8a1d,_0x499c08,_0x127fbc,_0x127fbc[_0x15e351(0x167)]);return;}if(!(0x0,lodash_1[_0x15e351(0x182)])(_0x4c5174)&&!(0x0,lodash_1[_0x15e351(0x182)])(_0x127fbc[_0x15e351(0x14f)])&&_0x7f43e9==='0'){const _0x196480=await QueueOption_1[_0x15e351(0x1ab)][_0x15e351(0x158)](_0x127fbc[_0x15e351(0x14f)]);_0x196480?.[_0x15e351(0x1fb)]?await _0x127fbc[_0x15e351(0x14d)]({'queueOptionId':_0x196480['parentId'],'amountUsedBotQueues':0x0}):await _0x127fbc[_0x15e351(0x14d)]({'queueOptionId':null,'amountUsedBotQueues':0x0});await _0x127fbc[_0x15e351(0x1b9)](),await(0x0,exports['displayCurrentMenu'])(_0x127fbc,_0x4f8a1d);return;}if(!_0x127fbc[_0x15e351(0x1be)]&&_0x127fbc[_0x15e351(0x1a1)]>=_0x58895a[_0x15e351(0x16f)])return;if(!(0x0,lodash_1[_0x15e351(0x182)])(_0x4c5174)&&(0x0,lodash_1[_0x15e351(0x182)])(_0x127fbc['queueOptionId'])&&!_0x12cd5f){if(_0x7f43e9&&_0x4c5174[_0x15e351(0x20e)]?.[_0x15e351(0x233)]>0x0){const _0x443819=_0x4c5174[_0x15e351(0x20e)][_0x15e351(0x147)](_0x882db4=>_0x882db4['option']===_0x7f43e9);if(_0x443819){console[_0x15e351(0x221)](_0x15e351(0x1c5)+_0x7f43e9+_0x15e351(0x1f5)+_0x443819['id']),await _0x127fbc[_0x15e351(0x14d)]({'queueOptionId':_0x443819['id'],'amountUsedBotQueues':0x0}),await _0x127fbc[_0x15e351(0x1b9)](),await(0x0,exports[_0x15e351(0x22d)])(_0x127fbc,_0x4f8a1d);return;}else console[_0x15e351(0x221)]('Opção\x20'+_0x7f43e9+_0x15e351(0x1d3));}}else{if(!(0x0,lodash_1[_0x15e351(0x182)])(_0x4c5174)&&!(0x0,lodash_1[_0x15e351(0x182)])(_0x127fbc[_0x15e351(0x14f)])){const _0x322385=await QueueOption_1[_0x15e351(0x1ab)][_0x15e351(0x1f0)]({'where':{'parentId':_0x127fbc[_0x15e351(0x14f)]},'order':[[_0x15e351(0x1b4),_0x15e351(0x22f)]]});if(_0x7f43e9&&_0x322385['length']>0x0){const _0x2ba469=_0x322385['find'](_0x3dfaad=>_0x3dfaad[_0x15e351(0x1b4)]===_0x7f43e9);if(_0x2ba469){console['log']('Opção\x20'+_0x7f43e9+_0x15e351(0x142)+_0x2ba469['id']),await _0x127fbc['update']({'queueOptionId':_0x2ba469['id'],'amountUsedBotQueues':0x0}),await _0x127fbc[_0x15e351(0x1b9)](),await(0x0,exports[_0x15e351(0x22d)])(_0x127fbc,_0x4f8a1d);return;}else console[_0x15e351(0x221)]('Opção\x20'+_0x7f43e9+'\x20inválida\x20para\x20o\x20submenu\x20atual.');}}}if(_0x7f43e9&&_0x7f43e9!=='0'&&_0x7f43e9!=='#'){console[_0x15e351(0x221)](_0x15e351(0x1fa)+_0x7f43e9);if(_0x58895a['maxUseBotQueues']&&_0x58895a[_0x15e351(0x16f)]!==0x0&&_0x127fbc[_0x15e351(0x1a1)]>=_0x58895a[_0x15e351(0x16f)]){await _0x127fbc[_0x15e351(0x14d)]({'chatbot':![],'amountUsedBotQueues':_0x58895a[_0x15e351(0x16f)]});_0x58895a[_0x15e351(0x16d)]&&await(0x0,SendWhatsAppMessage_1['default'])({'ticket':_0x127fbc,'body':_0x58895a[_0x15e351(0x16d)]});return;}await _0x127fbc[_0x15e351(0x14d)]({'amountUsedBotQueues':_0x127fbc[_0x15e351(0x1a1)]+0x1}),await _0x127fbc[_0x15e351(0x1b9)]();}!_0x12cd5f&&await(0x0,exports[_0x15e351(0x22d)])(_0x127fbc,_0x4f8a1d);},displayCurrentMenu=async(_0x27a4cc,_0x520e24)=>{const _0x42c897=a587_0x3068bf;console[_0x42c897(0x221)](_0x42c897(0x183)+_0x27a4cc['id']+',\x20queueOptionId:\x20'+_0x27a4cc['queueOptionId']);const _0x212bd0=await Queue_1['default'][_0x42c897(0x158)](_0x27a4cc['queueId']);if(!_0x212bd0)return;if((0x0,lodash_1[_0x42c897(0x182)])(_0x27a4cc[_0x42c897(0x14f)])){const _0xa4dabb=await QueueOption_1[_0x42c897(0x1ab)][_0x42c897(0x1f0)]({'where':{'queueId':_0x27a4cc[_0x42c897(0x1ed)],'parentId':null},'order':[[_0x42c897(0x1b4),'ASC']]});if(_0xa4dabb['length']>0x0){let _0x3e3cbf=_0x212bd0[_0x42c897(0x1e6)]?_0x212bd0[_0x42c897(0x1e6)]+'\x0a\x0a':'';_0xa4dabb['forEach'](_0x1bd09c=>{const _0x425360=_0x42c897;_0x3e3cbf+='*'+_0x1bd09c[_0x425360(0x1b4)]+_0x425360(0x157)+_0x1bd09c[_0x425360(0x1a5)]+'\x0a';}),_0x3e3cbf+=_0x42c897(0x1c0),await(0x0,SendWhatsAppMessage_1[_0x42c897(0x1ab)])({'ticket':_0x27a4cc,'body':_0x3e3cbf}),console[_0x42c897(0x221)](_0x42c897(0x156));}return;}const _0x130784=await QueueOption_1[_0x42c897(0x1ab)]['findByPk'](_0x27a4cc[_0x42c897(0x14f)],{'include':[{'model':Queue_1[_0x42c897(0x1ab)],'as':_0x42c897(0x1bb)}]});if(!_0x130784){console[_0x42c897(0x221)](_0x42c897(0x1c5)+_0x27a4cc[_0x42c897(0x14f)]+_0x42c897(0x1fc));return;}const _0x2e8d04=await QueueOption_1['default'][_0x42c897(0x1f0)]({'where':{'parentId':_0x27a4cc[_0x42c897(0x14f)]},'order':[[_0x42c897(0x1b4),_0x42c897(0x22f)]]});if(_0x2e8d04[_0x42c897(0x233)]===0x0){console[_0x42c897(0x221)]('Nó\x20final\x20encontrado.\x20Exibindo\x20mensagem\x20final.');let _0x551f87=(0x0,Mustache_1['default'])('‎'+_0x130784[_0x42c897(0x16a)],_0x27a4cc);if(_0x130784?.[_0x42c897(0x198)]){const _0x46ad55=path_1['default']['resolve'](_0x42c897(0x234),_0x130784[_0x42c897(0x198)]);_0x46ad55?await(0x0,SendWhatsAppMedia_1['default'])({'media':_0x46ad55,'ticket':_0x27a4cc,'body':_0x551f87}):await(0x0,SendWhatsAppMessage_1['default'])({'ticket':_0x27a4cc,'body':_0x551f87});}else await(0x0,SendWhatsAppMessage_1[_0x42c897(0x1ab)])({'ticket':_0x27a4cc,'body':_0x551f87});if(_0x130784['exitChatbot'])await _0x27a4cc['update']({'queueOptionId':null,'chatbot':![],'amountUsedBotQueues':0x0});else{if(_0x130784[_0x42c897(0x151)]){await _0x27a4cc[_0x42c897(0x14d)]({'queueOptionId':null,'chatbot':![],'queueId':_0x130784[_0x42c897(0x151)],'amountUsedBotQueues':0x0}),await _0x27a4cc['reload']();if(_0x130784[_0x42c897(0x1bb)]){const _0x4943ed=await QueueOption_1['default']['findOne']({'where':{'queueId':_0x130784['forwardQueueId'],'parentId':null}});await _0x27a4cc['update']({'chatbot':!!_0x4943ed}),_0x130784[_0x42c897(0x1bb)][_0x42c897(0x1e6)]&&await(0x0,SendWhatsAppMessage_1['default'])({'ticket':_0x27a4cc,'body':_0x130784[_0x42c897(0x1bb)][_0x42c897(0x1e6)]}),_0x4943ed&&await(0x0,exports[_0x42c897(0x22d)])(_0x27a4cc,_0x520e24);}}else await _0x27a4cc['update']({'queueOptionId':null,'chatbot':![]});}return;}console[_0x42c897(0x221)]('Submenu\x20encontrado\x20com\x20'+_0x2e8d04[_0x42c897(0x233)]+'\x20opções.\x20Exibindo\x20submenu.');let _0x3ba860=_0x130784[_0x42c897(0x16a)]?_0x130784['message']+'\x0a\x0a':'';_0x2e8d04[_0x42c897(0x1d0)](_0x4cad8b=>{const _0x558c4a=_0x42c897;_0x3ba860+='*'+_0x4cad8b['option']+_0x558c4a(0x157)+_0x4cad8b[_0x558c4a(0x1a5)]+'\x0a';}),_0x3ba860+='\x0a*0*\x20-\x20Voltar\x20ao\x20menu\x20anterior\x0a',_0x3ba860+=_0x42c897(0x161);if(_0x130784?.['mediaPath']){const _0x5eea58=path_1[_0x42c897(0x1ab)]['resolve'](_0x42c897(0x234),_0x130784[_0x42c897(0x198)]);_0x5eea58?await(0x0,SendWhatsAppMedia_1[_0x42c897(0x1ab)])({'media':_0x5eea58,'ticket':_0x27a4cc,'body':_0x3ba860}):await(0x0,SendWhatsAppMessage_1['default'])({'ticket':_0x27a4cc,'body':_0x3ba860});}else await(0x0,SendWhatsAppMessage_1[_0x42c897(0x1ab)])({'ticket':_0x27a4cc,'body':_0x3ba860});};exports[a587_0x3068bf(0x22d)]=displayCurrentMenu;const handleMessageIntegration=async(_0x18f268,_0x27682d,_0x223e94,_0x7d25e)=>{const _0x22f639=a587_0x3068bf;if(process[_0x22f639(0x18b)][_0x22f639(0x14c)]){if(_0x7d25e[_0x22f639(0x167)][_0x22f639(0x216)]!=process[_0x22f639(0x18b)][_0x22f639(0x14c)]){console['log']('chatbot\x20desativado!');return;}}console['log'](_0x22f639(0x1b7),_0x7d25e[_0x22f639(0x18e)]),_0x223e94[_0x22f639(0x1f4)]==='typebot'&&!_0x7d25e[_0x22f639(0x18e)]?(await(0x0,typebotListener_1['default'])({'ticket':_0x7d25e,'msg':_0x18f268,'wbot':_0x27682d,'typebot':_0x223e94}),!_0x7d25e[_0x22f639(0x15b)]&&(await _0x7d25e[_0x22f639(0x14d)]({'useIntegration':!![],'integrationId':_0x223e94['id']}),console[_0x22f639(0x221)]('Atualizando\x20estado\x20de\x20integração\x20do\x20ticket\x20#'+_0x7d25e['id']))):console[_0x22f639(0x221)](_0x22f639(0x1bd));};exports[a587_0x3068bf(0x21c)]=handleMessageIntegration;const handleMessage=async(_0x5247aa,_0x2c6f5f,_0x69b5a)=>{const _0x5e09ce=a587_0x3068bf;if(!isValidMsg(_0x5247aa))return;_0x5247aa[_0x5e09ce(0x16a)]?.[_0x5e09ce(0x192)]&&(_0x5247aa[_0x5e09ce(0x16a)]=_0x5247aa[_0x5e09ce(0x16a)]['ephemeralMessage'][_0x5e09ce(0x16a)]);try{let _0x810f9c,_0x2bcf2c;const _0xe4e213=_0x5247aa[_0x5e09ce(0x1d8)][_0x5e09ce(0x18f)]?.[_0x5e09ce(0x1aa)](_0x5e09ce(0x162));if(_0xe4e213){const _0x16bac5=await Setting_1[_0x5e09ce(0x1ab)][_0x5e09ce(0x150)]({'where':{'companyId':_0x69b5a,'key':'CheckMsgIsGroup'}});if(!_0x16bac5||_0x16bac5[_0x5e09ce(0x1d9)]==='enabled')return;}const _0x12e624=(0x0,GetHandlers_1[_0x5e09ce(0x22b)])(_0x5247aa),_0x39292d=(0x0,GetHandlers_1['getTypeMessage'])(_0x5247aa),_0x1381e7=_0x39292d!==_0x5e09ce(0x166)&&(0x0,GetHandlers_1[_0x5e09ce(0x22a)])(_0x5247aa),_0x48b6=_0x1381e7&&(0x0,GetHandlers_1[_0x5e09ce(0x187)])(_0x1381e7);if(_0x5247aa['key'][_0x5e09ce(0x177)]){if(_0x12e624?.[_0x5e09ce(0x181)]('‎'))return;if(!_0x48b6&&_0x39292d!=='conversation'&&_0x39292d!=='extendedTextMessage'&&_0x39292d!=='vcard')return;_0x810f9c=await(0x0,GetHandlers_1[_0x5e09ce(0x1ac)])(_0x5247aa,_0x2c6f5f);}else _0x810f9c=await(0x0,GetHandlers_1[_0x5e09ce(0x1ac)])(_0x5247aa,_0x2c6f5f);_0xe4e213&&(_0x2bcf2c=await wbotMutex[_0x5e09ce(0x223)](async()=>{const _0xfe8d7c=_0x5e09ce;let _0x8a1ab0=groupContactCache[_0xfe8d7c(0x1f7)](_0x5247aa[_0xfe8d7c(0x1d8)][_0xfe8d7c(0x18f)]);if(!_0x8a1ab0){const _0x3b5376=await _0x2c6f5f[_0xfe8d7c(0x1c6)](_0x5247aa[_0xfe8d7c(0x1d8)][_0xfe8d7c(0x18f)]),_0x5dbb72={'id':_0x3b5376['id'],'name':_0x3b5376[_0xfe8d7c(0x1bf)]};_0x8a1ab0=await(0x0,VerifyHandlers_1[_0xfe8d7c(0x1ee)])(_0x5dbb72,_0x2c6f5f,_0x69b5a),groupContactCache[_0xfe8d7c(0x1f2)](_0x5247aa[_0xfe8d7c(0x1d8)]['remoteJid'],_0x8a1ab0);}return _0x8a1ab0;}));const _0x5c82cd=await(0x0,ShowWhatsAppService_1[_0x5e09ce(0x1ab)])(_0x2c6f5f['id'],_0x69b5a),_0x1a6011=await(0x0,VerifyHandlers_1['verifyContact'])(_0x810f9c,_0x2c6f5f,_0x69b5a);let _0x30203d=_0x1a6011;if(!_0x5247aa['key'][_0x5e09ce(0x177)]){const _0x5362b4=_0x5247aa[_0x5e09ce(0x1d8)],_0x53c1bc=_0x5247aa[_0x5e09ce(0x1d8)][_0x5e09ce(0x18f)],_0x143378=_0x5362b4[_0x5e09ce(0x213)];let _0x5d36a5=null,_0x46e62b=![];if(_0x53c1bc?.[_0x5e09ce(0x199)](_0x5e09ce(0x17b)))_0x5d36a5=_0x53c1bc,_0x46e62b=_0x1a6011['number'][_0x5e09ce(0x233)]>0xd;else _0x53c1bc?.['includes']('@lid')&&_0x143378?.[_0x5e09ce(0x199)](_0x5e09ce(0x17b))&&(_0x5d36a5=_0x143378,_0x46e62b=!![]);if(_0x5d36a5&&_0x46e62b){const _0x1f897e=_0x5d36a5['split']('@')[0x0],_0x2b12c4=await Contact_1[_0x5e09ce(0x1ab)][_0x5e09ce(0x150)]({'where':{'number':_0x1f897e,'companyId':_0x1a6011[_0x5e09ce(0x169)]}});if(_0x2b12c4&&_0x2b12c4['id']!==_0x1a6011['id']){_0x30203d=_0x2b12c4;const _0x573a78=_0x53c1bc?.[_0x5e09ce(0x199)]('@lid')?_0x53c1bc:_0x143378,_0x5938a8=_0x573a78?.[_0x5e09ce(0x21f)]('@')[0x0],_0x4b6217={};_0x5938a8&&!_0x2b12c4[_0x5e09ce(0x17f)]&&(_0x4b6217['lid']=_0x5938a8);_0x5d36a5&&!_0x2b12c4[_0x5e09ce(0x18f)]&&(_0x4b6217['remoteJid']=_0x5d36a5);const _0x259115=!_0x2b12c4[_0x5e09ce(0x1de)]||_0x2b12c4[_0x5e09ce(0x1de)]===''||_0x2b12c4[_0x5e09ce(0x1de)]===process[_0x5e09ce(0x18b)][_0x5e09ce(0x19a)]+_0x5e09ce(0x231);_0x259115&&_0x1a6011[_0x5e09ce(0x1de)]&&_0x1a6011['profilePicUrl']!==process[_0x5e09ce(0x18b)][_0x5e09ce(0x19a)]+_0x5e09ce(0x231)&&(_0x4b6217[_0x5e09ce(0x1de)]=_0x1a6011['profilePicUrl']);Object[_0x5e09ce(0x1e4)](_0x4b6217)[_0x5e09ce(0x233)]>0x0&&await _0x2b12c4[_0x5e09ce(0x14d)](_0x4b6217);const _0x2d3007=await Ticket_1[_0x5e09ce(0x1ab)][_0x5e09ce(0x1cf)]({'where':{'contactId':_0x1a6011['id']}});_0x2d3007===0x0&&await _0x1a6011[_0x5e09ce(0x212)]();}else!_0x2b12c4&&(await _0x1a6011[_0x5e09ce(0x14d)]({'number':_0x1f897e,'remoteJid':_0x5d36a5}),_0x30203d=_0x1a6011);}}let _0x4f2ce0=0x0;if(_0x5247aa[_0x5e09ce(0x1d8)][_0x5e09ce(0x177)])await cache_1[_0x5e09ce(0x1c9)][_0x5e09ce(0x1f2)]('contacts:'+_0x30203d['id']+':unreads','0');else{const _0x4711d6=await cache_1[_0x5e09ce(0x1c9)][_0x5e09ce(0x1f7)](_0x5e09ce(0x160)+_0x30203d['id']+_0x5e09ce(0x205));_0x4f2ce0=+_0x4711d6+0x1,await cache_1[_0x5e09ce(0x1c9)][_0x5e09ce(0x1f2)](_0x5e09ce(0x160)+_0x30203d['id']+':unreads',''+_0x4f2ce0);}const _0x4c6fce=await Message_1[_0x5e09ce(0x1ab)]['findOne']({'where':{'contactId':_0x30203d['id'],'companyId':_0x69b5a,'$ticket.whatsappId$':_0x5c82cd['id']},'include':[_0x5e09ce(0x197)],'order':[[_0x5e09ce(0x15c),'DESC']]}),_0x4036e9=_0x5c82cd[_0x5e09ce(0x143)][_0x5e09ce(0x1a2)]()||_0x5e09ce(0x1f9);if(_0x4c6fce&&_0x4f2ce0===0x0&&_0x4036e9&&(0x0,Mustache_1[_0x5e09ce(0x1ab)])(_0x4036e9,_0x4c6fce[_0x5e09ce(0x197)])[_0x5e09ce(0x1a2)]()[_0x5e09ce(0x1dd)]()===_0x4c6fce?.[_0x5e09ce(0x20a)][_0x5e09ce(0x1a2)]()[_0x5e09ce(0x1dd)]())return;if(!_0x5247aa['key']['fromMe']&&!_0x30203d[_0x5e09ce(0x222)]){if(_0x5c82cd['useRating']){const _0x1e67e2=await TicketTraking_1[_0x5e09ce(0x1ab)][_0x5e09ce(0x150)]({'where':{'whatsappId':_0x5c82cd['id'],'rated':![],'ratingAt':{[sequelize_1['Op'][_0x5e09ce(0x224)]]:null},'finishedAt':null},'include':[{'model':Ticket_1[_0x5e09ce(0x1ab)],'where':{'status':_0x5e09ce(0x1d4),'contactId':_0x30203d['id']},'include':[{'model':Contact_1[_0x5e09ce(0x1ab)]},{'model':User_1[_0x5e09ce(0x1ab)]},{'model':Queue_1[_0x5e09ce(0x1ab)]}]}]});if(_0x1e67e2)try{const _0x446ee0=Number(_0x12e624);if(!Number[_0x5e09ce(0x1f6)](_0x446ee0)){const _0xa0d350=(0x0,Debounce_1[_0x5e09ce(0x1e5)])(async()=>{const _0x4ac208=_0x5e09ce,_0x353b8f=_0x5c82cd['ratingMessage']?.[_0x4ac208(0x1a2)]()||'Por\x20favor\x20avalie\x20nosso\x20atendimento';await(0x0,SendWhatsAppMessage_1['default'])({'ticket':_0x317abc,'body':'\x0a*'+_0x353b8f+'*'});},0x3e8,_0x1e67e2[_0x5e09ce(0x197)]['id']);_0xa0d350();return;}if((0x0,VerifyHandlers_1['verifyRating'])(_0x1e67e2)){(0x0,exports['handleRating'])(_0x5247aa,_0x1e67e2[_0x5e09ce(0x197)],_0x1e67e2);return;}}catch(_0x18ed18){Sentry['captureException'](_0x18ed18),console[_0x5e09ce(0x221)]('Erro\x20ao\x20processar\x20avaliação:',_0x18ed18);}}}const {ticket:_0x317abc,justCreated:_0x119a39}=await(0x0,FindOrCreateTicketService_1[_0x5e09ce(0x1ab)])(_0x30203d,_0x2c6f5f['id'],_0x4f2ce0,_0x69b5a,_0x2bcf2c);if(_0x48b6||_0x5247aa?.['message']?.[_0x5e09ce(0x188)]?.['thumbnailDirectPath'])await(0x0,VerifyHandlers_1[_0x5e09ce(0x1e7)])(_0x5247aa,_0x317abc,_0x30203d,_0x2c6f5f,_0x48b6);else{if(_0x5247aa[_0x5e09ce(0x16a)]?.[_0x5e09ce(0x153)]?.[_0x5e09ce(0x16a)]?.[_0x5e09ce(0x1eb)]?.['editedMessage'])await(0x0,VerifyHandlers_1[_0x5e09ce(0x195)])(_0x5247aa[_0x5e09ce(0x16a)][_0x5e09ce(0x153)][_0x5e09ce(0x16a)][_0x5e09ce(0x1eb)]['editedMessage'],_0x317abc,_0x5247aa[_0x5e09ce(0x16a)][_0x5e09ce(0x153)]['message'][_0x5e09ce(0x1eb)]['key']['id']);else{if(_0x5247aa[_0x5e09ce(0x16a)]?.['protocolMessage']?.[_0x5e09ce(0x153)])await(0x0,VerifyHandlers_1[_0x5e09ce(0x195)])(_0x5247aa[_0x5e09ce(0x16a)][_0x5e09ce(0x1eb)][_0x5e09ce(0x153)],_0x317abc,_0x5247aa[_0x5e09ce(0x16a)][_0x5e09ce(0x1eb)][_0x5e09ce(0x1d8)]['id']);else _0x5247aa[_0x5e09ce(0x16a)]?.[_0x5e09ce(0x1eb)]?.[_0x5e09ce(0x1f4)]===0x0?await(0x0,VerifyHandlers_1[_0x5e09ce(0x214)])(_0x5247aa[_0x5e09ce(0x16a)][_0x5e09ce(0x1eb)],_0x317abc):await(0x0,VerifyHandlers_1['verifyMessage'])(_0x5247aa,_0x317abc,_0x30203d,null,_0x2c6f5f);}}if(_0x317abc[_0x5e09ce(0x15b)]===!![]&&_0x317abc[_0x5e09ce(0x1b3)]){const _0x394f2d=await(0x0,ShowQueueIntegrationService_1[_0x5e09ce(0x1ab)])(_0x317abc[_0x5e09ce(0x1b3)],_0x69b5a);if(_0x394f2d){await(0x0,exports['handleMessageIntegration'])(_0x5247aa,_0x2c6f5f,_0x394f2d,_0x317abc);return;}else await _0x317abc[_0x5e09ce(0x14d)]({'useIntegration':![],'integrationId':null,'typebotSessionId':null});}if(_0x12e624==='#'&&!_0xe4e213){await _0x317abc[_0x5e09ce(0x14d)]({'queueOptionId':null,'chatbot':![],'queueId':null}),await(0x0,VerifyHandlers_1[_0x5e09ce(0x148)])(_0x2c6f5f,_0x5247aa,_0x317abc,_0x317abc['contact']);return;}if(_0xe4e213||_0x30203d[_0x5e09ce(0x1d6)])return;const _0x4001e3=await(0x0,CheckSettings_1[_0x5e09ce(0x19b)])(_0x69b5a,_0x5e09ce(0x17a),_0x5e09ce(0x1fd));try{if(!_0x5247aa[_0x5e09ce(0x1d8)]['fromMe']&&_0x4001e3){const _0x27bea1=await(0x0,CheckSettings_1[_0x5e09ce(0x19b)])(_0x69b5a,_0x5e09ce(0x21a),_0x5e09ce(0x15f));let _0x4f9145=null;const _0xc24188=_0x317abc['status']===_0x5e09ce(0x1d4)&&_0x317abc['user'][_0x5e09ce(0x1c7)][_0x5e09ce(0x233)]>0x0,_0x533206=!_0xc24188&&outOfHoursCache['get'](_0x5e09ce(0x17c)+_0x317abc['id']);if(_0x4001e3===_0x5e09ce(0x18d)&&!_0xc24188){_0x4f9145=await(0x0,VerifyCurrentSchedule_1[_0x5e09ce(0x1ab)])(_0x69b5a),console['log']('Resultado\x20da\x20verificação\x20de\x20horário:',{'currentSchedule':_0x4f9145,'isInActivity':_0x4f9145?.[_0x5e09ce(0x190)]});if(_0x4f9145&&_0x4f9145[_0x5e09ce(0x190)]===![]){if(!_0x533206){outOfHoursCache[_0x5e09ce(0x1f2)](_0x5e09ce(0x17c)+_0x317abc['id'],!![]);const _0x5be590=_0x5c82cd[_0x5e09ce(0x1a8)]['trim']()||_0x5e09ce(0x1b6);await(0x0,SendWhatsAppMessage_1[_0x5e09ce(0x1ab)])({'ticket':_0x317abc,'body':_0x5be590});}_0x317abc[_0x5e09ce(0x19e)]!==_0x5e09ce(0x1d4)&&await(0x0,UpdateTicketService_1[_0x5e09ce(0x1ab)])({'ticketData':{'chatbot':![],'status':_0x27bea1},'ticketId':_0x317abc['id'],'companyId':_0x317abc[_0x5e09ce(0x169)]});return;}}if(_0x4001e3===_0x5e09ce(0x1e9)&&_0x317abc[_0x5e09ce(0x1ed)]!==null&&!_0xc24188){_0x4f9145=await(0x0,VerifyCurrentSchedule_1['default'])(_0x69b5a,_0x317abc[_0x5e09ce(0x1ed)]);const _0x22b425=await Queue_1[_0x5e09ce(0x1ab)][_0x5e09ce(0x158)](_0x317abc[_0x5e09ce(0x1ed)]);if(!(0x0,lodash_1['isNil'])(_0x4f9145)&&(!_0x4f9145||_0x4f9145['inActivity']===![])){if(!_0x533206){outOfHoursCache[_0x5e09ce(0x1f2)](_0x5e09ce(0x17c)+_0x317abc['id'],!![]);const _0x31e0fe=_0x22b425['outOfHoursMessage']?.['trim']()||'Estamos\x20fora\x20do\x20horário\x20de\x20expediente';await(0x0,SendWhatsAppMessage_1[_0x5e09ce(0x1ab)])({'ticket':_0x317abc,'body':_0x31e0fe});}_0x317abc[_0x5e09ce(0x19e)]!==_0x5e09ce(0x1d4)&&await(0x0,UpdateTicketService_1[_0x5e09ce(0x1ab)])({'ticketData':{'chatbot':![],'status':_0x27bea1},'ticketId':_0x317abc['id'],'companyId':_0x317abc[_0x5e09ce(0x169)]});return;}}}}catch(_0xc6800f){Sentry[_0x5e09ce(0x144)](_0xc6800f),console[_0x5e09ce(0x221)]('Erro\x20ao\x20verificar\x20horário\x20de\x20atendimento:',_0xc6800f);}!_0x317abc['queue']&&!_0xe4e213&&!_0x5247aa[_0x5e09ce(0x1d8)][_0x5e09ce(0x177)]&&!_0x317abc[_0x5e09ce(0x1ca)]&&_0x5c82cd[_0x5e09ce(0x16b)]['length']>=0x1&&await(0x0,VerifyHandlers_1['verifyQueue'])(_0x2c6f5f,_0x5247aa,_0x317abc,_0x317abc[_0x5e09ce(0x167)]);const _0x4e0413=_0x317abc[_0x5e09ce(0x1e9)]===null;await _0x317abc[_0x5e09ce(0x1b9)]();if(_0x119a39&&!_0x5c82cd?.[_0x5e09ce(0x16b)]?.[_0x5e09ce(0x233)]&&!_0x317abc['userId']&&!_0xe4e213&&!_0x5247aa[_0x5e09ce(0x1d8)]['fromMe']){const _0x57f833=await Message_1[_0x5e09ce(0x1ab)]['findOne']({'where':{'ticketId':_0x317abc['id'],'fromMe':!![]},'order':[[_0x5e09ce(0x15c),_0x5e09ce(0x1d1)]]});if(_0x57f833&&_0x57f833['body'][_0x5e09ce(0x199)](_0x5c82cd[_0x5e09ce(0x1e6)]))return;if(_0x5c82cd[_0x5e09ce(0x1e6)]){const _0x595937=(0x0,Debounce_1['debounce'])(async()=>{const _0x360a53=_0x5e09ce;await(0x0,SendWhatsAppMessage_1[_0x360a53(0x1ab)])({'ticket':_0x317abc,'body':''+_0x5c82cd['greetingMessage']});},0x3e8,_0x317abc['id']);_0x595937();return;}}if(!_0x317abc[_0x5e09ce(0x1be)]&&_0x317abc[_0x5e09ce(0x1a1)]>=_0x5c82cd?.[_0x5e09ce(0x16f)])return;if(_0x317abc[_0x5e09ce(0x1be)]&&!_0x5247aa[_0x5e09ce(0x1d8)]['fromMe']){await handleChartbot(_0x317abc,_0x5247aa,_0x2c6f5f);return;}_0x5c82cd[_0x5e09ce(0x16b)][_0x5e09ce(0x233)]===0x1&&_0x317abc[_0x5e09ce(0x1e9)]&&(_0x317abc[_0x5e09ce(0x1be)]&&!_0x5247aa[_0x5e09ce(0x1d8)][_0x5e09ce(0x177)]&&!_0x317abc[_0x5e09ce(0x15b)]&&await handleChartbot(_0x317abc,_0x5247aa,_0x2c6f5f,_0x4e0413)),_0x5c82cd[_0x5e09ce(0x16b)][_0x5e09ce(0x233)]>0x1&&_0x317abc[_0x5e09ce(0x1e9)]&&(_0x317abc[_0x5e09ce(0x1be)]&&!_0x5247aa[_0x5e09ce(0x1d8)][_0x5e09ce(0x177)]&&!_0x317abc[_0x5e09ce(0x15b)]&&await handleChartbot(_0x317abc,_0x5247aa,_0x2c6f5f,_0x4e0413));}catch(_0x374116){console[_0x5e09ce(0x221)]('Erro\x20ao\x20processar\x20mensagem\x20do\x20WhatsApp:',_0x374116),Sentry['captureException'](_0x374116),logger_1['logger'][_0x5e09ce(0x1b0)]('Error\x20handling\x20whatsapp\x20message:\x20Err:\x20'+_0x374116);}};exports['handleMessage']=handleMessage;const handleMsgAck=async(_0xc68e2c,_0x481741)=>{const _0x171757=a587_0x3068bf;if(!_0x481741)return;const _0x2602a6=(0x0,socket_1[_0x171757(0x170)])();try{const _0x16b681=await Message_1[_0x171757(0x1ab)]['findByPk'](_0xc68e2c['key']['id'],{'include':[_0x171757(0x167),{'model':Message_1[_0x171757(0x1ab)],'as':_0x171757(0x229),'include':[_0x171757(0x167)]}]});if(!_0x16b681||_0x481741<=_0x16b681[_0x171757(0x178)])return;await _0x16b681[_0x171757(0x14d)]({'ack':_0x481741}),_0x2602a6['to'](_0x16b681[_0x171757(0x1df)][_0x171757(0x200)]())[_0x171757(0x1db)](_0x171757(0x189)+_0x16b681[_0x171757(0x169)]+'-appMessage',{'action':_0x171757(0x14d),'message':_0x16b681});}catch(_0xb2d2c5){Sentry[_0x171757(0x144)](_0xb2d2c5),logger_1[_0x171757(0x184)][_0x171757(0x1b0)](_0x171757(0x145)+_0xb2d2c5);}},filterMessages=_0x5996a4=>{const _0x576ddb=a587_0x3068bf;if(_0x5996a4[_0x576ddb(0x16a)]?.['protocolMessage']?.[_0x576ddb(0x153)])return!![];if(_0x5996a4['message']?.[_0x576ddb(0x1eb)]?.[_0x576ddb(0x1f4)]===0x0)return!![];if(_0x5996a4[_0x576ddb(0x16a)]?.[_0x576ddb(0x1eb)])return![];if([baileys_1[_0x576ddb(0x1da)][_0x576ddb(0x21e)],baileys_1[_0x576ddb(0x1da)][_0x576ddb(0x1c2)],baileys_1['WAMessageStubType'][_0x576ddb(0x159)],baileys_1[_0x576ddb(0x1da)][_0x576ddb(0x1a7)]][_0x576ddb(0x199)](_0x5996a4[_0x576ddb(0x146)]))return![];return!![];},wbotMessageListener=async(_0x37627a,_0x5cc818)=>{const _0x37308a=a587_0x3068bf;try{_0x37627a['ev']['on'](_0x37308a(0x1cd),async _0x7f68bf=>{const _0xcd00e6=_0x37308a,_0x45c9b0=_0x7f68bf[_0xcd00e6(0x16c)][_0xcd00e6(0x20d)](filterMessages)[_0xcd00e6(0x179)](_0x7fb57f=>_0x7fb57f);if(!_0x45c9b0)return;_0x45c9b0[_0xcd00e6(0x1d0)](async _0x3dde09=>{const _0x57c2f3=_0xcd00e6,_0x50590c=await Message_1['default'][_0x57c2f3(0x1cf)]({'where':{'id':_0x3dde09[_0x57c2f3(0x1d8)]['id'],'companyId':_0x5cc818}});if(!_0x50590c){if(await(0x0,VerifyHandlers_1[_0x57c2f3(0x19d)])(_0x3dde09,_0x5cc818))return;await handleMessage(_0x3dde09,_0x37627a,_0x5cc818);}});}),_0x37627a['ev']['on'](_0x37308a(0x14a),_0x113a74=>{const _0x26535d=_0x37308a;if(_0x113a74[_0x26535d(0x233)]===0x0)return;_0x113a74[_0x26535d(0x1d0)](async _0x2e64c2=>{const _0x5dcca3=_0x26535d;_0x37627a[_0x5dcca3(0x155)]([_0x2e64c2['key']]),await ackMutex[_0x5dcca3(0x223)](async()=>{const _0x309489=_0x5dcca3;handleMsgAck(_0x2e64c2,_0x2e64c2[_0x309489(0x14d)]['status']);});});});}catch(_0x1ef130){Sentry[_0x37308a(0x144)](_0x1ef130),logger_1[_0x37308a(0x184)]['error'](_0x37308a(0x1a6)+_0x1ef130);}};exports['wbotMessageListener']=wbotMessageListener;