'use strict';const a582_0x4659a2=a582_0x5be5;(function(_0x1d795f,_0x576b71){const _0x1f1c09=a582_0x5be5,_0x44cc74=_0x1d795f();while(!![]){try{const _0x651904=-parseInt(_0x1f1c09(0x1ed))/0x1*(-parseInt(_0x1f1c09(0x241))/0x2)+-parseInt(_0x1f1c09(0x265))/0x3*(parseInt(_0x1f1c09(0x1f3))/0x4)+parseInt(_0x1f1c09(0x209))/0x5+parseInt(_0x1f1c09(0x276))/0x6+parseInt(_0x1f1c09(0x28f))/0x7+-parseInt(_0x1f1c09(0x21a))/0x8*(-parseInt(_0x1f1c09(0x26c))/0x9)+-parseInt(_0x1f1c09(0x27b))/0xa;if(_0x651904===_0x576b71)break;else _0x44cc74['push'](_0x44cc74['shift']());}catch(_0x5606cb){_0x44cc74['push'](_0x44cc74['shift']());}}}(a582_0x2486,0x38c5a));var __createBinding=this&&this[a582_0x4659a2(0x25c)]||(Object[a582_0x4659a2(0x24f)]?function(_0x5f4609,_0x27d636,_0x170fe7,_0x371802){const _0x2e6f89=a582_0x4659a2;if(_0x371802===undefined)_0x371802=_0x170fe7;var _0x2a7783=Object[_0x2e6f89(0x26a)](_0x27d636,_0x170fe7);(!_0x2a7783||(_0x2e6f89(0x1dd)in _0x2a7783?!_0x27d636[_0x2e6f89(0x23c)]:_0x2a7783[_0x2e6f89(0x1e9)]||_0x2a7783[_0x2e6f89(0x1fd)]))&&(_0x2a7783={'enumerable':!![],'get':function(){return _0x27d636[_0x170fe7];}}),Object[_0x2e6f89(0x245)](_0x5f4609,_0x371802,_0x2a7783);}:function(_0x2797b4,_0x539df5,_0x3560e0,_0x164cdc){if(_0x164cdc===undefined)_0x164cdc=_0x3560e0;_0x2797b4[_0x164cdc]=_0x539df5[_0x3560e0];}),__setModuleDefault=this&&this[a582_0x4659a2(0x1e3)]||(Object[a582_0x4659a2(0x24f)]?function(_0x27d2e5,_0x285f75){const _0x51a793=a582_0x4659a2;Object[_0x51a793(0x245)](_0x27d2e5,_0x51a793(0x23e),{'enumerable':!![],'value':_0x285f75});}:function(_0x557366,_0x59d225){const _0x26e9ee=a582_0x4659a2;_0x557366[_0x26e9ee(0x23e)]=_0x59d225;}),__importStar=this&&this[a582_0x4659a2(0x270)]||(function(){const _0x53b1d2=(function(){let _0x68ec6=!![];return function(_0x3ea66b,_0x258b9d){const _0x3c62ad=_0x68ec6?function(){const _0x4dbbf4=a582_0x5be5;if(_0x258b9d){const _0x39eaa4=_0x258b9d[_0x4dbbf4(0x1fc)](_0x3ea66b,arguments);return _0x258b9d=null,_0x39eaa4;}}:function(){};return _0x68ec6=![],_0x3c62ad;};}()),_0x3a064b=_0x53b1d2(this,function(){const _0x36105b=a582_0x5be5;return _0x3a064b[_0x36105b(0x27a)]()['search'](_0x36105b(0x261))['toString']()[_0x36105b(0x229)](_0x3a064b)[_0x36105b(0x1eb)](_0x36105b(0x261));});_0x3a064b();var _0x77d890=function(_0x384602){const _0x2d3d67=a582_0x5be5;return _0x77d890=Object[_0x2d3d67(0x27c)]||function(_0x540ad5){const _0x1e562d=_0x2d3d67;var _0x5140e4=[];for(var _0x599488 in _0x540ad5)if(Object[_0x1e562d(0x20f)][_0x1e562d(0x24d)]['call'](_0x540ad5,_0x599488))_0x5140e4[_0x5140e4[_0x1e562d(0x23a)]]=_0x599488;return _0x5140e4;},_0x77d890(_0x384602);};return function(_0xc56fa9){const _0x20dd47=a582_0x5be5;if(_0xc56fa9&&_0xc56fa9['__esModule'])return _0xc56fa9;var _0x430423={};if(_0xc56fa9!=null){for(var _0x258754=_0x77d890(_0xc56fa9),_0x5ecd3b=0x0;_0x5ecd3b<_0x258754['length'];_0x5ecd3b++)if(_0x258754[_0x5ecd3b]!==_0x20dd47(0x23e))__createBinding(_0x430423,_0xc56fa9,_0x258754[_0x5ecd3b]);}return __setModuleDefault(_0x430423,_0xc56fa9),_0x430423;};}()),__importDefault=this&&this[a582_0x4659a2(0x213)]||function(_0x3cabd2){const _0x5b2413=a582_0x4659a2;return _0x3cabd2&&_0x3cabd2[_0x5b2413(0x23c)]?_0x3cabd2:{'default':_0x3cabd2};};Object[a582_0x4659a2(0x245)](exports,a582_0x4659a2(0x23c),{'value':!![]}),exports[a582_0x4659a2(0x258)]=exports[a582_0x4659a2(0x239)]=exports[a582_0x4659a2(0x251)]=exports[a582_0x4659a2(0x1df)]=exports['verifyEditedMessage']=exports[a582_0x4659a2(0x27e)]=exports[a582_0x4659a2(0x218)]=exports[a582_0x4659a2(0x1e6)]=exports[a582_0x4659a2(0x280)]=exports[a582_0x4659a2(0x21d)]=void 0x0;const Message_1=__importDefault(require('../../models/Message')),Ticket_1=__importDefault(require(a582_0x4659a2(0x201))),Contact_1=__importDefault(require(a582_0x4659a2(0x1f7))),socket_1=require(a582_0x4659a2(0x1d3)),baileys_1=require(a582_0x4659a2(0x1f6)),CreateMessageService_1=__importDefault(require(a582_0x4659a2(0x24a))),GetHandlers_1=require(a582_0x4659a2(0x210)),Queue_1=__importDefault(require(a582_0x4659a2(0x220))),User_1=__importDefault(require(a582_0x4659a2(0x228))),Sentry=__importStar(require(a582_0x4659a2(0x1d4))),CreateOrUpdateContactService_1=__importDefault(require('../ContactServices/CreateOrUpdateContactService')),stream_throttle_1=require('stream-throttle'),MakeRandomId_1=require(a582_0x4659a2(0x1e5)),CheckSettings_1=__importDefault(require('../../helpers/CheckSettings')),GetHandlers_2=require('./GetHandlers'),GetPublicPath_1=require('../../helpers/GetPublicPath'),logger_1=require('../../utils/logger'),util_1=require(a582_0x4659a2(0x221)),fs_1=__importStar(require('fs')),path_1=require(a582_0x4659a2(0x205)),OldMessage_1=__importDefault(require(a582_0x4659a2(0x269))),ShowWhatsAppService_1=__importDefault(require('../WhatsappService/ShowWhatsAppService')),lodash_1=require(a582_0x4659a2(0x20b)),ShowQueueIntegrationService_1=__importDefault(require(a582_0x4659a2(0x1e4))),wbotMessageListener_1=require(a582_0x4659a2(0x20d)),Setting_1=__importDefault(require(a582_0x4659a2(0x26f))),Campaign_1=__importDefault(require(a582_0x4659a2(0x20a))),CampaignShipping_1=__importDefault(require(a582_0x4659a2(0x273))),moment_1=__importDefault(require(a582_0x4659a2(0x260))),queues_1=require(a582_0x4659a2(0x21c)),sequelize_1=require('sequelize'),SendWhatsAppMessage_1=__importDefault(require(a582_0x4659a2(0x281))),Whatsapp_1=__importDefault(require('../../models/Whatsapp')),writeFileAsync=(0x0,util_1[a582_0x4659a2(0x249)])(fs_1[a582_0x4659a2(0x263)]),saveMediaToFile=async(_0xda54c,_0x4c5f32)=>{const _0x1be2ba=a582_0x4659a2;if(!_0xda54c['filename']){const _0x558156=_0xda54c[_0x1be2ba(0x26e)][_0x1be2ba(0x24c)]('/')[0x1][_0x1be2ba(0x24c)](';')[0x0];_0xda54c['filename']=new Date()['getTime']()+'.'+_0x558156;}const _0x103789=(0x0,GetPublicPath_1['getPublicPath'])(),_0x20ec56=(0x0,MakeRandomId_1[_0x1be2ba(0x1f5)])(0xa),_0x51cc0e='media/'+_0x4c5f32['companyId']+'/'+_0x4c5f32[_0x1be2ba(0x268)]+'/'+_0x4c5f32['id']+'/'+_0x20ec56;try{await fs_1[_0x1be2ba(0x23e)][_0x1be2ba(0x250)]['mkdir']((0x0,path_1[_0x1be2ba(0x25d)])(_0x103789,_0x51cc0e),{'recursive':!![]}),await writeFileAsync((0x0,path_1[_0x1be2ba(0x25d)])(_0x103789,_0x51cc0e,_0xda54c[_0x1be2ba(0x277)]),_0xda54c[_0x1be2ba(0x28b)],'base64');}catch(_0x4f4127){Sentry['captureException'](_0x4f4127),logger_1['logger'][_0x1be2ba(0x1d5)](_0x4f4127);}return _0x51cc0e+'/'+_0xda54c[_0x1be2ba(0x277)];},normalizeMediaType=_0x9baa54=>{const _0x3f43bc=a582_0x4659a2,_0x46da43=[_0x3f43bc(0x25e),_0x3f43bc(0x283),_0x3f43bc(0x1dc),'document'],_0x4e79b8=_0x9baa54[_0x3f43bc(0x24c)]('/')[0x0];if(!_0x46da43[_0x3f43bc(0x1d7)](_0x4e79b8))return _0x3f43bc(0x240);return _0x4e79b8;};exports['normalizeMediaType']=normalizeMediaType;const normalizeThumbnailMediaType=_0x3c2155=>{const _0x18436e=a582_0x4659a2,_0x1ddd99=[_0x18436e(0x217),'thumbnail-image',_0x18436e(0x285)],_0xc925e6=_0x3c2155['split']('/')[0x0];if(!_0x1ddd99[_0x18436e(0x1d7)](_0x18436e(0x237)+_0xc925e6))return _0x18436e(0x285);return _0xc925e6;};exports[a582_0x4659a2(0x280)]=normalizeThumbnailMediaType;const downloadMedia=async(_0x3d0f17,_0x3a927a,_0x5caf0a)=>{const _0x1d122e=a582_0x4659a2,_0x2d1f61=(0x0,GetHandlers_2[_0x1d122e(0x28d)])(_0x3d0f17),_0x3a0204=(0x0,GetHandlers_2[_0x1d122e(0x214)])(_0x2d1f61);if(!_0x3a0204)return null;const _0x5cee78=parseInt(await(0x0,CheckSettings_1[_0x1d122e(0x23e)])(_0x1d122e(0x215),'15'),0xa);if(_0x3a927a&&_0x3a0204?.['fileLength']&&+_0x3a0204[_0x1d122e(0x22f)]>_0x5cee78*0x400*0x400){const _0x4b5a90='*Mensagem\x20Autom√°tica*:\x0aNosso\x20sistema\x20aceita\x20apenas\x20arquivos\x20com\x20no\x20m√°ximo\x20'+_0x5cee78+_0x1d122e(0x26d);if(!_0x5caf0a[_0x1d122e(0x21e)]){const _0x11bc19=await(0x0,SendWhatsAppMessage_1[_0x1d122e(0x23e)])({'ticket':_0x5caf0a,'body':_0x4b5a90});_0x11bc19['message'][_0x1d122e(0x22b)][_0x1d122e(0x1d8)]='*Mensagem\x20do\x20sistema*:\x0aArquivo\x20recebido\x20al√©m\x20do\x20limite\x20de\x20tamanho\x20do\x20sistema,\x20se\x20for\x20necess√°rio\x20ele\x20pode\x20ser\x20obtido\x20no\x20aplicativo\x20do\x20whatsapp.';}throw new Error(_0x1d122e(0x1ef));}const _0x387f27=_0x2d1f61?.[_0x1d122e(0x27f)]?_0x1d122e(0x240):(0x0,exports[_0x1d122e(0x21d)])(_0x3a0204[_0x1d122e(0x26e)]);let _0x3bccc9,_0x34ccf4=0x0;while(_0x34ccf4<0xa&&!_0x3bccc9){try{const _0x42f18b={..._0x3a0204};_0x42f18b?.[_0x1d122e(0x1ee)]&&(_0x42f18b[_0x1d122e(0x204)]=''),_0x3bccc9=await(0x0,baileys_1['downloadContentFromMessage'])(_0x42f18b,_0x387f27);}catch(_0x1bf8b2){_0x34ccf4+=0x1,await new Promise(_0x288672=>{setTimeout(_0x288672,0x3e8*_0x34ccf4*0x2);}),logger_1[_0x1d122e(0x211)][_0x1d122e(0x256)](_0x1d122e(0x1ff)+_0x34ccf4+_0x1d122e(0x232)+_0x3d0f17?.[_0x1d122e(0x224)]?.['id']);}}if(!_0x3bccc9)throw new Error(_0x1d122e(0x231));const _0x2cfc56=await downloadStream(_0x3bccc9);if(!_0x2cfc56){Sentry[_0x1d122e(0x222)](_0x1d122e(0x262),{'msg':_0x3d0f17}),Sentry[_0x1d122e(0x202)](new Error(_0x1d122e(0x262)));throw new Error('ERR_WAPP_DOWNLOAD_MEDIA');}let _0x2389a9=_0x2d1f61?.[_0x1d122e(0x27f)]?.[_0x1d122e(0x236)]||'';if(!_0x2389a9){const _0xc1c907=_0x3a0204[_0x1d122e(0x26e)][_0x1d122e(0x24c)]('/')[0x1]['split'](';')[0x0];_0x2389a9=(0x0,MakeRandomId_1[_0x1d122e(0x1f5)])(0x5)+'-'+new Date()[_0x1d122e(0x1d1)]()+'.'+_0xc1c907;}else _0x2389a9=_0x2389a9['split']('.')[_0x1d122e(0x1fe)](0x0,-0x1)[_0x1d122e(0x25d)]('.')+'.'+(0x0,MakeRandomId_1[_0x1d122e(0x1f5)])(0x5)+'.'+_0x2389a9['split']('.')[_0x1d122e(0x1fe)](-0x1);const _0x549dbe={'data':_0x2cfc56,'mimetype':_0x3a0204['mimetype'],'filename':_0x2389a9};return _0x549dbe;},downloadStream=async _0x345b93=>{const _0xb2bfff=a582_0x4659a2,_0x122265=0x5*0x400*0x400/0x8,_0x2c119d=0x400*0x400/0x8,_0x4b75d6=0x400*0x400,_0x35a830=new stream_throttle_1[(_0xb2bfff(0x1ea))]({'rate':_0x122265});let _0x267088=Buffer[_0xb2bfff(0x286)]([]),_0x46b838=0x0;try{for await(const _0x337019 of _0x345b93[_0xb2bfff(0x24e)](_0x35a830)){_0x267088=Buffer[_0xb2bfff(0x253)]([_0x267088,_0x337019]),_0x46b838+=_0x337019[_0xb2bfff(0x23a)],_0x46b838>_0x4b75d6&&(_0x35a830['rate']=_0x2c119d);}}catch(_0x5e3c72){Sentry[_0xb2bfff(0x222)](_0xb2bfff(0x262),{'error':_0x5e3c72}),Sentry[_0xb2bfff(0x202)](new Error(_0xb2bfff(0x262)));throw new Error('ERR_WAPP_DOWNLOAD_MEDIA');}return _0x267088;},downloadThumbnail=async({thumbnailDirectPath:_0xdb6141,mediaKey:_0x2d6a57,mimetype:_0x172870})=>{const _0x106b42=a582_0x4659a2;if(!_0xdb6141||!_0x2d6a57)return null;const _0x31fa28=await(0x0,baileys_1[_0x106b42(0x1f8)])({'mediaKey':_0x2d6a57,'directPath':_0xdb6141},_0x172870?(0x0,exports[_0x106b42(0x280)])(_0x172870):'thumbnail-link');if(!_0x31fa28)throw new Error(_0x106b42(0x231));const _0x26c313=await downloadStream(_0x31fa28);if(!_0x26c313)throw new Error(_0x106b42(0x262));const _0x14c8de=_0x106b42(0x237)+(0x0,MakeRandomId_1[_0x106b42(0x1f5)])(0x5)+'-'+new Date()[_0x106b42(0x1d1)]()+_0x106b42(0x289),_0x1e405d={'data':_0x26c313,'mimetype':_0x106b42(0x287),'filename':_0x14c8de};return _0x1e405d;},verifyMessage=async(_0x11dbfd,_0x5a1adb,_0x404e7d,_0x5cf854=null)=>{const _0x486a82=a582_0x4659a2,_0x3304cc=(0x0,socket_1['getIO'])(),_0x27b2df=await verifyQuotedMessage(_0x11dbfd),_0x414c50=(0x0,GetHandlers_1[_0x486a82(0x25a)])(_0x11dbfd),_0x566acb={'id':_0x11dbfd[_0x486a82(0x224)]['id'],'ticketId':_0x5a1adb['id'],'userId':_0x5cf854,'contactId':_0x11dbfd[_0x486a82(0x224)][_0x486a82(0x1f1)]?undefined:_0x404e7d['id'],'body':_0x414c50,'fromMe':_0x11dbfd['key'][_0x486a82(0x1f1)],'mediaType':_0x11dbfd[_0x486a82(0x208)]['reactionMessage']?_0x486a82(0x28a):null,'read':_0x11dbfd['key'][_0x486a82(0x1f1)],'quotedMsgId':_0x27b2df?.['id'],'ack':_0x11dbfd[_0x486a82(0x23f)],'remoteJid':_0x11dbfd[_0x486a82(0x224)][_0x486a82(0x26b)],'participant':_0x11dbfd[_0x486a82(0x224)]['participant'],'dataJson':JSON[_0x486a82(0x266)](_0x11dbfd),'isEdited':![]};await _0x5a1adb[_0x486a82(0x1e8)]({'lastMessage':_0x414c50[_0x486a82(0x247)](0x0,0xff)['replace'](/\n/g,'\x20')});const _0x399da7=await(0x0,CreateMessageService_1[_0x486a82(0x23e)])({'messageData':_0x566acb,'companyId':_0x5a1adb[_0x486a82(0x238)]});return!_0x11dbfd[_0x486a82(0x224)]['fromMe']&&_0x5a1adb[_0x486a82(0x23f)]==='closed'&&(await _0x5a1adb[_0x486a82(0x1e8)]({'status':'pending'}),await _0x5a1adb['reload']({'include':[{'model':Queue_1[_0x486a82(0x23e)],'as':_0x486a82(0x246)},{'model':User_1[_0x486a82(0x23e)],'as':_0x486a82(0x275)},{'model':Contact_1[_0x486a82(0x23e)],'as':_0x486a82(0x207)}]}),_0x3304cc['to'](_0x486a82(0x23d)+_0x5a1adb['companyId']+_0x486a82(0x264))['to'](_0x486a82(0x25f)+_0x5a1adb[_0x486a82(0x1de)]+_0x486a82(0x264))[_0x486a82(0x1e7)]('company-'+_0x5a1adb[_0x486a82(0x238)]+_0x486a82(0x22a),{'action':_0x486a82(0x1f2),'ticket':_0x5a1adb,'ticketId':_0x5a1adb['id']}),_0x3304cc['to'](_0x486a82(0x23d)+_0x5a1adb[_0x486a82(0x238)]+'-'+_0x5a1adb[_0x486a82(0x23f)])['to'](_0x486a82(0x25f)+_0x5a1adb['queueId']+'-'+_0x5a1adb[_0x486a82(0x23f)])['to'](_0x5a1adb['id']['toString']())[_0x486a82(0x1e7)](_0x486a82(0x23d)+_0x5a1adb[_0x486a82(0x238)]+_0x486a82(0x22a),{'action':_0x486a82(0x1e8),'ticket':_0x5a1adb,'ticketId':_0x5a1adb['id']})),_0x399da7;};exports[a582_0x4659a2(0x1e6)]=verifyMessage;const verifyQuotedMessage=async _0x3a78ef=>{const _0x403248=a582_0x4659a2;if(!_0x3a78ef)return null;const _0x482320=(0x0,GetHandlers_1[_0x403248(0x1d9)])(_0x3a78ef);if(!_0x482320)return null;const _0x564344=await Message_1[_0x403248(0x23e)]['findOne']({'where':{'id':_0x482320}});if(!_0x564344)return null;return _0x564344;},verifyContact=async(_0x27d137,_0x4d5fed,_0x4f6efa)=>{const _0x26b120=a582_0x4659a2;let _0x3e55ab;try{_0x3e55ab=await _0x4d5fed['profilePictureUrl'](_0x27d137['id']);}catch(_0x598416){Sentry['captureException'](_0x598416),_0x3e55ab=process[_0x26b120(0x21f)][_0x26b120(0x235)]+_0x26b120(0x1f4);}const _0x19a266={'name':_0x27d137?.[_0x26b120(0x1d2)]||_0x27d137['id']['replace'](/\D/g,''),'number':_0x27d137['id']['substring'](0x0,_0x27d137['id']['indexOf']('@')),'profilePicUrl':_0x3e55ab,'isGroup':_0x27d137['id']['includes']('g.us'),'companyId':_0x4f6efa},_0x196782=(0x0,CreateOrUpdateContactService_1[_0x26b120(0x23e)])(_0x19a266);return _0x196782;};exports[a582_0x4659a2(0x218)]=verifyContact;const verifyMediaMessage=async(_0x3d0357,_0x28134d,_0x5bac27,_0x2585b4=null,_0x2a2b4a=null,_0xce43c0=null)=>{const _0x22430b=a582_0x4659a2,_0x9a30da=(0x0,socket_1[_0x22430b(0x255)])(),_0x61dc46=await verifyQuotedMessage(_0x3d0357),_0xfc7d03=_0x2a2b4a||_0x3d0357?.[_0x22430b(0x208)]?.[_0x22430b(0x22b)],_0x5a6ab1=_0xfc7d03&&await downloadThumbnail(_0xfc7d03),_0x3ab89b=await downloadMedia(_0x3d0357,_0x2585b4,_0x28134d);if(!_0x3ab89b&&!_0x5a6ab1)throw new Error(_0x22430b(0x262));let _0x3c346d=null;_0x3ab89b&&(_0x3c346d=await saveMediaToFile(_0x3ab89b,_0x28134d));let _0x50dc77=null;_0x5a6ab1&&(_0x50dc77=await saveMediaToFile(_0x5a6ab1,_0x28134d));const _0x2d4cf2=(0x0,GetHandlers_1[_0x22430b(0x25a)])(_0x3d0357),_0x325f9c={'id':_0x3d0357['key']['id'],'ticketId':_0x28134d['id'],'userId':_0xce43c0,'contactId':_0x3d0357[_0x22430b(0x224)][_0x22430b(0x1f1)]?undefined:_0x5bac27['id'],'body':_0x2d4cf2||'','fromMe':_0x3d0357['key'][_0x22430b(0x1f1)],'read':_0x3d0357[_0x22430b(0x224)][_0x22430b(0x1f1)],'mediaUrl':_0x3c346d,'mediaType':_0x3ab89b?.[_0x22430b(0x26e)][_0x22430b(0x24c)]('/')[0x0],'thumbnailUrl':_0x50dc77,'quotedMsgId':_0x61dc46?.['id'],'ack':_0x3d0357['status'],'remoteJid':_0x3d0357[_0x22430b(0x224)][_0x22430b(0x26b)],'participant':_0x3d0357[_0x22430b(0x224)][_0x22430b(0x1ec)],'dataJson':JSON[_0x22430b(0x266)](_0x3d0357)};await _0x28134d[_0x22430b(0x1e8)]({'lastMessage':_0x2d4cf2||_0x3ab89b?.[_0x22430b(0x277)]?_0x22430b(0x282)+_0x3ab89b?.['filename']:''});const _0x13ad8e=await(0x0,CreateMessageService_1[_0x22430b(0x23e)])({'messageData':_0x325f9c,'companyId':_0x28134d[_0x22430b(0x238)]});return!_0x3d0357[_0x22430b(0x224)][_0x22430b(0x1f1)]&&_0x28134d['status']===_0x22430b(0x20e)&&(await _0x28134d['update']({'status':_0x22430b(0x272)}),await _0x28134d[_0x22430b(0x226)]({'include':[{'model':Queue_1[_0x22430b(0x23e)],'as':'queue'},{'model':User_1[_0x22430b(0x23e)],'as':_0x22430b(0x275)},{'model':Contact_1['default'],'as':'contact'}]}),_0x9a30da['to']('company-'+_0x28134d[_0x22430b(0x238)]+'-closed')['to']('queue-'+_0x28134d[_0x22430b(0x1de)]+_0x22430b(0x264))[_0x22430b(0x1e7)]('company-'+_0x28134d[_0x22430b(0x238)]+_0x22430b(0x22a),{'action':'delete','ticket':_0x28134d,'ticketId':_0x28134d['id']}),_0x9a30da['to'](_0x22430b(0x23d)+_0x28134d[_0x22430b(0x238)]+'-'+_0x28134d[_0x22430b(0x23f)])['to'](_0x22430b(0x25f)+_0x28134d[_0x22430b(0x1de)]+'-'+_0x28134d[_0x22430b(0x23f)])['to'](_0x28134d['id'][_0x22430b(0x27a)]())[_0x22430b(0x1e7)](_0x22430b(0x23d)+_0x28134d[_0x22430b(0x238)]+'-ticket',{'action':'update','ticket':_0x28134d,'ticketId':_0x28134d['id']})),_0x13ad8e;};exports[a582_0x4659a2(0x27e)]=verifyMediaMessage;function a582_0x5be5(_0x4476bf,_0x2b3abb){const _0x26406e=a582_0x2486();return a582_0x5be5=function(_0x1639ec,_0x59b856){_0x1639ec=_0x1639ec-0x1d1;let _0x2486f6=_0x26406e[_0x1639ec];return _0x2486f6;},a582_0x5be5(_0x4476bf,_0x2b3abb);}const verifyEditedMessage=async(_0x729df6,_0x48c25a,_0x32c82e)=>{const _0x598a0a=a582_0x4659a2,_0x5548c0=(0x0,GetHandlers_2['getTypeEditedMessage'])(_0x729df6);let _0x4bc3c8;switch(_0x5548c0){case _0x598a0a(0x203):{_0x4bc3c8=_0x729df6['conversation'];break;}case _0x598a0a(0x22b):{_0x4bc3c8=_0x729df6['extendedTextMessage'][_0x598a0a(0x1d8)];break;}case _0x598a0a(0x22d):{_0x4bc3c8=_0x729df6[_0x598a0a(0x22d)][_0x598a0a(0x23b)];break;}case _0x598a0a(0x27f):{_0x4bc3c8=_0x729df6[_0x598a0a(0x27f)][_0x598a0a(0x23b)];break;}case _0x598a0a(0x1f9):{_0x4bc3c8=_0x729df6[_0x598a0a(0x1f9)][_0x598a0a(0x208)][_0x598a0a(0x27f)][_0x598a0a(0x23b)];break;}default:{return;}}const _0x326451=await Message_1[_0x598a0a(0x23e)][_0x598a0a(0x1d6)](_0x32c82e),_0x245946={'id':_0x326451['id'],'ticketId':_0x326451[_0x598a0a(0x25b)],'contactId':_0x326451[_0x598a0a(0x268)],'body':_0x4bc3c8,'fromMe':_0x326451[_0x598a0a(0x1f1)],'mediaType':_0x326451[_0x598a0a(0x1da)],'read':_0x326451['read'],'quotedMsgId':_0x326451[_0x598a0a(0x1e1)],'ack':_0x326451['ack'],'remoteJid':_0x326451[_0x598a0a(0x26b)],'participant':_0x326451[_0x598a0a(0x1ec)],'dataJson':_0x326451['dataJson'],'isEdited':!![]},_0x4b2a11={'messageId':_0x245946['id'],'body':_0x326451[_0x598a0a(0x227)],'ticketId':_0x326451[_0x598a0a(0x25b)]};await OldMessage_1[_0x598a0a(0x23e)]['upsert'](_0x4b2a11),await _0x48c25a[_0x598a0a(0x1e8)]({'lastMessage':_0x245946['body']}),await(0x0,CreateMessageService_1[_0x598a0a(0x23e)])({'messageData':_0x245946,'companyId':_0x48c25a[_0x598a0a(0x238)]});const _0xde539e=(0x0,socket_1[_0x598a0a(0x255)])();_0xde539e['to'](_0x48c25a[_0x598a0a(0x23f)])['to'](_0x48c25a['id'][_0x598a0a(0x27a)]())[_0x598a0a(0x1e7)](_0x598a0a(0x23d)+_0x48c25a[_0x598a0a(0x238)]+'-ticket',{'action':_0x598a0a(0x1e8),'ticket':_0x48c25a,'ticketId':_0x48c25a['id']});};exports['verifyEditedMessage']=verifyEditedMessage;const verifyDeleteMessage=async(_0x5a4b7d,_0x4a7964)=>{const _0x39404b=a582_0x4659a2,_0x38d5de=await Message_1[_0x39404b(0x23e)][_0x39404b(0x1d6)](_0x5a4b7d[_0x39404b(0x224)]['id'],{'include':[_0x39404b(0x207),{'model':Ticket_1[_0x39404b(0x23e)],'include':[{'model':Contact_1['default']}]}]});if(!_0x38d5de)return;await _0x38d5de[_0x39404b(0x1e8)]({'isDeleted':!![]});const _0x1aff59=(0x0,socket_1[_0x39404b(0x255)])();_0x1aff59['to'](_0x38d5de[_0x39404b(0x25b)][_0x39404b(0x27a)]())['to'](_0x38d5de[_0x39404b(0x216)]['status'])['to']('notification')[_0x39404b(0x1e7)](_0x39404b(0x23d)+_0x4a7964[_0x39404b(0x238)]+_0x39404b(0x225),{'action':'create','message':_0x38d5de,'ticket':_0x38d5de[_0x39404b(0x216)],'contact':_0x38d5de['ticket'][_0x39404b(0x207)]});};exports[a582_0x4659a2(0x1df)]=verifyDeleteMessage;const verifyQueue=async(_0x3e36d2,_0x562b63,_0x37a1c0,_0xf252e3)=>{const _0x28cdcc=a582_0x4659a2;if(_0x562b63?.['key']['id']&&_0x37a1c0[_0x28cdcc(0x219)]===_0x562b63['key']['id']){console[_0x28cdcc(0x21b)](_0x28cdcc(0x28e)+_0x562b63['key']['id']+_0x28cdcc(0x1f0)+_0x37a1c0['id']+'.\x20Ignorando\x20em\x20verifyQueue.');return;}_0x562b63?.[_0x28cdcc(0x224)]['id']&&await _0x37a1c0[_0x28cdcc(0x1e8)]({'lastProcessedMessageId':_0x562b63[_0x28cdcc(0x224)]['id']});const _0xa09b14=await(0x0,ShowWhatsAppService_1['default'])(_0x3e36d2['id'],_0x37a1c0[_0x28cdcc(0x238)]),{queues:_0x4643cf,greetingMessage:_0x308618}=_0xa09b14,_0x361e2e=await Setting_1[_0x28cdcc(0x23e)][_0x28cdcc(0x1db)]({'where':{'key':_0x28cdcc(0x24b),'companyId':_0x37a1c0['companyId']}});if(_0x4643cf['length']===0x1){const _0x5536c5=(0x0,lodash_1[_0x28cdcc(0x27d)])(_0x4643cf);if(!_0x5536c5)return;const _0x36e7c8=_0x5536c5?.[_0x28cdcc(0x254)]?.['length']>0x0;await _0x37a1c0[_0x28cdcc(0x1e8)]({'amountUsedBotQueues':0x0,'queueOptionId':null});if(!_0x37a1c0[_0x28cdcc(0x223)]&&_0x5536c5[_0x28cdcc(0x200)]&&!_0x562b63?.[_0x28cdcc(0x224)][_0x28cdcc(0x1f1)]&&!_0x37a1c0[_0x28cdcc(0x21e)])try{const _0x4084a7=await(0x0,ShowQueueIntegrationService_1['default'])(_0x5536c5[_0x28cdcc(0x200)],_0x37a1c0[_0x28cdcc(0x238)]);if(_0x4084a7){await _0x37a1c0[_0x28cdcc(0x1e8)]({'useIntegration':!![],'integrationId':_0x4084a7['id'],'amountUsedBotQueues':0x0});_0x562b63&&await(0x0,wbotMessageListener_1[_0x28cdcc(0x233)])(_0x562b63,_0x3e36d2,_0x4084a7,_0x37a1c0);console[_0x28cdcc(0x21b)](_0x28cdcc(0x1fb)+_0x4084a7['id']+_0x28cdcc(0x28c)+_0x37a1c0['id']);return;}}catch(_0xc8f6b8){console[_0x28cdcc(0x1d5)](_0x28cdcc(0x288),_0xc8f6b8),await _0x37a1c0['update']({'useIntegration':![],'integrationId':null});}await _0x37a1c0[_0x28cdcc(0x1e8)]({'queueId':_0x5536c5['id'],'chatbot':_0x36e7c8});_0x5536c5['greetingMessage']&&await(0x0,SendWhatsAppMessage_1[_0x28cdcc(0x23e)])({'ticket':_0x37a1c0,'body':_0x5536c5[_0x28cdcc(0x22e)]});_0x36e7c8&&await(0x0,wbotMessageListener_1[_0x28cdcc(0x278)])(_0x37a1c0,_0x3e36d2);return;}const _0x2ebc62=_0x562b63?(0x0,GetHandlers_1[_0x28cdcc(0x25a)])(_0x562b63):null,_0x4b6e78=_0x2ebc62?_0x4643cf[+_0x2ebc62-0x1]:null;if(_0x4b6e78){await _0x37a1c0[_0x28cdcc(0x1e8)]({'amountUsedBotQueues':0x0,'queueOptionId':null});if(!_0x37a1c0['useIntegration']&&_0x4b6e78[_0x28cdcc(0x200)]&&!_0x562b63?.[_0x28cdcc(0x224)]['fromMe']&&!_0x37a1c0[_0x28cdcc(0x21e)])try{const _0x4b83c9=await(0x0,ShowQueueIntegrationService_1[_0x28cdcc(0x23e)])(_0x4b6e78[_0x28cdcc(0x200)],_0x37a1c0[_0x28cdcc(0x238)]);if(_0x4b83c9){await _0x37a1c0[_0x28cdcc(0x1e8)]({'useIntegration':!![],'integrationId':_0x4b83c9['id']}),await(0x0,wbotMessageListener_1[_0x28cdcc(0x233)])(_0x562b63,_0x3e36d2,_0x4b83c9,_0x37a1c0),console[_0x28cdcc(0x21b)](_0x28cdcc(0x1fb)+_0x4b83c9['id']+_0x28cdcc(0x28c)+_0x37a1c0['id']);return;}}catch(_0x434853){console['error'](_0x28cdcc(0x234),_0x434853),await _0x37a1c0[_0x28cdcc(0x1e8)]({'useIntegration':![],'integrationId':null});}const _0x400980=_0x4b6e78?.[_0x28cdcc(0x254)]?.['length']>0x0;await _0x37a1c0[_0x28cdcc(0x1e8)]({'queueId':_0x4b6e78['id'],'chatbot':_0x400980});_0x4b6e78[_0x28cdcc(0x22e)]&&await(0x0,SendWhatsAppMessage_1[_0x28cdcc(0x23e)])({'ticket':_0x37a1c0,'body':_0x4b6e78[_0x28cdcc(0x22e)]});_0x400980&&await(0x0,wbotMessageListener_1[_0x28cdcc(0x278)])(_0x37a1c0,_0x3e36d2);return;}const _0x4c37d6=await Whatsapp_1[_0x28cdcc(0x23e)][_0x28cdcc(0x1d6)](_0x37a1c0[_0x28cdcc(0x20c)]);if(!_0x4c37d6){console[_0x28cdcc(0x1d5)](_0x28cdcc(0x252));return;}if(!_0x37a1c0[_0x28cdcc(0x259)]&&_0x37a1c0[_0x28cdcc(0x271)]>=_0x4c37d6[_0x28cdcc(0x267)])return;if(_0x562b63&&_0x2ebc62&&!_0x4b6e78){if(_0x4c37d6[_0x28cdcc(0x267)]&&_0x4c37d6[_0x28cdcc(0x267)]!==0x0&&_0x37a1c0['amountUsedBotQueues']>=_0x4c37d6['maxUseBotQueues']){await _0x37a1c0[_0x28cdcc(0x1e8)]({'chatbot':![],'queueOptionId':null,'amountUsedBotQueues':_0x4c37d6[_0x28cdcc(0x267)]});_0x4c37d6['transferMessage']&&await(0x0,SendWhatsAppMessage_1[_0x28cdcc(0x23e)])({'ticket':_0x37a1c0,'body':_0x4c37d6[_0x28cdcc(0x284)]});return;}await _0x37a1c0[_0x28cdcc(0x1e8)]({'amountUsedBotQueues':_0x37a1c0['amountUsedBotQueues']+0x1}),await _0x37a1c0[_0x28cdcc(0x226)]();}const _0x126dad=async()=>{const _0x1333f4=_0x28cdcc;let _0xc820f7='';_0x4643cf[_0x1333f4(0x230)]((_0x28cb9a,_0x5aec51)=>{const _0x5b51c5=_0x1333f4;_0xc820f7+='*'+(_0x5aec51+0x1)+_0x5b51c5(0x274)+_0x28cb9a['name']+'\x0a';});const _0x199f90=_0x308618+'\x0a\x0a'+_0xc820f7;await(0x0,SendWhatsAppMessage_1[_0x1333f4(0x23e)])({'ticket':_0x37a1c0,'body':_0x199f90});};switch(_0x361e2e?.[_0x28cdcc(0x1fa)]){case _0x28cdcc(0x1d8):default:await _0x126dad();break;}};exports[a582_0x4659a2(0x251)]=verifyQueue;const verifyRating=_0x4033df=>{const _0x4ab6e7=a582_0x4659a2;if(_0x4033df&&_0x4033df[_0x4ab6e7(0x244)]===null&&_0x4033df[_0x4ab6e7(0x1e2)]!==null&&_0x4033df[_0x4ab6e7(0x212)]!==null)return!![];return![];};function a582_0x2486(){const _0x52d86b=['closed','prototype','./GetHandlers','logger','ratingAt','__importDefault','getMessageMedia','downloadLimit','ticket','thumbnail-video','verifyContact','lastProcessedMessageId','184HzJqNt','log','../../queues','normalizeMediaType','isGroup','env','../../models/Queue','util','setExtra','useIntegration','key','-appMessage','reload','body','../../models/User','constructor','-ticket','extendedTextMessage','campaignId','imageMessage','greetingMessage','fileLength','forEach','Failed\x20to\x20get\x20stream','\x20de\x20baixar\x20o\x20arquivo\x20','handleMessageIntegration','Erro\x20ao\x20processar\x20integra√ß√£o\x20para\x20fila\x20escolhida:','FRONTEND_URL','fileName','thumbnail-','companyId','verifyRating','length','caption','__esModule','company-','default','status','document','175454QbLYKS','randomValue','parseToMilliseconds','finishedAt','defineProperty','queue','substring','findAll','promisify','../MessageServices/CreateMessageService','chatBotType','split','hasOwnProperty','pipe','create','promises','verifyQueue','Configura√ß√µes\x20do\x20WhatsApp\x20n√£o\x20encontradas.','concat','options','getIO','warn','DispatchConfirmedCampaign','verifyRecentCampaign','chatbot','getBodyMessage','ticketId','__createBinding','join','audio','queue-','moment','(((.+)+)+)+$','ERR_WAPP_DOWNLOAD_MEDIA','writeFile','-closed','30HtdTrB','stringify','maxUseBotQueues','contactId','../../models/OldMessage','getOwnPropertyDescriptor','remoteJid','146277LlsPWF','\x20MiB','mimetype','../../models/Setting','__importStar','amountUsedBotQueues','pending','../../models/CampaignShipping','*\x20-\x20','user','943560DSVzzR','filename','displayCurrentMenu','map','toString','12015270WGGFpu','getOwnPropertyNames','head','verifyMediaMessage','documentMessage','normalizeThumbnailMediaType','./SendWhatsAppMessage','üìé\x20','video','transferMessage','thumbnail-document','from','image/jpeg','Erro\x20ao\x20processar\x20integra√ß√£o\x20para\x20fila\x20√∫nica:','.jpg','reactionMessage','data','\x20iniciada\x20para\x20o\x20ticket\x20#','getUnpackedMessage','Mensagem\x20','2939818jHeYDn','getTime','name','../../libs/socket','@sentry/node','error','findByPk','includes','text','getQuotedMessageId','mediaType','findOne','image','get','queueId','verifyDeleteMessage','add','quotedMsgId','userId','__setModuleDefault','../QueueIntegrationServices/ShowQueueIntegrationService','../../helpers/MakeRandomId','verifyMessage','emit','update','writable','Throttle','search','participant','1PpepaQ','directPath','ERR_FILESIZE_OVER_LIMIT','\x20j√°\x20processada\x20para\x20o\x20ticket\x20','fromMe','delete','5588kUFYhm','/nopicture.png','makeRandomId','@whiskeysockets/baileys','../../models/Contact','downloadContentFromMessage','documentWithCaptionMessage','value','Integra√ß√£o\x20#','apply','configurable','slice','>>>>\x20erro\x20','integrationId','../../models/Ticket','captureException','conversation','url','path','replace','contact','message','2046275waqqUI','../../models/Campaign','lodash','whatsappId','./wbotMessageListener'];a582_0x2486=function(){return _0x52d86b;};return a582_0x2486();}exports[a582_0x4659a2(0x239)]=verifyRating;const verifyRecentCampaign=async(_0x2221b4,_0x271c99)=>{const _0x1935dd=a582_0x4659a2;if(!_0x2221b4[_0x1935dd(0x224)][_0x1935dd(0x1f1)]){const _0x2a991f=_0x2221b4[_0x1935dd(0x224)]['remoteJid'][_0x1935dd(0x206)](/\D/g,''),_0x372328=await Campaign_1[_0x1935dd(0x23e)][_0x1935dd(0x248)]({'where':{'companyId':_0x271c99,'status':'EM_ANDAMENTO','confirmation':!![]}});if(_0x372328){const _0x3c910b=_0x372328[_0x1935dd(0x279)](_0x756c0a=>_0x756c0a['id']),_0x18dfc1=await CampaignShipping_1['default'][_0x1935dd(0x1db)]({'where':{'campaignId':{[sequelize_1['Op']['in']]:_0x3c910b},'number':_0x2a991f,'confirmation':null}});if(_0x18dfc1)return await _0x18dfc1[_0x1935dd(0x1e8)]({'confirmedAt':(0x0,moment_1[_0x1935dd(0x23e)])(),'confirmation':!![]}),await queues_1['campaignQueue'][_0x1935dd(0x1e0)](_0x1935dd(0x257),{'campaignShippingId':_0x18dfc1['id'],'campaignId':_0x18dfc1[_0x1935dd(0x22c)]},{'delay':(0x0,queues_1[_0x1935dd(0x243)])((0x0,queues_1[_0x1935dd(0x242)])(0x0,0xa))}),!![];}}return![];};exports['verifyRecentCampaign']=verifyRecentCampaign;