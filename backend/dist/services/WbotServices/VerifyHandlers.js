'use strict';const a583_0x4a1176=a583_0x1ee9;(function(_0x167081,_0x5c9570){const _0x2c002d=a583_0x1ee9,_0x52520d=_0x167081();while(!![]){try{const _0x3eb664=parseInt(_0x2c002d(0x163))/0x1*(parseInt(_0x2c002d(0x177))/0x2)+parseInt(_0x2c002d(0x10d))/0x3*(parseInt(_0x2c002d(0x19a))/0x4)+parseInt(_0x2c002d(0x197))/0x5+parseInt(_0x2c002d(0x108))/0x6*(parseInt(_0x2c002d(0x15c))/0x7)+-parseInt(_0x2c002d(0x1ab))/0x8+parseInt(_0x2c002d(0x118))/0x9+parseInt(_0x2c002d(0x158))/0xa*(-parseInt(_0x2c002d(0x176))/0xb);if(_0x3eb664===_0x5c9570)break;else _0x52520d['push'](_0x52520d['shift']());}catch(_0x185612){_0x52520d['push'](_0x52520d['shift']());}}}(a583_0x1296,0xc7953));var __createBinding=this&&this['__createBinding']||(Object['create']?function(_0x2b4862,_0x56722e,_0x39c1c7,_0x403aed){const _0x45b56b=a583_0x1ee9;if(_0x403aed===undefined)_0x403aed=_0x39c1c7;var _0x186424=Object[_0x45b56b(0x192)](_0x56722e,_0x39c1c7);(!_0x186424||(_0x45b56b(0x110)in _0x186424?!_0x56722e['__esModule']:_0x186424[_0x45b56b(0x1b4)]||_0x186424['configurable']))&&(_0x186424={'enumerable':!![],'get':function(){return _0x56722e[_0x39c1c7];}}),Object[_0x45b56b(0x174)](_0x2b4862,_0x403aed,_0x186424);}:function(_0x2d6707,_0x29d93d,_0x24e950,_0x45890f){if(_0x45890f===undefined)_0x45890f=_0x24e950;_0x2d6707[_0x45890f]=_0x29d93d[_0x24e950];}),__setModuleDefault=this&&this[a583_0x4a1176(0x19f)]||(Object['create']?function(_0xce888f,_0x4cae7b){const _0x3b3da9=a583_0x4a1176;Object['defineProperty'](_0xce888f,_0x3b3da9(0x142),{'enumerable':!![],'value':_0x4cae7b});}:function(_0x202e3b,_0x1bc07f){const _0x5f04bb=a583_0x4a1176;_0x202e3b[_0x5f04bb(0x142)]=_0x1bc07f;}),__importStar=this&&this[a583_0x4a1176(0x159)]||(function(){const _0x290d49=(function(){let _0x54569b=!![];return function(_0xe9c9ab,_0x3545d3){const _0xaaadb1=_0x54569b?function(){const _0x5b7566=a583_0x1ee9;if(_0x3545d3){const _0xd2ece2=_0x3545d3[_0x5b7566(0x1b3)](_0xe9c9ab,arguments);return _0x3545d3=null,_0xd2ece2;}}:function(){};return _0x54569b=![],_0xaaadb1;};}()),_0x38fd28=_0x290d49(this,function(){const _0x52a2e0=a583_0x1ee9;return _0x38fd28[_0x52a2e0(0x1af)]()[_0x52a2e0(0x152)]('(((.+)+)+)+$')[_0x52a2e0(0x1af)]()[_0x52a2e0(0x121)](_0x38fd28)['search']('(((.+)+)+)+$');});_0x38fd28();var _0x5a5e77=function(_0x28c81c){const _0x5d9b17=a583_0x1ee9;return _0x5a5e77=Object[_0x5d9b17(0x196)]||function(_0x1eb916){const _0x7c3762=_0x5d9b17;var _0x27d7d7=[];for(var _0x647e71 in _0x1eb916)if(Object['prototype'][_0x7c3762(0x145)][_0x7c3762(0x170)](_0x1eb916,_0x647e71))_0x27d7d7[_0x27d7d7[_0x7c3762(0x153)]]=_0x647e71;return _0x27d7d7;},_0x5a5e77(_0x28c81c);};return function(_0x106dbe){const _0x48f8f5=a583_0x1ee9;if(_0x106dbe&&_0x106dbe[_0x48f8f5(0x105)])return _0x106dbe;var _0x3e2aa1={};if(_0x106dbe!=null){for(var _0x140cdc=_0x5a5e77(_0x106dbe),_0x15271a=0x0;_0x15271a<_0x140cdc[_0x48f8f5(0x153)];_0x15271a++)if(_0x140cdc[_0x15271a]!==_0x48f8f5(0x142))__createBinding(_0x3e2aa1,_0x106dbe,_0x140cdc[_0x15271a]);}return __setModuleDefault(_0x3e2aa1,_0x106dbe),_0x3e2aa1;};}()),__importDefault=this&&this[a583_0x4a1176(0x147)]||function(_0x5d96b0){const _0x13cd04=a583_0x4a1176;return _0x5d96b0&&_0x5d96b0[_0x13cd04(0x105)]?_0x5d96b0:{'default':_0x5d96b0};};Object[a583_0x4a1176(0x174)](exports,a583_0x4a1176(0x105),{'value':!![]}),exports[a583_0x4a1176(0x135)]=exports[a583_0x4a1176(0x125)]=exports['verifyQueue']=exports[a583_0x4a1176(0x199)]=exports[a583_0x4a1176(0x140)]=exports[a583_0x4a1176(0x1ad)]=exports[a583_0x4a1176(0x1a7)]=exports[a583_0x4a1176(0x14d)]=exports[a583_0x4a1176(0x194)]=exports[a583_0x4a1176(0x14a)]=void 0x0;const Message_1=__importDefault(require('../../models/Message')),Ticket_1=__importDefault(require(a583_0x4a1176(0x122))),Contact_1=__importDefault(require('../../models/Contact')),socket_1=require('../../libs/socket'),baileys_1=require(a583_0x4a1176(0x131)),CreateMessageService_1=__importDefault(require(a583_0x4a1176(0x13b))),GetHandlers_1=require(a583_0x4a1176(0x1b9)),Queue_1=__importDefault(require('../../models/Queue')),User_1=__importDefault(require(a583_0x4a1176(0x17b))),Sentry=__importStar(require('@sentry/node')),CreateOrUpdateContactService_1=__importDefault(require('../ContactServices/CreateOrUpdateContactService')),stream_throttle_1=require(a583_0x4a1176(0x10e)),MakeRandomId_1=require(a583_0x4a1176(0x150)),CheckSettings_1=__importDefault(require(a583_0x4a1176(0x181))),GetHandlers_2=require(a583_0x4a1176(0x1b9)),GetPublicPath_1=require(a583_0x4a1176(0x18c)),logger_1=require(a583_0x4a1176(0x116)),util_1=require('util'),fs_1=__importStar(require('fs')),path_1=require(a583_0x4a1176(0x11a)),OldMessage_1=__importDefault(require(a583_0x4a1176(0x14f))),ShowWhatsAppService_1=__importDefault(require(a583_0x4a1176(0x113))),lodash_1=require(a583_0x4a1176(0x12f)),ShowQueueIntegrationService_1=__importDefault(require(a583_0x4a1176(0x1a8))),wbotMessageListener_1=require(a583_0x4a1176(0x178)),Setting_1=__importDefault(require('../../models/Setting')),Campaign_1=__importDefault(require(a583_0x4a1176(0x112))),CampaignShipping_1=__importDefault(require(a583_0x4a1176(0x14b))),moment_1=__importDefault(require(a583_0x4a1176(0x154))),queues_1=require(a583_0x4a1176(0x143)),sequelize_1=require('sequelize'),SendWhatsAppMessage_1=__importDefault(require(a583_0x4a1176(0x11d))),Whatsapp_1=__importDefault(require('../../models/Whatsapp')),writeFileAsync=(0x0,util_1[a583_0x4a1176(0x189)])(fs_1[a583_0x4a1176(0x13d)]),saveMediaToFile=async(_0xdac7b8,_0x22bd8c)=>{const _0x4b8e63=a583_0x4a1176;if(!_0xdac7b8[_0x4b8e63(0x136)]){const _0x541c94=_0xdac7b8[_0x4b8e63(0x13c)][_0x4b8e63(0x19c)]('/')[0x1][_0x4b8e63(0x19c)](';')[0x0];_0xdac7b8[_0x4b8e63(0x136)]=new Date()[_0x4b8e63(0x18e)]()+'.'+_0x541c94;}const _0x4ccf3d=(0x0,GetPublicPath_1[_0x4b8e63(0x162)])(),_0x17af89=(0x0,MakeRandomId_1['makeRandomId'])(0xa),_0x3ef5f5='media/'+_0x22bd8c[_0x4b8e63(0x175)]+'/'+_0x22bd8c['contactId']+'/'+_0x22bd8c['id']+'/'+_0x17af89;try{await fs_1[_0x4b8e63(0x142)]['promises'][_0x4b8e63(0x18b)]((0x0,path_1['join'])(_0x4ccf3d,_0x3ef5f5),{'recursive':!![]}),await writeFileAsync((0x0,path_1[_0x4b8e63(0x103)])(_0x4ccf3d,_0x3ef5f5,_0xdac7b8[_0x4b8e63(0x136)]),_0xdac7b8['data'],_0x4b8e63(0x15a));}catch(_0xdae2b5){Sentry['captureException'](_0xdae2b5),logger_1[_0x4b8e63(0x10b)][_0x4b8e63(0x18d)](_0xdae2b5);}return _0x3ef5f5+'/'+_0xdac7b8[_0x4b8e63(0x136)];},normalizeMediaType=_0x1edba5=>{const _0xcfe122=a583_0x4a1176,_0x4c6883=['audio',_0xcfe122(0x1b8),'image',_0xcfe122(0x16d)],_0x3bf57e=_0x1edba5[_0xcfe122(0x19c)]('/')[0x0];if(!_0x4c6883[_0xcfe122(0x15f)](_0x3bf57e))return _0xcfe122(0x16d);return _0x3bf57e;};exports[a583_0x4a1176(0x14a)]=normalizeMediaType;const normalizeThumbnailMediaType=_0x210fb2=>{const _0x1b793e=a583_0x4a1176,_0x57c4b6=[_0x1b793e(0x14c),'thumbnail-image','thumbnail-document'],_0x11cbae=_0x210fb2[_0x1b793e(0x19c)]('/')[0x0];if(!_0x57c4b6[_0x1b793e(0x15f)](_0x1b793e(0x18a)+_0x11cbae))return _0x1b793e(0x119);return _0x11cbae;};exports['normalizeThumbnailMediaType']=normalizeThumbnailMediaType;const downloadMedia=async(_0x519814,_0x2687c6,_0x11ca34)=>{const _0x425862=a583_0x4a1176,_0x33f81b=(0x0,GetHandlers_2[_0x425862(0x137)])(_0x519814),_0x90326f=(0x0,GetHandlers_2[_0x425862(0x185)])(_0x33f81b);if(!_0x90326f)return null;const _0x3e495b=parseInt(await(0x0,CheckSettings_1[_0x425862(0x142)])(_0x425862(0x179),'15'),0xa);if(_0x2687c6&&_0x90326f?.[_0x425862(0x168)]&&+_0x90326f[_0x425862(0x168)]>_0x3e495b*0x400*0x400){const _0x516f4c=_0x425862(0x17a)+_0x3e495b+_0x425862(0x104);if(!_0x11ca34[_0x425862(0x156)]){const _0x30d389=await(0x0,SendWhatsAppMessage_1[_0x425862(0x142)])({'ticket':_0x11ca34,'body':_0x516f4c});_0x30d389[_0x425862(0x13f)][_0x425862(0x1a0)]['text']=_0x425862(0x148);}throw new Error('ERR_FILESIZE_OVER_LIMIT');}const _0x1f4a5a=_0x33f81b?.[_0x425862(0x19d)]?'document':(0x0,exports[_0x425862(0x14a)])(_0x90326f[_0x425862(0x13c)]);let _0x522fb3,_0x368bc0=0x0;while(_0x368bc0<0xa&&!_0x522fb3){try{const _0x35f6ed={..._0x90326f};_0x35f6ed?.[_0x425862(0x102)]&&(_0x35f6ed[_0x425862(0x10a)]=''),_0x522fb3=await(0x0,baileys_1[_0x425862(0x10f)])(_0x35f6ed,_0x1f4a5a);}catch(_0x592876){_0x368bc0+=0x1,await new Promise(_0x2db0f6=>{setTimeout(_0x2db0f6,0x3e8*_0x368bc0*0x2);}),logger_1['logger']['warn'](_0x425862(0x11e)+_0x368bc0+_0x425862(0x132)+_0x519814?.[_0x425862(0x19e)]?.['id']);}}if(!_0x522fb3)throw new Error('Failed\x20to\x20get\x20stream');const _0x8f6ac6=await downloadStream(_0x522fb3);if(!_0x8f6ac6){Sentry[_0x425862(0x144)]('ERR_WAPP_DOWNLOAD_MEDIA',{'msg':_0x519814}),Sentry[_0x425862(0x14e)](new Error(_0x425862(0x13e)));throw new Error(_0x425862(0x13e));}let _0x4ecc15=_0x33f81b?.[_0x425862(0x19d)]?.['fileName']||'';if(!_0x4ecc15){const _0x109443=_0x90326f[_0x425862(0x13c)][_0x425862(0x19c)]('/')[0x1][_0x425862(0x19c)](';')[0x0];_0x4ecc15=(0x0,MakeRandomId_1[_0x425862(0x149)])(0x5)+'-'+new Date()[_0x425862(0x18e)]()+'.'+_0x109443;}else _0x4ecc15=_0x4ecc15['split']('.')[_0x425862(0x186)](0x0,-0x1)[_0x425862(0x103)]('.')+'.'+(0x0,MakeRandomId_1[_0x425862(0x149)])(0x5)+'.'+_0x4ecc15['split']('.')['slice'](-0x1);const _0x5b2983={'data':_0x8f6ac6,'mimetype':_0x90326f[_0x425862(0x13c)],'filename':_0x4ecc15};return _0x5b2983;},downloadStream=async _0x4642a2=>{const _0x2dd39c=a583_0x4a1176,_0x7a2c5b=0x5*0x400*0x400/0x8,_0xbb1cb=0x400*0x400/0x8,_0x3ceef9=0x400*0x400,_0x3ec17e=new stream_throttle_1['Throttle']({'rate':_0x7a2c5b});let _0x180a93=Buffer[_0x2dd39c(0x114)]([]),_0x2e32cd=0x0;try{for await(const _0x504189 of _0x4642a2[_0x2dd39c(0x115)](_0x3ec17e)){_0x180a93=Buffer[_0x2dd39c(0x11b)]([_0x180a93,_0x504189]),_0x2e32cd+=_0x504189[_0x2dd39c(0x153)],_0x2e32cd>_0x3ceef9&&(_0x3ec17e[_0x2dd39c(0x124)]=_0xbb1cb);}}catch(_0x507d42){Sentry[_0x2dd39c(0x144)]('ERR_WAPP_DOWNLOAD_MEDIA',{'error':_0x507d42}),Sentry[_0x2dd39c(0x14e)](new Error('ERR_WAPP_DOWNLOAD_MEDIA'));throw new Error(_0x2dd39c(0x13e));}return _0x180a93;},downloadThumbnail=async({thumbnailDirectPath:_0x3f6cae,mediaKey:_0xe086b6,mimetype:_0x4d8bec})=>{const _0x2fcb2e=a583_0x4a1176;if(!_0x3f6cae||!_0xe086b6)return null;const _0x1007f9=await(0x0,baileys_1['downloadContentFromMessage'])({'mediaKey':_0xe086b6,'directPath':_0x3f6cae},_0x4d8bec?(0x0,exports[_0x2fcb2e(0x194)])(_0x4d8bec):'thumbnail-link');if(!_0x1007f9)throw new Error(_0x2fcb2e(0x1ae));const _0x47e166=await downloadStream(_0x1007f9);if(!_0x47e166)throw new Error(_0x2fcb2e(0x13e));const _0x11dc99=_0x2fcb2e(0x18a)+(0x0,MakeRandomId_1['makeRandomId'])(0x5)+'-'+new Date()[_0x2fcb2e(0x18e)]()+'.jpg',_0x24ab70={'data':_0x47e166,'mimetype':'image/jpeg','filename':_0x11dc99};return _0x24ab70;},verifyMessage=async(_0x3a2e94,_0x31ee33,_0x1c1d49,_0x1dd8fb=null)=>{const _0x446161=a583_0x4a1176,_0x1b30ed=(0x0,socket_1[_0x446161(0x12e)])(),_0x531240=await verifyQuotedMessage(_0x3a2e94),_0x2ae663=(0x0,GetHandlers_1[_0x446161(0x15e)])(_0x3a2e94),_0x30d955={'id':_0x3a2e94[_0x446161(0x19e)]['id'],'ticketId':_0x31ee33['id'],'userId':_0x1dd8fb,'contactId':_0x3a2e94[_0x446161(0x19e)][_0x446161(0x1a9)]?undefined:_0x1c1d49['id'],'body':_0x2ae663,'fromMe':_0x3a2e94[_0x446161(0x19e)]['fromMe'],'mediaType':_0x3a2e94['message'][_0x446161(0x171)]?_0x446161(0x171):null,'read':_0x3a2e94[_0x446161(0x19e)]['fromMe'],'quotedMsgId':_0x531240?.['id'],'ack':_0x3a2e94['status'],'remoteJid':_0x3a2e94[_0x446161(0x19e)][_0x446161(0x1b6)],'participant':_0x3a2e94['key'][_0x446161(0x106)],'dataJson':JSON['stringify'](_0x3a2e94),'isEdited':![]};await _0x31ee33[_0x446161(0x109)]({'lastMessage':_0x2ae663[_0x446161(0x1a3)](0x0,0xff)[_0x446161(0x12d)](/\n/g,'\x20')});const _0x349ee5=await(0x0,CreateMessageService_1[_0x446161(0x142)])({'messageData':_0x30d955,'companyId':_0x31ee33[_0x446161(0x175)]});return!_0x3a2e94[_0x446161(0x19e)][_0x446161(0x1a9)]&&_0x31ee33['status']===_0x446161(0x164)&&(await _0x31ee33[_0x446161(0x109)]({'status':_0x446161(0x1a5)}),await _0x31ee33[_0x446161(0x13a)]({'include':[{'model':Queue_1[_0x446161(0x142)],'as':_0x446161(0x128)},{'model':User_1[_0x446161(0x142)],'as':_0x446161(0x123)},{'model':Contact_1[_0x446161(0x142)],'as':_0x446161(0x146)}]}),_0x1b30ed['to'](_0x446161(0x11c)+_0x31ee33[_0x446161(0x175)]+'-closed')['to'](_0x446161(0x1b7)+_0x31ee33[_0x446161(0x180)]+_0x446161(0x157))['emit'](_0x446161(0x11c)+_0x31ee33[_0x446161(0x175)]+_0x446161(0x12c),{'action':_0x446161(0x169),'ticket':_0x31ee33,'ticketId':_0x31ee33['id']}),_0x1b30ed['to']('company-'+_0x31ee33[_0x446161(0x175)]+'-'+_0x31ee33[_0x446161(0x15d)])['to']('queue-'+_0x31ee33[_0x446161(0x180)]+'-'+_0x31ee33[_0x446161(0x15d)])['to'](_0x31ee33['id'][_0x446161(0x1af)]())['emit']('company-'+_0x31ee33['companyId']+_0x446161(0x12c),{'action':'update','ticket':_0x31ee33,'ticketId':_0x31ee33['id']})),_0x349ee5;};exports[a583_0x4a1176(0x14d)]=verifyMessage;const verifyQuotedMessage=async _0x4736e=>{const _0x45db92=a583_0x4a1176;if(!_0x4736e)return null;const _0x3fd004=(0x0,GetHandlers_1[_0x45db92(0x17e)])(_0x4736e);if(!_0x3fd004)return null;const _0x2951e6=await Message_1[_0x45db92(0x142)]['findOne']({'where':{'id':_0x3fd004}});if(!_0x2951e6)return null;return _0x2951e6;},verifyContact=async(_0x594430,_0x2b4f2f,_0x14c57c)=>{const _0xcb123d=a583_0x4a1176;let _0xd2cc69;try{_0xd2cc69=await _0x2b4f2f[_0xcb123d(0x19b)](_0x594430['id']);}catch(_0x498374){Sentry[_0xcb123d(0x14e)](_0x498374),_0xd2cc69=process[_0xcb123d(0x188)]['FRONTEND_URL']+'/nopicture.png';}const _0x33a2a5={'name':_0x594430?.[_0xcb123d(0x1b1)]||_0x594430['id'][_0xcb123d(0x12d)](/\D/g,''),'number':_0x594430['id']['substring'](0x0,_0x594430['id'][_0xcb123d(0x161)]('@')),'profilePicUrl':_0xd2cc69,'isGroup':_0x594430['id']['includes']('g.us'),'companyId':_0x14c57c},_0x24d43a=(0x0,CreateOrUpdateContactService_1[_0xcb123d(0x142)])(_0x33a2a5);return _0x24d43a;};exports[a583_0x4a1176(0x1a7)]=verifyContact;const verifyMediaMessage=async(_0x2b290b,_0x1f3c93,_0x2f315b,_0x4511dc=null,_0x513a98=null,_0x25a290=null)=>{const _0x24398e=a583_0x4a1176,_0x173846=(0x0,socket_1[_0x24398e(0x12e)])(),_0x2d9331=await verifyQuotedMessage(_0x2b290b),_0x10281a=_0x513a98||_0x2b290b?.[_0x24398e(0x13f)]?.[_0x24398e(0x1a0)],_0x219efa=_0x10281a&&await downloadThumbnail(_0x10281a),_0x370ec4=await downloadMedia(_0x2b290b,_0x4511dc,_0x1f3c93);if(!_0x370ec4&&!_0x219efa)throw new Error(_0x24398e(0x13e));let _0x2fd8f1=null;_0x370ec4&&(_0x2fd8f1=await saveMediaToFile(_0x370ec4,_0x1f3c93));let _0x3f3a02=null;_0x219efa&&(_0x3f3a02=await saveMediaToFile(_0x219efa,_0x1f3c93));const _0x931359=(0x0,GetHandlers_1[_0x24398e(0x15e)])(_0x2b290b),_0x2a0527={'id':_0x2b290b[_0x24398e(0x19e)]['id'],'ticketId':_0x1f3c93['id'],'userId':_0x25a290,'contactId':_0x2b290b[_0x24398e(0x19e)][_0x24398e(0x1a9)]?undefined:_0x2f315b['id'],'body':_0x931359||'','fromMe':_0x2b290b[_0x24398e(0x19e)]['fromMe'],'read':_0x2b290b[_0x24398e(0x19e)][_0x24398e(0x1a9)],'mediaUrl':_0x2fd8f1,'mediaType':_0x370ec4?.[_0x24398e(0x13c)]['split']('/')[0x0],'thumbnailUrl':_0x3f3a02,'quotedMsgId':_0x2d9331?.['id'],'ack':_0x2b290b[_0x24398e(0x15d)],'remoteJid':_0x2b290b[_0x24398e(0x19e)][_0x24398e(0x1b6)],'participant':_0x2b290b[_0x24398e(0x19e)]['participant'],'dataJson':JSON['stringify'](_0x2b290b)};await _0x1f3c93['update']({'lastMessage':_0x931359||_0x370ec4?.[_0x24398e(0x136)]?_0x24398e(0x111)+_0x370ec4?.[_0x24398e(0x136)]:''});const _0x4cb8e5=await(0x0,CreateMessageService_1[_0x24398e(0x142)])({'messageData':_0x2a0527,'companyId':_0x1f3c93[_0x24398e(0x175)]});return!_0x2b290b[_0x24398e(0x19e)]['fromMe']&&_0x1f3c93['status']==='closed'&&(await _0x1f3c93[_0x24398e(0x109)]({'status':'pending'}),await _0x1f3c93['reload']({'include':[{'model':Queue_1[_0x24398e(0x142)],'as':_0x24398e(0x128)},{'model':User_1['default'],'as':_0x24398e(0x123)},{'model':Contact_1[_0x24398e(0x142)],'as':'contact'}]}),_0x173846['to'](_0x24398e(0x11c)+_0x1f3c93[_0x24398e(0x175)]+'-closed')['to'](_0x24398e(0x1b7)+_0x1f3c93[_0x24398e(0x180)]+_0x24398e(0x157))[_0x24398e(0x173)](_0x24398e(0x11c)+_0x1f3c93[_0x24398e(0x175)]+_0x24398e(0x12c),{'action':'delete','ticket':_0x1f3c93,'ticketId':_0x1f3c93['id']}),_0x173846['to'](_0x24398e(0x11c)+_0x1f3c93['companyId']+'-'+_0x1f3c93[_0x24398e(0x15d)])['to'](_0x24398e(0x1b7)+_0x1f3c93[_0x24398e(0x180)]+'-'+_0x1f3c93[_0x24398e(0x15d)])['to'](_0x1f3c93['id'][_0x24398e(0x1af)]())['emit'](_0x24398e(0x11c)+_0x1f3c93['companyId']+'-ticket',{'action':_0x24398e(0x109),'ticket':_0x1f3c93,'ticketId':_0x1f3c93['id']})),_0x4cb8e5;};exports[a583_0x4a1176(0x1ad)]=verifyMediaMessage;const verifyEditedMessage=async(_0x42adcb,_0x20fe2d,_0x2feb93)=>{const _0x38aa0c=a583_0x4a1176,_0x3e9d76=(0x0,GetHandlers_2[_0x38aa0c(0x16b)])(_0x42adcb);let _0xa481c4;switch(_0x3e9d76){case _0x38aa0c(0x133):{_0xa481c4=_0x42adcb['conversation'];break;}case _0x38aa0c(0x1a0):{_0xa481c4=_0x42adcb[_0x38aa0c(0x1a0)]['text'];break;}case _0x38aa0c(0x182):{_0xa481c4=_0x42adcb[_0x38aa0c(0x182)]['caption'];break;}case _0x38aa0c(0x19d):{_0xa481c4=_0x42adcb[_0x38aa0c(0x19d)][_0x38aa0c(0x138)];break;}case'documentWithCaptionMessage':{_0xa481c4=_0x42adcb[_0x38aa0c(0x15b)][_0x38aa0c(0x13f)][_0x38aa0c(0x19d)][_0x38aa0c(0x138)];break;}default:{return;}}const _0x236fcb=await Message_1['default']['findByPk'](_0x2feb93),_0x49f61d={'id':_0x236fcb['id'],'ticketId':_0x236fcb[_0x38aa0c(0x129)],'contactId':_0x236fcb['contactId'],'body':_0xa481c4,'fromMe':_0x236fcb['fromMe'],'mediaType':_0x236fcb[_0x38aa0c(0x126)],'read':_0x236fcb[_0x38aa0c(0x130)],'quotedMsgId':_0x236fcb[_0x38aa0c(0x1b5)],'ack':_0x236fcb[_0x38aa0c(0x1a2)],'remoteJid':_0x236fcb['remoteJid'],'participant':_0x236fcb[_0x38aa0c(0x106)],'dataJson':_0x236fcb[_0x38aa0c(0x17c)],'isEdited':!![]},_0x8a9b73={'messageId':_0x49f61d['id'],'body':_0x236fcb['body'],'ticketId':_0x236fcb[_0x38aa0c(0x129)]};await OldMessage_1[_0x38aa0c(0x142)]['upsert'](_0x8a9b73),await _0x20fe2d[_0x38aa0c(0x109)]({'lastMessage':_0x49f61d[_0x38aa0c(0x17f)]}),await(0x0,CreateMessageService_1[_0x38aa0c(0x142)])({'messageData':_0x49f61d,'companyId':_0x20fe2d[_0x38aa0c(0x175)]});const _0x44dced=(0x0,socket_1[_0x38aa0c(0x12e)])();_0x44dced['to'](_0x20fe2d['status'])['to'](_0x20fe2d['id'][_0x38aa0c(0x1af)]())['emit']('company-'+_0x20fe2d[_0x38aa0c(0x175)]+_0x38aa0c(0x12c),{'action':_0x38aa0c(0x109),'ticket':_0x20fe2d,'ticketId':_0x20fe2d['id']});};exports['verifyEditedMessage']=verifyEditedMessage;const verifyDeleteMessage=async(_0x3a2555,_0x4f8ec3)=>{const _0x4568c5=a583_0x4a1176,_0x15eaf8=await Message_1[_0x4568c5(0x142)][_0x4568c5(0x16a)](_0x3a2555[_0x4568c5(0x19e)]['id'],{'include':['contact',{'model':Ticket_1[_0x4568c5(0x142)],'include':[{'model':Contact_1['default']}]}]});if(!_0x15eaf8)return;await _0x15eaf8[_0x4568c5(0x109)]({'isDeleted':!![]});const _0x4686b5=(0x0,socket_1[_0x4568c5(0x12e)])();_0x4686b5['to'](_0x15eaf8[_0x4568c5(0x129)][_0x4568c5(0x1af)]())['to'](_0x15eaf8['ticket'][_0x4568c5(0x15d)])['to'](_0x4568c5(0x187))['emit'](_0x4568c5(0x11c)+_0x4f8ec3['companyId']+_0x4568c5(0x155),{'action':_0x4568c5(0x160),'message':_0x15eaf8,'ticket':_0x15eaf8['ticket'],'contact':_0x15eaf8['ticket']['contact']});};exports['verifyDeleteMessage']=verifyDeleteMessage;const verifyQueue=async(_0x1defcf,_0x49526e,_0x2bdf28,_0x53afb4)=>{const _0x44f421=a583_0x4a1176;if(_0x49526e?.[_0x44f421(0x19e)]['id']&&_0x2bdf28[_0x44f421(0x165)]===_0x49526e[_0x44f421(0x19e)]['id']){console['log'](_0x44f421(0x172)+_0x49526e[_0x44f421(0x19e)]['id']+_0x44f421(0x117)+_0x2bdf28['id']+'.\x20Ignorando\x20em\x20verifyQueue.');return;}_0x49526e?.[_0x44f421(0x19e)]['id']&&await _0x2bdf28[_0x44f421(0x109)]({'lastProcessedMessageId':_0x49526e['key']['id']});const _0x477510=await(0x0,ShowWhatsAppService_1[_0x44f421(0x142)])(_0x1defcf['id'],_0x2bdf28[_0x44f421(0x175)]),{queues:_0x35f46c,greetingMessage:_0x395a1a}=_0x477510,_0x2121c7=await Setting_1[_0x44f421(0x142)][_0x44f421(0x1a1)]({'where':{'key':_0x44f421(0x191),'companyId':_0x2bdf28[_0x44f421(0x175)]}});if(_0x35f46c[_0x44f421(0x153)]===0x1){const _0x3d801f=(0x0,lodash_1[_0x44f421(0x151)])(_0x35f46c);if(!_0x3d801f)return;const _0x3c28fe=_0x3d801f?.['options']?.['length']>0x0;await _0x2bdf28['update']({'amountUsedBotQueues':0x0,'queueOptionId':null});if(!_0x2bdf28['useIntegration']&&_0x3d801f['integrationId']&&!_0x49526e?.[_0x44f421(0x19e)][_0x44f421(0x1a9)]&&!_0x2bdf28[_0x44f421(0x156)])try{const _0x53a37b=await(0x0,ShowQueueIntegrationService_1[_0x44f421(0x142)])(_0x3d801f[_0x44f421(0x11f)],_0x2bdf28[_0x44f421(0x175)]);if(_0x53a37b){await _0x2bdf28[_0x44f421(0x109)]({'useIntegration':!![],'integrationId':_0x53a37b['id'],'amountUsedBotQueues':0x0});_0x49526e&&await(0x0,wbotMessageListener_1[_0x44f421(0x16c)])(_0x49526e,_0x1defcf,_0x53a37b,_0x2bdf28);console['log'](_0x44f421(0x1b0)+_0x53a37b['id']+_0x44f421(0x183)+_0x2bdf28['id']);return;}}catch(_0x25facf){console[_0x44f421(0x18d)](_0x44f421(0x184),_0x25facf),await _0x2bdf28[_0x44f421(0x109)]({'useIntegration':![],'integrationId':null});}await _0x2bdf28[_0x44f421(0x109)]({'queueId':_0x3d801f['id'],'chatbot':_0x3c28fe});_0x3d801f[_0x44f421(0x1b2)]&&await(0x0,SendWhatsAppMessage_1[_0x44f421(0x142)])({'ticket':_0x2bdf28,'body':_0x3d801f[_0x44f421(0x1b2)]});_0x3c28fe&&await(0x0,wbotMessageListener_1[_0x44f421(0x193)])(_0x2bdf28,_0x1defcf);return;}const _0xec1982=_0x49526e?(0x0,GetHandlers_1[_0x44f421(0x15e)])(_0x49526e):null,_0x183fb5=_0xec1982?_0x35f46c[+_0xec1982-0x1]:null;if(_0x183fb5){await _0x2bdf28[_0x44f421(0x109)]({'amountUsedBotQueues':0x0,'queueOptionId':null});if(!_0x2bdf28['useIntegration']&&_0x183fb5[_0x44f421(0x11f)]&&!_0x49526e?.[_0x44f421(0x19e)][_0x44f421(0x1a9)]&&!_0x2bdf28['isGroup'])try{const _0x533b09=await(0x0,ShowQueueIntegrationService_1[_0x44f421(0x142)])(_0x183fb5[_0x44f421(0x11f)],_0x2bdf28[_0x44f421(0x175)]);if(_0x533b09){await _0x2bdf28['update']({'useIntegration':!![],'integrationId':_0x533b09['id']}),await(0x0,wbotMessageListener_1[_0x44f421(0x16c)])(_0x49526e,_0x1defcf,_0x533b09,_0x2bdf28),console[_0x44f421(0x195)](_0x44f421(0x1b0)+_0x533b09['id']+_0x44f421(0x183)+_0x2bdf28['id']);return;}}catch(_0x539bac){console[_0x44f421(0x18d)](_0x44f421(0x1ba),_0x539bac),await _0x2bdf28['update']({'useIntegration':![],'integrationId':null});}const _0x3f9420=_0x183fb5?.[_0x44f421(0x16e)]?.['length']>0x0;await _0x2bdf28[_0x44f421(0x109)]({'queueId':_0x183fb5['id'],'chatbot':_0x3f9420});_0x183fb5[_0x44f421(0x1b2)]&&await(0x0,SendWhatsAppMessage_1[_0x44f421(0x142)])({'ticket':_0x2bdf28,'body':_0x183fb5['greetingMessage']});_0x3f9420&&await(0x0,wbotMessageListener_1[_0x44f421(0x193)])(_0x2bdf28,_0x1defcf);return;}const _0x2586b9=await Whatsapp_1['default'][_0x44f421(0x16a)](_0x2bdf28[_0x44f421(0x120)]);if(!_0x2586b9){console['error'](_0x44f421(0x1ac));return;}if(!_0x2bdf28[_0x44f421(0x139)]&&_0x2bdf28['amountUsedBotQueues']>=_0x2586b9[_0x44f421(0x141)])return;if(_0x49526e&&_0xec1982&&!_0x183fb5){if(_0x2586b9[_0x44f421(0x141)]&&_0x2586b9[_0x44f421(0x141)]!==0x0&&_0x2bdf28['amountUsedBotQueues']>=_0x2586b9[_0x44f421(0x141)]){await _0x2bdf28[_0x44f421(0x109)]({'chatbot':![],'queueOptionId':null,'amountUsedBotQueues':_0x2586b9[_0x44f421(0x141)]});_0x2586b9[_0x44f421(0x134)]&&await(0x0,SendWhatsAppMessage_1[_0x44f421(0x142)])({'ticket':_0x2bdf28,'body':_0x2586b9[_0x44f421(0x134)]});return;}await _0x2bdf28['update']({'amountUsedBotQueues':_0x2bdf28[_0x44f421(0x12b)]+0x1}),await _0x2bdf28[_0x44f421(0x13a)]();}const _0x46ff44=async()=>{const _0x23d10d=_0x44f421;let _0x1eadc5='';_0x35f46c[_0x23d10d(0x127)]((_0x2500f4,_0x57f712)=>{const _0x36a129=_0x23d10d;_0x1eadc5+='*'+(_0x57f712+0x1)+'*\x20-\x20'+_0x2500f4[_0x36a129(0x1b1)]+'\x0a';});const _0x26c7a4=_0x395a1a+'\x0a\x0a'+_0x1eadc5;await(0x0,SendWhatsAppMessage_1[_0x23d10d(0x142)])({'ticket':_0x2bdf28,'body':_0x26c7a4});};switch(_0x2121c7?.[_0x44f421(0x18f)]){case _0x44f421(0x10c):default:await _0x46ff44();break;}};exports['verifyQueue']=verifyQueue;const verifyRating=_0x4bb0b4=>{const _0x19f159=a583_0x4a1176;if(_0x4bb0b4&&_0x4bb0b4[_0x19f159(0x167)]===null&&_0x4bb0b4[_0x19f159(0x166)]!==null&&_0x4bb0b4[_0x19f159(0x16f)]!==null)return!![];return![];};exports[a583_0x4a1176(0x125)]=verifyRating;const verifyRecentCampaign=async(_0x162294,_0x5c3fb5)=>{const _0x488afa=a583_0x4a1176;if(!_0x162294[_0x488afa(0x19e)][_0x488afa(0x1a9)]){const _0x2473cf=_0x162294[_0x488afa(0x19e)]['remoteJid'][_0x488afa(0x12d)](/\D/g,''),_0x427f43=await Campaign_1['default'][_0x488afa(0x198)]({'where':{'companyId':_0x5c3fb5,'status':_0x488afa(0x1a6),'confirmation':!![]}});if(_0x427f43){const _0x4fceab=_0x427f43[_0x488afa(0x1a4)](_0x2d5063=>_0x2d5063['id']),_0x4db4f4=await CampaignShipping_1[_0x488afa(0x142)][_0x488afa(0x1a1)]({'where':{'campaignId':{[sequelize_1['Op']['in']]:_0x4fceab},'number':_0x2473cf,'confirmation':null}});if(_0x4db4f4)return await _0x4db4f4['update']({'confirmedAt':(0x0,moment_1[_0x488afa(0x142)])(),'confirmation':!![]}),await queues_1[_0x488afa(0x12a)]['add'](_0x488afa(0x190),{'campaignShippingId':_0x4db4f4['id'],'campaignId':_0x4db4f4[_0x488afa(0x1aa)]},{'delay':(0x0,queues_1[_0x488afa(0x107)])((0x0,queues_1[_0x488afa(0x17d)])(0x0,0xa))}),!![];}}return![];};function a583_0x1ee9(_0x304b22,_0x5304f6){const _0x42f9bd=a583_0x1296();return a583_0x1ee9=function(_0x224d38,_0x428e12){_0x224d38=_0x224d38-0x102;let _0x12963c=_0x42f9bd[_0x224d38];return _0x12963c;},a583_0x1ee9(_0x304b22,_0x5304f6);}exports[a583_0x4a1176(0x135)]=verifyRecentCampaign;function a583_0x1296(){const _0x494963=['*Mensagem\x20do\x20sistema*:\x0aArquivo\x20recebido\x20além\x20do\x20limite\x20de\x20tamanho\x20do\x20sistema,\x20se\x20for\x20necessário\x20ele\x20pode\x20ser\x20obtido\x20no\x20aplicativo\x20do\x20whatsapp.','makeRandomId','normalizeMediaType','../../models/CampaignShipping','thumbnail-video','verifyMessage','captureException','../../models/OldMessage','../../helpers/MakeRandomId','head','search','length','moment','-appMessage','isGroup','-closed','6125810gTsWFU','__importStar','base64','documentWithCaptionMessage','35KjLZrh','status','getBodyMessage','includes','create','indexOf','getPublicPath','2bCpwpf','closed','lastProcessedMessageId','userId','finishedAt','fileLength','delete','findByPk','getTypeEditedMessage','handleMessageIntegration','document','options','ratingAt','call','reactionMessage','Mensagem\x20','emit','defineProperty','companyId','33rrwmjw','191138ahVPht','./wbotMessageListener','downloadLimit','*Mensagem\x20Automática*:\x0aNosso\x20sistema\x20aceita\x20apenas\x20arquivos\x20com\x20no\x20máximo\x20','../../models/User','dataJson','randomValue','getQuotedMessageId','body','queueId','../../helpers/CheckSettings','imageMessage','\x20iniciada\x20para\x20o\x20ticket\x20#','Erro\x20ao\x20processar\x20integração\x20para\x20fila\x20única:','getMessageMedia','slice','notification','env','promisify','thumbnail-','mkdir','../../helpers/GetPublicPath','error','getTime','value','DispatchConfirmedCampaign','chatBotType','getOwnPropertyDescriptor','displayCurrentMenu','normalizeThumbnailMediaType','log','getOwnPropertyNames','4838905wlGrIc','findAll','verifyDeleteMessage','4rnkCMO','profilePictureUrl','split','documentMessage','key','__setModuleDefault','extendedTextMessage','findOne','ack','substring','map','pending','EM_ANDAMENTO','verifyContact','../QueueIntegrationServices/ShowQueueIntegrationService','fromMe','campaignId','3311544GbrJEY','Configurações\x20do\x20WhatsApp\x20não\x20encontradas.','verifyMediaMessage','Failed\x20to\x20get\x20stream','toString','Integração\x20#','name','greetingMessage','apply','writable','quotedMsgId','remoteJid','queue-','video','./GetHandlers','Erro\x20ao\x20processar\x20integração\x20para\x20fila\x20escolhida:','directPath','join','\x20MiB','__esModule','participant','parseToMilliseconds','410220mBgkYv','update','url','logger','text','4186275TKAFDB','stream-throttle','downloadContentFromMessage','get','📎\x20','../../models/Campaign','../WhatsappService/ShowWhatsAppService','from','pipe','../../utils/logger','\x20já\x20processada\x20para\x20o\x20ticket\x20','1556847vDxsth','thumbnail-document','path','concat','company-','./SendWhatsAppMessage','>>>>\x20erro\x20','integrationId','whatsappId','constructor','../../models/Ticket','user','rate','verifyRating','mediaType','forEach','queue','ticketId','campaignQueue','amountUsedBotQueues','-ticket','replace','getIO','lodash','read','@whiskeysockets/baileys','\x20de\x20baixar\x20o\x20arquivo\x20','conversation','transferMessage','verifyRecentCampaign','filename','getUnpackedMessage','caption','chatbot','reload','../MessageServices/CreateMessageService','mimetype','writeFile','ERR_WAPP_DOWNLOAD_MEDIA','message','verifyEditedMessage','maxUseBotQueues','default','../../queues','setExtra','hasOwnProperty','contact','__importDefault'];a583_0x1296=function(){return _0x494963;};return a583_0x1296();}