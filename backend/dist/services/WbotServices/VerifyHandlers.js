'use strict';const a583_0x5bb4bf=a583_0x38e7;(function(_0x509a66,_0x1f0c8b){const _0x2d66dd=a583_0x38e7,_0x5a0fe3=_0x509a66();while(!![]){try{const _0x22946f=-parseInt(_0x2d66dd(0xf9))/0x1*(-parseInt(_0x2d66dd(0xb5))/0x2)+parseInt(_0x2d66dd(0x14e))/0x3+-parseInt(_0x2d66dd(0xbf))/0x4+-parseInt(_0x2d66dd(0xbe))/0x5+-parseInt(_0x2d66dd(0x10c))/0x6+-parseInt(_0x2d66dd(0x155))/0x7+parseInt(_0x2d66dd(0xd5))/0x8;if(_0x22946f===_0x1f0c8b)break;else _0x5a0fe3['push'](_0x5a0fe3['shift']());}catch(_0x2b9195){_0x5a0fe3['push'](_0x5a0fe3['shift']());}}}(a583_0x411d,0x54e8f));var __createBinding=this&&this[a583_0x5bb4bf(0x105)]||(Object[a583_0x5bb4bf(0xa7)]?function(_0x1b4a62,_0x532f44,_0x53077d,_0x53a005){const _0x80dd0e=a583_0x5bb4bf;if(_0x53a005===undefined)_0x53a005=_0x53077d;var _0x5b9dde=Object[_0x80dd0e(0xcc)](_0x532f44,_0x53077d);(!_0x5b9dde||(_0x80dd0e(0xca)in _0x5b9dde?!_0x532f44['__esModule']:_0x5b9dde[_0x80dd0e(0x139)]||_0x5b9dde[_0x80dd0e(0x15e)]))&&(_0x5b9dde={'enumerable':!![],'get':function(){return _0x532f44[_0x53077d];}}),Object[_0x80dd0e(0xce)](_0x1b4a62,_0x53a005,_0x5b9dde);}:function(_0x4c5dc5,_0x1726dc,_0x165ae2,_0xa7aadc){if(_0xa7aadc===undefined)_0xa7aadc=_0x165ae2;_0x4c5dc5[_0xa7aadc]=_0x1726dc[_0x165ae2];}),__setModuleDefault=this&&this[a583_0x5bb4bf(0x150)]||(Object[a583_0x5bb4bf(0xa7)]?function(_0x5c91f9,_0x23356c){const _0x63a50d=a583_0x5bb4bf;Object[_0x63a50d(0xce)](_0x5c91f9,'default',{'enumerable':!![],'value':_0x23356c});}:function(_0x58b768,_0x9fd8b1){const _0x4b5575=a583_0x5bb4bf;_0x58b768[_0x4b5575(0x113)]=_0x9fd8b1;}),__importStar=this&&this['__importStar']||(function(){const _0x3c5de5=(function(){let _0xe8d7c6=!![];return function(_0x263b47,_0x49c9e8){const _0x57f030=_0xe8d7c6?function(){const _0x572b30=a583_0x38e7;if(_0x49c9e8){const _0x5d14cb=_0x49c9e8[_0x572b30(0xaf)](_0x263b47,arguments);return _0x49c9e8=null,_0x5d14cb;}}:function(){};return _0xe8d7c6=![],_0x57f030;};}()),_0x4b7e1c=_0x3c5de5(this,function(){const _0xf26a03=a583_0x38e7;return _0x4b7e1c[_0xf26a03(0x141)]()[_0xf26a03(0xe6)](_0xf26a03(0x13d))['toString']()[_0xf26a03(0x143)](_0x4b7e1c)[_0xf26a03(0xe6)]('(((.+)+)+)+$');});_0x4b7e1c();var _0x59ba67=function(_0x5ca414){const _0x4b0abf=a583_0x38e7;return _0x59ba67=Object[_0x4b0abf(0x104)]||function(_0x143054){const _0x1e414c=_0x4b0abf;var _0x1757ba=[];for(var _0x930164 in _0x143054)if(Object['prototype'][_0x1e414c(0xa9)]['call'](_0x143054,_0x930164))_0x1757ba[_0x1757ba[_0x1e414c(0xff)]]=_0x930164;return _0x1757ba;},_0x59ba67(_0x5ca414);};return function(_0x35560c){const _0x1e6fbb=a583_0x38e7;if(_0x35560c&&_0x35560c[_0x1e6fbb(0x157)])return _0x35560c;var _0x188004={};if(_0x35560c!=null){for(var _0x1afa68=_0x59ba67(_0x35560c),_0x382ca7=0x0;_0x382ca7<_0x1afa68[_0x1e6fbb(0xff)];_0x382ca7++)if(_0x1afa68[_0x382ca7]!==_0x1e6fbb(0x113))__createBinding(_0x188004,_0x35560c,_0x1afa68[_0x382ca7]);}return __setModuleDefault(_0x188004,_0x35560c),_0x188004;};}()),__importDefault=this&&this[a583_0x5bb4bf(0xb7)]||function(_0x47f019){const _0x2e47c9=a583_0x5bb4bf;return _0x47f019&&_0x47f019[_0x2e47c9(0x157)]?_0x47f019:{'default':_0x47f019};};Object[a583_0x5bb4bf(0xce)](exports,'__esModule',{'value':!![]}),exports['verifyRecentCampaign']=exports[a583_0x5bb4bf(0xc9)]=exports[a583_0x5bb4bf(0x137)]=exports['verifyDeleteMessage']=exports[a583_0x5bb4bf(0xc4)]=exports[a583_0x5bb4bf(0x10d)]=exports[a583_0x5bb4bf(0xdd)]=exports[a583_0x5bb4bf(0x132)]=exports[a583_0x5bb4bf(0xb2)]=exports['normalizeMediaType']=void 0x0;const Message_1=__importDefault(require(a583_0x5bb4bf(0x148))),Ticket_1=__importDefault(require(a583_0x5bb4bf(0x14d))),Contact_1=__importDefault(require(a583_0x5bb4bf(0x106))),socket_1=require(a583_0x5bb4bf(0x15b)),baileys_1=require(a583_0x5bb4bf(0xf5)),CreateMessageService_1=__importDefault(require('../MessageServices/CreateMessageService')),GetHandlers_1=require(a583_0x5bb4bf(0xbb)),Queue_1=__importDefault(require(a583_0x5bb4bf(0xaa))),User_1=__importDefault(require(a583_0x5bb4bf(0xbc))),Sentry=__importStar(require(a583_0x5bb4bf(0x145))),CreateOrUpdateContactService_1=__importDefault(require('../ContactServices/CreateOrUpdateContactService')),stream_throttle_1=require(a583_0x5bb4bf(0x108)),MakeRandomId_1=require(a583_0x5bb4bf(0xc8)),CheckSettings_1=__importDefault(require(a583_0x5bb4bf(0xae))),GetHandlers_2=require('./GetHandlers'),GetPublicPath_1=require(a583_0x5bb4bf(0xed)),logger_1=require(a583_0x5bb4bf(0x129)),util_1=require('util'),fs_1=__importStar(require('fs')),path_1=require('path'),OldMessage_1=__importDefault(require('../../models/OldMessage')),ShowWhatsAppService_1=__importDefault(require(a583_0x5bb4bf(0xbd))),lodash_1=require(a583_0x5bb4bf(0x14a)),ShowQueueIntegrationService_1=__importDefault(require(a583_0x5bb4bf(0x152))),wbotMessageListener_1=require(a583_0x5bb4bf(0xfb)),Setting_1=__importDefault(require(a583_0x5bb4bf(0xab))),Campaign_1=__importDefault(require(a583_0x5bb4bf(0xc6))),CampaignShipping_1=__importDefault(require(a583_0x5bb4bf(0x110))),moment_1=__importDefault(require(a583_0x5bb4bf(0xf7))),queues_1=require(a583_0x5bb4bf(0xf3)),sequelize_1=require(a583_0x5bb4bf(0xd2)),SendWhatsAppMessage_1=__importDefault(require(a583_0x5bb4bf(0xe3))),Whatsapp_1=__importDefault(require('../../models/Whatsapp')),writeFileAsync=(0x0,util_1[a583_0x5bb4bf(0xd1)])(fs_1[a583_0x5bb4bf(0x140)]),saveMediaToFile=async(_0x2e56ea,_0x4a9673)=>{const _0x1cb7fb=a583_0x5bb4bf;if(!_0x2e56ea[_0x1cb7fb(0x14c)]){const _0x12df83=_0x2e56ea['mimetype'][_0x1cb7fb(0x160)]('/')[0x1][_0x1cb7fb(0x160)](';')[0x0];_0x2e56ea[_0x1cb7fb(0x14c)]=new Date()[_0x1cb7fb(0xf1)]()+'.'+_0x12df83;}const _0x25e3ef=(0x0,GetPublicPath_1['getPublicPath'])(),_0x496a43=(0x0,MakeRandomId_1['makeRandomId'])(0xa),_0x372e95=_0x1cb7fb(0x11d)+_0x4a9673[_0x1cb7fb(0x128)]+'/'+_0x4a9673[_0x1cb7fb(0x120)]+'/'+_0x4a9673['id']+'/'+_0x496a43;try{await fs_1[_0x1cb7fb(0x113)][_0x1cb7fb(0x117)][_0x1cb7fb(0xde)]((0x0,path_1[_0x1cb7fb(0x123)])(_0x25e3ef,_0x372e95),{'recursive':!![]}),await writeFileAsync((0x0,path_1['join'])(_0x25e3ef,_0x372e95,_0x2e56ea[_0x1cb7fb(0x14c)]),_0x2e56ea[_0x1cb7fb(0x13f)],_0x1cb7fb(0x151));}catch(_0x4dbd84){Sentry[_0x1cb7fb(0xda)](_0x4dbd84),logger_1['logger'][_0x1cb7fb(0xdf)](_0x4dbd84);}return _0x372e95+'/'+_0x2e56ea[_0x1cb7fb(0x14c)];},normalizeMediaType=_0x549916=>{const _0x187e21=a583_0x5bb4bf,_0x559f0e=['audio','video',_0x187e21(0xf6),_0x187e21(0x154)],_0x4e1a97=_0x549916[_0x187e21(0x160)]('/')[0x0];if(!_0x559f0e[_0x187e21(0xc5)](_0x4e1a97))return _0x187e21(0x154);return _0x4e1a97;};exports[a583_0x5bb4bf(0xc0)]=normalizeMediaType;const normalizeThumbnailMediaType=_0x4f9f6a=>{const _0xaca5b5=a583_0x5bb4bf,_0x2b5c23=[_0xaca5b5(0x10e),_0xaca5b5(0xcd),_0xaca5b5(0x127)],_0x3cd41c=_0x4f9f6a[_0xaca5b5(0x160)]('/')[0x0];if(!_0x2b5c23[_0xaca5b5(0xc5)](_0xaca5b5(0x112)+_0x3cd41c))return _0xaca5b5(0x127);return _0x3cd41c;};exports[a583_0x5bb4bf(0xb2)]=normalizeThumbnailMediaType;const downloadMedia=async(_0x42793b,_0x225e69,_0x3dc7a1)=>{const _0xe9f264=a583_0x5bb4bf,_0x41c112=(0x0,GetHandlers_2[_0xe9f264(0xe8)])(_0x42793b),_0x32fe8a=(0x0,GetHandlers_2[_0xe9f264(0xb3)])(_0x41c112);if(!_0x32fe8a)return null;const _0x52fe88=parseInt(await(0x0,CheckSettings_1[_0xe9f264(0x113)])(_0xe9f264(0xd8),'15'),0xa);if(_0x225e69&&_0x32fe8a?.['fileLength']&&+_0x32fe8a[_0xe9f264(0x13a)]>_0x52fe88*0x400*0x400){const _0x2467fa=_0xe9f264(0x13e)+_0x52fe88+'\x20MiB';if(!_0x3dc7a1['isGroup']){const _0x20ffba=await(0x0,SendWhatsAppMessage_1[_0xe9f264(0x113)])({'ticket':_0x3dc7a1,'body':_0x2467fa});_0x20ffba['message'][_0xe9f264(0xcb)][_0xe9f264(0xb1)]=_0xe9f264(0x14b);}throw new Error(_0xe9f264(0xba));}const _0x35f698=_0x41c112?.[_0xe9f264(0x130)]?_0xe9f264(0x154):(0x0,exports[_0xe9f264(0xc0)])(_0x32fe8a[_0xe9f264(0xb0)]);let _0x92c1d4,_0x4ab7c0=0x0;while(_0x4ab7c0<0xa&&!_0x92c1d4){try{const _0x3dbf34={..._0x32fe8a};_0x3dbf34?.[_0xe9f264(0xfd)]&&(_0x3dbf34[_0xe9f264(0xf8)]=''),_0x92c1d4=await(0x0,baileys_1[_0xe9f264(0x111)])(_0x3dbf34,_0x35f698);}catch(_0x4eca3d){_0x4ab7c0+=0x1,await new Promise(_0x51a91f=>{setTimeout(_0x51a91f,0x3e8*_0x4ab7c0*0x2);}),logger_1[_0xe9f264(0x103)]['warn'](_0xe9f264(0x124)+_0x4ab7c0+'\x20de\x20baixar\x20o\x20arquivo\x20'+_0x42793b?.[_0xe9f264(0xee)]?.['id']);}}if(!_0x92c1d4)throw new Error(_0xe9f264(0xd6));const _0x340fe1=await downloadStream(_0x92c1d4);if(!_0x340fe1){Sentry['setExtra'](_0xe9f264(0xb4),{'msg':_0x42793b}),Sentry[_0xe9f264(0xda)](new Error(_0xe9f264(0xb4)));throw new Error(_0xe9f264(0xb4));}let _0x3f3abc=_0x41c112?.[_0xe9f264(0x130)]?.[_0xe9f264(0xb6)]||'';if(!_0x3f3abc){const _0x394f14=_0x32fe8a[_0xe9f264(0xb0)]['split']('/')[0x1]['split'](';')[0x0];_0x3f3abc=(0x0,MakeRandomId_1[_0xe9f264(0xe2)])(0x5)+'-'+new Date()[_0xe9f264(0xf1)]()+'.'+_0x394f14;}else _0x3f3abc=_0x3f3abc['split']('.')[_0xe9f264(0xd7)](0x0,-0x1)['join']('.')+'.'+(0x0,MakeRandomId_1[_0xe9f264(0xe2)])(0x5)+'.'+_0x3f3abc['split']('.')[_0xe9f264(0xd7)](-0x1);const _0x2cec47={'data':_0x340fe1,'mimetype':_0x32fe8a[_0xe9f264(0xb0)],'filename':_0x3f3abc};return _0x2cec47;},downloadStream=async _0x417fa2=>{const _0xc3a650=a583_0x5bb4bf,_0x432919=0x5*0x400*0x400/0x8,_0x4bcd9d=0x400*0x400/0x8,_0x2cc4b5=0x400*0x400,_0x4b68b8=new stream_throttle_1[(_0xc3a650(0xea))]({'rate':_0x432919});let _0x2ef68b=Buffer[_0xc3a650(0x126)]([]),_0x504cff=0x0;try{for await(const _0x3f178f of _0x417fa2[_0xc3a650(0x11b)](_0x4b68b8)){_0x2ef68b=Buffer['concat']([_0x2ef68b,_0x3f178f]),_0x504cff+=_0x3f178f['length'],_0x504cff>_0x2cc4b5&&(_0x4b68b8[_0xc3a650(0xc1)]=_0x4bcd9d);}}catch(_0x381f13){Sentry[_0xc3a650(0xd4)]('ERR_WAPP_DOWNLOAD_MEDIA',{'error':_0x381f13}),Sentry[_0xc3a650(0xda)](new Error(_0xc3a650(0xb4)));throw new Error(_0xc3a650(0xb4));}return _0x2ef68b;},downloadThumbnail=async({thumbnailDirectPath:_0x547221,mediaKey:_0x3b5faf,mimetype:_0x22a808})=>{const _0x5b2943=a583_0x5bb4bf;if(!_0x547221||!_0x3b5faf)return null;const _0x481b64=await(0x0,baileys_1[_0x5b2943(0x111)])({'mediaKey':_0x3b5faf,'directPath':_0x547221},_0x22a808?(0x0,exports[_0x5b2943(0xb2)])(_0x22a808):_0x5b2943(0x158));if(!_0x481b64)throw new Error('Failed\x20to\x20get\x20stream');const _0x58c12c=await downloadStream(_0x481b64);if(!_0x58c12c)throw new Error(_0x5b2943(0xb4));const _0x23e07a='thumbnail-'+(0x0,MakeRandomId_1[_0x5b2943(0xe2)])(0x5)+'-'+new Date()[_0x5b2943(0xf1)]()+_0x5b2943(0x11a),_0x1855fd={'data':_0x58c12c,'mimetype':_0x5b2943(0x12d),'filename':_0x23e07a};return _0x1855fd;},verifyMessage=async(_0x54fb26,_0x2848b8,_0x12c382,_0x2019e0=null)=>{const _0x3bb4b0=a583_0x5bb4bf,_0x5b0ccb=(0x0,socket_1[_0x3bb4b0(0x133)])(),_0x112aa2=await verifyQuotedMessage(_0x54fb26),_0x58bbd=(0x0,GetHandlers_1[_0x3bb4b0(0xd0)])(_0x54fb26),_0x2725c1={'id':_0x54fb26[_0x3bb4b0(0xee)]['id'],'ticketId':_0x2848b8['id'],'userId':_0x2019e0,'contactId':_0x54fb26[_0x3bb4b0(0xee)][_0x3bb4b0(0x11e)]?undefined:_0x12c382['id'],'body':_0x58bbd,'fromMe':_0x54fb26[_0x3bb4b0(0xee)][_0x3bb4b0(0x11e)],'mediaType':_0x54fb26[_0x3bb4b0(0x15f)][_0x3bb4b0(0xdb)]?_0x3bb4b0(0xdb):null,'read':_0x54fb26[_0x3bb4b0(0xee)][_0x3bb4b0(0x11e)],'quotedMsgId':_0x112aa2?.['id'],'ack':_0x54fb26[_0x3bb4b0(0x161)],'remoteJid':_0x54fb26['key'][_0x3bb4b0(0x118)],'participant':_0x54fb26[_0x3bb4b0(0xee)][_0x3bb4b0(0xac)],'dataJson':JSON[_0x3bb4b0(0x153)](_0x54fb26),'isEdited':![]};await _0x2848b8[_0x3bb4b0(0x12c)]({'lastMessage':_0x58bbd[_0x3bb4b0(0x15d)](0x0,0xff)['replace'](/\n/g,'\x20')});const _0x5965cd=await(0x0,CreateMessageService_1[_0x3bb4b0(0x113)])({'messageData':_0x2725c1,'companyId':_0x2848b8[_0x3bb4b0(0x128)]});return!_0x54fb26[_0x3bb4b0(0xee)]['fromMe']&&_0x2848b8['status']===_0x3bb4b0(0x10b)&&(await _0x2848b8['update']({'status':_0x3bb4b0(0xfc)}),await _0x2848b8[_0x3bb4b0(0x146)]({'include':[{'model':Queue_1['default'],'as':_0x3bb4b0(0xcf)},{'model':User_1['default'],'as':_0x3bb4b0(0x142)},{'model':Contact_1[_0x3bb4b0(0x113)],'as':_0x3bb4b0(0x12e)}]}),_0x5b0ccb['to'](_0x3bb4b0(0x156)+_0x2848b8[_0x3bb4b0(0x128)]+_0x3bb4b0(0x121))['to'](_0x3bb4b0(0xc3)+_0x2848b8['queueId']+_0x3bb4b0(0x121))[_0x3bb4b0(0xef)]('company-'+_0x2848b8['companyId']+_0x3bb4b0(0xfe),{'action':_0x3bb4b0(0x147),'ticket':_0x2848b8,'ticketId':_0x2848b8['id']}),_0x5b0ccb['to']('company-'+_0x2848b8[_0x3bb4b0(0x128)]+'-'+_0x2848b8['status'])['to'](_0x3bb4b0(0xc3)+_0x2848b8[_0x3bb4b0(0x149)]+'-'+_0x2848b8['status'])['to'](_0x2848b8['id']['toString']())[_0x3bb4b0(0xef)](_0x3bb4b0(0x156)+_0x2848b8[_0x3bb4b0(0x128)]+_0x3bb4b0(0xfe),{'action':_0x3bb4b0(0x12c),'ticket':_0x2848b8,'ticketId':_0x2848b8['id']})),_0x5965cd;};function a583_0x38e7(_0x436815,_0x16f4f4){const _0x3b9ee1=a583_0x411d();return a583_0x38e7=function(_0x45bbc0,_0x51cef7){_0x45bbc0=_0x45bbc0-0xa7;let _0x411d5c=_0x3b9ee1[_0x45bbc0];return _0x411d5c;},a583_0x38e7(_0x436815,_0x16f4f4);}exports[a583_0x5bb4bf(0x132)]=verifyMessage;const verifyQuotedMessage=async _0x4e00d3=>{const _0x53adb0=a583_0x5bb4bf;if(!_0x4e00d3)return null;const _0x421d34=(0x0,GetHandlers_1['getQuotedMessageId'])(_0x4e00d3);if(!_0x421d34)return null;const _0x2db9e5=await Message_1[_0x53adb0(0x113)][_0x53adb0(0x102)]({'where':{'id':_0x421d34}});if(!_0x2db9e5)return null;return _0x2db9e5;},verifyContact=async(_0x41a0e5,_0x172eee,_0x4638ee)=>{const _0x516dbe=a583_0x5bb4bf;let _0x268d78;try{_0x268d78=await _0x172eee[_0x516dbe(0x10f)](_0x41a0e5['id']);}catch(_0x269cce){Sentry[_0x516dbe(0xda)](_0x269cce),_0x268d78=process['env'][_0x516dbe(0xb8)]+_0x516dbe(0x15a);}const _0x3fd39a={'name':_0x41a0e5?.[_0x516dbe(0xc2)]||_0x41a0e5['id'][_0x516dbe(0xe0)](/\D/g,''),'number':_0x41a0e5['id'][_0x516dbe(0x15d)](0x0,_0x41a0e5['id'][_0x516dbe(0x13b)]('@')),'profilePicUrl':_0x268d78,'isGroup':_0x41a0e5['id'][_0x516dbe(0xc5)]('g.us'),'companyId':_0x4638ee},_0x2e0269=(0x0,CreateOrUpdateContactService_1[_0x516dbe(0x113)])(_0x3fd39a);return _0x2e0269;};exports[a583_0x5bb4bf(0xdd)]=verifyContact;const verifyMediaMessage=async(_0x1c0902,_0x4316a7,_0xc34ed3,_0x45b552=null,_0x570662=null,_0xa31ac3=null)=>{const _0x560ab6=a583_0x5bb4bf,_0x76115a=(0x0,socket_1[_0x560ab6(0x133)])(),_0x49e321=await verifyQuotedMessage(_0x1c0902),_0x41b2a2=_0x570662||_0x1c0902?.[_0x560ab6(0x15f)]?.[_0x560ab6(0xcb)],_0x3f656d=_0x41b2a2&&await downloadThumbnail(_0x41b2a2),_0x334189=await downloadMedia(_0x1c0902,_0x45b552,_0x4316a7);if(!_0x334189&&!_0x3f656d)throw new Error(_0x560ab6(0xb4));let _0x93b2f0=null;_0x334189&&(_0x93b2f0=await saveMediaToFile(_0x334189,_0x4316a7));let _0x5254da=null;_0x3f656d&&(_0x5254da=await saveMediaToFile(_0x3f656d,_0x4316a7));const _0x1ff734=(0x0,GetHandlers_1[_0x560ab6(0xd0)])(_0x1c0902),_0x1072b1={'id':_0x1c0902['key']['id'],'ticketId':_0x4316a7['id'],'userId':_0xa31ac3,'contactId':_0x1c0902[_0x560ab6(0xee)]['fromMe']?undefined:_0xc34ed3['id'],'body':_0x1ff734||'','fromMe':_0x1c0902[_0x560ab6(0xee)][_0x560ab6(0x11e)],'read':_0x1c0902[_0x560ab6(0xee)][_0x560ab6(0x11e)],'mediaUrl':_0x93b2f0,'mediaType':_0x334189?.['mimetype'][_0x560ab6(0x160)]('/')[0x0],'thumbnailUrl':_0x5254da,'quotedMsgId':_0x49e321?.['id'],'ack':_0x1c0902['status'],'remoteJid':_0x1c0902[_0x560ab6(0xee)][_0x560ab6(0x118)],'participant':_0x1c0902['key'][_0x560ab6(0xac)],'dataJson':JSON[_0x560ab6(0x153)](_0x1c0902)};await _0x4316a7[_0x560ab6(0x12c)]({'lastMessage':_0x1ff734||_0x334189?.[_0x560ab6(0x14c)]?_0x560ab6(0xdc)+_0x334189?.[_0x560ab6(0x14c)]:''});const _0x4d651f=await(0x0,CreateMessageService_1[_0x560ab6(0x113)])({'messageData':_0x1072b1,'companyId':_0x4316a7[_0x560ab6(0x128)]});return!_0x1c0902['key'][_0x560ab6(0x11e)]&&_0x4316a7[_0x560ab6(0x161)]==='closed'&&(await _0x4316a7['update']({'status':_0x560ab6(0xfc)}),await _0x4316a7[_0x560ab6(0x146)]({'include':[{'model':Queue_1['default'],'as':_0x560ab6(0xcf)},{'model':User_1[_0x560ab6(0x113)],'as':'user'},{'model':Contact_1[_0x560ab6(0x113)],'as':_0x560ab6(0x12e)}]}),_0x76115a['to'](_0x560ab6(0x156)+_0x4316a7['companyId']+_0x560ab6(0x121))['to'](_0x560ab6(0xc3)+_0x4316a7[_0x560ab6(0x149)]+'-closed')[_0x560ab6(0xef)]('company-'+_0x4316a7[_0x560ab6(0x128)]+_0x560ab6(0xfe),{'action':_0x560ab6(0x147),'ticket':_0x4316a7,'ticketId':_0x4316a7['id']}),_0x76115a['to'](_0x560ab6(0x156)+_0x4316a7[_0x560ab6(0x128)]+'-'+_0x4316a7[_0x560ab6(0x161)])['to'](_0x560ab6(0xc3)+_0x4316a7[_0x560ab6(0x149)]+'-'+_0x4316a7[_0x560ab6(0x161)])['to'](_0x4316a7['id']['toString']())[_0x560ab6(0xef)](_0x560ab6(0x156)+_0x4316a7['companyId']+'-ticket',{'action':_0x560ab6(0x12c),'ticket':_0x4316a7,'ticketId':_0x4316a7['id']})),_0x4d651f;};exports[a583_0x5bb4bf(0x10d)]=verifyMediaMessage;const verifyEditedMessage=async(_0x281d51,_0x5b0bfe,_0x384304)=>{const _0x290f4a=a583_0x5bb4bf,_0x16c3bb=(0x0,GetHandlers_2[_0x290f4a(0x134)])(_0x281d51);let _0x9a4ef5;switch(_0x16c3bb){case _0x290f4a(0x144):{_0x9a4ef5=_0x281d51[_0x290f4a(0x144)];break;}case _0x290f4a(0xcb):{_0x9a4ef5=_0x281d51[_0x290f4a(0xcb)][_0x290f4a(0xb1)];break;}case'imageMessage':{_0x9a4ef5=_0x281d51[_0x290f4a(0x125)]['caption'];break;}case _0x290f4a(0x130):{_0x9a4ef5=_0x281d51[_0x290f4a(0x130)][_0x290f4a(0x100)];break;}case _0x290f4a(0xe7):{_0x9a4ef5=_0x281d51[_0x290f4a(0xe7)][_0x290f4a(0x15f)][_0x290f4a(0x130)][_0x290f4a(0x100)];break;}default:{return;}}const _0x50538c=await Message_1[_0x290f4a(0x113)][_0x290f4a(0x107)](_0x384304),_0x1ae02f={'id':_0x50538c['id'],'ticketId':_0x50538c['ticketId'],'contactId':_0x50538c['contactId'],'body':_0x9a4ef5,'fromMe':_0x50538c[_0x290f4a(0x11e)],'mediaType':_0x50538c[_0x290f4a(0x162)],'read':_0x50538c[_0x290f4a(0xe4)],'quotedMsgId':_0x50538c['quotedMsgId'],'ack':_0x50538c['ack'],'remoteJid':_0x50538c[_0x290f4a(0x118)],'participant':_0x50538c[_0x290f4a(0xac)],'dataJson':_0x50538c[_0x290f4a(0x163)],'isEdited':!![]},_0x2a61ed={'messageId':_0x1ae02f['id'],'body':_0x50538c[_0x290f4a(0xad)],'ticketId':_0x50538c['ticketId']};await OldMessage_1[_0x290f4a(0x113)][_0x290f4a(0x116)](_0x2a61ed),await _0x5b0bfe['update']({'lastMessage':_0x1ae02f['body']}),await(0x0,CreateMessageService_1[_0x290f4a(0x113)])({'messageData':_0x1ae02f,'companyId':_0x5b0bfe[_0x290f4a(0x128)]});const _0x534f23=(0x0,socket_1[_0x290f4a(0x133)])();_0x534f23['to'](_0x5b0bfe[_0x290f4a(0x161)])['to'](_0x5b0bfe['id'][_0x290f4a(0x141)]())['emit'](_0x290f4a(0x156)+_0x5b0bfe[_0x290f4a(0x128)]+'-ticket',{'action':_0x290f4a(0x12c),'ticket':_0x5b0bfe,'ticketId':_0x5b0bfe['id']});};function a583_0x411d(){const _0x918b05=['(((.+)+)+)+$','*Mensagem\x20Automática*:\x0aNosso\x20sistema\x20aceita\x20apenas\x20arquivos\x20com\x20no\x20máximo\x20','data','writeFile','toString','user','constructor','conversation','@sentry/node','reload','delete','../../models/Message','queueId','lodash','*Mensagem\x20do\x20sistema*:\x0aArquivo\x20recebido\x20além\x20do\x20limite\x20de\x20tamanho\x20do\x20sistema,\x20se\x20for\x20necessário\x20ele\x20pode\x20ser\x20obtido\x20no\x20aplicativo\x20do\x20whatsapp.','filename','../../models/Ticket','1049517glCVct','campaignQueue','__setModuleDefault','base64','../QueueIntegrationServices/ShowQueueIntegrationService','stringify','document','1809374bNjNuR','company-','__esModule','thumbnail-link','value','/nopicture.png','../../libs/socket','amountUsedBotQueues','substring','configurable','message','split','status','mediaType','dataJson','create','EM_ANDAMENTO','hasOwnProperty','../../models/Queue','../../models/Setting','participant','body','../../helpers/CheckSettings','apply','mimetype','text','normalizeThumbnailMediaType','getMessageMedia','ERR_WAPP_DOWNLOAD_MEDIA','18qYsrBA','fileName','__importDefault','FRONTEND_URL','maxUseBotQueues','ERR_FILESIZE_OVER_LIMIT','./GetHandlers','../../models/User','../WhatsappService/ShowWhatsAppService','1753110LGKUbH','1146024RtUbls','normalizeMediaType','rate','name','queue-','verifyEditedMessage','includes','../../models/Campaign','campaignId','../../helpers/MakeRandomId','verifyRating','get','extendedTextMessage','getOwnPropertyDescriptor','thumbnail-image','defineProperty','queue','getBodyMessage','promisify','sequelize','-appMessage','setExtra','7946472aGRLWs','Failed\x20to\x20get\x20stream','slice','downloadLimit','\x20iniciada\x20para\x20o\x20ticket\x20#','captureException','reactionMessage','📎\x20','verifyContact','mkdir','error','replace','ticketId','makeRandomId','./SendWhatsAppMessage','read','Configurações\x20do\x20WhatsApp\x20não\x20encontradas.','search','documentWithCaptionMessage','getUnpackedMessage','userId','Throttle','map','notification','../../helpers/GetPublicPath','key','emit','greetingMessage','getTime','displayCurrentMenu','../../queues','\x20já\x20processada\x20para\x20o\x20ticket\x20','@whiskeysockets/baileys','image','moment','url','28088wzZaJt','add','./wbotMessageListener','pending','directPath','-ticket','length','caption','Erro\x20ao\x20processar\x20integração\x20para\x20fila\x20escolhida:','findOne','logger','getOwnPropertyNames','__createBinding','../../models/Contact','findByPk','stream-throttle','options','log','closed','2115234ckwzAm','verifyMediaMessage','thumbnail-video','profilePictureUrl','../../models/CampaignShipping','downloadContentFromMessage','thumbnail-','default','randomValue','forEach','upsert','promises','remoteJid','.\x20Ignorando\x20em\x20verifyQueue.','.jpg','pipe','ticket','media/','fromMe','finishedAt','contactId','-closed','lastProcessedMessageId','join','>>>>\x20erro\x20','imageMessage','from','thumbnail-document','companyId','../../utils/logger','useIntegration','transferMessage','update','image/jpeg','contact','handleMessageIntegration','documentMessage','integrationId','verifyMessage','getIO','getTypeEditedMessage','isGroup','Erro\x20ao\x20processar\x20integração\x20para\x20fila\x20única:','verifyQueue','parseToMilliseconds','writable','fileLength','indexOf','Integração\x20#'];a583_0x411d=function(){return _0x918b05;};return a583_0x411d();}exports[a583_0x5bb4bf(0xc4)]=verifyEditedMessage;const verifyDeleteMessage=async(_0x460f1d,_0x46ba82)=>{const _0x322c16=a583_0x5bb4bf,_0x50717b=await Message_1[_0x322c16(0x113)][_0x322c16(0x107)](_0x460f1d[_0x322c16(0xee)]['id'],{'include':[_0x322c16(0x12e),{'model':Ticket_1['default'],'include':[{'model':Contact_1[_0x322c16(0x113)]}]}]});if(!_0x50717b)return;await _0x50717b[_0x322c16(0x12c)]({'isDeleted':!![]});const _0x2cef64=(0x0,socket_1[_0x322c16(0x133)])();_0x2cef64['to'](_0x50717b[_0x322c16(0xe1)][_0x322c16(0x141)]())['to'](_0x50717b[_0x322c16(0x11c)]['status'])['to'](_0x322c16(0xec))[_0x322c16(0xef)](_0x322c16(0x156)+_0x46ba82[_0x322c16(0x128)]+_0x322c16(0xd3),{'action':_0x322c16(0xa7),'message':_0x50717b,'ticket':_0x50717b[_0x322c16(0x11c)],'contact':_0x50717b[_0x322c16(0x11c)][_0x322c16(0x12e)]});};exports['verifyDeleteMessage']=verifyDeleteMessage;const verifyQueue=async(_0x2239a7,_0x1cbb35,_0x1181cc,_0x287e93)=>{const _0x8eb15b=a583_0x5bb4bf;if(_0x1cbb35?.['key']['id']&&_0x1181cc[_0x8eb15b(0x122)]===_0x1cbb35['key']['id']){console[_0x8eb15b(0x10a)]('Mensagem\x20'+_0x1cbb35['key']['id']+_0x8eb15b(0xf4)+_0x1181cc['id']+_0x8eb15b(0x119));return;}_0x1cbb35?.[_0x8eb15b(0xee)]['id']&&await _0x1181cc[_0x8eb15b(0x12c)]({'lastProcessedMessageId':_0x1cbb35[_0x8eb15b(0xee)]['id']});const _0x4a497c=await(0x0,ShowWhatsAppService_1[_0x8eb15b(0x113)])(_0x2239a7['id'],_0x1181cc[_0x8eb15b(0x128)]),{queues:_0x1be437,greetingMessage:_0x4bada4}=_0x4a497c,_0x37e567=await Setting_1[_0x8eb15b(0x113)][_0x8eb15b(0x102)]({'where':{'key':'chatBotType','companyId':_0x1181cc[_0x8eb15b(0x128)]}});if(_0x1be437[_0x8eb15b(0xff)]===0x1){const _0x1ee9a1=(0x0,lodash_1['head'])(_0x1be437);if(!_0x1ee9a1)return;const _0x2b9f1e=_0x1ee9a1?.[_0x8eb15b(0x109)]?.[_0x8eb15b(0xff)]>0x0;await _0x1181cc[_0x8eb15b(0x12c)]({'amountUsedBotQueues':0x0,'queueOptionId':null});if(!_0x1181cc[_0x8eb15b(0x12a)]&&_0x1ee9a1[_0x8eb15b(0x131)]&&!_0x1cbb35?.[_0x8eb15b(0xee)][_0x8eb15b(0x11e)]&&!_0x1181cc['isGroup'])try{const _0x22d611=await(0x0,ShowQueueIntegrationService_1[_0x8eb15b(0x113)])(_0x1ee9a1[_0x8eb15b(0x131)],_0x1181cc[_0x8eb15b(0x128)]);if(_0x22d611){await _0x1181cc[_0x8eb15b(0x12c)]({'useIntegration':!![],'integrationId':_0x22d611['id'],'amountUsedBotQueues':0x0});_0x1cbb35&&await(0x0,wbotMessageListener_1[_0x8eb15b(0x12f)])(_0x1cbb35,_0x2239a7,_0x22d611,_0x1181cc);console[_0x8eb15b(0x10a)](_0x8eb15b(0x13c)+_0x22d611['id']+'\x20iniciada\x20para\x20o\x20ticket\x20#'+_0x1181cc['id']);return;}}catch(_0x543650){console['error'](_0x8eb15b(0x136),_0x543650),await _0x1181cc[_0x8eb15b(0x12c)]({'useIntegration':![],'integrationId':null});}await _0x1181cc[_0x8eb15b(0x12c)]({'queueId':_0x1ee9a1['id'],'chatbot':_0x2b9f1e});_0x1ee9a1[_0x8eb15b(0xf0)]&&await(0x0,SendWhatsAppMessage_1[_0x8eb15b(0x113)])({'ticket':_0x1181cc,'body':_0x1ee9a1[_0x8eb15b(0xf0)]});_0x2b9f1e&&await(0x0,wbotMessageListener_1[_0x8eb15b(0xf2)])(_0x1181cc,_0x2239a7);return;}const _0x5d12aa=_0x1cbb35?(0x0,GetHandlers_1[_0x8eb15b(0xd0)])(_0x1cbb35):null,_0x494b4d=_0x5d12aa?_0x1be437[+_0x5d12aa-0x1]:null;if(_0x494b4d){await _0x1181cc[_0x8eb15b(0x12c)]({'amountUsedBotQueues':0x0,'queueOptionId':null});if(!_0x1181cc['useIntegration']&&_0x494b4d[_0x8eb15b(0x131)]&&!_0x1cbb35?.[_0x8eb15b(0xee)][_0x8eb15b(0x11e)]&&!_0x1181cc[_0x8eb15b(0x135)])try{const _0x21da78=await(0x0,ShowQueueIntegrationService_1[_0x8eb15b(0x113)])(_0x494b4d[_0x8eb15b(0x131)],_0x1181cc['companyId']);if(_0x21da78){await _0x1181cc[_0x8eb15b(0x12c)]({'useIntegration':!![],'integrationId':_0x21da78['id']}),await(0x0,wbotMessageListener_1['handleMessageIntegration'])(_0x1cbb35,_0x2239a7,_0x21da78,_0x1181cc),console[_0x8eb15b(0x10a)](_0x8eb15b(0x13c)+_0x21da78['id']+_0x8eb15b(0xd9)+_0x1181cc['id']);return;}}catch(_0x1a91c7){console[_0x8eb15b(0xdf)](_0x8eb15b(0x101),_0x1a91c7),await _0x1181cc[_0x8eb15b(0x12c)]({'useIntegration':![],'integrationId':null});}const _0xe814c5=_0x494b4d?.['options']?.[_0x8eb15b(0xff)]>0x0;await _0x1181cc[_0x8eb15b(0x12c)]({'queueId':_0x494b4d['id'],'chatbot':_0xe814c5});_0x494b4d[_0x8eb15b(0xf0)]&&await(0x0,SendWhatsAppMessage_1[_0x8eb15b(0x113)])({'ticket':_0x1181cc,'body':_0x494b4d[_0x8eb15b(0xf0)]});_0xe814c5&&await(0x0,wbotMessageListener_1[_0x8eb15b(0xf2)])(_0x1181cc,_0x2239a7);return;}const _0x3d5544=await Whatsapp_1['default'][_0x8eb15b(0x107)](_0x1181cc['whatsappId']);if(!_0x3d5544){console[_0x8eb15b(0xdf)](_0x8eb15b(0xe5));return;}if(!_0x1181cc['chatbot']&&_0x1181cc[_0x8eb15b(0x15c)]>=_0x3d5544[_0x8eb15b(0xb9)])return;if(_0x1cbb35&&_0x5d12aa&&!_0x494b4d){if(_0x3d5544[_0x8eb15b(0xb9)]&&_0x3d5544[_0x8eb15b(0xb9)]!==0x0&&_0x1181cc[_0x8eb15b(0x15c)]>=_0x3d5544[_0x8eb15b(0xb9)]){await _0x1181cc[_0x8eb15b(0x12c)]({'chatbot':![],'queueOptionId':null,'amountUsedBotQueues':_0x3d5544[_0x8eb15b(0xb9)]});_0x3d5544[_0x8eb15b(0x12b)]&&await(0x0,SendWhatsAppMessage_1[_0x8eb15b(0x113)])({'ticket':_0x1181cc,'body':_0x3d5544[_0x8eb15b(0x12b)]});return;}await _0x1181cc[_0x8eb15b(0x12c)]({'amountUsedBotQueues':_0x1181cc[_0x8eb15b(0x15c)]+0x1}),await _0x1181cc['reload']();}const _0x2f8fac=async()=>{const _0x305ae9=_0x8eb15b;let _0x66b3d5='';_0x1be437[_0x305ae9(0x115)]((_0x10b135,_0x32e007)=>{const _0x176bbc=_0x305ae9;_0x66b3d5+='*'+(_0x32e007+0x1)+'*\x20-\x20'+_0x10b135[_0x176bbc(0xc2)]+'\x0a';});const _0x3c1fa7=_0x4bada4+'\x0a\x0a'+_0x66b3d5;await(0x0,SendWhatsAppMessage_1[_0x305ae9(0x113)])({'ticket':_0x1181cc,'body':_0x3c1fa7});};switch(_0x37e567?.[_0x8eb15b(0x159)]){case _0x8eb15b(0xb1):default:await _0x2f8fac();break;}};exports[a583_0x5bb4bf(0x137)]=verifyQueue;const verifyRating=_0x26223d=>{const _0x2ba642=a583_0x5bb4bf;if(_0x26223d&&_0x26223d[_0x2ba642(0x11f)]===null&&_0x26223d[_0x2ba642(0xe9)]!==null&&_0x26223d['ratingAt']!==null)return!![];return![];};exports[a583_0x5bb4bf(0xc9)]=verifyRating;const verifyRecentCampaign=async(_0x578daa,_0x37622b)=>{const _0xee336c=a583_0x5bb4bf;if(!_0x578daa[_0xee336c(0xee)][_0xee336c(0x11e)]){const _0x3f13ce=_0x578daa[_0xee336c(0xee)][_0xee336c(0x118)]['replace'](/\D/g,''),_0x10f364=await Campaign_1[_0xee336c(0x113)]['findAll']({'where':{'companyId':_0x37622b,'status':_0xee336c(0xa8),'confirmation':!![]}});if(_0x10f364){const _0xa84a4=_0x10f364[_0xee336c(0xeb)](_0x2814d2=>_0x2814d2['id']),_0x2f4929=await CampaignShipping_1['default'][_0xee336c(0x102)]({'where':{'campaignId':{[sequelize_1['Op']['in']]:_0xa84a4},'number':_0x3f13ce,'confirmation':null}});if(_0x2f4929)return await _0x2f4929[_0xee336c(0x12c)]({'confirmedAt':(0x0,moment_1[_0xee336c(0x113)])(),'confirmation':!![]}),await queues_1[_0xee336c(0x14f)][_0xee336c(0xfa)]('DispatchConfirmedCampaign',{'campaignShippingId':_0x2f4929['id'],'campaignId':_0x2f4929[_0xee336c(0xc7)]},{'delay':(0x0,queues_1[_0xee336c(0x138)])((0x0,queues_1[_0xee336c(0x114)])(0x0,0xa))}),!![];}}return![];};exports['verifyRecentCampaign']=verifyRecentCampaign;