const a667_0x2a8538=a667_0x4335;(function(_0x419b1a,_0x34ee45){const _0x36907b=a667_0x4335,_0x79ceeb=_0x419b1a();while(!![]){try{const _0x134eac=parseInt(_0x36907b(0x16b))/0x1*(parseInt(_0x36907b(0x18d))/0x2)+parseInt(_0x36907b(0x161))/0x3+parseInt(_0x36907b(0x157))/0x4*(-parseInt(_0x36907b(0x178))/0x5)+parseInt(_0x36907b(0x16c))/0x6+-parseInt(_0x36907b(0x15e))/0x7*(-parseInt(_0x36907b(0x154))/0x8)+-parseInt(_0x36907b(0x160))/0x9+parseInt(_0x36907b(0x173))/0xa;if(_0x134eac===_0x34ee45)break;else _0x79ceeb['push'](_0x79ceeb['shift']());}catch(_0x3a3759){_0x79ceeb['push'](_0x79ceeb['shift']());}}}(a667_0x3ee3,0x58330));function a667_0x4335(_0x31b9d1,_0x360c60){const _0x537acc=a667_0x3ee3();return a667_0x4335=function(_0x3c4010,_0x17960a){_0x3c4010=_0x3c4010-0x151;let _0x3ee3b3=_0x537acc[_0x3c4010];return _0x3ee3b3;},a667_0x4335(_0x31b9d1,_0x360c60);}const a667_0x17960a=(function(){let _0x447002=!![];return function(_0x4728d5,_0x5a87a3){const _0x54edd8=_0x447002?function(){if(_0x5a87a3){const _0x2036dc=_0x5a87a3['apply'](_0x4728d5,arguments);return _0x5a87a3=null,_0x2036dc;}}:function(){};return _0x447002=![],_0x54edd8;};}()),a667_0x3c4010=a667_0x17960a(this,function(){const _0x1be6a6=a667_0x4335;return a667_0x3c4010[_0x1be6a6(0x163)]()['search']('(((.+)+)+)+$')['toString']()['constructor'](a667_0x3c4010)['search']('(((.+)+)+)+$');});a667_0x3c4010();'use strict';var __importDefault=this&&this[a667_0x2a8538(0x16d)]||function(_0x26ff95){return _0x26ff95&&_0x26ff95['__esModule']?_0x26ff95:{'default':_0x26ff95};};function a667_0x3ee3(){const _0x25e57c=['tags','../../models/Message','user','messages','contact','groupsTab','startOfDay','../../helpers/CheckSettings','trim','queues','findAndCountAll','col','map','sequelize','date-fns','../../models/Contact','../../models/Ticket','../UserServices/ShowUserService','defineProperty','presence','1438mGSWfF','pending','between','length','__esModule','true','LIKE','push','558952XoyfLy','profile','color','4jeQWyH','whatsapp','closed','admin','endOfDay','disabled','isGroup','7fiwtxC','where','1656603OOrzGN','1085172EOYpKB','findAll','toString','updatedAt','object','DESC','isArray','body','GetCompanySetting','../../models/Queue','524lbQfPr','276882nCSCXq','__importDefault','LOWER','name','intersection','like','parseISO','1097690OfxFSK','default','notIn','queue','contact.name','2094670VxgKGR'];a667_0x3ee3=function(){return _0x25e57c;};return a667_0x3ee3();}Object[a667_0x2a8538(0x18b)](exports,a667_0x2a8538(0x191),{'value':!![]});const sequelize_1=require(a667_0x2a8538(0x186)),date_fns_1=require(a667_0x2a8538(0x187)),lodash_1=require('lodash'),Ticket_1=__importDefault(require(a667_0x2a8538(0x189))),Contact_1=__importDefault(require(a667_0x2a8538(0x188))),Message_1=__importDefault(require(a667_0x2a8538(0x17a))),Queue_1=__importDefault(require(a667_0x2a8538(0x16a))),User_1=__importDefault(require('../../models/User')),ShowUserService_1=__importDefault(require(a667_0x2a8538(0x18a))),Tag_1=__importDefault(require('../../models/Tag')),TicketTag_1=__importDefault(require('../../models/TicketTag')),Whatsapp_1=__importDefault(require('../../models/Whatsapp')),CheckSettings_1=require(a667_0x2a8538(0x180)),ListTicketsService=async({isSearch:isSearch=![],searchParam:searchParam='',pageNumber:pageNumber='1',queueIds:_0x367077,tags:_0x362674,users:_0x48fb14,status:_0x88e9e5,groups:_0x1808c1,date:_0x5c9423,updatedAt:_0x8a190c,showAll:_0x3452e5,userId:_0x42efc0,withUnreadMessages:_0x393133,notClosed:_0xdea1e1,all:_0x164429,companyId:_0x2ab573})=>{const _0x418a79=a667_0x2a8538,_0x3b3cd8=!isSearch&&await(0x0,CheckSettings_1[_0x418a79(0x169)])(_0x2ab573,_0x418a79(0x17e),_0x418a79(0x15c))==='enabled',_0x28443b=await(0x0,ShowUserService_1[_0x418a79(0x174)])(_0x42efc0);let _0x3b0f4b={};const _0x510dae=_0x3452e5===_0x418a79(0x151),_0x3b983e=()=>{if(_0x367077['length']>0x0)return{[sequelize_1['Op']['or']]:[{[sequelize_1['Op']['in']]:_0x367077},null]};return{[sequelize_1['Op']['or']]:[{[sequelize_1['Op']['ne']]:null},null]};},_0x4f4422=_0x88e9e5===_0x418a79(0x18e);if(_0x28443b[_0x418a79(0x155)]===_0x418a79(0x15a))_0x510dae?_0x3b0f4b={'queueId':_0x3b983e()}:_0x4f4422?_0x3b0f4b={'queueId':_0x3b983e(),'userId':null}:_0x3b0f4b={'userId':_0x28443b['id']};else{if(_0x28443b[_0x418a79(0x155)]==='superv'){const _0x438e16=await User_1[_0x418a79(0x174)][_0x418a79(0x162)]({'where':{'companyId':_0x2ab573,'profile':_0x418a79(0x15a)},'attributes':['id']}),_0x11c05b=_0x438e16[_0x418a79(0x185)](_0x175aa0=>_0x175aa0['id']);_0x510dae?_0x3b0f4b={'queueId':_0x3b983e(),[sequelize_1['Op']['or']]:[{'userId':{[sequelize_1['Op'][_0x418a79(0x175)]]:_0x11c05b}},{'userId':null}]}:_0x4f4422?_0x3b0f4b={'queueId':_0x3b983e(),'userId':null}:_0x3b0f4b={'userId':_0x28443b['id']};}else _0x367077[_0x418a79(0x190)]===0x0?_0x3b0f4b={'userId':_0x28443b['id'],'queueId':null}:_0x3b0f4b={[sequelize_1['Op']['or']]:[{'userId':_0x28443b['id']},{'status':_0x418a79(0x18e),'queueId':{[sequelize_1['Op']['in']]:_0x367077}}]};}_0x3b3cd8&&(typeof _0x3b0f4b===_0x418a79(0x165)&&!Array[_0x418a79(0x167)](_0x3b0f4b)&&(_0x3b0f4b={..._0x3b0f4b,'isGroup':_0x1808c1===_0x418a79(0x151)}));let _0x206ded;_0x206ded=[{'model':Contact_1[_0x418a79(0x174)],'as':_0x418a79(0x17d),'attributes':['id',_0x418a79(0x16f),'number','email','profilePicUrl',_0x418a79(0x18c)]},{'model':Queue_1[_0x418a79(0x174)],'as':_0x418a79(0x176),'attributes':['id',_0x418a79(0x16f),_0x418a79(0x156)]},{'model':User_1['default'],'as':_0x418a79(0x17b),'attributes':['id',_0x418a79(0x16f)]},{'model':Tag_1[_0x418a79(0x174)],'as':_0x418a79(0x179),'attributes':['id','name',_0x418a79(0x156)]},{'model':Whatsapp_1['default'],'as':_0x418a79(0x158),'attributes':['id','name']}];_0x88e9e5&&(_0x3b0f4b={..._0x3b0f4b,'status':_0x88e9e5});if(searchParam){const _0x3847a6=searchParam['toLocaleLowerCase']()[_0x418a79(0x181)]();_0x206ded=[..._0x206ded,{'model':Message_1[_0x418a79(0x174)],'as':_0x418a79(0x17c),'attributes':['id','body'],'where':{'body':(0x0,sequelize_1[_0x418a79(0x15f)])((0x0,sequelize_1['fn'])(_0x418a79(0x16e),(0x0,sequelize_1[_0x418a79(0x184)])(_0x418a79(0x168))),'LIKE','%'+_0x3847a6+'%')},'required':![],'duplicating':![]}],_0x3b0f4b={..._0x3b0f4b,[sequelize_1['Op']['or']]:[{'$contact.name$':(0x0,sequelize_1[_0x418a79(0x15f)])((0x0,sequelize_1['fn'])('LOWER',(0x0,sequelize_1['col'])(_0x418a79(0x177))),_0x418a79(0x152),'%'+_0x3847a6+'%')},{'$contact.number$':{[sequelize_1['Op'][_0x418a79(0x171)]]:'%'+_0x3847a6+'%'}},{'$message.body$':(0x0,sequelize_1[_0x418a79(0x15f)])((0x0,sequelize_1['fn'])(_0x418a79(0x16e),(0x0,sequelize_1[_0x418a79(0x184)])(_0x418a79(0x168))),_0x418a79(0x152),'%'+_0x3847a6+'%')}]};}_0x5c9423&&(_0x3b0f4b={'createdAt':{[sequelize_1['Op'][_0x418a79(0x18f)]]:[+(0x0,date_fns_1[_0x418a79(0x17f)])((0x0,date_fns_1['parseISO'])(_0x5c9423)),+(0x0,date_fns_1['endOfDay'])((0x0,date_fns_1['parseISO'])(_0x5c9423))]}});_0x8a190c&&(_0x3b0f4b={'updatedAt':{[sequelize_1['Op'][_0x418a79(0x18f)]]:[+(0x0,date_fns_1[_0x418a79(0x17f)])((0x0,date_fns_1[_0x418a79(0x172)])(_0x8a190c)),+(0x0,date_fns_1[_0x418a79(0x15b)])((0x0,date_fns_1[_0x418a79(0x172)])(_0x8a190c))]}});if(_0x393133===_0x418a79(0x151)){const _0x3a9ad7=_0x28443b[_0x418a79(0x182)][_0x418a79(0x185)](_0xfe5f0d=>_0xfe5f0d['id']);_0x3b0f4b={[sequelize_1['Op']['or']]:[{'userId':_0x42efc0},{'status':_0x418a79(0x18e)}],'queueId':{[sequelize_1['Op']['or']]:_0x28443b[_0x418a79(0x155)]===_0x418a79(0x15a)?[_0x3a9ad7,null]:[_0x3a9ad7]},'unreadMessages':{[sequelize_1['Op']['gt']]:0x0}},_0x3b3cd8&&(_0x3b0f4b[_0x418a79(0x15d)]=_0x1808c1===_0x418a79(0x151));}if(Array[_0x418a79(0x167)](_0x362674)&&_0x362674[_0x418a79(0x190)]>0x0){const _0x5d2b2c=[];for await(const _0x270688 of _0x362674){const _0x33a429=await TicketTag_1['default'][_0x418a79(0x162)]({'where':{'tagId':_0x270688}});_0x33a429&&_0x5d2b2c['push'](_0x33a429[_0x418a79(0x185)](_0x5b36b5=>_0x5b36b5['ticketId']));}const _0x36e437=(0x0,lodash_1[_0x418a79(0x170)])(..._0x5d2b2c);_0x3b0f4b={..._0x3b0f4b,'id':{[sequelize_1['Op']['in']]:_0x36e437}};}if(Array[_0x418a79(0x167)](_0x48fb14)&&_0x48fb14[_0x418a79(0x190)]>0x0){const _0x5da507=[];for await(const _0x213cac of _0x48fb14){const _0x48fce5=await Ticket_1['default'][_0x418a79(0x162)]({'where':{'userId':_0x213cac}});_0x48fce5&&_0x5da507[_0x418a79(0x153)](_0x48fce5[_0x418a79(0x185)](_0x1122a6=>_0x1122a6['id']));}const _0x488df5=(0x0,lodash_1[_0x418a79(0x170)])(..._0x5da507);_0x3b0f4b={..._0x3b0f4b,'id':{[sequelize_1['Op']['in']]:_0x488df5}};}const _0x1233ca=_0x164429?undefined:0x28,_0x16af8a=_0x164429?undefined:_0x1233ca*(+pageNumber-0x1);_0xdea1e1&&(_0x3b0f4b={..._0x3b0f4b,'status':{[sequelize_1['Op']['ne']]:_0x418a79(0x159)}});_0x3b0f4b={..._0x3b0f4b,'companyId':_0x2ab573};const {count:_0x19d585,rows:_0x197d56}=await Ticket_1['default'][_0x418a79(0x183)]({'where':_0x3b0f4b,'include':_0x206ded,'distinct':!![],'limit':_0x1233ca,'offset':_0x16af8a,'order':[[_0x418a79(0x164),_0x418a79(0x166)]],'subQuery':![]}),_0x525199=_0x19d585>_0x16af8a+_0x197d56['length'];return{'tickets':_0x197d56,'count':_0x19d585,'hasMore':_0x525199};};exports[a667_0x2a8538(0x174)]=ListTicketsService;