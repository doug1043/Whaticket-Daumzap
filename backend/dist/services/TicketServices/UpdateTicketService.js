const a559_0x31f935=a559_0xa746;(function(_0x16dfc8,_0x519b98){const _0x5bfe52=a559_0xa746,_0x19aa2b=_0x16dfc8();while(!![]){try{const _0x2b978e=parseInt(_0x5bfe52(0x223))/0x1*(parseInt(_0x5bfe52(0x20b))/0x2)+parseInt(_0x5bfe52(0x21f))/0x3+parseInt(_0x5bfe52(0x220))/0x4*(-parseInt(_0x5bfe52(0x21c))/0x5)+-parseInt(_0x5bfe52(0x1e3))/0x6*(parseInt(_0x5bfe52(0x230))/0x7)+parseInt(_0x5bfe52(0x21a))/0x8*(-parseInt(_0x5bfe52(0x1e4))/0x9)+-parseInt(_0x5bfe52(0x22a))/0xa+parseInt(_0x5bfe52(0x204))/0xb;if(_0x2b978e===_0x519b98)break;else _0x19aa2b['push'](_0x19aa2b['shift']());}catch(_0x3df441){_0x19aa2b['push'](_0x19aa2b['shift']());}}}(a559_0x1747,0x4b1fb));const a559_0x39abc8=(function(){let _0x20125a=!![];return function(_0x575964,_0x5e32df){const _0x5543e1=_0x20125a?function(){const _0x50a35f=a559_0xa746;if(_0x5e32df){const _0x1c1246=_0x5e32df[_0x50a35f(0x1fc)](_0x575964,arguments);return _0x5e32df=null,_0x1c1246;}}:function(){};return _0x20125a=![],_0x5543e1;};}()),a559_0x2c3ade=a559_0x39abc8(this,function(){const _0x4e1b6c=a559_0xa746;return a559_0x2c3ade[_0x4e1b6c(0x1f5)]()[_0x4e1b6c(0x207)](_0x4e1b6c(0x22e))[_0x4e1b6c(0x1f5)]()[_0x4e1b6c(0x20d)](a559_0x2c3ade)['search']('(((.+)+)+)+$');});a559_0x2c3ade();'use strict';function a559_0xa746(_0x38389a,_0x516d05){const _0x3e1c35=a559_0x1747();return a559_0xa746=function(_0x2c3ade,_0x39abc8){_0x2c3ade=_0x2c3ade-0x1df;let _0x174718=_0x3e1c35[_0x2c3ade];return _0x174718;},a559_0xa746(_0x38389a,_0x516d05);}function a559_0x1747(){const _0x8757e7=['lodash','1128YINiKQ','update','222895rnlKqi','whatsapp','ratingAt','963813sKTnMB','24cuoxmu','queueOptionId','rated','373927cOAqBh','amountUsedBotQueues','../../helpers/CheckContactOpenTickets','__importDefault','channel','enabled','delete','3894160FZWwWQ','disableBot','queueId','__esModule','(((.+)+)+)+$','whatsappId','312123OlqYfM','useIntegration','indexOf','../../errors/AppError','\x0a\x0a*Digite\x20uma\x20nota\x20de\x201\x20a\x205*\x0a','12MKUNJL','20925OUrRlC','reload','admin','open','user-','isNil','userId','defineProperty','queue-','s.whatsapp.net','useRating','contactId','default','../../helpers/GetTicketWbot','sendMessage','getIO','Por\x20favor\x20avalie\x20nosso\x20atendimento','toString','emit','-notification','../WbotServices/SendWhatsAppMessage','removeFromList','trim','keepUserAndQueue','apply','-mainchannel','contact','-open','closed','../../helpers/CheckSettings','isGroup','integrationId','7550422VkDEfp','./FindOrCreateATicketTrakingService','updateUnread','search','verifyMessage','chatbot','save','2PhoJUi','number','constructor','Apenas\x20o\x20usuário\x20ativo\x20do\x20ticket\x20ou\x20o\x20Admin\x20podem\x20fazer\x20alterações\x20no\x20ticket','-ticket','../WhatsappService/ShowWhatsAppService','company-','GetCompanySetting','../WbotServices/VerifyHandlers','pending','companyId','status','queuedAt','toDate'];a559_0x1747=function(){return _0x8757e7;};return a559_0x1747();}var __importDefault=this&&this[a559_0x31f935(0x226)]||function(_0x4f1057){const _0x5365e7=a559_0x31f935;return _0x4f1057&&_0x4f1057[_0x5365e7(0x22d)]?_0x4f1057:{'default':_0x4f1057};};Object[a559_0x31f935(0x1eb)](exports,a559_0x31f935(0x22d),{'value':!![]});const moment_1=__importDefault(require('moment')),lodash_1=require(a559_0x31f935(0x219)),CheckContactOpenTickets_1=__importDefault(require(a559_0x31f935(0x225))),SetTicketMessagesAsRead_1=__importDefault(require('../../helpers/SetTicketMessagesAsRead')),socket_1=require('../../libs/socket'),ShowTicketService_1=__importDefault(require('./ShowTicketService')),ShowWhatsAppService_1=__importDefault(require(a559_0x31f935(0x210))),SendWhatsAppMessage_1=__importDefault(require(a559_0x31f935(0x1f8))),FindOrCreateATicketTrakingService_1=__importDefault(require(a559_0x31f935(0x205))),GetTicketWbot_1=__importDefault(require(a559_0x31f935(0x1f1))),VerifyHandlers_1=require(a559_0x31f935(0x213)),AppError_1=__importDefault(require(a559_0x31f935(0x1e1))),CheckSettings_1=require(a559_0x31f935(0x201)),Mustache_1=__importDefault(require('../../helpers/Mustache')),UpdateTicketService=async({ticketData:_0x7df1b1,ticketId:_0x55f2ec,tokenData:_0x1edb95,companyId:_0x1987cf})=>{const _0x4fbf90=a559_0x31f935;try{if(!_0x1987cf&&!_0x1edb95)throw new Error('Need\x20companyId\x20or\x20tokenData');_0x1edb95&&(_0x1987cf=_0x1edb95[_0x4fbf90(0x215)]);const {justClose:_0x93b4fd}=_0x7df1b1;let {status:_0x434234}=_0x7df1b1,{queueId:_0x558f81,userId:_0x486c37}=_0x7df1b1,_0x3d2291=_0x7df1b1[_0x4fbf90(0x209)]||![],_0x3e1b07=_0x7df1b1[_0x4fbf90(0x221)]||null,_0x3a2dcb=_0x7df1b1[_0x4fbf90(0x1df)]||![],_0x22d409=_0x7df1b1[_0x4fbf90(0x203)]||null;const _0x59421b=(0x0,socket_1[_0x4fbf90(0x1f3)])(),_0x570e54=await(0x0,ShowTicketService_1[_0x4fbf90(0x1f0)])(_0x55f2ec,_0x1987cf),_0x326899=await(0x0,ShowWhatsAppService_1[_0x4fbf90(0x1f0)])(_0x570e54['whatsappId'],_0x1987cf);if(_0x1edb95&&_0x570e54[_0x4fbf90(0x216)]!==_0x4fbf90(0x214)){if(_0x1edb95['profile']!==_0x4fbf90(0x1e6)&&_0x570e54[_0x4fbf90(0x1ea)]!==parseInt(_0x1edb95['id'],0xa))throw new AppError_1['default'](_0x4fbf90(0x20e));}const _0x216b00=await(0x0,FindOrCreateATicketTrakingService_1[_0x4fbf90(0x1f0)])({'ticketId':_0x55f2ec,'companyId':_0x1987cf,'whatsappId':_0x570e54[_0x4fbf90(0x22f)]});_0x570e54['channel']==='whatsapp'&&_0x434234===_0x4fbf90(0x1e7)&&(0x0,SetTicketMessagesAsRead_1[_0x4fbf90(0x1f0)])(_0x570e54);const _0x593e0f=_0x570e54[_0x4fbf90(0x216)],_0x4445c8=_0x570e54['user']?.['id'],_0x25fa71=_0x570e54[_0x4fbf90(0x22c)];_0x593e0f===_0x4fbf90(0x200)&&(await(0x0,CheckContactOpenTickets_1[_0x4fbf90(0x1f0)])(_0x570e54[_0x4fbf90(0x1ef)],_0x570e54['whatsappId']),_0x3d2291=null,_0x3e1b07=null);if(_0x434234!==undefined&&['closed'][_0x4fbf90(0x1e0)](_0x434234)>-0x1){const {complationMessage:_0x2a30d4,ratingMessage:_0x5e733b}=await(0x0,ShowWhatsAppService_1['default'])(_0x570e54[_0x4fbf90(0x22f)],_0x1987cf);if(!_0x570e54[_0x4fbf90(0x1fe)]['isGroup']&&!_0x570e54[_0x4fbf90(0x1fe)][_0x4fbf90(0x22b)]&&_0x326899[_0x4fbf90(0x1ee)]){if(_0x216b00[_0x4fbf90(0x21e)]==null&&!_0x93b4fd){const _0x5b53d9=_0x5e733b?.['trim']()||_0x4fbf90(0x1f4),_0x404222=_0x5b53d9+_0x4fbf90(0x1e2);return _0x570e54['channel']==='whatsapp'&&await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x404222,'ticket':_0x570e54}),await _0x216b00[_0x4fbf90(0x21b)]({'ratingAt':(0x0,moment_1[_0x4fbf90(0x1f0)])()['toDate'](),'rated':![]}),_0x59421b['to'](_0x4fbf90(0x211)+_0x570e54[_0x4fbf90(0x215)]+_0x4fbf90(0x1ff))['to'](_0x4fbf90(0x1ec)+_0x570e54[_0x4fbf90(0x22c)]+_0x4fbf90(0x1ff))['to'](_0x55f2ec[_0x4fbf90(0x1f5)]())[_0x4fbf90(0x1f6)](_0x4fbf90(0x211)+_0x570e54[_0x4fbf90(0x215)]+_0x4fbf90(0x20f),{'action':_0x4fbf90(0x229),'ticketId':_0x570e54['id']}),{'ticket':_0x570e54,'oldStatus':_0x593e0f,'oldUserId':_0x4445c8};}_0x216b00['ratingAt']=(0x0,moment_1['default'])()[_0x4fbf90(0x218)](),_0x216b00[_0x4fbf90(0x222)]=![];}if(!_0x570e54[_0x4fbf90(0x1fe)]['isGroup']&&!_0x570e54[_0x4fbf90(0x1fe)][_0x4fbf90(0x22b)]&&!_0x93b4fd&&!(0x0,lodash_1[_0x4fbf90(0x1e9)])(_0x2a30d4)&&_0x2a30d4!==''){const _0x43ed0b=(0x0,Mustache_1[_0x4fbf90(0x1f0)])(''+_0x2a30d4,_0x570e54);if(_0x570e54[_0x4fbf90(0x227)]===_0x4fbf90(0x21d)&&!_0x570e54[_0x4fbf90(0x202)]){const _0x3ab9c5=await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x43ed0b,'ticket':_0x570e54});await(0x0,VerifyHandlers_1['verifyMessage'])(_0x3ab9c5,_0x570e54,_0x570e54['contact']);}}_0x216b00['finishedAt']=(0x0,moment_1[_0x4fbf90(0x1f0)])()[_0x4fbf90(0x218)](),_0x216b00[_0x4fbf90(0x22f)]=_0x570e54[_0x4fbf90(0x22f)],_0x216b00[_0x4fbf90(0x1ea)]=_0x570e54[_0x4fbf90(0x1ea)],_0x3a2dcb=![],_0x22d409=null;const _0x5a75fa=await(0x0,CheckSettings_1[_0x4fbf90(0x212)])(_0x1987cf,_0x4fbf90(0x1fb),_0x4fbf90(0x228));_0x5a75fa==='disabled'&&(_0x558f81=null,_0x486c37=null);}_0x558f81!==undefined&&_0x558f81!==null&&(_0x216b00[_0x4fbf90(0x217)]=(0x0,moment_1[_0x4fbf90(0x1f0)])()[_0x4fbf90(0x218)]());if(_0x25fa71!==_0x558f81&&!(0x0,lodash_1[_0x4fbf90(0x1e9)])(_0x25fa71)&&!(0x0,lodash_1[_0x4fbf90(0x1e9)])(_0x558f81)){if(_0x570e54[_0x4fbf90(0x227)]===_0x4fbf90(0x21d)){const _0x11299c=await(0x0,GetTicketWbot_1[_0x4fbf90(0x1f0)])(_0x570e54),{transferMessage:_0x293bc7}=await(0x0,ShowWhatsAppService_1['default'])(_0x570e54[_0x4fbf90(0x22f)],_0x1987cf);if(!_0x570e54['isGroup']){if(_0x293bc7?.[_0x4fbf90(0x1fa)]()){const _0x2b5045=await _0x11299c[_0x4fbf90(0x1f2)](_0x570e54[_0x4fbf90(0x1fe)][_0x4fbf90(0x20c)]+'@'+(_0x570e54[_0x4fbf90(0x202)]?'g.us':_0x4fbf90(0x1ed)),{'text':''+_0x293bc7});await(0x0,VerifyHandlers_1[_0x4fbf90(0x208)])(_0x2b5045,_0x570e54,_0x570e54[_0x4fbf90(0x1fe)]);}}}}await _0x570e54['update']({'status':_0x434234,'amountUsedBotQueues':_0x7df1b1[_0x4fbf90(0x224)]||0x0,'queueId':_0x558f81,'userId':_0x486c37,'whatsappId':_0x570e54[_0x4fbf90(0x22f)],'chatbot':_0x3d2291,'queueOptionId':_0x3e1b07,'useIntegration':_0x3a2dcb,'integrationId':_0x22d409}),await _0x570e54[_0x4fbf90(0x1e5)](),_0x434234=_0x570e54[_0x4fbf90(0x216)];_0x434234!==undefined&&['pending'][_0x4fbf90(0x1e0)](_0x434234)>-0x1&&(_0x216b00[_0x4fbf90(0x21b)]({'whatsappId':_0x570e54[_0x4fbf90(0x22f)],'queuedAt':(0x0,moment_1[_0x4fbf90(0x1f0)])()[_0x4fbf90(0x218)](),'startedAt':null,'userId':null}),_0x59421b['to'](_0x4fbf90(0x211)+_0x1987cf+'-mainchannel')[_0x4fbf90(0x1f6)](_0x4fbf90(0x211)+_0x1987cf+_0x4fbf90(0x20f),{'action':_0x4fbf90(0x1f9),'ticketId':_0x570e54?.['id']}));_0x434234!==undefined&&[_0x4fbf90(0x1e7)][_0x4fbf90(0x1e0)](_0x434234)>-0x1&&(_0x216b00[_0x4fbf90(0x21b)]({'startedAt':(0x0,moment_1[_0x4fbf90(0x1f0)])()[_0x4fbf90(0x218)](),'ratingAt':null,'rated':![],'whatsappId':_0x570e54[_0x4fbf90(0x22f)],'userId':_0x570e54[_0x4fbf90(0x1ea)]}),_0x59421b['to'](_0x4fbf90(0x211)+_0x1987cf+_0x4fbf90(0x1fd))['emit'](_0x4fbf90(0x211)+_0x1987cf+_0x4fbf90(0x20f),{'action':_0x4fbf90(0x1f9),'ticketId':_0x570e54?.['id']}),_0x59421b['to']('company-'+_0x1987cf+_0x4fbf90(0x1fd))['emit']('company-'+_0x1987cf+_0x4fbf90(0x20f),{'action':_0x4fbf90(0x206),'ticketId':_0x570e54?.['id']}));await _0x216b00[_0x4fbf90(0x20a)]();if(_0x93b4fd&&_0x434234===_0x4fbf90(0x200))_0x59421b['to'](_0x4fbf90(0x211)+_0x1987cf+_0x4fbf90(0x1fd))['emit'](_0x4fbf90(0x211)+_0x1987cf+_0x4fbf90(0x20f),{'action':_0x4fbf90(0x1f9),'ticketId':_0x570e54?.['id']});else _0x570e54[_0x4fbf90(0x216)]===_0x4fbf90(0x200)&&_0x570e54['status']!==_0x593e0f&&_0x59421b['to'](_0x4fbf90(0x211)+_0x1987cf+'-'+_0x593e0f)['to']('queue-'+_0x570e54[_0x4fbf90(0x22c)]+'-'+_0x593e0f)['to']('user-'+_0x4445c8)['emit'](_0x4fbf90(0x211)+_0x1987cf+_0x4fbf90(0x20f),{'action':_0x4fbf90(0x1f9),'ticketId':_0x570e54['id']});return _0x59421b['to'](_0x4fbf90(0x211)+_0x1987cf+'-'+_0x570e54[_0x4fbf90(0x216)])['to'](_0x4fbf90(0x211)+_0x1987cf+'-notification')['to'](_0x4fbf90(0x1ec)+_0x570e54[_0x4fbf90(0x22c)]+'-'+_0x570e54[_0x4fbf90(0x216)])['to']('queue-'+_0x570e54[_0x4fbf90(0x22c)]+_0x4fbf90(0x1f7))['to'](_0x55f2ec[_0x4fbf90(0x1f5)]())['to'](_0x4fbf90(0x1e8)+_0x570e54?.[_0x4fbf90(0x1ea)])['to'](_0x4fbf90(0x1e8)+_0x4445c8)[_0x4fbf90(0x1f6)](_0x4fbf90(0x211)+_0x1987cf+_0x4fbf90(0x20f),{'action':_0x4fbf90(0x21b),'ticket':_0x570e54}),{'ticket':_0x570e54,'oldStatus':_0x593e0f,'oldUserId':_0x4445c8};}catch(_0xcbd7ed){if(_0xcbd7ed instanceof AppError_1[_0x4fbf90(0x1f0)])throw _0xcbd7ed;throw new AppError_1['default']('Error\x20updating\x20ticket',0x1f4,_0xcbd7ed);}};exports[a559_0x31f935(0x1f0)]=UpdateTicketService;