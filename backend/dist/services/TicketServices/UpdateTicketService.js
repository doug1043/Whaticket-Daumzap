function a558_0x53d1(_0x493b5f,_0x360b91){const _0x552f6a=a558_0x20b8();return a558_0x53d1=function(_0x379951,_0x4da2d5){_0x379951=_0x379951-0x19f;let _0x20b8ec=_0x552f6a[_0x379951];return _0x20b8ec;},a558_0x53d1(_0x493b5f,_0x360b91);}const a558_0x32c611=a558_0x53d1;(function(_0x37e862,_0xb823f8){const _0x19d92d=a558_0x53d1,_0x4d7d31=_0x37e862();while(!![]){try{const _0x4c745d=-parseInt(_0x19d92d(0x1e2))/0x1*(-parseInt(_0x19d92d(0x1e5))/0x2)+-parseInt(_0x19d92d(0x1ab))/0x3*(parseInt(_0x19d92d(0x1ea))/0x4)+parseInt(_0x19d92d(0x1b3))/0x5*(parseInt(_0x19d92d(0x1d3))/0x6)+parseInt(_0x19d92d(0x1a5))/0x7+-parseInt(_0x19d92d(0x1bf))/0x8*(-parseInt(_0x19d92d(0x1bb))/0x9)+parseInt(_0x19d92d(0x1ce))/0xa+parseInt(_0x19d92d(0x1bd))/0xb*(-parseInt(_0x19d92d(0x1de))/0xc);if(_0x4c745d===_0xb823f8)break;else _0x4d7d31['push'](_0x4d7d31['shift']());}catch(_0x342584){_0x4d7d31['push'](_0x4d7d31['shift']());}}}(a558_0x20b8,0xa262a));const a558_0x4da2d5=(function(){let _0x3cf208=!![];return function(_0x56e668,_0x94f590){const _0x4ece42=_0x3cf208?function(){const _0x4c584c=a558_0x53d1;if(_0x94f590){const _0x4d7c5a=_0x94f590[_0x4c584c(0x1ee)](_0x56e668,arguments);return _0x94f590=null,_0x4d7c5a;}}:function(){};return _0x3cf208=![],_0x4ece42;};}()),a558_0x379951=a558_0x4da2d5(this,function(){const _0x8d05ab=a558_0x53d1;return a558_0x379951[_0x8d05ab(0x1e7)]()[_0x8d05ab(0x1d9)](_0x8d05ab(0x1ec))[_0x8d05ab(0x1e7)]()[_0x8d05ab(0x1af)](a558_0x379951)['search'](_0x8d05ab(0x1ec));});a558_0x379951();'use strict';function a558_0x20b8(){const _0x18dc1f=['getIO','whatsapp','Apenas\x20o\x20usuário\x20ativo\x20do\x20ticket\x20ou\x20o\x20Admin\x20podem\x20fazer\x20alterações\x20no\x20ticket','number','verifyMessage','useIntegration','chatbot','disableBot','company-','delete','5500770nMAUwQ','whatsappId','user','keepUserAndQueue','rated','2331222RMUYOn','default','update','indexOf','isNil','g.us','search','../WbotServices/SendWhatsAppMessage','Error\x20updating\x20ticket','emit','-ticket','2568NPjWJb','enabled','Por\x20favor\x20avalie\x20nosso\x20atendimento','-mainchannel','5MSLttW','\x0a\x0a*Digite\x20uma\x20nota\x20de\x201\x20a\x205*\x0a','pending','55834lebMMa','ratingAt','toString','./FindOrCreateATicketTrakingService','../WhatsappService/ShowWhatsAppService','12tehLYs','../../helpers/Mustache','(((.+)+)+)+$','defineProperty','apply','integrationId','queueOptionId','queue-','closed','isGroup','status','GetCompanySetting','user-','contactId','companyId','9301502AxHUBy','sendMessage','-notification','admin','userId','../../helpers/GetTicketWbot','188499FWHqep','finishedAt','contact','lodash','constructor','__importDefault','-open','queueId','5YjXgLl','toDate','moment','../../helpers/CheckContactOpenTickets','disabled','save','../../helpers/CheckSettings','../WbotServices/VerifyHandlers','36ThEJoP','trim','110440XEkHmr','__esModule','1190408jmpUOb','channel','queuedAt','removeFromList','profile'];a558_0x20b8=function(){return _0x18dc1f;};return a558_0x20b8();}var __importDefault=this&&this[a558_0x32c611(0x1b0)]||function(_0x208c03){return _0x208c03&&_0x208c03['__esModule']?_0x208c03:{'default':_0x208c03};};Object[a558_0x32c611(0x1ed)](exports,a558_0x32c611(0x1be),{'value':!![]});const moment_1=__importDefault(require(a558_0x32c611(0x1b5))),lodash_1=require(a558_0x32c611(0x1ae)),CheckContactOpenTickets_1=__importDefault(require(a558_0x32c611(0x1b6))),SetTicketMessagesAsRead_1=__importDefault(require('../../helpers/SetTicketMessagesAsRead')),socket_1=require('../../libs/socket'),ShowTicketService_1=__importDefault(require('./ShowTicketService')),ShowWhatsAppService_1=__importDefault(require(a558_0x32c611(0x1e9))),SendWhatsAppMessage_1=__importDefault(require(a558_0x32c611(0x1da))),FindOrCreateATicketTrakingService_1=__importDefault(require(a558_0x32c611(0x1e8))),GetTicketWbot_1=__importDefault(require(a558_0x32c611(0x1aa))),VerifyHandlers_1=require(a558_0x32c611(0x1ba)),AppError_1=__importDefault(require('../../errors/AppError')),CheckSettings_1=require(a558_0x32c611(0x1b9)),Mustache_1=__importDefault(require(a558_0x32c611(0x1eb))),UpdateTicketService=async({ticketData:_0x5cfa7c,ticketId:_0xae4ac7,tokenData:_0x53690e,companyId:_0x2cf8b6})=>{const _0x4be427=a558_0x32c611;try{if(!_0x2cf8b6&&!_0x53690e)throw new Error('Need\x20companyId\x20or\x20tokenData');_0x53690e&&(_0x2cf8b6=_0x53690e[_0x4be427(0x1a4)]);const {justClose:_0x13d9bf}=_0x5cfa7c;let {status:_0x187c74}=_0x5cfa7c,{queueId:_0x1f062d,userId:_0x2e2804}=_0x5cfa7c,_0x52c733=_0x5cfa7c[_0x4be427(0x1ca)]||![],_0x4957be=_0x5cfa7c[_0x4be427(0x1f0)]||null,_0x370610=_0x5cfa7c[_0x4be427(0x1c9)]||![],_0x1d5720=_0x5cfa7c[_0x4be427(0x1ef)]||null;const _0xcc9b16=(0x0,socket_1[_0x4be427(0x1c4)])(),_0x5bad1f=await(0x0,ShowTicketService_1[_0x4be427(0x1d4)])(_0xae4ac7,_0x2cf8b6),_0x430240=await(0x0,ShowWhatsAppService_1['default'])(_0x5bad1f[_0x4be427(0x1cf)],_0x2cf8b6);if(_0x53690e&&_0x5bad1f[_0x4be427(0x1a0)]!==_0x4be427(0x1e4)){if(_0x53690e[_0x4be427(0x1c3)]!==_0x4be427(0x1a8)&&_0x5bad1f['userId']!==parseInt(_0x53690e['id'],0xa))throw new AppError_1[(_0x4be427(0x1d4))](_0x4be427(0x1c6));}const _0x1b88cc=await(0x0,FindOrCreateATicketTrakingService_1[_0x4be427(0x1d4)])({'ticketId':_0xae4ac7,'companyId':_0x2cf8b6,'whatsappId':_0x5bad1f[_0x4be427(0x1cf)]});_0x5bad1f[_0x4be427(0x1c0)]===_0x4be427(0x1c5)&&_0x187c74==='open'&&(0x0,SetTicketMessagesAsRead_1[_0x4be427(0x1d4)])(_0x5bad1f);const _0x858c5c=_0x5bad1f['status'],_0x230202=_0x5bad1f[_0x4be427(0x1d0)]?.['id'],_0x3cb713=_0x5bad1f[_0x4be427(0x1b2)];_0x858c5c===_0x4be427(0x1f2)&&(await(0x0,CheckContactOpenTickets_1[_0x4be427(0x1d4)])(_0x5bad1f[_0x4be427(0x1a3)],_0x5bad1f['whatsappId']),_0x52c733=null,_0x4957be=null);if(_0x187c74!==undefined&&[_0x4be427(0x1f2)][_0x4be427(0x1d6)](_0x187c74)>-0x1){const {complationMessage:_0x218f34,ratingMessage:_0x46043d}=await(0x0,ShowWhatsAppService_1[_0x4be427(0x1d4)])(_0x5bad1f['whatsappId'],_0x2cf8b6);if(!_0x5bad1f[_0x4be427(0x1ad)][_0x4be427(0x19f)]&&!_0x5bad1f[_0x4be427(0x1ad)][_0x4be427(0x1cb)]&&_0x430240['useRating']){if(_0x1b88cc[_0x4be427(0x1e6)]==null&&!_0x13d9bf){const _0x471617=_0x46043d?.[_0x4be427(0x1bc)]()||_0x4be427(0x1e0),_0xb8f506=_0x471617+_0x4be427(0x1e3);return _0x5bad1f[_0x4be427(0x1c0)]===_0x4be427(0x1c5)&&await(0x0,SendWhatsAppMessage_1[_0x4be427(0x1d4)])({'body':_0xb8f506,'ticket':_0x5bad1f}),await _0x1b88cc['update']({'ratingAt':(0x0,moment_1[_0x4be427(0x1d4)])()['toDate'](),'rated':![]}),_0xcc9b16['to'](_0x4be427(0x1cc)+_0x5bad1f['companyId']+_0x4be427(0x1b1))['to'](_0x4be427(0x1f1)+_0x5bad1f[_0x4be427(0x1b2)]+_0x4be427(0x1b1))['to'](_0xae4ac7['toString']())[_0x4be427(0x1dc)]('company-'+_0x5bad1f[_0x4be427(0x1a4)]+_0x4be427(0x1dd),{'action':_0x4be427(0x1cd),'ticketId':_0x5bad1f['id']}),{'ticket':_0x5bad1f,'oldStatus':_0x858c5c,'oldUserId':_0x230202};}_0x1b88cc['ratingAt']=(0x0,moment_1[_0x4be427(0x1d4)])()[_0x4be427(0x1b4)](),_0x1b88cc[_0x4be427(0x1d2)]=![];}if(!_0x5bad1f['contact'][_0x4be427(0x19f)]&&!_0x5bad1f['contact']['disableBot']&&!_0x13d9bf&&!(0x0,lodash_1['isNil'])(_0x218f34)&&_0x218f34!==''){const _0x54da70=(0x0,Mustache_1[_0x4be427(0x1d4)])(''+_0x218f34,_0x5bad1f);if(_0x5bad1f[_0x4be427(0x1c0)]===_0x4be427(0x1c5)&&!_0x5bad1f[_0x4be427(0x19f)]){const _0x425490=await(0x0,SendWhatsAppMessage_1[_0x4be427(0x1d4)])({'body':_0x54da70,'ticket':_0x5bad1f});await(0x0,VerifyHandlers_1[_0x4be427(0x1c8)])(_0x425490,_0x5bad1f,_0x5bad1f[_0x4be427(0x1ad)]);}}_0x1b88cc[_0x4be427(0x1ac)]=(0x0,moment_1[_0x4be427(0x1d4)])()[_0x4be427(0x1b4)](),_0x1b88cc[_0x4be427(0x1cf)]=_0x5bad1f[_0x4be427(0x1cf)],_0x1b88cc[_0x4be427(0x1a9)]=_0x5bad1f[_0x4be427(0x1a9)],_0x370610=![],_0x1d5720=null;const _0x2b7118=await(0x0,CheckSettings_1[_0x4be427(0x1a1)])(_0x2cf8b6,_0x4be427(0x1d1),_0x4be427(0x1df));_0x2b7118===_0x4be427(0x1b7)&&(_0x1f062d=null,_0x2e2804=null);}_0x1f062d!==undefined&&_0x1f062d!==null&&(_0x1b88cc[_0x4be427(0x1c1)]=(0x0,moment_1[_0x4be427(0x1d4)])()[_0x4be427(0x1b4)]());if(_0x3cb713!==_0x1f062d&&!(0x0,lodash_1['isNil'])(_0x3cb713)&&!(0x0,lodash_1[_0x4be427(0x1d7)])(_0x1f062d)){if(_0x5bad1f[_0x4be427(0x1c0)]===_0x4be427(0x1c5)){const _0x561dbe=await(0x0,GetTicketWbot_1[_0x4be427(0x1d4)])(_0x5bad1f),{transferMessage:_0x1a91fd}=await(0x0,ShowWhatsAppService_1[_0x4be427(0x1d4)])(_0x5bad1f['whatsappId'],_0x2cf8b6);if(!_0x5bad1f[_0x4be427(0x19f)]){if(_0x1a91fd?.[_0x4be427(0x1bc)]()){const _0x5c36f7=await _0x561dbe[_0x4be427(0x1a6)](_0x5bad1f[_0x4be427(0x1ad)][_0x4be427(0x1c7)]+'@'+(_0x5bad1f['isGroup']?_0x4be427(0x1d8):'s.whatsapp.net'),{'text':''+_0x1a91fd});await(0x0,VerifyHandlers_1[_0x4be427(0x1c8)])(_0x5c36f7,_0x5bad1f,_0x5bad1f[_0x4be427(0x1ad)]);}}}}await _0x5bad1f[_0x4be427(0x1d5)]({'status':_0x187c74,'amountUsedBotQueues':_0x5cfa7c['amountUsedBotQueues']||0x0,'queueId':_0x1f062d,'userId':_0x2e2804,'whatsappId':_0x5bad1f[_0x4be427(0x1cf)],'chatbot':_0x52c733,'queueOptionId':_0x4957be,'useIntegration':_0x370610,'integrationId':_0x1d5720}),await _0x5bad1f['reload'](),_0x187c74=_0x5bad1f[_0x4be427(0x1a0)];_0x187c74!==undefined&&[_0x4be427(0x1e4)]['indexOf'](_0x187c74)>-0x1&&(_0x1b88cc[_0x4be427(0x1d5)]({'whatsappId':_0x5bad1f['whatsappId'],'queuedAt':(0x0,moment_1[_0x4be427(0x1d4)])()[_0x4be427(0x1b4)](),'startedAt':null,'userId':null}),_0xcc9b16['to']('company-'+_0x2cf8b6+_0x4be427(0x1e1))[_0x4be427(0x1dc)](_0x4be427(0x1cc)+_0x2cf8b6+_0x4be427(0x1dd),{'action':_0x4be427(0x1c2),'ticketId':_0x5bad1f?.['id']}));_0x187c74!==undefined&&['open'][_0x4be427(0x1d6)](_0x187c74)>-0x1&&(_0x1b88cc[_0x4be427(0x1d5)]({'startedAt':(0x0,moment_1[_0x4be427(0x1d4)])()[_0x4be427(0x1b4)](),'ratingAt':null,'rated':![],'whatsappId':_0x5bad1f[_0x4be427(0x1cf)],'userId':_0x5bad1f[_0x4be427(0x1a9)]}),_0xcc9b16['to']('company-'+_0x2cf8b6+_0x4be427(0x1e1))['emit'](_0x4be427(0x1cc)+_0x2cf8b6+_0x4be427(0x1dd),{'action':_0x4be427(0x1c2),'ticketId':_0x5bad1f?.['id']}),_0xcc9b16['to']('company-'+_0x2cf8b6+_0x4be427(0x1e1))[_0x4be427(0x1dc)](_0x4be427(0x1cc)+_0x2cf8b6+'-ticket',{'action':'updateUnread','ticketId':_0x5bad1f?.['id']}));await _0x1b88cc[_0x4be427(0x1b8)]();if(_0x13d9bf&&_0x187c74===_0x4be427(0x1f2))_0xcc9b16['to'](_0x4be427(0x1cc)+_0x2cf8b6+_0x4be427(0x1e1))[_0x4be427(0x1dc)]('company-'+_0x2cf8b6+_0x4be427(0x1dd),{'action':_0x4be427(0x1c2),'ticketId':_0x5bad1f?.['id']});else _0x5bad1f['status']===_0x4be427(0x1f2)&&_0x5bad1f[_0x4be427(0x1a0)]!==_0x858c5c&&_0xcc9b16['to'](_0x4be427(0x1cc)+_0x2cf8b6+'-'+_0x858c5c)['to'](_0x4be427(0x1f1)+_0x5bad1f[_0x4be427(0x1b2)]+'-'+_0x858c5c)['to']('user-'+_0x230202)[_0x4be427(0x1dc)](_0x4be427(0x1cc)+_0x2cf8b6+_0x4be427(0x1dd),{'action':_0x4be427(0x1c2),'ticketId':_0x5bad1f['id']});return _0xcc9b16['to']('company-'+_0x2cf8b6+'-'+_0x5bad1f[_0x4be427(0x1a0)])['to'](_0x4be427(0x1cc)+_0x2cf8b6+_0x4be427(0x1a7))['to'](_0x4be427(0x1f1)+_0x5bad1f[_0x4be427(0x1b2)]+'-'+_0x5bad1f[_0x4be427(0x1a0)])['to'](_0x4be427(0x1f1)+_0x5bad1f['queueId']+_0x4be427(0x1a7))['to'](_0xae4ac7[_0x4be427(0x1e7)]())['to'](_0x4be427(0x1a2)+_0x5bad1f?.['userId'])['to'](_0x4be427(0x1a2)+_0x230202)['emit'](_0x4be427(0x1cc)+_0x2cf8b6+_0x4be427(0x1dd),{'action':_0x4be427(0x1d5),'ticket':_0x5bad1f}),{'ticket':_0x5bad1f,'oldStatus':_0x858c5c,'oldUserId':_0x230202};}catch(_0x380338){if(_0x380338 instanceof AppError_1[_0x4be427(0x1d4)])throw _0x380338;throw new AppError_1[(_0x4be427(0x1d4))](_0x4be427(0x1db),0x1f4,_0x380338);}};exports['default']=UpdateTicketService;