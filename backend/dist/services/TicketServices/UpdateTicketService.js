const a553_0x59d4ce=a553_0x4c03;function a553_0x17ef(){const _0x19570e=['../../helpers/CheckSettings','profile','../../libs/socket','8dmcTFJ','1211168jkukdF','apply','../../helpers/SetTicketMessagesAsRead','defineProperty','whatsappId','enabled','default','whatsapp','Por\x20favor\x20avalie\x20nosso\x20atendimento','contact','ratingAt','-mainchannel','user-','moment','update','10054521sUvQFV','disableBot','../../helpers/GetTicketWbot','g.us','67398iSfFmU','verifyMessage','s.whatsapp.net','removeFromList','sendMessage','./ShowTicketService','queueId','3889235OIUxlA','596301rRwGYF','status','isGroup','useIntegration','../../models/Setting','contactId','__esModule','(((.+)+)+)+$','6eDZhin','closed','emit','lodash','queueOptionId','open','number','integrationId','delete','indexOf','../WbotServices/SendWhatsAppMessage','admin','\x0a\x0a*Digite\x20uma\x20nota\x20de\x201\x20a\x205*\x0a','trim','../../errors/AppError','channel','finishedAt','updateUnread','companyId','toDate','-notification','Error\x20updating\x20ticket','queue-','isNil','search','save','26xLkOEn','user','findOne','-ticket','company-','constructor','toString','userId','10875780jOXMiN','Need\x20companyId\x20or\x20tokenData','../../helpers/CheckContactOpenTickets','../../helpers/Mustache','3773675oPkmSV','rated','GetCompanySetting'];a553_0x17ef=function(){return _0x19570e;};return a553_0x17ef();}(function(_0x45e496,_0x486297){const _0x4ed12c=a553_0x4c03,_0x119ce1=_0x45e496();while(!![]){try{const _0x243315=parseInt(_0x4ed12c(0x1f2))/0x1*(-parseInt(_0x4ed12c(0x21c))/0x2)+-parseInt(_0x4ed12c(0x1fa))/0x3+-parseInt(_0x4ed12c(0x22f))/0x4+-parseInt(_0x4ed12c(0x228))/0x5+-parseInt(_0x4ed12c(0x202))/0x6*(-parseInt(_0x4ed12c(0x1f9))/0x7)+-parseInt(_0x4ed12c(0x22e))/0x8*(-parseInt(_0x4ed12c(0x1ee))/0x9)+parseInt(_0x4ed12c(0x224))/0xa;if(_0x243315===_0x486297)break;else _0x119ce1['push'](_0x119ce1['shift']());}catch(_0x5e38e7){_0x119ce1['push'](_0x119ce1['shift']());}}}(a553_0x17ef,0x994ac));const a553_0x509ee3=(function(){let _0x5372b8=!![];return function(_0x2c2fa5,_0x33b636){const _0x1d52ec=_0x5372b8?function(){const _0xbc6066=a553_0x4c03;if(_0x33b636){const _0x3cbde6=_0x33b636[_0xbc6066(0x230)](_0x2c2fa5,arguments);return _0x33b636=null,_0x3cbde6;}}:function(){};return _0x5372b8=![],_0x1d52ec;};}()),a553_0x1f6104=a553_0x509ee3(this,function(){const _0x49bd4b=a553_0x4c03;return a553_0x1f6104[_0x49bd4b(0x222)]()[_0x49bd4b(0x21a)](_0x49bd4b(0x201))[_0x49bd4b(0x222)]()[_0x49bd4b(0x221)](a553_0x1f6104)['search']('(((.+)+)+)+$');});a553_0x1f6104();'use strict';function a553_0x4c03(_0x325056,_0x58bf9c){const _0x3159a6=a553_0x17ef();return a553_0x4c03=function(_0x1f6104,_0x509ee3){_0x1f6104=_0x1f6104-0x1e9;let _0x17ef57=_0x3159a6[_0x1f6104];return _0x17ef57;},a553_0x4c03(_0x325056,_0x58bf9c);}var __importDefault=this&&this['__importDefault']||function(_0x5b6821){const _0x531a34=a553_0x4c03;return _0x5b6821&&_0x5b6821[_0x531a34(0x200)]?_0x5b6821:{'default':_0x5b6821};};Object[a553_0x59d4ce(0x232)](exports,'__esModule',{'value':!![]});const moment_1=__importDefault(require(a553_0x59d4ce(0x1ec))),lodash_1=require(a553_0x59d4ce(0x205)),CheckContactOpenTickets_1=__importDefault(require(a553_0x59d4ce(0x226))),SetTicketMessagesAsRead_1=__importDefault(require(a553_0x59d4ce(0x231))),socket_1=require(a553_0x59d4ce(0x22d)),Setting_1=__importDefault(require(a553_0x59d4ce(0x1fe))),ShowTicketService_1=__importDefault(require(a553_0x59d4ce(0x1f7))),ShowWhatsAppService_1=__importDefault(require('../WhatsappService/ShowWhatsAppService')),SendWhatsAppMessage_1=__importDefault(require(a553_0x59d4ce(0x20c))),FindOrCreateATicketTrakingService_1=__importDefault(require('./FindOrCreateATicketTrakingService')),GetTicketWbot_1=__importDefault(require(a553_0x59d4ce(0x1f0))),VerifyHandlers_1=require('../WbotServices/VerifyHandlers'),AppError_1=__importDefault(require(a553_0x59d4ce(0x210))),CheckSettings_1=require(a553_0x59d4ce(0x22b)),Mustache_1=__importDefault(require(a553_0x59d4ce(0x227))),UpdateTicketService=async({ticketData:_0xf95d5d,ticketId:_0x2a9892,tokenData:_0x1260a6,companyId:_0x1e5eca})=>{const _0x54d37e=a553_0x59d4ce;try{if(!_0x1e5eca&&!_0x1260a6)throw new Error(_0x54d37e(0x225));_0x1260a6&&(_0x1e5eca=_0x1260a6[_0x54d37e(0x214)]);const {justClose:_0x265384}=_0xf95d5d;let {status:_0x431292}=_0xf95d5d,{queueId:_0x216f93,userId:_0x2ed788}=_0xf95d5d,_0x247ca6=_0xf95d5d['chatbot']||![],_0x36158c=_0xf95d5d[_0x54d37e(0x206)]||null,_0x470cff=_0xf95d5d[_0x54d37e(0x1fd)]||![],_0x5a9f24=_0xf95d5d[_0x54d37e(0x209)]||null;const _0x3c8976=(0x0,socket_1['getIO'])(),_0x56242b='userRating',_0x5a1f09=await Setting_1[_0x54d37e(0x235)][_0x54d37e(0x21e)]({'where':{'companyId':_0x1e5eca,'key':_0x56242b}}),_0x15db3a=await(0x0,ShowTicketService_1['default'])(_0x2a9892,_0x1e5eca);if(_0x1260a6&&_0x15db3a[_0x54d37e(0x1fb)]!=='pending'){if(_0x1260a6[_0x54d37e(0x22c)]!==_0x54d37e(0x20d)&&_0x15db3a[_0x54d37e(0x223)]!==parseInt(_0x1260a6['id'],0xa))throw new AppError_1[(_0x54d37e(0x235))]('Apenas\x20o\x20usuário\x20ativo\x20do\x20ticket\x20ou\x20o\x20Admin\x20podem\x20fazer\x20alterações\x20no\x20ticket');}const _0x4f48b9=await(0x0,FindOrCreateATicketTrakingService_1['default'])({'ticketId':_0x2a9892,'companyId':_0x1e5eca,'whatsappId':_0x15db3a[_0x54d37e(0x233)]});_0x15db3a[_0x54d37e(0x211)]===_0x54d37e(0x236)&&_0x431292===_0x54d37e(0x207)&&(0x0,SetTicketMessagesAsRead_1[_0x54d37e(0x235)])(_0x15db3a);const _0x6cfd36=_0x15db3a[_0x54d37e(0x1fb)],_0x509cd6=_0x15db3a[_0x54d37e(0x21d)]?.['id'],_0x5e8fcd=_0x15db3a['queueId'];_0x6cfd36===_0x54d37e(0x203)&&(await(0x0,CheckContactOpenTickets_1[_0x54d37e(0x235)])(_0x15db3a[_0x54d37e(0x1ff)],_0x15db3a[_0x54d37e(0x233)]),_0x247ca6=null,_0x36158c=null);if(_0x431292!==undefined&&[_0x54d37e(0x203)]['indexOf'](_0x431292)>-0x1){const {complationMessage:_0x552148,ratingMessage:_0x105d68}=await(0x0,ShowWhatsAppService_1[_0x54d37e(0x235)])(_0x15db3a[_0x54d37e(0x233)],_0x1e5eca);if(!_0x15db3a[_0x54d37e(0x238)]['isGroup']&&!_0x15db3a['contact']['disableBot']&&_0x5a1f09?.['value']==='enabled'){if(_0x4f48b9[_0x54d37e(0x1e9)]==null&&!_0x265384){const _0x4a6a45=_0x105d68?.[_0x54d37e(0x20f)]()||_0x54d37e(0x237),_0x2f48b6=_0x4a6a45+_0x54d37e(0x20e);return _0x15db3a[_0x54d37e(0x211)]==='whatsapp'&&await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x2f48b6,'ticket':_0x15db3a}),await _0x4f48b9[_0x54d37e(0x1ed)]({'ratingAt':(0x0,moment_1[_0x54d37e(0x235)])()[_0x54d37e(0x215)]()}),_0x3c8976['to'](_0x54d37e(0x220)+_0x15db3a[_0x54d37e(0x214)]+'-open')['to'](_0x54d37e(0x218)+_0x15db3a[_0x54d37e(0x1f8)]+'-open')['to'](_0x2a9892['toString']())[_0x54d37e(0x204)]('company-'+_0x15db3a[_0x54d37e(0x214)]+'-ticket',{'action':_0x54d37e(0x20a),'ticketId':_0x15db3a['id']}),{'ticket':_0x15db3a,'oldStatus':_0x6cfd36,'oldUserId':_0x509cd6};}_0x4f48b9[_0x54d37e(0x1e9)]=(0x0,moment_1['default'])()['toDate'](),_0x4f48b9[_0x54d37e(0x229)]=![];}if(!_0x15db3a[_0x54d37e(0x238)]['isGroup']&&!_0x15db3a[_0x54d37e(0x238)][_0x54d37e(0x1ef)]&&!_0x265384&&!(0x0,lodash_1['isNil'])(_0x552148)&&_0x552148!==''){const _0x4fec6f=(0x0,Mustache_1['default'])(''+_0x552148,_0x15db3a);if(_0x15db3a[_0x54d37e(0x211)]==='whatsapp'&&!_0x15db3a[_0x54d37e(0x1fc)]){const _0x404338=await(0x0,SendWhatsAppMessage_1[_0x54d37e(0x235)])({'body':_0x4fec6f,'ticket':_0x15db3a});await(0x0,VerifyHandlers_1[_0x54d37e(0x1f3)])(_0x404338,_0x15db3a,_0x15db3a[_0x54d37e(0x238)]);}}_0x4f48b9[_0x54d37e(0x212)]=(0x0,moment_1['default'])()['toDate'](),_0x4f48b9[_0x54d37e(0x233)]=_0x15db3a[_0x54d37e(0x233)],_0x4f48b9[_0x54d37e(0x223)]=_0x15db3a[_0x54d37e(0x223)],_0x470cff=![],_0x5a9f24=null;const _0x2f8db6=await(0x0,CheckSettings_1[_0x54d37e(0x22a)])(_0x1e5eca,'keepUserAndQueue',_0x54d37e(0x234));_0x2f8db6==='disabled'&&(_0x216f93=null,_0x2ed788=null);}_0x216f93!==undefined&&_0x216f93!==null&&(_0x4f48b9['queuedAt']=(0x0,moment_1['default'])()[_0x54d37e(0x215)]());if(_0x5e8fcd!==_0x216f93&&!(0x0,lodash_1[_0x54d37e(0x219)])(_0x5e8fcd)&&!(0x0,lodash_1['isNil'])(_0x216f93)){if(_0x15db3a[_0x54d37e(0x211)]==='whatsapp'){const _0x54faaf=await(0x0,GetTicketWbot_1[_0x54d37e(0x235)])(_0x15db3a),{transferMessage:_0x29ac3e}=await(0x0,ShowWhatsAppService_1[_0x54d37e(0x235)])(_0x15db3a[_0x54d37e(0x233)],_0x1e5eca);if(!_0x15db3a[_0x54d37e(0x1fc)]){if(_0x29ac3e?.[_0x54d37e(0x20f)]()){const _0x145593=await _0x54faaf[_0x54d37e(0x1f6)](_0x15db3a[_0x54d37e(0x238)][_0x54d37e(0x208)]+'@'+(_0x15db3a[_0x54d37e(0x1fc)]?_0x54d37e(0x1f1):_0x54d37e(0x1f4)),{'text':''+_0x29ac3e});await(0x0,VerifyHandlers_1[_0x54d37e(0x1f3)])(_0x145593,_0x15db3a,_0x15db3a[_0x54d37e(0x238)]);}}}}await _0x15db3a[_0x54d37e(0x1ed)]({'status':_0x431292,'amountUsedBotQueues':_0xf95d5d['amountUsedBotQueues']||0x0,'queueId':_0x216f93,'userId':_0x2ed788,'whatsappId':_0x15db3a['whatsappId'],'chatbot':_0x247ca6,'queueOptionId':_0x36158c,'useIntegration':_0x470cff,'integrationId':_0x5a9f24}),await _0x15db3a['reload'](),_0x431292=_0x15db3a[_0x54d37e(0x1fb)];_0x431292!==undefined&&['pending'][_0x54d37e(0x20b)](_0x431292)>-0x1&&(_0x4f48b9[_0x54d37e(0x1ed)]({'whatsappId':_0x15db3a[_0x54d37e(0x233)],'queuedAt':(0x0,moment_1[_0x54d37e(0x235)])()[_0x54d37e(0x215)](),'startedAt':null,'userId':null}),_0x3c8976['to'](_0x54d37e(0x220)+_0x1e5eca+_0x54d37e(0x1ea))[_0x54d37e(0x204)](_0x54d37e(0x220)+_0x1e5eca+_0x54d37e(0x21f),{'action':_0x54d37e(0x1f5),'ticketId':_0x15db3a?.['id']}));_0x431292!==undefined&&['open'][_0x54d37e(0x20b)](_0x431292)>-0x1&&(_0x4f48b9['update']({'startedAt':(0x0,moment_1[_0x54d37e(0x235)])()[_0x54d37e(0x215)](),'ratingAt':null,'rated':![],'whatsappId':_0x15db3a[_0x54d37e(0x233)],'userId':_0x15db3a['userId']}),_0x3c8976['to'](_0x54d37e(0x220)+_0x1e5eca+_0x54d37e(0x1ea))[_0x54d37e(0x204)](_0x54d37e(0x220)+_0x1e5eca+_0x54d37e(0x21f),{'action':_0x54d37e(0x1f5),'ticketId':_0x15db3a?.['id']}),_0x3c8976['to'](_0x54d37e(0x220)+_0x1e5eca+_0x54d37e(0x1ea))[_0x54d37e(0x204)]('company-'+_0x1e5eca+_0x54d37e(0x21f),{'action':_0x54d37e(0x213),'ticketId':_0x15db3a?.['id']}));await _0x4f48b9[_0x54d37e(0x21b)]();if(_0x265384&&_0x431292===_0x54d37e(0x203))_0x3c8976['to']('company-'+_0x1e5eca+'-mainchannel')[_0x54d37e(0x204)](_0x54d37e(0x220)+_0x1e5eca+_0x54d37e(0x21f),{'action':_0x54d37e(0x1f5),'ticketId':_0x15db3a?.['id']});else _0x15db3a['status']==='closed'&&_0x15db3a[_0x54d37e(0x1fb)]!==_0x6cfd36&&_0x3c8976['to'](_0x54d37e(0x220)+_0x1e5eca+'-'+_0x6cfd36)['to']('queue-'+_0x15db3a[_0x54d37e(0x1f8)]+'-'+_0x6cfd36)['to'](_0x54d37e(0x1eb)+_0x509cd6)[_0x54d37e(0x204)]('company-'+_0x1e5eca+_0x54d37e(0x21f),{'action':_0x54d37e(0x1f5),'ticketId':_0x15db3a['id']});return _0x3c8976['to']('company-'+_0x1e5eca+'-'+_0x15db3a[_0x54d37e(0x1fb)])['to'](_0x54d37e(0x220)+_0x1e5eca+_0x54d37e(0x216))['to'](_0x54d37e(0x218)+_0x15db3a[_0x54d37e(0x1f8)]+'-'+_0x15db3a['status'])['to'](_0x54d37e(0x218)+_0x15db3a[_0x54d37e(0x1f8)]+_0x54d37e(0x216))['to'](_0x2a9892[_0x54d37e(0x222)]())['to'](_0x54d37e(0x1eb)+_0x15db3a?.['userId'])['to'](_0x54d37e(0x1eb)+_0x509cd6)[_0x54d37e(0x204)](_0x54d37e(0x220)+_0x1e5eca+_0x54d37e(0x21f),{'action':_0x54d37e(0x1ed),'ticket':_0x15db3a}),{'ticket':_0x15db3a,'oldStatus':_0x6cfd36,'oldUserId':_0x509cd6};}catch(_0x34b29a){if(_0x34b29a instanceof AppError_1[_0x54d37e(0x235)])throw _0x34b29a;throw new AppError_1['default'](_0x54d37e(0x217),0x1f4,_0x34b29a);}};exports[a553_0x59d4ce(0x235)]=UpdateTicketService;