function a672_0x3a7e(){const _0x3148fe=['profile','getIO','../WhatsappService/ShowWhatsAppService','finishedAt','defineProperty','34067zocdlP','greetingMediaAttachment','updateUnread','-notification','../../helpers/Mustache','contact','useRating','removeFromList','isNil','../WbotServices/VerifyHandlers','companyId','146385iaqGYa','amountUsedBotQueues','-mainchannel','-ticket','emit','public','rated','../../helpers/CheckContactOpenTickets','toString','name','delete','resolve','queueId','pending','greetingAcceptedMessage','6821696nyuxUp','closed','keepUserAndQueue','disableBot','superv','__esModule','../../errors/AppError','user-','queuedAt','../../helpers/SetTicketMessagesAsRead','path','10585kojAWv','__importDefault','company-','transferMessage','status','750XMONaz','search','whatsappId','open','useIntegration','Need\x20companyId\x20or\x20tokenData','876248ezWbLG','./ShowTicketService','color','enabled','reload','indexOf','../../models/User','../../helpers/CheckSettings','queue','toDate','sendTransferMessage','-open','user','save','verifyMessage','queue-','userId','isGroup','../../libs/socket','(((.+)+)+)+$','update','1176626CXBGpX','chatbot','2418cwvQwK','ratingAt','admin','4111612Bslkkg','default','../WbotServices/SendWhatsAppMessage','3GBstEb','trim','existsSync','Error\x20updating\x20ticket','GetCompanySetting','whatsapp','392TNsFTV','channel','lodash'];a672_0x3a7e=function(){return _0x3148fe;};return a672_0x3a7e();}function a672_0x3347(_0x54014b,_0x1a4cf4){const _0x407908=a672_0x3a7e();return a672_0x3347=function(_0xd04982,_0x563db3){_0xd04982=_0xd04982-0x8e;let _0x3a7eb1=_0x407908[_0xd04982];return _0x3a7eb1;},a672_0x3347(_0x54014b,_0x1a4cf4);}const a672_0x48c513=a672_0x3347;(function(_0x40603f,_0xd93c27){const _0x2590fa=a672_0x3347,_0x311bc4=_0x40603f();while(!![]){try{const _0x32b525=parseInt(_0x2590fa(0xae))/0x1+-parseInt(_0x2590fa(0xc3))/0x2+parseInt(_0x2590fa(0xcb))/0x3*(-parseInt(_0x2590fa(0xc8))/0x4)+parseInt(_0x2590fa(0xa3))/0x5*(parseInt(_0x2590fa(0xc5))/0x6)+parseInt(_0x2590fa(0x98))/0x7+-parseInt(_0x2590fa(0xd1))/0x8*(parseInt(_0x2590fa(0xe4))/0x9)+parseInt(_0x2590fa(0xa8))/0xa*(parseInt(_0x2590fa(0xd9))/0xb);if(_0x32b525===_0xd93c27)break;else _0x311bc4['push'](_0x311bc4['shift']());}catch(_0x383456){_0x311bc4['push'](_0x311bc4['shift']());}}}(a672_0x3a7e,0x7faf9));const a672_0x563db3=(function(){let _0x57c6b2=!![];return function(_0x30fc9c,_0x4807c1){const _0xe4b9e2=_0x57c6b2?function(){if(_0x4807c1){const _0x52c022=_0x4807c1['apply'](_0x30fc9c,arguments);return _0x4807c1=null,_0x52c022;}}:function(){};return _0x57c6b2=![],_0xe4b9e2;};}()),a672_0xd04982=a672_0x563db3(this,function(){const _0x1181e9=a672_0x3347;return a672_0xd04982[_0x1181e9(0x91)]()[_0x1181e9(0xa9)](_0x1181e9(0xc1))['toString']()['constructor'](a672_0xd04982)[_0x1181e9(0xa9)](_0x1181e9(0xc1));});a672_0xd04982();'use strict';var __importDefault=this&&this[a672_0x48c513(0xa4)]||function(_0x360544){const _0x27afa6=a672_0x48c513;return _0x360544&&_0x360544[_0x27afa6(0x9d)]?_0x360544:{'default':_0x360544};};Object[a672_0x48c513(0xd8)](exports,a672_0x48c513(0x9d),{'value':!![]});const moment_1=__importDefault(require('moment')),lodash_1=require(a672_0x48c513(0xd3)),path_1=__importDefault(require(a672_0x48c513(0xa2))),fs_1=__importDefault(require('fs')),CheckContactOpenTickets_1=__importDefault(require(a672_0x48c513(0x90))),SetTicketMessagesAsRead_1=__importDefault(require(a672_0x48c513(0xa1))),socket_1=require(a672_0x48c513(0xc0)),Queue_1=__importDefault(require('../../models/Queue')),User_1=__importDefault(require(a672_0x48c513(0xb4))),ShowTicketService_1=__importDefault(require(a672_0x48c513(0xaf))),ShowWhatsAppService_1=__importDefault(require(a672_0x48c513(0xd6))),SendWhatsAppMessage_1=__importDefault(require(a672_0x48c513(0xca))),SendWhatsAppMedia_1=__importDefault(require('../WbotServices/SendWhatsAppMedia')),FindOrCreateATicketTrakingService_1=__importDefault(require('./FindOrCreateATicketTrakingService')),VerifyHandlers_1=require(a672_0x48c513(0xe2)),AppError_1=__importDefault(require(a672_0x48c513(0x9e))),CheckSettings_1=require(a672_0x48c513(0xb5)),Mustache_1=__importDefault(require(a672_0x48c513(0xdd))),UpdateTicketService=async({ticketData:_0x56df4a,ticketId:_0x50f6b1,tokenData:_0x29a881,companyId:_0x5c87c8})=>{const _0x156583=a672_0x48c513;try{if(!_0x5c87c8&&!_0x29a881)throw new Error(_0x156583(0xad));_0x29a881&&(_0x5c87c8=_0x29a881[_0x156583(0xe3)]);const {justClose:_0x1efab8}=_0x56df4a;let {status:_0x2ed0a5}=_0x56df4a,{queueId:_0x2d952a,userId:_0x92b978}=_0x56df4a,_0x461107=_0x56df4a[_0x156583(0xc4)]||![],_0x1ae411=_0x56df4a[_0x156583(0xac)]||![],_0x1242fb=_0x56df4a['integrationId']||null;const _0x2f5441=(0x0,socket_1[_0x156583(0xd5)])(),_0x3ce23f=await(0x0,ShowTicketService_1['default'])(_0x50f6b1,_0x5c87c8),_0x5ed58a=await(0x0,ShowWhatsAppService_1[_0x156583(0xc9)])(_0x3ce23f[_0x156583(0xaa)],_0x5c87c8);if(_0x29a881&&_0x3ce23f['status']!==_0x156583(0x96)){if(_0x29a881[_0x156583(0xd4)]!==_0x156583(0xc7)&&_0x29a881['profile']!==_0x156583(0x9c)&&_0x3ce23f[_0x156583(0xbe)]!==parseInt(_0x29a881['id'],0xa))throw new AppError_1[(_0x156583(0xc9))]('Apenas\x20o\x20usuário\x20ativo\x20do\x20ticket,\x20Supervisor\x20ou\x20Admin\x20podem\x20fazer\x20alterações\x20no\x20ticket');}const _0x133808=await(0x0,FindOrCreateATicketTrakingService_1[_0x156583(0xc9)])({'ticketId':_0x50f6b1,'companyId':_0x5c87c8,'whatsappId':_0x3ce23f[_0x156583(0xaa)]});_0x3ce23f[_0x156583(0xd2)]==='whatsapp'&&_0x2ed0a5===_0x156583(0xab)&&(0x0,SetTicketMessagesAsRead_1['default'])(_0x3ce23f);const _0xc233f9=_0x3ce23f[_0x156583(0xa7)],_0x454364=_0x3ce23f[_0x156583(0xba)]?.['id'],_0x26d8ef=_0x3ce23f[_0x156583(0x95)];_0xc233f9==='closed'&&(await(0x0,CheckContactOpenTickets_1[_0x156583(0xc9)])(_0x3ce23f['contactId'],_0x3ce23f[_0x156583(0xaa)]),_0x461107=null);if(_0x2ed0a5!==undefined&&['closed'][_0x156583(0xb3)](_0x2ed0a5)>-0x1){const {complationMessage:_0x13256e,ratingMessage:_0x2f3b1e}=await(0x0,ShowWhatsAppService_1[_0x156583(0xc9)])(_0x3ce23f[_0x156583(0xaa)],_0x5c87c8);if(!_0x3ce23f[_0x156583(0xde)][_0x156583(0xbf)]&&!_0x3ce23f['contact'][_0x156583(0x9b)]&&_0x5ed58a[_0x156583(0xdf)]){if(_0x133808[_0x156583(0xc6)]==null&&!_0x1efab8){const _0x520dec=_0x2f3b1e?.[_0x156583(0xcc)]()||'Por\x20favor\x20avalie\x20nosso\x20atendimento',_0x278d70=_0x520dec+'\x0a\x0a*Digite\x20uma\x20nota\x20de\x201\x20a\x205*\x0a';return _0x3ce23f[_0x156583(0xd2)]===_0x156583(0xd0)&&await(0x0,SendWhatsAppMessage_1[_0x156583(0xc9)])({'body':_0x278d70,'ticket':_0x3ce23f}),await _0x133808[_0x156583(0xc2)]({'ratingAt':(0x0,moment_1[_0x156583(0xc9)])()[_0x156583(0xb7)](),'rated':![]}),_0x2f5441['to'](_0x156583(0xa5)+_0x3ce23f[_0x156583(0xe3)]+_0x156583(0xb9))['to'](_0x156583(0xbd)+_0x3ce23f[_0x156583(0x95)]+_0x156583(0xb9))['to'](_0x50f6b1[_0x156583(0x91)]())[_0x156583(0xe8)]('company-'+_0x3ce23f['companyId']+'-ticket',{'action':_0x156583(0x93),'ticketId':_0x3ce23f['id']}),{'ticket':_0x3ce23f,'oldStatus':_0xc233f9,'oldUserId':_0x454364};}_0x133808['ratingAt']=(0x0,moment_1['default'])()['toDate'](),_0x133808[_0x156583(0x8f)]=![];}if(!_0x3ce23f[_0x156583(0xde)]['isGroup']&&!_0x3ce23f[_0x156583(0xde)][_0x156583(0x9b)]&&!_0x1efab8&&!(0x0,lodash_1[_0x156583(0xe1)])(_0x13256e)&&_0x13256e!==''){const _0xc9e29f=(0x0,Mustache_1['default'])(''+_0x13256e,_0x3ce23f);if(_0x3ce23f[_0x156583(0xd2)]===_0x156583(0xd0)&&!_0x3ce23f[_0x156583(0xbf)]){const _0x4864fa=await(0x0,SendWhatsAppMessage_1[_0x156583(0xc9)])({'body':_0xc9e29f,'ticket':_0x3ce23f});await(0x0,VerifyHandlers_1[_0x156583(0xbc)])(_0x4864fa,_0x3ce23f,_0x3ce23f[_0x156583(0xde)]);}}_0x133808[_0x156583(0xd7)]=(0x0,moment_1[_0x156583(0xc9)])()[_0x156583(0xb7)](),_0x133808[_0x156583(0xaa)]=_0x3ce23f[_0x156583(0xaa)],_0x133808[_0x156583(0xbe)]=_0x3ce23f[_0x156583(0xbe)],_0x1ae411=![],_0x1242fb=null;const _0x50d5f9=await(0x0,CheckSettings_1[_0x156583(0xcf)])(_0x5c87c8,_0x156583(0x9a),_0x156583(0xb1));_0x50d5f9==='disabled'&&(_0x2d952a=null,_0x92b978=null);}_0x2d952a!==undefined&&_0x2d952a!==null&&(_0x133808[_0x156583(0xa0)]=(0x0,moment_1[_0x156583(0xc9)])()[_0x156583(0xb7)]());await _0x3ce23f['update']({'status':_0x2ed0a5,'amountUsedBotQueues':_0x56df4a[_0x156583(0xe5)]||0x0,'queueId':_0x2d952a,'userId':_0x92b978,'whatsappId':_0x3ce23f['whatsappId'],'chatbot':_0x461107,'useIntegration':_0x1ae411,'integrationId':_0x1242fb}),await _0x3ce23f['reload']();if(_0x26d8ef!==_0x2d952a&&!(0x0,lodash_1[_0x156583(0xe1)])(_0x26d8ef)&&!(0x0,lodash_1[_0x156583(0xe1)])(_0x2d952a)){if(_0x3ce23f[_0x156583(0xd2)]===_0x156583(0xd0)){const _0xfb8913=await(0x0,ShowWhatsAppService_1['default'])(_0x3ce23f[_0x156583(0xaa)],_0x5c87c8);if(_0xfb8913[_0x156583(0xb8)]&&!_0x3ce23f['isGroup']){if(_0xfb8913[_0x156583(0xa6)]?.['trim']()){await _0x3ce23f[_0x156583(0xb2)]({'include':[{'model':Queue_1[_0x156583(0xc9)],'as':_0x156583(0xb6),'attributes':['id',_0x156583(0x92),'color']},{'model':User_1[_0x156583(0xc9)],'as':'user','attributes':['id',_0x156583(0x92)]}]});const _0x1f311a=(0x0,Mustache_1[_0x156583(0xc9)])(_0xfb8913[_0x156583(0xa6)],_0x3ce23f);await(0x0,SendWhatsAppMessage_1[_0x156583(0xc9)])({'body':_0x1f311a,'ticket':_0x3ce23f});}}}}if(_0xc233f9===_0x156583(0x96)&&_0x2ed0a5===_0x156583(0xab)&&_0x3ce23f['channel']===_0x156583(0xd0)&&!_0x3ce23f[_0x156583(0xbf)]){const _0x4b4985=await(0x0,ShowWhatsAppService_1[_0x156583(0xc9)])(_0x3ce23f['whatsappId'],_0x5c87c8);if(_0x4b4985['sendGreetingAccepted']){const _0x2a30c6=_0x4b4985[_0x156583(0x97)]?.[_0x156583(0xcc)]()||_0x4b4985['greetingMessage']?.[_0x156583(0xcc)]();if(_0x2a30c6){await _0x3ce23f['reload']({'include':[{'model':Queue_1[_0x156583(0xc9)],'as':_0x156583(0xb6),'attributes':['id',_0x156583(0x92),_0x156583(0xb0)]},{'model':User_1['default'],'as':_0x156583(0xba),'attributes':['id',_0x156583(0x92)]}]});if(_0x4b4985[_0x156583(0xda)]){const _0x1da8eb=path_1[_0x156583(0xc9)][_0x156583(0x94)](_0x156583(0x8e),_0x4b4985[_0x156583(0xda)]),_0x732e45=fs_1[_0x156583(0xc9)][_0x156583(0xcd)](_0x1da8eb);if(_0x732e45){const _0x113fdb=(0x0,Mustache_1[_0x156583(0xc9)])(_0x2a30c6,_0x3ce23f);await(0x0,SendWhatsAppMedia_1[_0x156583(0xc9)])({'ticket':_0x3ce23f,'media':_0x1da8eb,'body':_0x113fdb});}else{const _0x436316=(0x0,Mustache_1[_0x156583(0xc9)])(_0x2a30c6,_0x3ce23f);await(0x0,SendWhatsAppMessage_1[_0x156583(0xc9)])({'body':_0x436316,'ticket':_0x3ce23f});}}else{const _0x3201c9=(0x0,Mustache_1[_0x156583(0xc9)])(_0x2a30c6,_0x3ce23f);await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x3201c9,'ticket':_0x3ce23f});}}}}_0x2ed0a5=_0x3ce23f[_0x156583(0xa7)];_0x2ed0a5!==undefined&&[_0x156583(0x96)][_0x156583(0xb3)](_0x2ed0a5)>-0x1&&(_0x133808['update']({'whatsappId':_0x3ce23f[_0x156583(0xaa)],'queuedAt':(0x0,moment_1[_0x156583(0xc9)])()[_0x156583(0xb7)](),'startedAt':null,'userId':null}),_0x2f5441['to']('company-'+_0x5c87c8+_0x156583(0xe6))['emit'](_0x156583(0xa5)+_0x5c87c8+_0x156583(0xe7),{'action':'removeFromList','ticketId':_0x3ce23f?.['id']}));_0x2ed0a5!==undefined&&[_0x156583(0xab)][_0x156583(0xb3)](_0x2ed0a5)>-0x1&&(_0x133808[_0x156583(0xc2)]({'startedAt':(0x0,moment_1[_0x156583(0xc9)])()[_0x156583(0xb7)](),'ratingAt':null,'rated':![],'whatsappId':_0x3ce23f['whatsappId'],'userId':_0x3ce23f[_0x156583(0xbe)]}),_0x2f5441['to'](_0x156583(0xa5)+_0x5c87c8+'-mainchannel')[_0x156583(0xe8)](_0x156583(0xa5)+_0x5c87c8+_0x156583(0xe7),{'action':_0x156583(0xe0),'ticketId':_0x3ce23f?.['id']}),_0x2f5441['to'](_0x156583(0xa5)+_0x5c87c8+'-mainchannel')['emit'](_0x156583(0xa5)+_0x5c87c8+'-ticket',{'action':_0x156583(0xdb),'ticketId':_0x3ce23f?.['id']}));await _0x133808[_0x156583(0xbb)]();if(_0x1efab8&&_0x2ed0a5===_0x156583(0x99))_0x2f5441['to'](_0x156583(0xa5)+_0x5c87c8+_0x156583(0xe6))['emit'](_0x156583(0xa5)+_0x5c87c8+_0x156583(0xe7),{'action':_0x156583(0xe0),'ticketId':_0x3ce23f?.['id']});else _0x3ce23f[_0x156583(0xa7)]===_0x156583(0x99)&&_0x3ce23f[_0x156583(0xa7)]!==_0xc233f9&&_0x2f5441['to'](_0x156583(0xa5)+_0x5c87c8+'-'+_0xc233f9)['to'](_0x156583(0xbd)+_0x3ce23f['queueId']+'-'+_0xc233f9)['to'](_0x156583(0x9f)+_0x454364)[_0x156583(0xe8)]('company-'+_0x5c87c8+'-ticket',{'action':_0x156583(0xe0),'ticketId':_0x3ce23f['id']});return _0x2f5441['to'](_0x156583(0xa5)+_0x5c87c8+'-'+_0x3ce23f[_0x156583(0xa7)])['to'](_0x156583(0xa5)+_0x5c87c8+_0x156583(0xdc))['to'](_0x156583(0xbd)+_0x3ce23f[_0x156583(0x95)]+'-'+_0x3ce23f[_0x156583(0xa7)])['to'](_0x156583(0xbd)+_0x3ce23f[_0x156583(0x95)]+_0x156583(0xdc))['to'](_0x50f6b1['toString']())['to'](_0x156583(0x9f)+_0x3ce23f?.[_0x156583(0xbe)])['to'](_0x156583(0x9f)+_0x454364)['emit'](_0x156583(0xa5)+_0x5c87c8+_0x156583(0xe7),{'action':_0x156583(0xc2),'ticket':_0x3ce23f}),{'ticket':_0x3ce23f,'oldStatus':_0xc233f9,'oldUserId':_0x454364};}catch(_0x3d05c8){if(_0x3d05c8 instanceof AppError_1[_0x156583(0xc9)])throw _0x3d05c8;throw new AppError_1['default'](_0x156583(0xce),0x1f4,_0x3d05c8);}};exports[a672_0x48c513(0xc9)]=UpdateTicketService;