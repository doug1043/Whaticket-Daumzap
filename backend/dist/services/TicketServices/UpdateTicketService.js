const a521_0x25b8a9=a521_0x1319;(function(_0x485bcc,_0x2827ef){const _0x49f7e6=a521_0x1319,_0x41dda2=_0x485bcc();while(!![]){try{const _0x10262f=parseInt(_0x49f7e6(0x231))/0x1+parseInt(_0x49f7e6(0x212))/0x2*(-parseInt(_0x49f7e6(0x22f))/0x3)+parseInt(_0x49f7e6(0x228))/0x4+-parseInt(_0x49f7e6(0x1f9))/0x5+-parseInt(_0x49f7e6(0x1f6))/0x6+parseInt(_0x49f7e6(0x21e))/0x7*(-parseInt(_0x49f7e6(0x23f))/0x8)+parseInt(_0x49f7e6(0x216))/0x9;if(_0x10262f===_0x2827ef)break;else _0x41dda2['push'](_0x41dda2['shift']());}catch(_0x142419){_0x41dda2['push'](_0x41dda2['shift']());}}}(a521_0x5594,0xf24a3));function a521_0x5594(){const _0x19bae1=['notifyUpdate','name','length','../WbotServices/SendWhatsAppMessage','updateUnread','push','__importStar','sendMessage','verifyMessage','enabled','apply','\x0aaguarde,\x20já\x20vamos\x20te\x20atender!','find','amountUsedBotQueues','isNil','DD/MM/YYYY\x20HH:mm:ss','*,\x20em\x20','../../models/Setting','*Mensagem\x20automática*:\x0aFoi\x20transferido\x20para\x20o\x20atendente\x20*','moment','../../helpers/GetTicketWbot','*\x20transferido\x20por\x20','company-','*5*\x20-\x20_Muito\x20Satisfeito_\x0a','*\x20e\x20contará\x20com\x20a\x20presença\x20de\x20*','../WbotServices/wbotMessageListener','finishedAt','hasOwnProperty','create','../UserServices/ShowUserService','10740QjZrlE','chatbot','filter','6606210TyLzRz','ticketId','defineProperty','findOne','-notification','reload','\x0aAguarde,\x20já\x20vamos\x20te\x20atender!','*\x20transferiu\x20o\x20ticket\x20para\x20você,\x20*','userId','getWbot','userRating','whatsappId','open','../SettingServices/ListSettingsServiceOne','getTime','__importDefault','configurable','findByPk','contactId','*3*\x20-\x20_Moderadamente\x20Satisfeito_\x0a','value','ratingAt','@sentry/node','\x20em\x20','-ticket','70BaLiKA','pending','dest','writable','20908251WsoEvP','s.whatsapp.net','../../helpers/CheckContactOpenTickets','status','../../helpers/SetTicketMessagesAsRead','__esModule','user','lodash','146986DEqwiP','isGroup','update','constructor','companyId','prototype','disableBot','Apenas\x20o\x20usuário\x20ativo\x20do\x20ticket\x20ou\x20o\x20Admin\x20podem\x20fazer\x20alterações\x20no\x20ticket','SendPresenceStatus','removeFromList','2199884komeTf','emit','toDate','__createBinding','useIntegration','queue-','toString','60030cTGHYT','search','184687xuyAZh','unreadMessages','*Mensagem\x20automática*:\x0aVocê\x20foi\x20transferido\x20para\x20o\x20departamento\x20*','getOwnPropertyDescriptor','newTicketOnTransfer','default','queueId','(((.+)+)+)+$','rated','username','trace','*\x0aaguarde,\x20já\x20vamos\x20te\x20atender!','contact','closed','16bEILcu','__setModuleDefault','*2*\x20-\x20_Insatisfeito_\x0a','g.us','-mainchannel','number','../../models/Ticket'];a521_0x5594=function(){return _0x19bae1;};return a521_0x5594();}const a521_0xcf34e9=(function(){let _0x588ada=!![];return function(_0x5cf358,_0x5b11ba){const _0x5c1b45=_0x588ada?function(){const _0x1910fe=a521_0x1319;if(_0x5b11ba){const _0x51bd91=_0x5b11ba[_0x1910fe(0x250)](_0x5cf358,arguments);return _0x5b11ba=null,_0x51bd91;}}:function(){};return _0x588ada=![],_0x5c1b45;};}()),a521_0x126860=a521_0xcf34e9(this,function(){const _0x2281d1=a521_0x1319;return a521_0x126860['toString']()['search'](_0x2281d1(0x238))[_0x2281d1(0x22e)]()[_0x2281d1(0x221)](a521_0x126860)[_0x2281d1(0x230)](_0x2281d1(0x238));});a521_0x126860();'use strict';var __createBinding=this&&this[a521_0x25b8a9(0x22b)]||(Object[a521_0x25b8a9(0x1f4)]?function(_0x54167e,_0x4d9c0d,_0x417342,_0x35e409){const _0x492e98=a521_0x25b8a9;if(_0x35e409===undefined)_0x35e409=_0x417342;var _0x3ebd42=Object[_0x492e98(0x234)](_0x4d9c0d,_0x417342);(!_0x3ebd42||('get'in _0x3ebd42?!_0x4d9c0d[_0x492e98(0x21b)]:_0x3ebd42[_0x492e98(0x215)]||_0x3ebd42[_0x492e98(0x209)]))&&(_0x3ebd42={'enumerable':!![],'get':function(){return _0x4d9c0d[_0x417342];}}),Object[_0x492e98(0x1fb)](_0x54167e,_0x35e409,_0x3ebd42);}:function(_0x24b73d,_0x1ae4e8,_0x1b111f,_0x528d2d){if(_0x528d2d===undefined)_0x528d2d=_0x1b111f;_0x24b73d[_0x528d2d]=_0x1ae4e8[_0x1b111f];}),__setModuleDefault=this&&this[a521_0x25b8a9(0x240)]||(Object[a521_0x25b8a9(0x1f4)]?function(_0x2b1543,_0x452d8b){const _0x1fdaca=a521_0x25b8a9;Object[_0x1fdaca(0x1fb)](_0x2b1543,'default',{'enumerable':!![],'value':_0x452d8b});}:function(_0x19500a,_0x39d565){const _0x351674=a521_0x25b8a9;_0x19500a[_0x351674(0x236)]=_0x39d565;}),__importStar=this&&this[a521_0x25b8a9(0x24c)]||function(_0x6f4227){const _0xe006d8=a521_0x25b8a9;if(_0x6f4227&&_0x6f4227[_0xe006d8(0x21b)])return _0x6f4227;var _0x42208f={};if(_0x6f4227!=null){for(var _0x59c638 in _0x6f4227)if(_0x59c638!==_0xe006d8(0x236)&&Object[_0xe006d8(0x223)][_0xe006d8(0x1f3)]['call'](_0x6f4227,_0x59c638))__createBinding(_0x42208f,_0x6f4227,_0x59c638);}return __setModuleDefault(_0x42208f,_0x6f4227),_0x42208f;},__importDefault=this&&this[a521_0x25b8a9(0x208)]||function(_0x5d03f4){const _0x1bf557=a521_0x25b8a9;return _0x5d03f4&&_0x5d03f4[_0x1bf557(0x21b)]?_0x5d03f4:{'default':_0x5d03f4};};Object[a521_0x25b8a9(0x1fb)](exports,a521_0x25b8a9(0x21b),{'value':!![]}),exports[a521_0x25b8a9(0x246)]=void 0x0;const moment_1=__importDefault(require(a521_0x25b8a9(0x259))),Sentry=__importStar(require(a521_0x25b8a9(0x20f))),CheckContactOpenTickets_1=__importDefault(require(a521_0x25b8a9(0x218))),SetTicketMessagesAsRead_1=__importDefault(require(a521_0x25b8a9(0x21a))),socket_1=require('../../libs/socket'),Ticket_1=__importDefault(require(a521_0x25b8a9(0x245))),Setting_1=__importDefault(require(a521_0x25b8a9(0x257))),Queue_1=__importDefault(require('../../models/Queue')),ShowTicketService_1=__importDefault(require('./ShowTicketService')),ShowWhatsAppService_1=__importDefault(require('../WhatsappService/ShowWhatsAppService')),SendWhatsAppMessage_1=__importDefault(require(a521_0x25b8a9(0x249))),FindOrCreateATicketTrakingService_1=__importDefault(require('./FindOrCreateATicketTrakingService')),GetTicketWbot_1=__importDefault(require(a521_0x25b8a9(0x25a))),wbotMessageListener_1=require(a521_0x25b8a9(0x1f1)),ListSettingsServiceOne_1=__importDefault(require(a521_0x25b8a9(0x206))),ShowUserService_1=__importDefault(require(a521_0x25b8a9(0x1f5))),lodash_1=require(a521_0x25b8a9(0x21d)),AppError_1=__importDefault(require('../../errors/AppError')),SendPresenceStatus_1=require('../../helpers/SendPresenceStatus'),wbot_1=require('../../libs/wbot');let completionMessageControl=[];const UpdateTicketService=async({ticketData:_0x3e9825,ticketId:_0x16db1a,tokenData:_0x51bec9,companyId:_0x42f521})=>{const _0x1435d0=a521_0x25b8a9;try{if(!_0x42f521&&!_0x51bec9)throw new Error('Need\x20companyId\x20or\x20tokenData');_0x51bec9&&(_0x42f521=_0x51bec9[_0x1435d0(0x222)]);let {status:_0xe73506}=_0x3e9825,{queueId:_0x95cf8e,userId:_0x4d490f,whatsappId:_0xb6418f,sendFarewellMessage:_0x11f75b}=_0x3e9825;_0x11f75b==null&&(_0x11f75b=!![]);let _0x32aaca=_0x3e9825['chatbot']||![],_0x9374cc=_0x3e9825['queueOptionId']||null,_0x36ca45=_0x3e9825[_0x1435d0(0x22c)]||![],_0x54b2f8=_0x3e9825['integrationId']||null;const _0x46af4d=(0x0,socket_1['getIO'])(),_0x5962d6=_0x1435d0(0x203),_0x163b9f=await Setting_1[_0x1435d0(0x236)][_0x1435d0(0x1fc)]({'where':{'companyId':_0x42f521,'key':_0x5962d6}});let _0x5b300c=await(0x0,ShowTicketService_1[_0x1435d0(0x236)])(_0x16db1a,_0x42f521);if(_0x51bec9&&_0x5b300c[_0x1435d0(0x219)]!==_0x1435d0(0x213)){if(_0x51bec9['profile']!=='admin'&&_0x5b300c[_0x1435d0(0x201)]!==parseInt(_0x51bec9['id'],0xa))throw new AppError_1[(_0x1435d0(0x236))](_0x1435d0(0x225));}const _0xaeb333=await(0x0,FindOrCreateATicketTrakingService_1[_0x1435d0(0x236)])({'ticketId':_0x16db1a,'companyId':_0x42f521,'whatsappId':_0x5b300c[_0x1435d0(0x204)]});(0x0,lodash_1[_0x1435d0(0x254)])(_0xb6418f)&&(_0xb6418f=_0x5b300c[_0x1435d0(0x204)][_0x1435d0(0x22e)]());(_0xe73506==='closed'||_0xe73506===_0x1435d0(0x205))&&await(0x0,SetTicketMessagesAsRead_1[_0x1435d0(0x236)])(_0x5b300c);const _0x4d896e=_0x5b300c[_0x1435d0(0x219)],_0x2f83e9=_0x5b300c[_0x1435d0(0x21c)]?.['id'],_0x5672cd=_0x5b300c[_0x1435d0(0x237)];(_0x4d896e===_0x1435d0(0x23e)||_0xb6418f!==undefined&&Number(_0xb6418f)!==_0x5b300c[_0x1435d0(0x204)])&&(await(0x0,CheckContactOpenTickets_1[_0x1435d0(0x236)])(_0x5b300c[_0x1435d0(0x23d)]['id'],_0xb6418f),_0x32aaca=null,_0x9374cc=null);if(_0xe73506==='closed'){const {complationMessage:_0x50e035,ratingMessage:_0x9b4e68}=await(0x0,ShowWhatsAppService_1[_0x1435d0(0x236)])(_0x5b300c[_0x1435d0(0x204)],_0x42f521);if(!_0x5b300c[_0x1435d0(0x23d)][_0x1435d0(0x224)]&&_0x163b9f?.[_0x1435d0(0x20d)]==='enabled'&&_0x11f75b&&!_0x5b300c['isGroup']){if(_0xaeb333['ratingAt']==null&&!_0x5b300c[_0x1435d0(0x21f)]){const _0x19dc50=_0x9b4e68||'';let _0x24af15='‎'+_0x19dc50+'\x0a\x0a';return _0x24af15+='Digite\x20de\x201\x20à\x205\x20para\x20qualificar\x20nosso\x20atendimento:\x0a'+'*1*\x20-\x20_Muito\x20Insatisfeito_\x0a'+_0x1435d0(0x241)+_0x1435d0(0x20c)+'*4*\x20-\x20_Satisfeito_\x0a'+_0x1435d0(0x1ef),await(0x0,SendPresenceStatus_1[_0x1435d0(0x226)])((0x0,wbot_1[_0x1435d0(0x202)])(_0x5b300c[_0x1435d0(0x204)]),_0x5b300c[_0x1435d0(0x23d)][_0x1435d0(0x244)]+'@'+(_0x5b300c[_0x1435d0(0x21f)]?_0x1435d0(0x242):'s.whatsapp.net')),await(0x0,SendWhatsAppMessage_1[_0x1435d0(0x236)])({'body':_0x24af15,'ticket':_0x5b300c}),await _0xaeb333[_0x1435d0(0x220)]({'rated':![],'ratingAt':(0x0,moment_1[_0x1435d0(0x236)])()['toDate']()}),await _0x5b300c['update']({'amountUsedBotQueues':_0x3e9825[_0x1435d0(0x253)]||0x0,'status':_0xe73506,'unreadMessages':_0x3e9825[_0x1435d0(0x232)]||0x0,'queueId':_0x95cf8e,'userId':_0x4d490f,'whatsappId':_0xb6418f,'chatbot':_0x32aaca,'queueOptionId':_0x9374cc}),_0x46af4d['to']('company-'+_0x5b300c[_0x1435d0(0x222)]+'-open')['to'](_0x16db1a[_0x1435d0(0x22e)]())[_0x1435d0(0x229)](_0x1435d0(0x25c)+_0x5b300c[_0x1435d0(0x222)]+_0x1435d0(0x211),{'action':'delete','ticketId':_0x5b300c['id']}),{'ticket':_0x5b300c,'oldStatus':_0x4d896e,'oldUserId':_0x2f83e9};}_0xaeb333[_0x1435d0(0x20e)]=(0x0,moment_1[_0x1435d0(0x236)])()[_0x1435d0(0x22a)](),_0xaeb333[_0x1435d0(0x239)]=![];}if(completionMessageControl[_0x1435d0(0x248)]>=0x9c4)completionMessageControl=[];if(!(0x0,lodash_1['isNil'])(_0x50e035)&&_0x50e035!==''&&_0x11f75b&&!_0x5b300c['isGroup']){let _0xec1d60=completionMessageControl[_0x1435d0(0x252)](_0x2be865=>_0x2be865[_0x1435d0(0x1fa)]===_0x5b300c['id']||_0x2be865[_0x1435d0(0x214)]===_0x5b300c[_0x1435d0(0x23d)]['number']);if(!_0xec1d60||_0xec1d60&&_0xec1d60['time']+0x3e8*0x3c*0x1e<new Date()[_0x1435d0(0x207)]()){_0xec1d60&&(completionMessageControl=completionMessageControl[_0x1435d0(0x1f8)](_0x3b72b2=>_0x3b72b2[_0x1435d0(0x1fa)]!==_0x5b300c['id']),_0xec1d60=null);if(!_0x5b300c[_0x1435d0(0x23d)][_0x1435d0(0x224)]&&!(0x0,lodash_1[_0x1435d0(0x254)])(_0x50e035)&&_0x50e035!==''){const _0x14d360='‎'+_0x50e035;await(0x0,SendPresenceStatus_1['SendPresenceStatus'])((0x0,wbot_1[_0x1435d0(0x202)])(_0x5b300c[_0x1435d0(0x204)]),_0x5b300c[_0x1435d0(0x23d)][_0x1435d0(0x244)]+'@'+(_0x5b300c[_0x1435d0(0x21f)]?_0x1435d0(0x242):'s.whatsapp.net')),await(0x0,SendWhatsAppMessage_1[_0x1435d0(0x236)])({'body':_0x14d360,'ticket':_0x5b300c});}}!_0xec1d60&&completionMessageControl[_0x1435d0(0x24b)]({'ticketId':_0x5b300c['id'],'dest':_0x5b300c['contact'][_0x1435d0(0x244)],'time':new Date()[_0x1435d0(0x207)]()});}await _0x5b300c[_0x1435d0(0x220)]({'integrationId':null,'useIntegration':![],'typebotStatus':![],'typebotSessionId':null}),_0xaeb333[_0x1435d0(0x1f2)]=(0x0,moment_1['default'])()[_0x1435d0(0x22a)](),_0xaeb333[_0x1435d0(0x204)]=_0x5b300c[_0x1435d0(0x204)],_0xaeb333['userId']=_0x5b300c[_0x1435d0(0x201)];}_0x95cf8e!==undefined&&_0x95cf8e!==null&&(_0xaeb333['queuedAt']=(0x0,moment_1[_0x1435d0(0x236)])()[_0x1435d0(0x22a)]());const _0x1d92f4=await(0x0,ListSettingsServiceOne_1[_0x1435d0(0x236)])({'companyId':_0x42f521,'key':'sendMsgTransfTicket'}),_0x1f41fb=await Queue_1['default'][_0x1435d0(0x20a)](_0x95cf8e);if(_0x1d92f4?.['value']===_0x1435d0(0x24f)){if(_0x5672cd!==_0x95cf8e&&_0x2f83e9===_0x4d490f&&!(0x0,lodash_1[_0x1435d0(0x254)])(_0x5672cd)&&!(0x0,lodash_1[_0x1435d0(0x254)])(_0x95cf8e)){const _0x568bbf=await(0x0,GetTicketWbot_1[_0x1435d0(0x236)])(_0x5b300c),_0x3f0c14=_0x1435d0(0x233)+_0x1f41fb?.[_0x1435d0(0x247)]+_0x1435d0(0x23c);await(0x0,SendPresenceStatus_1[_0x1435d0(0x226)])(_0x568bbf,_0x5b300c[_0x1435d0(0x23d)][_0x1435d0(0x244)]+'@'+(_0x5b300c[_0x1435d0(0x21f)]?_0x1435d0(0x242):_0x1435d0(0x217)));const _0x4c2e02=await _0x568bbf['sendMessage'](_0x5b300c[_0x1435d0(0x23d)][_0x1435d0(0x244)]+'@'+(_0x5b300c[_0x1435d0(0x21f)]?_0x1435d0(0x242):_0x1435d0(0x217)),{'text':_0x3f0c14});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x4c2e02,_0x5b300c,_0x5b300c[_0x1435d0(0x23d)]);}else{if(_0x2f83e9!==_0x4d490f&&_0x5672cd===_0x95cf8e&&!(0x0,lodash_1['isNil'])(_0x2f83e9)&&!(0x0,lodash_1[_0x1435d0(0x254)])(_0x4d490f)){const _0x105658=await(0x0,GetTicketWbot_1[_0x1435d0(0x236)])(_0x5b300c),_0xd8d849=await(0x0,ShowUserService_1[_0x1435d0(0x236)])(_0x3e9825[_0x1435d0(0x201)]),_0x248253=_0x1435d0(0x258)+_0xd8d849[_0x1435d0(0x247)]+'*\x20por\x20'+_0x51bec9[_0x1435d0(0x23a)]+_0x1435d0(0x210)+(0x0,moment_1[_0x1435d0(0x236)])()['format']('DD/MM/YYYY\x20HH:mm:ss')+_0x1435d0(0x1ff);await(0x0,SendPresenceStatus_1[_0x1435d0(0x226)])(_0x105658,_0x5b300c[_0x1435d0(0x23d)][_0x1435d0(0x244)]+'@'+(_0x5b300c[_0x1435d0(0x21f)]?_0x1435d0(0x242):_0x1435d0(0x217)));const _0x12c66d=await _0x105658[_0x1435d0(0x24d)](_0x5b300c['contact'][_0x1435d0(0x244)]+'@'+(_0x5b300c[_0x1435d0(0x21f)]?_0x1435d0(0x242):_0x1435d0(0x217)),{'text':_0x248253});await(0x0,wbotMessageListener_1[_0x1435d0(0x24e)])(_0x12c66d,_0x5b300c,_0x5b300c[_0x1435d0(0x23d)]);}else{if(_0x2f83e9!==_0x4d490f&&!(0x0,lodash_1[_0x1435d0(0x254)])(_0x2f83e9)&&!(0x0,lodash_1[_0x1435d0(0x254)])(_0x4d490f)&&_0x5672cd!==_0x95cf8e&&!(0x0,lodash_1[_0x1435d0(0x254)])(_0x5672cd)&&!(0x0,lodash_1['isNil'])(_0x95cf8e)){const _0x51b8a5=await(0x0,GetTicketWbot_1[_0x1435d0(0x236)])(_0x5b300c),_0x382711=await(0x0,ShowUserService_1[_0x1435d0(0x236)])(_0x3e9825[_0x1435d0(0x201)]),_0x3bcad7=await(0x0,ShowUserService_1[_0x1435d0(0x236)])(_0x2f83e9),_0x3fb8a8=_0x1435d0(0x233)+_0x1f41fb?.[_0x1435d0(0x247)]+_0x1435d0(0x1f0)+_0x382711[_0x1435d0(0x247)]+_0x1435d0(0x25b)+_0x51bec9[_0x1435d0(0x23a)]+'\x20em\x20'+(0x0,moment_1[_0x1435d0(0x236)])()['format'](_0x1435d0(0x255))+_0x1435d0(0x251);await(0x0,SendPresenceStatus_1[_0x1435d0(0x226)])(_0x51b8a5,_0x5b300c['contact']['number']+'@'+(_0x5b300c[_0x1435d0(0x21f)]?_0x1435d0(0x242):_0x1435d0(0x217)));const _0x5b1be8=await _0x51b8a5[_0x1435d0(0x24d)](_0x5b300c[_0x1435d0(0x23d)][_0x1435d0(0x244)]+'@'+(_0x5b300c['isGroup']?_0x1435d0(0x242):_0x1435d0(0x217)),{'text':_0x3fb8a8});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x5b1be8,_0x5b300c,_0x5b300c[_0x1435d0(0x23d)]);const _0x3cf759=await(0x0,ShowUserService_1[_0x1435d0(0x236)])(_0x4d490f),_0x37a05b='*Mensagem\x20automática*:\x0aO\x20atendente\x20anterior\x20*'+_0x3bcad7['name']+_0x1435d0(0x200)+_0x382711[_0x1435d0(0x247)]+_0x1435d0(0x256)+(0x0,moment_1['default'])()['format']('DD/MM/YYYY\x20HH:mm:ss')+_0x1435d0(0x251);await(0x0,SendPresenceStatus_1[_0x1435d0(0x226)])(_0x51b8a5,_0x5b300c['contact'][_0x1435d0(0x244)]+'@'+(_0x5b300c[_0x1435d0(0x21f)]?_0x1435d0(0x242):'s.whatsapp.net'));const _0x344831=await _0x51b8a5[_0x1435d0(0x24d)](_0x5b300c[_0x1435d0(0x23d)][_0x1435d0(0x244)]+'@'+(_0x5b300c['isGroup']?'g.us':_0x1435d0(0x217)),{'text':_0x37a05b});await(0x0,wbotMessageListener_1[_0x1435d0(0x24e)])(_0x344831,_0x5b300c,_0x5b300c[_0x1435d0(0x23d)]);}else{if(_0x2f83e9!==undefined&&(0x0,lodash_1[_0x1435d0(0x254)])(_0x4d490f)&&_0x5672cd!==_0x95cf8e&&!(0x0,lodash_1[_0x1435d0(0x254)])(_0x95cf8e)){const _0x58774e=await(0x0,GetTicketWbot_1[_0x1435d0(0x236)])(_0x5b300c),_0x9565d3=_0x1435d0(0x233)+_0x1f41fb?.[_0x1435d0(0x247)]+_0x1435d0(0x23c);await(0x0,SendPresenceStatus_1[_0x1435d0(0x226)])(_0x58774e,_0x5b300c['contact'][_0x1435d0(0x244)]+'@'+(_0x5b300c[_0x1435d0(0x21f)]?_0x1435d0(0x242):_0x1435d0(0x217)));const _0x3764da=await _0x58774e[_0x1435d0(0x24d)](_0x5b300c[_0x1435d0(0x23d)][_0x1435d0(0x244)]+'@'+(_0x5b300c[_0x1435d0(0x21f)]?_0x1435d0(0x242):_0x1435d0(0x217)),{'text':_0x9565d3});await(0x0,wbotMessageListener_1[_0x1435d0(0x24e)])(_0x3764da,_0x5b300c,_0x5b300c[_0x1435d0(0x23d)]);}}}}}var _0x2c4d4c=_0x5672cd!==_0x95cf8e;return _0x1f41fb&&(_0x2c4d4c&&_0x1f41fb[_0x1435d0(0x235)]&&(_0xe73506=_0x1435d0(0x23e))),await _0x5b300c[_0x1435d0(0x220)]({'amountUsedBotQueues':_0x3e9825[_0x1435d0(0x253)]||0x0,'status':_0xe73506,'unreadMessages':_0x3e9825['unreadMessages']||0x0,'queueId':_0x95cf8e,'userId':_0x4d490f,'whatsappId':_0xb6418f,'chatbot':_0x32aaca,'queueOptionId':_0x9374cc}),await _0x5b300c[_0x1435d0(0x1fe)](),_0x1f41fb&&_0x2c4d4c&&_0x1f41fb[_0x1435d0(0x235)]&&!_0x5b300c[_0x1435d0(0x1f7)]&&!_0x5b300c[_0x1435d0(0x22c)]&&(_0x46af4d['to']('company-'+_0x5b300c[_0x1435d0(0x222)]+'-'+_0x4d896e)['to'](_0x1435d0(0x22d)+_0x5b300c[_0x1435d0(0x237)]+'-'+_0x4d896e)[_0x1435d0(0x229)](_0x1435d0(0x25c)+_0x42f521+_0x1435d0(0x211),{'action':'delete','ticketId':_0x5b300c['id']}),_0x46af4d['to'](_0x1435d0(0x25c)+_0x5b300c['companyId']+'-'+_0x5b300c['status'])['to']('company-'+_0x5b300c[_0x1435d0(0x222)]+_0x1435d0(0x1fd))['to']('queue-'+_0x5b300c[_0x1435d0(0x237)]+'-notification')['to'](_0x1435d0(0x22d)+_0x5b300c[_0x1435d0(0x237)]+'-'+_0x5b300c[_0x1435d0(0x219)])['to'](_0x16db1a['toString']())[_0x1435d0(0x229)](_0x1435d0(0x25c)+_0x42f521+'-ticket',{'action':'update','ticket':_0x5b300c}),_0x5b300c=await Ticket_1['default']['create']({'companyId':_0x42f521,'contactId':_0x5b300c[_0x1435d0(0x20b)],'userId':_0x4d490f,'queueId':_0x95cf8e,'status':'pending','whatsappId':_0x5b300c[_0x1435d0(0x204)],'chatbot':_0x32aaca,'queueOptionId':_0x9374cc,'useIntegration':_0x36ca45,'integrationId':_0x54b2f8,'amountUsedBotQueues':0x0,'unreadMessages':0x0})),_0xe73506=_0x5b300c[_0x1435d0(0x219)],_0xe73506===_0x1435d0(0x213)&&(_0xaeb333[_0x1435d0(0x220)]({'whatsappId':_0xb6418f,'queuedAt':(0x0,moment_1[_0x1435d0(0x236)])()['toDate'](),'startedAt':null,'userId':null}),_0x46af4d['to'](_0x1435d0(0x25c)+_0x42f521+_0x1435d0(0x243))[_0x1435d0(0x229)](_0x1435d0(0x25c)+_0x42f521+_0x1435d0(0x211),{'action':'removeFromList','ticketId':_0x5b300c?.['id']})),_0xe73506===_0x1435d0(0x205)&&(_0xaeb333[_0x1435d0(0x220)]({'startedAt':(0x0,moment_1[_0x1435d0(0x236)])()[_0x1435d0(0x22a)](),'ratingAt':null,'rated':![],'whatsappId':_0xb6418f,'userId':_0x5b300c[_0x1435d0(0x201)]}),_0x46af4d['to'](_0x1435d0(0x25c)+_0x42f521+_0x1435d0(0x243))[_0x1435d0(0x229)](_0x1435d0(0x25c)+_0x42f521+_0x1435d0(0x211),{'action':_0x1435d0(0x227),'ticketId':_0x5b300c?.['id']}),_0x46af4d['to'](_0x1435d0(0x25c)+_0x42f521+_0x1435d0(0x243))[_0x1435d0(0x229)](_0x1435d0(0x25c)+_0x42f521+_0x1435d0(0x211),{'action':_0x1435d0(0x24a),'ticketId':_0x5b300c?.['id']})),await _0xaeb333['save'](),(_0x5b300c[_0x1435d0(0x219)]!==_0x4d896e||_0x5b300c[_0x1435d0(0x21c)]?.['id']!==_0x2f83e9||_0x2c4d4c)&&_0x46af4d['to'](_0x1435d0(0x25c)+_0x5b300c[_0x1435d0(0x222)]+'-'+_0x4d896e)['to'](_0x1435d0(0x22d)+_0x5b300c[_0x1435d0(0x237)]+'-'+_0x4d896e)['to']('company-'+_0x5b300c[_0x1435d0(0x222)]+_0x1435d0(0x1fd))['to']('queue-'+_0x5b300c[_0x1435d0(0x237)]+_0x1435d0(0x1fd))['to'](_0x16db1a[_0x1435d0(0x22e)]())[_0x1435d0(0x229)](_0x1435d0(0x25c)+_0x42f521+_0x1435d0(0x211),{'action':'delete','ticketId':_0x5b300c['id']}),_0x5b300c[_0x1435d0(0x219)]!=='closed'&&_0x46af4d['to'](_0x1435d0(0x25c)+_0x5b300c['companyId']+'-'+_0x5b300c[_0x1435d0(0x219)])['to'](_0x1435d0(0x25c)+_0x5b300c['companyId']+'-notification')['to']('queue-'+_0x5b300c['queueId']+_0x1435d0(0x1fd))['to']('queue-'+_0x5b300c[_0x1435d0(0x237)]+'-'+_0x5b300c[_0x1435d0(0x219)])['to'](_0x16db1a[_0x1435d0(0x22e)]())[_0x1435d0(0x229)](_0x1435d0(0x25c)+_0x42f521+_0x1435d0(0x211),{'action':_0x1435d0(0x220),'ticket':_0x5b300c}),{'ticket':_0x5b300c,'oldStatus':_0x4d896e,'oldUserId':_0x2f83e9};}catch(_0xef97a1){console[_0x1435d0(0x23b)](_0xef97a1),Sentry['captureException'](_0xef97a1);}};exports['default']=UpdateTicketService;function a521_0x1319(_0x3888b6,_0x6ef3f1){const _0x1a7bf4=a521_0x5594();return a521_0x1319=function(_0x126860,_0xcf34e9){_0x126860=_0x126860-0x1ef;let _0x5594ff=_0x1a7bf4[_0x126860];return _0x5594ff;},a521_0x1319(_0x3888b6,_0x6ef3f1);}const notifyUpdate=(_0x9280ac,_0x43929e,_0xbecfdb,_0x10e485)=>{const _0x336bdd=a521_0x25b8a9;_0x9280ac['to']('company-'+_0x43929e[_0x336bdd(0x222)]+'-'+_0x43929e[_0x336bdd(0x219)])['to']('company-'+_0x43929e['companyId']+_0x336bdd(0x1fd))['to'](_0xbecfdb['toString']())[_0x336bdd(0x229)](_0x336bdd(0x25c)+_0x10e485+_0x336bdd(0x211),{'action':_0x336bdd(0x220),'ticket':_0x43929e});};exports['notifyUpdate']=notifyUpdate;