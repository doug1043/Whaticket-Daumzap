const a531_0x470c78=a531_0x494a;(function(_0x5163f8,_0x332f27){const _0x1528a5=a531_0x494a,_0x3f5358=_0x5163f8();while(!![]){try{const _0x38740e=-parseInt(_0x1528a5(0x143))/0x1+-parseInt(_0x1528a5(0xda))/0x2+parseInt(_0x1528a5(0x137))/0x3*(parseInt(_0x1528a5(0x100))/0x4)+-parseInt(_0x1528a5(0x10a))/0x5+parseInt(_0x1528a5(0x138))/0x6*(parseInt(_0x1528a5(0xf7))/0x7)+parseInt(_0x1528a5(0x107))/0x8+parseInt(_0x1528a5(0xdf))/0x9*(parseInt(_0x1528a5(0xf1))/0xa);if(_0x38740e===_0x332f27)break;else _0x3f5358['push'](_0x3f5358['shift']());}catch(_0x4f9e36){_0x3f5358['push'](_0x3f5358['shift']());}}}(a531_0xce14,0x89de7));const a531_0x5e6cc7=(function(){let _0x7c0810=!![];return function(_0x3bbf59,_0xb17b95){const _0x5b4b04=_0x7c0810?function(){if(_0xb17b95){const _0x28de1f=_0xb17b95['apply'](_0x3bbf59,arguments);return _0xb17b95=null,_0x28de1f;}}:function(){};return _0x7c0810=![],_0x5b4b04;};}()),a531_0x4c6e21=a531_0x5e6cc7(this,function(){const _0x38fcd2=a531_0x494a;return a531_0x4c6e21['toString']()[_0x38fcd2(0xff)]('(((.+)+)+)+$')['toString']()['constructor'](a531_0x4c6e21)[_0x38fcd2(0xff)](_0x38fcd2(0x139));});function a531_0x494a(_0x2cb212,_0x1f6008){const _0x192f14=a531_0xce14();return a531_0x494a=function(_0x4c6e21,_0x5e6cc7){_0x4c6e21=_0x4c6e21-0xd1;let _0xce14e7=_0x192f14[_0x4c6e21];return _0xce14e7;},a531_0x494a(_0x2cb212,_0x1f6008);}a531_0x4c6e21();'use strict';var __createBinding=this&&this[a531_0x470c78(0xeb)]||(Object[a531_0x470c78(0xd7)]?function(_0x2bbf33,_0x4a888f,_0x3e0e6f,_0x266c97){const _0x17d3e0=a531_0x470c78;if(_0x266c97===undefined)_0x266c97=_0x3e0e6f;var _0x3d305c=Object[_0x17d3e0(0xfd)](_0x4a888f,_0x3e0e6f);(!_0x3d305c||(_0x17d3e0(0x11a)in _0x3d305c?!_0x4a888f['__esModule']:_0x3d305c[_0x17d3e0(0xfc)]||_0x3d305c[_0x17d3e0(0xd9)]))&&(_0x3d305c={'enumerable':!![],'get':function(){return _0x4a888f[_0x3e0e6f];}}),Object['defineProperty'](_0x2bbf33,_0x266c97,_0x3d305c);}:function(_0x355979,_0x558aeb,_0x51e7cf,_0x11dfcf){if(_0x11dfcf===undefined)_0x11dfcf=_0x51e7cf;_0x355979[_0x11dfcf]=_0x558aeb[_0x51e7cf];}),__setModuleDefault=this&&this[a531_0x470c78(0xfe)]||(Object[a531_0x470c78(0xd7)]?function(_0x3ba354,_0x4d6050){const _0x56addd=a531_0x470c78;Object[_0x56addd(0xdd)](_0x3ba354,_0x56addd(0x128),{'enumerable':!![],'value':_0x4d6050});}:function(_0x150ec3,_0x3f7f30){const _0x2247ba=a531_0x470c78;_0x150ec3[_0x2247ba(0x128)]=_0x3f7f30;}),__importStar=this&&this[a531_0x470c78(0xd8)]||function(_0x15e3dc){const _0x5f2ce2=a531_0x470c78;if(_0x15e3dc&&_0x15e3dc[_0x5f2ce2(0x11c)])return _0x15e3dc;var _0xef9d={};if(_0x15e3dc!=null){for(var _0x585455 in _0x15e3dc)if(_0x585455!==_0x5f2ce2(0x128)&&Object['prototype'][_0x5f2ce2(0x10f)][_0x5f2ce2(0x118)](_0x15e3dc,_0x585455))__createBinding(_0xef9d,_0x15e3dc,_0x585455);}return __setModuleDefault(_0xef9d,_0x15e3dc),_0xef9d;},__importDefault=this&&this[a531_0x470c78(0xe6)]||function(_0x24f0de){const _0x1feb9a=a531_0x470c78;return _0x24f0de&&_0x24f0de[_0x1feb9a(0x11c)]?_0x24f0de:{'default':_0x24f0de};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a531_0x470c78(0x105)]=void 0x0;const moment_1=__importDefault(require(a531_0x470c78(0x12c))),Sentry=__importStar(require('@sentry/node')),CheckContactOpenTickets_1=__importDefault(require(a531_0x470c78(0x104))),SetTicketMessagesAsRead_1=__importDefault(require('../../helpers/SetTicketMessagesAsRead')),socket_1=require(a531_0x470c78(0x13e)),Ticket_1=__importDefault(require('../../models/Ticket')),Setting_1=__importDefault(require('../../models/Setting')),Queue_1=__importDefault(require(a531_0x470c78(0xee))),ShowTicketService_1=__importDefault(require(a531_0x470c78(0xec))),ShowWhatsAppService_1=__importDefault(require(a531_0x470c78(0x113))),SendWhatsAppMessage_1=__importDefault(require(a531_0x470c78(0xd1))),FindOrCreateATicketTrakingService_1=__importDefault(require(a531_0x470c78(0x130))),GetTicketWbot_1=__importDefault(require(a531_0x470c78(0x10b))),wbotMessageListener_1=require('../WbotServices/wbotMessageListener'),ListSettingsServiceOne_1=__importDefault(require(a531_0x470c78(0x10c))),ShowUserService_1=__importDefault(require(a531_0x470c78(0x131))),lodash_1=require(a531_0x470c78(0xde)),AppError_1=__importDefault(require(a531_0x470c78(0x13a))),SendPresenceStatus_1=require(a531_0x470c78(0x101)),wbot_1=require(a531_0x470c78(0xe3));let completionMessageControl=[];const UpdateTicketService=async({ticketData:_0xbba585,ticketId:_0x135882,tokenData:_0x44406e,companyId:_0x1a1e59})=>{const _0x1e63d3=a531_0x470c78;try{if(!_0x1a1e59&&!_0x44406e)throw new Error('Need\x20companyId\x20or\x20tokenData');_0x44406e&&(_0x1a1e59=_0x44406e['companyId']);let {status:_0x2bedb8}=_0xbba585,{queueId:_0x191e37,userId:_0x490ed9,whatsappId:_0x5602f4,sendFarewellMessage:_0x7783ab}=_0xbba585;_0x7783ab==null&&(_0x7783ab=!![]);let _0x47a654=_0xbba585[_0x1e63d3(0xef)]||![],_0x4534cc=_0xbba585[_0x1e63d3(0x12e)]||null,_0x9a5064=_0xbba585[_0x1e63d3(0xfb)]||null,_0x5257cf=_0xbba585[_0x1e63d3(0x117)]||![],_0x55f048=_0xbba585[_0x1e63d3(0xf4)]||null;const _0x444192=(0x0,socket_1['getIO'])(),_0x5062ba=_0x1e63d3(0x112),_0x74a04f=await Setting_1[_0x1e63d3(0x128)][_0x1e63d3(0x129)]({'where':{'companyId':_0x1a1e59,'key':_0x5062ba}});let _0x323c68=await(0x0,ShowTicketService_1[_0x1e63d3(0x128)])(_0x135882,_0x1a1e59);if(_0x44406e&&_0x323c68[_0x1e63d3(0xe1)]!=='pending'){if(_0x44406e['profile']!=='admin'&&_0x323c68[_0x1e63d3(0x13d)]!==parseInt(_0x44406e['id'],0xa))throw new AppError_1[(_0x1e63d3(0x128))](_0x1e63d3(0xd5));}const _0x150705=await(0x0,FindOrCreateATicketTrakingService_1['default'])({'ticketId':_0x135882,'companyId':_0x1a1e59,'whatsappId':_0x323c68[_0x1e63d3(0xd6)]});(0x0,lodash_1[_0x1e63d3(0x142)])(_0x5602f4)&&(_0x5602f4=_0x323c68['whatsappId'][_0x1e63d3(0x106)]());(_0x2bedb8===_0x1e63d3(0xd2)||_0x2bedb8===_0x1e63d3(0x135))&&await(0x0,SetTicketMessagesAsRead_1[_0x1e63d3(0x128)])(_0x323c68);const _0x45b153=_0x323c68[_0x1e63d3(0xe1)],_0x4550a8=_0x323c68['user']?.['id'],_0x5bad61=_0x323c68[_0x1e63d3(0x124)];(_0x45b153===_0x1e63d3(0xd2)||_0x5602f4!==undefined&&Number(_0x5602f4)!==_0x323c68[_0x1e63d3(0xd6)])&&(await(0x0,CheckContactOpenTickets_1[_0x1e63d3(0x128)])(_0x323c68[_0x1e63d3(0x103)]['id'],_0x5602f4),_0x47a654=null,_0x4534cc=null);if(_0x2bedb8===_0x1e63d3(0xd2)){const {complationMessage:_0xd5c9cb,ratingMessage:_0x21cbbc}=await(0x0,ShowWhatsAppService_1[_0x1e63d3(0x128)])(_0x323c68[_0x1e63d3(0xd6)],_0x1a1e59);if(!_0x323c68[_0x1e63d3(0x103)][_0x1e63d3(0x10e)]&&_0x74a04f?.[_0x1e63d3(0x109)]===_0x1e63d3(0x122)&&_0x7783ab&&!_0x323c68[_0x1e63d3(0xf5)]){if(_0x150705['ratingAt']==null&&!_0x323c68['isGroup']){const _0x54e050=_0x21cbbc||'';let _0x1502f5='‎'+_0x54e050+'\x0a\x0a';return _0x1502f5+='Digite\x20de\x201\x20à\x205\x20para\x20qualificar\x20nosso\x20atendimento:\x0a'+'*1*\x20-\x20_Muito\x20Insatisfeito_\x0a'+_0x1e63d3(0xf3)+_0x1e63d3(0x119)+'*4*\x20-\x20_Satisfeito_\x0a'+'*5*\x20-\x20_Muito\x20Satisfeito_\x0a',await(0x0,SendPresenceStatus_1['SendPresenceStatus'])((0x0,wbot_1[_0x1e63d3(0x140)])(_0x323c68[_0x1e63d3(0xd6)]),_0x323c68[_0x1e63d3(0x103)][_0x1e63d3(0xe9)]+'@'+(_0x323c68[_0x1e63d3(0xf5)]?_0x1e63d3(0x10d):_0x1e63d3(0x11f))),await(0x0,SendWhatsAppMessage_1[_0x1e63d3(0x128)])({'body':_0x1502f5,'ticket':_0x323c68}),await _0x150705[_0x1e63d3(0x126)]({'rated':![],'ratingAt':(0x0,moment_1[_0x1e63d3(0x128)])()['toDate']()}),await _0x323c68[_0x1e63d3(0x126)]({'amountUsedBotQueues':_0xbba585['amountUsedBotQueues']||0x0,'status':_0x2bedb8,'unreadMessages':_0xbba585[_0x1e63d3(0xe7)]||0x0,'queueId':_0x191e37,'userId':_0x490ed9,'whatsappId':_0x5602f4,'chatbot':_0x47a654,'queueOptionId':_0x4534cc}),_0x444192['to'](_0x1e63d3(0xdc)+_0x323c68[_0x1e63d3(0x110)]+'-open')['to'](_0x135882[_0x1e63d3(0x106)]())[_0x1e63d3(0x136)](_0x1e63d3(0xdc)+_0x323c68[_0x1e63d3(0x110)]+'-ticket',{'action':_0x1e63d3(0xea),'ticketId':_0x323c68['id']}),{'ticket':_0x323c68,'oldStatus':_0x45b153,'oldUserId':_0x4550a8};}_0x150705[_0x1e63d3(0x125)]=(0x0,moment_1[_0x1e63d3(0x128)])()[_0x1e63d3(0x102)](),_0x150705[_0x1e63d3(0xf8)]=![];}if(completionMessageControl[_0x1e63d3(0x127)]>=0x9c4)completionMessageControl=[];if(!(0x0,lodash_1[_0x1e63d3(0x142)])(_0xd5c9cb)&&_0xd5c9cb!==''&&_0x7783ab&&!_0x323c68['isGroup']){let _0x5cced=completionMessageControl[_0x1e63d3(0x116)](_0x39fcab=>_0x39fcab[_0x1e63d3(0xe4)]===_0x323c68['id']||_0x39fcab[_0x1e63d3(0x12d)]===_0x323c68[_0x1e63d3(0x103)]['number']);if(!_0x5cced||_0x5cced&&_0x5cced[_0x1e63d3(0xdb)]+0x3e8*0x3c*0x1e<new Date()['getTime']()){_0x5cced&&(completionMessageControl=completionMessageControl['filter'](_0x51f44e=>_0x51f44e[_0x1e63d3(0xe4)]!==_0x323c68['id']),_0x5cced=null);if(!_0x323c68[_0x1e63d3(0x103)][_0x1e63d3(0x10e)]&&!(0x0,lodash_1['isNil'])(_0xd5c9cb)&&_0xd5c9cb!==''){const _0x14c191='‎'+_0xd5c9cb;await(0x0,SendPresenceStatus_1[_0x1e63d3(0xe0)])((0x0,wbot_1[_0x1e63d3(0x140)])(_0x323c68[_0x1e63d3(0xd6)]),_0x323c68[_0x1e63d3(0x103)][_0x1e63d3(0xe9)]+'@'+(_0x323c68[_0x1e63d3(0xf5)]?_0x1e63d3(0x10d):'s.whatsapp.net')),await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x14c191,'ticket':_0x323c68});}}!_0x5cced&&completionMessageControl['push']({'ticketId':_0x323c68['id'],'dest':_0x323c68[_0x1e63d3(0x103)][_0x1e63d3(0xe9)],'time':new Date()[_0x1e63d3(0x133)]()});}await _0x323c68['update']({'promptId':null,'integrationId':null,'useIntegration':![],'typebotStatus':![],'typebotSessionId':null}),_0x150705['finishedAt']=(0x0,moment_1[_0x1e63d3(0x128)])()[_0x1e63d3(0x102)](),_0x150705[_0x1e63d3(0xd6)]=_0x323c68[_0x1e63d3(0xd6)],_0x150705[_0x1e63d3(0x13d)]=_0x323c68[_0x1e63d3(0x13d)];}_0x191e37!==undefined&&_0x191e37!==null&&(_0x150705[_0x1e63d3(0xed)]=(0x0,moment_1[_0x1e63d3(0x128)])()[_0x1e63d3(0x102)]());const _0x1caca0=await(0x0,ListSettingsServiceOne_1[_0x1e63d3(0x128)])({'companyId':_0x1a1e59,'key':_0x1e63d3(0xf0)}),_0x3f1a72=await Queue_1['default'][_0x1e63d3(0xe2)](_0x191e37);if(_0x1caca0?.['value']===_0x1e63d3(0x122)){if(_0x5bad61!==_0x191e37&&_0x4550a8===_0x490ed9&&!(0x0,lodash_1['isNil'])(_0x5bad61)&&!(0x0,lodash_1[_0x1e63d3(0x142)])(_0x191e37)){const _0x1b70b0=await(0x0,GetTicketWbot_1[_0x1e63d3(0x128)])(_0x323c68),_0x40f8b0=_0x1e63d3(0x12b)+_0x3f1a72?.['name']+_0x1e63d3(0xe8);await(0x0,SendPresenceStatus_1[_0x1e63d3(0xe0)])(_0x1b70b0,_0x323c68[_0x1e63d3(0x103)][_0x1e63d3(0xe9)]+'@'+(_0x323c68[_0x1e63d3(0xf5)]?_0x1e63d3(0x10d):_0x1e63d3(0x11f)));const _0x15666f=await _0x1b70b0['sendMessage'](_0x323c68['contact'][_0x1e63d3(0xe9)]+'@'+(_0x323c68[_0x1e63d3(0xf5)]?_0x1e63d3(0x10d):'s.whatsapp.net'),{'text':_0x40f8b0});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x15666f,_0x323c68,_0x323c68[_0x1e63d3(0x103)]);}else{if(_0x4550a8!==_0x490ed9&&_0x5bad61===_0x191e37&&!(0x0,lodash_1['isNil'])(_0x4550a8)&&!(0x0,lodash_1['isNil'])(_0x490ed9)){const _0x4493b4=await(0x0,GetTicketWbot_1[_0x1e63d3(0x128)])(_0x323c68),_0x509b63=await(0x0,ShowUserService_1['default'])(_0xbba585[_0x1e63d3(0x13d)]),_0x28e95b='*Mensagem\x20automática*:\x0aFoi\x20transferido\x20para\x20o\x20atendente\x20*'+_0x509b63[_0x1e63d3(0x114)]+_0x1e63d3(0xf9)+_0x44406e[_0x1e63d3(0xd3)]+'\x20em\x20'+(0x0,moment_1[_0x1e63d3(0x128)])()[_0x1e63d3(0xfa)](_0x1e63d3(0x108))+'\x0aAguarde,\x20já\x20vamos\x20te\x20atender!';await(0x0,SendPresenceStatus_1[_0x1e63d3(0xe0)])(_0x4493b4,_0x323c68[_0x1e63d3(0x103)][_0x1e63d3(0xe9)]+'@'+(_0x323c68[_0x1e63d3(0xf5)]?_0x1e63d3(0x10d):_0x1e63d3(0x11f)));const _0x8339d4=await _0x4493b4[_0x1e63d3(0xe5)](_0x323c68[_0x1e63d3(0x103)]['number']+'@'+(_0x323c68[_0x1e63d3(0xf5)]?'g.us':'s.whatsapp.net'),{'text':_0x28e95b});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x8339d4,_0x323c68,_0x323c68[_0x1e63d3(0x103)]);}else{if(_0x4550a8!==_0x490ed9&&!(0x0,lodash_1[_0x1e63d3(0x142)])(_0x4550a8)&&!(0x0,lodash_1[_0x1e63d3(0x142)])(_0x490ed9)&&_0x5bad61!==_0x191e37&&!(0x0,lodash_1[_0x1e63d3(0x142)])(_0x5bad61)&&!(0x0,lodash_1[_0x1e63d3(0x142)])(_0x191e37)){const _0x37936f=await(0x0,GetTicketWbot_1['default'])(_0x323c68),_0x4a9f73=await(0x0,ShowUserService_1[_0x1e63d3(0x128)])(_0xbba585['userId']),_0x1f75fe=await(0x0,ShowUserService_1[_0x1e63d3(0x128)])(_0x4550a8),_0x1fe093=_0x1e63d3(0x12b)+_0x3f1a72?.[_0x1e63d3(0x114)]+'*\x20e\x20contará\x20com\x20a\x20presença\x20de\x20*'+_0x4a9f73[_0x1e63d3(0x114)]+_0x1e63d3(0x134)+_0x44406e[_0x1e63d3(0xd3)]+_0x1e63d3(0x111)+(0x0,moment_1[_0x1e63d3(0x128)])()[_0x1e63d3(0xfa)](_0x1e63d3(0x108))+_0x1e63d3(0x141);await(0x0,SendPresenceStatus_1[_0x1e63d3(0xe0)])(_0x37936f,_0x323c68['contact'][_0x1e63d3(0xe9)]+'@'+(_0x323c68['isGroup']?_0x1e63d3(0x10d):'s.whatsapp.net'));const _0x3f818d=await _0x37936f[_0x1e63d3(0xe5)](_0x323c68[_0x1e63d3(0x103)][_0x1e63d3(0xe9)]+'@'+(_0x323c68[_0x1e63d3(0xf5)]?_0x1e63d3(0x10d):_0x1e63d3(0x11f)),{'text':_0x1fe093});await(0x0,wbotMessageListener_1[_0x1e63d3(0xd4)])(_0x3f818d,_0x323c68,_0x323c68[_0x1e63d3(0x103)]);const _0x5daa9b=await(0x0,ShowUserService_1[_0x1e63d3(0x128)])(_0x490ed9),_0x240120=_0x1e63d3(0x123)+_0x1f75fe[_0x1e63d3(0x114)]+_0x1e63d3(0xf2)+_0x4a9f73[_0x1e63d3(0x114)]+_0x1e63d3(0x120)+(0x0,moment_1[_0x1e63d3(0x128)])()[_0x1e63d3(0xfa)](_0x1e63d3(0x108))+_0x1e63d3(0x141);await(0x0,SendPresenceStatus_1['SendPresenceStatus'])(_0x37936f,_0x323c68['contact'][_0x1e63d3(0xe9)]+'@'+(_0x323c68[_0x1e63d3(0xf5)]?_0x1e63d3(0x10d):_0x1e63d3(0x11f)));const _0x171ab8=await _0x37936f[_0x1e63d3(0xe5)](_0x323c68[_0x1e63d3(0x103)][_0x1e63d3(0xe9)]+'@'+(_0x323c68['isGroup']?_0x1e63d3(0x10d):_0x1e63d3(0x11f)),{'text':_0x240120});await(0x0,wbotMessageListener_1[_0x1e63d3(0xd4)])(_0x171ab8,_0x323c68,_0x323c68[_0x1e63d3(0x103)]);}else{if(_0x4550a8!==undefined&&(0x0,lodash_1[_0x1e63d3(0x142)])(_0x490ed9)&&_0x5bad61!==_0x191e37&&!(0x0,lodash_1[_0x1e63d3(0x142)])(_0x191e37)){const _0x7015e9=await(0x0,GetTicketWbot_1[_0x1e63d3(0x128)])(_0x323c68),_0x1109c0=_0x1e63d3(0x12b)+_0x3f1a72?.[_0x1e63d3(0x114)]+_0x1e63d3(0xe8);await(0x0,SendPresenceStatus_1[_0x1e63d3(0xe0)])(_0x7015e9,_0x323c68[_0x1e63d3(0x103)]['number']+'@'+(_0x323c68[_0x1e63d3(0xf5)]?'g.us':'s.whatsapp.net'));const _0x2ff1a9=await _0x7015e9['sendMessage'](_0x323c68[_0x1e63d3(0x103)][_0x1e63d3(0xe9)]+'@'+(_0x323c68['isGroup']?_0x1e63d3(0x10d):'s.whatsapp.net'),{'text':_0x1109c0});await(0x0,wbotMessageListener_1[_0x1e63d3(0xd4)])(_0x2ff1a9,_0x323c68,_0x323c68[_0x1e63d3(0x103)]);}}}}}var _0x4ca77d=_0x5bad61!==_0x191e37;return _0x3f1a72&&(_0x4ca77d&&_0x3f1a72[_0x1e63d3(0x11b)]&&(_0x2bedb8=_0x1e63d3(0xd2))),await _0x323c68[_0x1e63d3(0x126)]({'amountUsedBotQueues':_0xbba585[_0x1e63d3(0x132)]||0x0,'status':_0x2bedb8,'unreadMessages':_0xbba585[_0x1e63d3(0xe7)]||0x0,'queueId':_0x191e37,'userId':_0x490ed9,'whatsappId':_0x5602f4,'chatbot':_0x47a654,'queueOptionId':_0x4534cc}),await _0x323c68['reload'](),_0x3f1a72&&_0x4ca77d&&_0x3f1a72['newTicketOnTransfer']&&!_0x323c68[_0x1e63d3(0xef)]&&!_0x323c68[_0x1e63d3(0x117)]&&(_0x444192['to'](_0x1e63d3(0xdc)+_0x323c68[_0x1e63d3(0x110)]+'-'+_0x45b153)['to'](_0x1e63d3(0x115)+_0x323c68['queueId']+'-'+_0x45b153)[_0x1e63d3(0x136)](_0x1e63d3(0xdc)+_0x1a1e59+_0x1e63d3(0x13b),{'action':_0x1e63d3(0xea),'ticketId':_0x323c68['id']}),_0x444192['to'](_0x1e63d3(0xdc)+_0x323c68['companyId']+'-'+_0x323c68['status'])['to']('company-'+_0x323c68[_0x1e63d3(0x110)]+_0x1e63d3(0x13f))['to']('queue-'+_0x323c68[_0x1e63d3(0x124)]+'-notification')['to'](_0x1e63d3(0x115)+_0x323c68[_0x1e63d3(0x124)]+'-'+_0x323c68[_0x1e63d3(0xe1)])['to'](_0x135882[_0x1e63d3(0x106)]())[_0x1e63d3(0x136)](_0x1e63d3(0xdc)+_0x1a1e59+_0x1e63d3(0x13b),{'action':_0x1e63d3(0x126),'ticket':_0x323c68}),_0x323c68=await Ticket_1[_0x1e63d3(0x128)]['create']({'companyId':_0x1a1e59,'contactId':_0x323c68[_0x1e63d3(0x13c)],'userId':_0x490ed9,'queueId':_0x191e37,'status':'pending','whatsappId':_0x323c68[_0x1e63d3(0xd6)],'chatbot':_0x47a654,'queueOptionId':_0x4534cc,'promptId':_0x9a5064,'useIntegration':_0x5257cf,'integrationId':_0x55f048,'amountUsedBotQueues':0x0,'unreadMessages':0x0})),_0x2bedb8=_0x323c68[_0x1e63d3(0xe1)],_0x2bedb8===_0x1e63d3(0x11d)&&(_0x150705[_0x1e63d3(0x126)]({'whatsappId':_0x5602f4,'queuedAt':(0x0,moment_1['default'])()[_0x1e63d3(0x102)](),'startedAt':null,'userId':null}),_0x444192['to']('company-'+_0x1a1e59+_0x1e63d3(0xf6))[_0x1e63d3(0x136)](_0x1e63d3(0xdc)+_0x1a1e59+_0x1e63d3(0x13b),{'action':_0x1e63d3(0x12a),'ticketId':_0x323c68?.['id']})),_0x2bedb8===_0x1e63d3(0x135)&&(_0x150705[_0x1e63d3(0x126)]({'startedAt':(0x0,moment_1[_0x1e63d3(0x128)])()[_0x1e63d3(0x102)](),'ratingAt':null,'rated':![],'whatsappId':_0x5602f4,'userId':_0x323c68[_0x1e63d3(0x13d)]}),_0x444192['to'](_0x1e63d3(0xdc)+_0x1a1e59+_0x1e63d3(0xf6))['emit'](_0x1e63d3(0xdc)+_0x1a1e59+'-ticket',{'action':'removeFromList','ticketId':_0x323c68?.['id']}),_0x444192['to'](_0x1e63d3(0xdc)+_0x1a1e59+_0x1e63d3(0xf6))['emit'](_0x1e63d3(0xdc)+_0x1a1e59+_0x1e63d3(0x13b),{'action':_0x1e63d3(0x12f),'ticketId':_0x323c68?.['id']})),await _0x150705['save'](),(_0x323c68[_0x1e63d3(0xe1)]!==_0x45b153||_0x323c68[_0x1e63d3(0x121)]?.['id']!==_0x4550a8||_0x4ca77d)&&_0x444192['to'](_0x1e63d3(0xdc)+_0x323c68['companyId']+'-'+_0x45b153)['to'](_0x1e63d3(0x115)+_0x323c68['queueId']+'-'+_0x45b153)['to']('company-'+_0x323c68[_0x1e63d3(0x110)]+_0x1e63d3(0x13f))['to'](_0x1e63d3(0x115)+_0x323c68[_0x1e63d3(0x124)]+'-notification')['to'](_0x135882['toString']())[_0x1e63d3(0x136)]('company-'+_0x1a1e59+'-ticket',{'action':_0x1e63d3(0xea),'ticketId':_0x323c68['id']}),_0x323c68['status']!==_0x1e63d3(0xd2)&&_0x444192['to'](_0x1e63d3(0xdc)+_0x323c68[_0x1e63d3(0x110)]+'-'+_0x323c68[_0x1e63d3(0xe1)])['to']('company-'+_0x323c68[_0x1e63d3(0x110)]+'-notification')['to'](_0x1e63d3(0x115)+_0x323c68[_0x1e63d3(0x124)]+_0x1e63d3(0x13f))['to'](_0x1e63d3(0x115)+_0x323c68[_0x1e63d3(0x124)]+'-'+_0x323c68[_0x1e63d3(0xe1)])['to'](_0x135882[_0x1e63d3(0x106)]())[_0x1e63d3(0x136)](_0x1e63d3(0xdc)+_0x1a1e59+_0x1e63d3(0x13b),{'action':_0x1e63d3(0x126),'ticket':_0x323c68}),{'ticket':_0x323c68,'oldStatus':_0x45b153,'oldUserId':_0x4550a8};}catch(_0x463d80){console[_0x1e63d3(0x11e)](_0x463d80),Sentry['captureException'](_0x463d80);}};exports[a531_0x470c78(0x128)]=UpdateTicketService;const notifyUpdate=(_0x1036fd,_0x11f264,_0x16c414,_0x4c6918)=>{const _0x4a71f9=a531_0x470c78;_0x1036fd['to']('company-'+_0x11f264[_0x4a71f9(0x110)]+'-'+_0x11f264[_0x4a71f9(0xe1)])['to']('company-'+_0x11f264['companyId']+_0x4a71f9(0x13f))['to'](_0x16c414[_0x4a71f9(0x106)]())[_0x4a71f9(0x136)](_0x4a71f9(0xdc)+_0x4c6918+_0x4a71f9(0x13b),{'action':'update','ticket':_0x11f264});};function a531_0xce14(){const _0x2ede72=['defineProperty','lodash','54MpiReb','SendPresenceStatus','status','findByPk','../../libs/wbot','ticketId','sendMessage','__importDefault','unreadMessages','*\x0aaguarde,\x20já\x20vamos\x20te\x20atender!','number','delete','__createBinding','./ShowTicketService','queuedAt','../../models/Queue','chatbot','sendMsgTransfTicket','1372390KsAkbu','*\x20transferiu\x20o\x20ticket\x20para\x20você,\x20*','*2*\x20-\x20_Insatisfeito_\x0a','integrationId','isGroup','-mainchannel','49NPOelY','rated','*\x20por\x20','format','promptId','writable','getOwnPropertyDescriptor','__setModuleDefault','search','90152RUqskp','../../helpers/SendPresenceStatus','toDate','contact','../../helpers/CheckContactOpenTickets','notifyUpdate','toString','7128544DeXSXW','DD/MM/YYYY\x20HH:mm:ss','value','2364980oiozFa','../../helpers/GetTicketWbot','../SettingServices/ListSettingsServiceOne','g.us','disableBot','hasOwnProperty','companyId','\x20em\x20','userRating','../WhatsappService/ShowWhatsAppService','name','queue-','find','useIntegration','call','*3*\x20-\x20_Moderadamente\x20Satisfeito_\x0a','get','newTicketOnTransfer','__esModule','pending','trace','s.whatsapp.net','*,\x20em\x20','user','enabled','*Mensagem\x20automática*:\x0aO\x20atendente\x20anterior\x20*','queueId','ratingAt','update','length','default','findOne','removeFromList','*Mensagem\x20automática*:\x0aVocê\x20foi\x20transferido\x20para\x20o\x20departamento\x20*','moment','dest','queueOptionId','updateUnread','./FindOrCreateATicketTrakingService','../UserServices/ShowUserService','amountUsedBotQueues','getTime','*\x20transferido\x20por\x20','open','emit','48mOdFTi','473358tVPMXB','(((.+)+)+)+$','../../errors/AppError','-ticket','contactId','userId','../../libs/socket','-notification','getWbot','\x0aaguarde,\x20já\x20vamos\x20te\x20atender!','isNil','671052YbNMpw','../WbotServices/SendWhatsAppMessage','closed','username','verifyMessage','Apenas\x20o\x20usuário\x20ativo\x20do\x20ticket\x20ou\x20o\x20Admin\x20podem\x20fazer\x20alterações\x20no\x20ticket','whatsappId','create','__importStar','configurable','1837204yFfUIy','time','company-'];a531_0xce14=function(){return _0x2ede72;};return a531_0xce14();}exports[a531_0x470c78(0x105)]=notifyUpdate;