const a559_0xe905bf=a559_0x4ddd;function a559_0x7ea5(){const _0xdcee2b=['__importDefault','toString','queueId','chatbot','-open','../../helpers/GetTicketWbot','6483825dCOjjF','Apenas\x20o\x20usuário\x20ativo\x20do\x20ticket\x20ou\x20o\x20Admin\x20podem\x20fazer\x20alterações\x20no\x20ticket','queue-','../../libs/socket','companyId','channel','GetCompanySetting','toDate','number','profile','4fMGHHb','-ticket','76010tNZJsD','enabled','isGroup','company-','default','contact','user','-mainchannel','(((.+)+)+)+$','getIO','constructor','disabled','rated','whatsapp','removeFromList','../../helpers/CheckSettings','15JnlvBN','closed','11963AJyhMM','\x0a\x0a*Digite\x20uma\x20nota\x20de\x201\x20a\x205*\x0a','1981920DXlaxZ','pending','keepUserAndQueue','user-','status','1837ZMcCHm','emit','2140944bFuStO','queueOptionId','545085vIkMUu','open','Por\x20favor\x20avalie\x20nosso\x20atendimento','verifyMessage','integrationId','Error\x20updating\x20ticket','disableBot','s.whatsapp.net','__esModule','userId','reload','846XzDNnT','updateUnread','finishedAt','-notification','indexOf','../../helpers/SetTicketMessagesAsRead','ratingAt','9366PlkNNU','contactId','update','search','../../helpers/Mustache','../../errors/AppError','./ShowTicketService','../WbotServices/VerifyHandlers','lodash','useIntegration','trim','defineProperty','../../helpers/CheckContactOpenTickets','admin','Need\x20companyId\x20or\x20tokenData','amountUsedBotQueues','whatsappId','../WhatsappService/ShowWhatsAppService'];a559_0x7ea5=function(){return _0xdcee2b;};return a559_0x7ea5();}(function(_0x491783,_0x199f09){const _0x30588e=a559_0x4ddd,_0x2a3db7=_0x491783();while(!![]){try{const _0x40f878=-parseInt(_0x30588e(0x1cb))/0x1*(parseInt(_0x30588e(0x1ea))/0x2)+-parseInt(_0x30588e(0x1d6))/0x3+parseInt(_0x30588e(0x1b9))/0x4*(parseInt(_0x30588e(0x1d8))/0x5)+parseInt(_0x30588e(0x1e3))/0x6*(parseInt(_0x30588e(0x1cd))/0x7)+parseInt(_0x30588e(0x1cf))/0x8+-parseInt(_0x30588e(0x1af))/0x9+parseInt(_0x30588e(0x1bb))/0xa*(parseInt(_0x30588e(0x1d4))/0xb);if(_0x40f878===_0x199f09)break;else _0x2a3db7['push'](_0x2a3db7['shift']());}catch(_0x1bb20e){_0x2a3db7['push'](_0x2a3db7['shift']());}}}(a559_0x7ea5,0x58917));function a559_0x4ddd(_0x2767d1,_0x5bafb6){const _0x4c2094=a559_0x7ea5();return a559_0x4ddd=function(_0x59fc3c,_0x1f1912){_0x59fc3c=_0x59fc3c-0x1a7;let _0x7ea527=_0x4c2094[_0x59fc3c];return _0x7ea527;},a559_0x4ddd(_0x2767d1,_0x5bafb6);}const a559_0x1f1912=(function(){let _0xa26157=!![];return function(_0x143888,_0x333644){const _0x16735c=_0xa26157?function(){if(_0x333644){const _0x722e2=_0x333644['apply'](_0x143888,arguments);return _0x333644=null,_0x722e2;}}:function(){};return _0xa26157=![],_0x16735c;};}()),a559_0x59fc3c=a559_0x1f1912(this,function(){const _0x1c8ecb=a559_0x4ddd;return a559_0x59fc3c[_0x1c8ecb(0x1aa)]()['search'](_0x1c8ecb(0x1c3))['toString']()[_0x1c8ecb(0x1c5)](a559_0x59fc3c)[_0x1c8ecb(0x1ed)]('(((.+)+)+)+$');});a559_0x59fc3c();'use strict';var __importDefault=this&&this[a559_0xe905bf(0x1a9)]||function(_0x52bbe6){const _0x234061=a559_0xe905bf;return _0x52bbe6&&_0x52bbe6[_0x234061(0x1e0)]?_0x52bbe6:{'default':_0x52bbe6};};Object[a559_0xe905bf(0x1f5)](exports,a559_0xe905bf(0x1e0),{'value':!![]});const moment_1=__importDefault(require('moment')),lodash_1=require(a559_0xe905bf(0x1f2)),CheckContactOpenTickets_1=__importDefault(require(a559_0xe905bf(0x1f6))),SetTicketMessagesAsRead_1=__importDefault(require(a559_0xe905bf(0x1e8))),socket_1=require(a559_0xe905bf(0x1b2)),ShowTicketService_1=__importDefault(require(a559_0xe905bf(0x1f0))),ShowWhatsAppService_1=__importDefault(require(a559_0xe905bf(0x1a8))),SendWhatsAppMessage_1=__importDefault(require('../WbotServices/SendWhatsAppMessage')),FindOrCreateATicketTrakingService_1=__importDefault(require('./FindOrCreateATicketTrakingService')),GetTicketWbot_1=__importDefault(require(a559_0xe905bf(0x1ae))),VerifyHandlers_1=require(a559_0xe905bf(0x1f1)),AppError_1=__importDefault(require(a559_0xe905bf(0x1ef))),CheckSettings_1=require(a559_0xe905bf(0x1ca)),Mustache_1=__importDefault(require(a559_0xe905bf(0x1ee))),UpdateTicketService=async({ticketData:_0x299868,ticketId:_0x14b00f,tokenData:_0x78482d,companyId:_0xadc40e})=>{const _0x4a6031=a559_0xe905bf;try{if(!_0xadc40e&&!_0x78482d)throw new Error(_0x4a6031(0x1f8));_0x78482d&&(_0xadc40e=_0x78482d[_0x4a6031(0x1b3)]);const {justClose:_0x24192c}=_0x299868;let {status:_0x2c5712}=_0x299868,{queueId:_0x429463,userId:_0x58951a}=_0x299868,_0x3c09de=_0x299868[_0x4a6031(0x1ac)]||![],_0x430ccd=_0x299868[_0x4a6031(0x1d7)]||null,_0x482243=_0x299868[_0x4a6031(0x1f3)]||![],_0x3f7aa0=_0x299868[_0x4a6031(0x1dc)]||null;const _0x29cd3d=(0x0,socket_1[_0x4a6031(0x1c4)])(),_0x530aa7=await(0x0,ShowTicketService_1[_0x4a6031(0x1bf)])(_0x14b00f,_0xadc40e),_0xdac07c=await(0x0,ShowWhatsAppService_1[_0x4a6031(0x1bf)])(_0x530aa7[_0x4a6031(0x1a7)],_0xadc40e);if(_0x78482d&&_0x530aa7[_0x4a6031(0x1d3)]!==_0x4a6031(0x1d0)){if(_0x78482d[_0x4a6031(0x1b8)]!==_0x4a6031(0x1f7)&&_0x530aa7['userId']!==parseInt(_0x78482d['id'],0xa))throw new AppError_1[(_0x4a6031(0x1bf))](_0x4a6031(0x1b0));}const _0x252278=await(0x0,FindOrCreateATicketTrakingService_1[_0x4a6031(0x1bf)])({'ticketId':_0x14b00f,'companyId':_0xadc40e,'whatsappId':_0x530aa7[_0x4a6031(0x1a7)]});_0x530aa7['channel']===_0x4a6031(0x1c8)&&_0x2c5712===_0x4a6031(0x1d9)&&(0x0,SetTicketMessagesAsRead_1[_0x4a6031(0x1bf)])(_0x530aa7);const _0xa3aa15=_0x530aa7['status'],_0x57ce9f=_0x530aa7[_0x4a6031(0x1c1)]?.['id'],_0x11fd78=_0x530aa7['queueId'];_0xa3aa15===_0x4a6031(0x1cc)&&(await(0x0,CheckContactOpenTickets_1[_0x4a6031(0x1bf)])(_0x530aa7[_0x4a6031(0x1eb)],_0x530aa7[_0x4a6031(0x1a7)]),_0x3c09de=null,_0x430ccd=null);if(_0x2c5712!==undefined&&[_0x4a6031(0x1cc)][_0x4a6031(0x1e7)](_0x2c5712)>-0x1){const {complationMessage:_0x5551bf,ratingMessage:_0x195f43}=await(0x0,ShowWhatsAppService_1[_0x4a6031(0x1bf)])(_0x530aa7['whatsappId'],_0xadc40e);if(!_0x530aa7[_0x4a6031(0x1c0)][_0x4a6031(0x1bd)]&&!_0x530aa7[_0x4a6031(0x1c0)][_0x4a6031(0x1de)]&&_0xdac07c['useRating']){if(_0x252278['ratingAt']==null&&!_0x24192c){const _0x30d1b0=_0x195f43?.[_0x4a6031(0x1f4)]()||_0x4a6031(0x1da),_0x10a652=_0x30d1b0+_0x4a6031(0x1ce);return _0x530aa7[_0x4a6031(0x1b4)]===_0x4a6031(0x1c8)&&await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x10a652,'ticket':_0x530aa7}),await _0x252278[_0x4a6031(0x1ec)]({'ratingAt':(0x0,moment_1[_0x4a6031(0x1bf)])()[_0x4a6031(0x1b6)](),'rated':![]}),_0x29cd3d['to']('company-'+_0x530aa7['companyId']+_0x4a6031(0x1ad))['to']('queue-'+_0x530aa7['queueId']+'-open')['to'](_0x14b00f['toString']())[_0x4a6031(0x1d5)](_0x4a6031(0x1be)+_0x530aa7[_0x4a6031(0x1b3)]+_0x4a6031(0x1ba),{'action':'delete','ticketId':_0x530aa7['id']}),{'ticket':_0x530aa7,'oldStatus':_0xa3aa15,'oldUserId':_0x57ce9f};}_0x252278[_0x4a6031(0x1e9)]=(0x0,moment_1['default'])()[_0x4a6031(0x1b6)](),_0x252278[_0x4a6031(0x1c7)]=![];}if(!_0x530aa7[_0x4a6031(0x1c0)][_0x4a6031(0x1bd)]&&!_0x530aa7[_0x4a6031(0x1c0)]['disableBot']&&!_0x24192c&&!(0x0,lodash_1['isNil'])(_0x5551bf)&&_0x5551bf!==''){const _0x227641=(0x0,Mustache_1[_0x4a6031(0x1bf)])(''+_0x5551bf,_0x530aa7);if(_0x530aa7[_0x4a6031(0x1b4)]===_0x4a6031(0x1c8)&&!_0x530aa7[_0x4a6031(0x1bd)]){const _0x7bc55c=await(0x0,SendWhatsAppMessage_1[_0x4a6031(0x1bf)])({'body':_0x227641,'ticket':_0x530aa7});await(0x0,VerifyHandlers_1[_0x4a6031(0x1db)])(_0x7bc55c,_0x530aa7,_0x530aa7[_0x4a6031(0x1c0)]);}}_0x252278[_0x4a6031(0x1e5)]=(0x0,moment_1['default'])()[_0x4a6031(0x1b6)](),_0x252278[_0x4a6031(0x1a7)]=_0x530aa7[_0x4a6031(0x1a7)],_0x252278[_0x4a6031(0x1e1)]=_0x530aa7[_0x4a6031(0x1e1)],_0x482243=![],_0x3f7aa0=null;const _0x169532=await(0x0,CheckSettings_1[_0x4a6031(0x1b5)])(_0xadc40e,_0x4a6031(0x1d1),_0x4a6031(0x1bc));_0x169532===_0x4a6031(0x1c6)&&(_0x429463=null,_0x58951a=null);}_0x429463!==undefined&&_0x429463!==null&&(_0x252278['queuedAt']=(0x0,moment_1[_0x4a6031(0x1bf)])()[_0x4a6031(0x1b6)]());if(_0x11fd78!==_0x429463&&!(0x0,lodash_1['isNil'])(_0x11fd78)&&!(0x0,lodash_1['isNil'])(_0x429463)){if(_0x530aa7[_0x4a6031(0x1b4)]===_0x4a6031(0x1c8)){const _0x211e0b=await(0x0,GetTicketWbot_1[_0x4a6031(0x1bf)])(_0x530aa7),{transferMessage:_0xfa3764}=await(0x0,ShowWhatsAppService_1['default'])(_0x530aa7['whatsappId'],_0xadc40e);if(!_0x530aa7[_0x4a6031(0x1bd)]){if(_0xfa3764?.[_0x4a6031(0x1f4)]()){const _0x3cd996=await _0x211e0b['sendMessage'](_0x530aa7[_0x4a6031(0x1c0)][_0x4a6031(0x1b7)]+'@'+(_0x530aa7[_0x4a6031(0x1bd)]?'g.us':_0x4a6031(0x1df)),{'text':''+_0xfa3764});await(0x0,VerifyHandlers_1['verifyMessage'])(_0x3cd996,_0x530aa7,_0x530aa7[_0x4a6031(0x1c0)]);}}}}await _0x530aa7[_0x4a6031(0x1ec)]({'status':_0x2c5712,'amountUsedBotQueues':_0x299868[_0x4a6031(0x1f9)]||0x0,'queueId':_0x429463,'userId':_0x58951a,'whatsappId':_0x530aa7['whatsappId'],'chatbot':_0x3c09de,'queueOptionId':_0x430ccd,'useIntegration':_0x482243,'integrationId':_0x3f7aa0}),await _0x530aa7[_0x4a6031(0x1e2)](),_0x2c5712=_0x530aa7['status'];_0x2c5712!==undefined&&[_0x4a6031(0x1d0)][_0x4a6031(0x1e7)](_0x2c5712)>-0x1&&(_0x252278[_0x4a6031(0x1ec)]({'whatsappId':_0x530aa7['whatsappId'],'queuedAt':(0x0,moment_1['default'])()[_0x4a6031(0x1b6)](),'startedAt':null,'userId':null}),_0x29cd3d['to'](_0x4a6031(0x1be)+_0xadc40e+_0x4a6031(0x1c2))[_0x4a6031(0x1d5)](_0x4a6031(0x1be)+_0xadc40e+_0x4a6031(0x1ba),{'action':_0x4a6031(0x1c9),'ticketId':_0x530aa7?.['id']}));_0x2c5712!==undefined&&[_0x4a6031(0x1d9)][_0x4a6031(0x1e7)](_0x2c5712)>-0x1&&(_0x252278['update']({'startedAt':(0x0,moment_1[_0x4a6031(0x1bf)])()[_0x4a6031(0x1b6)](),'ratingAt':null,'rated':![],'whatsappId':_0x530aa7[_0x4a6031(0x1a7)],'userId':_0x530aa7[_0x4a6031(0x1e1)]}),_0x29cd3d['to'](_0x4a6031(0x1be)+_0xadc40e+'-mainchannel')[_0x4a6031(0x1d5)](_0x4a6031(0x1be)+_0xadc40e+_0x4a6031(0x1ba),{'action':_0x4a6031(0x1c9),'ticketId':_0x530aa7?.['id']}),_0x29cd3d['to'](_0x4a6031(0x1be)+_0xadc40e+'-mainchannel')[_0x4a6031(0x1d5)](_0x4a6031(0x1be)+_0xadc40e+_0x4a6031(0x1ba),{'action':_0x4a6031(0x1e4),'ticketId':_0x530aa7?.['id']}));await _0x252278['save']();if(_0x24192c&&_0x2c5712==='closed')_0x29cd3d['to']('company-'+_0xadc40e+_0x4a6031(0x1c2))[_0x4a6031(0x1d5)](_0x4a6031(0x1be)+_0xadc40e+'-ticket',{'action':_0x4a6031(0x1c9),'ticketId':_0x530aa7?.['id']});else _0x530aa7[_0x4a6031(0x1d3)]==='closed'&&_0x530aa7['status']!==_0xa3aa15&&_0x29cd3d['to'](_0x4a6031(0x1be)+_0xadc40e+'-'+_0xa3aa15)['to'](_0x4a6031(0x1b1)+_0x530aa7[_0x4a6031(0x1ab)]+'-'+_0xa3aa15)['to'](_0x4a6031(0x1d2)+_0x57ce9f)[_0x4a6031(0x1d5)](_0x4a6031(0x1be)+_0xadc40e+_0x4a6031(0x1ba),{'action':'removeFromList','ticketId':_0x530aa7['id']});return _0x29cd3d['to']('company-'+_0xadc40e+'-'+_0x530aa7[_0x4a6031(0x1d3)])['to'](_0x4a6031(0x1be)+_0xadc40e+_0x4a6031(0x1e6))['to']('queue-'+_0x530aa7[_0x4a6031(0x1ab)]+'-'+_0x530aa7[_0x4a6031(0x1d3)])['to'](_0x4a6031(0x1b1)+_0x530aa7[_0x4a6031(0x1ab)]+_0x4a6031(0x1e6))['to'](_0x14b00f[_0x4a6031(0x1aa)]())['to']('user-'+_0x530aa7?.[_0x4a6031(0x1e1)])['to'](_0x4a6031(0x1d2)+_0x57ce9f)[_0x4a6031(0x1d5)](_0x4a6031(0x1be)+_0xadc40e+_0x4a6031(0x1ba),{'action':_0x4a6031(0x1ec),'ticket':_0x530aa7}),{'ticket':_0x530aa7,'oldStatus':_0xa3aa15,'oldUserId':_0x57ce9f};}catch(_0x2ff7d4){if(_0x2ff7d4 instanceof AppError_1['default'])throw _0x2ff7d4;throw new AppError_1[(_0x4a6031(0x1bf))](_0x4a6031(0x1dd),0x1f4,_0x2ff7d4);}};exports[a559_0xe905bf(0x1bf)]=UpdateTicketService;