const a562_0x5376a8=a562_0x15c3;(function(_0x368381,_0x49cb11){const _0x460a69=a562_0x15c3,_0x397c6d=_0x368381();while(!![]){try{const _0x2e69b4=parseInt(_0x460a69(0xa1))/0x1*(parseInt(_0x460a69(0x85))/0x2)+-parseInt(_0x460a69(0x75))/0x3+-parseInt(_0x460a69(0x72))/0x4+-parseInt(_0x460a69(0xa8))/0x5*(parseInt(_0x460a69(0x93))/0x6)+parseInt(_0x460a69(0x77))/0x7*(-parseInt(_0x460a69(0x81))/0x8)+parseInt(_0x460a69(0x9b))/0x9+-parseInt(_0x460a69(0xab))/0xa*(-parseInt(_0x460a69(0x96))/0xb);if(_0x2e69b4===_0x49cb11)break;else _0x397c6d['push'](_0x397c6d['shift']());}catch(_0x4ea11b){_0x397c6d['push'](_0x397c6d['shift']());}}}(a562_0x35d8,0x6b2e5));const a562_0x28dc16=(function(){let _0x5e5a79=!![];return function(_0xa033e2,_0x4bac24){const _0x59decd=_0x5e5a79?function(){const _0x53b83c=a562_0x15c3;if(_0x4bac24){const _0x1511b0=_0x4bac24[_0x53b83c(0xa7)](_0xa033e2,arguments);return _0x4bac24=null,_0x1511b0;}}:function(){};return _0x5e5a79=![],_0x59decd;};}()),a562_0x38ef75=a562_0x28dc16(this,function(){const _0x257f5d=a562_0x15c3;return a562_0x38ef75[_0x257f5d(0x9c)]()[_0x257f5d(0x8c)]('(((.+)+)+)+$')[_0x257f5d(0x9c)]()[_0x257f5d(0x7c)](a562_0x38ef75)[_0x257f5d(0x8c)]('(((.+)+)+)+$');});a562_0x38ef75();'use strict';var __importDefault=this&&this[a562_0x5376a8(0x76)]||function(_0x34dcbe){return _0x34dcbe&&_0x34dcbe['__esModule']?_0x34dcbe:{'default':_0x34dcbe};};function a562_0x35d8(){const _0x2b9071=['sendMessage','user-','../../helpers/CheckContactOpenTickets','5552793yAJIBt','toString','../../errors/AppError','default','verifyMessage','toDate','5530adyyhS','whatsappId','../../helpers/CheckSettings','admin','whatsapp','../../helpers/SetTicketMessagesAsRead','apply','912170ErYmlg','useRating','disableBot','28550JsVIEw','Por\x20favor\x20avalie\x20nosso\x20atendimento','../../helpers/Mustache','../../helpers/GetTicketWbot','\x0a\x0a*Digite\x20uma\x20nota\x20de\x201\x20a\x205*\x0a','../WbotServices/VerifyHandlers','pending','closed','companyId','contact','ratingAt','s.whatsapp.net','../WhatsappService/ShowWhatsAppService','queueId','integrationId','indexOf','user','delete','company-','save','status','3397012INCpxV','isNil','queue-','981063tCnLPv','__importDefault','7kqQEZs','emit','Error\x20updating\x20ticket','-ticket','finishedAt','constructor','userId','update','-mainchannel','isGroup','3905872zDLHRa','./ShowTicketService','profile','keepUserAndQueue','118DcKrLM','open','enabled','queueOptionId','lodash','-open','../../libs/socket','search','g.us','channel','disabled','removeFromList','contactId','./FindOrCreateATicketTrakingService','24oqjYao','number','trim','7282VKuJko','queuedAt'];a562_0x35d8=function(){return _0x2b9071;};return a562_0x35d8();}Object['defineProperty'](exports,'__esModule',{'value':!![]});const moment_1=__importDefault(require('moment')),lodash_1=require(a562_0x5376a8(0x89)),CheckContactOpenTickets_1=__importDefault(require(a562_0x5376a8(0x9a))),SetTicketMessagesAsRead_1=__importDefault(require(a562_0x5376a8(0xa6))),socket_1=require(a562_0x5376a8(0x8b)),ShowTicketService_1=__importDefault(require(a562_0x5376a8(0x82))),ShowWhatsAppService_1=__importDefault(require(a562_0x5376a8(0xb7))),SendWhatsAppMessage_1=__importDefault(require('../WbotServices/SendWhatsAppMessage')),FindOrCreateATicketTrakingService_1=__importDefault(require(a562_0x5376a8(0x92))),GetTicketWbot_1=__importDefault(require(a562_0x5376a8(0xae))),VerifyHandlers_1=require(a562_0x5376a8(0xb0)),AppError_1=__importDefault(require(a562_0x5376a8(0x9d))),CheckSettings_1=require(a562_0x5376a8(0xa3)),Mustache_1=__importDefault(require(a562_0x5376a8(0xad))),UpdateTicketService=async({ticketData:_0x6e354f,ticketId:_0x11fba2,tokenData:_0x337b50,companyId:_0x2dc7d8})=>{const _0x47ee14=a562_0x5376a8;try{if(!_0x2dc7d8&&!_0x337b50)throw new Error('Need\x20companyId\x20or\x20tokenData');_0x337b50&&(_0x2dc7d8=_0x337b50[_0x47ee14(0xb3)]);const {justClose:_0x4969a4}=_0x6e354f;let {status:_0x5d416a}=_0x6e354f,{queueId:_0x27b3b3,userId:_0x5dd2e5}=_0x6e354f,_0x4eea7f=_0x6e354f['chatbot']||![],_0x4ec07f=_0x6e354f[_0x47ee14(0x88)]||null,_0x5a2423=_0x6e354f['useIntegration']||![],_0x32e2ec=_0x6e354f[_0x47ee14(0xb9)]||null;const _0x1c4a39=(0x0,socket_1['getIO'])(),_0x34ca9c=await(0x0,ShowTicketService_1[_0x47ee14(0x9e)])(_0x11fba2,_0x2dc7d8),_0x47d696=await(0x0,ShowWhatsAppService_1[_0x47ee14(0x9e)])(_0x34ca9c[_0x47ee14(0xa2)],_0x2dc7d8);if(_0x337b50&&_0x34ca9c['status']!==_0x47ee14(0xb1)){if(_0x337b50[_0x47ee14(0x83)]!==_0x47ee14(0xa4)&&_0x34ca9c[_0x47ee14(0x7d)]!==parseInt(_0x337b50['id'],0xa))throw new AppError_1[(_0x47ee14(0x9e))]('Apenas\x20o\x20usuário\x20ativo\x20do\x20ticket\x20ou\x20o\x20Admin\x20podem\x20fazer\x20alterações\x20no\x20ticket');}const _0xae14c1=await(0x0,FindOrCreateATicketTrakingService_1[_0x47ee14(0x9e)])({'ticketId':_0x11fba2,'companyId':_0x2dc7d8,'whatsappId':_0x34ca9c[_0x47ee14(0xa2)]});_0x34ca9c[_0x47ee14(0x8e)]===_0x47ee14(0xa5)&&_0x5d416a==='open'&&(0x0,SetTicketMessagesAsRead_1[_0x47ee14(0x9e)])(_0x34ca9c);const _0x1e8552=_0x34ca9c[_0x47ee14(0x71)],_0x150085=_0x34ca9c[_0x47ee14(0xbb)]?.['id'],_0x62da23=_0x34ca9c['queueId'];_0x1e8552===_0x47ee14(0xb2)&&(await(0x0,CheckContactOpenTickets_1['default'])(_0x34ca9c[_0x47ee14(0x91)],_0x34ca9c['whatsappId']),_0x4eea7f=null,_0x4ec07f=null);if(_0x5d416a!==undefined&&[_0x47ee14(0xb2)][_0x47ee14(0xba)](_0x5d416a)>-0x1){const {complationMessage:_0x3b79a3,ratingMessage:_0xc2b7d6}=await(0x0,ShowWhatsAppService_1['default'])(_0x34ca9c[_0x47ee14(0xa2)],_0x2dc7d8);if(!_0x34ca9c[_0x47ee14(0xb4)][_0x47ee14(0x80)]&&!_0x34ca9c[_0x47ee14(0xb4)]['disableBot']&&_0x47d696[_0x47ee14(0xa9)]){if(_0xae14c1['ratingAt']==null&&!_0x4969a4){const _0x33741d=_0xc2b7d6?.[_0x47ee14(0x95)]()||_0x47ee14(0xac),_0x273d9c=_0x33741d+_0x47ee14(0xaf);return _0x34ca9c[_0x47ee14(0x8e)]==='whatsapp'&&await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x273d9c,'ticket':_0x34ca9c}),await _0xae14c1[_0x47ee14(0x7e)]({'ratingAt':(0x0,moment_1['default'])()[_0x47ee14(0xa0)](),'rated':![]}),_0x1c4a39['to'](_0x47ee14(0xbd)+_0x34ca9c[_0x47ee14(0xb3)]+'-open')['to'](_0x47ee14(0x74)+_0x34ca9c['queueId']+_0x47ee14(0x8a))['to'](_0x11fba2[_0x47ee14(0x9c)]())['emit']('company-'+_0x34ca9c[_0x47ee14(0xb3)]+_0x47ee14(0x7a),{'action':_0x47ee14(0xbc),'ticketId':_0x34ca9c['id']}),{'ticket':_0x34ca9c,'oldStatus':_0x1e8552,'oldUserId':_0x150085};}_0xae14c1[_0x47ee14(0xb5)]=(0x0,moment_1[_0x47ee14(0x9e)])()[_0x47ee14(0xa0)](),_0xae14c1['rated']=![];}if(!_0x34ca9c[_0x47ee14(0xb4)]['isGroup']&&!_0x34ca9c[_0x47ee14(0xb4)][_0x47ee14(0xaa)]&&!_0x4969a4&&!(0x0,lodash_1[_0x47ee14(0x73)])(_0x3b79a3)&&_0x3b79a3!==''){const _0x528ec3=(0x0,Mustache_1[_0x47ee14(0x9e)])(''+_0x3b79a3,_0x34ca9c);if(_0x34ca9c[_0x47ee14(0x8e)]===_0x47ee14(0xa5)&&!_0x34ca9c[_0x47ee14(0x80)]){const _0x2e18fd=await(0x0,SendWhatsAppMessage_1[_0x47ee14(0x9e)])({'body':_0x528ec3,'ticket':_0x34ca9c});await(0x0,VerifyHandlers_1[_0x47ee14(0x9f)])(_0x2e18fd,_0x34ca9c,_0x34ca9c['contact']);}}_0xae14c1[_0x47ee14(0x7b)]=(0x0,moment_1['default'])()['toDate'](),_0xae14c1[_0x47ee14(0xa2)]=_0x34ca9c[_0x47ee14(0xa2)],_0xae14c1[_0x47ee14(0x7d)]=_0x34ca9c[_0x47ee14(0x7d)],_0x5a2423=![],_0x32e2ec=null;const _0x3af8e5=await(0x0,CheckSettings_1['GetCompanySetting'])(_0x2dc7d8,_0x47ee14(0x84),_0x47ee14(0x87));_0x3af8e5===_0x47ee14(0x8f)&&(_0x27b3b3=null,_0x5dd2e5=null);}_0x27b3b3!==undefined&&_0x27b3b3!==null&&(_0xae14c1[_0x47ee14(0x97)]=(0x0,moment_1[_0x47ee14(0x9e)])()[_0x47ee14(0xa0)]());if(_0x62da23!==_0x27b3b3&&!(0x0,lodash_1[_0x47ee14(0x73)])(_0x62da23)&&!(0x0,lodash_1[_0x47ee14(0x73)])(_0x27b3b3)){if(_0x34ca9c[_0x47ee14(0x8e)]===_0x47ee14(0xa5)){const _0x230d0d=await(0x0,GetTicketWbot_1[_0x47ee14(0x9e)])(_0x34ca9c),{transferMessage:_0x5abd13}=await(0x0,ShowWhatsAppService_1['default'])(_0x34ca9c['whatsappId'],_0x2dc7d8);if(!_0x34ca9c[_0x47ee14(0x80)]){if(_0x5abd13?.[_0x47ee14(0x95)]()){const _0x3d912b=await _0x230d0d[_0x47ee14(0x98)](_0x34ca9c[_0x47ee14(0xb4)][_0x47ee14(0x94)]+'@'+(_0x34ca9c[_0x47ee14(0x80)]?_0x47ee14(0x8d):_0x47ee14(0xb6)),{'text':''+_0x5abd13});await(0x0,VerifyHandlers_1[_0x47ee14(0x9f)])(_0x3d912b,_0x34ca9c,_0x34ca9c[_0x47ee14(0xb4)]);}}}}await _0x34ca9c['update']({'status':_0x5d416a,'amountUsedBotQueues':_0x6e354f['amountUsedBotQueues']||0x0,'queueId':_0x27b3b3,'userId':_0x5dd2e5,'whatsappId':_0x34ca9c[_0x47ee14(0xa2)],'chatbot':_0x4eea7f,'queueOptionId':_0x4ec07f,'useIntegration':_0x5a2423,'integrationId':_0x32e2ec}),await _0x34ca9c['reload'](),_0x5d416a=_0x34ca9c[_0x47ee14(0x71)];_0x5d416a!==undefined&&[_0x47ee14(0xb1)][_0x47ee14(0xba)](_0x5d416a)>-0x1&&(_0xae14c1[_0x47ee14(0x7e)]({'whatsappId':_0x34ca9c[_0x47ee14(0xa2)],'queuedAt':(0x0,moment_1['default'])()['toDate'](),'startedAt':null,'userId':null}),_0x1c4a39['to'](_0x47ee14(0xbd)+_0x2dc7d8+_0x47ee14(0x7f))[_0x47ee14(0x78)](_0x47ee14(0xbd)+_0x2dc7d8+_0x47ee14(0x7a),{'action':'removeFromList','ticketId':_0x34ca9c?.['id']}));_0x5d416a!==undefined&&[_0x47ee14(0x86)][_0x47ee14(0xba)](_0x5d416a)>-0x1&&(_0xae14c1['update']({'startedAt':(0x0,moment_1[_0x47ee14(0x9e)])()[_0x47ee14(0xa0)](),'ratingAt':null,'rated':![],'whatsappId':_0x34ca9c[_0x47ee14(0xa2)],'userId':_0x34ca9c['userId']}),_0x1c4a39['to'](_0x47ee14(0xbd)+_0x2dc7d8+_0x47ee14(0x7f))[_0x47ee14(0x78)](_0x47ee14(0xbd)+_0x2dc7d8+_0x47ee14(0x7a),{'action':_0x47ee14(0x90),'ticketId':_0x34ca9c?.['id']}),_0x1c4a39['to'](_0x47ee14(0xbd)+_0x2dc7d8+_0x47ee14(0x7f))[_0x47ee14(0x78)]('company-'+_0x2dc7d8+'-ticket',{'action':'updateUnread','ticketId':_0x34ca9c?.['id']}));await _0xae14c1[_0x47ee14(0xbe)]();if(_0x4969a4&&_0x5d416a==='closed')_0x1c4a39['to'](_0x47ee14(0xbd)+_0x2dc7d8+_0x47ee14(0x7f))['emit'](_0x47ee14(0xbd)+_0x2dc7d8+_0x47ee14(0x7a),{'action':_0x47ee14(0x90),'ticketId':_0x34ca9c?.['id']});else _0x34ca9c[_0x47ee14(0x71)]===_0x47ee14(0xb2)&&_0x34ca9c[_0x47ee14(0x71)]!==_0x1e8552&&_0x1c4a39['to'](_0x47ee14(0xbd)+_0x2dc7d8+'-'+_0x1e8552)['to'](_0x47ee14(0x74)+_0x34ca9c['queueId']+'-'+_0x1e8552)['to']('user-'+_0x150085)['emit'](_0x47ee14(0xbd)+_0x2dc7d8+_0x47ee14(0x7a),{'action':_0x47ee14(0x90),'ticketId':_0x34ca9c['id']});return _0x1c4a39['to'](_0x47ee14(0xbd)+_0x2dc7d8+'-'+_0x34ca9c[_0x47ee14(0x71)])['to']('company-'+_0x2dc7d8+'-notification')['to'](_0x47ee14(0x74)+_0x34ca9c[_0x47ee14(0xb8)]+'-'+_0x34ca9c[_0x47ee14(0x71)])['to'](_0x47ee14(0x74)+_0x34ca9c[_0x47ee14(0xb8)]+'-notification')['to'](_0x11fba2[_0x47ee14(0x9c)]())['to'](_0x47ee14(0x99)+_0x34ca9c?.[_0x47ee14(0x7d)])['to'](_0x47ee14(0x99)+_0x150085)[_0x47ee14(0x78)]('company-'+_0x2dc7d8+'-ticket',{'action':_0x47ee14(0x7e),'ticket':_0x34ca9c}),{'ticket':_0x34ca9c,'oldStatus':_0x1e8552,'oldUserId':_0x150085};}catch(_0x8dd5bf){if(_0x8dd5bf instanceof AppError_1[_0x47ee14(0x9e)])throw _0x8dd5bf;throw new AppError_1[(_0x47ee14(0x9e))](_0x47ee14(0x79),0x1f4,_0x8dd5bf);}};function a562_0x15c3(_0x2600d4,_0x3525d8){const _0xa0b6e=a562_0x35d8();return a562_0x15c3=function(_0x38ef75,_0x28dc16){_0x38ef75=_0x38ef75-0x71;let _0x35d8e4=_0xa0b6e[_0x38ef75];return _0x35d8e4;},a562_0x15c3(_0x2600d4,_0x3525d8);}exports['default']=UpdateTicketService;