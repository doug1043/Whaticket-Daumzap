const a562_0x3239ec=a562_0x284a;(function(_0x47990d,_0x58ba07){const _0x1a1d2a=a562_0x284a,_0x4313ff=_0x47990d();while(!![]){try{const _0x9554de=parseInt(_0x1a1d2a(0x130))/0x1*(-parseInt(_0x1a1d2a(0x163))/0x2)+-parseInt(_0x1a1d2a(0x13b))/0x3*(-parseInt(_0x1a1d2a(0x142))/0x4)+-parseInt(_0x1a1d2a(0x15c))/0x5+parseInt(_0x1a1d2a(0x135))/0x6*(-parseInt(_0x1a1d2a(0x152))/0x7)+-parseInt(_0x1a1d2a(0x157))/0x8+parseInt(_0x1a1d2a(0x14a))/0x9+parseInt(_0x1a1d2a(0x16d))/0xa*(parseInt(_0x1a1d2a(0x154))/0xb);if(_0x9554de===_0x58ba07)break;else _0x4313ff['push'](_0x4313ff['shift']());}catch(_0x3ab5d0){_0x4313ff['push'](_0x4313ff['shift']());}}}(a562_0x1b5f,0xa1df4));const a562_0x572638=(function(){let _0x1bd38e=!![];return function(_0x4e28cd,_0x1ab7df){const _0x34879f=_0x1bd38e?function(){if(_0x1ab7df){const _0x5e570c=_0x1ab7df['apply'](_0x4e28cd,arguments);return _0x1ab7df=null,_0x5e570c;}}:function(){};return _0x1bd38e=![],_0x34879f;};}()),a562_0x50020a=a562_0x572638(this,function(){const _0x5cb41d=a562_0x284a;return a562_0x50020a[_0x5cb41d(0x149)]()[_0x5cb41d(0x11d)]('(((.+)+)+)+$')['toString']()[_0x5cb41d(0x158)](a562_0x50020a)[_0x5cb41d(0x11d)](_0x5cb41d(0x16a));});a562_0x50020a();'use strict';var __importDefault=this&&this[a562_0x3239ec(0x139)]||function(_0x2fdcd6){return _0x2fdcd6&&_0x2fdcd6['__esModule']?_0x2fdcd6:{'default':_0x2fdcd6};};function a562_0x284a(_0x25b516,_0x548c2b){const _0x509638=a562_0x1b5f();return a562_0x284a=function(_0x50020a,_0x572638){_0x50020a=_0x50020a-0x11c;let _0x1b5f1d=_0x509638[_0x50020a];return _0x1b5f1d;},a562_0x284a(_0x25b516,_0x548c2b);}Object['defineProperty'](exports,a562_0x3239ec(0x123),{'value':!![]});const moment_1=__importDefault(require(a562_0x3239ec(0x150))),lodash_1=require(a562_0x3239ec(0x153)),CheckContactOpenTickets_1=__importDefault(require(a562_0x3239ec(0x12d))),SetTicketMessagesAsRead_1=__importDefault(require(a562_0x3239ec(0x11c))),socket_1=require(a562_0x3239ec(0x13a)),ShowTicketService_1=__importDefault(require(a562_0x3239ec(0x164))),ShowWhatsAppService_1=__importDefault(require(a562_0x3239ec(0x15e))),SendWhatsAppMessage_1=__importDefault(require('../WbotServices/SendWhatsAppMessage')),FindOrCreateATicketTrakingService_1=__importDefault(require(a562_0x3239ec(0x124))),GetTicketWbot_1=__importDefault(require(a562_0x3239ec(0x13d))),VerifyHandlers_1=require(a562_0x3239ec(0x134)),AppError_1=__importDefault(require('../../errors/AppError')),CheckSettings_1=require(a562_0x3239ec(0x159)),Mustache_1=__importDefault(require(a562_0x3239ec(0x147))),UpdateTicketService=async({ticketData:_0x3ed510,ticketId:_0x440138,tokenData:_0x2317c6,companyId:_0x37409a})=>{const _0x5e02e7=a562_0x3239ec;try{if(!_0x37409a&&!_0x2317c6)throw new Error(_0x5e02e7(0x133));_0x2317c6&&(_0x37409a=_0x2317c6['companyId']);const {justClose:_0x528fd4}=_0x3ed510;let {status:_0x163a98}=_0x3ed510,{queueId:_0x21ba09,userId:_0x4766d5}=_0x3ed510,_0x3d719a=_0x3ed510[_0x5e02e7(0x146)]||![],_0x4fa796=_0x3ed510[_0x5e02e7(0x169)]||null,_0x37971e=_0x3ed510['useIntegration']||![],_0x5823dc=_0x3ed510[_0x5e02e7(0x12b)]||null;const _0x321f71=(0x0,socket_1[_0x5e02e7(0x151)])(),_0x413613=await(0x0,ShowTicketService_1[_0x5e02e7(0x144)])(_0x440138,_0x37409a),_0x2a9644=await(0x0,ShowWhatsAppService_1[_0x5e02e7(0x144)])(_0x413613['whatsappId'],_0x37409a);if(_0x2317c6&&_0x413613['status']!=='pending'){if(_0x2317c6[_0x5e02e7(0x138)]!==_0x5e02e7(0x167)&&_0x413613[_0x5e02e7(0x12f)]!==parseInt(_0x2317c6['id'],0xa))throw new AppError_1['default']('Apenas\x20o\x20usuário\x20ativo\x20do\x20ticket\x20ou\x20o\x20Admin\x20podem\x20fazer\x20alterações\x20no\x20ticket');}const _0x1569f2=await(0x0,FindOrCreateATicketTrakingService_1[_0x5e02e7(0x144)])({'ticketId':_0x440138,'companyId':_0x37409a,'whatsappId':_0x413613['whatsappId']});_0x413613[_0x5e02e7(0x15b)]===_0x5e02e7(0x132)&&_0x163a98===_0x5e02e7(0x161)&&(0x0,SetTicketMessagesAsRead_1['default'])(_0x413613);const _0x5977e0=_0x413613[_0x5e02e7(0x155)],_0x431cad=_0x413613[_0x5e02e7(0x14d)]?.['id'],_0x484b77=_0x413613[_0x5e02e7(0x16c)];_0x5977e0==='closed'&&(await(0x0,CheckContactOpenTickets_1['default'])(_0x413613[_0x5e02e7(0x145)],_0x413613[_0x5e02e7(0x160)]),_0x3d719a=null,_0x4fa796=null);if(_0x163a98!==undefined&&[_0x5e02e7(0x15a)]['indexOf'](_0x163a98)>-0x1){const {complationMessage:_0x54f184,ratingMessage:_0x2b0e75}=await(0x0,ShowWhatsAppService_1[_0x5e02e7(0x144)])(_0x413613[_0x5e02e7(0x160)],_0x37409a);if(!_0x413613[_0x5e02e7(0x141)][_0x5e02e7(0x128)]&&!_0x413613[_0x5e02e7(0x141)]['disableBot']&&_0x2a9644['useRating']){if(_0x1569f2[_0x5e02e7(0x12e)]==null&&!_0x528fd4){const _0x1eb776=_0x2b0e75?.[_0x5e02e7(0x140)]()||'Por\x20favor\x20avalie\x20nosso\x20atendimento',_0x1ede24=_0x1eb776+_0x5e02e7(0x156);return _0x413613[_0x5e02e7(0x15b)]===_0x5e02e7(0x132)&&await(0x0,SendWhatsAppMessage_1[_0x5e02e7(0x144)])({'body':_0x1ede24,'ticket':_0x413613}),await _0x1569f2[_0x5e02e7(0x129)]({'ratingAt':(0x0,moment_1[_0x5e02e7(0x144)])()['toDate'](),'rated':![]}),_0x321f71['to'](_0x5e02e7(0x166)+_0x413613[_0x5e02e7(0x148)]+_0x5e02e7(0x11f))['to'](_0x5e02e7(0x136)+_0x413613[_0x5e02e7(0x16c)]+_0x5e02e7(0x11f))['to'](_0x440138[_0x5e02e7(0x149)]())['emit'](_0x5e02e7(0x166)+_0x413613[_0x5e02e7(0x148)]+_0x5e02e7(0x165),{'action':_0x5e02e7(0x127),'ticketId':_0x413613['id']}),{'ticket':_0x413613,'oldStatus':_0x5977e0,'oldUserId':_0x431cad};}_0x1569f2[_0x5e02e7(0x12e)]=(0x0,moment_1[_0x5e02e7(0x144)])()[_0x5e02e7(0x131)](),_0x1569f2[_0x5e02e7(0x14c)]=![];}if(!_0x413613[_0x5e02e7(0x141)]['isGroup']&&!_0x413613[_0x5e02e7(0x141)]['disableBot']&&!_0x528fd4&&!(0x0,lodash_1[_0x5e02e7(0x125)])(_0x54f184)&&_0x54f184!==''){const _0x16d8e5=(0x0,Mustache_1[_0x5e02e7(0x144)])(''+_0x54f184,_0x413613);if(_0x413613['channel']==='whatsapp'&&!_0x413613[_0x5e02e7(0x128)]){const _0x240d43=await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x16d8e5,'ticket':_0x413613});await(0x0,VerifyHandlers_1[_0x5e02e7(0x120)])(_0x240d43,_0x413613,_0x413613[_0x5e02e7(0x141)]);}}_0x1569f2['finishedAt']=(0x0,moment_1[_0x5e02e7(0x144)])()['toDate'](),_0x1569f2[_0x5e02e7(0x160)]=_0x413613['whatsappId'],_0x1569f2[_0x5e02e7(0x12f)]=_0x413613[_0x5e02e7(0x12f)],_0x37971e=![],_0x5823dc=null;const _0x49241a=await(0x0,CheckSettings_1[_0x5e02e7(0x122)])(_0x37409a,_0x5e02e7(0x15d),_0x5e02e7(0x14f));_0x49241a===_0x5e02e7(0x11e)&&(_0x21ba09=null,_0x4766d5=null);}_0x21ba09!==undefined&&_0x21ba09!==null&&(_0x1569f2[_0x5e02e7(0x14b)]=(0x0,moment_1[_0x5e02e7(0x144)])()[_0x5e02e7(0x131)]());if(_0x484b77!==_0x21ba09&&!(0x0,lodash_1[_0x5e02e7(0x125)])(_0x484b77)&&!(0x0,lodash_1['isNil'])(_0x21ba09)){if(_0x413613[_0x5e02e7(0x15b)]===_0x5e02e7(0x132)){const _0x8d3f7f=await(0x0,GetTicketWbot_1['default'])(_0x413613),{transferMessage:_0x391bbe}=await(0x0,ShowWhatsAppService_1['default'])(_0x413613[_0x5e02e7(0x160)],_0x37409a);if(!_0x413613['isGroup']){if(_0x391bbe?.[_0x5e02e7(0x140)]()){const _0x991148=await _0x8d3f7f[_0x5e02e7(0x16f)](_0x413613[_0x5e02e7(0x141)][_0x5e02e7(0x162)]+'@'+(_0x413613[_0x5e02e7(0x128)]?_0x5e02e7(0x16b):_0x5e02e7(0x14e)),{'text':''+_0x391bbe});await(0x0,VerifyHandlers_1[_0x5e02e7(0x120)])(_0x991148,_0x413613,_0x413613[_0x5e02e7(0x141)]);}}}}await _0x413613[_0x5e02e7(0x129)]({'status':_0x163a98,'amountUsedBotQueues':_0x3ed510[_0x5e02e7(0x143)]||0x0,'queueId':_0x21ba09,'userId':_0x4766d5,'whatsappId':_0x413613[_0x5e02e7(0x160)],'chatbot':_0x3d719a,'queueOptionId':_0x4fa796,'useIntegration':_0x37971e,'integrationId':_0x5823dc}),await _0x413613[_0x5e02e7(0x15f)](),_0x163a98=_0x413613[_0x5e02e7(0x155)];_0x163a98!==undefined&&[_0x5e02e7(0x121)][_0x5e02e7(0x13c)](_0x163a98)>-0x1&&(_0x1569f2[_0x5e02e7(0x129)]({'whatsappId':_0x413613['whatsappId'],'queuedAt':(0x0,moment_1[_0x5e02e7(0x144)])()['toDate'](),'startedAt':null,'userId':null}),_0x321f71['to'](_0x5e02e7(0x166)+_0x37409a+_0x5e02e7(0x126))['emit'](_0x5e02e7(0x166)+_0x37409a+_0x5e02e7(0x165),{'action':'removeFromList','ticketId':_0x413613?.['id']}));_0x163a98!==undefined&&[_0x5e02e7(0x161)]['indexOf'](_0x163a98)>-0x1&&(_0x1569f2['update']({'startedAt':(0x0,moment_1[_0x5e02e7(0x144)])()[_0x5e02e7(0x131)](),'ratingAt':null,'rated':![],'whatsappId':_0x413613[_0x5e02e7(0x160)],'userId':_0x413613[_0x5e02e7(0x12f)]}),_0x321f71['to']('company-'+_0x37409a+_0x5e02e7(0x126))[_0x5e02e7(0x137)]('company-'+_0x37409a+_0x5e02e7(0x165),{'action':_0x5e02e7(0x13f),'ticketId':_0x413613?.['id']}),_0x321f71['to'](_0x5e02e7(0x166)+_0x37409a+_0x5e02e7(0x126))[_0x5e02e7(0x137)]('company-'+_0x37409a+_0x5e02e7(0x165),{'action':_0x5e02e7(0x16e),'ticketId':_0x413613?.['id']}));await _0x1569f2[_0x5e02e7(0x168)]();if(_0x528fd4&&_0x163a98===_0x5e02e7(0x15a))_0x321f71['to'](_0x5e02e7(0x166)+_0x37409a+_0x5e02e7(0x126))[_0x5e02e7(0x137)](_0x5e02e7(0x166)+_0x37409a+_0x5e02e7(0x165),{'action':'removeFromList','ticketId':_0x413613?.['id']});else _0x413613[_0x5e02e7(0x155)]===_0x5e02e7(0x15a)&&_0x413613[_0x5e02e7(0x155)]!==_0x5977e0&&_0x321f71['to'](_0x5e02e7(0x166)+_0x37409a+'-'+_0x5977e0)['to'](_0x5e02e7(0x136)+_0x413613['queueId']+'-'+_0x5977e0)['to'](_0x5e02e7(0x13e)+_0x431cad)['emit'](_0x5e02e7(0x166)+_0x37409a+_0x5e02e7(0x165),{'action':_0x5e02e7(0x13f),'ticketId':_0x413613['id']});return _0x321f71['to'](_0x5e02e7(0x166)+_0x37409a+'-'+_0x413613['status'])['to'](_0x5e02e7(0x166)+_0x37409a+_0x5e02e7(0x12c))['to'](_0x5e02e7(0x136)+_0x413613[_0x5e02e7(0x16c)]+'-'+_0x413613[_0x5e02e7(0x155)])['to'](_0x5e02e7(0x136)+_0x413613[_0x5e02e7(0x16c)]+_0x5e02e7(0x12c))['to'](_0x440138[_0x5e02e7(0x149)]())['to'](_0x5e02e7(0x13e)+_0x413613?.['userId'])['to'](_0x5e02e7(0x13e)+_0x431cad)[_0x5e02e7(0x137)]('company-'+_0x37409a+'-ticket',{'action':_0x5e02e7(0x129),'ticket':_0x413613}),{'ticket':_0x413613,'oldStatus':_0x5977e0,'oldUserId':_0x431cad};}catch(_0x10f242){if(_0x10f242 instanceof AppError_1[_0x5e02e7(0x144)])throw _0x10f242;throw new AppError_1['default'](_0x5e02e7(0x12a),0x1f4,_0x10f242);}};function a562_0x1b5f(){const _0x555c3b=['Need\x20companyId\x20or\x20tokenData','../WbotServices/VerifyHandlers','19926EYGMrR','queue-','emit','profile','__importDefault','../../libs/socket','3CuCKQp','indexOf','../../helpers/GetTicketWbot','user-','removeFromList','trim','contact','716164gddnyM','amountUsedBotQueues','default','contactId','chatbot','../../helpers/Mustache','companyId','toString','7818147XjpkOK','queuedAt','rated','user','s.whatsapp.net','enabled','moment','getIO','210pInPvU','lodash','80663XmtxqW','status','\x0a\x0a*Digite\x20uma\x20nota\x20de\x201\x20a\x205*\x0a','4361168peWFCE','constructor','../../helpers/CheckSettings','closed','channel','6535130YwpubE','keepUserAndQueue','../WhatsappService/ShowWhatsAppService','reload','whatsappId','open','number','1690902iRmMpz','./ShowTicketService','-ticket','company-','admin','save','queueOptionId','(((.+)+)+)+$','g.us','queueId','3290FuEkzk','updateUnread','sendMessage','../../helpers/SetTicketMessagesAsRead','search','disabled','-open','verifyMessage','pending','GetCompanySetting','__esModule','./FindOrCreateATicketTrakingService','isNil','-mainchannel','delete','isGroup','update','Error\x20updating\x20ticket','integrationId','-notification','../../helpers/CheckContactOpenTickets','ratingAt','userId','1JLZOaN','toDate','whatsapp'];a562_0x1b5f=function(){return _0x555c3b;};return a562_0x1b5f();}exports[a562_0x3239ec(0x144)]=UpdateTicketService;