function a563_0x416a(_0x2e7695,_0x107421){const _0x1b71cc=a563_0x5d1b();return a563_0x416a=function(_0x296cdb,_0x2e2a3f){_0x296cdb=_0x296cdb-0x11c;let _0x5d1b28=_0x1b71cc[_0x296cdb];return _0x5d1b28;},a563_0x416a(_0x2e7695,_0x107421);}function a563_0x5d1b(){const _0x3c3806=['useIntegration','../../helpers/GetTicketWbot','queueId','Error\x20updating\x20ticket','Por\x20favor\x20avalie\x20nosso\x20atendimento','queue-','288855KpmZnv','-ticket','enabled','closed','emit','removeFromList','trim','apply','number','../../libs/socket','update','Need\x20companyId\x20or\x20tokenData','company-','15108GjRyqr','user-','84828hGPEho','default','delete','chatbot','./ShowTicketService','indexOf','reload','companyId','37873yjICkL','defineProperty','finishedAt','profile','-mainchannel','../../errors/AppError','-notification','integrationId','useRating','save','../../helpers/CheckContactOpenTickets','queueOptionId','./FindOrCreateATicketTrakingService','userId','2454cTLVSL','s.whatsapp.net','status','486qLtWxb','lodash','whatsapp','toDate','getIO','../../helpers/Mustache','-open','moment','disableBot','648aUIqQe','disabled','../../helpers/CheckSettings','search','contactId','isGroup','whatsappId','__importDefault','138530XQUGUr','254620IFidue','../WbotServices/VerifyHandlers','toString','constructor','(((.+)+)+)+$','updateUnread','8012WkLgTk','g.us','sendMessage','../../helpers/SetTicketMessagesAsRead','ratingAt','../WhatsappService/ShowWhatsAppService','rated','contact','channel','505gbqcWE','3441826WDpfOx','open','\x0a\x0a*Digite\x20uma\x20nota\x20de\x201\x20a\x205*\x0a','isNil','keepUserAndQueue','user'];a563_0x5d1b=function(){return _0x3c3806;};return a563_0x5d1b();}const a563_0xed04cf=a563_0x416a;(function(_0x351713,_0x5e64e8){const _0x3e5b83=a563_0x416a,_0x3c9e5a=_0x351713();while(!![]){try{const _0x625b78=parseInt(_0x3e5b83(0x146))/0x1+parseInt(_0x3e5b83(0x13a))/0x2+parseInt(_0x3e5b83(0x16b))/0x3*(parseInt(_0x3e5b83(0x130))/0x4)+-parseInt(_0x3e5b83(0x139))/0x5*(parseInt(_0x3e5b83(0x155))/0x6)+parseInt(_0x3e5b83(0x129))/0x7*(parseInt(_0x3e5b83(0x121))/0x8)+parseInt(_0x3e5b83(0x16e))/0x9*(parseInt(_0x3e5b83(0x12a))/0xa)+-parseInt(_0x3e5b83(0x15d))/0xb*(parseInt(_0x3e5b83(0x153))/0xc);if(_0x625b78===_0x5e64e8)break;else _0x3c9e5a['push'](_0x3c9e5a['shift']());}catch(_0x48a4d1){_0x3c9e5a['push'](_0x3c9e5a['shift']());}}}(a563_0x5d1b,0xd2cfd));const a563_0x2e2a3f=(function(){let _0x440888=!![];return function(_0x27941a,_0x2ba0b0){const _0x18c419=_0x440888?function(){const _0x3ad3ce=a563_0x416a;if(_0x2ba0b0){const _0x1af9b5=_0x2ba0b0[_0x3ad3ce(0x14d)](_0x27941a,arguments);return _0x2ba0b0=null,_0x1af9b5;}}:function(){};return _0x440888=![],_0x18c419;};}()),a563_0x296cdb=a563_0x2e2a3f(this,function(){const _0x273632=a563_0x416a;return a563_0x296cdb[_0x273632(0x12c)]()['search'](_0x273632(0x12e))['toString']()[_0x273632(0x12d)](a563_0x296cdb)[_0x273632(0x124)](_0x273632(0x12e));});a563_0x296cdb();'use strict';var __importDefault=this&&this[a563_0xed04cf(0x128)]||function(_0x4186fa){return _0x4186fa&&_0x4186fa['__esModule']?_0x4186fa:{'default':_0x4186fa};};Object[a563_0xed04cf(0x15e)](exports,'__esModule',{'value':!![]});const moment_1=__importDefault(require(a563_0xed04cf(0x11f))),lodash_1=require(a563_0xed04cf(0x16f)),CheckContactOpenTickets_1=__importDefault(require(a563_0xed04cf(0x167))),SetTicketMessagesAsRead_1=__importDefault(require(a563_0xed04cf(0x133))),socket_1=require(a563_0xed04cf(0x14f)),ShowTicketService_1=__importDefault(require(a563_0xed04cf(0x159))),ShowWhatsAppService_1=__importDefault(require(a563_0xed04cf(0x135))),SendWhatsAppMessage_1=__importDefault(require('../WbotServices/SendWhatsAppMessage')),FindOrCreateATicketTrakingService_1=__importDefault(require(a563_0xed04cf(0x169))),GetTicketWbot_1=__importDefault(require(a563_0xed04cf(0x141))),VerifyHandlers_1=require(a563_0xed04cf(0x12b)),AppError_1=__importDefault(require(a563_0xed04cf(0x162))),CheckSettings_1=require(a563_0xed04cf(0x123)),Mustache_1=__importDefault(require(a563_0xed04cf(0x11d))),UpdateTicketService=async({ticketData:_0x3e7f0a,ticketId:_0x124ae9,tokenData:_0x5ab69b,companyId:_0x23498c})=>{const _0x358ca5=a563_0xed04cf;try{if(!_0x23498c&&!_0x5ab69b)throw new Error(_0x358ca5(0x151));_0x5ab69b&&(_0x23498c=_0x5ab69b[_0x358ca5(0x15c)]);const {justClose:_0x2ecdbe}=_0x3e7f0a;let {status:_0xe1df1e}=_0x3e7f0a,{queueId:_0x261c72,userId:_0x42874f}=_0x3e7f0a,_0x2e4403=_0x3e7f0a[_0x358ca5(0x158)]||![],_0x2a4347=_0x3e7f0a[_0x358ca5(0x168)]||null,_0x3e8216=_0x3e7f0a[_0x358ca5(0x140)]||![],_0x2a92ce=_0x3e7f0a[_0x358ca5(0x164)]||null;const _0x242dd6=(0x0,socket_1[_0x358ca5(0x11c)])(),_0x538bb5=await(0x0,ShowTicketService_1[_0x358ca5(0x156)])(_0x124ae9,_0x23498c),_0x1f4bfc=await(0x0,ShowWhatsAppService_1[_0x358ca5(0x156)])(_0x538bb5[_0x358ca5(0x127)],_0x23498c);if(_0x5ab69b&&_0x538bb5[_0x358ca5(0x16d)]!=='pending'){if(_0x5ab69b[_0x358ca5(0x160)]!=='admin'&&_0x538bb5[_0x358ca5(0x16a)]!==parseInt(_0x5ab69b['id'],0xa))throw new AppError_1[(_0x358ca5(0x156))]('Apenas\x20o\x20usuário\x20ativo\x20do\x20ticket\x20ou\x20o\x20Admin\x20podem\x20fazer\x20alterações\x20no\x20ticket');}const _0x2fb15a=await(0x0,FindOrCreateATicketTrakingService_1['default'])({'ticketId':_0x124ae9,'companyId':_0x23498c,'whatsappId':_0x538bb5[_0x358ca5(0x127)]});_0x538bb5[_0x358ca5(0x138)]===_0x358ca5(0x170)&&_0xe1df1e==='open'&&(0x0,SetTicketMessagesAsRead_1['default'])(_0x538bb5);const _0x28281d=_0x538bb5['status'],_0x4c7af7=_0x538bb5[_0x358ca5(0x13f)]?.['id'],_0x16dc76=_0x538bb5['queueId'];_0x28281d===_0x358ca5(0x149)&&(await(0x0,CheckContactOpenTickets_1['default'])(_0x538bb5[_0x358ca5(0x125)],_0x538bb5[_0x358ca5(0x127)]),_0x2e4403=null,_0x2a4347=null);if(_0xe1df1e!==undefined&&[_0x358ca5(0x149)][_0x358ca5(0x15a)](_0xe1df1e)>-0x1){const {complationMessage:_0x5bf633,ratingMessage:_0x3696e9}=await(0x0,ShowWhatsAppService_1[_0x358ca5(0x156)])(_0x538bb5[_0x358ca5(0x127)],_0x23498c);if(!_0x538bb5[_0x358ca5(0x137)][_0x358ca5(0x126)]&&!_0x538bb5[_0x358ca5(0x137)][_0x358ca5(0x120)]&&_0x1f4bfc[_0x358ca5(0x165)]){if(_0x2fb15a[_0x358ca5(0x134)]==null&&!_0x2ecdbe){const _0x5b8837=_0x3696e9?.[_0x358ca5(0x14c)]()||_0x358ca5(0x144),_0x57af35=_0x5b8837+_0x358ca5(0x13c);return _0x538bb5[_0x358ca5(0x138)]===_0x358ca5(0x170)&&await(0x0,SendWhatsAppMessage_1[_0x358ca5(0x156)])({'body':_0x57af35,'ticket':_0x538bb5}),await _0x2fb15a['update']({'ratingAt':(0x0,moment_1[_0x358ca5(0x156)])()[_0x358ca5(0x171)](),'rated':![]}),_0x242dd6['to'](_0x358ca5(0x152)+_0x538bb5[_0x358ca5(0x15c)]+_0x358ca5(0x11e))['to'](_0x358ca5(0x145)+_0x538bb5[_0x358ca5(0x142)]+_0x358ca5(0x11e))['to'](_0x124ae9[_0x358ca5(0x12c)]())[_0x358ca5(0x14a)](_0x358ca5(0x152)+_0x538bb5[_0x358ca5(0x15c)]+_0x358ca5(0x147),{'action':_0x358ca5(0x157),'ticketId':_0x538bb5['id']}),{'ticket':_0x538bb5,'oldStatus':_0x28281d,'oldUserId':_0x4c7af7};}_0x2fb15a[_0x358ca5(0x134)]=(0x0,moment_1['default'])()[_0x358ca5(0x171)](),_0x2fb15a[_0x358ca5(0x136)]=![];}if(!_0x538bb5['contact'][_0x358ca5(0x126)]&&!_0x538bb5[_0x358ca5(0x137)][_0x358ca5(0x120)]&&!_0x2ecdbe&&!(0x0,lodash_1[_0x358ca5(0x13d)])(_0x5bf633)&&_0x5bf633!==''){const _0x3469e9=(0x0,Mustache_1[_0x358ca5(0x156)])(''+_0x5bf633,_0x538bb5);if(_0x538bb5['channel']===_0x358ca5(0x170)&&!_0x538bb5[_0x358ca5(0x126)]){const _0x3af5ae=await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x3469e9,'ticket':_0x538bb5});await(0x0,VerifyHandlers_1['verifyMessage'])(_0x3af5ae,_0x538bb5,_0x538bb5[_0x358ca5(0x137)]);}}_0x2fb15a[_0x358ca5(0x15f)]=(0x0,moment_1['default'])()[_0x358ca5(0x171)](),_0x2fb15a[_0x358ca5(0x127)]=_0x538bb5[_0x358ca5(0x127)],_0x2fb15a[_0x358ca5(0x16a)]=_0x538bb5[_0x358ca5(0x16a)],_0x3e8216=![],_0x2a92ce=null;const _0xc35fe4=await(0x0,CheckSettings_1['GetCompanySetting'])(_0x23498c,_0x358ca5(0x13e),_0x358ca5(0x148));_0xc35fe4===_0x358ca5(0x122)&&(_0x261c72=null,_0x42874f=null);}_0x261c72!==undefined&&_0x261c72!==null&&(_0x2fb15a['queuedAt']=(0x0,moment_1['default'])()[_0x358ca5(0x171)]());if(_0x16dc76!==_0x261c72&&!(0x0,lodash_1['isNil'])(_0x16dc76)&&!(0x0,lodash_1[_0x358ca5(0x13d)])(_0x261c72)){if(_0x538bb5[_0x358ca5(0x138)]==='whatsapp'){const _0x379e8a=await(0x0,GetTicketWbot_1[_0x358ca5(0x156)])(_0x538bb5),{transferMessage:_0x493170}=await(0x0,ShowWhatsAppService_1[_0x358ca5(0x156)])(_0x538bb5[_0x358ca5(0x127)],_0x23498c);if(!_0x538bb5[_0x358ca5(0x126)]){if(_0x493170?.['trim']()){const _0x3c56f2=await _0x379e8a[_0x358ca5(0x132)](_0x538bb5[_0x358ca5(0x137)][_0x358ca5(0x14e)]+'@'+(_0x538bb5[_0x358ca5(0x126)]?_0x358ca5(0x131):_0x358ca5(0x16c)),{'text':''+_0x493170});await(0x0,VerifyHandlers_1['verifyMessage'])(_0x3c56f2,_0x538bb5,_0x538bb5[_0x358ca5(0x137)]);}}}}await _0x538bb5[_0x358ca5(0x150)]({'status':_0xe1df1e,'amountUsedBotQueues':_0x3e7f0a['amountUsedBotQueues']||0x0,'queueId':_0x261c72,'userId':_0x42874f,'whatsappId':_0x538bb5[_0x358ca5(0x127)],'chatbot':_0x2e4403,'queueOptionId':_0x2a4347,'useIntegration':_0x3e8216,'integrationId':_0x2a92ce}),await _0x538bb5[_0x358ca5(0x15b)](),_0xe1df1e=_0x538bb5['status'];_0xe1df1e!==undefined&&['pending'][_0x358ca5(0x15a)](_0xe1df1e)>-0x1&&(_0x2fb15a['update']({'whatsappId':_0x538bb5[_0x358ca5(0x127)],'queuedAt':(0x0,moment_1[_0x358ca5(0x156)])()['toDate'](),'startedAt':null,'userId':null}),_0x242dd6['to'](_0x358ca5(0x152)+_0x23498c+'-mainchannel')[_0x358ca5(0x14a)](_0x358ca5(0x152)+_0x23498c+_0x358ca5(0x147),{'action':_0x358ca5(0x14b),'ticketId':_0x538bb5?.['id']}));_0xe1df1e!==undefined&&[_0x358ca5(0x13b)][_0x358ca5(0x15a)](_0xe1df1e)>-0x1&&(_0x2fb15a[_0x358ca5(0x150)]({'startedAt':(0x0,moment_1[_0x358ca5(0x156)])()[_0x358ca5(0x171)](),'ratingAt':null,'rated':![],'whatsappId':_0x538bb5['whatsappId'],'userId':_0x538bb5[_0x358ca5(0x16a)]}),_0x242dd6['to']('company-'+_0x23498c+_0x358ca5(0x161))[_0x358ca5(0x14a)](_0x358ca5(0x152)+_0x23498c+_0x358ca5(0x147),{'action':_0x358ca5(0x14b),'ticketId':_0x538bb5?.['id']}),_0x242dd6['to'](_0x358ca5(0x152)+_0x23498c+_0x358ca5(0x161))['emit'](_0x358ca5(0x152)+_0x23498c+_0x358ca5(0x147),{'action':_0x358ca5(0x12f),'ticketId':_0x538bb5?.['id']}));await _0x2fb15a[_0x358ca5(0x166)]();if(_0x2ecdbe&&_0xe1df1e===_0x358ca5(0x149))_0x242dd6['to'](_0x358ca5(0x152)+_0x23498c+_0x358ca5(0x161))[_0x358ca5(0x14a)](_0x358ca5(0x152)+_0x23498c+_0x358ca5(0x147),{'action':'removeFromList','ticketId':_0x538bb5?.['id']});else _0x538bb5[_0x358ca5(0x16d)]===_0x358ca5(0x149)&&_0x538bb5['status']!==_0x28281d&&_0x242dd6['to']('company-'+_0x23498c+'-'+_0x28281d)['to'](_0x358ca5(0x145)+_0x538bb5[_0x358ca5(0x142)]+'-'+_0x28281d)['to'](_0x358ca5(0x154)+_0x4c7af7)[_0x358ca5(0x14a)](_0x358ca5(0x152)+_0x23498c+_0x358ca5(0x147),{'action':_0x358ca5(0x14b),'ticketId':_0x538bb5['id']});return _0x242dd6['to'](_0x358ca5(0x152)+_0x23498c+'-'+_0x538bb5['status'])['to']('company-'+_0x23498c+_0x358ca5(0x163))['to']('queue-'+_0x538bb5[_0x358ca5(0x142)]+'-'+_0x538bb5['status'])['to'](_0x358ca5(0x145)+_0x538bb5[_0x358ca5(0x142)]+'-notification')['to'](_0x124ae9[_0x358ca5(0x12c)]())['to'](_0x358ca5(0x154)+_0x538bb5?.['userId'])['to']('user-'+_0x4c7af7)['emit']('company-'+_0x23498c+_0x358ca5(0x147),{'action':'update','ticket':_0x538bb5}),{'ticket':_0x538bb5,'oldStatus':_0x28281d,'oldUserId':_0x4c7af7};}catch(_0x33f282){if(_0x33f282 instanceof AppError_1['default'])throw _0x33f282;throw new AppError_1[(_0x358ca5(0x156))](_0x358ca5(0x143),0x1f4,_0x33f282);}};exports['default']=UpdateTicketService;