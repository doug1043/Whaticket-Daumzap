const a671_0x21bb40=a671_0x1f84;(function(_0x14ad68,_0xa9e98){const _0x30b6f3=a671_0x1f84,_0x5403ce=_0x14ad68();while(!![]){try{const _0x2e8b8f=-parseInt(_0x30b6f3(0xc1))/0x1+-parseInt(_0x30b6f3(0xc6))/0x2*(parseInt(_0x30b6f3(0xee))/0x3)+-parseInt(_0x30b6f3(0xd3))/0x4*(-parseInt(_0x30b6f3(0xc9))/0x5)+-parseInt(_0x30b6f3(0xfe))/0x6*(-parseInt(_0x30b6f3(0xb6))/0x7)+-parseInt(_0x30b6f3(0xbc))/0x8*(-parseInt(_0x30b6f3(0xca))/0x9)+parseInt(_0x30b6f3(0xc0))/0xa*(parseInt(_0x30b6f3(0xd5))/0xb)+-parseInt(_0x30b6f3(0xd4))/0xc;if(_0x2e8b8f===_0xa9e98)break;else _0x5403ce['push'](_0x5403ce['shift']());}catch(_0x21418d){_0x5403ce['push'](_0x5403ce['shift']());}}}(a671_0xf250,0x66c3f));const a671_0x4bc52a=(function(){let _0x370b31=!![];return function(_0x5a561c,_0x1e29bf){const _0x10c2b3=_0x370b31?function(){const _0x5ba5b2=a671_0x1f84;if(_0x1e29bf){const _0xeb2a63=_0x1e29bf[_0x5ba5b2(0xb0)](_0x5a561c,arguments);return _0x1e29bf=null,_0xeb2a63;}}:function(){};return _0x370b31=![],_0x10c2b3;};}()),a671_0x4b177b=a671_0x4bc52a(this,function(){const _0x3b4c61=a671_0x1f84;return a671_0x4b177b[_0x3b4c61(0xbd)]()[_0x3b4c61(0xb7)](_0x3b4c61(0xeb))[_0x3b4c61(0xbd)]()['constructor'](a671_0x4b177b)['search']('(((.+)+)+)+$');});a671_0x4b177b();function a671_0x1f84(_0xdc64b7,_0x561569){const _0x328da0=a671_0xf250();return a671_0x1f84=function(_0x4b177b,_0x4bc52a){_0x4b177b=_0x4b177b-0x9f;let _0xf25001=_0x328da0[_0x4b177b];return _0xf25001;},a671_0x1f84(_0xdc64b7,_0x561569);}'use strict';var __importDefault=this&&this[a671_0x21bb40(0xa9)]||function(_0x466410){const _0x5bc5d5=a671_0x21bb40;return _0x466410&&_0x466410[_0x5bc5d5(0xd0)]?_0x466410:{'default':_0x466410};};function a671_0xf250(){const _0x25ab2b=['companyId','queue','name','../../helpers/Mustache','../WbotServices/SendWhatsAppMedia','contactId','ratingAt','(((.+)+)+)+$','-ticket','lodash','381CzWxbD','../../models/Queue','-mainchannel','moment','user-','finishedAt','whatsappId','user','status','admin','../../errors/AppError','greetingAcceptedMessage','disableBot','../../helpers/SetTicketMessagesAsRead','contact','public','18vSfzvf','reload','existsSync','color','useRating','userId','useIntegration','verifyMessage','pending','open','../../models/User','__importDefault','channel','save','toDate','Error\x20updating\x20ticket','../WbotServices/SendWhatsAppMessage','isGroup','apply','keepUserAndQueue','rated','superv','Por\x20favor\x20avalie\x20nosso\x20atendimento','getIO','1275694eKEDvS','search','closed','greetingMediaAttachment','../WbotServices/VerifyHandlers','trim','80kcrQxw','toString','isNil','Apenas\x20o\x20usuário\x20ativo\x20do\x20ticket,\x20Supervisor\x20ou\x20Admin\x20podem\x20fazer\x20alterações\x20no\x20ticket','430YozXYC','437179mCRfWv','../WhatsappService/ShowWhatsAppService','queueId','removeFromList','./FindOrCreateATicketTrakingService','8488LCADyT','indexOf','\x0a\x0a*Digite\x20uma\x20nota\x20de\x201\x20a\x205*\x0a','177755FFWTQn','291744XeKpNq','sendTransferMessage','delete','greetingMessage','queue-','-open','__esModule','Need\x20companyId\x20or\x20tokenData','company-','76SWkqUE','9769008cqAeKL','170071IwuBTg','update','GetCompanySetting','updateUnread','transferMessage','amountUsedBotQueues','emit','resolve','chatbot','integrationId','-notification','profile','enabled','default','whatsapp'];a671_0xf250=function(){return _0x25ab2b;};return a671_0xf250();}Object['defineProperty'](exports,a671_0x21bb40(0xd0),{'value':!![]});const moment_1=__importDefault(require(a671_0x21bb40(0xf1))),lodash_1=require(a671_0x21bb40(0xed)),path_1=__importDefault(require('path')),fs_1=__importDefault(require('fs')),CheckContactOpenTickets_1=__importDefault(require('../../helpers/CheckContactOpenTickets')),SetTicketMessagesAsRead_1=__importDefault(require(a671_0x21bb40(0xfb))),socket_1=require('../../libs/socket'),Queue_1=__importDefault(require(a671_0x21bb40(0xef))),User_1=__importDefault(require(a671_0x21bb40(0xa8))),ShowTicketService_1=__importDefault(require('./ShowTicketService')),ShowWhatsAppService_1=__importDefault(require(a671_0x21bb40(0xc2))),SendWhatsAppMessage_1=__importDefault(require(a671_0x21bb40(0xae))),SendWhatsAppMedia_1=__importDefault(require(a671_0x21bb40(0xe8))),FindOrCreateATicketTrakingService_1=__importDefault(require(a671_0x21bb40(0xc5))),VerifyHandlers_1=require(a671_0x21bb40(0xba)),AppError_1=__importDefault(require(a671_0x21bb40(0xf8))),CheckSettings_1=require('../../helpers/CheckSettings'),Mustache_1=__importDefault(require(a671_0x21bb40(0xe7))),UpdateTicketService=async({ticketData:_0x35b1de,ticketId:_0x468ec7,tokenData:_0x3d1255,companyId:_0x1829aa})=>{const _0x11fa6b=a671_0x21bb40;try{if(!_0x1829aa&&!_0x3d1255)throw new Error(_0x11fa6b(0xd1));_0x3d1255&&(_0x1829aa=_0x3d1255['companyId']);const {justClose:_0xb8477}=_0x35b1de;let {status:_0x2197a1}=_0x35b1de,{queueId:_0xbed187,userId:_0x3fd581}=_0x35b1de,_0x180b5f=_0x35b1de[_0x11fa6b(0xdd)]||![],_0x164baf=_0x35b1de[_0x11fa6b(0xa4)]||![],_0x41ec39=_0x35b1de[_0x11fa6b(0xde)]||null;const _0x5da8a9=(0x0,socket_1[_0x11fa6b(0xb5)])(),_0x48f055=await(0x0,ShowTicketService_1[_0x11fa6b(0xe2)])(_0x468ec7,_0x1829aa),_0x3e2d89=await(0x0,ShowWhatsAppService_1['default'])(_0x48f055[_0x11fa6b(0xf4)],_0x1829aa);if(_0x3d1255&&_0x48f055[_0x11fa6b(0xf6)]!==_0x11fa6b(0xa6)){if(_0x3d1255[_0x11fa6b(0xe0)]!==_0x11fa6b(0xf7)&&_0x3d1255['profile']!==_0x11fa6b(0xb3)&&_0x48f055[_0x11fa6b(0xa3)]!==parseInt(_0x3d1255['id'],0xa))throw new AppError_1[(_0x11fa6b(0xe2))](_0x11fa6b(0xbf));}const _0x5e9a72=await(0x0,FindOrCreateATicketTrakingService_1[_0x11fa6b(0xe2)])({'ticketId':_0x468ec7,'companyId':_0x1829aa,'whatsappId':_0x48f055[_0x11fa6b(0xf4)]});_0x48f055['channel']==='whatsapp'&&_0x2197a1===_0x11fa6b(0xa7)&&(0x0,SetTicketMessagesAsRead_1[_0x11fa6b(0xe2)])(_0x48f055);const _0x5064a4=_0x48f055[_0x11fa6b(0xf6)],_0x4f0cdb=_0x48f055[_0x11fa6b(0xf5)]?.['id'],_0x400550=_0x48f055[_0x11fa6b(0xc3)];_0x5064a4===_0x11fa6b(0xb8)&&(await(0x0,CheckContactOpenTickets_1['default'])(_0x48f055[_0x11fa6b(0xe9)],_0x48f055['whatsappId']),_0x180b5f=null);if(_0x2197a1!==undefined&&[_0x11fa6b(0xb8)][_0x11fa6b(0xc7)](_0x2197a1)>-0x1){const {complationMessage:_0x4adf84,ratingMessage:_0x5de228}=await(0x0,ShowWhatsAppService_1[_0x11fa6b(0xe2)])(_0x48f055[_0x11fa6b(0xf4)],_0x1829aa);if(!_0x48f055['contact']['isGroup']&&!_0x48f055[_0x11fa6b(0xfc)][_0x11fa6b(0xfa)]&&_0x3e2d89[_0x11fa6b(0xa2)]){if(_0x5e9a72[_0x11fa6b(0xea)]==null&&!_0xb8477){const _0x5c7737=_0x5de228?.[_0x11fa6b(0xbb)]()||_0x11fa6b(0xb4),_0x7fedd4=_0x5c7737+_0x11fa6b(0xc8);return _0x48f055[_0x11fa6b(0xaa)]===_0x11fa6b(0xe3)&&await(0x0,SendWhatsAppMessage_1[_0x11fa6b(0xe2)])({'body':_0x7fedd4,'ticket':_0x48f055}),await _0x5e9a72[_0x11fa6b(0xd6)]({'ratingAt':(0x0,moment_1[_0x11fa6b(0xe2)])()[_0x11fa6b(0xac)](),'rated':![]}),_0x5da8a9['to'](_0x11fa6b(0xd2)+_0x48f055['companyId']+'-open')['to'](_0x11fa6b(0xce)+_0x48f055['queueId']+_0x11fa6b(0xcf))['to'](_0x468ec7[_0x11fa6b(0xbd)]())[_0x11fa6b(0xdb)](_0x11fa6b(0xd2)+_0x48f055[_0x11fa6b(0xe4)]+_0x11fa6b(0xec),{'action':_0x11fa6b(0xcc),'ticketId':_0x48f055['id']}),{'ticket':_0x48f055,'oldStatus':_0x5064a4,'oldUserId':_0x4f0cdb};}_0x5e9a72['ratingAt']=(0x0,moment_1[_0x11fa6b(0xe2)])()['toDate'](),_0x5e9a72[_0x11fa6b(0xb2)]=![];}if(!_0x48f055[_0x11fa6b(0xfc)]['isGroup']&&!_0x48f055[_0x11fa6b(0xfc)][_0x11fa6b(0xfa)]&&!_0xb8477&&!(0x0,lodash_1[_0x11fa6b(0xbe)])(_0x4adf84)&&_0x4adf84!==''){const _0x504f51=(0x0,Mustache_1[_0x11fa6b(0xe2)])(''+_0x4adf84,_0x48f055);if(_0x48f055[_0x11fa6b(0xaa)]===_0x11fa6b(0xe3)&&!_0x48f055[_0x11fa6b(0xaf)]){const _0x441486=await(0x0,SendWhatsAppMessage_1[_0x11fa6b(0xe2)])({'body':_0x504f51,'ticket':_0x48f055});await(0x0,VerifyHandlers_1[_0x11fa6b(0xa5)])(_0x441486,_0x48f055,_0x48f055[_0x11fa6b(0xfc)]);}}_0x5e9a72[_0x11fa6b(0xf3)]=(0x0,moment_1[_0x11fa6b(0xe2)])()['toDate'](),_0x5e9a72['whatsappId']=_0x48f055[_0x11fa6b(0xf4)],_0x5e9a72['userId']=_0x48f055[_0x11fa6b(0xa3)],_0x164baf=![],_0x41ec39=null;const _0x386986=await(0x0,CheckSettings_1[_0x11fa6b(0xd7)])(_0x1829aa,_0x11fa6b(0xb1),_0x11fa6b(0xe1));_0x386986==='disabled'&&(_0xbed187=null,_0x3fd581=null);}_0xbed187!==undefined&&_0xbed187!==null&&(_0x5e9a72['queuedAt']=(0x0,moment_1[_0x11fa6b(0xe2)])()[_0x11fa6b(0xac)]());await _0x48f055[_0x11fa6b(0xd6)]({'status':_0x2197a1,'amountUsedBotQueues':_0x35b1de[_0x11fa6b(0xda)]||0x0,'queueId':_0xbed187,'userId':_0x3fd581,'whatsappId':_0x48f055[_0x11fa6b(0xf4)],'chatbot':_0x180b5f,'useIntegration':_0x164baf,'integrationId':_0x41ec39}),await _0x48f055[_0x11fa6b(0x9f)]();if(_0x400550!==_0xbed187&&!(0x0,lodash_1[_0x11fa6b(0xbe)])(_0x400550)&&!(0x0,lodash_1[_0x11fa6b(0xbe)])(_0xbed187)){if(_0x48f055[_0x11fa6b(0xaa)]===_0x11fa6b(0xe3)){const _0x415a5b=await(0x0,ShowWhatsAppService_1[_0x11fa6b(0xe2)])(_0x48f055[_0x11fa6b(0xf4)],_0x1829aa);if(_0x415a5b[_0x11fa6b(0xcb)]&&!_0x48f055['isGroup']){if(_0x415a5b[_0x11fa6b(0xd9)]?.['trim']()){await _0x48f055[_0x11fa6b(0x9f)]({'include':[{'model':Queue_1[_0x11fa6b(0xe2)],'as':_0x11fa6b(0xe5),'attributes':['id','name','color']},{'model':User_1['default'],'as':_0x11fa6b(0xf5),'attributes':['id','name']}]});const _0x78832e=(0x0,Mustache_1[_0x11fa6b(0xe2)])(_0x415a5b[_0x11fa6b(0xd9)],_0x48f055);await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x78832e,'ticket':_0x48f055});}}}}if(_0x5064a4===_0x11fa6b(0xa6)&&_0x2197a1===_0x11fa6b(0xa7)&&_0x48f055[_0x11fa6b(0xaa)]==='whatsapp'&&!_0x48f055[_0x11fa6b(0xaf)]){const _0x16e4e3=await(0x0,ShowWhatsAppService_1[_0x11fa6b(0xe2)])(_0x48f055['whatsappId'],_0x1829aa);if(_0x16e4e3['sendGreetingAccepted']){const _0x273ab5=_0x16e4e3[_0x11fa6b(0xf9)]?.[_0x11fa6b(0xbb)]()||_0x16e4e3[_0x11fa6b(0xcd)]?.['trim']();if(_0x273ab5){await _0x48f055[_0x11fa6b(0x9f)]({'include':[{'model':Queue_1[_0x11fa6b(0xe2)],'as':_0x11fa6b(0xe5),'attributes':['id',_0x11fa6b(0xe6),_0x11fa6b(0xa1)]},{'model':User_1[_0x11fa6b(0xe2)],'as':_0x11fa6b(0xf5),'attributes':['id','name']}]});if(_0x16e4e3['greetingMediaAttachment']){const _0x3a2c76=path_1[_0x11fa6b(0xe2)][_0x11fa6b(0xdc)](_0x11fa6b(0xfd),_0x16e4e3[_0x11fa6b(0xb9)]),_0x571afd=fs_1[_0x11fa6b(0xe2)][_0x11fa6b(0xa0)](_0x3a2c76);if(_0x571afd){const _0x4178b7=(0x0,Mustache_1[_0x11fa6b(0xe2)])(_0x273ab5,_0x48f055);await(0x0,SendWhatsAppMedia_1[_0x11fa6b(0xe2)])({'ticket':_0x48f055,'media':_0x3a2c76,'body':_0x4178b7});}else{const _0x2ca7cf=(0x0,Mustache_1['default'])(_0x273ab5,_0x48f055);await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x2ca7cf,'ticket':_0x48f055});}}else{const _0x30b833=(0x0,Mustache_1[_0x11fa6b(0xe2)])(_0x273ab5,_0x48f055);await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x30b833,'ticket':_0x48f055});}}}}_0x2197a1=_0x48f055[_0x11fa6b(0xf6)];_0x2197a1!==undefined&&[_0x11fa6b(0xa6)][_0x11fa6b(0xc7)](_0x2197a1)>-0x1&&(_0x5e9a72[_0x11fa6b(0xd6)]({'whatsappId':_0x48f055['whatsappId'],'queuedAt':(0x0,moment_1[_0x11fa6b(0xe2)])()['toDate'](),'startedAt':null,'userId':null}),_0x5da8a9['to'](_0x11fa6b(0xd2)+_0x1829aa+_0x11fa6b(0xf0))[_0x11fa6b(0xdb)](_0x11fa6b(0xd2)+_0x1829aa+'-ticket',{'action':_0x11fa6b(0xc4),'ticketId':_0x48f055?.['id']}));_0x2197a1!==undefined&&[_0x11fa6b(0xa7)][_0x11fa6b(0xc7)](_0x2197a1)>-0x1&&(_0x5e9a72[_0x11fa6b(0xd6)]({'startedAt':(0x0,moment_1['default'])()[_0x11fa6b(0xac)](),'ratingAt':null,'rated':![],'whatsappId':_0x48f055[_0x11fa6b(0xf4)],'userId':_0x48f055[_0x11fa6b(0xa3)]}),_0x5da8a9['to']('company-'+_0x1829aa+'-mainchannel')[_0x11fa6b(0xdb)]('company-'+_0x1829aa+_0x11fa6b(0xec),{'action':_0x11fa6b(0xc4),'ticketId':_0x48f055?.['id']}),_0x5da8a9['to'](_0x11fa6b(0xd2)+_0x1829aa+'-mainchannel')['emit'](_0x11fa6b(0xd2)+_0x1829aa+'-ticket',{'action':_0x11fa6b(0xd8),'ticketId':_0x48f055?.['id']}));await _0x5e9a72[_0x11fa6b(0xab)]();if(_0xb8477&&_0x2197a1===_0x11fa6b(0xb8))_0x5da8a9['to'](_0x11fa6b(0xd2)+_0x1829aa+_0x11fa6b(0xf0))[_0x11fa6b(0xdb)](_0x11fa6b(0xd2)+_0x1829aa+'-ticket',{'action':_0x11fa6b(0xc4),'ticketId':_0x48f055?.['id']});else _0x48f055[_0x11fa6b(0xf6)]===_0x11fa6b(0xb8)&&_0x48f055[_0x11fa6b(0xf6)]!==_0x5064a4&&_0x5da8a9['to']('company-'+_0x1829aa+'-'+_0x5064a4)['to'](_0x11fa6b(0xce)+_0x48f055[_0x11fa6b(0xc3)]+'-'+_0x5064a4)['to'](_0x11fa6b(0xf2)+_0x4f0cdb)[_0x11fa6b(0xdb)]('company-'+_0x1829aa+_0x11fa6b(0xec),{'action':_0x11fa6b(0xc4),'ticketId':_0x48f055['id']});return _0x5da8a9['to']('company-'+_0x1829aa+'-'+_0x48f055[_0x11fa6b(0xf6)])['to'](_0x11fa6b(0xd2)+_0x1829aa+'-notification')['to'](_0x11fa6b(0xce)+_0x48f055['queueId']+'-'+_0x48f055[_0x11fa6b(0xf6)])['to'](_0x11fa6b(0xce)+_0x48f055['queueId']+_0x11fa6b(0xdf))['to'](_0x468ec7[_0x11fa6b(0xbd)]())['to'](_0x11fa6b(0xf2)+_0x48f055?.[_0x11fa6b(0xa3)])['to'](_0x11fa6b(0xf2)+_0x4f0cdb)[_0x11fa6b(0xdb)]('company-'+_0x1829aa+_0x11fa6b(0xec),{'action':'update','ticket':_0x48f055}),{'ticket':_0x48f055,'oldStatus':_0x5064a4,'oldUserId':_0x4f0cdb};}catch(_0x3b9a08){if(_0x3b9a08 instanceof AppError_1['default'])throw _0x3b9a08;throw new AppError_1[(_0x11fa6b(0xe2))](_0x11fa6b(0xad),0x1f4,_0x3b9a08);}};exports[a671_0x21bb40(0xe2)]=UpdateTicketService;