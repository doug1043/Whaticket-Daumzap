const a530_0x53826f=a530_0x20d1;(function(_0x54cc9f,_0x16c663){const _0x162158=a530_0x20d1,_0x378952=_0x54cc9f();while(!![]){try{const _0x108a33=-parseInt(_0x162158(0xe3))/0x1*(parseInt(_0x162158(0x7b))/0x2)+parseInt(_0x162158(0xeb))/0x3*(-parseInt(_0x162158(0xd2))/0x4)+-parseInt(_0x162158(0x92))/0x5*(parseInt(_0x162158(0xb7))/0x6)+parseInt(_0x162158(0x9f))/0x7*(parseInt(_0x162158(0x76))/0x8)+-parseInt(_0x162158(0x9a))/0x9*(parseInt(_0x162158(0xa5))/0xa)+-parseInt(_0x162158(0x83))/0xb+parseInt(_0x162158(0x6f))/0xc;if(_0x108a33===_0x16c663)break;else _0x378952['push'](_0x378952['shift']());}catch(_0x13a936){_0x378952['push'](_0x378952['shift']());}}}(a530_0x5b39,0xae3bc));const a530_0x116461=(function(){let _0x5e96ad=!![];return function(_0x645e7,_0x7ada03){const _0xa84e30=_0x5e96ad?function(){const _0x201cda=a530_0x20d1;if(_0x7ada03){const _0xbecfc=_0x7ada03[_0x201cda(0xa7)](_0x645e7,arguments);return _0x7ada03=null,_0xbecfc;}}:function(){};return _0x5e96ad=![],_0xa84e30;};}()),a530_0x1fb597=a530_0x116461(this,function(){const _0x4b9d3c=a530_0x20d1;return a530_0x1fb597[_0x4b9d3c(0x9e)]()[_0x4b9d3c(0xdf)](_0x4b9d3c(0xcb))['toString']()['constructor'](a530_0x1fb597)['search']('(((.+)+)+)+$');});a530_0x1fb597();'use strict';var __createBinding=this&&this[a530_0x53826f(0x94)]||(Object[a530_0x53826f(0x8d)]?function(_0x5b2fd9,_0xb2c94c,_0x26d328,_0x4bdf67){const _0x5e4492=a530_0x53826f;if(_0x4bdf67===undefined)_0x4bdf67=_0x26d328;var _0x5a7a6d=Object[_0x5e4492(0x84)](_0xb2c94c,_0x26d328);(!_0x5a7a6d||(_0x5e4492(0x95)in _0x5a7a6d?!_0xb2c94c['__esModule']:_0x5a7a6d[_0x5e4492(0xd8)]||_0x5a7a6d[_0x5e4492(0xa9)]))&&(_0x5a7a6d={'enumerable':!![],'get':function(){return _0xb2c94c[_0x26d328];}}),Object[_0x5e4492(0xcd)](_0x5b2fd9,_0x4bdf67,_0x5a7a6d);}:function(_0x3b0f01,_0x1f8d36,_0x43c932,_0x180b69){if(_0x180b69===undefined)_0x180b69=_0x43c932;_0x3b0f01[_0x180b69]=_0x1f8d36[_0x43c932];}),__setModuleDefault=this&&this[a530_0x53826f(0x97)]||(Object[a530_0x53826f(0x8d)]?function(_0x1c425d,_0x33f5be){const _0x199428=a530_0x53826f;Object['defineProperty'](_0x1c425d,_0x199428(0x81),{'enumerable':!![],'value':_0x33f5be});}:function(_0x8f90de,_0x1e038f){_0x8f90de['default']=_0x1e038f;}),__importStar=this&&this[a530_0x53826f(0xae)]||function(_0x5d16b6){const _0xd48472=a530_0x53826f;if(_0x5d16b6&&_0x5d16b6['__esModule'])return _0x5d16b6;var _0x2a2db8={};if(_0x5d16b6!=null){for(var _0x169bc7 in _0x5d16b6)if(_0x169bc7!==_0xd48472(0x81)&&Object[_0xd48472(0x9c)][_0xd48472(0xe2)][_0xd48472(0xe7)](_0x5d16b6,_0x169bc7))__createBinding(_0x2a2db8,_0x5d16b6,_0x169bc7);}return __setModuleDefault(_0x2a2db8,_0x5d16b6),_0x2a2db8;},__importDefault=this&&this[a530_0x53826f(0xad)]||function(_0xbf61a0){const _0x4b5040=a530_0x53826f;return _0xbf61a0&&_0xbf61a0[_0x4b5040(0x79)]?_0xbf61a0:{'default':_0xbf61a0};};function a530_0x5b39(){const _0x2bf11b=['getTime','10UIYuWT','../../models/Queue','apply','update','configurable','-ticket','whatsappId','userId','__importDefault','__importStar','integrationId','../../helpers/CheckContactOpenTickets','queue-','useIntegration','\x0aaguarde,\x20já\x20vamos\x20te\x20atender!','getIO','trace','-mainchannel','10812YWoykZ','updateUnread','toDate','../../libs/socket','ratingAt','\x20em\x20','dest','contact','queueOptionId','Apenas\x20o\x20usuário\x20ativo\x20do\x20ticket\x20ou\x20o\x20Admin\x20podem\x20fazer\x20alterações\x20no\x20ticket','removeFromList','../WhatsappService/ShowWhatsAppService','notifyUpdate','pending','username','push','*Mensagem\x20automática*:\x0aVocê\x20foi\x20transferido\x20para\x20o\x20departamento\x20*','verifyMessage','emit','*4*\x20-\x20_Satisfeito_\x0a','(((.+)+)+)+$','filter','defineProperty','*Mensagem\x20automática*:\x0aFoi\x20transferido\x20para\x20o\x20atendente\x20*','*\x0aaguarde,\x20já\x20vamos\x20te\x20atender!','../SettingServices/ListSettingsServiceOne','company-','4DrEZfb','isGroup','delete','name','-notification','Digite\x20de\x201\x20à\x205\x20para\x20qualificar\x20nosso\x20atendimento:\x0a','writable','*\x20transferiu\x20o\x20ticket\x20para\x20você,\x20*','../../helpers/GetTicketWbot','admin','user','@sentry/node','*3*\x20-\x20_Moderadamente\x20Satisfeito_\x0a','search','captureException','format','hasOwnProperty','10913bcSrHt','newTicketOnTransfer','*\x20por\x20','status','call','isNil','enabled','queueId','3101355WfsQhz','48596988Qjdwav','../../errors/AppError','reload','find','companyId','g.us','chatbot','19760JbraxK','SendPresenceStatus','number','__esModule','sendMessage','32kUnCkb','../WbotServices/wbotMessageListener','./ShowTicketService','moment','userRating','value','default','open','3895705kWBvRf','getOwnPropertyDescriptor','../../helpers/SendPresenceStatus','*5*\x20-\x20_Muito\x20Satisfeito_\x0a','rated','ticketId','*Mensagem\x20automática*:\x0aO\x20atendente\x20anterior\x20*','unreadMessages','finishedAt','sendMsgTransfTicket','create','*1*\x20-\x20_Muito\x20Insatisfeito_\x0a','\x0aAguarde,\x20já\x20vamos\x20te\x20atender!','lodash','amountUsedBotQueues','3685WWGrYv','closed','__createBinding','get','../WbotServices/SendWhatsAppMessage','__setModuleDefault','promptId','*2*\x20-\x20_Insatisfeito_\x0a','11834163SURquZ','s.whatsapp.net','prototype','disableBot','toString','2464PepPkW','../../models/Ticket','length','DD/MM/YYYY\x20HH:mm:ss','../UserServices/ShowUserService'];a530_0x5b39=function(){return _0x2bf11b;};return a530_0x5b39();}Object['defineProperty'](exports,a530_0x53826f(0x79),{'value':!![]}),exports[a530_0x53826f(0xc3)]=void 0x0;const moment_1=__importDefault(require(a530_0x53826f(0x7e))),Sentry=__importStar(require(a530_0x53826f(0xdd))),CheckContactOpenTickets_1=__importDefault(require(a530_0x53826f(0xb0))),SetTicketMessagesAsRead_1=__importDefault(require('../../helpers/SetTicketMessagesAsRead')),socket_1=require(a530_0x53826f(0xba)),Ticket_1=__importDefault(require(a530_0x53826f(0xa0))),Setting_1=__importDefault(require('../../models/Setting')),Queue_1=__importDefault(require(a530_0x53826f(0xa6))),ShowTicketService_1=__importDefault(require(a530_0x53826f(0x7d))),ShowWhatsAppService_1=__importDefault(require(a530_0x53826f(0xc2))),SendWhatsAppMessage_1=__importDefault(require(a530_0x53826f(0x96))),FindOrCreateATicketTrakingService_1=__importDefault(require('./FindOrCreateATicketTrakingService')),GetTicketWbot_1=__importDefault(require(a530_0x53826f(0xda))),wbotMessageListener_1=require(a530_0x53826f(0x7c)),ListSettingsServiceOne_1=__importDefault(require(a530_0x53826f(0xd0))),ShowUserService_1=__importDefault(require(a530_0x53826f(0xa3))),lodash_1=require(a530_0x53826f(0x90)),AppError_1=__importDefault(require(a530_0x53826f(0x70))),SendPresenceStatus_1=require(a530_0x53826f(0x85)),wbot_1=require('../../libs/wbot');function a530_0x20d1(_0x36eadd,_0x30f5c7){const _0x5ef86d=a530_0x5b39();return a530_0x20d1=function(_0x1fb597,_0x116461){_0x1fb597=_0x1fb597-0x6f;let _0x5b39a3=_0x5ef86d[_0x1fb597];return _0x5b39a3;},a530_0x20d1(_0x36eadd,_0x30f5c7);}let completionMessageControl=[];const UpdateTicketService=async({ticketData:_0x1bb3a9,ticketId:_0x390c04,tokenData:_0x165c0b,companyId:_0x3de469})=>{const _0x48f31c=a530_0x53826f;try{if(!_0x3de469&&!_0x165c0b)throw new Error('Need\x20companyId\x20or\x20tokenData');_0x165c0b&&(_0x3de469=_0x165c0b['companyId']);let {status:_0x39139c}=_0x1bb3a9,{queueId:_0x32d78d,userId:_0x44ef30,whatsappId:_0x38bace,sendFarewellMessage:_0x4f76cf}=_0x1bb3a9;_0x4f76cf==null&&(_0x4f76cf=!![]);let _0x28bab8=_0x1bb3a9[_0x48f31c(0x75)]||![],_0x578656=_0x1bb3a9[_0x48f31c(0xbf)]||null,_0x814d1d=_0x1bb3a9[_0x48f31c(0x98)]||null,_0x4e161c=_0x1bb3a9[_0x48f31c(0xb2)]||![],_0x63b07d=_0x1bb3a9[_0x48f31c(0xaf)]||null;const _0x1367bf=(0x0,socket_1[_0x48f31c(0xb4)])(),_0x109259=_0x48f31c(0x7f),_0x4e9d8d=await Setting_1[_0x48f31c(0x81)]['findOne']({'where':{'companyId':_0x3de469,'key':_0x109259}});let _0x4437e9=await(0x0,ShowTicketService_1[_0x48f31c(0x81)])(_0x390c04,_0x3de469);if(_0x165c0b&&_0x4437e9[_0x48f31c(0xe6)]!=='pending'){if(_0x165c0b['profile']!==_0x48f31c(0xdb)&&_0x4437e9[_0x48f31c(0xac)]!==parseInt(_0x165c0b['id'],0xa))throw new AppError_1[(_0x48f31c(0x81))](_0x48f31c(0xc0));}const _0x240dea=await(0x0,FindOrCreateATicketTrakingService_1[_0x48f31c(0x81)])({'ticketId':_0x390c04,'companyId':_0x3de469,'whatsappId':_0x4437e9[_0x48f31c(0xab)]});(0x0,lodash_1[_0x48f31c(0xe8)])(_0x38bace)&&(_0x38bace=_0x4437e9[_0x48f31c(0xab)][_0x48f31c(0x9e)]());(_0x39139c===_0x48f31c(0x93)||_0x39139c==='open')&&await(0x0,SetTicketMessagesAsRead_1[_0x48f31c(0x81)])(_0x4437e9);const _0x4b086a=_0x4437e9['status'],_0x2896fa=_0x4437e9[_0x48f31c(0xdc)]?.['id'],_0x161c9f=_0x4437e9[_0x48f31c(0xea)];(_0x4b086a===_0x48f31c(0x93)||_0x38bace!==undefined&&Number(_0x38bace)!==_0x4437e9[_0x48f31c(0xab)])&&(await(0x0,CheckContactOpenTickets_1[_0x48f31c(0x81)])(_0x4437e9['contact']['id'],_0x38bace),_0x28bab8=null,_0x578656=null);if(_0x39139c===_0x48f31c(0x93)){const {complationMessage:_0x576b51,ratingMessage:_0x202644}=await(0x0,ShowWhatsAppService_1[_0x48f31c(0x81)])(_0x4437e9['whatsappId'],_0x3de469);if(!_0x4437e9['contact'][_0x48f31c(0x9d)]&&_0x4e9d8d?.['value']===_0x48f31c(0xe9)&&_0x4f76cf&&!_0x4437e9['isGroup']){if(_0x240dea[_0x48f31c(0xbb)]==null&&!_0x4437e9[_0x48f31c(0xd3)]){const _0x3c26df=_0x202644||'';let _0x18726b='‎'+_0x3c26df+'\x0a\x0a';return _0x18726b+=_0x48f31c(0xd7)+_0x48f31c(0x8e)+_0x48f31c(0x99)+_0x48f31c(0xde)+_0x48f31c(0xca)+_0x48f31c(0x86),await(0x0,SendPresenceStatus_1['SendPresenceStatus'])((0x0,wbot_1['getWbot'])(_0x4437e9['whatsappId']),_0x4437e9[_0x48f31c(0xbe)][_0x48f31c(0x78)]+'@'+(_0x4437e9['isGroup']?_0x48f31c(0x74):_0x48f31c(0x9b))),await(0x0,SendWhatsAppMessage_1[_0x48f31c(0x81)])({'body':_0x18726b,'ticket':_0x4437e9}),await _0x240dea[_0x48f31c(0xa8)]({'rated':![],'ratingAt':(0x0,moment_1[_0x48f31c(0x81)])()[_0x48f31c(0xb9)]()}),await _0x4437e9['update']({'amountUsedBotQueues':_0x1bb3a9['amountUsedBotQueues']||0x0,'status':_0x39139c,'unreadMessages':_0x1bb3a9['unreadMessages']||0x0,'queueId':_0x32d78d,'userId':_0x44ef30,'whatsappId':_0x38bace,'chatbot':_0x28bab8,'queueOptionId':_0x578656}),_0x1367bf['to'](_0x48f31c(0xd1)+_0x4437e9[_0x48f31c(0x73)]+'-open')['to'](_0x390c04[_0x48f31c(0x9e)]())[_0x48f31c(0xc9)](_0x48f31c(0xd1)+_0x4437e9['companyId']+_0x48f31c(0xaa),{'action':'delete','ticketId':_0x4437e9['id']}),{'ticket':_0x4437e9,'oldStatus':_0x4b086a,'oldUserId':_0x2896fa};}_0x240dea[_0x48f31c(0xbb)]=(0x0,moment_1[_0x48f31c(0x81)])()[_0x48f31c(0xb9)](),_0x240dea[_0x48f31c(0x87)]=![];}if(completionMessageControl[_0x48f31c(0xa1)]>=0x9c4)completionMessageControl=[];if(!(0x0,lodash_1['isNil'])(_0x576b51)&&_0x576b51!==''&&_0x4f76cf&&!_0x4437e9['isGroup']){let _0x4b2cba=completionMessageControl[_0x48f31c(0x72)](_0x146f3f=>_0x146f3f['ticketId']===_0x4437e9['id']||_0x146f3f[_0x48f31c(0xbd)]===_0x4437e9[_0x48f31c(0xbe)][_0x48f31c(0x78)]);if(!_0x4b2cba||_0x4b2cba&&_0x4b2cba['time']+0x3e8*0x3c*0x1e<new Date()['getTime']()){_0x4b2cba&&(completionMessageControl=completionMessageControl[_0x48f31c(0xcc)](_0x1fac38=>_0x1fac38[_0x48f31c(0x88)]!==_0x4437e9['id']),_0x4b2cba=null);if(!_0x4437e9[_0x48f31c(0xbe)][_0x48f31c(0x9d)]&&!(0x0,lodash_1['isNil'])(_0x576b51)&&_0x576b51!==''){const _0x3d1b1f='‎'+_0x576b51;await(0x0,SendPresenceStatus_1[_0x48f31c(0x77)])((0x0,wbot_1['getWbot'])(_0x4437e9[_0x48f31c(0xab)]),_0x4437e9[_0x48f31c(0xbe)]['number']+'@'+(_0x4437e9[_0x48f31c(0xd3)]?_0x48f31c(0x74):'s.whatsapp.net')),await(0x0,SendWhatsAppMessage_1[_0x48f31c(0x81)])({'body':_0x3d1b1f,'ticket':_0x4437e9});}}!_0x4b2cba&&completionMessageControl[_0x48f31c(0xc6)]({'ticketId':_0x4437e9['id'],'dest':_0x4437e9[_0x48f31c(0xbe)][_0x48f31c(0x78)],'time':new Date()[_0x48f31c(0xa4)]()});}await _0x4437e9[_0x48f31c(0xa8)]({'promptId':null,'integrationId':null,'useIntegration':![],'typebotStatus':![],'typebotSessionId':null}),_0x240dea[_0x48f31c(0x8b)]=(0x0,moment_1[_0x48f31c(0x81)])()[_0x48f31c(0xb9)](),_0x240dea[_0x48f31c(0xab)]=_0x4437e9['whatsappId'],_0x240dea['userId']=_0x4437e9['userId'];}_0x32d78d!==undefined&&_0x32d78d!==null&&(_0x240dea['queuedAt']=(0x0,moment_1[_0x48f31c(0x81)])()[_0x48f31c(0xb9)]());const _0x26bcdf=await(0x0,ListSettingsServiceOne_1[_0x48f31c(0x81)])({'companyId':_0x3de469,'key':_0x48f31c(0x8c)}),_0x37748e=await Queue_1[_0x48f31c(0x81)]['findByPk'](_0x32d78d);if(_0x26bcdf?.[_0x48f31c(0x80)]===_0x48f31c(0xe9)){if(_0x161c9f!==_0x32d78d&&_0x2896fa===_0x44ef30&&!(0x0,lodash_1['isNil'])(_0x161c9f)&&!(0x0,lodash_1[_0x48f31c(0xe8)])(_0x32d78d)){const _0x43ba0a=await(0x0,GetTicketWbot_1[_0x48f31c(0x81)])(_0x4437e9),_0x306f0a='*Mensagem\x20automática*:\x0aVocê\x20foi\x20transferido\x20para\x20o\x20departamento\x20*'+_0x37748e?.[_0x48f31c(0xd5)]+_0x48f31c(0xcf);await(0x0,SendPresenceStatus_1['SendPresenceStatus'])(_0x43ba0a,_0x4437e9[_0x48f31c(0xbe)]['number']+'@'+(_0x4437e9[_0x48f31c(0xd3)]?_0x48f31c(0x74):'s.whatsapp.net'));const _0x2b1ea1=await _0x43ba0a[_0x48f31c(0x7a)](_0x4437e9[_0x48f31c(0xbe)][_0x48f31c(0x78)]+'@'+(_0x4437e9[_0x48f31c(0xd3)]?_0x48f31c(0x74):_0x48f31c(0x9b)),{'text':_0x306f0a});await(0x0,wbotMessageListener_1[_0x48f31c(0xc8)])(_0x2b1ea1,_0x4437e9,_0x4437e9[_0x48f31c(0xbe)]);}else{if(_0x2896fa!==_0x44ef30&&_0x161c9f===_0x32d78d&&!(0x0,lodash_1[_0x48f31c(0xe8)])(_0x2896fa)&&!(0x0,lodash_1['isNil'])(_0x44ef30)){const _0x5d60c4=await(0x0,GetTicketWbot_1[_0x48f31c(0x81)])(_0x4437e9),_0x33110c=await(0x0,ShowUserService_1[_0x48f31c(0x81)])(_0x1bb3a9[_0x48f31c(0xac)]),_0x21a4d8=_0x48f31c(0xce)+_0x33110c[_0x48f31c(0xd5)]+_0x48f31c(0xe5)+_0x165c0b[_0x48f31c(0xc5)]+_0x48f31c(0xbc)+(0x0,moment_1[_0x48f31c(0x81)])()[_0x48f31c(0xe1)](_0x48f31c(0xa2))+_0x48f31c(0x8f);await(0x0,SendPresenceStatus_1['SendPresenceStatus'])(_0x5d60c4,_0x4437e9[_0x48f31c(0xbe)][_0x48f31c(0x78)]+'@'+(_0x4437e9['isGroup']?_0x48f31c(0x74):_0x48f31c(0x9b)));const _0x3e9e37=await _0x5d60c4[_0x48f31c(0x7a)](_0x4437e9[_0x48f31c(0xbe)][_0x48f31c(0x78)]+'@'+(_0x4437e9['isGroup']?_0x48f31c(0x74):_0x48f31c(0x9b)),{'text':_0x21a4d8});await(0x0,wbotMessageListener_1[_0x48f31c(0xc8)])(_0x3e9e37,_0x4437e9,_0x4437e9['contact']);}else{if(_0x2896fa!==_0x44ef30&&!(0x0,lodash_1[_0x48f31c(0xe8)])(_0x2896fa)&&!(0x0,lodash_1['isNil'])(_0x44ef30)&&_0x161c9f!==_0x32d78d&&!(0x0,lodash_1[_0x48f31c(0xe8)])(_0x161c9f)&&!(0x0,lodash_1[_0x48f31c(0xe8)])(_0x32d78d)){const _0x15494a=await(0x0,GetTicketWbot_1[_0x48f31c(0x81)])(_0x4437e9),_0x16ad84=await(0x0,ShowUserService_1[_0x48f31c(0x81)])(_0x1bb3a9[_0x48f31c(0xac)]),_0x3cbc08=await(0x0,ShowUserService_1[_0x48f31c(0x81)])(_0x2896fa),_0x4d40fa=_0x48f31c(0xc7)+_0x37748e?.[_0x48f31c(0xd5)]+'*\x20e\x20contará\x20com\x20a\x20presença\x20de\x20*'+_0x16ad84[_0x48f31c(0xd5)]+'*\x20transferido\x20por\x20'+_0x165c0b[_0x48f31c(0xc5)]+_0x48f31c(0xbc)+(0x0,moment_1[_0x48f31c(0x81)])()['format']('DD/MM/YYYY\x20HH:mm:ss')+_0x48f31c(0xb3);await(0x0,SendPresenceStatus_1[_0x48f31c(0x77)])(_0x15494a,_0x4437e9[_0x48f31c(0xbe)][_0x48f31c(0x78)]+'@'+(_0x4437e9[_0x48f31c(0xd3)]?'g.us':_0x48f31c(0x9b)));const _0x214e0b=await _0x15494a[_0x48f31c(0x7a)](_0x4437e9[_0x48f31c(0xbe)][_0x48f31c(0x78)]+'@'+(_0x4437e9[_0x48f31c(0xd3)]?_0x48f31c(0x74):'s.whatsapp.net'),{'text':_0x4d40fa});await(0x0,wbotMessageListener_1[_0x48f31c(0xc8)])(_0x214e0b,_0x4437e9,_0x4437e9['contact']);const _0x108164=await(0x0,ShowUserService_1[_0x48f31c(0x81)])(_0x44ef30),_0x5a4a34=_0x48f31c(0x89)+_0x3cbc08['name']+_0x48f31c(0xd9)+_0x16ad84[_0x48f31c(0xd5)]+'*,\x20em\x20'+(0x0,moment_1[_0x48f31c(0x81)])()[_0x48f31c(0xe1)](_0x48f31c(0xa2))+'\x0aaguarde,\x20já\x20vamos\x20te\x20atender!';await(0x0,SendPresenceStatus_1[_0x48f31c(0x77)])(_0x15494a,_0x4437e9[_0x48f31c(0xbe)][_0x48f31c(0x78)]+'@'+(_0x4437e9[_0x48f31c(0xd3)]?_0x48f31c(0x74):'s.whatsapp.net'));const _0x298f55=await _0x15494a['sendMessage'](_0x4437e9[_0x48f31c(0xbe)]['number']+'@'+(_0x4437e9['isGroup']?_0x48f31c(0x74):_0x48f31c(0x9b)),{'text':_0x5a4a34});await(0x0,wbotMessageListener_1[_0x48f31c(0xc8)])(_0x298f55,_0x4437e9,_0x4437e9[_0x48f31c(0xbe)]);}else{if(_0x2896fa!==undefined&&(0x0,lodash_1[_0x48f31c(0xe8)])(_0x44ef30)&&_0x161c9f!==_0x32d78d&&!(0x0,lodash_1['isNil'])(_0x32d78d)){const _0x385848=await(0x0,GetTicketWbot_1['default'])(_0x4437e9),_0x183c53=_0x48f31c(0xc7)+_0x37748e?.['name']+_0x48f31c(0xcf);await(0x0,SendPresenceStatus_1[_0x48f31c(0x77)])(_0x385848,_0x4437e9[_0x48f31c(0xbe)][_0x48f31c(0x78)]+'@'+(_0x4437e9['isGroup']?_0x48f31c(0x74):_0x48f31c(0x9b)));const _0x1ebe4a=await _0x385848['sendMessage'](_0x4437e9[_0x48f31c(0xbe)]['number']+'@'+(_0x4437e9[_0x48f31c(0xd3)]?_0x48f31c(0x74):_0x48f31c(0x9b)),{'text':_0x183c53});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x1ebe4a,_0x4437e9,_0x4437e9[_0x48f31c(0xbe)]);}}}}}var _0x53d097=_0x161c9f!==_0x32d78d;return _0x37748e&&(_0x53d097&&_0x37748e[_0x48f31c(0xe4)]&&(_0x39139c=_0x48f31c(0x93))),await _0x4437e9[_0x48f31c(0xa8)]({'amountUsedBotQueues':_0x1bb3a9[_0x48f31c(0x91)]||0x0,'status':_0x39139c,'unreadMessages':_0x1bb3a9[_0x48f31c(0x8a)]||0x0,'queueId':_0x32d78d,'userId':_0x44ef30,'whatsappId':_0x38bace,'chatbot':_0x28bab8,'queueOptionId':_0x578656}),await _0x4437e9[_0x48f31c(0x71)](),_0x37748e&&_0x53d097&&_0x37748e['newTicketOnTransfer']&&!_0x4437e9[_0x48f31c(0x75)]&&!_0x4437e9['useIntegration']&&(_0x1367bf['to'](_0x48f31c(0xd1)+_0x4437e9['companyId']+'-'+_0x4b086a)['to']('queue-'+_0x4437e9['queueId']+'-'+_0x4b086a)[_0x48f31c(0xc9)](_0x48f31c(0xd1)+_0x3de469+_0x48f31c(0xaa),{'action':_0x48f31c(0xd4),'ticketId':_0x4437e9['id']}),_0x1367bf['to'](_0x48f31c(0xd1)+_0x4437e9[_0x48f31c(0x73)]+'-'+_0x4437e9[_0x48f31c(0xe6)])['to'](_0x48f31c(0xd1)+_0x4437e9[_0x48f31c(0x73)]+_0x48f31c(0xd6))['to'](_0x48f31c(0xb1)+_0x4437e9[_0x48f31c(0xea)]+_0x48f31c(0xd6))['to'](_0x48f31c(0xb1)+_0x4437e9[_0x48f31c(0xea)]+'-'+_0x4437e9['status'])['to'](_0x390c04[_0x48f31c(0x9e)]())[_0x48f31c(0xc9)](_0x48f31c(0xd1)+_0x3de469+_0x48f31c(0xaa),{'action':_0x48f31c(0xa8),'ticket':_0x4437e9}),_0x4437e9=await Ticket_1[_0x48f31c(0x81)][_0x48f31c(0x8d)]({'companyId':_0x3de469,'contactId':_0x4437e9['contactId'],'userId':_0x44ef30,'queueId':_0x32d78d,'status':_0x48f31c(0xc4),'whatsappId':_0x4437e9[_0x48f31c(0xab)],'chatbot':_0x28bab8,'queueOptionId':_0x578656,'promptId':_0x814d1d,'useIntegration':_0x4e161c,'integrationId':_0x63b07d,'amountUsedBotQueues':0x0,'unreadMessages':0x0})),_0x39139c=_0x4437e9['status'],_0x39139c===_0x48f31c(0xc4)&&(_0x240dea[_0x48f31c(0xa8)]({'whatsappId':_0x38bace,'queuedAt':(0x0,moment_1[_0x48f31c(0x81)])()[_0x48f31c(0xb9)](),'startedAt':null,'userId':null}),_0x1367bf['to'](_0x48f31c(0xd1)+_0x3de469+'-mainchannel')[_0x48f31c(0xc9)](_0x48f31c(0xd1)+_0x3de469+'-ticket',{'action':_0x48f31c(0xc1),'ticketId':_0x4437e9?.['id']})),_0x39139c===_0x48f31c(0x82)&&(_0x240dea[_0x48f31c(0xa8)]({'startedAt':(0x0,moment_1[_0x48f31c(0x81)])()[_0x48f31c(0xb9)](),'ratingAt':null,'rated':![],'whatsappId':_0x38bace,'userId':_0x4437e9[_0x48f31c(0xac)]}),_0x1367bf['to']('company-'+_0x3de469+_0x48f31c(0xb6))[_0x48f31c(0xc9)](_0x48f31c(0xd1)+_0x3de469+_0x48f31c(0xaa),{'action':_0x48f31c(0xc1),'ticketId':_0x4437e9?.['id']}),_0x1367bf['to'](_0x48f31c(0xd1)+_0x3de469+'-mainchannel')[_0x48f31c(0xc9)](_0x48f31c(0xd1)+_0x3de469+_0x48f31c(0xaa),{'action':_0x48f31c(0xb8),'ticketId':_0x4437e9?.['id']})),await _0x240dea['save'](),(_0x4437e9[_0x48f31c(0xe6)]!==_0x4b086a||_0x4437e9[_0x48f31c(0xdc)]?.['id']!==_0x2896fa||_0x53d097)&&_0x1367bf['to'](_0x48f31c(0xd1)+_0x4437e9[_0x48f31c(0x73)]+'-'+_0x4b086a)['to'](_0x48f31c(0xb1)+_0x4437e9[_0x48f31c(0xea)]+'-'+_0x4b086a)['to'](_0x48f31c(0xd1)+_0x4437e9[_0x48f31c(0x73)]+_0x48f31c(0xd6))['to'](_0x48f31c(0xb1)+_0x4437e9[_0x48f31c(0xea)]+_0x48f31c(0xd6))['to'](_0x390c04['toString']())[_0x48f31c(0xc9)](_0x48f31c(0xd1)+_0x3de469+'-ticket',{'action':_0x48f31c(0xd4),'ticketId':_0x4437e9['id']}),_0x4437e9[_0x48f31c(0xe6)]!==_0x48f31c(0x93)&&_0x1367bf['to'](_0x48f31c(0xd1)+_0x4437e9[_0x48f31c(0x73)]+'-'+_0x4437e9['status'])['to']('company-'+_0x4437e9[_0x48f31c(0x73)]+'-notification')['to'](_0x48f31c(0xb1)+_0x4437e9[_0x48f31c(0xea)]+_0x48f31c(0xd6))['to'](_0x48f31c(0xb1)+_0x4437e9[_0x48f31c(0xea)]+'-'+_0x4437e9[_0x48f31c(0xe6)])['to'](_0x390c04[_0x48f31c(0x9e)]())[_0x48f31c(0xc9)](_0x48f31c(0xd1)+_0x3de469+_0x48f31c(0xaa),{'action':'update','ticket':_0x4437e9}),{'ticket':_0x4437e9,'oldStatus':_0x4b086a,'oldUserId':_0x2896fa};}catch(_0x4f7cef){console[_0x48f31c(0xb5)](_0x4f7cef),Sentry[_0x48f31c(0xe0)](_0x4f7cef);}};exports['default']=UpdateTicketService;const notifyUpdate=(_0x1cd786,_0x54bdc7,_0x16f087,_0x408ab2)=>{const _0x40d520=a530_0x53826f;_0x1cd786['to']('company-'+_0x54bdc7['companyId']+'-'+_0x54bdc7[_0x40d520(0xe6)])['to']('company-'+_0x54bdc7[_0x40d520(0x73)]+_0x40d520(0xd6))['to'](_0x16f087['toString']())['emit'](_0x40d520(0xd1)+_0x408ab2+'-ticket',{'action':_0x40d520(0xa8),'ticket':_0x54bdc7});};exports[a530_0x53826f(0xc3)]=notifyUpdate;