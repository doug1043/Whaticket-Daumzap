const a557_0x36946b=a557_0x128f;(function(_0x1e481d,_0x33e5ec){const _0x5d1f68=a557_0x128f,_0x40e50e=_0x1e481d();while(!![]){try{const _0x48ade7=parseInt(_0x5d1f68(0x1c7))/0x1+parseInt(_0x5d1f68(0x1d2))/0x2*(-parseInt(_0x5d1f68(0x1e8))/0x3)+parseInt(_0x5d1f68(0x1c2))/0x4*(parseInt(_0x5d1f68(0x1c0))/0x5)+-parseInt(_0x5d1f68(0x1cb))/0x6+parseInt(_0x5d1f68(0x1d3))/0x7*(parseInt(_0x5d1f68(0x1da))/0x8)+-parseInt(_0x5d1f68(0x1c3))/0x9+parseInt(_0x5d1f68(0x1ea))/0xa;if(_0x48ade7===_0x33e5ec)break;else _0x40e50e['push'](_0x40e50e['shift']());}catch(_0xfb9bb0){_0x40e50e['push'](_0x40e50e['shift']());}}}(a557_0x892b,0x99126));const a557_0x35c5bb=(function(){let _0x12cc3c=!![];return function(_0x989f77,_0x46f306){const _0x55484c=_0x12cc3c?function(){if(_0x46f306){const _0x4e7d3d=_0x46f306['apply'](_0x989f77,arguments);return _0x46f306=null,_0x4e7d3d;}}:function(){};return _0x12cc3c=![],_0x55484c;};}()),a557_0x4308cb=a557_0x35c5bb(this,function(){const _0x90ca76=a557_0x128f;return a557_0x4308cb[_0x90ca76(0x1df)]()[_0x90ca76(0x1e6)]('(((.+)+)+)+$')[_0x90ca76(0x1df)]()['constructor'](a557_0x4308cb)[_0x90ca76(0x1e6)](_0x90ca76(0x1b0));});a557_0x4308cb();'use strict';var __importDefault=this&&this[a557_0x36946b(0x1ee)]||function(_0x53b140){const _0x40f1c0=a557_0x36946b;return _0x53b140&&_0x53b140[_0x40f1c0(0x1db)]?_0x53b140:{'default':_0x53b140};};Object['defineProperty'](exports,a557_0x36946b(0x1db),{'value':!![]});function a557_0x892b(){const _0xa05db8=['contact','rated','verifyMessage','g.us','ratingAt','amountUsedBotQueues','removeFromList','getIO','(((.+)+)+)+$','emit','lodash','whatsappId','Error\x20updating\x20ticket','../../helpers/Mustache','disableBot','indexOf','profile','../../helpers/GetTicketWbot','number','-ticket','admin','company-','userId','whatsapp','610kmklDp','../WbotServices/VerifyHandlers','10636FBVSlF','234450WEMhqm','../WbotServices/SendWhatsAppMessage','pending','user-','571533dECoZX','useIntegration','Need\x20companyId\x20or\x20tokenData','-open','7225710hHUbkw','s.whatsapp.net','default','../../helpers/CheckContactOpenTickets','contactId','integrationId','moment','2bxQjMu','1561JejcEY','./FindOrCreateATicketTrakingService','queueOptionId','trim','../../libs/socket','isGroup','-mainchannel','27752srEnlO','__esModule','finishedAt','Por\x20favor\x20avalie\x20nosso\x20atendimento','queueId','toString','user','update','status','queue-','chatbot','channel','search','isNil','1389846FNDQtN','queuedAt','6510810dyzgse','../../helpers/CheckSettings','toDate','companyId','__importDefault','disabled','closed'];a557_0x892b=function(){return _0xa05db8;};return a557_0x892b();}const moment_1=__importDefault(require(a557_0x36946b(0x1d1))),lodash_1=require(a557_0x36946b(0x1b2)),CheckContactOpenTickets_1=__importDefault(require(a557_0x36946b(0x1ce))),SetTicketMessagesAsRead_1=__importDefault(require('../../helpers/SetTicketMessagesAsRead')),socket_1=require(a557_0x36946b(0x1d7)),ShowTicketService_1=__importDefault(require('./ShowTicketService')),ShowWhatsAppService_1=__importDefault(require('../WhatsappService/ShowWhatsAppService')),SendWhatsAppMessage_1=__importDefault(require(a557_0x36946b(0x1c4))),FindOrCreateATicketTrakingService_1=__importDefault(require(a557_0x36946b(0x1d4))),GetTicketWbot_1=__importDefault(require(a557_0x36946b(0x1b9))),VerifyHandlers_1=require(a557_0x36946b(0x1c1)),AppError_1=__importDefault(require('../../errors/AppError')),CheckSettings_1=require(a557_0x36946b(0x1eb)),Mustache_1=__importDefault(require(a557_0x36946b(0x1b5))),UpdateTicketService=async({ticketData:_0x5661d1,ticketId:_0x19efc2,tokenData:_0x760421,companyId:_0x176c27})=>{const _0x54c9b6=a557_0x36946b;try{if(!_0x176c27&&!_0x760421)throw new Error(_0x54c9b6(0x1c9));_0x760421&&(_0x176c27=_0x760421['companyId']);const {justClose:_0x252a0e}=_0x5661d1;let {status:_0x38f2e9}=_0x5661d1,{queueId:_0xc0ddbf,userId:_0x5a5adb}=_0x5661d1,_0x47a1d0=_0x5661d1[_0x54c9b6(0x1e4)]||![],_0x1a5a7e=_0x5661d1[_0x54c9b6(0x1d5)]||null,_0x51e09a=_0x5661d1[_0x54c9b6(0x1c8)]||![],_0xaeb507=_0x5661d1[_0x54c9b6(0x1d0)]||null;const _0xd9e498=(0x0,socket_1[_0x54c9b6(0x1af)])(),_0x444210=await(0x0,ShowTicketService_1[_0x54c9b6(0x1cd)])(_0x19efc2,_0x176c27),_0x5df341=await(0x0,ShowWhatsAppService_1[_0x54c9b6(0x1cd)])(_0x444210['whatsappId'],_0x176c27);if(_0x760421&&_0x444210[_0x54c9b6(0x1e2)]!==_0x54c9b6(0x1c5)){if(_0x760421[_0x54c9b6(0x1b8)]!==_0x54c9b6(0x1bc)&&_0x444210[_0x54c9b6(0x1be)]!==parseInt(_0x760421['id'],0xa))throw new AppError_1[(_0x54c9b6(0x1cd))]('Apenas\x20o\x20usuário\x20ativo\x20do\x20ticket\x20ou\x20o\x20Admin\x20podem\x20fazer\x20alterações\x20no\x20ticket');}const _0x37922a=await(0x0,FindOrCreateATicketTrakingService_1[_0x54c9b6(0x1cd)])({'ticketId':_0x19efc2,'companyId':_0x176c27,'whatsappId':_0x444210[_0x54c9b6(0x1b3)]});_0x444210[_0x54c9b6(0x1e5)]===_0x54c9b6(0x1bf)&&_0x38f2e9==='open'&&(0x0,SetTicketMessagesAsRead_1[_0x54c9b6(0x1cd)])(_0x444210);const _0x34a254=_0x444210[_0x54c9b6(0x1e2)],_0x1b4936=_0x444210[_0x54c9b6(0x1e0)]?.['id'],_0x103455=_0x444210[_0x54c9b6(0x1de)];_0x34a254===_0x54c9b6(0x1f0)&&(await(0x0,CheckContactOpenTickets_1['default'])(_0x444210[_0x54c9b6(0x1cf)],_0x444210['whatsappId']),_0x47a1d0=null,_0x1a5a7e=null);if(_0x38f2e9!==undefined&&[_0x54c9b6(0x1f0)]['indexOf'](_0x38f2e9)>-0x1){const {complationMessage:_0x325037,ratingMessage:_0x13d6c1}=await(0x0,ShowWhatsAppService_1[_0x54c9b6(0x1cd)])(_0x444210['whatsappId'],_0x176c27);if(!_0x444210[_0x54c9b6(0x1a8)][_0x54c9b6(0x1d8)]&&!_0x444210[_0x54c9b6(0x1a8)]['disableBot']&&_0x5df341['useRating']){if(_0x37922a[_0x54c9b6(0x1ac)]==null&&!_0x252a0e){const _0x4e53b9=_0x13d6c1?.[_0x54c9b6(0x1d6)]()||_0x54c9b6(0x1dd),_0x450ec5=_0x4e53b9+'\x0a\x0a*Digite\x20uma\x20nota\x20de\x201\x20a\x205*\x0a';return _0x444210[_0x54c9b6(0x1e5)]==='whatsapp'&&await(0x0,SendWhatsAppMessage_1[_0x54c9b6(0x1cd)])({'body':_0x450ec5,'ticket':_0x444210}),await _0x37922a[_0x54c9b6(0x1e1)]({'ratingAt':(0x0,moment_1['default'])()['toDate'](),'rated':![]}),_0xd9e498['to'](_0x54c9b6(0x1bd)+_0x444210['companyId']+_0x54c9b6(0x1ca))['to'](_0x54c9b6(0x1e3)+_0x444210['queueId']+_0x54c9b6(0x1ca))['to'](_0x19efc2[_0x54c9b6(0x1df)]())['emit'](_0x54c9b6(0x1bd)+_0x444210[_0x54c9b6(0x1ed)]+'-ticket',{'action':'delete','ticketId':_0x444210['id']}),{'ticket':_0x444210,'oldStatus':_0x34a254,'oldUserId':_0x1b4936};}_0x37922a['ratingAt']=(0x0,moment_1[_0x54c9b6(0x1cd)])()['toDate'](),_0x37922a[_0x54c9b6(0x1a9)]=![];}if(!_0x444210[_0x54c9b6(0x1a8)][_0x54c9b6(0x1d8)]&&!_0x444210[_0x54c9b6(0x1a8)][_0x54c9b6(0x1b6)]&&!_0x252a0e&&!(0x0,lodash_1[_0x54c9b6(0x1e7)])(_0x325037)&&_0x325037!==''){const _0x265092=(0x0,Mustache_1[_0x54c9b6(0x1cd)])(''+_0x325037,_0x444210);if(_0x444210[_0x54c9b6(0x1e5)]===_0x54c9b6(0x1bf)&&!_0x444210[_0x54c9b6(0x1d8)]){const _0x5e2f88=await(0x0,SendWhatsAppMessage_1[_0x54c9b6(0x1cd)])({'body':_0x265092,'ticket':_0x444210});await(0x0,VerifyHandlers_1[_0x54c9b6(0x1aa)])(_0x5e2f88,_0x444210,_0x444210[_0x54c9b6(0x1a8)]);}}_0x37922a[_0x54c9b6(0x1dc)]=(0x0,moment_1[_0x54c9b6(0x1cd)])()[_0x54c9b6(0x1ec)](),_0x37922a[_0x54c9b6(0x1b3)]=_0x444210['whatsappId'],_0x37922a['userId']=_0x444210['userId'],_0x51e09a=![],_0xaeb507=null;const _0x1fd147=await(0x0,CheckSettings_1['GetCompanySetting'])(_0x176c27,'keepUserAndQueue','enabled');_0x1fd147===_0x54c9b6(0x1ef)&&(_0xc0ddbf=null,_0x5a5adb=null);}_0xc0ddbf!==undefined&&_0xc0ddbf!==null&&(_0x37922a[_0x54c9b6(0x1e9)]=(0x0,moment_1[_0x54c9b6(0x1cd)])()[_0x54c9b6(0x1ec)]());if(_0x103455!==_0xc0ddbf&&!(0x0,lodash_1[_0x54c9b6(0x1e7)])(_0x103455)&&!(0x0,lodash_1[_0x54c9b6(0x1e7)])(_0xc0ddbf)){if(_0x444210[_0x54c9b6(0x1e5)]===_0x54c9b6(0x1bf)){const _0x3b2d6a=await(0x0,GetTicketWbot_1[_0x54c9b6(0x1cd)])(_0x444210),{transferMessage:_0x8492b7}=await(0x0,ShowWhatsAppService_1['default'])(_0x444210[_0x54c9b6(0x1b3)],_0x176c27);if(!_0x444210[_0x54c9b6(0x1d8)]){if(_0x8492b7?.[_0x54c9b6(0x1d6)]()){const _0x3f8162=await _0x3b2d6a['sendMessage'](_0x444210[_0x54c9b6(0x1a8)][_0x54c9b6(0x1ba)]+'@'+(_0x444210[_0x54c9b6(0x1d8)]?_0x54c9b6(0x1ab):_0x54c9b6(0x1cc)),{'text':''+_0x8492b7});await(0x0,VerifyHandlers_1[_0x54c9b6(0x1aa)])(_0x3f8162,_0x444210,_0x444210['contact']);}}}}await _0x444210[_0x54c9b6(0x1e1)]({'status':_0x38f2e9,'amountUsedBotQueues':_0x5661d1[_0x54c9b6(0x1ad)]||0x0,'queueId':_0xc0ddbf,'userId':_0x5a5adb,'whatsappId':_0x444210[_0x54c9b6(0x1b3)],'chatbot':_0x47a1d0,'queueOptionId':_0x1a5a7e,'useIntegration':_0x51e09a,'integrationId':_0xaeb507}),await _0x444210['reload'](),_0x38f2e9=_0x444210['status'];_0x38f2e9!==undefined&&[_0x54c9b6(0x1c5)][_0x54c9b6(0x1b7)](_0x38f2e9)>-0x1&&(_0x37922a[_0x54c9b6(0x1e1)]({'whatsappId':_0x444210['whatsappId'],'queuedAt':(0x0,moment_1['default'])()['toDate'](),'startedAt':null,'userId':null}),_0xd9e498['to'](_0x54c9b6(0x1bd)+_0x176c27+'-mainchannel')['emit'](_0x54c9b6(0x1bd)+_0x176c27+_0x54c9b6(0x1bb),{'action':_0x54c9b6(0x1ae),'ticketId':_0x444210?.['id']}));_0x38f2e9!==undefined&&['open'][_0x54c9b6(0x1b7)](_0x38f2e9)>-0x1&&(_0x37922a[_0x54c9b6(0x1e1)]({'startedAt':(0x0,moment_1[_0x54c9b6(0x1cd)])()['toDate'](),'ratingAt':null,'rated':![],'whatsappId':_0x444210['whatsappId'],'userId':_0x444210[_0x54c9b6(0x1be)]}),_0xd9e498['to']('company-'+_0x176c27+_0x54c9b6(0x1d9))[_0x54c9b6(0x1b1)](_0x54c9b6(0x1bd)+_0x176c27+_0x54c9b6(0x1bb),{'action':_0x54c9b6(0x1ae),'ticketId':_0x444210?.['id']}),_0xd9e498['to']('company-'+_0x176c27+_0x54c9b6(0x1d9))['emit'](_0x54c9b6(0x1bd)+_0x176c27+_0x54c9b6(0x1bb),{'action':'updateUnread','ticketId':_0x444210?.['id']}));await _0x37922a['save']();if(_0x252a0e&&_0x38f2e9===_0x54c9b6(0x1f0))_0xd9e498['to'](_0x54c9b6(0x1bd)+_0x176c27+'-mainchannel')[_0x54c9b6(0x1b1)](_0x54c9b6(0x1bd)+_0x176c27+_0x54c9b6(0x1bb),{'action':_0x54c9b6(0x1ae),'ticketId':_0x444210?.['id']});else _0x444210['status']===_0x54c9b6(0x1f0)&&_0x444210[_0x54c9b6(0x1e2)]!==_0x34a254&&_0xd9e498['to'](_0x54c9b6(0x1bd)+_0x176c27+'-'+_0x34a254)['to']('queue-'+_0x444210['queueId']+'-'+_0x34a254)['to'](_0x54c9b6(0x1c6)+_0x1b4936)[_0x54c9b6(0x1b1)]('company-'+_0x176c27+_0x54c9b6(0x1bb),{'action':'removeFromList','ticketId':_0x444210['id']});return _0xd9e498['to'](_0x54c9b6(0x1bd)+_0x176c27+'-'+_0x444210[_0x54c9b6(0x1e2)])['to'](_0x54c9b6(0x1bd)+_0x176c27+'-notification')['to']('queue-'+_0x444210[_0x54c9b6(0x1de)]+'-'+_0x444210[_0x54c9b6(0x1e2)])['to']('queue-'+_0x444210[_0x54c9b6(0x1de)]+'-notification')['to'](_0x19efc2[_0x54c9b6(0x1df)]())['to'](_0x54c9b6(0x1c6)+_0x444210?.[_0x54c9b6(0x1be)])['to'](_0x54c9b6(0x1c6)+_0x1b4936)['emit'](_0x54c9b6(0x1bd)+_0x176c27+_0x54c9b6(0x1bb),{'action':_0x54c9b6(0x1e1),'ticket':_0x444210}),{'ticket':_0x444210,'oldStatus':_0x34a254,'oldUserId':_0x1b4936};}catch(_0x6d1d5d){if(_0x6d1d5d instanceof AppError_1['default'])throw _0x6d1d5d;throw new AppError_1[(_0x54c9b6(0x1cd))](_0x54c9b6(0x1b4),0x1f4,_0x6d1d5d);}};function a557_0x128f(_0x1c307f,_0x6316ed){const _0x11aa07=a557_0x892b();return a557_0x128f=function(_0x4308cb,_0x35c5bb){_0x4308cb=_0x4308cb-0x1a8;let _0x892b44=_0x11aa07[_0x4308cb];return _0x892b44;},a557_0x128f(_0x1c307f,_0x6316ed);}exports[a557_0x36946b(0x1cd)]=UpdateTicketService;