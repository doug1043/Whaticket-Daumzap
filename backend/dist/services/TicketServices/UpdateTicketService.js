function a529_0x4cfb(_0x47e058,_0x273fe0){const _0x6646f4=a529_0x46af();return a529_0x4cfb=function(_0xb35614,_0x27a56c){_0xb35614=_0xb35614-0x1e5;let _0x46af5d=_0x6646f4[_0xb35614];return _0x46af5d;},a529_0x4cfb(_0x47e058,_0x273fe0);}const a529_0xe2d52b=a529_0x4cfb;(function(_0x106ced,_0x41e486){const _0x3896ae=a529_0x4cfb,_0x3c2eb9=_0x106ced();while(!![]){try{const _0x4296d4=parseInt(_0x3896ae(0x248))/0x1*(parseInt(_0x3896ae(0x1e8))/0x2)+parseInt(_0x3896ae(0x226))/0x3+parseInt(_0x3896ae(0x242))/0x4+parseInt(_0x3896ae(0x20a))/0x5*(-parseInt(_0x3896ae(0x20e))/0x6)+parseInt(_0x3896ae(0x20c))/0x7*(-parseInt(_0x3896ae(0x1ef))/0x8)+-parseInt(_0x3896ae(0x1eb))/0x9*(parseInt(_0x3896ae(0x1f4))/0xa)+-parseInt(_0x3896ae(0x1f7))/0xb*(-parseInt(_0x3896ae(0x210))/0xc);if(_0x4296d4===_0x41e486)break;else _0x3c2eb9['push'](_0x3c2eb9['shift']());}catch(_0x3f9ebb){_0x3c2eb9['push'](_0x3c2eb9['shift']());}}}(a529_0x46af,0x78996));const a529_0x27a56c=(function(){let _0x3276e2=!![];return function(_0x1997fd,_0x3beb89){const _0x25a60b=_0x3276e2?function(){if(_0x3beb89){const _0x2afba4=_0x3beb89['apply'](_0x1997fd,arguments);return _0x3beb89=null,_0x2afba4;}}:function(){};return _0x3276e2=![],_0x25a60b;};}()),a529_0xb35614=a529_0x27a56c(this,function(){const _0x2fcc24=a529_0x4cfb;return a529_0xb35614[_0x2fcc24(0x1fe)]()['search'](_0x2fcc24(0x204))['toString']()[_0x2fcc24(0x207)](a529_0xb35614)[_0x2fcc24(0x1fa)](_0x2fcc24(0x204));});function a529_0x46af(){const _0x173325=['Digite\x20de\x201\x20à\x205\x20para\x20qualificar\x20nosso\x20atendimento:\x0a','find','filter','10zOfUox','getTime','toDate','88JKvReW','*5*\x20-\x20_Muito\x20Satisfeito_\x0a','integrationId','search','*\x20por\x20','enabled','g.us','toString','hasOwnProperty','getIO','*3*\x20-\x20_Moderadamente\x20Satisfeito_\x0a','findByPk','status','(((.+)+)+)+$','disableBot','length','constructor','*\x20e\x20contará\x20com\x20a\x20presença\x20de\x20*','*2*\x20-\x20_Insatisfeito_\x0a','1873990iMvZnv','../../helpers/SendPresenceStatus','34433nZDfuS','create','12cIDmiN','emit','284892UHGhUH','writable','*Mensagem\x20automática*:\x0aO\x20atendente\x20anterior\x20*','trace','*Mensagem\x20automática*:\x0aFoi\x20transferido\x20para\x20o\x20atendente\x20*','promptId','unreadMessages','-open','Apenas\x20o\x20usuário\x20ativo\x20do\x20ticket\x20ou\x20o\x20Admin\x20podem\x20fazer\x20alterações\x20no\x20ticket','delete','get','isNil','name','./ShowTicketService','../WbotServices/wbotMessageListener','queueId','finishedAt','defineProperty','contactId','findOne','../../models/Ticket','configurable','2346483vuQhGE','contact','queue-','ticketId','*\x0aaguarde,\x20já\x20vamos\x20te\x20atender!','SendPresenceStatus','notifyUpdate','whatsappId','rated','open','s.whatsapp.net','-notification','updateUnread','dest','DD/MM/YYYY\x20HH:mm:ss','isGroup','company-','username','call','pending','amountUsedBotQueues','__esModule','userRating','newTicketOnTransfer','captureException','-ticket','sendMsgTransfTicket','getOwnPropertyDescriptor','2259596lyEOZO','sendMessage','closed','value','queuedAt','-mainchannel','251csVCEW','profile','admin','__setModuleDefault','companyId','moment','number','push','*Mensagem\x20automática*:\x0aVocê\x20foi\x20transferido\x20para\x20o\x20departamento\x20*','../WhatsappService/ShowWhatsAppService','ratingAt','time','\x0aAguarde,\x20já\x20vamos\x20te\x20atender!','../../models/Setting','@sentry/node','__importStar','user','../../errors/AppError','update','userId','../UserServices/ShowUserService','verifyMessage','Need\x20companyId\x20or\x20tokenData','lodash','4876NtfeRs','chatbot','format','5890383tliGBz','../WbotServices/SendWhatsAppMessage','*\x20transferido\x20por\x20','default','408nWANPd','removeFromList'];a529_0x46af=function(){return _0x173325;};return a529_0x46af();}a529_0xb35614();'use strict';var __createBinding=this&&this['__createBinding']||(Object[a529_0xe2d52b(0x20d)]?function(_0x4fbdcc,_0xb24798,_0x5635e2,_0x514832){const _0x321424=a529_0xe2d52b;if(_0x514832===undefined)_0x514832=_0x5635e2;var _0x207e35=Object[_0x321424(0x241)](_0xb24798,_0x5635e2);(!_0x207e35||(_0x321424(0x21a)in _0x207e35?!_0xb24798[_0x321424(0x23b)]:_0x207e35[_0x321424(0x211)]||_0x207e35[_0x321424(0x225)]))&&(_0x207e35={'enumerable':!![],'get':function(){return _0xb24798[_0x5635e2];}}),Object[_0x321424(0x221)](_0x4fbdcc,_0x514832,_0x207e35);}:function(_0x48aecd,_0x1184a2,_0x1a7745,_0x53ffb8){if(_0x53ffb8===undefined)_0x53ffb8=_0x1a7745;_0x48aecd[_0x53ffb8]=_0x1184a2[_0x1a7745];}),__setModuleDefault=this&&this[a529_0xe2d52b(0x24b)]||(Object['create']?function(_0xc04dd9,_0x11a2fb){const _0x4213dc=a529_0xe2d52b;Object[_0x4213dc(0x221)](_0xc04dd9,_0x4213dc(0x1ee),{'enumerable':!![],'value':_0x11a2fb});}:function(_0xec9658,_0x18f228){const _0x3f1b89=a529_0xe2d52b;_0xec9658[_0x3f1b89(0x1ee)]=_0x18f228;}),__importStar=this&&this[a529_0xe2d52b(0x257)]||function(_0x5d8240){const _0x561529=a529_0xe2d52b;if(_0x5d8240&&_0x5d8240[_0x561529(0x23b)])return _0x5d8240;var _0x1c63a0={};if(_0x5d8240!=null){for(var _0x2435e8 in _0x5d8240)if(_0x2435e8!==_0x561529(0x1ee)&&Object['prototype'][_0x561529(0x1ff)][_0x561529(0x238)](_0x5d8240,_0x2435e8))__createBinding(_0x1c63a0,_0x5d8240,_0x2435e8);}return __setModuleDefault(_0x1c63a0,_0x5d8240),_0x1c63a0;},__importDefault=this&&this['__importDefault']||function(_0x38efaf){const _0x5da913=a529_0xe2d52b;return _0x38efaf&&_0x38efaf[_0x5da913(0x23b)]?_0x38efaf:{'default':_0x38efaf};};Object[a529_0xe2d52b(0x221)](exports,a529_0xe2d52b(0x23b),{'value':!![]}),exports[a529_0xe2d52b(0x22c)]=void 0x0;const moment_1=__importDefault(require(a529_0xe2d52b(0x24d))),Sentry=__importStar(require(a529_0xe2d52b(0x256))),CheckContactOpenTickets_1=__importDefault(require('../../helpers/CheckContactOpenTickets')),SetTicketMessagesAsRead_1=__importDefault(require('../../helpers/SetTicketMessagesAsRead')),socket_1=require('../../libs/socket'),Ticket_1=__importDefault(require(a529_0xe2d52b(0x224))),Setting_1=__importDefault(require(a529_0xe2d52b(0x255))),Queue_1=__importDefault(require('../../models/Queue')),ShowTicketService_1=__importDefault(require(a529_0xe2d52b(0x21d))),ShowWhatsAppService_1=__importDefault(require(a529_0xe2d52b(0x251))),SendWhatsAppMessage_1=__importDefault(require(a529_0xe2d52b(0x1ec))),FindOrCreateATicketTrakingService_1=__importDefault(require('./FindOrCreateATicketTrakingService')),GetTicketWbot_1=__importDefault(require('../../helpers/GetTicketWbot')),wbotMessageListener_1=require(a529_0xe2d52b(0x21e)),ListSettingsServiceOne_1=__importDefault(require('../SettingServices/ListSettingsServiceOne')),ShowUserService_1=__importDefault(require(a529_0xe2d52b(0x25c))),lodash_1=require(a529_0xe2d52b(0x1e7)),AppError_1=__importDefault(require(a529_0xe2d52b(0x259))),SendPresenceStatus_1=require(a529_0xe2d52b(0x20b)),wbot_1=require('../../libs/wbot');let completionMessageControl=[];const UpdateTicketService=async({ticketData:_0x2ccbc4,ticketId:_0x2072f8,tokenData:_0x1e6428,companyId:_0x43afcd})=>{const _0x2fa824=a529_0xe2d52b;try{if(!_0x43afcd&&!_0x1e6428)throw new Error(_0x2fa824(0x1e6));_0x1e6428&&(_0x43afcd=_0x1e6428[_0x2fa824(0x24c)]);let {status:_0x43f978}=_0x2ccbc4,{queueId:_0x5e3671,userId:_0x48f8b1,whatsappId:_0x28def4,sendFarewellMessage:_0x1f3351}=_0x2ccbc4;_0x1f3351==null&&(_0x1f3351=!![]);let _0x2bbfca=_0x2ccbc4['chatbot']||![],_0x3e155c=_0x2ccbc4['queueOptionId']||null,_0x38a01c=_0x2ccbc4[_0x2fa824(0x215)]||null,_0x56e81e=_0x2ccbc4['useIntegration']||![],_0x20fb96=_0x2ccbc4[_0x2fa824(0x1f9)]||null;const _0x419148=(0x0,socket_1[_0x2fa824(0x200)])(),_0x4d94fe=_0x2fa824(0x23c),_0x3f2a1b=await Setting_1[_0x2fa824(0x1ee)][_0x2fa824(0x223)]({'where':{'companyId':_0x43afcd,'key':_0x4d94fe}});let _0x5e22db=await(0x0,ShowTicketService_1[_0x2fa824(0x1ee)])(_0x2072f8,_0x43afcd);if(_0x1e6428&&_0x5e22db[_0x2fa824(0x203)]!==_0x2fa824(0x239)){if(_0x1e6428[_0x2fa824(0x249)]!==_0x2fa824(0x24a)&&_0x5e22db[_0x2fa824(0x25b)]!==parseInt(_0x1e6428['id'],0xa))throw new AppError_1[(_0x2fa824(0x1ee))](_0x2fa824(0x218));}const _0x507611=await(0x0,FindOrCreateATicketTrakingService_1[_0x2fa824(0x1ee)])({'ticketId':_0x2072f8,'companyId':_0x43afcd,'whatsappId':_0x5e22db[_0x2fa824(0x22d)]});(0x0,lodash_1[_0x2fa824(0x21b)])(_0x28def4)&&(_0x28def4=_0x5e22db['whatsappId']['toString']());(_0x43f978==='closed'||_0x43f978===_0x2fa824(0x22f))&&await(0x0,SetTicketMessagesAsRead_1[_0x2fa824(0x1ee)])(_0x5e22db);const _0xcb480=_0x5e22db[_0x2fa824(0x203)],_0xc81c4c=_0x5e22db['user']?.['id'],_0x4e0757=_0x5e22db[_0x2fa824(0x21f)];(_0xcb480==='closed'||_0x28def4!==undefined&&Number(_0x28def4)!==_0x5e22db[_0x2fa824(0x22d)])&&(await(0x0,CheckContactOpenTickets_1['default'])(_0x5e22db[_0x2fa824(0x227)]['id'],_0x28def4),_0x2bbfca=null,_0x3e155c=null);if(_0x43f978===_0x2fa824(0x244)){const {complationMessage:_0x175b50,ratingMessage:_0x494150}=await(0x0,ShowWhatsAppService_1[_0x2fa824(0x1ee)])(_0x5e22db[_0x2fa824(0x22d)],_0x43afcd);if(!_0x5e22db['contact'][_0x2fa824(0x205)]&&_0x3f2a1b?.[_0x2fa824(0x245)]===_0x2fa824(0x1fc)&&_0x1f3351&&!_0x5e22db[_0x2fa824(0x235)]){if(_0x507611[_0x2fa824(0x252)]==null&&!_0x5e22db['isGroup']){const _0x24c63a=_0x494150||'';let _0xce764b='‎'+_0x24c63a+'\x0a\x0a';return _0xce764b+=_0x2fa824(0x1f1)+'*1*\x20-\x20_Muito\x20Insatisfeito_\x0a'+_0x2fa824(0x209)+_0x2fa824(0x201)+'*4*\x20-\x20_Satisfeito_\x0a'+_0x2fa824(0x1f8),await(0x0,SendPresenceStatus_1[_0x2fa824(0x22b)])((0x0,wbot_1['getWbot'])(_0x5e22db['whatsappId']),_0x5e22db[_0x2fa824(0x227)][_0x2fa824(0x24e)]+'@'+(_0x5e22db[_0x2fa824(0x235)]?'g.us':_0x2fa824(0x230))),await(0x0,SendWhatsAppMessage_1[_0x2fa824(0x1ee)])({'body':_0xce764b,'ticket':_0x5e22db}),await _0x507611[_0x2fa824(0x25a)]({'rated':![],'ratingAt':(0x0,moment_1[_0x2fa824(0x1ee)])()[_0x2fa824(0x1f6)]()}),await _0x5e22db[_0x2fa824(0x25a)]({'amountUsedBotQueues':_0x2ccbc4[_0x2fa824(0x23a)]||0x0,'status':_0x43f978,'unreadMessages':_0x2ccbc4['unreadMessages']||0x0,'queueId':_0x5e3671,'userId':_0x48f8b1,'whatsappId':_0x28def4,'chatbot':_0x2bbfca,'queueOptionId':_0x3e155c}),_0x419148['to'](_0x2fa824(0x236)+_0x5e22db['companyId']+_0x2fa824(0x217))['to'](_0x2072f8[_0x2fa824(0x1fe)]())[_0x2fa824(0x20f)]('company-'+_0x5e22db['companyId']+_0x2fa824(0x23f),{'action':'delete','ticketId':_0x5e22db['id']}),{'ticket':_0x5e22db,'oldStatus':_0xcb480,'oldUserId':_0xc81c4c};}_0x507611[_0x2fa824(0x252)]=(0x0,moment_1[_0x2fa824(0x1ee)])()[_0x2fa824(0x1f6)](),_0x507611[_0x2fa824(0x22e)]=![];}if(completionMessageControl[_0x2fa824(0x206)]>=0x9c4)completionMessageControl=[];if(!(0x0,lodash_1['isNil'])(_0x175b50)&&_0x175b50!==''&&_0x1f3351&&!_0x5e22db[_0x2fa824(0x235)]){let _0x59a0fc=completionMessageControl[_0x2fa824(0x1f2)](_0x305789=>_0x305789['ticketId']===_0x5e22db['id']||_0x305789[_0x2fa824(0x233)]===_0x5e22db[_0x2fa824(0x227)][_0x2fa824(0x24e)]);if(!_0x59a0fc||_0x59a0fc&&_0x59a0fc[_0x2fa824(0x253)]+0x3e8*0x3c*0x1e<new Date()[_0x2fa824(0x1f5)]()){_0x59a0fc&&(completionMessageControl=completionMessageControl[_0x2fa824(0x1f3)](_0x4602fb=>_0x4602fb[_0x2fa824(0x229)]!==_0x5e22db['id']),_0x59a0fc=null);if(!_0x5e22db['contact'][_0x2fa824(0x205)]&&!(0x0,lodash_1['isNil'])(_0x175b50)&&_0x175b50!==''){const _0x165782='‎'+_0x175b50;await(0x0,SendPresenceStatus_1['SendPresenceStatus'])((0x0,wbot_1['getWbot'])(_0x5e22db['whatsappId']),_0x5e22db[_0x2fa824(0x227)]['number']+'@'+(_0x5e22db['isGroup']?_0x2fa824(0x1fd):_0x2fa824(0x230))),await(0x0,SendWhatsAppMessage_1[_0x2fa824(0x1ee)])({'body':_0x165782,'ticket':_0x5e22db});}}!_0x59a0fc&&completionMessageControl[_0x2fa824(0x24f)]({'ticketId':_0x5e22db['id'],'dest':_0x5e22db[_0x2fa824(0x227)][_0x2fa824(0x24e)],'time':new Date()[_0x2fa824(0x1f5)]()});}await _0x5e22db[_0x2fa824(0x25a)]({'promptId':null,'integrationId':null,'useIntegration':![],'typebotStatus':![],'typebotSessionId':null}),_0x507611[_0x2fa824(0x220)]=(0x0,moment_1[_0x2fa824(0x1ee)])()[_0x2fa824(0x1f6)](),_0x507611[_0x2fa824(0x22d)]=_0x5e22db[_0x2fa824(0x22d)],_0x507611[_0x2fa824(0x25b)]=_0x5e22db['userId'];}_0x5e3671!==undefined&&_0x5e3671!==null&&(_0x507611[_0x2fa824(0x246)]=(0x0,moment_1[_0x2fa824(0x1ee)])()[_0x2fa824(0x1f6)]());const _0x5c61b9=await(0x0,ListSettingsServiceOne_1['default'])({'companyId':_0x43afcd,'key':_0x2fa824(0x240)}),_0x3906da=await Queue_1[_0x2fa824(0x1ee)][_0x2fa824(0x202)](_0x5e3671);if(_0x5c61b9?.[_0x2fa824(0x245)]===_0x2fa824(0x1fc)){if(_0x4e0757!==_0x5e3671&&_0xc81c4c===_0x48f8b1&&!(0x0,lodash_1[_0x2fa824(0x21b)])(_0x4e0757)&&!(0x0,lodash_1[_0x2fa824(0x21b)])(_0x5e3671)){const _0xeb44a2=await(0x0,GetTicketWbot_1[_0x2fa824(0x1ee)])(_0x5e22db),_0x4f0f6e=_0x2fa824(0x250)+_0x3906da?.[_0x2fa824(0x21c)]+_0x2fa824(0x22a);await(0x0,SendPresenceStatus_1[_0x2fa824(0x22b)])(_0xeb44a2,_0x5e22db[_0x2fa824(0x227)][_0x2fa824(0x24e)]+'@'+(_0x5e22db['isGroup']?_0x2fa824(0x1fd):_0x2fa824(0x230)));const _0x53de56=await _0xeb44a2[_0x2fa824(0x243)](_0x5e22db[_0x2fa824(0x227)][_0x2fa824(0x24e)]+'@'+(_0x5e22db[_0x2fa824(0x235)]?_0x2fa824(0x1fd):_0x2fa824(0x230)),{'text':_0x4f0f6e});await(0x0,wbotMessageListener_1[_0x2fa824(0x1e5)])(_0x53de56,_0x5e22db,_0x5e22db[_0x2fa824(0x227)]);}else{if(_0xc81c4c!==_0x48f8b1&&_0x4e0757===_0x5e3671&&!(0x0,lodash_1['isNil'])(_0xc81c4c)&&!(0x0,lodash_1['isNil'])(_0x48f8b1)){const _0x2c94d3=await(0x0,GetTicketWbot_1[_0x2fa824(0x1ee)])(_0x5e22db),_0x50beef=await(0x0,ShowUserService_1[_0x2fa824(0x1ee)])(_0x2ccbc4[_0x2fa824(0x25b)]),_0x59c5a5=_0x2fa824(0x214)+_0x50beef[_0x2fa824(0x21c)]+_0x2fa824(0x1fb)+_0x1e6428[_0x2fa824(0x237)]+'\x20em\x20'+(0x0,moment_1['default'])()[_0x2fa824(0x1ea)](_0x2fa824(0x234))+_0x2fa824(0x254);await(0x0,SendPresenceStatus_1['SendPresenceStatus'])(_0x2c94d3,_0x5e22db[_0x2fa824(0x227)][_0x2fa824(0x24e)]+'@'+(_0x5e22db[_0x2fa824(0x235)]?'g.us':_0x2fa824(0x230)));const _0x75b4d6=await _0x2c94d3[_0x2fa824(0x243)](_0x5e22db[_0x2fa824(0x227)][_0x2fa824(0x24e)]+'@'+(_0x5e22db[_0x2fa824(0x235)]?_0x2fa824(0x1fd):_0x2fa824(0x230)),{'text':_0x59c5a5});await(0x0,wbotMessageListener_1['verifyMessage'])(_0x75b4d6,_0x5e22db,_0x5e22db[_0x2fa824(0x227)]);}else{if(_0xc81c4c!==_0x48f8b1&&!(0x0,lodash_1[_0x2fa824(0x21b)])(_0xc81c4c)&&!(0x0,lodash_1[_0x2fa824(0x21b)])(_0x48f8b1)&&_0x4e0757!==_0x5e3671&&!(0x0,lodash_1['isNil'])(_0x4e0757)&&!(0x0,lodash_1[_0x2fa824(0x21b)])(_0x5e3671)){const _0x55ac0f=await(0x0,GetTicketWbot_1[_0x2fa824(0x1ee)])(_0x5e22db),_0x3aa0de=await(0x0,ShowUserService_1[_0x2fa824(0x1ee)])(_0x2ccbc4[_0x2fa824(0x25b)]),_0x40e0a1=await(0x0,ShowUserService_1[_0x2fa824(0x1ee)])(_0xc81c4c),_0xebc62a='*Mensagem\x20automática*:\x0aVocê\x20foi\x20transferido\x20para\x20o\x20departamento\x20*'+_0x3906da?.[_0x2fa824(0x21c)]+_0x2fa824(0x208)+_0x3aa0de[_0x2fa824(0x21c)]+_0x2fa824(0x1ed)+_0x1e6428[_0x2fa824(0x237)]+'\x20em\x20'+(0x0,moment_1[_0x2fa824(0x1ee)])()['format']('DD/MM/YYYY\x20HH:mm:ss')+'\x0aaguarde,\x20já\x20vamos\x20te\x20atender!';await(0x0,SendPresenceStatus_1['SendPresenceStatus'])(_0x55ac0f,_0x5e22db[_0x2fa824(0x227)][_0x2fa824(0x24e)]+'@'+(_0x5e22db[_0x2fa824(0x235)]?_0x2fa824(0x1fd):'s.whatsapp.net'));const _0x116965=await _0x55ac0f[_0x2fa824(0x243)](_0x5e22db['contact'][_0x2fa824(0x24e)]+'@'+(_0x5e22db[_0x2fa824(0x235)]?'g.us':_0x2fa824(0x230)),{'text':_0xebc62a});await(0x0,wbotMessageListener_1[_0x2fa824(0x1e5)])(_0x116965,_0x5e22db,_0x5e22db[_0x2fa824(0x227)]);const _0x1beb30=await(0x0,ShowUserService_1[_0x2fa824(0x1ee)])(_0x48f8b1),_0x478c71=_0x2fa824(0x212)+_0x40e0a1[_0x2fa824(0x21c)]+'*\x20transferiu\x20o\x20ticket\x20para\x20você,\x20*'+_0x3aa0de[_0x2fa824(0x21c)]+'*,\x20em\x20'+(0x0,moment_1['default'])()[_0x2fa824(0x1ea)](_0x2fa824(0x234))+'\x0aaguarde,\x20já\x20vamos\x20te\x20atender!';await(0x0,SendPresenceStatus_1[_0x2fa824(0x22b)])(_0x55ac0f,_0x5e22db['contact'][_0x2fa824(0x24e)]+'@'+(_0x5e22db[_0x2fa824(0x235)]?_0x2fa824(0x1fd):_0x2fa824(0x230)));const _0x1bb4e7=await _0x55ac0f[_0x2fa824(0x243)](_0x5e22db[_0x2fa824(0x227)][_0x2fa824(0x24e)]+'@'+(_0x5e22db[_0x2fa824(0x235)]?'g.us':_0x2fa824(0x230)),{'text':_0x478c71});await(0x0,wbotMessageListener_1[_0x2fa824(0x1e5)])(_0x1bb4e7,_0x5e22db,_0x5e22db[_0x2fa824(0x227)]);}else{if(_0xc81c4c!==undefined&&(0x0,lodash_1[_0x2fa824(0x21b)])(_0x48f8b1)&&_0x4e0757!==_0x5e3671&&!(0x0,lodash_1[_0x2fa824(0x21b)])(_0x5e3671)){const _0x4c08b7=await(0x0,GetTicketWbot_1[_0x2fa824(0x1ee)])(_0x5e22db),_0x52a1f9=_0x2fa824(0x250)+_0x3906da?.[_0x2fa824(0x21c)]+_0x2fa824(0x22a);await(0x0,SendPresenceStatus_1[_0x2fa824(0x22b)])(_0x4c08b7,_0x5e22db['contact'][_0x2fa824(0x24e)]+'@'+(_0x5e22db[_0x2fa824(0x235)]?_0x2fa824(0x1fd):'s.whatsapp.net'));const _0x28ba62=await _0x4c08b7[_0x2fa824(0x243)](_0x5e22db[_0x2fa824(0x227)][_0x2fa824(0x24e)]+'@'+(_0x5e22db[_0x2fa824(0x235)]?_0x2fa824(0x1fd):_0x2fa824(0x230)),{'text':_0x52a1f9});await(0x0,wbotMessageListener_1[_0x2fa824(0x1e5)])(_0x28ba62,_0x5e22db,_0x5e22db[_0x2fa824(0x227)]);}}}}}var _0x53b90b=_0x4e0757!==_0x5e3671;return _0x3906da&&(_0x53b90b&&_0x3906da[_0x2fa824(0x23d)]&&(_0x43f978=_0x2fa824(0x244))),await _0x5e22db[_0x2fa824(0x25a)]({'amountUsedBotQueues':_0x2ccbc4['amountUsedBotQueues']||0x0,'status':_0x43f978,'unreadMessages':_0x2ccbc4[_0x2fa824(0x216)]||0x0,'queueId':_0x5e3671,'userId':_0x48f8b1,'whatsappId':_0x28def4,'chatbot':_0x2bbfca,'queueOptionId':_0x3e155c}),await _0x5e22db['reload'](),_0x3906da&&_0x53b90b&&_0x3906da['newTicketOnTransfer']&&!_0x5e22db[_0x2fa824(0x1e9)]&&!_0x5e22db['useIntegration']&&(_0x419148['to'](_0x2fa824(0x236)+_0x5e22db[_0x2fa824(0x24c)]+'-'+_0xcb480)['to'](_0x2fa824(0x228)+_0x5e22db['queueId']+'-'+_0xcb480)[_0x2fa824(0x20f)]('company-'+_0x43afcd+_0x2fa824(0x23f),{'action':_0x2fa824(0x219),'ticketId':_0x5e22db['id']}),_0x419148['to'](_0x2fa824(0x236)+_0x5e22db[_0x2fa824(0x24c)]+'-'+_0x5e22db['status'])['to'](_0x2fa824(0x236)+_0x5e22db['companyId']+_0x2fa824(0x231))['to'](_0x2fa824(0x228)+_0x5e22db[_0x2fa824(0x21f)]+_0x2fa824(0x231))['to']('queue-'+_0x5e22db[_0x2fa824(0x21f)]+'-'+_0x5e22db[_0x2fa824(0x203)])['to'](_0x2072f8[_0x2fa824(0x1fe)]())['emit'](_0x2fa824(0x236)+_0x43afcd+_0x2fa824(0x23f),{'action':_0x2fa824(0x25a),'ticket':_0x5e22db}),_0x5e22db=await Ticket_1[_0x2fa824(0x1ee)]['create']({'companyId':_0x43afcd,'contactId':_0x5e22db[_0x2fa824(0x222)],'userId':_0x48f8b1,'queueId':_0x5e3671,'status':_0x2fa824(0x239),'whatsappId':_0x5e22db[_0x2fa824(0x22d)],'chatbot':_0x2bbfca,'queueOptionId':_0x3e155c,'promptId':_0x38a01c,'useIntegration':_0x56e81e,'integrationId':_0x20fb96,'amountUsedBotQueues':0x0,'unreadMessages':0x0})),_0x43f978=_0x5e22db['status'],_0x43f978===_0x2fa824(0x239)&&(_0x507611[_0x2fa824(0x25a)]({'whatsappId':_0x28def4,'queuedAt':(0x0,moment_1['default'])()['toDate'](),'startedAt':null,'userId':null}),_0x419148['to'](_0x2fa824(0x236)+_0x43afcd+'-mainchannel')[_0x2fa824(0x20f)]('company-'+_0x43afcd+_0x2fa824(0x23f),{'action':_0x2fa824(0x1f0),'ticketId':_0x5e22db?.['id']})),_0x43f978===_0x2fa824(0x22f)&&(_0x507611[_0x2fa824(0x25a)]({'startedAt':(0x0,moment_1[_0x2fa824(0x1ee)])()[_0x2fa824(0x1f6)](),'ratingAt':null,'rated':![],'whatsappId':_0x28def4,'userId':_0x5e22db['userId']}),_0x419148['to'](_0x2fa824(0x236)+_0x43afcd+_0x2fa824(0x247))[_0x2fa824(0x20f)](_0x2fa824(0x236)+_0x43afcd+_0x2fa824(0x23f),{'action':_0x2fa824(0x1f0),'ticketId':_0x5e22db?.['id']}),_0x419148['to'](_0x2fa824(0x236)+_0x43afcd+'-mainchannel')[_0x2fa824(0x20f)](_0x2fa824(0x236)+_0x43afcd+'-ticket',{'action':_0x2fa824(0x232),'ticketId':_0x5e22db?.['id']})),await _0x507611['save'](),(_0x5e22db[_0x2fa824(0x203)]!==_0xcb480||_0x5e22db[_0x2fa824(0x258)]?.['id']!==_0xc81c4c||_0x53b90b)&&_0x419148['to'](_0x2fa824(0x236)+_0x5e22db[_0x2fa824(0x24c)]+'-'+_0xcb480)['to'](_0x2fa824(0x228)+_0x5e22db[_0x2fa824(0x21f)]+'-'+_0xcb480)['to'](_0x2fa824(0x236)+_0x5e22db['companyId']+'-notification')['to']('queue-'+_0x5e22db['queueId']+_0x2fa824(0x231))['to'](_0x2072f8[_0x2fa824(0x1fe)]())[_0x2fa824(0x20f)](_0x2fa824(0x236)+_0x43afcd+_0x2fa824(0x23f),{'action':_0x2fa824(0x219),'ticketId':_0x5e22db['id']}),_0x5e22db[_0x2fa824(0x203)]!==_0x2fa824(0x244)&&_0x419148['to'](_0x2fa824(0x236)+_0x5e22db[_0x2fa824(0x24c)]+'-'+_0x5e22db[_0x2fa824(0x203)])['to'](_0x2fa824(0x236)+_0x5e22db[_0x2fa824(0x24c)]+'-notification')['to'](_0x2fa824(0x228)+_0x5e22db[_0x2fa824(0x21f)]+_0x2fa824(0x231))['to'](_0x2fa824(0x228)+_0x5e22db[_0x2fa824(0x21f)]+'-'+_0x5e22db[_0x2fa824(0x203)])['to'](_0x2072f8[_0x2fa824(0x1fe)]())[_0x2fa824(0x20f)](_0x2fa824(0x236)+_0x43afcd+_0x2fa824(0x23f),{'action':_0x2fa824(0x25a),'ticket':_0x5e22db}),{'ticket':_0x5e22db,'oldStatus':_0xcb480,'oldUserId':_0xc81c4c};}catch(_0x244085){console[_0x2fa824(0x213)](_0x244085),Sentry[_0x2fa824(0x23e)](_0x244085);}};exports[a529_0xe2d52b(0x1ee)]=UpdateTicketService;const notifyUpdate=(_0x3fe363,_0xf6d2e2,_0x5a3de7,_0x4242da)=>{const _0x2131c1=a529_0xe2d52b;_0x3fe363['to'](_0x2131c1(0x236)+_0xf6d2e2[_0x2131c1(0x24c)]+'-'+_0xf6d2e2['status'])['to'](_0x2131c1(0x236)+_0xf6d2e2[_0x2131c1(0x24c)]+_0x2131c1(0x231))['to'](_0x5a3de7['toString']())[_0x2131c1(0x20f)](_0x2131c1(0x236)+_0x4242da+_0x2131c1(0x23f),{'action':'update','ticket':_0xf6d2e2});};exports['notifyUpdate']=notifyUpdate;