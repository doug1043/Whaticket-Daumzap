const a670_0x596b25=a670_0x4b7d;(function(_0x4a45bf,_0xbe048b){const _0x5f5b33=a670_0x4b7d,_0x4b8d1b=_0x4a45bf();while(!![]){try{const _0x37828e=-parseInt(_0x5f5b33(0x197))/0x1*(-parseInt(_0x5f5b33(0x14e))/0x2)+parseInt(_0x5f5b33(0x162))/0x3+parseInt(_0x5f5b33(0x191))/0x4*(-parseInt(_0x5f5b33(0x158))/0x5)+parseInt(_0x5f5b33(0x147))/0x6+parseInt(_0x5f5b33(0x196))/0x7+-parseInt(_0x5f5b33(0x187))/0x8+-parseInt(_0x5f5b33(0x195))/0x9;if(_0x37828e===_0xbe048b)break;else _0x4b8d1b['push'](_0x4b8d1b['shift']());}catch(_0x126370){_0x4b8d1b['push'](_0x4b8d1b['shift']());}}}(a670_0x1bbd,0xaa54d));const a670_0x14b139=(function(){let _0x6169b5=!![];return function(_0x4a83c9,_0x2727a7){const _0x5358c7=_0x6169b5?function(){const _0x5c4d77=a670_0x4b7d;if(_0x2727a7){const _0x2e0288=_0x2727a7[_0x5c4d77(0x14c)](_0x4a83c9,arguments);return _0x2727a7=null,_0x2e0288;}}:function(){};return _0x6169b5=![],_0x5358c7;};}()),a670_0x334543=a670_0x14b139(this,function(){const _0x2941d5=a670_0x4b7d;return a670_0x334543[_0x2941d5(0x19a)]()[_0x2941d5(0x14f)](_0x2941d5(0x15a))['toString']()[_0x2941d5(0x181)](a670_0x334543)[_0x2941d5(0x14f)](_0x2941d5(0x15a));});function a670_0x1bbd(){const _0x15b27f=['-mainchannel','sendGreetingAccepted','moment','user','user-','2954226kWimAW','removeFromList','delete','greetingMediaAttachment','amountUsedBotQueues','greetingAcceptedMessage','save','./FindOrCreateATicketTrakingService','Apenas\x20o\x20usuário\x20ativo\x20do\x20ticket,\x20Supervisor\x20ou\x20Admin\x20podem\x20fazer\x20alterações\x20no\x20ticket','../../libs/socket','-notification','defineProperty','__esModule','transferMessage','../WbotServices/VerifyHandlers','queueId','whatsapp','isGroup','default','-ticket','userId','GetCompanySetting','update','../WbotServices/SendWhatsAppMessage','getIO','disableBot','public','queue-','../../helpers/CheckContactOpenTickets','integrationId','whatsappId','constructor','resolve','closed','chatbot','sendTransferMessage','finishedAt','8837368RFzLVd','__importDefault','keepUserAndQueue','emit','useIntegration','reload','channel','disabled','-open','../../models/User','3725240wYqLZP','indexOf','ratingAt','greetingMessage','2437506ozpscP','7553245NnkFtN','73EwVhzq','../../helpers/CheckSettings','pending','toString','trim','\x0a\x0a*Digite\x20uma\x20nota\x20de\x201\x20a\x205*\x0a','isNil','name','../WbotServices/SendWhatsAppMedia','companyId','contact','5602680qqtiVh','../../helpers/Mustache','useRating','company-','Need\x20companyId\x20or\x20tokenData','apply','../WhatsappService/ShowWhatsAppService','190scbXgc','search','queuedAt','status','color','rated','contactId','profile','toDate','open','5fdKuBw','queue','(((.+)+)+)+$','admin','updateUnread'];a670_0x1bbd=function(){return _0x15b27f;};return a670_0x1bbd();}a670_0x334543();'use strict';function a670_0x4b7d(_0x35bd1d,_0x545852){const _0x78b79c=a670_0x1bbd();return a670_0x4b7d=function(_0x334543,_0x14b139){_0x334543=_0x334543-0x140;let _0x1bbd0a=_0x78b79c[_0x334543];return _0x1bbd0a;},a670_0x4b7d(_0x35bd1d,_0x545852);}var __importDefault=this&&this[a670_0x596b25(0x188)]||function(_0x39d2d4){const _0x357a89=a670_0x596b25;return _0x39d2d4&&_0x39d2d4[_0x357a89(0x16e)]?_0x39d2d4:{'default':_0x39d2d4};};Object[a670_0x596b25(0x16d)](exports,'__esModule',{'value':!![]});const moment_1=__importDefault(require(a670_0x596b25(0x15f))),lodash_1=require('lodash'),path_1=__importDefault(require('path')),fs_1=__importDefault(require('fs')),CheckContactOpenTickets_1=__importDefault(require(a670_0x596b25(0x17e))),SetTicketMessagesAsRead_1=__importDefault(require('../../helpers/SetTicketMessagesAsRead')),socket_1=require(a670_0x596b25(0x16b)),Queue_1=__importDefault(require('../../models/Queue')),User_1=__importDefault(require(a670_0x596b25(0x190))),ShowTicketService_1=__importDefault(require('./ShowTicketService')),ShowWhatsAppService_1=__importDefault(require(a670_0x596b25(0x14d))),SendWhatsAppMessage_1=__importDefault(require(a670_0x596b25(0x179))),SendWhatsAppMedia_1=__importDefault(require(a670_0x596b25(0x144))),FindOrCreateATicketTrakingService_1=__importDefault(require(a670_0x596b25(0x169))),VerifyHandlers_1=require(a670_0x596b25(0x170)),AppError_1=__importDefault(require('../../errors/AppError')),CheckSettings_1=require(a670_0x596b25(0x198)),Mustache_1=__importDefault(require(a670_0x596b25(0x148))),UpdateTicketService=async({ticketData:_0xd2d488,ticketId:_0x7254f0,tokenData:_0x360b27,companyId:_0x3602ad})=>{const _0x3751e1=a670_0x596b25;try{if(!_0x3602ad&&!_0x360b27)throw new Error(_0x3751e1(0x14b));_0x360b27&&(_0x3602ad=_0x360b27['companyId']);const {justClose:_0x361da1}=_0xd2d488;let {status:_0x4c0020}=_0xd2d488,{queueId:_0x4964fb,userId:_0x2ce338}=_0xd2d488,_0x57e3da=_0xd2d488[_0x3751e1(0x184)]||![],_0x121ae3=_0xd2d488[_0x3751e1(0x18b)]||![],_0x4fe45c=_0xd2d488[_0x3751e1(0x17f)]||null;const _0x41c5a2=(0x0,socket_1[_0x3751e1(0x17a)])(),_0xa585a2=await(0x0,ShowTicketService_1[_0x3751e1(0x174)])(_0x7254f0,_0x3602ad),_0x46487c=await(0x0,ShowWhatsAppService_1[_0x3751e1(0x174)])(_0xa585a2[_0x3751e1(0x180)],_0x3602ad);if(_0x360b27&&_0xa585a2['status']!==_0x3751e1(0x199)){if(_0x360b27[_0x3751e1(0x155)]!==_0x3751e1(0x15b)&&_0x360b27['profile']!=='superv'&&_0xa585a2['userId']!==parseInt(_0x360b27['id'],0xa))throw new AppError_1[(_0x3751e1(0x174))](_0x3751e1(0x16a));}const _0x4a7d1c=await(0x0,FindOrCreateATicketTrakingService_1['default'])({'ticketId':_0x7254f0,'companyId':_0x3602ad,'whatsappId':_0xa585a2['whatsappId']});_0xa585a2[_0x3751e1(0x18d)]===_0x3751e1(0x172)&&_0x4c0020===_0x3751e1(0x157)&&(0x0,SetTicketMessagesAsRead_1[_0x3751e1(0x174)])(_0xa585a2);const _0x192c86=_0xa585a2[_0x3751e1(0x151)],_0x25e829=_0xa585a2[_0x3751e1(0x160)]?.['id'],_0x535688=_0xa585a2[_0x3751e1(0x171)];_0x192c86===_0x3751e1(0x183)&&(await(0x0,CheckContactOpenTickets_1[_0x3751e1(0x174)])(_0xa585a2[_0x3751e1(0x154)],_0xa585a2[_0x3751e1(0x180)]),_0x57e3da=null);if(_0x4c0020!==undefined&&[_0x3751e1(0x183)][_0x3751e1(0x192)](_0x4c0020)>-0x1){const {complationMessage:_0x4a990b,ratingMessage:_0x2fe6df}=await(0x0,ShowWhatsAppService_1[_0x3751e1(0x174)])(_0xa585a2[_0x3751e1(0x180)],_0x3602ad);if(!_0xa585a2[_0x3751e1(0x146)]['isGroup']&&!_0xa585a2[_0x3751e1(0x146)]['disableBot']&&_0x46487c[_0x3751e1(0x149)]){if(_0x4a7d1c[_0x3751e1(0x193)]==null&&!_0x361da1){const _0x2d49af=_0x2fe6df?.[_0x3751e1(0x140)]()||'Por\x20favor\x20avalie\x20nosso\x20atendimento',_0x43675c=_0x2d49af+_0x3751e1(0x141);return _0xa585a2[_0x3751e1(0x18d)]===_0x3751e1(0x172)&&await(0x0,SendWhatsAppMessage_1[_0x3751e1(0x174)])({'body':_0x43675c,'ticket':_0xa585a2}),await _0x4a7d1c[_0x3751e1(0x178)]({'ratingAt':(0x0,moment_1[_0x3751e1(0x174)])()[_0x3751e1(0x156)](),'rated':![]}),_0x41c5a2['to'](_0x3751e1(0x14a)+_0xa585a2[_0x3751e1(0x145)]+_0x3751e1(0x18f))['to']('queue-'+_0xa585a2[_0x3751e1(0x171)]+'-open')['to'](_0x7254f0[_0x3751e1(0x19a)]())[_0x3751e1(0x18a)](_0x3751e1(0x14a)+_0xa585a2[_0x3751e1(0x145)]+_0x3751e1(0x175),{'action':_0x3751e1(0x164),'ticketId':_0xa585a2['id']}),{'ticket':_0xa585a2,'oldStatus':_0x192c86,'oldUserId':_0x25e829};}_0x4a7d1c['ratingAt']=(0x0,moment_1[_0x3751e1(0x174)])()[_0x3751e1(0x156)](),_0x4a7d1c[_0x3751e1(0x153)]=![];}if(!_0xa585a2[_0x3751e1(0x146)][_0x3751e1(0x173)]&&!_0xa585a2[_0x3751e1(0x146)][_0x3751e1(0x17b)]&&!_0x361da1&&!(0x0,lodash_1[_0x3751e1(0x142)])(_0x4a990b)&&_0x4a990b!==''){const _0x474534=(0x0,Mustache_1[_0x3751e1(0x174)])(''+_0x4a990b,_0xa585a2);if(_0xa585a2[_0x3751e1(0x18d)]===_0x3751e1(0x172)&&!_0xa585a2[_0x3751e1(0x173)]){const _0x539eb8=await(0x0,SendWhatsAppMessage_1[_0x3751e1(0x174)])({'body':_0x474534,'ticket':_0xa585a2});await(0x0,VerifyHandlers_1['verifyMessage'])(_0x539eb8,_0xa585a2,_0xa585a2[_0x3751e1(0x146)]);}}_0x4a7d1c[_0x3751e1(0x186)]=(0x0,moment_1[_0x3751e1(0x174)])()['toDate'](),_0x4a7d1c['whatsappId']=_0xa585a2[_0x3751e1(0x180)],_0x4a7d1c[_0x3751e1(0x176)]=_0xa585a2['userId'],_0x121ae3=![],_0x4fe45c=null;const _0x451a8f=await(0x0,CheckSettings_1[_0x3751e1(0x177)])(_0x3602ad,_0x3751e1(0x189),'enabled');_0x451a8f===_0x3751e1(0x18e)&&(_0x4964fb=null,_0x2ce338=null);}_0x4964fb!==undefined&&_0x4964fb!==null&&(_0x4a7d1c[_0x3751e1(0x150)]=(0x0,moment_1[_0x3751e1(0x174)])()[_0x3751e1(0x156)]());await _0xa585a2[_0x3751e1(0x178)]({'status':_0x4c0020,'amountUsedBotQueues':_0xd2d488[_0x3751e1(0x166)]||0x0,'queueId':_0x4964fb,'userId':_0x2ce338,'whatsappId':_0xa585a2[_0x3751e1(0x180)],'chatbot':_0x57e3da,'useIntegration':_0x121ae3,'integrationId':_0x4fe45c}),await _0xa585a2[_0x3751e1(0x18c)]();if(_0x535688!==_0x4964fb&&!(0x0,lodash_1[_0x3751e1(0x142)])(_0x535688)&&!(0x0,lodash_1[_0x3751e1(0x142)])(_0x4964fb)){if(_0xa585a2['channel']==='whatsapp'){const _0x2dc41d=await(0x0,ShowWhatsAppService_1[_0x3751e1(0x174)])(_0xa585a2[_0x3751e1(0x180)],_0x3602ad);if(_0x2dc41d[_0x3751e1(0x185)]&&!_0xa585a2['isGroup']){if(_0x2dc41d[_0x3751e1(0x16f)]?.[_0x3751e1(0x140)]()){await _0xa585a2[_0x3751e1(0x18c)]({'include':[{'model':Queue_1['default'],'as':'queue','attributes':['id',_0x3751e1(0x143),'color']},{'model':User_1[_0x3751e1(0x174)],'as':_0x3751e1(0x160),'attributes':['id','name']}]});const _0x2a6921=(0x0,Mustache_1[_0x3751e1(0x174)])(_0x2dc41d['transferMessage'],_0xa585a2);await(0x0,SendWhatsAppMessage_1[_0x3751e1(0x174)])({'body':_0x2a6921,'ticket':_0xa585a2});}}}}if(_0x192c86===_0x3751e1(0x199)&&_0x4c0020===_0x3751e1(0x157)&&_0xa585a2[_0x3751e1(0x18d)]===_0x3751e1(0x172)&&!_0xa585a2[_0x3751e1(0x173)]){const _0x3fa687=await(0x0,ShowWhatsAppService_1[_0x3751e1(0x174)])(_0xa585a2['whatsappId'],_0x3602ad);if(_0x3fa687[_0x3751e1(0x15e)]){const _0x67c579=_0x3fa687[_0x3751e1(0x167)]?.[_0x3751e1(0x140)]()||_0x3fa687[_0x3751e1(0x194)]?.[_0x3751e1(0x140)]();if(_0x67c579){await _0xa585a2[_0x3751e1(0x18c)]({'include':[{'model':Queue_1[_0x3751e1(0x174)],'as':_0x3751e1(0x159),'attributes':['id',_0x3751e1(0x143),_0x3751e1(0x152)]},{'model':User_1[_0x3751e1(0x174)],'as':'user','attributes':['id','name']}]});if(_0x3fa687[_0x3751e1(0x165)]){const _0x5d19b0=path_1[_0x3751e1(0x174)][_0x3751e1(0x182)](_0x3751e1(0x17c),_0x3fa687['greetingMediaAttachment']),_0x561ec2=fs_1[_0x3751e1(0x174)]['existsSync'](_0x5d19b0);if(_0x561ec2){const _0x5caa19=(0x0,Mustache_1[_0x3751e1(0x174)])(_0x67c579,_0xa585a2);await(0x0,SendWhatsAppMedia_1['default'])({'ticket':_0xa585a2,'media':_0x5d19b0,'body':_0x5caa19});}else{const _0x4d48d3=(0x0,Mustache_1[_0x3751e1(0x174)])(_0x67c579,_0xa585a2);await(0x0,SendWhatsAppMessage_1[_0x3751e1(0x174)])({'body':_0x4d48d3,'ticket':_0xa585a2});}}else{const _0x5d097b=(0x0,Mustache_1[_0x3751e1(0x174)])(_0x67c579,_0xa585a2);await(0x0,SendWhatsAppMessage_1['default'])({'body':_0x5d097b,'ticket':_0xa585a2});}}}}_0x4c0020=_0xa585a2[_0x3751e1(0x151)];_0x4c0020!==undefined&&[_0x3751e1(0x199)][_0x3751e1(0x192)](_0x4c0020)>-0x1&&(_0x4a7d1c[_0x3751e1(0x178)]({'whatsappId':_0xa585a2[_0x3751e1(0x180)],'queuedAt':(0x0,moment_1[_0x3751e1(0x174)])()[_0x3751e1(0x156)](),'startedAt':null,'userId':null}),_0x41c5a2['to'](_0x3751e1(0x14a)+_0x3602ad+_0x3751e1(0x15d))[_0x3751e1(0x18a)](_0x3751e1(0x14a)+_0x3602ad+_0x3751e1(0x175),{'action':_0x3751e1(0x163),'ticketId':_0xa585a2?.['id']}));_0x4c0020!==undefined&&[_0x3751e1(0x157)]['indexOf'](_0x4c0020)>-0x1&&(_0x4a7d1c['update']({'startedAt':(0x0,moment_1[_0x3751e1(0x174)])()['toDate'](),'ratingAt':null,'rated':![],'whatsappId':_0xa585a2[_0x3751e1(0x180)],'userId':_0xa585a2[_0x3751e1(0x176)]}),_0x41c5a2['to'](_0x3751e1(0x14a)+_0x3602ad+'-mainchannel')[_0x3751e1(0x18a)](_0x3751e1(0x14a)+_0x3602ad+'-ticket',{'action':_0x3751e1(0x163),'ticketId':_0xa585a2?.['id']}),_0x41c5a2['to'](_0x3751e1(0x14a)+_0x3602ad+'-mainchannel')[_0x3751e1(0x18a)](_0x3751e1(0x14a)+_0x3602ad+_0x3751e1(0x175),{'action':_0x3751e1(0x15c),'ticketId':_0xa585a2?.['id']}));await _0x4a7d1c[_0x3751e1(0x168)]();if(_0x361da1&&_0x4c0020===_0x3751e1(0x183))_0x41c5a2['to'](_0x3751e1(0x14a)+_0x3602ad+_0x3751e1(0x15d))['emit']('company-'+_0x3602ad+_0x3751e1(0x175),{'action':_0x3751e1(0x163),'ticketId':_0xa585a2?.['id']});else _0xa585a2[_0x3751e1(0x151)]===_0x3751e1(0x183)&&_0xa585a2[_0x3751e1(0x151)]!==_0x192c86&&_0x41c5a2['to']('company-'+_0x3602ad+'-'+_0x192c86)['to'](_0x3751e1(0x17d)+_0xa585a2[_0x3751e1(0x171)]+'-'+_0x192c86)['to']('user-'+_0x25e829)[_0x3751e1(0x18a)]('company-'+_0x3602ad+_0x3751e1(0x175),{'action':'removeFromList','ticketId':_0xa585a2['id']});return _0x41c5a2['to'](_0x3751e1(0x14a)+_0x3602ad+'-'+_0xa585a2['status'])['to'](_0x3751e1(0x14a)+_0x3602ad+'-notification')['to'](_0x3751e1(0x17d)+_0xa585a2[_0x3751e1(0x171)]+'-'+_0xa585a2[_0x3751e1(0x151)])['to'](_0x3751e1(0x17d)+_0xa585a2[_0x3751e1(0x171)]+_0x3751e1(0x16c))['to'](_0x7254f0[_0x3751e1(0x19a)]())['to'](_0x3751e1(0x161)+_0xa585a2?.['userId'])['to'](_0x3751e1(0x161)+_0x25e829)['emit'](_0x3751e1(0x14a)+_0x3602ad+_0x3751e1(0x175),{'action':_0x3751e1(0x178),'ticket':_0xa585a2}),{'ticket':_0xa585a2,'oldStatus':_0x192c86,'oldUserId':_0x25e829};}catch(_0x152e8d){if(_0x152e8d instanceof AppError_1[_0x3751e1(0x174)])throw _0x152e8d;throw new AppError_1[(_0x3751e1(0x174))]('Error\x20updating\x20ticket',0x1f4,_0x152e8d);}};exports[a670_0x596b25(0x174)]=UpdateTicketService;