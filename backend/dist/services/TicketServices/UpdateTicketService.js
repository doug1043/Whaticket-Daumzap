function a528_0x52b8(_0x2d674f,_0x3f7394){const _0x1a4cc7=a528_0x2583();return a528_0x52b8=function(_0xfb4fe,_0x4b9d3a){_0xfb4fe=_0xfb4fe-0x178;let _0x2583f3=_0x1a4cc7[_0xfb4fe];return _0x2583f3;},a528_0x52b8(_0x2d674f,_0x3f7394);}const a528_0x5086d3=a528_0x52b8;(function(_0x3c7c8c,_0x3c8f10){const _0x477cb3=a528_0x52b8,_0x5d20e2=_0x3c7c8c();while(!![]){try{const _0x356c77=parseInt(_0x477cb3(0x1ba))/0x1+parseInt(_0x477cb3(0x19c))/0x2+parseInt(_0x477cb3(0x1cc))/0x3+-parseInt(_0x477cb3(0x191))/0x4+-parseInt(_0x477cb3(0x1af))/0x5+-parseInt(_0x477cb3(0x1c2))/0x6*(parseInt(_0x477cb3(0x1d2))/0x7)+parseInt(_0x477cb3(0x1eb))/0x8;if(_0x356c77===_0x3c8f10)break;else _0x5d20e2['push'](_0x5d20e2['shift']());}catch(_0x468ea7){_0x5d20e2['push'](_0x5d20e2['shift']());}}}(a528_0x2583,0x76e5e));const a528_0x4b9d3a=(function(){let _0x119e3f=!![];return function(_0x298aee,_0x395118){const _0x2a5647=_0x119e3f?function(){const _0x5e088f=a528_0x52b8;if(_0x395118){const _0x8e760=_0x395118[_0x5e088f(0x1db)](_0x298aee,arguments);return _0x395118=null,_0x8e760;}}:function(){};return _0x119e3f=![],_0x2a5647;};}()),a528_0xfb4fe=a528_0x4b9d3a(this,function(){const _0x39c260=a528_0x52b8;return a528_0xfb4fe['toString']()['search'](_0x39c260(0x184))[_0x39c260(0x19f)]()[_0x39c260(0x186)](a528_0xfb4fe)[_0x39c260(0x1d0)]('(((.+)+)+)+$');});a528_0xfb4fe();'use strict';var __createBinding=this&&this[a528_0x5086d3(0x1c8)]||(Object[a528_0x5086d3(0x1ed)]?function(_0x252a38,_0x51ab96,_0x39d096,_0x15a40c){const _0x52c3a4=a528_0x5086d3;if(_0x15a40c===undefined)_0x15a40c=_0x39d096;var _0x46dc34=Object[_0x52c3a4(0x1b4)](_0x51ab96,_0x39d096);(!_0x46dc34||(_0x52c3a4(0x1a9)in _0x46dc34?!_0x51ab96[_0x52c3a4(0x183)]:_0x46dc34['writable']||_0x46dc34[_0x52c3a4(0x199)]))&&(_0x46dc34={'enumerable':!![],'get':function(){return _0x51ab96[_0x39d096];}}),Object[_0x52c3a4(0x1c4)](_0x252a38,_0x15a40c,_0x46dc34);}:function(_0x3f8a8b,_0x4c1515,_0x11e399,_0x4346d3){if(_0x4346d3===undefined)_0x4346d3=_0x11e399;_0x3f8a8b[_0x4346d3]=_0x4c1515[_0x11e399];}),__setModuleDefault=this&&this[a528_0x5086d3(0x180)]||(Object[a528_0x5086d3(0x1ed)]?function(_0x2cd48d,_0x58aa83){const _0x4f2ed3=a528_0x5086d3;Object[_0x4f2ed3(0x1c4)](_0x2cd48d,_0x4f2ed3(0x1a0),{'enumerable':!![],'value':_0x58aa83});}:function(_0x2b3738,_0x4846a6){_0x2b3738['default']=_0x4846a6;}),__importStar=this&&this['__importStar']||function(_0x4bb9bc){const _0x53d61b=a528_0x5086d3;if(_0x4bb9bc&&_0x4bb9bc[_0x53d61b(0x183)])return _0x4bb9bc;var _0x5c76a2={};if(_0x4bb9bc!=null){for(var _0x4ead67 in _0x4bb9bc)if(_0x4ead67!=='default'&&Object[_0x53d61b(0x1e3)][_0x53d61b(0x196)]['call'](_0x4bb9bc,_0x4ead67))__createBinding(_0x5c76a2,_0x4bb9bc,_0x4ead67);}return __setModuleDefault(_0x5c76a2,_0x4bb9bc),_0x5c76a2;},__importDefault=this&&this[a528_0x5086d3(0x1c3)]||function(_0x85f74a){const _0x4f042b=a528_0x5086d3;return _0x85f74a&&_0x85f74a[_0x4f042b(0x183)]?_0x85f74a:{'default':_0x85f74a};};Object[a528_0x5086d3(0x1c4)](exports,a528_0x5086d3(0x183),{'value':!![]}),exports[a528_0x5086d3(0x1dc)]=void 0x0;function a528_0x2583(){const _0x4f0090=['create','company-','ratingAt','-mainchannel','*\x0aaguarde,\x20já\x20vamos\x20te\x20atender!','*\x20e\x20contará\x20com\x20a\x20presença\x20de\x20*','*\x20por\x20','lodash','promptId','__setModuleDefault','findByPk','toDate','__esModule','(((.+)+)+)+$','../../libs/socket','constructor','../../libs/wbot','g.us','number','reload','queue-','value','profile','../UserServices/ShowUserService','unreadMessages','whatsappId','1829552lFdBhH','queueId','removeFromList','emit','../../helpers/SetTicketMessagesAsRead','hasOwnProperty','DD/MM/YYYY\x20HH:mm:ss','length','configurable','status','dest','1223172Iywuzt','updateUnread','integrationId','toString','default','pending','save','delete','../WhatsappService/ShowWhatsAppService','isNil','../WbotServices/SendWhatsAppMessage','-notification','./ShowTicketService','get','getTime','*Mensagem\x20automática*:\x0aFoi\x20transferido\x20para\x20o\x20atendente\x20*','update','queuedAt','../SettingServices/ListSettingsServiceOne','4269565lfkETV','finishedAt','contactId','../../models/Queue','sendMsgTransfTicket','getOwnPropertyDescriptor','\x0aaguarde,\x20já\x20vamos\x20te\x20atender!','contact','SendPresenceStatus','closed','findOne','266988KEhXLB','sendMessage','username','name','Need\x20companyId\x20or\x20tokenData','captureException','trace','@sentry/node','865308HdXIoL','__importDefault','defineProperty','companyId','*3*\x20-\x20_Moderadamente\x20Satisfeito_\x0a','verifyMessage','__createBinding','useIntegration','userId','amountUsedBotQueues','2836332WmHgoy','format','enabled','filter','search','isGroup','35OfVVCN','*,\x20em\x20','*\x20transferido\x20por\x20','moment','\x20em\x20','disableBot','user','chatbot','\x0aAguarde,\x20já\x20vamos\x20te\x20atender!','apply','notifyUpdate','userRating','*5*\x20-\x20_Muito\x20Satisfeito_\x0a','find','../../helpers/GetTicketWbot','admin','push','prototype','-ticket','time','../../models/Setting','*\x20transferiu\x20o\x20ticket\x20para\x20você,\x20*','../../errors/AppError','s.whatsapp.net','newTicketOnTransfer','5563032RcrlIc','*2*\x20-\x20_Insatisfeito_\x0a'];a528_0x2583=function(){return _0x4f0090;};return a528_0x2583();}const moment_1=__importDefault(require(a528_0x5086d3(0x1d5))),Sentry=__importStar(require(a528_0x5086d3(0x1c1))),CheckContactOpenTickets_1=__importDefault(require('../../helpers/CheckContactOpenTickets')),SetTicketMessagesAsRead_1=__importDefault(require(a528_0x5086d3(0x195))),socket_1=require(a528_0x5086d3(0x185)),Ticket_1=__importDefault(require('../../models/Ticket')),Setting_1=__importDefault(require(a528_0x5086d3(0x1e6))),Queue_1=__importDefault(require(a528_0x5086d3(0x1b2))),ShowTicketService_1=__importDefault(require(a528_0x5086d3(0x1a8))),ShowWhatsAppService_1=__importDefault(require(a528_0x5086d3(0x1a4))),SendWhatsAppMessage_1=__importDefault(require(a528_0x5086d3(0x1a6))),FindOrCreateATicketTrakingService_1=__importDefault(require('./FindOrCreateATicketTrakingService')),GetTicketWbot_1=__importDefault(require(a528_0x5086d3(0x1e0))),wbotMessageListener_1=require('../WbotServices/wbotMessageListener'),ListSettingsServiceOne_1=__importDefault(require(a528_0x5086d3(0x1ae))),ShowUserService_1=__importDefault(require(a528_0x5086d3(0x18e))),lodash_1=require(a528_0x5086d3(0x17e)),AppError_1=__importDefault(require(a528_0x5086d3(0x1e8))),SendPresenceStatus_1=require('../../helpers/SendPresenceStatus'),wbot_1=require(a528_0x5086d3(0x187));let completionMessageControl=[];const UpdateTicketService=async({ticketData:_0x17ef2c,ticketId:_0x19d7bf,tokenData:_0x49fa58,companyId:_0x1c16ac})=>{const _0x57004f=a528_0x5086d3;try{if(!_0x1c16ac&&!_0x49fa58)throw new Error(_0x57004f(0x1be));_0x49fa58&&(_0x1c16ac=_0x49fa58['companyId']);let {status:_0x200dc3}=_0x17ef2c,{queueId:_0x3c801a,userId:_0x201cf9,whatsappId:_0x3250b9,sendFarewellMessage:_0x138f98}=_0x17ef2c;_0x138f98==null&&(_0x138f98=!![]);let _0x49fef9=_0x17ef2c[_0x57004f(0x1d9)]||![],_0x23197a=_0x17ef2c['queueOptionId']||null,_0x5badd7=_0x17ef2c[_0x57004f(0x17f)]||null,_0x3c751c=_0x17ef2c[_0x57004f(0x1c9)]||![],_0x2904cb=_0x17ef2c[_0x57004f(0x19e)]||null;const _0x23e7d0=(0x0,socket_1['getIO'])(),_0x3cb109=_0x57004f(0x1dd),_0x166bc2=await Setting_1['default'][_0x57004f(0x1b9)]({'where':{'companyId':_0x1c16ac,'key':_0x3cb109}});let _0x1544d1=await(0x0,ShowTicketService_1[_0x57004f(0x1a0)])(_0x19d7bf,_0x1c16ac);if(_0x49fa58&&_0x1544d1[_0x57004f(0x19a)]!==_0x57004f(0x1a1)){if(_0x49fa58[_0x57004f(0x18d)]!==_0x57004f(0x1e1)&&_0x1544d1[_0x57004f(0x1ca)]!==parseInt(_0x49fa58['id'],0xa))throw new AppError_1[(_0x57004f(0x1a0))]('Apenas\x20o\x20usuário\x20ativo\x20do\x20ticket\x20ou\x20o\x20Admin\x20podem\x20fazer\x20alterações\x20no\x20ticket');}const _0x3dca04=await(0x0,FindOrCreateATicketTrakingService_1['default'])({'ticketId':_0x19d7bf,'companyId':_0x1c16ac,'whatsappId':_0x1544d1[_0x57004f(0x190)]});(0x0,lodash_1[_0x57004f(0x1a5)])(_0x3250b9)&&(_0x3250b9=_0x1544d1[_0x57004f(0x190)][_0x57004f(0x19f)]());(_0x200dc3===_0x57004f(0x1b8)||_0x200dc3==='open')&&await(0x0,SetTicketMessagesAsRead_1[_0x57004f(0x1a0)])(_0x1544d1);const _0x2975a3=_0x1544d1[_0x57004f(0x19a)],_0x3c446b=_0x1544d1[_0x57004f(0x1d8)]?.['id'],_0x2a4385=_0x1544d1[_0x57004f(0x192)];(_0x2975a3===_0x57004f(0x1b8)||_0x3250b9!==undefined&&Number(_0x3250b9)!==_0x1544d1[_0x57004f(0x190)])&&(await(0x0,CheckContactOpenTickets_1[_0x57004f(0x1a0)])(_0x1544d1[_0x57004f(0x1b6)]['id'],_0x3250b9),_0x49fef9=null,_0x23197a=null);if(_0x200dc3==='closed'){const {complationMessage:_0x23eddd,ratingMessage:_0x191e1d}=await(0x0,ShowWhatsAppService_1['default'])(_0x1544d1[_0x57004f(0x190)],_0x1c16ac);if(!_0x1544d1[_0x57004f(0x1b6)][_0x57004f(0x1d7)]&&_0x166bc2?.[_0x57004f(0x18c)]===_0x57004f(0x1ce)&&_0x138f98&&!_0x1544d1[_0x57004f(0x1d1)]){if(_0x3dca04[_0x57004f(0x179)]==null&&!_0x1544d1[_0x57004f(0x1d1)]){const _0x463b27=_0x191e1d||'';let _0x47f13d='‎'+_0x463b27+'\x0a\x0a';return _0x47f13d+='Digite\x20de\x201\x20à\x205\x20para\x20qualificar\x20nosso\x20atendimento:\x0a'+'*1*\x20-\x20_Muito\x20Insatisfeito_\x0a'+_0x57004f(0x1ec)+_0x57004f(0x1c6)+'*4*\x20-\x20_Satisfeito_\x0a'+_0x57004f(0x1de),await(0x0,SendPresenceStatus_1[_0x57004f(0x1b7)])((0x0,wbot_1['getWbot'])(_0x1544d1[_0x57004f(0x190)]),_0x1544d1[_0x57004f(0x1b6)][_0x57004f(0x189)]+'@'+(_0x1544d1[_0x57004f(0x1d1)]?_0x57004f(0x188):_0x57004f(0x1e9))),await(0x0,SendWhatsAppMessage_1[_0x57004f(0x1a0)])({'body':_0x47f13d,'ticket':_0x1544d1}),await _0x3dca04['update']({'rated':![],'ratingAt':(0x0,moment_1['default'])()[_0x57004f(0x182)]()}),await _0x1544d1[_0x57004f(0x1ac)]({'amountUsedBotQueues':_0x17ef2c[_0x57004f(0x1cb)]||0x0,'status':_0x200dc3,'unreadMessages':_0x17ef2c[_0x57004f(0x18f)]||0x0,'queueId':_0x3c801a,'userId':_0x201cf9,'whatsappId':_0x3250b9,'chatbot':_0x49fef9,'queueOptionId':_0x23197a}),_0x23e7d0['to'](_0x57004f(0x178)+_0x1544d1['companyId']+'-open')['to'](_0x19d7bf[_0x57004f(0x19f)]())[_0x57004f(0x194)](_0x57004f(0x178)+_0x1544d1['companyId']+'-ticket',{'action':_0x57004f(0x1a3),'ticketId':_0x1544d1['id']}),{'ticket':_0x1544d1,'oldStatus':_0x2975a3,'oldUserId':_0x3c446b};}_0x3dca04[_0x57004f(0x179)]=(0x0,moment_1[_0x57004f(0x1a0)])()[_0x57004f(0x182)](),_0x3dca04['rated']=![];}if(completionMessageControl[_0x57004f(0x198)]>=0x9c4)completionMessageControl=[];if(!(0x0,lodash_1['isNil'])(_0x23eddd)&&_0x23eddd!==''&&_0x138f98&&!_0x1544d1[_0x57004f(0x1d1)]){let _0x3cf753=completionMessageControl[_0x57004f(0x1df)](_0x36aea8=>_0x36aea8['ticketId']===_0x1544d1['id']||_0x36aea8[_0x57004f(0x19b)]===_0x1544d1['contact'][_0x57004f(0x189)]);if(!_0x3cf753||_0x3cf753&&_0x3cf753[_0x57004f(0x1e5)]+0x3e8*0x3c*0x1e<new Date()['getTime']()){_0x3cf753&&(completionMessageControl=completionMessageControl[_0x57004f(0x1cf)](_0x36230a=>_0x36230a['ticketId']!==_0x1544d1['id']),_0x3cf753=null);if(!_0x1544d1['contact'][_0x57004f(0x1d7)]&&!(0x0,lodash_1[_0x57004f(0x1a5)])(_0x23eddd)&&_0x23eddd!==''){const _0x234bf4='‎'+_0x23eddd;await(0x0,SendPresenceStatus_1['SendPresenceStatus'])((0x0,wbot_1['getWbot'])(_0x1544d1[_0x57004f(0x190)]),_0x1544d1[_0x57004f(0x1b6)]['number']+'@'+(_0x1544d1['isGroup']?_0x57004f(0x188):'s.whatsapp.net')),await(0x0,SendWhatsAppMessage_1[_0x57004f(0x1a0)])({'body':_0x234bf4,'ticket':_0x1544d1});}}!_0x3cf753&&completionMessageControl[_0x57004f(0x1e2)]({'ticketId':_0x1544d1['id'],'dest':_0x1544d1[_0x57004f(0x1b6)][_0x57004f(0x189)],'time':new Date()[_0x57004f(0x1aa)]()});}await _0x1544d1[_0x57004f(0x1ac)]({'promptId':null,'integrationId':null,'useIntegration':![],'typebotStatus':![],'typebotSessionId':null}),_0x3dca04[_0x57004f(0x1b0)]=(0x0,moment_1[_0x57004f(0x1a0)])()[_0x57004f(0x182)](),_0x3dca04[_0x57004f(0x190)]=_0x1544d1[_0x57004f(0x190)],_0x3dca04[_0x57004f(0x1ca)]=_0x1544d1['userId'];}_0x3c801a!==undefined&&_0x3c801a!==null&&(_0x3dca04[_0x57004f(0x1ad)]=(0x0,moment_1['default'])()['toDate']());const _0x4300cc=await(0x0,ListSettingsServiceOne_1[_0x57004f(0x1a0)])({'companyId':_0x1c16ac,'key':_0x57004f(0x1b3)}),_0x1b4c05=await Queue_1[_0x57004f(0x1a0)][_0x57004f(0x181)](_0x3c801a);if(_0x4300cc?.[_0x57004f(0x18c)]===_0x57004f(0x1ce)){if(_0x2a4385!==_0x3c801a&&_0x3c446b===_0x201cf9&&!(0x0,lodash_1['isNil'])(_0x2a4385)&&!(0x0,lodash_1['isNil'])(_0x3c801a)){const _0xd2e9f8=await(0x0,GetTicketWbot_1[_0x57004f(0x1a0)])(_0x1544d1),_0x457fd3='*Mensagem\x20automática*:\x0aVocê\x20foi\x20transferido\x20para\x20o\x20departamento\x20*'+_0x1b4c05?.[_0x57004f(0x1bd)]+'*\x0aaguarde,\x20já\x20vamos\x20te\x20atender!';await(0x0,SendPresenceStatus_1['SendPresenceStatus'])(_0xd2e9f8,_0x1544d1[_0x57004f(0x1b6)][_0x57004f(0x189)]+'@'+(_0x1544d1['isGroup']?'g.us':_0x57004f(0x1e9)));const _0x46ee48=await _0xd2e9f8[_0x57004f(0x1bb)](_0x1544d1[_0x57004f(0x1b6)][_0x57004f(0x189)]+'@'+(_0x1544d1['isGroup']?_0x57004f(0x188):_0x57004f(0x1e9)),{'text':_0x457fd3});await(0x0,wbotMessageListener_1[_0x57004f(0x1c7)])(_0x46ee48,_0x1544d1,_0x1544d1[_0x57004f(0x1b6)]);}else{if(_0x3c446b!==_0x201cf9&&_0x2a4385===_0x3c801a&&!(0x0,lodash_1['isNil'])(_0x3c446b)&&!(0x0,lodash_1['isNil'])(_0x201cf9)){const _0xa8d6b9=await(0x0,GetTicketWbot_1[_0x57004f(0x1a0)])(_0x1544d1),_0x4ee638=await(0x0,ShowUserService_1[_0x57004f(0x1a0)])(_0x17ef2c[_0x57004f(0x1ca)]),_0x458eab=_0x57004f(0x1ab)+_0x4ee638[_0x57004f(0x1bd)]+_0x57004f(0x17d)+_0x49fa58['username']+_0x57004f(0x1d6)+(0x0,moment_1[_0x57004f(0x1a0)])()[_0x57004f(0x1cd)](_0x57004f(0x197))+_0x57004f(0x1da);await(0x0,SendPresenceStatus_1[_0x57004f(0x1b7)])(_0xa8d6b9,_0x1544d1[_0x57004f(0x1b6)][_0x57004f(0x189)]+'@'+(_0x1544d1[_0x57004f(0x1d1)]?_0x57004f(0x188):_0x57004f(0x1e9)));const _0x5b56d3=await _0xa8d6b9[_0x57004f(0x1bb)](_0x1544d1['contact'][_0x57004f(0x189)]+'@'+(_0x1544d1[_0x57004f(0x1d1)]?_0x57004f(0x188):_0x57004f(0x1e9)),{'text':_0x458eab});await(0x0,wbotMessageListener_1[_0x57004f(0x1c7)])(_0x5b56d3,_0x1544d1,_0x1544d1['contact']);}else{if(_0x3c446b!==_0x201cf9&&!(0x0,lodash_1[_0x57004f(0x1a5)])(_0x3c446b)&&!(0x0,lodash_1[_0x57004f(0x1a5)])(_0x201cf9)&&_0x2a4385!==_0x3c801a&&!(0x0,lodash_1[_0x57004f(0x1a5)])(_0x2a4385)&&!(0x0,lodash_1['isNil'])(_0x3c801a)){const _0x89ae92=await(0x0,GetTicketWbot_1['default'])(_0x1544d1),_0x341a9f=await(0x0,ShowUserService_1[_0x57004f(0x1a0)])(_0x17ef2c[_0x57004f(0x1ca)]),_0x53351a=await(0x0,ShowUserService_1[_0x57004f(0x1a0)])(_0x3c446b),_0x191f7d='*Mensagem\x20automática*:\x0aVocê\x20foi\x20transferido\x20para\x20o\x20departamento\x20*'+_0x1b4c05?.['name']+_0x57004f(0x17c)+_0x341a9f[_0x57004f(0x1bd)]+_0x57004f(0x1d4)+_0x49fa58[_0x57004f(0x1bc)]+'\x20em\x20'+(0x0,moment_1[_0x57004f(0x1a0)])()['format'](_0x57004f(0x197))+_0x57004f(0x1b5);await(0x0,SendPresenceStatus_1[_0x57004f(0x1b7)])(_0x89ae92,_0x1544d1['contact'][_0x57004f(0x189)]+'@'+(_0x1544d1[_0x57004f(0x1d1)]?_0x57004f(0x188):_0x57004f(0x1e9)));const _0x4c60a0=await _0x89ae92[_0x57004f(0x1bb)](_0x1544d1[_0x57004f(0x1b6)]['number']+'@'+(_0x1544d1[_0x57004f(0x1d1)]?_0x57004f(0x188):'s.whatsapp.net'),{'text':_0x191f7d});await(0x0,wbotMessageListener_1[_0x57004f(0x1c7)])(_0x4c60a0,_0x1544d1,_0x1544d1[_0x57004f(0x1b6)]);const _0x3406b1=await(0x0,ShowUserService_1[_0x57004f(0x1a0)])(_0x201cf9),_0x6240d5='*Mensagem\x20automática*:\x0aO\x20atendente\x20anterior\x20*'+_0x53351a[_0x57004f(0x1bd)]+_0x57004f(0x1e7)+_0x341a9f[_0x57004f(0x1bd)]+_0x57004f(0x1d3)+(0x0,moment_1[_0x57004f(0x1a0)])()['format'](_0x57004f(0x197))+_0x57004f(0x1b5);await(0x0,SendPresenceStatus_1[_0x57004f(0x1b7)])(_0x89ae92,_0x1544d1[_0x57004f(0x1b6)][_0x57004f(0x189)]+'@'+(_0x1544d1[_0x57004f(0x1d1)]?_0x57004f(0x188):'s.whatsapp.net'));const _0x384194=await _0x89ae92[_0x57004f(0x1bb)](_0x1544d1[_0x57004f(0x1b6)][_0x57004f(0x189)]+'@'+(_0x1544d1['isGroup']?'g.us':_0x57004f(0x1e9)),{'text':_0x6240d5});await(0x0,wbotMessageListener_1[_0x57004f(0x1c7)])(_0x384194,_0x1544d1,_0x1544d1[_0x57004f(0x1b6)]);}else{if(_0x3c446b!==undefined&&(0x0,lodash_1[_0x57004f(0x1a5)])(_0x201cf9)&&_0x2a4385!==_0x3c801a&&!(0x0,lodash_1[_0x57004f(0x1a5)])(_0x3c801a)){const _0x310309=await(0x0,GetTicketWbot_1[_0x57004f(0x1a0)])(_0x1544d1),_0x2d9875='*Mensagem\x20automática*:\x0aVocê\x20foi\x20transferido\x20para\x20o\x20departamento\x20*'+_0x1b4c05?.['name']+_0x57004f(0x17b);await(0x0,SendPresenceStatus_1[_0x57004f(0x1b7)])(_0x310309,_0x1544d1[_0x57004f(0x1b6)][_0x57004f(0x189)]+'@'+(_0x1544d1[_0x57004f(0x1d1)]?_0x57004f(0x188):_0x57004f(0x1e9)));const _0x152eda=await _0x310309[_0x57004f(0x1bb)](_0x1544d1[_0x57004f(0x1b6)][_0x57004f(0x189)]+'@'+(_0x1544d1[_0x57004f(0x1d1)]?'g.us':_0x57004f(0x1e9)),{'text':_0x2d9875});await(0x0,wbotMessageListener_1[_0x57004f(0x1c7)])(_0x152eda,_0x1544d1,_0x1544d1[_0x57004f(0x1b6)]);}}}}}var _0x4622f9=_0x2a4385!==_0x3c801a;return _0x1b4c05&&(_0x4622f9&&_0x1b4c05['newTicketOnTransfer']&&(_0x200dc3=_0x57004f(0x1b8))),await _0x1544d1['update']({'amountUsedBotQueues':_0x17ef2c[_0x57004f(0x1cb)]||0x0,'status':_0x200dc3,'unreadMessages':_0x17ef2c['unreadMessages']||0x0,'queueId':_0x3c801a,'userId':_0x201cf9,'whatsappId':_0x3250b9,'chatbot':_0x49fef9,'queueOptionId':_0x23197a}),await _0x1544d1[_0x57004f(0x18a)](),_0x1b4c05&&_0x4622f9&&_0x1b4c05[_0x57004f(0x1ea)]&&!_0x1544d1[_0x57004f(0x1d9)]&&!_0x1544d1['useIntegration']&&(_0x23e7d0['to'](_0x57004f(0x178)+_0x1544d1[_0x57004f(0x1c5)]+'-'+_0x2975a3)['to'](_0x57004f(0x18b)+_0x1544d1[_0x57004f(0x192)]+'-'+_0x2975a3)[_0x57004f(0x194)](_0x57004f(0x178)+_0x1c16ac+_0x57004f(0x1e4),{'action':_0x57004f(0x1a3),'ticketId':_0x1544d1['id']}),_0x23e7d0['to'](_0x57004f(0x178)+_0x1544d1[_0x57004f(0x1c5)]+'-'+_0x1544d1[_0x57004f(0x19a)])['to'](_0x57004f(0x178)+_0x1544d1[_0x57004f(0x1c5)]+_0x57004f(0x1a7))['to'](_0x57004f(0x18b)+_0x1544d1[_0x57004f(0x192)]+'-notification')['to']('queue-'+_0x1544d1[_0x57004f(0x192)]+'-'+_0x1544d1[_0x57004f(0x19a)])['to'](_0x19d7bf['toString']())['emit'](_0x57004f(0x178)+_0x1c16ac+_0x57004f(0x1e4),{'action':_0x57004f(0x1ac),'ticket':_0x1544d1}),_0x1544d1=await Ticket_1['default'][_0x57004f(0x1ed)]({'companyId':_0x1c16ac,'contactId':_0x1544d1[_0x57004f(0x1b1)],'userId':_0x201cf9,'queueId':_0x3c801a,'status':_0x57004f(0x1a1),'whatsappId':_0x1544d1[_0x57004f(0x190)],'chatbot':_0x49fef9,'queueOptionId':_0x23197a,'promptId':_0x5badd7,'useIntegration':_0x3c751c,'integrationId':_0x2904cb,'amountUsedBotQueues':0x0,'unreadMessages':0x0})),_0x200dc3=_0x1544d1[_0x57004f(0x19a)],_0x200dc3===_0x57004f(0x1a1)&&(_0x3dca04[_0x57004f(0x1ac)]({'whatsappId':_0x3250b9,'queuedAt':(0x0,moment_1['default'])()[_0x57004f(0x182)](),'startedAt':null,'userId':null}),_0x23e7d0['to'](_0x57004f(0x178)+_0x1c16ac+_0x57004f(0x17a))['emit'](_0x57004f(0x178)+_0x1c16ac+_0x57004f(0x1e4),{'action':_0x57004f(0x193),'ticketId':_0x1544d1?.['id']})),_0x200dc3==='open'&&(_0x3dca04[_0x57004f(0x1ac)]({'startedAt':(0x0,moment_1[_0x57004f(0x1a0)])()['toDate'](),'ratingAt':null,'rated':![],'whatsappId':_0x3250b9,'userId':_0x1544d1[_0x57004f(0x1ca)]}),_0x23e7d0['to'](_0x57004f(0x178)+_0x1c16ac+_0x57004f(0x17a))[_0x57004f(0x194)](_0x57004f(0x178)+_0x1c16ac+'-ticket',{'action':_0x57004f(0x193),'ticketId':_0x1544d1?.['id']}),_0x23e7d0['to']('company-'+_0x1c16ac+'-mainchannel')[_0x57004f(0x194)](_0x57004f(0x178)+_0x1c16ac+_0x57004f(0x1e4),{'action':_0x57004f(0x19d),'ticketId':_0x1544d1?.['id']})),await _0x3dca04[_0x57004f(0x1a2)](),(_0x1544d1['status']!==_0x2975a3||_0x1544d1[_0x57004f(0x1d8)]?.['id']!==_0x3c446b||_0x4622f9)&&_0x23e7d0['to'](_0x57004f(0x178)+_0x1544d1['companyId']+'-'+_0x2975a3)['to'](_0x57004f(0x18b)+_0x1544d1[_0x57004f(0x192)]+'-'+_0x2975a3)['to'](_0x57004f(0x178)+_0x1544d1[_0x57004f(0x1c5)]+_0x57004f(0x1a7))['to'](_0x57004f(0x18b)+_0x1544d1[_0x57004f(0x192)]+_0x57004f(0x1a7))['to'](_0x19d7bf[_0x57004f(0x19f)]())[_0x57004f(0x194)](_0x57004f(0x178)+_0x1c16ac+_0x57004f(0x1e4),{'action':_0x57004f(0x1a3),'ticketId':_0x1544d1['id']}),_0x1544d1['status']!==_0x57004f(0x1b8)&&_0x23e7d0['to'](_0x57004f(0x178)+_0x1544d1[_0x57004f(0x1c5)]+'-'+_0x1544d1['status'])['to'](_0x57004f(0x178)+_0x1544d1[_0x57004f(0x1c5)]+_0x57004f(0x1a7))['to'](_0x57004f(0x18b)+_0x1544d1[_0x57004f(0x192)]+_0x57004f(0x1a7))['to'](_0x57004f(0x18b)+_0x1544d1[_0x57004f(0x192)]+'-'+_0x1544d1[_0x57004f(0x19a)])['to'](_0x19d7bf[_0x57004f(0x19f)]())[_0x57004f(0x194)](_0x57004f(0x178)+_0x1c16ac+_0x57004f(0x1e4),{'action':'update','ticket':_0x1544d1}),{'ticket':_0x1544d1,'oldStatus':_0x2975a3,'oldUserId':_0x3c446b};}catch(_0x263b25){console[_0x57004f(0x1c0)](_0x263b25),Sentry[_0x57004f(0x1bf)](_0x263b25);}};exports[a528_0x5086d3(0x1a0)]=UpdateTicketService;const notifyUpdate=(_0x1dfc16,_0x283f45,_0x55c016,_0x2374da)=>{const _0x3e47aa=a528_0x5086d3;_0x1dfc16['to'](_0x3e47aa(0x178)+_0x283f45[_0x3e47aa(0x1c5)]+'-'+_0x283f45['status'])['to']('company-'+_0x283f45[_0x3e47aa(0x1c5)]+'-notification')['to'](_0x55c016[_0x3e47aa(0x19f)]())[_0x3e47aa(0x194)](_0x3e47aa(0x178)+_0x2374da+_0x3e47aa(0x1e4),{'action':_0x3e47aa(0x1ac),'ticket':_0x283f45});};exports['notifyUpdate']=notifyUpdate;