const a552_0x591653=a552_0x226d;function a552_0x4c57(){const _0x5eff29=['create','length','3412003wintyJ','findOne','autoReopenTimeout','toString','__importDefault','12652410xHmMrS','./ShowTicketService','5634477UHgHhJ','../../helpers/CheckSettings','acquire','35271NDWFrP','10VyPhHX','constructor','sequelize','1575312hdEfpN','default','findByPk','userId','../../models/User','GetCompanySetting','search','transaction','__esModule','6501480UwIPrm','subMinutes','(((.+)+)+)+$','6204528QFezcf','whatsappId','queues','DESC','12ydNMrN','update','./FindOrCreateATicketTrakingService','4zvVJVJ','Mutex','open','../../models/Company','updatedAt','pending','between','date-fns'];a552_0x4c57=function(){return _0x5eff29;};return a552_0x4c57();}(function(_0x4cecce,_0x54fdf6){const _0x348b28=a552_0x226d,_0xc09c10=_0x4cecce();while(!![]){try{const _0x598324=-parseInt(_0x348b28(0x77))/0x1*(-parseInt(_0x348b28(0x78))/0x2)+parseInt(_0x348b28(0x7b))/0x3+-parseInt(_0x348b28(0x8e))/0x4*(-parseInt(_0x348b28(0x84))/0x5)+-parseInt(_0x348b28(0x8b))/0x6*(parseInt(_0x348b28(0x6d))/0x7)+-parseInt(_0x348b28(0x87))/0x8+-parseInt(_0x348b28(0x74))/0x9+parseInt(_0x348b28(0x72))/0xa;if(_0x598324===_0x54fdf6)break;else _0xc09c10['push'](_0xc09c10['shift']());}catch(_0x414aae){_0xc09c10['push'](_0xc09c10['shift']());}}}(a552_0x4c57,0xd9697));const a552_0x91a78b=(function(){let _0x349afe=!![];return function(_0x3cbcaf,_0x19a33a){const _0x325e43=_0x349afe?function(){if(_0x19a33a){const _0x4369e5=_0x19a33a['apply'](_0x3cbcaf,arguments);return _0x19a33a=null,_0x4369e5;}}:function(){};return _0x349afe=![],_0x325e43;};}()),a552_0x3b15e9=a552_0x91a78b(this,function(){const _0x46723d=a552_0x226d;return a552_0x3b15e9['toString']()[_0x46723d(0x81)](_0x46723d(0x86))[_0x46723d(0x70)]()[_0x46723d(0x79)](a552_0x3b15e9)[_0x46723d(0x81)](_0x46723d(0x86));});a552_0x3b15e9();'use strict';var __importDefault=this&&this[a552_0x591653(0x71)]||function(_0x16e885){const _0x1b8971=a552_0x591653;return _0x16e885&&_0x16e885[_0x1b8971(0x83)]?_0x16e885:{'default':_0x16e885};};Object['defineProperty'](exports,'__esModule',{'value':!![]});function a552_0x226d(_0x942230,_0x444c6b){const _0x4281a1=a552_0x4c57();return a552_0x226d=function(_0x3b15e9,_0x91a78b){_0x3b15e9=_0x3b15e9-0x69;let _0x4c5734=_0x4281a1[_0x3b15e9];return _0x4c5734;},a552_0x226d(_0x942230,_0x444c6b);}const date_fns_1=require(a552_0x591653(0x6a)),sequelize_1=require(a552_0x591653(0x7a)),async_mutex_1=require('async-mutex'),Ticket_1=__importDefault(require('../../models/Ticket')),ShowTicketService_1=__importDefault(require(a552_0x591653(0x73))),FindOrCreateATicketTrakingService_1=__importDefault(require(a552_0x591653(0x8d))),CheckSettings_1=require(a552_0x591653(0x75)),database_1=__importDefault(require('../../database')),Whatsapp_1=__importDefault(require('../../models/Whatsapp')),User_1=__importDefault(require(a552_0x591653(0x7f))),Company_1=__importDefault(require(a552_0x591653(0x91))),createTicketMutex=new async_mutex_1[(a552_0x591653(0x8f))](),internalFindOrCreateTicketService=async(_0x543dcc,_0x4630c3,_0x1504a0,_0x12fcd8,_0x16471f,_0x423b07,_0x3e12f5)=>{const _0x47580b=a552_0x591653;let _0xb0144a=![];const _0x478257=await database_1[_0x47580b(0x7c)][_0x47580b(0x82)](async()=>{const _0x435ccb=_0x47580b;let _0x589196=await Ticket_1[_0x435ccb(0x7c)][_0x435ccb(0x6e)]({'where':{'status':{[sequelize_1['Op']['or']]:[_0x435ccb(0x90),_0x435ccb(0x93)]},'contactId':_0x16471f?_0x16471f['id']:_0x543dcc['id'],'whatsappId':_0x4630c3},'order':[['id',_0x435ccb(0x8a)]],'include':[{'model':User_1['default']},{'model':Company_1[_0x435ccb(0x7c)]}]});_0x589196&&await _0x589196[_0x435ccb(0x8c)]({'unreadMessages':_0x1504a0});!_0x589196&&_0x16471f&&(_0x589196=await Ticket_1[_0x435ccb(0x7c)][_0x435ccb(0x6e)]({'where':{'contactId':_0x16471f['id'],'whatsappId':_0x4630c3},'order':[[_0x435ccb(0x92),_0x435ccb(0x8a)]],'include':[{'model':User_1[_0x435ccb(0x7c)]},{'model':Company_1['default']}]}),_0x589196&&(await _0x589196[_0x435ccb(0x8c)]({'status':_0x435ccb(0x93),'userId':null,'unreadMessages':_0x1504a0,'companyId':_0x12fcd8}),await(0x0,FindOrCreateATicketTrakingService_1[_0x435ccb(0x7c)])({'ticketId':_0x589196['id'],'companyId':_0x12fcd8,'whatsappId':_0x589196['whatsappId'],'userId':_0x589196['userId']})));if(!_0x423b07&&!_0x589196&&!_0x16471f){const _0x2e35bf=parseInt(await(0x0,CheckSettings_1[_0x435ccb(0x80)])(_0x12fcd8,_0x435ccb(0x6f),'0'),0xa);_0x589196=_0x2e35bf&&await Ticket_1['default'][_0x435ccb(0x6e)]({'where':{'updatedAt':{[sequelize_1['Op'][_0x435ccb(0x69)]]:[+(0x0,date_fns_1[_0x435ccb(0x85)])(new Date(),_0x2e35bf),+new Date()]},'contactId':_0x543dcc['id'],'whatsappId':_0x4630c3},'order':[['updatedAt',_0x435ccb(0x8a)]],'include':[{'model':User_1['default']},{'model':Company_1[_0x435ccb(0x7c)]}]}),_0x589196&&(await _0x589196[_0x435ccb(0x8c)]({'status':_0x435ccb(0x93),'userId':null,'unreadMessages':_0x1504a0,'companyId':_0x12fcd8}),await(0x0,FindOrCreateATicketTrakingService_1[_0x435ccb(0x7c)])({'ticketId':_0x589196['id'],'companyId':_0x12fcd8,'whatsappId':_0x589196[_0x435ccb(0x88)],'userId':_0x589196[_0x435ccb(0x7e)]}));}let _0x205988=_0x3e12f5?.['id']||null;if(_0x16471f){const _0x1193ce=await Whatsapp_1[_0x435ccb(0x7c)][_0x435ccb(0x7d)](_0x4630c3,{'include':[_0x435ccb(0x89)]});_0x1193ce?.[_0x435ccb(0x89)][_0x435ccb(0x6c)]===0x1&&(_0x205988=_0x1193ce[_0x435ccb(0x89)][0x0]['id']);}return!_0x589196&&(_0x589196=await Ticket_1[_0x435ccb(0x7c)][_0x435ccb(0x6b)]({'contactId':_0x16471f?_0x16471f['id']:_0x543dcc['id'],'status':_0x435ccb(0x93),'isGroup':!!_0x16471f,'unreadMessages':_0x1504a0,'whatsappId':_0x4630c3,'queueId':_0x205988,'companyId':_0x12fcd8}),_0xb0144a=!![],await(0x0,FindOrCreateATicketTrakingService_1[_0x435ccb(0x7c)])({'ticketId':_0x589196['id'],'companyId':_0x12fcd8,'whatsappId':_0x4630c3,'userId':_0x589196[_0x435ccb(0x7e)]})),_0x589196=await(0x0,ShowTicketService_1[_0x435ccb(0x7c)])(_0x589196['id'],_0x12fcd8),{'ticket':_0x589196,'justCreated':_0xb0144a};});return _0x478257;},FindOrCreateTicketService=async(_0x4ef2a5,_0x43638d,_0x5c4296,_0x2c6dfb,_0x25eb0b,_0x2e592d,_0x301957)=>{const _0x356841=a552_0x591653,_0x3d49b1=await createTicketMutex[_0x356841(0x76)]();try{return await internalFindOrCreateTicketService(_0x4ef2a5,_0x43638d,_0x5c4296,_0x2c6dfb,_0x25eb0b,_0x2e592d,_0x301957);}finally{_0x3d49b1();}};exports[a552_0x591653(0x7c)]=FindOrCreateTicketService;