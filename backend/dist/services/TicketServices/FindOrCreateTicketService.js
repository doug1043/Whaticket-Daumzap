function a554_0x1a5b(){const _0x5ccc99=['open','./ShowTicketService','constructor','length','pending','114YYPRAI','257826yaxGVZ','../../models/Company','(((.+)+)+)+$','transaction','315366pooqaY','../../models/Ticket','DESC','queues','async-mutex','462seMrPI','toString','subMinutes','2ryZHBo','search','default','findOne','between','../../helpers/CheckSettings','49190IzfhLG','whatsappId','__esModule','447304bBKqKI','101255XcFxsq','apply','1108836jyiOmD','836ijkmjX','update','create','48856DQrPoV','GetCompanySetting','date-fns','userId'];a554_0x1a5b=function(){return _0x5ccc99;};return a554_0x1a5b();}function a554_0x3a19(_0x2c7237,_0x5aba2b){const _0x279948=a554_0x1a5b();return a554_0x3a19=function(_0x4f9826,_0x17fa75){_0x4f9826=_0x4f9826-0x1c8;let _0x1a5bab=_0x279948[_0x4f9826];return _0x1a5bab;},a554_0x3a19(_0x2c7237,_0x5aba2b);}const a554_0x6e50fa=a554_0x3a19;(function(_0x335a58,_0x161e94){const _0x4bdbb8=a554_0x3a19,_0x5e8524=_0x335a58();while(!![]){try{const _0xbc1141=-parseInt(_0x4bdbb8(0x1eb))/0x1*(parseInt(_0x4bdbb8(0x1cd))/0x2)+-parseInt(_0x4bdbb8(0x1e7))/0x3+parseInt(_0x4bdbb8(0x1d6))/0x4+-parseInt(_0x4bdbb8(0x1d7))/0x5*(parseInt(_0x4bdbb8(0x1e6))/0x6)+-parseInt(_0x4bdbb8(0x1ca))/0x7*(-parseInt(_0x4bdbb8(0x1dd))/0x8)+parseInt(_0x4bdbb8(0x1d9))/0x9+-parseInt(_0x4bdbb8(0x1d3))/0xa*(-parseInt(_0x4bdbb8(0x1da))/0xb);if(_0xbc1141===_0x161e94)break;else _0x5e8524['push'](_0x5e8524['shift']());}catch(_0x570d02){_0x5e8524['push'](_0x5e8524['shift']());}}}(a554_0x1a5b,0x37243));const a554_0x17fa75=(function(){let _0x8724b2=!![];return function(_0x4ae558,_0x14da67){const _0x274cf5=_0x8724b2?function(){const _0x3b4041=a554_0x3a19;if(_0x14da67){const _0x252161=_0x14da67[_0x3b4041(0x1d8)](_0x4ae558,arguments);return _0x14da67=null,_0x252161;}}:function(){};return _0x8724b2=![],_0x274cf5;};}()),a554_0x4f9826=a554_0x17fa75(this,function(){const _0x1a09a4=a554_0x3a19;return a554_0x4f9826[_0x1a09a4(0x1cb)]()[_0x1a09a4(0x1ce)](_0x1a09a4(0x1e9))[_0x1a09a4(0x1cb)]()[_0x1a09a4(0x1e3)](a554_0x4f9826)['search'](_0x1a09a4(0x1e9));});a554_0x4f9826();'use strict';var __importDefault=this&&this['__importDefault']||function(_0x4b6eaa){const _0x2bdf37=a554_0x3a19;return _0x4b6eaa&&_0x4b6eaa[_0x2bdf37(0x1d5)]?_0x4b6eaa:{'default':_0x4b6eaa};};Object['defineProperty'](exports,a554_0x6e50fa(0x1d5),{'value':!![]});const date_fns_1=require(a554_0x6e50fa(0x1df)),sequelize_1=require('sequelize'),async_mutex_1=require(a554_0x6e50fa(0x1c9)),Ticket_1=__importDefault(require(a554_0x6e50fa(0x1ec))),ShowTicketService_1=__importDefault(require(a554_0x6e50fa(0x1e2))),FindOrCreateATicketTrakingService_1=__importDefault(require('./FindOrCreateATicketTrakingService')),CheckSettings_1=require(a554_0x6e50fa(0x1d2)),database_1=__importDefault(require('../../database')),Whatsapp_1=__importDefault(require('../../models/Whatsapp')),User_1=__importDefault(require('../../models/User')),Company_1=__importDefault(require(a554_0x6e50fa(0x1e8))),createTicketMutex=new async_mutex_1['Mutex'](),internalFindOrCreateTicketService=async(_0x32f4ad,_0x304119,_0x238a2e,_0x1f798b,_0x37a4e1,_0x3d3839,_0x4b5e7a)=>{const _0x3376a8=a554_0x6e50fa;let _0x2a98b0=![];const _0x427cea=await database_1[_0x3376a8(0x1cf)][_0x3376a8(0x1ea)](async()=>{const _0x39a334=_0x3376a8;let _0x47451d=await Ticket_1['default']['findOne']({'where':{'status':{[sequelize_1['Op']['or']]:[_0x39a334(0x1e1),_0x39a334(0x1e5)]},'contactId':_0x37a4e1?_0x37a4e1['id']:_0x32f4ad['id'],'whatsappId':_0x304119},'order':[['id',_0x39a334(0x1ed)]],'include':[{'model':User_1[_0x39a334(0x1cf)]},{'model':Company_1[_0x39a334(0x1cf)]}]});_0x47451d&&await _0x47451d[_0x39a334(0x1db)]({'unreadMessages':_0x238a2e});!_0x47451d&&_0x37a4e1&&(_0x47451d=await Ticket_1[_0x39a334(0x1cf)]['findOne']({'where':{'contactId':_0x37a4e1['id'],'whatsappId':_0x304119},'order':[['updatedAt',_0x39a334(0x1ed)]],'include':[{'model':User_1[_0x39a334(0x1cf)]},{'model':Company_1[_0x39a334(0x1cf)]}]}),_0x47451d&&(await _0x47451d[_0x39a334(0x1db)]({'status':_0x39a334(0x1e5),'userId':null,'unreadMessages':_0x238a2e,'companyId':_0x1f798b}),await(0x0,FindOrCreateATicketTrakingService_1[_0x39a334(0x1cf)])({'ticketId':_0x47451d['id'],'companyId':_0x1f798b,'whatsappId':_0x47451d[_0x39a334(0x1d4)],'userId':_0x47451d[_0x39a334(0x1e0)]})));if(!_0x3d3839&&!_0x47451d&&!_0x37a4e1){const _0xa53ffc=parseInt(await(0x0,CheckSettings_1[_0x39a334(0x1de)])(_0x1f798b,'autoReopenTimeout','0'),0xa);_0x47451d=_0xa53ffc&&await Ticket_1['default'][_0x39a334(0x1d0)]({'where':{'updatedAt':{[sequelize_1['Op'][_0x39a334(0x1d1)]]:[+(0x0,date_fns_1[_0x39a334(0x1cc)])(new Date(),_0xa53ffc),+new Date()]},'contactId':_0x32f4ad['id'],'whatsappId':_0x304119},'order':[['updatedAt',_0x39a334(0x1ed)]],'include':[{'model':User_1['default']},{'model':Company_1[_0x39a334(0x1cf)]}]}),_0x47451d&&(await _0x47451d[_0x39a334(0x1db)]({'status':_0x39a334(0x1e5),'userId':null,'unreadMessages':_0x238a2e,'companyId':_0x1f798b}),await(0x0,FindOrCreateATicketTrakingService_1[_0x39a334(0x1cf)])({'ticketId':_0x47451d['id'],'companyId':_0x1f798b,'whatsappId':_0x47451d[_0x39a334(0x1d4)],'userId':_0x47451d[_0x39a334(0x1e0)]}));}let _0x1eda14=_0x4b5e7a?.['id']||null;if(_0x37a4e1){const _0x28226d=await Whatsapp_1['default']['findByPk'](_0x304119,{'include':[_0x39a334(0x1c8)]});_0x28226d?.[_0x39a334(0x1c8)][_0x39a334(0x1e4)]===0x1&&(_0x1eda14=_0x28226d[_0x39a334(0x1c8)][0x0]['id']);}return!_0x47451d&&(_0x47451d=await Ticket_1[_0x39a334(0x1cf)][_0x39a334(0x1dc)]({'contactId':_0x37a4e1?_0x37a4e1['id']:_0x32f4ad['id'],'status':_0x39a334(0x1e5),'isGroup':!!_0x37a4e1,'unreadMessages':_0x238a2e,'whatsappId':_0x304119,'queueId':_0x1eda14,'companyId':_0x1f798b}),_0x2a98b0=!![],await(0x0,FindOrCreateATicketTrakingService_1[_0x39a334(0x1cf)])({'ticketId':_0x47451d['id'],'companyId':_0x1f798b,'whatsappId':_0x304119,'userId':_0x47451d[_0x39a334(0x1e0)]})),_0x47451d=await(0x0,ShowTicketService_1[_0x39a334(0x1cf)])(_0x47451d['id'],_0x1f798b),{'ticket':_0x47451d,'justCreated':_0x2a98b0};});return _0x427cea;},FindOrCreateTicketService=async(_0x3545b0,_0x2740da,_0x10eaa8,_0x4de31d,_0x11fd62,_0x1db886,_0x314677)=>{const _0x230e46=await createTicketMutex['acquire']();try{return await internalFindOrCreateTicketService(_0x3545b0,_0x2740da,_0x10eaa8,_0x4de31d,_0x11fd62,_0x1db886,_0x314677);}finally{_0x230e46();}};exports[a554_0x6e50fa(0x1cf)]=FindOrCreateTicketService;