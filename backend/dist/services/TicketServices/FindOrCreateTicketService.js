const a557_0x3a51b4=a557_0x2839;function a557_0x2839(_0x539a27,_0x4ddaab){const _0x40b563=a557_0x5463();return a557_0x2839=function(_0x4a3464,_0x931b2c){_0x4a3464=_0x4a3464-0xdf;let _0x5463a4=_0x40b563[_0x4a3464];return _0x5463a4;},a557_0x2839(_0x539a27,_0x4ddaab);}(function(_0x586ed2,_0xae6e78){const _0x4a1d91=a557_0x2839,_0x55611b=_0x586ed2();while(!![]){try{const _0x2c263c=parseInt(_0x4a1d91(0xe6))/0x1*(-parseInt(_0x4a1d91(0xfb))/0x2)+parseInt(_0x4a1d91(0xf1))/0x3*(parseInt(_0x4a1d91(0xef))/0x4)+-parseInt(_0x4a1d91(0x100))/0x5*(parseInt(_0x4a1d91(0x107))/0x6)+parseInt(_0x4a1d91(0xf9))/0x7+parseInt(_0x4a1d91(0xee))/0x8*(parseInt(_0x4a1d91(0xf3))/0x9)+parseInt(_0x4a1d91(0xdf))/0xa*(-parseInt(_0x4a1d91(0xe9))/0xb)+-parseInt(_0x4a1d91(0xf7))/0xc*(-parseInt(_0x4a1d91(0xff))/0xd);if(_0x2c263c===_0xae6e78)break;else _0x55611b['push'](_0x55611b['shift']());}catch(_0x9b58a9){_0x55611b['push'](_0x55611b['shift']());}}}(a557_0x5463,0xb4526));function a557_0x5463(){const _0x3553a5=['../../database','9POelvC','length','acquire','findOne','11177316KClMUC','__esModule','3923521HVJFvA','sequelize','7678HeVRmI','toString','DESC','(((.+)+)+)+$','13rdBAAV','5xfGyxz','queues','GetCompanySetting','../../models/Whatsapp','subMinutes','userId','updatedAt','4961346KCITHY','autoReopenTimeout','70lxjVDZ','update','pending','date-fns','create','search','__importDefault','359gNOcrO','../../models/Company','./FindOrCreateATicketTrakingService','445159AcYaiZ','default','./ShowTicketService','findByPk','whatsappId','11224072VfNHnP','8CcOvbZ','../../models/User','498027sgCgwI'];a557_0x5463=function(){return _0x3553a5;};return a557_0x5463();}const a557_0x931b2c=(function(){let _0x4b8145=!![];return function(_0x33f0d5,_0x204933){const _0x31ad66=_0x4b8145?function(){if(_0x204933){const _0x50b325=_0x204933['apply'](_0x33f0d5,arguments);return _0x204933=null,_0x50b325;}}:function(){};return _0x4b8145=![],_0x31ad66;};}()),a557_0x4a3464=a557_0x931b2c(this,function(){const _0x8767c0=a557_0x2839;return a557_0x4a3464[_0x8767c0(0xfc)]()[_0x8767c0(0xe4)](_0x8767c0(0xfe))['toString']()['constructor'](a557_0x4a3464)[_0x8767c0(0xe4)](_0x8767c0(0xfe));});a557_0x4a3464();'use strict';var __importDefault=this&&this[a557_0x3a51b4(0xe5)]||function(_0x5b1211){const _0x371de3=a557_0x3a51b4;return _0x5b1211&&_0x5b1211[_0x371de3(0xf8)]?_0x5b1211:{'default':_0x5b1211};};Object['defineProperty'](exports,a557_0x3a51b4(0xf8),{'value':!![]});const date_fns_1=require(a557_0x3a51b4(0xe2)),sequelize_1=require(a557_0x3a51b4(0xfa)),async_mutex_1=require('async-mutex'),Ticket_1=__importDefault(require('../../models/Ticket')),ShowTicketService_1=__importDefault(require(a557_0x3a51b4(0xeb))),FindOrCreateATicketTrakingService_1=__importDefault(require(a557_0x3a51b4(0xe8))),CheckSettings_1=require('../../helpers/CheckSettings'),database_1=__importDefault(require(a557_0x3a51b4(0xf2))),Whatsapp_1=__importDefault(require(a557_0x3a51b4(0x103))),User_1=__importDefault(require(a557_0x3a51b4(0xf0))),Company_1=__importDefault(require(a557_0x3a51b4(0xe7))),createTicketMutex=new async_mutex_1['Mutex'](),internalFindOrCreateTicketService=async(_0xda3ff4,_0x13b8a8,_0x44b7f6,_0x5d6eee,_0x101dcf,_0x3e4b4e,_0x27418d)=>{const _0x320753=a557_0x3a51b4;let _0x32282a=![];const _0x3d40a3=await database_1[_0x320753(0xea)]['transaction'](async()=>{const _0x2548dd=_0x320753;let _0x2f44d6=await Ticket_1[_0x2548dd(0xea)][_0x2548dd(0xf6)]({'where':{'status':{[sequelize_1['Op']['or']]:['open',_0x2548dd(0xe1)]},'contactId':_0x101dcf?_0x101dcf['id']:_0xda3ff4['id'],'whatsappId':_0x13b8a8},'order':[['id',_0x2548dd(0xfd)]],'include':[{'model':User_1['default']},{'model':Company_1['default']}]});_0x2f44d6&&await _0x2f44d6['update']({'unreadMessages':_0x44b7f6});!_0x2f44d6&&_0x101dcf&&(_0x2f44d6=await Ticket_1[_0x2548dd(0xea)][_0x2548dd(0xf6)]({'where':{'contactId':_0x101dcf['id'],'whatsappId':_0x13b8a8},'order':[[_0x2548dd(0x106),_0x2548dd(0xfd)]],'include':[{'model':User_1[_0x2548dd(0xea)]},{'model':Company_1[_0x2548dd(0xea)]}]}),_0x2f44d6&&(await _0x2f44d6[_0x2548dd(0xe0)]({'status':'pending','userId':null,'unreadMessages':_0x44b7f6,'companyId':_0x5d6eee}),await(0x0,FindOrCreateATicketTrakingService_1[_0x2548dd(0xea)])({'ticketId':_0x2f44d6['id'],'companyId':_0x5d6eee,'whatsappId':_0x2f44d6[_0x2548dd(0xed)],'userId':_0x2f44d6[_0x2548dd(0x105)]})));if(!_0x3e4b4e&&!_0x2f44d6&&!_0x101dcf){const _0xe7ee7b=parseInt(await(0x0,CheckSettings_1[_0x2548dd(0x102)])(_0x5d6eee,_0x2548dd(0x108),'0'),0xa);_0x2f44d6=_0xe7ee7b&&await Ticket_1[_0x2548dd(0xea)][_0x2548dd(0xf6)]({'where':{'updatedAt':{[sequelize_1['Op']['between']]:[+(0x0,date_fns_1[_0x2548dd(0x104)])(new Date(),_0xe7ee7b),+new Date()]},'contactId':_0xda3ff4['id'],'whatsappId':_0x13b8a8},'order':[[_0x2548dd(0x106),'DESC']],'include':[{'model':User_1['default']},{'model':Company_1[_0x2548dd(0xea)]}]}),_0x2f44d6&&(await _0x2f44d6['update']({'status':_0x2548dd(0xe1),'userId':null,'unreadMessages':_0x44b7f6,'companyId':_0x5d6eee}),await(0x0,FindOrCreateATicketTrakingService_1[_0x2548dd(0xea)])({'ticketId':_0x2f44d6['id'],'companyId':_0x5d6eee,'whatsappId':_0x2f44d6[_0x2548dd(0xed)],'userId':_0x2f44d6[_0x2548dd(0x105)]}));}let _0x27c10a=_0x27418d?.['id']||null;if(_0x101dcf){const _0x579266=await Whatsapp_1[_0x2548dd(0xea)][_0x2548dd(0xec)](_0x13b8a8,{'include':[_0x2548dd(0x101)]});_0x579266?.[_0x2548dd(0x101)][_0x2548dd(0xf4)]===0x1&&(_0x27c10a=_0x579266[_0x2548dd(0x101)][0x0]['id']);}return!_0x2f44d6&&(_0x2f44d6=await Ticket_1[_0x2548dd(0xea)][_0x2548dd(0xe3)]({'contactId':_0x101dcf?_0x101dcf['id']:_0xda3ff4['id'],'status':'pending','isGroup':!!_0x101dcf,'unreadMessages':_0x44b7f6,'whatsappId':_0x13b8a8,'queueId':_0x27c10a,'companyId':_0x5d6eee}),_0x32282a=!![],await(0x0,FindOrCreateATicketTrakingService_1[_0x2548dd(0xea)])({'ticketId':_0x2f44d6['id'],'companyId':_0x5d6eee,'whatsappId':_0x13b8a8,'userId':_0x2f44d6[_0x2548dd(0x105)]})),_0x2f44d6=await(0x0,ShowTicketService_1['default'])(_0x2f44d6['id'],_0x5d6eee),{'ticket':_0x2f44d6,'justCreated':_0x32282a};});return _0x3d40a3;},FindOrCreateTicketService=async(_0x100e38,_0x11446b,_0x156dd2,_0x4b074b,_0x41bcf5,_0x330433,_0x32238d)=>{const _0xc1966e=a557_0x3a51b4,_0x233d2a=await createTicketMutex[_0xc1966e(0xf5)]();try{return await internalFindOrCreateTicketService(_0x100e38,_0x11446b,_0x156dd2,_0x4b074b,_0x41bcf5,_0x330433,_0x32238d);}finally{_0x233d2a();}};exports[a557_0x3a51b4(0xea)]=FindOrCreateTicketService;