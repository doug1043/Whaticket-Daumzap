const a665_0x759522=a665_0x1e1d;(function(_0x2785f4,_0x789dd6){const _0x57f50c=a665_0x1e1d,_0x5820af=_0x2785f4();while(!![]){try{const _0x78876e=parseInt(_0x57f50c(0x1e5))/0x1+parseInt(_0x57f50c(0x1d4))/0x2*(parseInt(_0x57f50c(0x1db))/0x3)+parseInt(_0x57f50c(0x1de))/0x4*(-parseInt(_0x57f50c(0x1f7))/0x5)+-parseInt(_0x57f50c(0x1d2))/0x6+parseInt(_0x57f50c(0x1ea))/0x7*(-parseInt(_0x57f50c(0x1e9))/0x8)+-parseInt(_0x57f50c(0x1f5))/0x9+-parseInt(_0x57f50c(0x1d6))/0xa*(-parseInt(_0x57f50c(0x1e0))/0xb);if(_0x78876e===_0x789dd6)break;else _0x5820af['push'](_0x5820af['shift']());}catch(_0x20f974){_0x5820af['push'](_0x5820af['shift']());}}}(a665_0x2d33,0x34544));function a665_0x2d33(){const _0x5588f9=['whatsappId','findByPk','create','apply','search','transaction','sequelize','../../helpers/CheckSettings','1056924CmCRVz','./FindOrCreateATicketTrakingService','10nKJJAo','subMinutes','../../models/Ticket','length','default','../../models/User','1638420fSoaAI','date-fns','2268Jrrstw','defineProperty','10wYhvLw','__importDefault','userId','pending','./ShowTicketService','39ikMjpT','updatedAt','Mutex','483128qzFkgc','between','8316583BNBHux','findOne','../../database','update','(((.+)+)+)+$','268459QVLazE','autoReopenTimeout','queues','constructor','1184xmQULh','9121eGHNfz','DESC','toString'];a665_0x2d33=function(){return _0x5588f9;};return a665_0x2d33();}function a665_0x1e1d(_0x4290b8,_0xa9812e){const _0x17abfa=a665_0x2d33();return a665_0x1e1d=function(_0x1b9a6e,_0x33f93a){_0x1b9a6e=_0x1b9a6e-0x1cf;let _0x2d3365=_0x17abfa[_0x1b9a6e];return _0x2d3365;},a665_0x1e1d(_0x4290b8,_0xa9812e);}const a665_0x33f93a=(function(){let _0x3d2eb8=!![];return function(_0x23782a,_0x437ce6){const _0x37087e=_0x3d2eb8?function(){const _0x10ad03=a665_0x1e1d;if(_0x437ce6){const _0x22e82a=_0x437ce6[_0x10ad03(0x1f0)](_0x23782a,arguments);return _0x437ce6=null,_0x22e82a;}}:function(){};return _0x3d2eb8=![],_0x37087e;};}()),a665_0x1b9a6e=a665_0x33f93a(this,function(){const _0x30ec62=a665_0x1e1d;return a665_0x1b9a6e[_0x30ec62(0x1ec)]()[_0x30ec62(0x1f1)](_0x30ec62(0x1e4))[_0x30ec62(0x1ec)]()[_0x30ec62(0x1e8)](a665_0x1b9a6e)[_0x30ec62(0x1f1)]('(((.+)+)+)+$');});a665_0x1b9a6e();'use strict';var __importDefault=this&&this[a665_0x759522(0x1d7)]||function(_0xd68475){return _0xd68475&&_0xd68475['__esModule']?_0xd68475:{'default':_0xd68475};};Object[a665_0x759522(0x1d5)](exports,'__esModule',{'value':!![]});const date_fns_1=require(a665_0x759522(0x1d3)),sequelize_1=require(a665_0x759522(0x1f3)),async_mutex_1=require('async-mutex'),Ticket_1=__importDefault(require(a665_0x759522(0x1f9))),ShowTicketService_1=__importDefault(require(a665_0x759522(0x1da))),FindOrCreateATicketTrakingService_1=__importDefault(require(a665_0x759522(0x1f6))),CheckSettings_1=require(a665_0x759522(0x1f4)),database_1=__importDefault(require(a665_0x759522(0x1e2))),Whatsapp_1=__importDefault(require('../../models/Whatsapp')),User_1=__importDefault(require(a665_0x759522(0x1d1))),Company_1=__importDefault(require('../../models/Company')),createTicketMutex=new async_mutex_1[(a665_0x759522(0x1dd))](),internalFindOrCreateTicketService=async(_0x499d54,_0x29a2b8,_0x680336,_0x4edaba,_0x4c21e4,_0x35a091,_0x33322c)=>{const _0x1e4099=a665_0x759522;let _0x31b9f5=![];const _0x1dbe04=await database_1[_0x1e4099(0x1d0)][_0x1e4099(0x1f2)](async()=>{const _0x17d66c=_0x1e4099;let _0x142101=await Ticket_1[_0x17d66c(0x1d0)][_0x17d66c(0x1e1)]({'where':{'status':{[sequelize_1['Op']['or']]:['open','pending']},'contactId':_0x4c21e4?_0x4c21e4['id']:_0x499d54['id'],'whatsappId':_0x29a2b8},'order':[['id','DESC']],'include':[{'model':User_1[_0x17d66c(0x1d0)]},{'model':Company_1[_0x17d66c(0x1d0)]}]});_0x142101&&await _0x142101[_0x17d66c(0x1e3)]({'unreadMessages':_0x680336,'ticketsWithWarning':![],'warningSentAt':null});!_0x142101&&_0x4c21e4&&(_0x142101=await Ticket_1[_0x17d66c(0x1d0)][_0x17d66c(0x1e1)]({'where':{'contactId':_0x4c21e4['id'],'whatsappId':_0x29a2b8},'order':[[_0x17d66c(0x1dc),_0x17d66c(0x1eb)]],'include':[{'model':User_1[_0x17d66c(0x1d0)]},{'model':Company_1[_0x17d66c(0x1d0)]}]}),_0x142101&&(await _0x142101[_0x17d66c(0x1e3)]({'status':_0x17d66c(0x1d9),'userId':null,'unreadMessages':_0x680336,'companyId':_0x4edaba}),await(0x0,FindOrCreateATicketTrakingService_1[_0x17d66c(0x1d0)])({'ticketId':_0x142101['id'],'companyId':_0x4edaba,'whatsappId':_0x142101[_0x17d66c(0x1ed)],'userId':_0x142101[_0x17d66c(0x1d8)]})));if(!_0x35a091&&!_0x142101&&!_0x4c21e4){const _0x1d7c06=parseInt(await(0x0,CheckSettings_1['GetCompanySetting'])(_0x4edaba,_0x17d66c(0x1e6),'0'),0xa);_0x142101=_0x1d7c06&&await Ticket_1['default']['findOne']({'where':{'updatedAt':{[sequelize_1['Op'][_0x17d66c(0x1df)]]:[+(0x0,date_fns_1[_0x17d66c(0x1f8)])(new Date(),_0x1d7c06),+new Date()]},'contactId':_0x499d54['id'],'whatsappId':_0x29a2b8},'order':[[_0x17d66c(0x1dc),_0x17d66c(0x1eb)]],'include':[{'model':User_1[_0x17d66c(0x1d0)]},{'model':Company_1['default']}]}),_0x142101&&(await _0x142101[_0x17d66c(0x1e3)]({'status':_0x17d66c(0x1d9),'userId':null,'unreadMessages':_0x680336,'companyId':_0x4edaba}),await(0x0,FindOrCreateATicketTrakingService_1[_0x17d66c(0x1d0)])({'ticketId':_0x142101['id'],'companyId':_0x4edaba,'whatsappId':_0x142101['whatsappId'],'userId':_0x142101[_0x17d66c(0x1d8)]}));}let _0x3737e4=_0x33322c?.['id']||null;if(_0x4c21e4){const _0x39cfd0=await Whatsapp_1[_0x17d66c(0x1d0)][_0x17d66c(0x1ee)](_0x29a2b8,{'include':[_0x17d66c(0x1e7)]});_0x39cfd0?.[_0x17d66c(0x1e7)][_0x17d66c(0x1cf)]===0x1&&(_0x3737e4=_0x39cfd0[_0x17d66c(0x1e7)][0x0]['id']);}return!_0x142101&&(_0x142101=await Ticket_1['default'][_0x17d66c(0x1ef)]({'contactId':_0x4c21e4?_0x4c21e4['id']:_0x499d54['id'],'status':'pending','isGroup':!!_0x4c21e4,'unreadMessages':_0x680336,'whatsappId':_0x29a2b8,'queueId':_0x3737e4,'companyId':_0x4edaba}),_0x31b9f5=!![],await(0x0,FindOrCreateATicketTrakingService_1[_0x17d66c(0x1d0)])({'ticketId':_0x142101['id'],'companyId':_0x4edaba,'whatsappId':_0x29a2b8,'userId':_0x142101[_0x17d66c(0x1d8)]})),_0x142101=await(0x0,ShowTicketService_1[_0x17d66c(0x1d0)])(_0x142101['id'],_0x4edaba),{'ticket':_0x142101,'justCreated':_0x31b9f5};});return _0x1dbe04;},FindOrCreateTicketService=async(_0x39f5e6,_0x1e5953,_0x129d82,_0x428846,_0x3cc1ce,_0x77f89f,_0x3d1dc3)=>{const _0x5899b6=await createTicketMutex['acquire']();try{return await internalFindOrCreateTicketService(_0x39f5e6,_0x1e5953,_0x129d82,_0x428846,_0x3cc1ce,_0x77f89f,_0x3d1dc3);}finally{_0x5899b6();}};exports[a665_0x759522(0x1d0)]=FindOrCreateTicketService;