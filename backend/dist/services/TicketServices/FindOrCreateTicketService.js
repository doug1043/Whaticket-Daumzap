const a557_0x44dae1=a557_0x16ae;(function(_0x541f86,_0x506da3){const _0x1ec1e3=a557_0x16ae,_0x9a5bb=_0x541f86();while(!![]){try{const _0x2537ed=-parseInt(_0x1ec1e3(0x1dd))/0x1*(-parseInt(_0x1ec1e3(0x1c0))/0x2)+parseInt(_0x1ec1e3(0x1cf))/0x3+-parseInt(_0x1ec1e3(0x1e0))/0x4+parseInt(_0x1ec1e3(0x1c1))/0x5+-parseInt(_0x1ec1e3(0x1cb))/0x6*(-parseInt(_0x1ec1e3(0x1c4))/0x7)+-parseInt(_0x1ec1e3(0x1c6))/0x8*(parseInt(_0x1ec1e3(0x1cd))/0x9)+-parseInt(_0x1ec1e3(0x1c9))/0xa;if(_0x2537ed===_0x506da3)break;else _0x9a5bb['push'](_0x9a5bb['shift']());}catch(_0x17eba8){_0x9a5bb['push'](_0x9a5bb['shift']());}}}(a557_0x4abc,0xecc20));const a557_0x26afc7=(function(){let _0x5ad25a=!![];return function(_0x90c24b,_0xc32bc2){const _0x51c799=_0x5ad25a?function(){const _0x2ab670=a557_0x16ae;if(_0xc32bc2){const _0x1438be=_0xc32bc2[_0x2ab670(0x1d1)](_0x90c24b,arguments);return _0xc32bc2=null,_0x1438be;}}:function(){};return _0x5ad25a=![],_0x51c799;};}()),a557_0x3ffa9d=a557_0x26afc7(this,function(){const _0x34f939=a557_0x16ae;return a557_0x3ffa9d['toString']()[_0x34f939(0x1e4)](_0x34f939(0x1ca))[_0x34f939(0x1cc)]()[_0x34f939(0x1c2)](a557_0x3ffa9d)[_0x34f939(0x1e4)](_0x34f939(0x1ca));});a557_0x3ffa9d();'use strict';function a557_0x16ae(_0x4c525c,_0x50df01){const _0x4fa2b3=a557_0x4abc();return a557_0x16ae=function(_0x3ffa9d,_0x26afc7){_0x3ffa9d=_0x3ffa9d-0x1be;let _0x4abc08=_0x4fa2b3[_0x3ffa9d];return _0x4abc08;},a557_0x16ae(_0x4c525c,_0x50df01);}var __importDefault=this&&this[a557_0x44dae1(0x1c8)]||function(_0x3aa733){const _0x52d4e9=a557_0x44dae1;return _0x3aa733&&_0x3aa733[_0x52d4e9(0x1d8)]?_0x3aa733:{'default':_0x3aa733};};Object['defineProperty'](exports,a557_0x44dae1(0x1d8),{'value':!![]});const date_fns_1=require('date-fns'),sequelize_1=require(a557_0x44dae1(0x1d0)),async_mutex_1=require('async-mutex'),Ticket_1=__importDefault(require('../../models/Ticket')),ShowTicketService_1=__importDefault(require(a557_0x44dae1(0x1da))),FindOrCreateATicketTrakingService_1=__importDefault(require('./FindOrCreateATicketTrakingService')),CheckSettings_1=require(a557_0x44dae1(0x1ce)),database_1=__importDefault(require(a557_0x44dae1(0x1e2))),Whatsapp_1=__importDefault(require(a557_0x44dae1(0x1e3))),User_1=__importDefault(require(a557_0x44dae1(0x1d6))),Company_1=__importDefault(require(a557_0x44dae1(0x1c7))),createTicketMutex=new async_mutex_1[(a557_0x44dae1(0x1d9))](),internalFindOrCreateTicketService=async(_0x232353,_0x278b94,_0x2ac8be,_0x26e268,_0x56dfd8,_0x344ba7,_0x572f1f)=>{const _0x5103be=a557_0x44dae1;let _0x32e497=![];const _0xc8324a=await database_1[_0x5103be(0x1d2)]['transaction'](async()=>{const _0x280c23=_0x5103be;let _0x327aff=await Ticket_1[_0x280c23(0x1d2)][_0x280c23(0x1e1)]({'where':{'status':{[sequelize_1['Op']['or']]:[_0x280c23(0x1de),'pending']},'contactId':_0x56dfd8?_0x56dfd8['id']:_0x232353['id'],'whatsappId':_0x278b94},'order':[['id',_0x280c23(0x1c3)]],'include':[{'model':User_1[_0x280c23(0x1d2)]},{'model':Company_1[_0x280c23(0x1d2)]}]});_0x327aff&&await _0x327aff[_0x280c23(0x1d4)]({'unreadMessages':_0x2ac8be});!_0x327aff&&_0x56dfd8&&(_0x327aff=await Ticket_1[_0x280c23(0x1d2)][_0x280c23(0x1e1)]({'where':{'contactId':_0x56dfd8['id'],'whatsappId':_0x278b94},'order':[['updatedAt',_0x280c23(0x1c3)]],'include':[{'model':User_1[_0x280c23(0x1d2)]},{'model':Company_1[_0x280c23(0x1d2)]}]}),_0x327aff&&(await _0x327aff[_0x280c23(0x1d4)]({'status':_0x280c23(0x1c5),'userId':null,'unreadMessages':_0x2ac8be,'companyId':_0x26e268}),await(0x0,FindOrCreateATicketTrakingService_1['default'])({'ticketId':_0x327aff['id'],'companyId':_0x26e268,'whatsappId':_0x327aff[_0x280c23(0x1d5)],'userId':_0x327aff[_0x280c23(0x1be)]})));if(!_0x344ba7&&!_0x327aff&&!_0x56dfd8){const _0x47511c=parseInt(await(0x0,CheckSettings_1['GetCompanySetting'])(_0x26e268,_0x280c23(0x1df),'0'),0xa);_0x327aff=_0x47511c&&await Ticket_1['default']['findOne']({'where':{'updatedAt':{[sequelize_1['Op'][_0x280c23(0x1db)]]:[+(0x0,date_fns_1[_0x280c23(0x1dc)])(new Date(),_0x47511c),+new Date()]},'contactId':_0x232353['id'],'whatsappId':_0x278b94},'order':[[_0x280c23(0x1d7),_0x280c23(0x1c3)]],'include':[{'model':User_1[_0x280c23(0x1d2)]},{'model':Company_1[_0x280c23(0x1d2)]}]}),_0x327aff&&(await _0x327aff['update']({'status':_0x280c23(0x1c5),'userId':null,'unreadMessages':_0x2ac8be,'companyId':_0x26e268}),await(0x0,FindOrCreateATicketTrakingService_1[_0x280c23(0x1d2)])({'ticketId':_0x327aff['id'],'companyId':_0x26e268,'whatsappId':_0x327aff[_0x280c23(0x1d5)],'userId':_0x327aff[_0x280c23(0x1be)]}));}let _0x2cf0e7=_0x572f1f?.['id']||null;if(_0x56dfd8){const _0x1f7385=await Whatsapp_1['default']['findByPk'](_0x278b94,{'include':['queues']});_0x1f7385?.[_0x280c23(0x1bf)][_0x280c23(0x1d3)]===0x1&&(_0x2cf0e7=_0x1f7385[_0x280c23(0x1bf)][0x0]['id']);}return!_0x327aff&&(_0x327aff=await Ticket_1[_0x280c23(0x1d2)]['create']({'contactId':_0x56dfd8?_0x56dfd8['id']:_0x232353['id'],'status':_0x280c23(0x1c5),'isGroup':!!_0x56dfd8,'unreadMessages':_0x2ac8be,'whatsappId':_0x278b94,'queueId':_0x2cf0e7,'companyId':_0x26e268}),_0x32e497=!![],await(0x0,FindOrCreateATicketTrakingService_1[_0x280c23(0x1d2)])({'ticketId':_0x327aff['id'],'companyId':_0x26e268,'whatsappId':_0x278b94,'userId':_0x327aff['userId']})),_0x327aff=await(0x0,ShowTicketService_1[_0x280c23(0x1d2)])(_0x327aff['id'],_0x26e268),{'ticket':_0x327aff,'justCreated':_0x32e497};});return _0xc8324a;},FindOrCreateTicketService=async(_0x4b5652,_0x331596,_0x57a79a,_0x4633fc,_0x4f96f9,_0x6c96de,_0x13c56d)=>{const _0x34c2d0=await createTicketMutex['acquire']();try{return await internalFindOrCreateTicketService(_0x4b5652,_0x331596,_0x57a79a,_0x4633fc,_0x4f96f9,_0x6c96de,_0x13c56d);}finally{_0x34c2d0();}};function a557_0x4abc(){const _0x3990c9=['updatedAt','__esModule','Mutex','./ShowTicketService','between','subMinutes','311359bnIExj','open','autoReopenTimeout','3690772LqYNfz','findOne','../../database','../../models/Whatsapp','search','userId','queues','2FztdIR','2792380wAFNJR','constructor','DESC','7CYQoYB','pending','234128UVhpXo','../../models/Company','__importDefault','7350720cdvTVO','(((.+)+)+)+$','9888582hxBZCh','toString','369wQCFgR','../../helpers/CheckSettings','3928497vCeaha','sequelize','apply','default','length','update','whatsappId','../../models/User'];a557_0x4abc=function(){return _0x3990c9;};return a557_0x4abc();}exports[a557_0x44dae1(0x1d2)]=FindOrCreateTicketService;