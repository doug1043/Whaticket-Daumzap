const a558_0x2a22f7=a558_0x351e;(function(_0x365334,_0x47260c){const _0x4bcbb8=a558_0x351e,_0x2e6757=_0x365334();while(!![]){try{const _0x462889=parseInt(_0x4bcbb8(0xe5))/0x1+parseInt(_0x4bcbb8(0xff))/0x2*(parseInt(_0x4bcbb8(0xe6))/0x3)+-parseInt(_0x4bcbb8(0xdf))/0x4*(parseInt(_0x4bcbb8(0xe7))/0x5)+-parseInt(_0x4bcbb8(0xeb))/0x6*(parseInt(_0x4bcbb8(0xfd))/0x7)+parseInt(_0x4bcbb8(0xdb))/0x8*(parseInt(_0x4bcbb8(0xf4))/0x9)+-parseInt(_0x4bcbb8(0xd8))/0xa+parseInt(_0x4bcbb8(0xd5))/0xb*(parseInt(_0x4bcbb8(0xdc))/0xc);if(_0x462889===_0x47260c)break;else _0x2e6757['push'](_0x2e6757['shift']());}catch(_0x51abcc){_0x2e6757['push'](_0x2e6757['shift']());}}}(a558_0x148c,0x9a4c5));const a558_0x2119e3=(function(){let _0x188d0f=!![];return function(_0xeb1de,_0x350175){const _0x5b65e4=_0x188d0f?function(){const _0x3c4243=a558_0x351e;if(_0x350175){const _0x2e053d=_0x350175[_0x3c4243(0xe8)](_0xeb1de,arguments);return _0x350175=null,_0x2e053d;}}:function(){};return _0x188d0f=![],_0x5b65e4;};}()),a558_0x7aecb5=a558_0x2119e3(this,function(){const _0x5a29b4=a558_0x351e;return a558_0x7aecb5['toString']()[_0x5a29b4(0xf5)]('(((.+)+)+)+$')[_0x5a29b4(0xe4)]()[_0x5a29b4(0xf6)](a558_0x7aecb5)[_0x5a29b4(0xf5)](_0x5a29b4(0xd9));});a558_0x7aecb5();'use strict';var __importDefault=this&&this[a558_0x2a22f7(0xf0)]||function(_0x4b80d0){const _0x45960b=a558_0x2a22f7;return _0x4b80d0&&_0x4b80d0[_0x45960b(0xde)]?_0x4b80d0:{'default':_0x4b80d0};};function a558_0x351e(_0x318fa7,_0x5e34c2){const _0xdd0959=a558_0x148c();return a558_0x351e=function(_0x7aecb5,_0x2119e3){_0x7aecb5=_0x7aecb5-0xd5;let _0x148cbb=_0xdd0959[_0x7aecb5];return _0x148cbb;},a558_0x351e(_0x318fa7,_0x5e34c2);}function a558_0x148c(){const _0x25b619=['updatedAt','../../models/Ticket','227315bIKeFj','between','create','7645430SCmbsl','(((.+)+)+)+$','defineProperty','4712bfnajl','672Iweuqm','DESC','__esModule','3322928uuxZuO','../../models/User','queues','sequelize','whatsappId','toString','494150wnHgCu','9mCbFej','5knRJdF','apply','subMinutes','open','174AqLKzr','userId','length','findOne','Mutex','__importDefault','acquire','../../database','update','16965UKyUye','search','constructor','autoReopenTimeout','default','../../helpers/CheckSettings','../../models/Whatsapp','findByPk','./ShowTicketService','188412uGTcOz','pending','164126gisGWO','./FindOrCreateATicketTrakingService','async-mutex'];a558_0x148c=function(){return _0x25b619;};return a558_0x148c();}Object[a558_0x2a22f7(0xda)](exports,a558_0x2a22f7(0xde),{'value':!![]});const date_fns_1=require('date-fns'),sequelize_1=require(a558_0x2a22f7(0xe2)),async_mutex_1=require(a558_0x2a22f7(0x101)),Ticket_1=__importDefault(require(a558_0x2a22f7(0x103))),ShowTicketService_1=__importDefault(require(a558_0x2a22f7(0xfc))),FindOrCreateATicketTrakingService_1=__importDefault(require(a558_0x2a22f7(0x100))),CheckSettings_1=require(a558_0x2a22f7(0xf9)),database_1=__importDefault(require(a558_0x2a22f7(0xf2))),Whatsapp_1=__importDefault(require(a558_0x2a22f7(0xfa))),User_1=__importDefault(require(a558_0x2a22f7(0xe0))),Company_1=__importDefault(require('../../models/Company')),createTicketMutex=new async_mutex_1[(a558_0x2a22f7(0xef))](),internalFindOrCreateTicketService=async(_0x5f59c3,_0x470316,_0x1de57f,_0x1bb257,_0x595db4,_0x3c6074,_0x54c666)=>{const _0x51de90=a558_0x2a22f7;let _0x1a3e46=![];const _0x218aa4=await database_1[_0x51de90(0xf8)]['transaction'](async()=>{const _0x4dfd35=_0x51de90;let _0x56e30c=await Ticket_1['default'][_0x4dfd35(0xee)]({'where':{'status':{[sequelize_1['Op']['or']]:[_0x4dfd35(0xea),'pending']},'contactId':_0x595db4?_0x595db4['id']:_0x5f59c3['id'],'whatsappId':_0x470316},'order':[['id',_0x4dfd35(0xdd)]],'include':[{'model':User_1[_0x4dfd35(0xf8)]},{'model':Company_1['default']}]});_0x56e30c&&await _0x56e30c[_0x4dfd35(0xf3)]({'unreadMessages':_0x1de57f});!_0x56e30c&&_0x595db4&&(_0x56e30c=await Ticket_1[_0x4dfd35(0xf8)]['findOne']({'where':{'contactId':_0x595db4['id'],'whatsappId':_0x470316},'order':[[_0x4dfd35(0x102),'DESC']],'include':[{'model':User_1[_0x4dfd35(0xf8)]},{'model':Company_1[_0x4dfd35(0xf8)]}]}),_0x56e30c&&(await _0x56e30c[_0x4dfd35(0xf3)]({'status':'pending','userId':null,'unreadMessages':_0x1de57f,'companyId':_0x1bb257}),await(0x0,FindOrCreateATicketTrakingService_1[_0x4dfd35(0xf8)])({'ticketId':_0x56e30c['id'],'companyId':_0x1bb257,'whatsappId':_0x56e30c['whatsappId'],'userId':_0x56e30c[_0x4dfd35(0xec)]})));if(!_0x3c6074&&!_0x56e30c&&!_0x595db4){const _0x4a8a34=parseInt(await(0x0,CheckSettings_1['GetCompanySetting'])(_0x1bb257,_0x4dfd35(0xf7),'0'),0xa);_0x56e30c=_0x4a8a34&&await Ticket_1[_0x4dfd35(0xf8)][_0x4dfd35(0xee)]({'where':{'updatedAt':{[sequelize_1['Op'][_0x4dfd35(0xd6)]]:[+(0x0,date_fns_1[_0x4dfd35(0xe9)])(new Date(),_0x4a8a34),+new Date()]},'contactId':_0x5f59c3['id'],'whatsappId':_0x470316},'order':[[_0x4dfd35(0x102),_0x4dfd35(0xdd)]],'include':[{'model':User_1[_0x4dfd35(0xf8)]},{'model':Company_1[_0x4dfd35(0xf8)]}]}),_0x56e30c&&(await _0x56e30c[_0x4dfd35(0xf3)]({'status':_0x4dfd35(0xfe),'userId':null,'unreadMessages':_0x1de57f,'companyId':_0x1bb257}),await(0x0,FindOrCreateATicketTrakingService_1['default'])({'ticketId':_0x56e30c['id'],'companyId':_0x1bb257,'whatsappId':_0x56e30c[_0x4dfd35(0xe3)],'userId':_0x56e30c[_0x4dfd35(0xec)]}));}let _0x30440e=_0x54c666?.['id']||null;if(_0x595db4){const _0x516bd0=await Whatsapp_1[_0x4dfd35(0xf8)][_0x4dfd35(0xfb)](_0x470316,{'include':[_0x4dfd35(0xe1)]});_0x516bd0?.[_0x4dfd35(0xe1)][_0x4dfd35(0xed)]===0x1&&(_0x30440e=_0x516bd0['queues'][0x0]['id']);}return!_0x56e30c&&(_0x56e30c=await Ticket_1[_0x4dfd35(0xf8)][_0x4dfd35(0xd7)]({'contactId':_0x595db4?_0x595db4['id']:_0x5f59c3['id'],'status':_0x4dfd35(0xfe),'isGroup':!!_0x595db4,'unreadMessages':_0x1de57f,'whatsappId':_0x470316,'queueId':_0x30440e,'companyId':_0x1bb257}),_0x1a3e46=!![],await(0x0,FindOrCreateATicketTrakingService_1[_0x4dfd35(0xf8)])({'ticketId':_0x56e30c['id'],'companyId':_0x1bb257,'whatsappId':_0x470316,'userId':_0x56e30c[_0x4dfd35(0xec)]})),_0x56e30c=await(0x0,ShowTicketService_1[_0x4dfd35(0xf8)])(_0x56e30c['id'],_0x1bb257),{'ticket':_0x56e30c,'justCreated':_0x1a3e46};});return _0x218aa4;},FindOrCreateTicketService=async(_0x1d4fec,_0x4ce628,_0x1d6721,_0x41a685,_0x24d936,_0x246a54,_0x61461a)=>{const _0x528dd9=a558_0x2a22f7,_0x35f20e=await createTicketMutex[_0x528dd9(0xf1)]();try{return await internalFindOrCreateTicketService(_0x1d4fec,_0x4ce628,_0x1d6721,_0x41a685,_0x24d936,_0x246a54,_0x61461a);}finally{_0x35f20e();}};exports[a558_0x2a22f7(0xf8)]=FindOrCreateTicketService;