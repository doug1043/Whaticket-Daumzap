const a548_0x50272d=a548_0x172e;(function(_0x279f90,_0xfa062d){const _0x3a4d67=a548_0x172e,_0x3e9d28=_0x279f90();while(!![]){try{const _0x4b9dae=parseInt(_0x3a4d67(0x20f))/0x1*(-parseInt(_0x3a4d67(0x1f1))/0x2)+-parseInt(_0x3a4d67(0x202))/0x3+-parseInt(_0x3a4d67(0x1fc))/0x4*(-parseInt(_0x3a4d67(0x209))/0x5)+parseInt(_0x3a4d67(0x206))/0x6*(parseInt(_0x3a4d67(0x20a))/0x7)+parseInt(_0x3a4d67(0x1fa))/0x8+parseInt(_0x3a4d67(0x1f2))/0x9*(-parseInt(_0x3a4d67(0x210))/0xa)+-parseInt(_0x3a4d67(0x1fe))/0xb*(parseInt(_0x3a4d67(0x214))/0xc);if(_0x4b9dae===_0xfa062d)break;else _0x3e9d28['push'](_0x3e9d28['shift']());}catch(_0x145676){_0x3e9d28['push'](_0x3e9d28['shift']());}}}(a548_0x5b38,0x7c2e3));const a548_0x3aeab5=(function(){let _0x24a080=!![];return function(_0x430010,_0x3f9088){const _0x318802=_0x24a080?function(){const _0x560b3c=a548_0x172e;if(_0x3f9088){const _0x3109a8=_0x3f9088[_0x560b3c(0x213)](_0x430010,arguments);return _0x3f9088=null,_0x3109a8;}}:function(){};return _0x24a080=![],_0x318802;};}()),a548_0x436f25=a548_0x3aeab5(this,function(){const _0x5dead3=a548_0x172e;return a548_0x436f25[_0x5dead3(0x1f4)]()[_0x5dead3(0x1f3)](_0x5dead3(0x20c))[_0x5dead3(0x1f4)]()[_0x5dead3(0x211)](a548_0x436f25)[_0x5dead3(0x1f3)](_0x5dead3(0x20c));});a548_0x436f25();function a548_0x5b38(){const _0x31a120=['74JaQXvj','495VsllQn','search','toString','date-fns','length','subMinutes','sequelize','userId','7434368AVupjj','__esModule','9904oSGnjP','../../helpers/CheckSettings','3146OtoayI','findByPk','../../database','create','232980iAaIUU','updatedAt','open','default','8886nhcJOk','defineProperty','pending','1295fYsyjq','2436nDZeaG','DESC','(((.+)+)+)+$','acquire','__importDefault','19322cBfgTi','96610xBGJfU','constructor','queues','apply','10632WuDvMN','whatsappId','update','findOne','./ShowTicketService','../../models/Whatsapp','async-mutex','Mutex'];a548_0x5b38=function(){return _0x31a120;};return a548_0x5b38();}'use strict';var __importDefault=this&&this[a548_0x50272d(0x20e)]||function(_0x46f530){const _0x4dd9f2=a548_0x50272d;return _0x46f530&&_0x46f530[_0x4dd9f2(0x1fb)]?_0x46f530:{'default':_0x46f530};};Object[a548_0x50272d(0x207)](exports,a548_0x50272d(0x1fb),{'value':!![]});const date_fns_1=require(a548_0x50272d(0x1f5)),sequelize_1=require(a548_0x50272d(0x1f8)),async_mutex_1=require(a548_0x50272d(0x1ef)),Ticket_1=__importDefault(require('../../models/Ticket')),ShowTicketService_1=__importDefault(require(a548_0x50272d(0x218))),FindOrCreateATicketTrakingService_1=__importDefault(require('./FindOrCreateATicketTrakingService')),CheckSettings_1=require(a548_0x50272d(0x1fd)),database_1=__importDefault(require(a548_0x50272d(0x200))),Whatsapp_1=__importDefault(require(a548_0x50272d(0x1ee))),createTicketMutex=new async_mutex_1[(a548_0x50272d(0x1f0))](),internalFindOrCreateTicketService=async(_0x47c0f4,_0x1678b5,_0x3bae2d,_0x5c80f9,_0x346414,_0x316afc,_0x27bc31)=>{let _0x4a097d=![];const _0x6e5d52=await database_1['default']['transaction'](async()=>{const _0x550489=a548_0x172e;let _0x144861=await Ticket_1[_0x550489(0x205)]['findOne']({'where':{'status':{[sequelize_1['Op']['or']]:[_0x550489(0x204),_0x550489(0x208)]},'contactId':_0x346414?_0x346414['id']:_0x47c0f4['id'],'whatsappId':_0x1678b5},'order':[['id',_0x550489(0x20b)]]});_0x144861&&await _0x144861[_0x550489(0x216)]({'unreadMessages':_0x3bae2d});!_0x144861&&_0x346414&&(_0x144861=await Ticket_1[_0x550489(0x205)][_0x550489(0x217)]({'where':{'contactId':_0x346414['id'],'whatsappId':_0x1678b5},'order':[[_0x550489(0x203),_0x550489(0x20b)]]}),_0x144861&&(await _0x144861['update']({'status':_0x550489(0x208),'userId':null,'unreadMessages':_0x3bae2d,'companyId':_0x5c80f9}),await(0x0,FindOrCreateATicketTrakingService_1[_0x550489(0x205)])({'ticketId':_0x144861['id'],'companyId':_0x5c80f9,'whatsappId':_0x144861[_0x550489(0x215)],'userId':_0x144861[_0x550489(0x1f9)]})));if(!_0x316afc&&!_0x144861&&!_0x346414){const _0x1f61ac=parseInt(await(0x0,CheckSettings_1['GetCompanySetting'])(_0x5c80f9,'autoReopenTimeout','0'),0xa);_0x144861=_0x1f61ac&&await Ticket_1[_0x550489(0x205)][_0x550489(0x217)]({'where':{'updatedAt':{[sequelize_1['Op']['between']]:[+(0x0,date_fns_1[_0x550489(0x1f7)])(new Date(),_0x1f61ac),+new Date()]},'contactId':_0x47c0f4['id'],'whatsappId':_0x1678b5},'order':[[_0x550489(0x203),_0x550489(0x20b)]]}),_0x144861&&(await _0x144861[_0x550489(0x216)]({'status':'pending','userId':null,'unreadMessages':_0x3bae2d,'companyId':_0x5c80f9}),await(0x0,FindOrCreateATicketTrakingService_1['default'])({'ticketId':_0x144861['id'],'companyId':_0x5c80f9,'whatsappId':_0x144861[_0x550489(0x215)],'userId':_0x144861[_0x550489(0x1f9)]}));}let _0x540b55=_0x27bc31?.['id']||null;if(_0x346414){const _0x3e7e60=await Whatsapp_1[_0x550489(0x205)][_0x550489(0x1ff)](_0x1678b5,{'include':[_0x550489(0x212)]});_0x3e7e60?.['queues'][_0x550489(0x1f6)]===0x1&&(_0x540b55=_0x3e7e60[_0x550489(0x212)][0x0]['id']);}return!_0x144861&&(_0x144861=await Ticket_1[_0x550489(0x205)][_0x550489(0x201)]({'contactId':_0x346414?_0x346414['id']:_0x47c0f4['id'],'status':'pending','isGroup':!!_0x346414,'unreadMessages':_0x3bae2d,'whatsappId':_0x1678b5,'queueId':_0x540b55,'companyId':_0x5c80f9}),_0x4a097d=!![],await(0x0,FindOrCreateATicketTrakingService_1[_0x550489(0x205)])({'ticketId':_0x144861['id'],'companyId':_0x5c80f9,'whatsappId':_0x1678b5,'userId':_0x144861[_0x550489(0x1f9)]})),_0x144861=await(0x0,ShowTicketService_1[_0x550489(0x205)])(_0x144861['id'],_0x5c80f9),{'ticket':_0x144861,'justCreated':_0x4a097d};});return _0x6e5d52;},FindOrCreateTicketService=async(_0x2b7d1b,_0xaecf3a,_0x5649f0,_0x2ff116,_0x450422,_0x416fec,_0x292547)=>{const _0x50455d=a548_0x50272d,_0x274017=await createTicketMutex[_0x50455d(0x20d)]();try{return await internalFindOrCreateTicketService(_0x2b7d1b,_0xaecf3a,_0x5649f0,_0x2ff116,_0x450422,_0x416fec,_0x292547);}finally{_0x274017();}};function a548_0x172e(_0x3c7d34,_0x3c1b19){const _0x42124b=a548_0x5b38();return a548_0x172e=function(_0x436f25,_0x3aeab5){_0x436f25=_0x436f25-0x1ee;let _0x5b381a=_0x42124b[_0x436f25];return _0x5b381a;},a548_0x172e(_0x3c7d34,_0x3c1b19);}exports['default']=FindOrCreateTicketService;