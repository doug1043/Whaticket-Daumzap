const a554_0xdd190=a554_0x4b41;(function(_0x4fcd1c,_0x4cb94e){const _0x4e6491=a554_0x4b41,_0x3e3c7b=_0x4fcd1c();while(!![]){try{const _0x32c741=parseInt(_0x4e6491(0xea))/0x1*(-parseInt(_0x4e6491(0xe3))/0x2)+parseInt(_0x4e6491(0xe2))/0x3+-parseInt(_0x4e6491(0xf8))/0x4*(parseInt(_0x4e6491(0xd3))/0x5)+-parseInt(_0x4e6491(0xf6))/0x6+-parseInt(_0x4e6491(0xf3))/0x7+-parseInt(_0x4e6491(0xe8))/0x8*(parseInt(_0x4e6491(0xd7))/0x9)+-parseInt(_0x4e6491(0xd8))/0xa*(-parseInt(_0x4e6491(0xfc))/0xb);if(_0x32c741===_0x4cb94e)break;else _0x3e3c7b['push'](_0x3e3c7b['shift']());}catch(_0x19e9d0){_0x3e3c7b['push'](_0x3e3c7b['shift']());}}}(a554_0x51b9,0x2945c));const a554_0x2cf3bd=(function(){let _0x3b3928=!![];return function(_0x410ccc,_0x584d0f){const _0x2cc399=_0x3b3928?function(){const _0x2cf25f=a554_0x4b41;if(_0x584d0f){const _0x24e46d=_0x584d0f[_0x2cf25f(0xf2)](_0x410ccc,arguments);return _0x584d0f=null,_0x24e46d;}}:function(){};return _0x3b3928=![],_0x2cc399;};}()),a554_0x46c708=a554_0x2cf3bd(this,function(){const _0xd1c455=a554_0x4b41;return a554_0x46c708[_0xd1c455(0xef)]()[_0xd1c455(0xe1)](_0xd1c455(0xed))[_0xd1c455(0xef)]()[_0xd1c455(0xfd)](a554_0x46c708)[_0xd1c455(0xe1)](_0xd1c455(0xed));});a554_0x46c708();function a554_0x4b41(_0x550199,_0x3cb3af){const _0xa4aea8=a554_0x51b9();return a554_0x4b41=function(_0x46c708,_0x2cf3bd){_0x46c708=_0x46c708-0xd1;let _0x51b999=_0xa4aea8[_0x46c708];return _0x51b999;},a554_0x4b41(_0x550199,_0x3cb3af);}'use strict';var __importDefault=this&&this[a554_0xdd190(0xf9)]||function(_0x2a3186){const _0xa887f2=a554_0xdd190;return _0x2a3186&&_0x2a3186[_0xa887f2(0xf0)]?_0x2a3186:{'default':_0x2a3186};};Object[a554_0xdd190(0xf4)](exports,a554_0xdd190(0xf0),{'value':!![]});const date_fns_1=require(a554_0xdd190(0xd5)),sequelize_1=require(a554_0xdd190(0xe7)),async_mutex_1=require(a554_0xdd190(0xf1)),Ticket_1=__importDefault(require(a554_0xdd190(0xfa))),ShowTicketService_1=__importDefault(require(a554_0xdd190(0xe9))),FindOrCreateATicketTrakingService_1=__importDefault(require('./FindOrCreateATicketTrakingService')),CheckSettings_1=require(a554_0xdd190(0xdf)),database_1=__importDefault(require(a554_0xdd190(0xee))),Whatsapp_1=__importDefault(require(a554_0xdd190(0xe5))),User_1=__importDefault(require(a554_0xdd190(0xe6))),Company_1=__importDefault(require(a554_0xdd190(0xeb))),createTicketMutex=new async_mutex_1[(a554_0xdd190(0xda))](),internalFindOrCreateTicketService=async(_0x46d5b5,_0x17b412,_0x4548a9,_0x10cf9f,_0x12e181,_0x41d236,_0xffebbd)=>{const _0x3f3dfe=a554_0xdd190;let _0x462b6f=![];const _0x401262=await database_1[_0x3f3dfe(0xde)][_0x3f3dfe(0xdd)](async()=>{const _0x7f2d45=_0x3f3dfe;let _0xfdd20c=await Ticket_1[_0x7f2d45(0xde)][_0x7f2d45(0xdb)]({'where':{'status':{[sequelize_1['Op']['or']]:[_0x7f2d45(0xd6),_0x7f2d45(0xe0)]},'contactId':_0x12e181?_0x12e181['id']:_0x46d5b5['id'],'whatsappId':_0x17b412},'order':[['id',_0x7f2d45(0xf5)]],'include':[{'model':User_1[_0x7f2d45(0xde)]},{'model':Company_1[_0x7f2d45(0xde)]}]});_0xfdd20c&&await _0xfdd20c[_0x7f2d45(0xec)]({'unreadMessages':_0x4548a9});!_0xfdd20c&&_0x12e181&&(_0xfdd20c=await Ticket_1[_0x7f2d45(0xde)][_0x7f2d45(0xdb)]({'where':{'contactId':_0x12e181['id'],'whatsappId':_0x17b412},'order':[[_0x7f2d45(0xfb),_0x7f2d45(0xf5)]],'include':[{'model':User_1[_0x7f2d45(0xde)]},{'model':Company_1[_0x7f2d45(0xde)]}]}),_0xfdd20c&&(await _0xfdd20c[_0x7f2d45(0xec)]({'status':'pending','userId':null,'unreadMessages':_0x4548a9,'companyId':_0x10cf9f}),await(0x0,FindOrCreateATicketTrakingService_1[_0x7f2d45(0xde)])({'ticketId':_0xfdd20c['id'],'companyId':_0x10cf9f,'whatsappId':_0xfdd20c[_0x7f2d45(0xf7)],'userId':_0xfdd20c[_0x7f2d45(0xd9)]})));if(!_0x41d236&&!_0xfdd20c&&!_0x12e181){const _0x357814=parseInt(await(0x0,CheckSettings_1[_0x7f2d45(0xe4)])(_0x10cf9f,_0x7f2d45(0xd1),'0'),0xa);_0xfdd20c=_0x357814&&await Ticket_1[_0x7f2d45(0xde)][_0x7f2d45(0xdb)]({'where':{'updatedAt':{[sequelize_1['Op'][_0x7f2d45(0xd4)]]:[+(0x0,date_fns_1['subMinutes'])(new Date(),_0x357814),+new Date()]},'contactId':_0x46d5b5['id'],'whatsappId':_0x17b412},'order':[[_0x7f2d45(0xfb),'DESC']],'include':[{'model':User_1['default']},{'model':Company_1[_0x7f2d45(0xde)]}]}),_0xfdd20c&&(await _0xfdd20c[_0x7f2d45(0xec)]({'status':'pending','userId':null,'unreadMessages':_0x4548a9,'companyId':_0x10cf9f}),await(0x0,FindOrCreateATicketTrakingService_1[_0x7f2d45(0xde)])({'ticketId':_0xfdd20c['id'],'companyId':_0x10cf9f,'whatsappId':_0xfdd20c[_0x7f2d45(0xf7)],'userId':_0xfdd20c['userId']}));}let _0x5b2624=_0xffebbd?.['id']||null;if(_0x12e181){const _0x3db1c6=await Whatsapp_1[_0x7f2d45(0xde)]['findByPk'](_0x17b412,{'include':[_0x7f2d45(0xd2)]});_0x3db1c6?.[_0x7f2d45(0xd2)]['length']===0x1&&(_0x5b2624=_0x3db1c6[_0x7f2d45(0xd2)][0x0]['id']);}return!_0xfdd20c&&(_0xfdd20c=await Ticket_1['default']['create']({'contactId':_0x12e181?_0x12e181['id']:_0x46d5b5['id'],'status':_0x7f2d45(0xe0),'isGroup':!!_0x12e181,'unreadMessages':_0x4548a9,'whatsappId':_0x17b412,'queueId':_0x5b2624,'companyId':_0x10cf9f}),_0x462b6f=!![],await(0x0,FindOrCreateATicketTrakingService_1[_0x7f2d45(0xde)])({'ticketId':_0xfdd20c['id'],'companyId':_0x10cf9f,'whatsappId':_0x17b412,'userId':_0xfdd20c[_0x7f2d45(0xd9)]})),_0xfdd20c=await(0x0,ShowTicketService_1[_0x7f2d45(0xde)])(_0xfdd20c['id'],_0x10cf9f),{'ticket':_0xfdd20c,'justCreated':_0x462b6f};});return _0x401262;},FindOrCreateTicketService=async(_0x238129,_0x42a8bd,_0x32d706,_0x21e5ab,_0x317d77,_0x515ebb,_0xa1f221)=>{const _0x305842=a554_0xdd190,_0x3717f0=await createTicketMutex[_0x305842(0xdc)]();try{return await internalFindOrCreateTicketService(_0x238129,_0x42a8bd,_0x32d706,_0x21e5ab,_0x317d77,_0x515ebb,_0xa1f221);}finally{_0x3717f0();}};function a554_0x51b9(){const _0x1d1c51=['(((.+)+)+)+$','../../database','toString','__esModule','async-mutex','apply','2281377EozCxn','defineProperty','DESC','416298wIBALK','whatsappId','4awnOKb','__importDefault','../../models/Ticket','updatedAt','3966303lEkgvg','constructor','autoReopenTimeout','queues','729875TQIjHX','between','date-fns','open','3040227WQmRQk','30qowRKP','userId','Mutex','findOne','acquire','transaction','default','../../helpers/CheckSettings','pending','search','385473yWVaXw','4KXlSBX','GetCompanySetting','../../models/Whatsapp','../../models/User','sequelize','8BKYgSr','./ShowTicketService','81043Jpddcg','../../models/Company','update'];a554_0x51b9=function(){return _0x1d1c51;};return a554_0x51b9();}exports['default']=FindOrCreateTicketService;