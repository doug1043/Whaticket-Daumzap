const a553_0x51c0b4=a553_0x2f7e;(function(_0x201bdb,_0x300920){const _0x38033a=a553_0x2f7e,_0x51be1f=_0x201bdb();while(!![]){try{const _0x91f578=parseInt(_0x38033a(0xad))/0x1+parseInt(_0x38033a(0xa9))/0x2+parseInt(_0x38033a(0xac))/0x3+parseInt(_0x38033a(0xc9))/0x4*(parseInt(_0x38033a(0xbd))/0x5)+-parseInt(_0x38033a(0xc8))/0x6*(parseInt(_0x38033a(0xcd))/0x7)+parseInt(_0x38033a(0xb0))/0x8*(-parseInt(_0x38033a(0xc0))/0x9)+-parseInt(_0x38033a(0xa5))/0xa*(-parseInt(_0x38033a(0xa8))/0xb);if(_0x91f578===_0x300920)break;else _0x51be1f['push'](_0x51be1f['shift']());}catch(_0x4a70ac){_0x51be1f['push'](_0x51be1f['shift']());}}}(a553_0xeebc,0x1c5b4));const a553_0x404031=(function(){let _0x545575=!![];return function(_0x1e6d80,_0x42e3d6){const _0x5f4a2d=_0x545575?function(){const _0xed0fa5=a553_0x2f7e;if(_0x42e3d6){const _0x1fc2ec=_0x42e3d6[_0xed0fa5(0xb8)](_0x1e6d80,arguments);return _0x42e3d6=null,_0x1fc2ec;}}:function(){};return _0x545575=![],_0x5f4a2d;};}()),a553_0x3707d7=a553_0x404031(this,function(){const _0x1c8d01=a553_0x2f7e;return a553_0x3707d7[_0x1c8d01(0xbb)]()[_0x1c8d01(0xb1)](_0x1c8d01(0xbc))[_0x1c8d01(0xbb)]()['constructor'](a553_0x3707d7)[_0x1c8d01(0xb1)]('(((.+)+)+)+$');});function a553_0x2f7e(_0x286beb,_0x40a64b){const _0x470711=a553_0xeebc();return a553_0x2f7e=function(_0x3707d7,_0x404031){_0x3707d7=_0x3707d7-0xa5;let _0xeebc2a=_0x470711[_0x3707d7];return _0xeebc2a;},a553_0x2f7e(_0x286beb,_0x40a64b);}function a553_0xeebc(){const _0x34f6c9=['pending','./ShowTicketService','default','../../database','__importDefault','../../models/User','1388784eynugM','12akHuAs','DESC','userId','autoReopenTimeout','7acPYCS','length','sequelize','10txKsdg','GetCompanySetting','queues','272173sRTeFh','133814aSklrK','defineProperty','async-mutex','422328PxzcrE','221852jazbXq','../../models/Ticket','../../models/Company','8PrIitK','search','../../helpers/CheckSettings','update','transaction','updatedAt','create','whatsappId','apply','findOne','acquire','toString','(((.+)+)+)+$','113095QQuSYX','__esModule','Mutex','1570707kEwKNM','between'];a553_0xeebc=function(){return _0x34f6c9;};return a553_0xeebc();}a553_0x3707d7();'use strict';var __importDefault=this&&this[a553_0x51c0b4(0xc6)]||function(_0x1007c1){const _0x167f93=a553_0x51c0b4;return _0x1007c1&&_0x1007c1[_0x167f93(0xbe)]?_0x1007c1:{'default':_0x1007c1};};Object[a553_0x51c0b4(0xaa)](exports,'__esModule',{'value':!![]});const date_fns_1=require('date-fns'),sequelize_1=require(a553_0x51c0b4(0xcf)),async_mutex_1=require(a553_0x51c0b4(0xab)),Ticket_1=__importDefault(require(a553_0x51c0b4(0xae))),ShowTicketService_1=__importDefault(require(a553_0x51c0b4(0xc3))),FindOrCreateATicketTrakingService_1=__importDefault(require('./FindOrCreateATicketTrakingService')),CheckSettings_1=require(a553_0x51c0b4(0xb2)),database_1=__importDefault(require(a553_0x51c0b4(0xc5))),Whatsapp_1=__importDefault(require('../../models/Whatsapp')),User_1=__importDefault(require(a553_0x51c0b4(0xc7))),Company_1=__importDefault(require(a553_0x51c0b4(0xaf))),createTicketMutex=new async_mutex_1[(a553_0x51c0b4(0xbf))](),internalFindOrCreateTicketService=async(_0x510682,_0x5c3635,_0x26e495,_0x58763b,_0x5983cc,_0x42484c,_0xb77aae)=>{const _0xcc3f24=a553_0x51c0b4;let _0x412037=![];const _0x3d0ceb=await database_1[_0xcc3f24(0xc4)][_0xcc3f24(0xb4)](async()=>{const _0x413135=_0xcc3f24;let _0x138ac2=await Ticket_1[_0x413135(0xc4)][_0x413135(0xb9)]({'where':{'status':{[sequelize_1['Op']['or']]:['open',_0x413135(0xc2)]},'contactId':_0x5983cc?_0x5983cc['id']:_0x510682['id'],'whatsappId':_0x5c3635},'order':[['id','DESC']],'include':[{'model':User_1[_0x413135(0xc4)]},{'model':Company_1[_0x413135(0xc4)]}]});_0x138ac2&&await _0x138ac2['update']({'unreadMessages':_0x26e495});!_0x138ac2&&_0x5983cc&&(_0x138ac2=await Ticket_1[_0x413135(0xc4)][_0x413135(0xb9)]({'where':{'contactId':_0x5983cc['id'],'whatsappId':_0x5c3635},'order':[[_0x413135(0xb5),_0x413135(0xca)]],'include':[{'model':User_1[_0x413135(0xc4)]},{'model':Company_1[_0x413135(0xc4)]}]}),_0x138ac2&&(await _0x138ac2[_0x413135(0xb3)]({'status':_0x413135(0xc2),'userId':null,'unreadMessages':_0x26e495,'companyId':_0x58763b}),await(0x0,FindOrCreateATicketTrakingService_1[_0x413135(0xc4)])({'ticketId':_0x138ac2['id'],'companyId':_0x58763b,'whatsappId':_0x138ac2[_0x413135(0xb7)],'userId':_0x138ac2[_0x413135(0xcb)]})));if(!_0x42484c&&!_0x138ac2&&!_0x5983cc){const _0x146fea=parseInt(await(0x0,CheckSettings_1[_0x413135(0xa6)])(_0x58763b,_0x413135(0xcc),'0'),0xa);_0x138ac2=_0x146fea&&await Ticket_1[_0x413135(0xc4)][_0x413135(0xb9)]({'where':{'updatedAt':{[sequelize_1['Op'][_0x413135(0xc1)]]:[+(0x0,date_fns_1['subMinutes'])(new Date(),_0x146fea),+new Date()]},'contactId':_0x510682['id'],'whatsappId':_0x5c3635},'order':[[_0x413135(0xb5),_0x413135(0xca)]],'include':[{'model':User_1['default']},{'model':Company_1[_0x413135(0xc4)]}]}),_0x138ac2&&(await _0x138ac2[_0x413135(0xb3)]({'status':'pending','userId':null,'unreadMessages':_0x26e495,'companyId':_0x58763b}),await(0x0,FindOrCreateATicketTrakingService_1[_0x413135(0xc4)])({'ticketId':_0x138ac2['id'],'companyId':_0x58763b,'whatsappId':_0x138ac2[_0x413135(0xb7)],'userId':_0x138ac2[_0x413135(0xcb)]}));}let _0x4042e5=_0xb77aae?.['id']||null;if(_0x5983cc){const _0xf377d=await Whatsapp_1['default']['findByPk'](_0x5c3635,{'include':[_0x413135(0xa7)]});_0xf377d?.[_0x413135(0xa7)][_0x413135(0xce)]===0x1&&(_0x4042e5=_0xf377d[_0x413135(0xa7)][0x0]['id']);}return!_0x138ac2&&(_0x138ac2=await Ticket_1['default'][_0x413135(0xb6)]({'contactId':_0x5983cc?_0x5983cc['id']:_0x510682['id'],'status':_0x413135(0xc2),'isGroup':!!_0x5983cc,'unreadMessages':_0x26e495,'whatsappId':_0x5c3635,'queueId':_0x4042e5,'companyId':_0x58763b}),_0x412037=!![],await(0x0,FindOrCreateATicketTrakingService_1[_0x413135(0xc4)])({'ticketId':_0x138ac2['id'],'companyId':_0x58763b,'whatsappId':_0x5c3635,'userId':_0x138ac2[_0x413135(0xcb)]})),_0x138ac2=await(0x0,ShowTicketService_1[_0x413135(0xc4)])(_0x138ac2['id'],_0x58763b),{'ticket':_0x138ac2,'justCreated':_0x412037};});return _0x3d0ceb;},FindOrCreateTicketService=async(_0x23a1f7,_0x188983,_0x370f78,_0x951c1,_0x43246d,_0x10008f,_0x1b131e)=>{const _0x1fa64e=a553_0x51c0b4,_0x28083e=await createTicketMutex[_0x1fa64e(0xba)]();try{return await internalFindOrCreateTicketService(_0x23a1f7,_0x188983,_0x370f78,_0x951c1,_0x43246d,_0x10008f,_0x1b131e);}finally{_0x28083e();}};exports['default']=FindOrCreateTicketService;