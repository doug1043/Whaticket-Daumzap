const a667_0x275b17=a667_0x3683;(function(_0x194ae6,_0x17ebdd){const _0x321a0f=a667_0x3683,_0x1349a9=_0x194ae6();while(!![]){try{const _0xdfc5a7=-parseInt(_0x321a0f(0x124))/0x1+parseInt(_0x321a0f(0x130))/0x2+-parseInt(_0x321a0f(0x13a))/0x3*(-parseInt(_0x321a0f(0x13d))/0x4)+-parseInt(_0x321a0f(0x144))/0x5+-parseInt(_0x321a0f(0x122))/0x6+-parseInt(_0x321a0f(0x12e))/0x7*(-parseInt(_0x321a0f(0x139))/0x8)+parseInt(_0x321a0f(0x141))/0x9;if(_0xdfc5a7===_0x17ebdd)break;else _0x1349a9['push'](_0x1349a9['shift']());}catch(_0x4759ba){_0x1349a9['push'](_0x1349a9['shift']());}}}(a667_0x1288,0x98547));const a667_0x242e4b=(function(){let _0x32c7d0=!![];return function(_0x4bb894,_0x354456){const _0x18d7bf=_0x32c7d0?function(){const _0x40c1e2=a667_0x3683;if(_0x354456){const _0x4e91de=_0x354456[_0x40c1e2(0x138)](_0x4bb894,arguments);return _0x354456=null,_0x4e91de;}}:function(){};return _0x32c7d0=![],_0x18d7bf;};}()),a667_0x59cb46=a667_0x242e4b(this,function(){const _0x47740a=a667_0x3683;return a667_0x59cb46[_0x47740a(0x12b)]()[_0x47740a(0x127)](_0x47740a(0x140))[_0x47740a(0x12b)]()['constructor'](a667_0x59cb46)[_0x47740a(0x127)](_0x47740a(0x140));});function a667_0x1288(){const _0x4e07a2=['apply','771960licAtZ','66ZhISVT','between','pending','143204AoOPZU','userId','../../helpers/CheckSettings','(((.+)+)+)+$','183978yJyRhW','whatsappId','async-mutex','3003090uKrRlJ','./FindOrCreateATicketTrakingService','./ShowTicketService','collectiveVacationStart','setHours','../../models/Whatsapp','default','length','../../models/Ticket','defineProperty','1478478HfkpbF','log','10702aBovvw','collectiveVacationMessage','findOne','search','autoReopenTimeout','collectiveVacationEnd','[Férias\x20Coletivas]\x20Novo\x20ticket\x20#','toString','Mutex','subMinutes','7tlVjFw','__importDefault','1154234HTNTVx','findByPk','update','acquire','DESC','queues','../../models/User','sequelize'];a667_0x1288=function(){return _0x4e07a2;};return a667_0x1288();}a667_0x59cb46();'use strict';var __importDefault=this&&this[a667_0x275b17(0x12f)]||function(_0x5c44a2){return _0x5c44a2&&_0x5c44a2['__esModule']?_0x5c44a2:{'default':_0x5c44a2};};function a667_0x3683(_0x3839d9,_0x46698d){const _0x520034=a667_0x1288();return a667_0x3683=function(_0x59cb46,_0x242e4b){_0x59cb46=_0x59cb46-0x11d;let _0x1288ce=_0x520034[_0x59cb46];return _0x1288ce;},a667_0x3683(_0x3839d9,_0x46698d);}Object[a667_0x275b17(0x121)](exports,'__esModule',{'value':!![]});const date_fns_1=require('date-fns'),sequelize_1=require(a667_0x275b17(0x137)),async_mutex_1=require(a667_0x275b17(0x143)),Ticket_1=__importDefault(require(a667_0x275b17(0x120))),ShowTicketService_1=__importDefault(require(a667_0x275b17(0x146))),FindOrCreateATicketTrakingService_1=__importDefault(require(a667_0x275b17(0x145))),CheckSettings_1=require(a667_0x275b17(0x13f)),database_1=__importDefault(require('../../database')),Whatsapp_1=__importDefault(require(a667_0x275b17(0x11d))),User_1=__importDefault(require(a667_0x275b17(0x136))),Company_1=__importDefault(require('../../models/Company')),createTicketMutex=new async_mutex_1[(a667_0x275b17(0x12c))](),isInCollectiveVacation=_0xa8013=>{const _0x4bc547=a667_0x275b17;if(!_0xa8013[_0x4bc547(0x125)]||!_0xa8013[_0x4bc547(0x147)]||!_0xa8013[_0x4bc547(0x129)])return![];const _0x3aea4c=new Date();_0x3aea4c[_0x4bc547(0x148)](0x0,0x0,0x0,0x0);const _0x163953=new Date(_0xa8013[_0x4bc547(0x147)]);_0x163953[_0x4bc547(0x148)](0x0,0x0,0x0,0x0);const _0x423641=new Date(_0xa8013['collectiveVacationEnd']);return _0x423641['setHours'](0x17,0x3b,0x3b,0x3e7),_0x3aea4c>=_0x163953&&_0x3aea4c<=_0x423641;},internalFindOrCreateTicketService=async(_0x10aa44,_0x36d017,_0x441675,_0x532a7d,_0x2c0654,_0x2fae8f,_0x59759f)=>{const _0xfeea20=a667_0x275b17;let _0x4c92b3=![];const _0x57bf8c=await database_1[_0xfeea20(0x11e)]['transaction'](async()=>{const _0x502e01=_0xfeea20,_0x2d31a1=await Whatsapp_1[_0x502e01(0x11e)]['findByPk'](_0x36d017),_0x2f5f5e=_0x2d31a1?isInCollectiveVacation(_0x2d31a1):![];let _0x4441c6=await Ticket_1[_0x502e01(0x11e)]['findOne']({'where':{'status':{[sequelize_1['Op']['or']]:['open',_0x502e01(0x13c)]},'contactId':_0x2c0654?_0x2c0654['id']:_0x10aa44['id'],'whatsappId':_0x36d017},'order':[['id',_0x502e01(0x134)]],'include':[{'model':User_1['default']},{'model':Company_1[_0x502e01(0x11e)]}]});_0x4441c6&&await _0x4441c6[_0x502e01(0x132)]({'unreadMessages':_0x441675,'ticketsWithWarning':![],'warningSentAt':null});!_0x4441c6&&_0x2c0654&&(_0x4441c6=await Ticket_1['default'][_0x502e01(0x126)]({'where':{'contactId':_0x2c0654['id'],'whatsappId':_0x36d017},'order':[['updatedAt','DESC']],'include':[{'model':User_1['default']},{'model':Company_1[_0x502e01(0x11e)]}]}),_0x4441c6&&(await _0x4441c6[_0x502e01(0x132)]({'status':'pending','userId':null,'unreadMessages':_0x441675,'companyId':_0x532a7d}),await(0x0,FindOrCreateATicketTrakingService_1[_0x502e01(0x11e)])({'ticketId':_0x4441c6['id'],'companyId':_0x532a7d,'whatsappId':_0x4441c6[_0x502e01(0x142)],'userId':_0x4441c6[_0x502e01(0x13e)]})));if(!_0x2fae8f&&!_0x4441c6&&!_0x2c0654){const _0x1844bc=parseInt(await(0x0,CheckSettings_1['GetCompanySetting'])(_0x532a7d,_0x502e01(0x128),'0'),0xa);_0x4441c6=_0x1844bc&&await Ticket_1['default'][_0x502e01(0x126)]({'where':{'updatedAt':{[sequelize_1['Op'][_0x502e01(0x13b)]]:[+(0x0,date_fns_1[_0x502e01(0x12d)])(new Date(),_0x1844bc),+new Date()]},'contactId':_0x10aa44['id'],'whatsappId':_0x36d017},'order':[['updatedAt',_0x502e01(0x134)]],'include':[{'model':User_1[_0x502e01(0x11e)]},{'model':Company_1['default']}]}),_0x4441c6&&(await _0x4441c6[_0x502e01(0x132)]({'status':_0x502e01(0x13c),'userId':null,'unreadMessages':_0x441675,'companyId':_0x532a7d}),await(0x0,FindOrCreateATicketTrakingService_1[_0x502e01(0x11e)])({'ticketId':_0x4441c6['id'],'companyId':_0x532a7d,'whatsappId':_0x4441c6[_0x502e01(0x142)],'userId':_0x4441c6[_0x502e01(0x13e)]}));}let _0x4f8faf=_0x59759f?.['id']||null;if(_0x2c0654){const _0x5f8f48=await Whatsapp_1[_0x502e01(0x11e)][_0x502e01(0x131)](_0x36d017,{'include':[_0x502e01(0x135)]});_0x5f8f48?.[_0x502e01(0x135)][_0x502e01(0x11f)]===0x1&&(_0x4f8faf=_0x5f8f48[_0x502e01(0x135)][0x0]['id']);}return!_0x4441c6&&(_0x4441c6=await Ticket_1[_0x502e01(0x11e)]['create']({'contactId':_0x2c0654?_0x2c0654['id']:_0x10aa44['id'],'status':_0x502e01(0x13c),'isGroup':!!_0x2c0654,'unreadMessages':_0x441675,'whatsappId':_0x36d017,'queueId':_0x4f8faf,'companyId':_0x532a7d}),_0x4c92b3=!![],_0x2f5f5e&&console[_0x502e01(0x123)](_0x502e01(0x12a)+_0x4441c6['id']+'\x20criado\x20-\x20enviará\x20mensagem\x20de\x20férias'),await(0x0,FindOrCreateATicketTrakingService_1[_0x502e01(0x11e)])({'ticketId':_0x4441c6['id'],'companyId':_0x532a7d,'whatsappId':_0x36d017,'userId':_0x4441c6[_0x502e01(0x13e)]})),_0x4441c6=await(0x0,ShowTicketService_1[_0x502e01(0x11e)])(_0x4441c6['id'],_0x532a7d),{'ticket':_0x4441c6,'justCreated':_0x4c92b3,'inVacation':_0x2f5f5e};});return _0x57bf8c;},FindOrCreateTicketService=async(_0x1388bc,_0x42c2f0,_0x52a87d,_0x3ece31,_0x436c44,_0x5c12a4,_0x347748)=>{const _0x48940b=a667_0x275b17,_0x4de35b=await createTicketMutex[_0x48940b(0x133)]();try{return await internalFindOrCreateTicketService(_0x1388bc,_0x42c2f0,_0x52a87d,_0x3ece31,_0x436c44,_0x5c12a4,_0x347748);}finally{_0x4de35b();}};exports[a667_0x275b17(0x11e)]=FindOrCreateTicketService;