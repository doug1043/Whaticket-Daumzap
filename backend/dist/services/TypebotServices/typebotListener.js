const a533_0x1600b9=a533_0x2378;function a533_0x2378(_0x40f264,_0x4a023b){const _0x589207=a533_0x4d62();return a533_0x2378=function(_0x3ea4df,_0xd71623){_0x3ea4df=_0x3ea4df-0x146;let _0x4d62c6=_0x589207[_0x3ea4df];return _0x4d62c6;},a533_0x2378(_0x40f264,_0x4a023b);}(function(_0x1c6424,_0x1c27ec){const _0x542627=a533_0x2378,_0x4eb3e7=_0x1c6424();while(!![]){try{const _0x4825a2=parseInt(_0x542627(0x174))/0x1*(parseInt(_0x542627(0x16b))/0x2)+parseInt(_0x542627(0x178))/0x3*(-parseInt(_0x542627(0x16c))/0x4)+parseInt(_0x542627(0x164))/0x5*(-parseInt(_0x542627(0x151))/0x6)+parseInt(_0x542627(0x148))/0x7+parseInt(_0x542627(0x167))/0x8+parseInt(_0x542627(0x15a))/0x9*(parseInt(_0x542627(0x15b))/0xa)+-parseInt(_0x542627(0x18a))/0xb*(parseInt(_0x542627(0x15d))/0xc);if(_0x4825a2===_0x1c27ec)break;else _0x4eb3e7['push'](_0x4eb3e7['shift']());}catch(_0x138ab5){_0x4eb3e7['push'](_0x4eb3e7['shift']());}}}(a533_0x4d62,0xb13e9));const a533_0xd71623=(function(){let _0x2e4c2f=!![];return function(_0x2bd0b3,_0x49ed39){const _0x300faf=_0x2e4c2f?function(){const _0xa61419=a533_0x2378;if(_0x49ed39){const _0x3faf9a=_0x49ed39[_0xa61419(0x17b)](_0x2bd0b3,arguments);return _0x49ed39=null,_0x3faf9a;}}:function(){};return _0x2e4c2f=![],_0x300faf;};}()),a533_0x3ea4df=a533_0xd71623(this,function(){const _0xb27e9d=a533_0x2378;return a533_0x3ea4df[_0xb27e9d(0x15c)]()[_0xb27e9d(0x150)](_0xb27e9d(0x17d))[_0xb27e9d(0x15c)]()['constructor'](a533_0x3ea4df)[_0xb27e9d(0x150)]('(((.+)+)+)+$');});function a533_0x4d62(){const _0x31bbf5=['default','post','length','items','SendPresenceStatus','typebotStatus','content','2zYbJao','stringify','/continueChat','../../helpers/SendPresenceStatus','18399kXSTlc','../TicketServices/UpdateTicketService','update','apply','application/json','(((.+)+)+)+$','__esModule','choice\x20input','parse','status@broadcast','input','../WbotServices/wbotMessageListener','sessionId','lodash','companyId','text','userId','defineProperty','382591Gahljv','reload','stopBot','request','key','messages','8660281qMCNjT','contact','children','underline','Erro\x20ao\x20criar\x20sessão\x20do\x20typebot:\x20','/api/v1/typebots/','/startChat','typebotSessionId','search','1275420FkbTrb','audio/mp4','pushName','italic','type','remoteJid','replace','@c.us','string','198DLYEjz','29690xYNDJN','toString','372Uafoin','isNil','data','bold','audio','Error\x20on\x20typebotListener:\x20','Invalid\x20message.\x20Please,\x20try\x20again.','5uyOxWE','info','queueId','977600CKCrpD','logger','sendMessage','url','978452rhhVgu','252bJpnKl'];a533_0x4d62=function(){return _0x31bbf5;};return a533_0x4d62();}a533_0x3ea4df();'use strict';var __importDefault=this&&this['__importDefault']||function(_0xe17058){return _0xe17058&&_0xe17058['__esModule']?_0xe17058:{'default':_0xe17058};};Object[a533_0x1600b9(0x189)](exports,a533_0x1600b9(0x17e),{'value':!![]});const axios_1=__importDefault(require('axios')),wbotMessageListener_1=require(a533_0x1600b9(0x183)),logger_1=require('../../utils/logger'),lodash_1=require(a533_0x1600b9(0x185)),UpdateTicketService_1=__importDefault(require(a533_0x1600b9(0x179))),SendPresenceStatus_1=require(a533_0x1600b9(0x177)),typebotListener=async({wbot:_0xa21b2,msg:_0x466f5e,ticket:_0xbf14d,typebot:_0x318d7b})=>{const _0x4d5b89=a533_0x1600b9;if(_0x466f5e[_0x4d5b89(0x146)]['remoteJid']===_0x4d5b89(0x181))return;const {urlN8N:_0x39c9dd,typebotExpires:_0x553187,typebotKeywordFinish:_0x1450ff,typebotKeywordRestart:_0x3da644,typebotUnknownMessage:_0x5bf292,typebotSlug:_0x407f56,typebotDelayMessage:_0x24c835,typebotRestartMessage:_0x516167}=_0x318d7b,_0x2cac06=_0x466f5e[_0x4d5b89(0x146)][_0x4d5b89(0x156)][_0x4d5b89(0x157)](/\D/g,'');let _0x4c0d98=(0x0,wbotMessageListener_1['getBodyMessage'])(_0x466f5e);async function _0x3207ff(_0x3e55fc,_0x58e9aa,_0x42af42){const _0x5b22ac=_0x4d5b89;try{const _0x354f7d=JSON[_0x5b22ac(0x175)]({'isStreamEnabled':!![],'message':_0x5b22ac(0x159),'resultId':_0x5b22ac(0x159),'isOnlyRegistering':![],'prefilledVariables':{'number':_0x42af42,'pushName':_0x3e55fc[_0x5b22ac(0x153)]||'','remoteJid':_0xbf14d?.[_0x5b22ac(0x149)]?.[_0x5b22ac(0x156)]}}),_0x226a40={'method':_0x5b22ac(0x16e),'maxBodyLength':Infinity,'url':_0x39c9dd+_0x5b22ac(0x14d)+_0x407f56+_0x5b22ac(0x14e),'headers':{'Content-Type':_0x5b22ac(0x17c),'Accept':_0x5b22ac(0x17c)},'data':_0x354f7d},_0x577896=await axios_1['default'][_0x5b22ac(0x18d)](_0x226a40);return _0x577896[_0x5b22ac(0x15f)];}catch(_0x7c1af3){logger_1[_0x5b22ac(0x168)]['info'](_0x5b22ac(0x14c),_0x7c1af3);throw _0x7c1af3;}}let _0x4c704c,_0x253a25,_0x22ba38=![];try{const _0x182f9d=new Date();_0x182f9d['setMinutes'](_0x182f9d['getMinutes']()-Number(_0x553187));_0x553187>0x0&&_0xbf14d['updatedAt']<_0x182f9d&&(await _0xbf14d[_0x4d5b89(0x17a)]({'typebotSessionId':null,'chatbot':!![]}),await _0xbf14d[_0x4d5b89(0x18b)]());!_0xbf14d[_0x4d5b89(0x14f)]?(_0x253a25=await _0x3207ff(_0x466f5e,_0x318d7b,_0x2cac06),_0x4c704c=_0x253a25[_0x4d5b89(0x184)],_0x22ba38=!![],await _0xbf14d[_0x4d5b89(0x17a)]({'typebotSessionId':_0x4c704c,'typebotStatus':!![],'useIntegration':!![],'integrationId':_0x318d7b['id']}),await _0xbf14d[_0x4d5b89(0x18b)]()):(_0x4c704c=_0xbf14d['typebotSessionId'],_0x22ba38=_0xbf14d[_0x4d5b89(0x172)]);if(!_0x22ba38)return;;if(_0x4c0d98!==_0x1450ff&&_0x4c0d98!==_0x3da644){let _0x38b43d,_0x29f6db,_0x3f1650;if(_0x253a25?.[_0x4d5b89(0x147)][_0x4d5b89(0x16f)]===0x0||_0x253a25===undefined){const _0x47cf1b=JSON[_0x4d5b89(0x175)]({'message':_0x4c0d98});let _0x34bb05={'method':_0x4d5b89(0x16e),'maxBodyLength':Infinity,'url':_0x39c9dd+'/api/v1/sessions/'+_0x4c704c+_0x4d5b89(0x176),'headers':{'Content-Type':_0x4d5b89(0x17c),'Accept':_0x4d5b89(0x17c)},'data':_0x47cf1b};_0x38b43d=await axios_1['default'][_0x4d5b89(0x18d)](_0x34bb05),_0x29f6db=_0x38b43d['data']?.[_0x4d5b89(0x147)],_0x3f1650=_0x38b43d[_0x4d5b89(0x15f)]?.[_0x4d5b89(0x182)];}else _0x29f6db=_0x253a25?.[_0x4d5b89(0x147)],_0x3f1650=_0x253a25?.[_0x4d5b89(0x182)];if(_0x29f6db?.['length']===0x0)await _0xa21b2[_0x4d5b89(0x169)](_0x2cac06+_0x4d5b89(0x158),{'text':_0x5bf292});else{for(const _0x394f97 of _0x29f6db){if(_0x394f97[_0x4d5b89(0x155)]===_0x4d5b89(0x187)){let _0xce36e9='',_0x129875=![];for(const _0x2fc251 of _0x394f97[_0x4d5b89(0x173)]['richText']){for(const _0x567741 of _0x2fc251[_0x4d5b89(0x14a)]){let _0x2170b9='';_0x567741[_0x4d5b89(0x187)]&&(_0x2170b9=_0x567741[_0x4d5b89(0x187)]);if(_0x567741[_0x4d5b89(0x155)]&&_0x567741['children'])for(const _0x53d383 of _0x567741['children']){let _0x1aadc1='';_0x53d383['text']&&(_0x1aadc1=_0x53d383[_0x4d5b89(0x187)]);if(_0x53d383['type']&&_0x53d383[_0x4d5b89(0x14a)])for(const _0x427d2a of _0x53d383['children']){let _0x4d9a54='';_0x427d2a[_0x4d5b89(0x187)]&&(_0x4d9a54=_0x427d2a['text']);_0x427d2a[_0x4d5b89(0x160)]&&(_0x4d9a54='*'+_0x4d9a54+'*');_0x427d2a[_0x4d5b89(0x154)]&&(_0x4d9a54='_'+_0x4d9a54+'_');_0x427d2a[_0x4d5b89(0x14b)]&&(_0x4d9a54='~'+_0x4d9a54+'~');if(_0x427d2a[_0x4d5b89(0x16a)]){const _0x2c8db5=_0x427d2a[_0x4d5b89(0x14a)][0x0]['text'];_0x4d9a54='['+_0x2c8db5+']('+_0x427d2a[_0x4d5b89(0x16a)]+')',_0x129875=!![];}_0xce36e9+=_0x4d9a54;}_0x53d383[_0x4d5b89(0x160)]&&(_0x1aadc1='*'+_0x1aadc1+'*');_0x53d383['italic']&&(_0x1aadc1='_'+_0x1aadc1+'_');_0x53d383[_0x4d5b89(0x14b)]&&(_0x1aadc1='~'+_0x1aadc1+'~');if(_0x53d383[_0x4d5b89(0x16a)]){const _0x5b2192=_0x53d383[_0x4d5b89(0x14a)][0x0][_0x4d5b89(0x187)];_0x1aadc1='['+_0x5b2192+']('+_0x53d383[_0x4d5b89(0x16a)]+')',_0x129875=!![];}_0xce36e9+=_0x1aadc1;}_0x567741[_0x4d5b89(0x160)]&&(_0x2170b9='*'+_0x2170b9+'*');_0x567741[_0x4d5b89(0x154)]&&(_0x2170b9='_'+_0x2170b9+'_');_0x567741[_0x4d5b89(0x14b)]&&(_0x2170b9='~'+_0x2170b9+'~');if(_0x567741[_0x4d5b89(0x16a)]){const _0x47247b=_0x567741[_0x4d5b89(0x14a)][0x0]['text'];_0x2170b9='['+_0x47247b+']('+_0x567741[_0x4d5b89(0x16a)]+')',_0x129875=!![];}_0xce36e9+=_0x2170b9;}_0xce36e9+='\x0a';}_0xce36e9=_0xce36e9[_0x4d5b89(0x157)]('**','')[_0x4d5b89(0x157)](/\n$/,'');_0xce36e9===_0x4d5b89(0x163)&&(_0xce36e9=_0x5bf292);if(_0xce36e9['startsWith']('#')){let _0x4ddce8=_0xce36e9['replace']('#','');try{let _0x39ff87=JSON[_0x4d5b89(0x180)](_0x4ddce8);if(_0x39ff87[_0x4d5b89(0x18c)]&&(0x0,lodash_1[_0x4d5b89(0x15e)])(_0x39ff87[_0x4d5b89(0x188)])&&(0x0,lodash_1[_0x4d5b89(0x15e)])(_0x39ff87['queueId'])){await _0xbf14d[_0x4d5b89(0x17a)]({'useIntegration':![],'chatbot':![]});return;}if(!(0x0,lodash_1[_0x4d5b89(0x15e)])(_0x39ff87['queueId'])&&_0x39ff87['queueId']>0x0&&(0x0,lodash_1[_0x4d5b89(0x15e)])(_0x39ff87[_0x4d5b89(0x188)])){await(0x0,UpdateTicketService_1['default'])({'ticketData':{'queueId':_0x39ff87['queueId'],'chatbot':![],'useIntegration':![],'integrationId':null},'ticketId':_0xbf14d['id'],'companyId':_0xbf14d[_0x4d5b89(0x186)]});return;}if(!(0x0,lodash_1['isNil'])(_0x39ff87[_0x4d5b89(0x166)])&&_0x39ff87['queueId']>0x0&&!(0x0,lodash_1[_0x4d5b89(0x15e)])(_0x39ff87['userId'])&&_0x39ff87[_0x4d5b89(0x188)]>0x0){await(0x0,UpdateTicketService_1['default'])({'ticketData':{'queueId':_0x39ff87['queueId'],'userId':_0x39ff87['userId'],'chatbot':![],'useIntegration':![],'integrationId':null},'ticketId':_0xbf14d['id'],'companyId':_0xbf14d[_0x4d5b89(0x186)]});return;}}catch(_0x152b98){throw _0x152b98;}}await(0x0,SendPresenceStatus_1[_0x4d5b89(0x171)])(_0xa21b2,_0x466f5e['key']['remoteJid'],_0x24c835),await _0xa21b2[_0x4d5b89(0x169)](_0x466f5e[_0x4d5b89(0x146)][_0x4d5b89(0x156)],{'text':_0xce36e9});}if(_0x394f97[_0x4d5b89(0x155)]===_0x4d5b89(0x161)){await(0x0,SendPresenceStatus_1[_0x4d5b89(0x171)])(_0xa21b2,_0x466f5e[_0x4d5b89(0x146)]['remoteJid'],_0x24c835);const _0x44256e={'audio':{'url':_0x394f97[_0x4d5b89(0x173)][_0x4d5b89(0x16a)],'mimetype':_0x4d5b89(0x152),'ptt':!![]}};await _0xa21b2['sendMessage'](_0x466f5e[_0x4d5b89(0x146)][_0x4d5b89(0x156)],_0x44256e);}if(_0x394f97[_0x4d5b89(0x155)]==='image'){await(0x0,SendPresenceStatus_1[_0x4d5b89(0x171)])(_0xa21b2,_0x466f5e[_0x4d5b89(0x146)][_0x4d5b89(0x156)],_0x24c835);const _0x458cf9={'image':{'url':_0x394f97['content']['url']}};await _0xa21b2[_0x4d5b89(0x169)](_0x466f5e['key'][_0x4d5b89(0x156)],_0x458cf9);}}if(_0x3f1650){if(_0x3f1650[_0x4d5b89(0x155)]===_0x4d5b89(0x17f)){let _0x182704='';const _0x5611f8=_0x3f1650[_0x4d5b89(0x170)];for(const _0x31c878 of _0x5611f8){_0x182704+='▶️\x20'+_0x31c878[_0x4d5b89(0x173)]+'\x0a';}_0x182704=_0x182704[_0x4d5b89(0x157)](/\n$/,''),await(0x0,SendPresenceStatus_1[_0x4d5b89(0x171)])(_0xa21b2,_0x466f5e[_0x4d5b89(0x146)][_0x4d5b89(0x156)],_0x24c835),await _0xa21b2[_0x4d5b89(0x169)](_0x466f5e[_0x4d5b89(0x146)][_0x4d5b89(0x156)],{'text':_0x182704});}}}}_0x4c0d98===_0x3da644&&(await _0xbf14d[_0x4d5b89(0x17a)]({'chatbot':!![],'typebotSessionId':null}),await _0xbf14d[_0x4d5b89(0x18b)](),await _0xa21b2[_0x4d5b89(0x169)](_0x2cac06+_0x4d5b89(0x158),{'text':_0x516167}));if(_0x4c0d98===_0x1450ff){await(0x0,UpdateTicketService_1[_0x4d5b89(0x16d)])({'ticketData':{'status':'closed','useIntegration':![],'integrationId':null},'ticketId':_0xbf14d['id'],'companyId':_0xbf14d[_0x4d5b89(0x186)]});return;}}catch(_0x4852a0){logger_1[_0x4d5b89(0x168)][_0x4d5b89(0x165)](_0x4d5b89(0x162),_0x4852a0),await _0xbf14d[_0x4d5b89(0x17a)]({'typebotSessionId':null});}};exports['default']=typebotListener;