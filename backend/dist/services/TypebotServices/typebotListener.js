const a532_0x12fc42=a532_0x5cbf;(function(_0x46527d,_0x4bf754){const _0x576e7e=a532_0x5cbf,_0x20ad87=_0x46527d();while(!![]){try{const _0x5cd5af=-parseInt(_0x576e7e(0xcf))/0x1*(-parseInt(_0x576e7e(0xe9))/0x2)+-parseInt(_0x576e7e(0xfd))/0x3+parseInt(_0x576e7e(0xff))/0x4+parseInt(_0x576e7e(0x106))/0x5+parseInt(_0x576e7e(0xd0))/0x6*(parseInt(_0x576e7e(0x103))/0x7)+parseInt(_0x576e7e(0xf3))/0x8+parseInt(_0x576e7e(0x100))/0x9*(-parseInt(_0x576e7e(0xf4))/0xa);if(_0x5cd5af===_0x4bf754)break;else _0x20ad87['push'](_0x20ad87['shift']());}catch(_0x400179){_0x20ad87['push'](_0x20ad87['shift']());}}}(a532_0x261b,0x34fe6));const a532_0x53bc98=(function(){let _0x453934=!![];return function(_0x19d46d,_0x128290){const _0x436560=_0x453934?function(){if(_0x128290){const _0x4aa11e=_0x128290['apply'](_0x19d46d,arguments);return _0x128290=null,_0x4aa11e;}}:function(){};return _0x453934=![],_0x436560;};}()),a532_0x4fcf11=a532_0x53bc98(this,function(){const _0x3a855d=a532_0x5cbf;return a532_0x4fcf11[_0x3a855d(0xeb)]()['search'](_0x3a855d(0xf1))[_0x3a855d(0xeb)]()[_0x3a855d(0xed)](a532_0x4fcf11)[_0x3a855d(0x112)](_0x3a855d(0xf1));});a532_0x4fcf11();'use strict';var __importDefault=this&&this[a532_0x12fc42(0x114)]||function(_0x191503){const _0x180c0e=a532_0x12fc42;return _0x191503&&_0x191503[_0x180c0e(0xdb)]?_0x191503:{'default':_0x191503};};function a532_0x5cbf(_0x35a0b2,_0x3c1733){const _0x17ec3e=a532_0x261b();return a532_0x5cbf=function(_0x4fcf11,_0x53bc98){_0x4fcf11=_0x4fcf11-0xcf;let _0x261bb2=_0x17ec3e[_0x4fcf11];return _0x261bb2;},a532_0x5cbf(_0x35a0b2,_0x3c1733);}Object[a532_0x12fc42(0xf0)](exports,a532_0x12fc42(0xdb),{'value':!![]});function a532_0x261b(){const _0x143074=['post','content','underline','stringify','replace','audio/mp4','request','userId','SendPresenceStatus','closed','status@broadcast','107444vvhUrL','info','toString','type','constructor','@c.us','data','defineProperty','(((.+)+)+)+$','input','863608dFvhpS','57370AqXAAX','length','../../helpers/SendPresenceStatus','/api/v1/sessions/','queueId','../TicketServices/UpdateTicketService','sessionId','logger','application/json','99831DlxRvc','../WbotServices/wbotMessageListener','1007352gBYXqP','1170sZcdKj','/startChat','italic','37639CCmDeK','default','Invalid\x20message.\x20Please,\x20try\x20again.','1542055kzOJAZ','contact','isNil','reload','image','companyId','children','bold','string','startsWith','axios','text','search','parse','__importDefault','url','getBodyMessage','1QnHxMd','306KocRdw','typebotStatus','key','getMinutes','typebotSessionId','stopBot','remoteJid','choice\x20input','messages','sendMessage','update','__esModule','pushName','updatedAt'];a532_0x261b=function(){return _0x143074;};return a532_0x261b();}const axios_1=__importDefault(require(a532_0x12fc42(0x110))),wbotMessageListener_1=require(a532_0x12fc42(0xfe)),logger_1=require('../../utils/logger'),lodash_1=require('lodash'),UpdateTicketService_1=__importDefault(require(a532_0x12fc42(0xf9))),SendPresenceStatus_1=require(a532_0x12fc42(0xf6)),typebotListener=async({wbot:_0x32d662,msg:_0x282570,ticket:_0x1532eb,typebot:_0x54f9b5})=>{const _0x140f4b=a532_0x12fc42;if(_0x282570[_0x140f4b(0xd2)][_0x140f4b(0xd6)]===_0x140f4b(0xe8))return;const {urlN8N:_0x28cca7,typebotExpires:_0x36faca,typebotKeywordFinish:_0x1af38c,typebotKeywordRestart:_0x274dd9,typebotUnknownMessage:_0x23e425,typebotSlug:_0x9d404f,typebotDelayMessage:_0x3d118e,typebotRestartMessage:_0x41b071}=_0x54f9b5,_0x37b88d=_0x282570['key']['remoteJid'][_0x140f4b(0xe2)](/\D/g,'');let _0x429c4e=(0x0,wbotMessageListener_1[_0x140f4b(0x116)])(_0x282570);async function _0x26eb40(_0xf691ce,_0x51cf83,_0x372469){const _0x50d350=_0x140f4b;try{const _0x297c2d=JSON[_0x50d350(0xe1)]({'isStreamEnabled':!![],'message':'string','resultId':_0x50d350(0x10e),'isOnlyRegistering':![],'prefilledVariables':{'number':_0x372469,'pushName':_0xf691ce[_0x50d350(0xdc)]||'','remoteJid':_0x1532eb?.[_0x50d350(0x107)]?.[_0x50d350(0xd6)]}}),_0xda7111={'method':_0x50d350(0xde),'maxBodyLength':Infinity,'url':_0x28cca7+'/api/v1/typebots/'+_0x9d404f+_0x50d350(0x101),'headers':{'Content-Type':_0x50d350(0xfc),'Accept':_0x50d350(0xfc)},'data':_0x297c2d},_0x8f3c0f=await axios_1[_0x50d350(0x104)][_0x50d350(0xe4)](_0xda7111);return _0x8f3c0f[_0x50d350(0xef)];}catch(_0x43639d){logger_1[_0x50d350(0xfb)][_0x50d350(0xea)]('Erro\x20ao\x20criar\x20sessÃ£o\x20do\x20typebot:\x20',_0x43639d);throw _0x43639d;}}let _0x3615b2,_0x3b6eab,_0x7a56d9=![];try{const _0x393a46=new Date();_0x393a46['setMinutes'](_0x393a46[_0x140f4b(0xd3)]()-Number(_0x36faca));_0x36faca>0x0&&_0x1532eb[_0x140f4b(0xdd)]<_0x393a46&&(await _0x1532eb[_0x140f4b(0xda)]({'typebotSessionId':null,'chatbot':!![]}),await _0x1532eb[_0x140f4b(0x109)]());!_0x1532eb[_0x140f4b(0xd4)]?(_0x3b6eab=await _0x26eb40(_0x282570,_0x54f9b5,_0x37b88d),_0x3615b2=_0x3b6eab[_0x140f4b(0xfa)],_0x7a56d9=!![],await _0x1532eb[_0x140f4b(0xda)]({'typebotSessionId':_0x3615b2,'typebotStatus':!![],'useIntegration':!![],'integrationId':_0x54f9b5['id']}),await _0x1532eb[_0x140f4b(0x109)]()):(_0x3615b2=_0x1532eb[_0x140f4b(0xd4)],_0x7a56d9=_0x1532eb[_0x140f4b(0xd1)]);if(!_0x7a56d9)return;;if(_0x429c4e!==_0x1af38c&&_0x429c4e!==_0x274dd9){let _0x308020,_0x5114de,_0x4e1c28;if(_0x3b6eab?.[_0x140f4b(0xd8)][_0x140f4b(0xf5)]===0x0||_0x3b6eab===undefined){const _0x38f1e8=JSON[_0x140f4b(0xe1)]({'message':_0x429c4e});let _0x53c6f1={'method':_0x140f4b(0xde),'maxBodyLength':Infinity,'url':_0x28cca7+_0x140f4b(0xf7)+_0x3615b2+'/continueChat','headers':{'Content-Type':'application/json','Accept':_0x140f4b(0xfc)},'data':_0x38f1e8};_0x308020=await axios_1[_0x140f4b(0x104)][_0x140f4b(0xe4)](_0x53c6f1),_0x5114de=_0x308020[_0x140f4b(0xef)]?.[_0x140f4b(0xd8)],_0x4e1c28=_0x308020['data']?.['input'];}else _0x5114de=_0x3b6eab?.[_0x140f4b(0xd8)],_0x4e1c28=_0x3b6eab?.[_0x140f4b(0xf2)];if(_0x5114de?.[_0x140f4b(0xf5)]===0x0)await _0x32d662['sendMessage'](_0x37b88d+_0x140f4b(0xee),{'text':_0x23e425});else{for(const _0x59f47c of _0x5114de){if(_0x59f47c[_0x140f4b(0xec)]===_0x140f4b(0x111)){let _0x3c47bf='',_0xd04f7e=![];for(const _0x339d7c of _0x59f47c[_0x140f4b(0xdf)]['richText']){for(const _0x474066 of _0x339d7c[_0x140f4b(0x10c)]){let _0x1cfecf='';_0x474066[_0x140f4b(0x111)]&&(_0x1cfecf=_0x474066[_0x140f4b(0x111)]);if(_0x474066['type']&&_0x474066['children'])for(const _0x106c7c of _0x474066[_0x140f4b(0x10c)]){let _0x567fc1='';_0x106c7c['text']&&(_0x567fc1=_0x106c7c[_0x140f4b(0x111)]);if(_0x106c7c[_0x140f4b(0xec)]&&_0x106c7c['children'])for(const _0x54c1c2 of _0x106c7c[_0x140f4b(0x10c)]){let _0x1a61ef='';_0x54c1c2[_0x140f4b(0x111)]&&(_0x1a61ef=_0x54c1c2[_0x140f4b(0x111)]);_0x54c1c2[_0x140f4b(0x10d)]&&(_0x1a61ef='*'+_0x1a61ef+'*');_0x54c1c2[_0x140f4b(0x102)]&&(_0x1a61ef='_'+_0x1a61ef+'_');_0x54c1c2['underline']&&(_0x1a61ef='~'+_0x1a61ef+'~');if(_0x54c1c2[_0x140f4b(0x115)]){const _0x34485b=_0x54c1c2[_0x140f4b(0x10c)][0x0]['text'];_0x1a61ef='['+_0x34485b+']('+_0x54c1c2[_0x140f4b(0x115)]+')',_0xd04f7e=!![];}_0x3c47bf+=_0x1a61ef;}_0x106c7c['bold']&&(_0x567fc1='*'+_0x567fc1+'*');_0x106c7c[_0x140f4b(0x102)]&&(_0x567fc1='_'+_0x567fc1+'_');_0x106c7c['underline']&&(_0x567fc1='~'+_0x567fc1+'~');if(_0x106c7c[_0x140f4b(0x115)]){const _0x3ba631=_0x106c7c[_0x140f4b(0x10c)][0x0][_0x140f4b(0x111)];_0x567fc1='['+_0x3ba631+']('+_0x106c7c[_0x140f4b(0x115)]+')',_0xd04f7e=!![];}_0x3c47bf+=_0x567fc1;}_0x474066[_0x140f4b(0x10d)]&&(_0x1cfecf='*'+_0x1cfecf+'*');_0x474066[_0x140f4b(0x102)]&&(_0x1cfecf='_'+_0x1cfecf+'_');_0x474066[_0x140f4b(0xe0)]&&(_0x1cfecf='~'+_0x1cfecf+'~');if(_0x474066[_0x140f4b(0x115)]){const _0x3c8e06=_0x474066[_0x140f4b(0x10c)][0x0][_0x140f4b(0x111)];_0x1cfecf='['+_0x3c8e06+']('+_0x474066[_0x140f4b(0x115)]+')',_0xd04f7e=!![];}_0x3c47bf+=_0x1cfecf;}_0x3c47bf+='\x0a';}_0x3c47bf=_0x3c47bf['replace']('**','')['replace'](/\n$/,'');_0x3c47bf===_0x140f4b(0x105)&&(_0x3c47bf=_0x23e425);if(_0x3c47bf[_0x140f4b(0x10f)]('#')){let _0x400f86=_0x3c47bf[_0x140f4b(0xe2)]('#','');try{let _0x4b6744=JSON[_0x140f4b(0x113)](_0x400f86);if(_0x4b6744[_0x140f4b(0xd5)]&&(0x0,lodash_1[_0x140f4b(0x108)])(_0x4b6744['userId'])&&(0x0,lodash_1[_0x140f4b(0x108)])(_0x4b6744[_0x140f4b(0xf8)])){await _0x1532eb[_0x140f4b(0xda)]({'useIntegration':![],'chatbot':![]});return;}if(!(0x0,lodash_1[_0x140f4b(0x108)])(_0x4b6744[_0x140f4b(0xf8)])&&_0x4b6744[_0x140f4b(0xf8)]>0x0&&(0x0,lodash_1[_0x140f4b(0x108)])(_0x4b6744[_0x140f4b(0xe5)])){await(0x0,UpdateTicketService_1[_0x140f4b(0x104)])({'ticketData':{'queueId':_0x4b6744[_0x140f4b(0xf8)],'chatbot':![],'useIntegration':![],'integrationId':null},'ticketId':_0x1532eb['id'],'companyId':_0x1532eb['companyId']});return;}if(!(0x0,lodash_1['isNil'])(_0x4b6744[_0x140f4b(0xf8)])&&_0x4b6744[_0x140f4b(0xf8)]>0x0&&!(0x0,lodash_1[_0x140f4b(0x108)])(_0x4b6744[_0x140f4b(0xe5)])&&_0x4b6744[_0x140f4b(0xe5)]>0x0){await(0x0,UpdateTicketService_1[_0x140f4b(0x104)])({'ticketData':{'queueId':_0x4b6744['queueId'],'userId':_0x4b6744[_0x140f4b(0xe5)],'chatbot':![],'useIntegration':![],'integrationId':null},'ticketId':_0x1532eb['id'],'companyId':_0x1532eb[_0x140f4b(0x10b)]});return;}}catch(_0x2278e5){throw _0x2278e5;}}await(0x0,SendPresenceStatus_1[_0x140f4b(0xe6)])(_0x32d662,_0x282570[_0x140f4b(0xd2)][_0x140f4b(0xd6)],_0x3d118e),await _0x32d662[_0x140f4b(0xd9)](_0x282570[_0x140f4b(0xd2)]['remoteJid'],{'text':_0x3c47bf});}if(_0x59f47c[_0x140f4b(0xec)]==='audio'){await(0x0,SendPresenceStatus_1[_0x140f4b(0xe6)])(_0x32d662,_0x282570[_0x140f4b(0xd2)]['remoteJid'],_0x3d118e);const _0xbb84de={'audio':{'url':_0x59f47c[_0x140f4b(0xdf)][_0x140f4b(0x115)],'mimetype':_0x140f4b(0xe3),'ptt':!![]}};await _0x32d662['sendMessage'](_0x282570[_0x140f4b(0xd2)]['remoteJid'],_0xbb84de);}if(_0x59f47c[_0x140f4b(0xec)]===_0x140f4b(0x10a)){await(0x0,SendPresenceStatus_1['SendPresenceStatus'])(_0x32d662,_0x282570['key'][_0x140f4b(0xd6)],_0x3d118e);const _0x5ca06e={'image':{'url':_0x59f47c[_0x140f4b(0xdf)]['url']}};await _0x32d662['sendMessage'](_0x282570[_0x140f4b(0xd2)]['remoteJid'],_0x5ca06e);}}if(_0x4e1c28){if(_0x4e1c28[_0x140f4b(0xec)]===_0x140f4b(0xd7)){let _0x116f86='';const _0x83a51c=_0x4e1c28['items'];for(const _0x41a64c of _0x83a51c){_0x116f86+='â¶ï¸\x20'+_0x41a64c[_0x140f4b(0xdf)]+'\x0a';}_0x116f86=_0x116f86[_0x140f4b(0xe2)](/\n$/,''),await(0x0,SendPresenceStatus_1['SendPresenceStatus'])(_0x32d662,_0x282570['key'][_0x140f4b(0xd6)],_0x3d118e),await _0x32d662['sendMessage'](_0x282570[_0x140f4b(0xd2)][_0x140f4b(0xd6)],{'text':_0x116f86});}}}}_0x429c4e===_0x274dd9&&(await _0x1532eb[_0x140f4b(0xda)]({'chatbot':!![],'typebotSessionId':null}),await _0x1532eb[_0x140f4b(0x109)](),await _0x32d662[_0x140f4b(0xd9)](_0x37b88d+_0x140f4b(0xee),{'text':_0x41b071}));if(_0x429c4e===_0x1af38c){await(0x0,UpdateTicketService_1[_0x140f4b(0x104)])({'ticketData':{'status':_0x140f4b(0xe7),'useIntegration':![],'integrationId':null},'ticketId':_0x1532eb['id'],'companyId':_0x1532eb['companyId']});return;}}catch(_0x3c1c06){logger_1[_0x140f4b(0xfb)][_0x140f4b(0xea)]('Error\x20on\x20typebotListener:\x20',_0x3c1c06),await _0x1532eb[_0x140f4b(0xda)]({'typebotSessionId':null});}};exports['default']=typebotListener;