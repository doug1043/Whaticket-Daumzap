const a532_0x3a66a4=a532_0x1902;function a532_0x1902(_0x5de112,_0x1652ab){const _0x36fbdb=a532_0x5be3();return a532_0x1902=function(_0x1f11b8,_0x355a89){_0x1f11b8=_0x1f11b8-0xa1;let _0x5be345=_0x36fbdb[_0x1f11b8];return _0x5be345;},a532_0x1902(_0x5de112,_0x1652ab);}(function(_0x1c18e9,_0x4598e3){const _0x519cb7=a532_0x1902,_0x6d8973=_0x1c18e9();while(!![]){try{const _0x1f9041=-parseInt(_0x519cb7(0xda))/0x1*(parseInt(_0x519cb7(0xdc))/0x2)+parseInt(_0x519cb7(0xcb))/0x3+-parseInt(_0x519cb7(0xd0))/0x4+parseInt(_0x519cb7(0xb2))/0x5+parseInt(_0x519cb7(0xb8))/0x6+-parseInt(_0x519cb7(0xa2))/0x7*(-parseInt(_0x519cb7(0xc8))/0x8)+parseInt(_0x519cb7(0xc7))/0x9;if(_0x1f9041===_0x4598e3)break;else _0x6d8973['push'](_0x6d8973['shift']());}catch(_0x160abd){_0x6d8973['push'](_0x6d8973['shift']());}}}(a532_0x5be3,0x5e86c));const a532_0x355a89=(function(){let _0x4762f3=!![];return function(_0x5123a2,_0x2a83f8){const _0x4098c2=_0x4762f3?function(){if(_0x2a83f8){const _0x3379aa=_0x2a83f8['apply'](_0x5123a2,arguments);return _0x2a83f8=null,_0x3379aa;}}:function(){};return _0x4762f3=![],_0x4098c2;};}()),a532_0x1f11b8=a532_0x355a89(this,function(){const _0x4466a5=a532_0x1902;return a532_0x1f11b8[_0x4466a5(0xd6)]()['search'](_0x4466a5(0xb4))['toString']()['constructor'](a532_0x1f11b8)[_0x4466a5(0xca)]('(((.+)+)+)+$');});a532_0x1f11b8();'use strict';var __importDefault=this&&this[a532_0x3a66a4(0xde)]||function(_0x39295e){const _0x1ad8b1=a532_0x3a66a4;return _0x39295e&&_0x39295e[_0x1ad8b1(0xd4)]?_0x39295e:{'default':_0x39295e};};function a532_0x5be3(){const _0x5a6c88=['1907940twDcdI','string','data','remoteJid','companyId','/api/v1/sessions/','replace','italic','Invalid\x20message.\x20Please,\x20try\x20again.','parse','userId','application/json','items','axios','stringify','5251374MdEPNz','198944cCoTGl','input','search','1176510tOFGTU','closed','length','getBodyMessage','key','1862352MAeGKH','typebotStatus','/api/v1/typebots/','pushName','__esModule','../WbotServices/wbotMessageListener','toString','messages','text','setMinutes','7819jKxROK','/continueChat','184eTIbBn','bold','__importDefault','▶️\x20','defineProperty','default','getMinutes','type','audio/mp4','post','reload','7AbYGqK','content','url','../../helpers/SendPresenceStatus','lodash','startsWith','updatedAt','Erro\x20ao\x20criar\x20sessão\x20do\x20typebot:\x20','info','sendMessage','@c.us','richText','SendPresenceStatus','update','queueId','children','1268010mSTbcf','isNil','(((.+)+)+)+$','Error\x20on\x20typebotListener:\x20','contact','status@broadcast'];a532_0x5be3=function(){return _0x5a6c88;};return a532_0x5be3();}Object[a532_0x3a66a4(0xe0)](exports,'__esModule',{'value':!![]});const axios_1=__importDefault(require(a532_0x3a66a4(0xc5))),wbotMessageListener_1=require(a532_0x3a66a4(0xd5)),logger_1=require('../../utils/logger'),lodash_1=require(a532_0x3a66a4(0xa6)),UpdateTicketService_1=__importDefault(require('../TicketServices/UpdateTicketService')),SendPresenceStatus_1=require(a532_0x3a66a4(0xa5)),typebotListener=async({wbot:_0x527781,msg:_0x5750b0,ticket:_0x27d075,typebot:_0x4f5779})=>{const _0x1a93c5=a532_0x3a66a4;if(_0x5750b0[_0x1a93c5(0xcf)][_0x1a93c5(0xbb)]===_0x1a93c5(0xb7))return;const {urlN8N:_0x34a0a0,typebotExpires:_0x44bd47,typebotKeywordFinish:_0x4e791b,typebotKeywordRestart:_0x3bba47,typebotUnknownMessage:_0x1ceb76,typebotSlug:_0x344cab,typebotDelayMessage:_0x14d23e,typebotRestartMessage:_0x356fef}=_0x4f5779,_0x54eec8=_0x5750b0[_0x1a93c5(0xcf)][_0x1a93c5(0xbb)]['replace'](/\D/g,'');let _0x284a96=(0x0,wbotMessageListener_1[_0x1a93c5(0xce)])(_0x5750b0);async function _0x59e6fa(_0x4c51ab,_0x16f39a,_0xc67b45){const _0x5a7969=_0x1a93c5;try{const _0x35aced=JSON[_0x5a7969(0xc6)]({'isStreamEnabled':!![],'message':_0x5a7969(0xb9),'resultId':_0x5a7969(0xb9),'isOnlyRegistering':![],'prefilledVariables':{'number':_0xc67b45,'pushName':_0x4c51ab[_0x5a7969(0xd3)]||'','remoteJid':_0x27d075?.[_0x5a7969(0xb6)]?.[_0x5a7969(0xbb)]}}),_0x2cb79b={'method':_0x5a7969(0xe5),'maxBodyLength':Infinity,'url':_0x34a0a0+_0x5a7969(0xd2)+_0x344cab+'/startChat','headers':{'Content-Type':_0x5a7969(0xc3),'Accept':_0x5a7969(0xc3)},'data':_0x35aced},_0x544b4d=await axios_1[_0x5a7969(0xe1)]['request'](_0x2cb79b);return _0x544b4d[_0x5a7969(0xba)];}catch(_0x121205){logger_1['logger']['info'](_0x5a7969(0xa9),_0x121205);throw _0x121205;}}let _0x586fb4,_0x40089f,_0x59857f=![];try{const _0x641ade=new Date();_0x641ade[_0x1a93c5(0xd9)](_0x641ade[_0x1a93c5(0xe2)]()-Number(_0x44bd47));_0x44bd47>0x0&&_0x27d075[_0x1a93c5(0xa8)]<_0x641ade&&(await _0x27d075['update']({'typebotSessionId':null,'chatbot':!![]}),await _0x27d075[_0x1a93c5(0xa1)]());!_0x27d075['typebotSessionId']?(_0x40089f=await _0x59e6fa(_0x5750b0,_0x4f5779,_0x54eec8),_0x586fb4=_0x40089f['sessionId'],_0x59857f=!![],await _0x27d075['update']({'typebotSessionId':_0x586fb4,'typebotStatus':!![],'useIntegration':!![],'integrationId':_0x4f5779['id']}),await _0x27d075['reload']()):(_0x586fb4=_0x27d075['typebotSessionId'],_0x59857f=_0x27d075[_0x1a93c5(0xd1)]);if(!_0x59857f)return;;if(_0x284a96!==_0x4e791b&&_0x284a96!==_0x3bba47){let _0x31f732,_0xdf4183,_0x18c1ca;if(_0x40089f?.[_0x1a93c5(0xd7)][_0x1a93c5(0xcd)]===0x0||_0x40089f===undefined){const _0xebddb=JSON[_0x1a93c5(0xc6)]({'message':_0x284a96});let _0xd7f39={'method':_0x1a93c5(0xe5),'maxBodyLength':Infinity,'url':_0x34a0a0+_0x1a93c5(0xbd)+_0x586fb4+_0x1a93c5(0xdb),'headers':{'Content-Type':_0x1a93c5(0xc3),'Accept':_0x1a93c5(0xc3)},'data':_0xebddb};_0x31f732=await axios_1[_0x1a93c5(0xe1)]['request'](_0xd7f39),_0xdf4183=_0x31f732[_0x1a93c5(0xba)]?.['messages'],_0x18c1ca=_0x31f732[_0x1a93c5(0xba)]?.[_0x1a93c5(0xc9)];}else _0xdf4183=_0x40089f?.['messages'],_0x18c1ca=_0x40089f?.[_0x1a93c5(0xc9)];if(_0xdf4183?.[_0x1a93c5(0xcd)]===0x0)await _0x527781[_0x1a93c5(0xab)](_0x54eec8+'@c.us',{'text':_0x1ceb76});else{for(const _0x2a4457 of _0xdf4183){if(_0x2a4457[_0x1a93c5(0xe3)]==='text'){let _0x27426e='',_0x199f9b=![];for(const _0x3367c4 of _0x2a4457['content'][_0x1a93c5(0xad)]){for(const _0x131f7e of _0x3367c4[_0x1a93c5(0xb1)]){let _0x3fb21d='';_0x131f7e['text']&&(_0x3fb21d=_0x131f7e[_0x1a93c5(0xd8)]);if(_0x131f7e[_0x1a93c5(0xe3)]&&_0x131f7e[_0x1a93c5(0xb1)])for(const _0x4722fd of _0x131f7e[_0x1a93c5(0xb1)]){let _0x65c30a='';_0x4722fd[_0x1a93c5(0xd8)]&&(_0x65c30a=_0x4722fd[_0x1a93c5(0xd8)]);if(_0x4722fd[_0x1a93c5(0xe3)]&&_0x4722fd[_0x1a93c5(0xb1)])for(const _0x213d99 of _0x4722fd[_0x1a93c5(0xb1)]){let _0x3b5151='';_0x213d99[_0x1a93c5(0xd8)]&&(_0x3b5151=_0x213d99[_0x1a93c5(0xd8)]);_0x213d99[_0x1a93c5(0xdd)]&&(_0x3b5151='*'+_0x3b5151+'*');_0x213d99[_0x1a93c5(0xbf)]&&(_0x3b5151='_'+_0x3b5151+'_');_0x213d99['underline']&&(_0x3b5151='~'+_0x3b5151+'~');if(_0x213d99[_0x1a93c5(0xa4)]){const _0x28c621=_0x213d99[_0x1a93c5(0xb1)][0x0]['text'];_0x3b5151='['+_0x28c621+']('+_0x213d99[_0x1a93c5(0xa4)]+')',_0x199f9b=!![];}_0x27426e+=_0x3b5151;}_0x4722fd[_0x1a93c5(0xdd)]&&(_0x65c30a='*'+_0x65c30a+'*');_0x4722fd[_0x1a93c5(0xbf)]&&(_0x65c30a='_'+_0x65c30a+'_');_0x4722fd['underline']&&(_0x65c30a='~'+_0x65c30a+'~');if(_0x4722fd[_0x1a93c5(0xa4)]){const _0x564e9a=_0x4722fd[_0x1a93c5(0xb1)][0x0]['text'];_0x65c30a='['+_0x564e9a+']('+_0x4722fd['url']+')',_0x199f9b=!![];}_0x27426e+=_0x65c30a;}_0x131f7e['bold']&&(_0x3fb21d='*'+_0x3fb21d+'*');_0x131f7e['italic']&&(_0x3fb21d='_'+_0x3fb21d+'_');_0x131f7e['underline']&&(_0x3fb21d='~'+_0x3fb21d+'~');if(_0x131f7e['url']){const _0x5c4fab=_0x131f7e[_0x1a93c5(0xb1)][0x0]['text'];_0x3fb21d='['+_0x5c4fab+']('+_0x131f7e[_0x1a93c5(0xa4)]+')',_0x199f9b=!![];}_0x27426e+=_0x3fb21d;}_0x27426e+='\x0a';}_0x27426e=_0x27426e[_0x1a93c5(0xbe)]('**','')[_0x1a93c5(0xbe)](/\n$/,'');_0x27426e===_0x1a93c5(0xc0)&&(_0x27426e=_0x1ceb76);if(_0x27426e[_0x1a93c5(0xa7)]('#')){let _0x1b3553=_0x27426e[_0x1a93c5(0xbe)]('#','');try{let _0x41577b=JSON[_0x1a93c5(0xc1)](_0x1b3553);if(_0x41577b['stopBot']&&(0x0,lodash_1['isNil'])(_0x41577b[_0x1a93c5(0xc2)])&&(0x0,lodash_1[_0x1a93c5(0xb3)])(_0x41577b['queueId'])){await _0x27d075[_0x1a93c5(0xaf)]({'useIntegration':![],'chatbot':![]});return;}if(!(0x0,lodash_1['isNil'])(_0x41577b[_0x1a93c5(0xb0)])&&_0x41577b[_0x1a93c5(0xb0)]>0x0&&(0x0,lodash_1[_0x1a93c5(0xb3)])(_0x41577b[_0x1a93c5(0xc2)])){await(0x0,UpdateTicketService_1[_0x1a93c5(0xe1)])({'ticketData':{'queueId':_0x41577b[_0x1a93c5(0xb0)],'chatbot':![],'useIntegration':![],'integrationId':null},'ticketId':_0x27d075['id'],'companyId':_0x27d075[_0x1a93c5(0xbc)]});return;}if(!(0x0,lodash_1[_0x1a93c5(0xb3)])(_0x41577b['queueId'])&&_0x41577b[_0x1a93c5(0xb0)]>0x0&&!(0x0,lodash_1[_0x1a93c5(0xb3)])(_0x41577b[_0x1a93c5(0xc2)])&&_0x41577b['userId']>0x0){await(0x0,UpdateTicketService_1[_0x1a93c5(0xe1)])({'ticketData':{'queueId':_0x41577b['queueId'],'userId':_0x41577b[_0x1a93c5(0xc2)],'chatbot':![],'useIntegration':![],'integrationId':null},'ticketId':_0x27d075['id'],'companyId':_0x27d075['companyId']});return;}}catch(_0x4ddfed){throw _0x4ddfed;}}await(0x0,SendPresenceStatus_1['SendPresenceStatus'])(_0x527781,_0x5750b0['key']['remoteJid'],_0x14d23e),await _0x527781['sendMessage'](_0x5750b0[_0x1a93c5(0xcf)][_0x1a93c5(0xbb)],{'text':_0x27426e});}if(_0x2a4457[_0x1a93c5(0xe3)]==='audio'){await(0x0,SendPresenceStatus_1[_0x1a93c5(0xae)])(_0x527781,_0x5750b0['key'][_0x1a93c5(0xbb)],_0x14d23e);const _0x52f74c={'audio':{'url':_0x2a4457['content'][_0x1a93c5(0xa4)],'mimetype':_0x1a93c5(0xe4),'ptt':!![]}};await _0x527781[_0x1a93c5(0xab)](_0x5750b0[_0x1a93c5(0xcf)][_0x1a93c5(0xbb)],_0x52f74c);}if(_0x2a4457[_0x1a93c5(0xe3)]==='image'){await(0x0,SendPresenceStatus_1['SendPresenceStatus'])(_0x527781,_0x5750b0['key'][_0x1a93c5(0xbb)],_0x14d23e);const _0x5d5a21={'image':{'url':_0x2a4457[_0x1a93c5(0xa3)]['url']}};await _0x527781['sendMessage'](_0x5750b0['key'][_0x1a93c5(0xbb)],_0x5d5a21);}}if(_0x18c1ca){if(_0x18c1ca['type']==='choice\x20input'){let _0x24fc8f='';const _0x47abac=_0x18c1ca[_0x1a93c5(0xc4)];for(const _0x1e8f6a of _0x47abac){_0x24fc8f+=_0x1a93c5(0xdf)+_0x1e8f6a[_0x1a93c5(0xa3)]+'\x0a';}_0x24fc8f=_0x24fc8f[_0x1a93c5(0xbe)](/\n$/,''),await(0x0,SendPresenceStatus_1[_0x1a93c5(0xae)])(_0x527781,_0x5750b0[_0x1a93c5(0xcf)]['remoteJid'],_0x14d23e),await _0x527781['sendMessage'](_0x5750b0[_0x1a93c5(0xcf)][_0x1a93c5(0xbb)],{'text':_0x24fc8f});}}}}_0x284a96===_0x3bba47&&(await _0x27d075[_0x1a93c5(0xaf)]({'chatbot':!![],'typebotSessionId':null}),await _0x27d075[_0x1a93c5(0xa1)](),await _0x527781[_0x1a93c5(0xab)](_0x54eec8+_0x1a93c5(0xac),{'text':_0x356fef}));if(_0x284a96===_0x4e791b){await(0x0,UpdateTicketService_1[_0x1a93c5(0xe1)])({'ticketData':{'status':_0x1a93c5(0xcc),'useIntegration':![],'integrationId':null},'ticketId':_0x27d075['id'],'companyId':_0x27d075[_0x1a93c5(0xbc)]});return;}}catch(_0x3c0a6b){logger_1['logger'][_0x1a93c5(0xaa)](_0x1a93c5(0xb5),_0x3c0a6b),await _0x27d075[_0x1a93c5(0xaf)]({'typebotSessionId':null});}};exports[a532_0x3a66a4(0xe1)]=typebotListener;