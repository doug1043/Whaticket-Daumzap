const a531_0x3d7324=a531_0x2afc;(function(_0x2753fb,_0x3aa92e){const _0x3dbab4=a531_0x2afc,_0x458d1c=_0x2753fb();while(!![]){try{const _0x38b9d1=-parseInt(_0x3dbab4(0x1b2))/0x1*(parseInt(_0x3dbab4(0x1bf))/0x2)+parseInt(_0x3dbab4(0x189))/0x3*(-parseInt(_0x3dbab4(0x19e))/0x4)+parseInt(_0x3dbab4(0x1b3))/0x5*(-parseInt(_0x3dbab4(0x1c8))/0x6)+parseInt(_0x3dbab4(0x1c4))/0x7+parseInt(_0x3dbab4(0x1be))/0x8+-parseInt(_0x3dbab4(0x184))/0x9+parseInt(_0x3dbab4(0x1b5))/0xa*(parseInt(_0x3dbab4(0x18f))/0xb);if(_0x38b9d1===_0x3aa92e)break;else _0x458d1c['push'](_0x458d1c['shift']());}catch(_0x3e19cb){_0x458d1c['push'](_0x458d1c['shift']());}}}(a531_0x284f,0x7e744));function a531_0x2afc(_0x3faf2f,_0xcffba2){const _0x436f25=a531_0x284f();return a531_0x2afc=function(_0x2ae9c4,_0x278f0b){_0x2ae9c4=_0x2ae9c4-0x180;let _0x284fc6=_0x436f25[_0x2ae9c4];return _0x284fc6;},a531_0x2afc(_0x3faf2f,_0xcffba2);}const a531_0x278f0b=(function(){let _0x53217b=!![];return function(_0x51cf14,_0x52681f){const _0x1a32c2=_0x53217b?function(){const _0x3666f2=a531_0x2afc;if(_0x52681f){const _0xd8eb3c=_0x52681f[_0x3666f2(0x194)](_0x51cf14,arguments);return _0x52681f=null,_0xd8eb3c;}}:function(){};return _0x53217b=![],_0x1a32c2;};}()),a531_0x2ae9c4=a531_0x278f0b(this,function(){const _0x2be656=a531_0x2afc;return a531_0x2ae9c4[_0x2be656(0x1a6)]()[_0x2be656(0x19a)]('(((.+)+)+)+$')[_0x2be656(0x1a6)]()[_0x2be656(0x1a0)](a531_0x2ae9c4)['search'](_0x2be656(0x19b));});a531_0x2ae9c4();'use strict';function a531_0x284f(){const _0x218503=['info','post','/startChat','string','search','(((.+)+)+)+$','defineProperty','audio/mp4','86780UOmZuA','type','constructor','status@broadcast','/continueChat','setMinutes','url','children','toString','reload','userId','@c.us','queueId','update','length','replace','Erro\x20ao\x20criar\x20sessão\x20do\x20typebot:\x20','__esModule','data','key','2UqbyWT','55MNbtVR','sendMessage','30LggLqj','/api/v1/sessions/','italic','parse','stopBot','stringify','axios','request','isNil','3762200zYXQiP','54418xGbSQF','bold','underline','messages','../TicketServices/UpdateTicketService','6885102xUNWcJ','/api/v1/typebots/','remoteJid','companyId','177918JSmijh','Error\x20on\x20typebotListener:\x20','typebotSessionId','SendPresenceStatus','▶️\x20','3243600wvIpJm','pushName','../WbotServices/wbotMessageListener','application/json','richText','63BnBczS','default','content','items','lodash','getMinutes','955867eKvEbE','__importDefault','text','input','Invalid\x20message.\x20Please,\x20try\x20again.','apply','logger'];a531_0x284f=function(){return _0x218503;};return a531_0x284f();}var __importDefault=this&&this[a531_0x3d7324(0x190)]||function(_0x4e4ec1){return _0x4e4ec1&&_0x4e4ec1['__esModule']?_0x4e4ec1:{'default':_0x4e4ec1};};Object[a531_0x3d7324(0x19c)](exports,a531_0x3d7324(0x1af),{'value':!![]});const axios_1=__importDefault(require(a531_0x3d7324(0x1bb))),wbotMessageListener_1=require(a531_0x3d7324(0x186)),logger_1=require('../../utils/logger'),lodash_1=require(a531_0x3d7324(0x18d)),UpdateTicketService_1=__importDefault(require(a531_0x3d7324(0x1c3))),SendPresenceStatus_1=require('../../helpers/SendPresenceStatus'),typebotListener=async({wbot:_0x11e900,msg:_0x57db3d,ticket:_0xa6ff32,typebot:_0x2926f2})=>{const _0x43833e=a531_0x3d7324;if(_0x57db3d[_0x43833e(0x1b1)][_0x43833e(0x1c6)]===_0x43833e(0x1a1))return;const {urlN8N:_0x26551d,typebotExpires:_0x4ce8fa,typebotKeywordFinish:_0x59471c,typebotKeywordRestart:_0x131521,typebotUnknownMessage:_0x71de25,typebotSlug:_0x190852,typebotDelayMessage:_0x32bbd5,typebotRestartMessage:_0x5db2b0}=_0x2926f2,_0x11eabe=_0x57db3d['key']['remoteJid'][_0x43833e(0x1ad)](/\D/g,'');let _0x48307a=(0x0,wbotMessageListener_1['getBodyMessage'])(_0x57db3d);async function _0x2821a6(_0x39a0bc,_0x3eea71,_0x886a87){const _0x41c2b7=_0x43833e;try{const _0x42394b=JSON[_0x41c2b7(0x1ba)]({'isStreamEnabled':!![],'message':_0x41c2b7(0x199),'resultId':'string','isOnlyRegistering':![],'prefilledVariables':{'number':_0x886a87,'pushName':_0x39a0bc[_0x41c2b7(0x185)]||'','remoteJid':_0xa6ff32?.['contact']?.[_0x41c2b7(0x1c6)]}}),_0x612208={'method':_0x41c2b7(0x197),'maxBodyLength':Infinity,'url':_0x26551d+_0x41c2b7(0x1c5)+_0x190852+_0x41c2b7(0x198),'headers':{'Content-Type':'application/json','Accept':_0x41c2b7(0x187)},'data':_0x42394b},_0x35b788=await axios_1['default'][_0x41c2b7(0x1bc)](_0x612208);return _0x35b788[_0x41c2b7(0x1b0)];}catch(_0x167ede){logger_1[_0x41c2b7(0x195)][_0x41c2b7(0x196)](_0x41c2b7(0x1ae),_0x167ede);throw _0x167ede;}}let _0x1ecfe7,_0x1b42ed,_0x250eed=![];try{const _0x3d3c00=new Date();_0x3d3c00[_0x43833e(0x1a3)](_0x3d3c00[_0x43833e(0x18e)]()-Number(_0x4ce8fa));_0x4ce8fa>0x0&&_0xa6ff32['updatedAt']<_0x3d3c00&&(await _0xa6ff32[_0x43833e(0x1ab)]({'typebotSessionId':null,'chatbot':!![]}),await _0xa6ff32['reload']());!_0xa6ff32[_0x43833e(0x181)]?(_0x1b42ed=await _0x2821a6(_0x57db3d,_0x2926f2,_0x11eabe),_0x1ecfe7=_0x1b42ed['sessionId'],_0x250eed=!![],await _0xa6ff32[_0x43833e(0x1ab)]({'typebotSessionId':_0x1ecfe7,'typebotStatus':!![],'useIntegration':!![],'integrationId':_0x2926f2['id']}),await _0xa6ff32[_0x43833e(0x1a7)]()):(_0x1ecfe7=_0xa6ff32[_0x43833e(0x181)],_0x250eed=_0xa6ff32['typebotStatus']);if(!_0x250eed)return;;if(_0x48307a!==_0x59471c&&_0x48307a!==_0x131521){let _0x17f11f,_0x5b804f,_0x348757;if(_0x1b42ed?.['messages'][_0x43833e(0x1ac)]===0x0||_0x1b42ed===undefined){const _0x4a1034=JSON[_0x43833e(0x1ba)]({'message':_0x48307a});let _0x485e0b={'method':'post','maxBodyLength':Infinity,'url':_0x26551d+_0x43833e(0x1b6)+_0x1ecfe7+_0x43833e(0x1a2),'headers':{'Content-Type':_0x43833e(0x187),'Accept':_0x43833e(0x187)},'data':_0x4a1034};_0x17f11f=await axios_1[_0x43833e(0x18a)]['request'](_0x485e0b),_0x5b804f=_0x17f11f[_0x43833e(0x1b0)]?.[_0x43833e(0x1c2)],_0x348757=_0x17f11f['data']?.[_0x43833e(0x192)];}else _0x5b804f=_0x1b42ed?.[_0x43833e(0x1c2)],_0x348757=_0x1b42ed?.[_0x43833e(0x192)];if(_0x5b804f?.[_0x43833e(0x1ac)]===0x0)await _0x11e900['sendMessage'](_0x11eabe+_0x43833e(0x1a9),{'text':_0x71de25});else{for(const _0x947a8 of _0x5b804f){if(_0x947a8[_0x43833e(0x19f)]===_0x43833e(0x191)){let _0x299cae='',_0x5bfdb8=![];for(const _0x35622b of _0x947a8[_0x43833e(0x18b)][_0x43833e(0x188)]){for(const _0x5c0ee5 of _0x35622b['children']){let _0xef9c71='';_0x5c0ee5[_0x43833e(0x191)]&&(_0xef9c71=_0x5c0ee5['text']);if(_0x5c0ee5[_0x43833e(0x19f)]&&_0x5c0ee5[_0x43833e(0x1a5)])for(const _0x135a12 of _0x5c0ee5[_0x43833e(0x1a5)]){let _0x192be3='';_0x135a12[_0x43833e(0x191)]&&(_0x192be3=_0x135a12['text']);if(_0x135a12['type']&&_0x135a12[_0x43833e(0x1a5)])for(const _0x41e169 of _0x135a12[_0x43833e(0x1a5)]){let _0x4b9cd3='';_0x41e169[_0x43833e(0x191)]&&(_0x4b9cd3=_0x41e169[_0x43833e(0x191)]);_0x41e169[_0x43833e(0x1c0)]&&(_0x4b9cd3='*'+_0x4b9cd3+'*');_0x41e169[_0x43833e(0x1b7)]&&(_0x4b9cd3='_'+_0x4b9cd3+'_');_0x41e169['underline']&&(_0x4b9cd3='~'+_0x4b9cd3+'~');if(_0x41e169['url']){const _0x55a547=_0x41e169[_0x43833e(0x1a5)][0x0][_0x43833e(0x191)];_0x4b9cd3='['+_0x55a547+']('+_0x41e169[_0x43833e(0x1a4)]+')',_0x5bfdb8=!![];}_0x299cae+=_0x4b9cd3;}_0x135a12[_0x43833e(0x1c0)]&&(_0x192be3='*'+_0x192be3+'*');_0x135a12[_0x43833e(0x1b7)]&&(_0x192be3='_'+_0x192be3+'_');_0x135a12[_0x43833e(0x1c1)]&&(_0x192be3='~'+_0x192be3+'~');if(_0x135a12[_0x43833e(0x1a4)]){const _0x10953f=_0x135a12['children'][0x0][_0x43833e(0x191)];_0x192be3='['+_0x10953f+']('+_0x135a12[_0x43833e(0x1a4)]+')',_0x5bfdb8=!![];}_0x299cae+=_0x192be3;}_0x5c0ee5[_0x43833e(0x1c0)]&&(_0xef9c71='*'+_0xef9c71+'*');_0x5c0ee5[_0x43833e(0x1b7)]&&(_0xef9c71='_'+_0xef9c71+'_');_0x5c0ee5[_0x43833e(0x1c1)]&&(_0xef9c71='~'+_0xef9c71+'~');if(_0x5c0ee5['url']){const _0x3f107c=_0x5c0ee5[_0x43833e(0x1a5)][0x0][_0x43833e(0x191)];_0xef9c71='['+_0x3f107c+']('+_0x5c0ee5[_0x43833e(0x1a4)]+')',_0x5bfdb8=!![];}_0x299cae+=_0xef9c71;}_0x299cae+='\x0a';}_0x299cae=_0x299cae['replace']('**','')[_0x43833e(0x1ad)](/\n$/,'');_0x299cae===_0x43833e(0x193)&&(_0x299cae=_0x71de25);if(_0x299cae['startsWith']('#')){let _0x2c19ed=_0x299cae[_0x43833e(0x1ad)]('#','');try{let _0x270caa=JSON[_0x43833e(0x1b8)](_0x2c19ed);if(_0x270caa[_0x43833e(0x1b9)]&&(0x0,lodash_1[_0x43833e(0x1bd)])(_0x270caa[_0x43833e(0x1a8)])&&(0x0,lodash_1[_0x43833e(0x1bd)])(_0x270caa['queueId'])){await _0xa6ff32['update']({'useIntegration':![],'chatbot':![]});return;}if(!(0x0,lodash_1[_0x43833e(0x1bd)])(_0x270caa[_0x43833e(0x1aa)])&&_0x270caa[_0x43833e(0x1aa)]>0x0&&(0x0,lodash_1['isNil'])(_0x270caa['userId'])){await(0x0,UpdateTicketService_1[_0x43833e(0x18a)])({'ticketData':{'queueId':_0x270caa[_0x43833e(0x1aa)],'chatbot':![],'useIntegration':![],'integrationId':null},'ticketId':_0xa6ff32['id'],'companyId':_0xa6ff32[_0x43833e(0x1c7)]});return;}if(!(0x0,lodash_1[_0x43833e(0x1bd)])(_0x270caa[_0x43833e(0x1aa)])&&_0x270caa['queueId']>0x0&&!(0x0,lodash_1[_0x43833e(0x1bd)])(_0x270caa[_0x43833e(0x1a8)])&&_0x270caa['userId']>0x0){await(0x0,UpdateTicketService_1['default'])({'ticketData':{'queueId':_0x270caa[_0x43833e(0x1aa)],'userId':_0x270caa[_0x43833e(0x1a8)],'chatbot':![],'useIntegration':![],'integrationId':null},'ticketId':_0xa6ff32['id'],'companyId':_0xa6ff32[_0x43833e(0x1c7)]});return;}}catch(_0x72d4bf){throw _0x72d4bf;}}await(0x0,SendPresenceStatus_1['SendPresenceStatus'])(_0x11e900,_0x57db3d[_0x43833e(0x1b1)]['remoteJid'],_0x32bbd5),await _0x11e900[_0x43833e(0x1b4)](_0x57db3d['key'][_0x43833e(0x1c6)],{'text':_0x299cae});}if(_0x947a8[_0x43833e(0x19f)]==='audio'){await(0x0,SendPresenceStatus_1['SendPresenceStatus'])(_0x11e900,_0x57db3d[_0x43833e(0x1b1)][_0x43833e(0x1c6)],_0x32bbd5);const _0x2d8f37={'audio':{'url':_0x947a8[_0x43833e(0x18b)]['url'],'mimetype':_0x43833e(0x19d),'ptt':!![]}};await _0x11e900[_0x43833e(0x1b4)](_0x57db3d['key']['remoteJid'],_0x2d8f37);}if(_0x947a8[_0x43833e(0x19f)]==='image'){await(0x0,SendPresenceStatus_1[_0x43833e(0x182)])(_0x11e900,_0x57db3d[_0x43833e(0x1b1)][_0x43833e(0x1c6)],_0x32bbd5);const _0x1e142e={'image':{'url':_0x947a8[_0x43833e(0x18b)]['url']}};await _0x11e900['sendMessage'](_0x57db3d[_0x43833e(0x1b1)][_0x43833e(0x1c6)],_0x1e142e);}}if(_0x348757){if(_0x348757[_0x43833e(0x19f)]==='choice\x20input'){let _0x4b8831='';const _0x171e5d=_0x348757[_0x43833e(0x18c)];for(const _0x2ed8fc of _0x171e5d){_0x4b8831+=_0x43833e(0x183)+_0x2ed8fc[_0x43833e(0x18b)]+'\x0a';}_0x4b8831=_0x4b8831[_0x43833e(0x1ad)](/\n$/,''),await(0x0,SendPresenceStatus_1[_0x43833e(0x182)])(_0x11e900,_0x57db3d[_0x43833e(0x1b1)]['remoteJid'],_0x32bbd5),await _0x11e900[_0x43833e(0x1b4)](_0x57db3d[_0x43833e(0x1b1)][_0x43833e(0x1c6)],{'text':_0x4b8831});}}}}_0x48307a===_0x131521&&(await _0xa6ff32[_0x43833e(0x1ab)]({'chatbot':!![],'typebotSessionId':null}),await _0xa6ff32[_0x43833e(0x1a7)](),await _0x11e900[_0x43833e(0x1b4)](_0x11eabe+_0x43833e(0x1a9),{'text':_0x5db2b0}));if(_0x48307a===_0x59471c){await(0x0,UpdateTicketService_1[_0x43833e(0x18a)])({'ticketData':{'status':'closed','useIntegration':![],'integrationId':null},'ticketId':_0xa6ff32['id'],'companyId':_0xa6ff32[_0x43833e(0x1c7)]});return;}}catch(_0x110edc){logger_1[_0x43833e(0x195)][_0x43833e(0x196)](_0x43833e(0x180),_0x110edc),await _0xa6ff32[_0x43833e(0x1ab)]({'typebotSessionId':null});}};exports[a531_0x3d7324(0x18a)]=typebotListener;