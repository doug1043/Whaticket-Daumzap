const a531_0x2a34d2=a531_0x48b5;function a531_0x1aa9(){const _0x449aec=['update','items','search','children','typebotStatus','underline','60255ncYBjV','key','updatedAt','remoteJid','constructor','Erro\x20ao\x20criar\x20sessão\x20do\x20typebot:\x20','420150zTIePa','typebotSessionId','(((.+)+)+)+$','info','sessionId','companyId','request','20QzTpEu','../WbotServices/wbotMessageListener','parse','▶️\x20','default','type','post','italic','/startChat','getMinutes','logger','messages','richText','startsWith','688ZzjkUc','choice\x20input','closed','replace','getBodyMessage','toString','../../helpers/SendPresenceStatus','bold','../TicketServices/UpdateTicketService','length','url','audio','string','content','SendPresenceStatus','__importDefault','1678670HajByI','audio/mp4','apply','reload','input','/api/v1/typebots/','queueId','__esModule','setMinutes','362420hcIbtT','../../utils/logger','userId','text','Error\x20on\x20typebotListener:\x20','/continueChat','application/json','Invalid\x20message.\x20Please,\x20try\x20again.','180756bxrYup','1791960wyyklP','sendMessage','isNil','@c.us','defineProperty','data','1428945eRnXQj','contact','status@broadcast','axios'];a531_0x1aa9=function(){return _0x449aec;};return a531_0x1aa9();}(function(_0x3f6c0e,_0xbb4937){const _0x31f454=a531_0x48b5,_0x29390f=_0x3f6c0e();while(!![]){try{const _0x45f4a9=parseInt(_0x31f454(0xdc))/0x1+-parseInt(_0x31f454(0xfb))/0x2+parseInt(_0x31f454(0xe4))/0x3*(-parseInt(_0x31f454(0x102))/0x4)+-parseInt(_0x31f454(0xeb))/0x5+parseInt(_0x31f454(0xe5))/0x6+-parseInt(_0x31f454(0xd3))/0x7+parseInt(_0x31f454(0xc3))/0x8*(parseInt(_0x31f454(0xf5))/0x9);if(_0x45f4a9===_0xbb4937)break;else _0x29390f['push'](_0x29390f['shift']());}catch(_0x36cf1a){_0x29390f['push'](_0x29390f['shift']());}}}(a531_0x1aa9,0x30cec));const a531_0x4ba821=(function(){let _0x38513f=!![];return function(_0x103cdd,_0x1ccbb0){const _0x356eac=_0x38513f?function(){const _0x2c84b0=a531_0x48b5;if(_0x1ccbb0){const _0x41fb6e=_0x1ccbb0[_0x2c84b0(0xd5)](_0x103cdd,arguments);return _0x1ccbb0=null,_0x41fb6e;}}:function(){};return _0x38513f=![],_0x356eac;};}()),a531_0x50a83e=a531_0x4ba821(this,function(){const _0x549684=a531_0x48b5;return a531_0x50a83e[_0x549684(0xc8)]()[_0x549684(0xf1)](_0x549684(0xfd))[_0x549684(0xc8)]()[_0x549684(0xf9)](a531_0x50a83e)[_0x549684(0xf1)]('(((.+)+)+)+$');});a531_0x50a83e();'use strict';function a531_0x48b5(_0x307c89,_0x5b6298){const _0x4a67fa=a531_0x1aa9();return a531_0x48b5=function(_0x50a83e,_0x4ba821){_0x50a83e=_0x50a83e-0xc0;let _0x1aa9ad=_0x4a67fa[_0x50a83e];return _0x1aa9ad;},a531_0x48b5(_0x307c89,_0x5b6298);}var __importDefault=this&&this[a531_0x2a34d2(0xd2)]||function(_0x328930){const _0x96c036=a531_0x2a34d2;return _0x328930&&_0x328930[_0x96c036(0xda)]?_0x328930:{'default':_0x328930};};Object[a531_0x2a34d2(0xe9)](exports,a531_0x2a34d2(0xda),{'value':!![]});const axios_1=__importDefault(require(a531_0x2a34d2(0xee))),wbotMessageListener_1=require(a531_0x2a34d2(0x103)),logger_1=require(a531_0x2a34d2(0xdd)),lodash_1=require('lodash'),UpdateTicketService_1=__importDefault(require(a531_0x2a34d2(0xcb))),SendPresenceStatus_1=require(a531_0x2a34d2(0xc9)),typebotListener=async({wbot:_0x49af8a,msg:_0x266839,ticket:_0x4f7f11,typebot:_0x1060dc})=>{const _0x502342=a531_0x2a34d2;if(_0x266839[_0x502342(0xf6)][_0x502342(0xf8)]===_0x502342(0xed))return;const {urlN8N:_0x5485a3,typebotExpires:_0x543b39,typebotKeywordFinish:_0x48ec5b,typebotKeywordRestart:_0x15b298,typebotUnknownMessage:_0x39f0f0,typebotSlug:_0x5b78f1,typebotDelayMessage:_0x413228,typebotRestartMessage:_0x5aeeed}=_0x1060dc,_0x214d49=_0x266839['key'][_0x502342(0xf8)][_0x502342(0xc6)](/\D/g,'');let _0x55bd3b=(0x0,wbotMessageListener_1[_0x502342(0xc7)])(_0x266839);async function _0x3d253d(_0x5ad222,_0x56fbe0,_0x2ea6c7){const _0x53edba=_0x502342;try{const _0xee27b6=JSON['stringify']({'isStreamEnabled':!![],'message':_0x53edba(0xcf),'resultId':_0x53edba(0xcf),'isOnlyRegistering':![],'prefilledVariables':{'number':_0x2ea6c7,'pushName':_0x5ad222['pushName']||'','remoteJid':_0x4f7f11?.[_0x53edba(0xec)]?.[_0x53edba(0xf8)]}}),_0x5edff5={'method':_0x53edba(0x108),'maxBodyLength':Infinity,'url':_0x5485a3+_0x53edba(0xd8)+_0x5b78f1+_0x53edba(0x10a),'headers':{'Content-Type':_0x53edba(0xe2),'Accept':_0x53edba(0xe2)},'data':_0xee27b6},_0xe5eb25=await axios_1[_0x53edba(0x106)][_0x53edba(0x101)](_0x5edff5);return _0xe5eb25[_0x53edba(0xea)];}catch(_0x2d8a51){logger_1[_0x53edba(0x10c)][_0x53edba(0xfe)](_0x53edba(0xfa),_0x2d8a51);throw _0x2d8a51;}}let _0x46b2a0,_0x1b08ad,_0x4ddde5=![];try{const _0x2e8302=new Date();_0x2e8302[_0x502342(0xdb)](_0x2e8302[_0x502342(0x10b)]()-Number(_0x543b39));_0x543b39>0x0&&_0x4f7f11[_0x502342(0xf7)]<_0x2e8302&&(await _0x4f7f11[_0x502342(0xef)]({'typebotSessionId':null,'chatbot':!![]}),await _0x4f7f11[_0x502342(0xd6)]());!_0x4f7f11[_0x502342(0xfc)]?(_0x1b08ad=await _0x3d253d(_0x266839,_0x1060dc,_0x214d49),_0x46b2a0=_0x1b08ad[_0x502342(0xff)],_0x4ddde5=!![],await _0x4f7f11[_0x502342(0xef)]({'typebotSessionId':_0x46b2a0,'typebotStatus':!![],'useIntegration':!![],'integrationId':_0x1060dc['id']}),await _0x4f7f11[_0x502342(0xd6)]()):(_0x46b2a0=_0x4f7f11[_0x502342(0xfc)],_0x4ddde5=_0x4f7f11[_0x502342(0xf3)]);if(!_0x4ddde5)return;;if(_0x55bd3b!==_0x48ec5b&&_0x55bd3b!==_0x15b298){let _0x44c684,_0x1e6026,_0x730c6f;if(_0x1b08ad?.['messages'][_0x502342(0xcc)]===0x0||_0x1b08ad===undefined){const _0x3327e6=JSON['stringify']({'message':_0x55bd3b});let _0x124fe1={'method':_0x502342(0x108),'maxBodyLength':Infinity,'url':_0x5485a3+'/api/v1/sessions/'+_0x46b2a0+_0x502342(0xe1),'headers':{'Content-Type':_0x502342(0xe2),'Accept':'application/json'},'data':_0x3327e6};_0x44c684=await axios_1[_0x502342(0x106)]['request'](_0x124fe1),_0x1e6026=_0x44c684[_0x502342(0xea)]?.['messages'],_0x730c6f=_0x44c684[_0x502342(0xea)]?.[_0x502342(0xd7)];}else _0x1e6026=_0x1b08ad?.[_0x502342(0xc0)],_0x730c6f=_0x1b08ad?.['input'];if(_0x1e6026?.[_0x502342(0xcc)]===0x0)await _0x49af8a[_0x502342(0xe6)](_0x214d49+_0x502342(0xe8),{'text':_0x39f0f0});else{for(const _0x1f9353 of _0x1e6026){if(_0x1f9353[_0x502342(0x107)]==='text'){let _0x4c0674='',_0x5bc710=![];for(const _0x324d0c of _0x1f9353['content'][_0x502342(0xc1)]){for(const _0x5c5af9 of _0x324d0c[_0x502342(0xf2)]){let _0x424c1e='';_0x5c5af9[_0x502342(0xdf)]&&(_0x424c1e=_0x5c5af9[_0x502342(0xdf)]);if(_0x5c5af9[_0x502342(0x107)]&&_0x5c5af9[_0x502342(0xf2)])for(const _0x4e3bc2 of _0x5c5af9[_0x502342(0xf2)]){let _0x7bc4c1='';_0x4e3bc2[_0x502342(0xdf)]&&(_0x7bc4c1=_0x4e3bc2['text']);if(_0x4e3bc2['type']&&_0x4e3bc2[_0x502342(0xf2)])for(const _0x17ec99 of _0x4e3bc2[_0x502342(0xf2)]){let _0x22261e='';_0x17ec99['text']&&(_0x22261e=_0x17ec99[_0x502342(0xdf)]);_0x17ec99[_0x502342(0xca)]&&(_0x22261e='*'+_0x22261e+'*');_0x17ec99[_0x502342(0x109)]&&(_0x22261e='_'+_0x22261e+'_');_0x17ec99['underline']&&(_0x22261e='~'+_0x22261e+'~');if(_0x17ec99[_0x502342(0xcd)]){const _0x12bfc1=_0x17ec99[_0x502342(0xf2)][0x0][_0x502342(0xdf)];_0x22261e='['+_0x12bfc1+']('+_0x17ec99[_0x502342(0xcd)]+')',_0x5bc710=!![];}_0x4c0674+=_0x22261e;}_0x4e3bc2[_0x502342(0xca)]&&(_0x7bc4c1='*'+_0x7bc4c1+'*');_0x4e3bc2[_0x502342(0x109)]&&(_0x7bc4c1='_'+_0x7bc4c1+'_');_0x4e3bc2[_0x502342(0xf4)]&&(_0x7bc4c1='~'+_0x7bc4c1+'~');if(_0x4e3bc2['url']){const _0x35ba2a=_0x4e3bc2['children'][0x0][_0x502342(0xdf)];_0x7bc4c1='['+_0x35ba2a+']('+_0x4e3bc2['url']+')',_0x5bc710=!![];}_0x4c0674+=_0x7bc4c1;}_0x5c5af9[_0x502342(0xca)]&&(_0x424c1e='*'+_0x424c1e+'*');_0x5c5af9[_0x502342(0x109)]&&(_0x424c1e='_'+_0x424c1e+'_');_0x5c5af9[_0x502342(0xf4)]&&(_0x424c1e='~'+_0x424c1e+'~');if(_0x5c5af9[_0x502342(0xcd)]){const _0x258c46=_0x5c5af9[_0x502342(0xf2)][0x0][_0x502342(0xdf)];_0x424c1e='['+_0x258c46+']('+_0x5c5af9['url']+')',_0x5bc710=!![];}_0x4c0674+=_0x424c1e;}_0x4c0674+='\x0a';}_0x4c0674=_0x4c0674['replace']('**','')[_0x502342(0xc6)](/\n$/,'');_0x4c0674===_0x502342(0xe3)&&(_0x4c0674=_0x39f0f0);if(_0x4c0674[_0x502342(0xc2)]('#')){let _0x25e7d2=_0x4c0674[_0x502342(0xc6)]('#','');try{let _0x49c1c0=JSON[_0x502342(0x104)](_0x25e7d2);if(_0x49c1c0['stopBot']&&(0x0,lodash_1[_0x502342(0xe7)])(_0x49c1c0[_0x502342(0xde)])&&(0x0,lodash_1['isNil'])(_0x49c1c0[_0x502342(0xd9)])){await _0x4f7f11[_0x502342(0xef)]({'useIntegration':![],'chatbot':![]});return;}if(!(0x0,lodash_1[_0x502342(0xe7)])(_0x49c1c0[_0x502342(0xd9)])&&_0x49c1c0[_0x502342(0xd9)]>0x0&&(0x0,lodash_1[_0x502342(0xe7)])(_0x49c1c0['userId'])){await(0x0,UpdateTicketService_1[_0x502342(0x106)])({'ticketData':{'queueId':_0x49c1c0[_0x502342(0xd9)],'chatbot':![],'useIntegration':![],'integrationId':null},'ticketId':_0x4f7f11['id'],'companyId':_0x4f7f11['companyId']});return;}if(!(0x0,lodash_1[_0x502342(0xe7)])(_0x49c1c0[_0x502342(0xd9)])&&_0x49c1c0[_0x502342(0xd9)]>0x0&&!(0x0,lodash_1[_0x502342(0xe7)])(_0x49c1c0['userId'])&&_0x49c1c0[_0x502342(0xde)]>0x0){await(0x0,UpdateTicketService_1['default'])({'ticketData':{'queueId':_0x49c1c0[_0x502342(0xd9)],'userId':_0x49c1c0['userId'],'chatbot':![],'useIntegration':![],'integrationId':null},'ticketId':_0x4f7f11['id'],'companyId':_0x4f7f11['companyId']});return;}}catch(_0x1b35cc){throw _0x1b35cc;}}await(0x0,SendPresenceStatus_1['SendPresenceStatus'])(_0x49af8a,_0x266839['key']['remoteJid'],_0x413228),await _0x49af8a['sendMessage'](_0x266839[_0x502342(0xf6)][_0x502342(0xf8)],{'text':_0x4c0674});}if(_0x1f9353[_0x502342(0x107)]===_0x502342(0xce)){await(0x0,SendPresenceStatus_1[_0x502342(0xd1)])(_0x49af8a,_0x266839['key']['remoteJid'],_0x413228);const _0x1b0aae={'audio':{'url':_0x1f9353['content']['url'],'mimetype':_0x502342(0xd4),'ptt':!![]}};await _0x49af8a[_0x502342(0xe6)](_0x266839['key']['remoteJid'],_0x1b0aae);}if(_0x1f9353[_0x502342(0x107)]==='image'){await(0x0,SendPresenceStatus_1[_0x502342(0xd1)])(_0x49af8a,_0x266839['key'][_0x502342(0xf8)],_0x413228);const _0x340c00={'image':{'url':_0x1f9353[_0x502342(0xd0)]['url']}};await _0x49af8a['sendMessage'](_0x266839[_0x502342(0xf6)]['remoteJid'],_0x340c00);}}if(_0x730c6f){if(_0x730c6f[_0x502342(0x107)]===_0x502342(0xc4)){let _0x32b5aa='';const _0x576557=_0x730c6f[_0x502342(0xf0)];for(const _0x576026 of _0x576557){_0x32b5aa+=_0x502342(0x105)+_0x576026[_0x502342(0xd0)]+'\x0a';}_0x32b5aa=_0x32b5aa[_0x502342(0xc6)](/\n$/,''),await(0x0,SendPresenceStatus_1[_0x502342(0xd1)])(_0x49af8a,_0x266839[_0x502342(0xf6)][_0x502342(0xf8)],_0x413228),await _0x49af8a[_0x502342(0xe6)](_0x266839[_0x502342(0xf6)][_0x502342(0xf8)],{'text':_0x32b5aa});}}}}_0x55bd3b===_0x15b298&&(await _0x4f7f11[_0x502342(0xef)]({'chatbot':!![],'typebotSessionId':null}),await _0x4f7f11[_0x502342(0xd6)](),await _0x49af8a[_0x502342(0xe6)](_0x214d49+'@c.us',{'text':_0x5aeeed}));if(_0x55bd3b===_0x48ec5b){await(0x0,UpdateTicketService_1['default'])({'ticketData':{'status':_0x502342(0xc5),'useIntegration':![],'integrationId':null},'ticketId':_0x4f7f11['id'],'companyId':_0x4f7f11[_0x502342(0x100)]});return;}}catch(_0x4b362b){logger_1[_0x502342(0x10c)][_0x502342(0xfe)](_0x502342(0xe0),_0x4b362b),await _0x4f7f11[_0x502342(0xef)]({'typebotSessionId':null});}};exports[a531_0x2a34d2(0x106)]=typebotListener;