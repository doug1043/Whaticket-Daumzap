const a530_0xfca349=a530_0x36d5;(function(_0x3bb7ac,_0x42deba){const _0x27fb96=a530_0x36d5,_0x4170a0=_0x3bb7ac();while(!![]){try{const _0xcd686f=parseInt(_0x27fb96(0x1df))/0x1+parseInt(_0x27fb96(0x1c9))/0x2*(parseInt(_0x27fb96(0x1f1))/0x3)+-parseInt(_0x27fb96(0x1b8))/0x4+parseInt(_0x27fb96(0x1c5))/0x5*(-parseInt(_0x27fb96(0x1ac))/0x6)+-parseInt(_0x27fb96(0x1cd))/0x7+parseInt(_0x27fb96(0x1ce))/0x8+parseInt(_0x27fb96(0x1dc))/0x9*(-parseInt(_0x27fb96(0x1e6))/0xa);if(_0xcd686f===_0x42deba)break;else _0x4170a0['push'](_0x4170a0['shift']());}catch(_0xf9e847){_0x4170a0['push'](_0x4170a0['shift']());}}}(a530_0x14ec,0xc7d8c));const a530_0x396241=(function(){let _0x4c840c=!![];return function(_0xa8368b,_0x50aba3){const _0x257cc8=_0x4c840c?function(){if(_0x50aba3){const _0x3fdc36=_0x50aba3['apply'](_0xa8368b,arguments);return _0x50aba3=null,_0x3fdc36;}}:function(){};return _0x4c840c=![],_0x257cc8;};}()),a530_0x12c603=a530_0x396241(this,function(){const _0x37d81a=a530_0x36d5;return a530_0x12c603[_0x37d81a(0x1af)]()[_0x37d81a(0x1d8)](_0x37d81a(0x1d7))[_0x37d81a(0x1af)]()[_0x37d81a(0x1c0)](a530_0x12c603)[_0x37d81a(0x1d8)](_0x37d81a(0x1d7));});a530_0x12c603();'use strict';function a530_0x14ec(){const _0x235e34=['reload','@c.us','4429840hXsvNM','/continueChat','sessionId','audio','axios','choice\x20input','queueId','isNil','constructor','replace','Erro\x20ao\x20criar\x20sessão\x20do\x20typebot:\x20','pushName','contact','5YJByka','bold','stopBot','url','385292UWrhtA','defineProperty','request','../WbotServices/wbotMessageListener','2308089vvZplM','7068344vBbTiY','sendMessage','messages','text','lodash','updatedAt','update','remoteJid','length','(((.+)+)+)+$','search','string','closed','typebotSessionId','708426BxkRaP','SendPresenceStatus','Error\x20on\x20typebotListener:\x20','1188969okEeXp','../../helpers/SendPresenceStatus','../TicketServices/UpdateTicketService','italic','__importDefault','typebotStatus','parse','90eGLbJG','companyId','stringify','audio/mp4','info','type','data','default','getMinutes','post','underline','15ZIwxqT','logger','setMinutes','429342eUEeJV','content','richText','toString','/api/v1/typebots/','children','key','application/json','userId','__esModule'];a530_0x14ec=function(){return _0x235e34;};return a530_0x14ec();}var __importDefault=this&&this[a530_0xfca349(0x1e3)]||function(_0x4930c7){const _0x1daea4=a530_0xfca349;return _0x4930c7&&_0x4930c7[_0x1daea4(0x1b5)]?_0x4930c7:{'default':_0x4930c7};};Object[a530_0xfca349(0x1ca)](exports,a530_0xfca349(0x1b5),{'value':!![]});const axios_1=__importDefault(require(a530_0xfca349(0x1bc))),wbotMessageListener_1=require(a530_0xfca349(0x1cc)),logger_1=require('../../utils/logger'),lodash_1=require(a530_0xfca349(0x1d2)),UpdateTicketService_1=__importDefault(require(a530_0xfca349(0x1e1))),SendPresenceStatus_1=require(a530_0xfca349(0x1e0)),typebotListener=async({wbot:_0x3d8a5f,msg:_0x2479e8,ticket:_0x18707f,typebot:_0x1f34c4})=>{const _0x30894f=a530_0xfca349;if(_0x2479e8[_0x30894f(0x1b2)]['remoteJid']==='status@broadcast')return;const {urlN8N:_0x452500,typebotExpires:_0x4ca69d,typebotKeywordFinish:_0x2c9678,typebotKeywordRestart:_0x104027,typebotUnknownMessage:_0x5a612b,typebotSlug:_0x5e67ef,typebotDelayMessage:_0x25eb48,typebotRestartMessage:_0x351188}=_0x1f34c4,_0x3c1666=_0x2479e8[_0x30894f(0x1b2)][_0x30894f(0x1d5)][_0x30894f(0x1c1)](/\D/g,'');let _0x3d1be8=(0x0,wbotMessageListener_1['getBodyMessage'])(_0x2479e8);async function _0x2c2780(_0x5c6208,_0x1e6f1a,_0x3c212d){const _0x31e21d=_0x30894f;try{const _0x8991d0=JSON[_0x31e21d(0x1e8)]({'isStreamEnabled':!![],'message':'string','resultId':_0x31e21d(0x1d9),'isOnlyRegistering':![],'prefilledVariables':{'number':_0x3c212d,'pushName':_0x5c6208[_0x31e21d(0x1c3)]||'','remoteJid':_0x18707f?.[_0x31e21d(0x1c4)]?.['remoteJid']}}),_0x370765={'method':_0x31e21d(0x1ef),'maxBodyLength':Infinity,'url':_0x452500+_0x31e21d(0x1b0)+_0x5e67ef+'/startChat','headers':{'Content-Type':'application/json','Accept':'application/json'},'data':_0x8991d0},_0x5f453b=await axios_1['default'][_0x31e21d(0x1cb)](_0x370765);return _0x5f453b[_0x31e21d(0x1ec)];}catch(_0x2628fb){logger_1[_0x31e21d(0x1f2)][_0x31e21d(0x1ea)](_0x31e21d(0x1c2),_0x2628fb);throw _0x2628fb;}}let _0x1de8c4,_0x2c1763,_0x539045=![];try{const _0x32c05b=new Date();_0x32c05b[_0x30894f(0x1f3)](_0x32c05b[_0x30894f(0x1ee)]()-Number(_0x4ca69d));_0x4ca69d>0x0&&_0x18707f[_0x30894f(0x1d3)]<_0x32c05b&&(await _0x18707f[_0x30894f(0x1d4)]({'typebotSessionId':null,'chatbot':!![]}),await _0x18707f[_0x30894f(0x1b6)]());!_0x18707f[_0x30894f(0x1db)]?(_0x2c1763=await _0x2c2780(_0x2479e8,_0x1f34c4,_0x3c1666),_0x1de8c4=_0x2c1763[_0x30894f(0x1ba)],_0x539045=!![],await _0x18707f[_0x30894f(0x1d4)]({'typebotSessionId':_0x1de8c4,'typebotStatus':!![],'useIntegration':!![],'integrationId':_0x1f34c4['id']}),await _0x18707f[_0x30894f(0x1b6)]()):(_0x1de8c4=_0x18707f[_0x30894f(0x1db)],_0x539045=_0x18707f[_0x30894f(0x1e4)]);if(!_0x539045)return;;if(_0x3d1be8!==_0x2c9678&&_0x3d1be8!==_0x104027){let _0x52bc75,_0x4bb498,_0x4ae7fd;if(_0x2c1763?.[_0x30894f(0x1d0)][_0x30894f(0x1d6)]===0x0||_0x2c1763===undefined){const _0x4ec7c4=JSON[_0x30894f(0x1e8)]({'message':_0x3d1be8});let _0xdce5eb={'method':_0x30894f(0x1ef),'maxBodyLength':Infinity,'url':_0x452500+'/api/v1/sessions/'+_0x1de8c4+_0x30894f(0x1b9),'headers':{'Content-Type':_0x30894f(0x1b3),'Accept':_0x30894f(0x1b3)},'data':_0x4ec7c4};_0x52bc75=await axios_1[_0x30894f(0x1ed)][_0x30894f(0x1cb)](_0xdce5eb),_0x4bb498=_0x52bc75['data']?.[_0x30894f(0x1d0)],_0x4ae7fd=_0x52bc75['data']?.['input'];}else _0x4bb498=_0x2c1763?.[_0x30894f(0x1d0)],_0x4ae7fd=_0x2c1763?.['input'];if(_0x4bb498?.[_0x30894f(0x1d6)]===0x0)await _0x3d8a5f['sendMessage'](_0x3c1666+_0x30894f(0x1b7),{'text':_0x5a612b});else{for(const _0x34e380 of _0x4bb498){if(_0x34e380[_0x30894f(0x1eb)]===_0x30894f(0x1d1)){let _0x27667e='',_0x1ac9ae=![];for(const _0x431f75 of _0x34e380[_0x30894f(0x1ad)][_0x30894f(0x1ae)]){for(const _0x25ebf9 of _0x431f75['children']){let _0x2373a4='';_0x25ebf9[_0x30894f(0x1d1)]&&(_0x2373a4=_0x25ebf9['text']);if(_0x25ebf9[_0x30894f(0x1eb)]&&_0x25ebf9[_0x30894f(0x1b1)])for(const _0xcc4577 of _0x25ebf9['children']){let _0xf776ec='';_0xcc4577[_0x30894f(0x1d1)]&&(_0xf776ec=_0xcc4577['text']);if(_0xcc4577['type']&&_0xcc4577[_0x30894f(0x1b1)])for(const _0x414cd7 of _0xcc4577[_0x30894f(0x1b1)]){let _0x310262='';_0x414cd7[_0x30894f(0x1d1)]&&(_0x310262=_0x414cd7[_0x30894f(0x1d1)]);_0x414cd7['bold']&&(_0x310262='*'+_0x310262+'*');_0x414cd7[_0x30894f(0x1e2)]&&(_0x310262='_'+_0x310262+'_');_0x414cd7['underline']&&(_0x310262='~'+_0x310262+'~');if(_0x414cd7[_0x30894f(0x1c8)]){const _0x55ee13=_0x414cd7[_0x30894f(0x1b1)][0x0][_0x30894f(0x1d1)];_0x310262='['+_0x55ee13+']('+_0x414cd7['url']+')',_0x1ac9ae=!![];}_0x27667e+=_0x310262;}_0xcc4577[_0x30894f(0x1c6)]&&(_0xf776ec='*'+_0xf776ec+'*');_0xcc4577[_0x30894f(0x1e2)]&&(_0xf776ec='_'+_0xf776ec+'_');_0xcc4577[_0x30894f(0x1f0)]&&(_0xf776ec='~'+_0xf776ec+'~');if(_0xcc4577['url']){const _0x2ebb09=_0xcc4577[_0x30894f(0x1b1)][0x0][_0x30894f(0x1d1)];_0xf776ec='['+_0x2ebb09+']('+_0xcc4577[_0x30894f(0x1c8)]+')',_0x1ac9ae=!![];}_0x27667e+=_0xf776ec;}_0x25ebf9[_0x30894f(0x1c6)]&&(_0x2373a4='*'+_0x2373a4+'*');_0x25ebf9['italic']&&(_0x2373a4='_'+_0x2373a4+'_');_0x25ebf9[_0x30894f(0x1f0)]&&(_0x2373a4='~'+_0x2373a4+'~');if(_0x25ebf9[_0x30894f(0x1c8)]){const _0x66c235=_0x25ebf9[_0x30894f(0x1b1)][0x0][_0x30894f(0x1d1)];_0x2373a4='['+_0x66c235+']('+_0x25ebf9[_0x30894f(0x1c8)]+')',_0x1ac9ae=!![];}_0x27667e+=_0x2373a4;}_0x27667e+='\x0a';}_0x27667e=_0x27667e[_0x30894f(0x1c1)]('**','')['replace'](/\n$/,'');_0x27667e==='Invalid\x20message.\x20Please,\x20try\x20again.'&&(_0x27667e=_0x5a612b);if(_0x27667e['startsWith']('#')){let _0x929189=_0x27667e['replace']('#','');try{let _0x8bb20d=JSON[_0x30894f(0x1e5)](_0x929189);if(_0x8bb20d[_0x30894f(0x1c7)]&&(0x0,lodash_1[_0x30894f(0x1bf)])(_0x8bb20d[_0x30894f(0x1b4)])&&(0x0,lodash_1[_0x30894f(0x1bf)])(_0x8bb20d[_0x30894f(0x1be)])){await _0x18707f['update']({'useIntegration':![],'chatbot':![]});return;}if(!(0x0,lodash_1['isNil'])(_0x8bb20d[_0x30894f(0x1be)])&&_0x8bb20d['queueId']>0x0&&(0x0,lodash_1[_0x30894f(0x1bf)])(_0x8bb20d[_0x30894f(0x1b4)])){await(0x0,UpdateTicketService_1[_0x30894f(0x1ed)])({'ticketData':{'queueId':_0x8bb20d[_0x30894f(0x1be)],'chatbot':![],'useIntegration':![],'integrationId':null},'ticketId':_0x18707f['id'],'companyId':_0x18707f[_0x30894f(0x1e7)]});return;}if(!(0x0,lodash_1[_0x30894f(0x1bf)])(_0x8bb20d['queueId'])&&_0x8bb20d[_0x30894f(0x1be)]>0x0&&!(0x0,lodash_1[_0x30894f(0x1bf)])(_0x8bb20d[_0x30894f(0x1b4)])&&_0x8bb20d[_0x30894f(0x1b4)]>0x0){await(0x0,UpdateTicketService_1['default'])({'ticketData':{'queueId':_0x8bb20d['queueId'],'userId':_0x8bb20d[_0x30894f(0x1b4)],'chatbot':![],'useIntegration':![],'integrationId':null},'ticketId':_0x18707f['id'],'companyId':_0x18707f[_0x30894f(0x1e7)]});return;}}catch(_0x104a41){throw _0x104a41;}}await(0x0,SendPresenceStatus_1[_0x30894f(0x1dd)])(_0x3d8a5f,_0x2479e8[_0x30894f(0x1b2)][_0x30894f(0x1d5)],_0x25eb48),await _0x3d8a5f['sendMessage'](_0x2479e8['key'][_0x30894f(0x1d5)],{'text':_0x27667e});}if(_0x34e380[_0x30894f(0x1eb)]===_0x30894f(0x1bb)){await(0x0,SendPresenceStatus_1[_0x30894f(0x1dd)])(_0x3d8a5f,_0x2479e8['key'][_0x30894f(0x1d5)],_0x25eb48);const _0x91eddd={'audio':{'url':_0x34e380['content'][_0x30894f(0x1c8)],'mimetype':_0x30894f(0x1e9),'ptt':!![]}};await _0x3d8a5f['sendMessage'](_0x2479e8['key']['remoteJid'],_0x91eddd);}if(_0x34e380['type']==='image'){await(0x0,SendPresenceStatus_1[_0x30894f(0x1dd)])(_0x3d8a5f,_0x2479e8[_0x30894f(0x1b2)][_0x30894f(0x1d5)],_0x25eb48);const _0x27cd21={'image':{'url':_0x34e380[_0x30894f(0x1ad)][_0x30894f(0x1c8)]}};await _0x3d8a5f[_0x30894f(0x1cf)](_0x2479e8[_0x30894f(0x1b2)][_0x30894f(0x1d5)],_0x27cd21);}}if(_0x4ae7fd){if(_0x4ae7fd[_0x30894f(0x1eb)]===_0x30894f(0x1bd)){let _0x3f6339='';const _0x580939=_0x4ae7fd['items'];for(const _0x53a8dc of _0x580939){_0x3f6339+='▶️\x20'+_0x53a8dc['content']+'\x0a';}_0x3f6339=_0x3f6339['replace'](/\n$/,''),await(0x0,SendPresenceStatus_1[_0x30894f(0x1dd)])(_0x3d8a5f,_0x2479e8[_0x30894f(0x1b2)][_0x30894f(0x1d5)],_0x25eb48),await _0x3d8a5f['sendMessage'](_0x2479e8[_0x30894f(0x1b2)][_0x30894f(0x1d5)],{'text':_0x3f6339});}}}}_0x3d1be8===_0x104027&&(await _0x18707f[_0x30894f(0x1d4)]({'chatbot':!![],'typebotSessionId':null}),await _0x18707f[_0x30894f(0x1b6)](),await _0x3d8a5f[_0x30894f(0x1cf)](_0x3c1666+_0x30894f(0x1b7),{'text':_0x351188}));if(_0x3d1be8===_0x2c9678){await(0x0,UpdateTicketService_1[_0x30894f(0x1ed)])({'ticketData':{'status':_0x30894f(0x1da),'useIntegration':![],'integrationId':null},'ticketId':_0x18707f['id'],'companyId':_0x18707f[_0x30894f(0x1e7)]});return;}}catch(_0x4adbd1){logger_1[_0x30894f(0x1f2)][_0x30894f(0x1ea)](_0x30894f(0x1de),_0x4adbd1),await _0x18707f['update']({'typebotSessionId':null});}};function a530_0x36d5(_0x25d070,_0x255c0d){const _0x92e5b1=a530_0x14ec();return a530_0x36d5=function(_0x12c603,_0x396241){_0x12c603=_0x12c603-0x1ac;let _0x14ec6a=_0x92e5b1[_0x12c603];return _0x14ec6a;},a530_0x36d5(_0x25d070,_0x255c0d);}exports[a530_0xfca349(0x1ed)]=typebotListener;