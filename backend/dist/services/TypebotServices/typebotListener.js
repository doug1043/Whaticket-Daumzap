const a523_0x550c19=a523_0x3bb9;(function(_0x151b95,_0x399ea1){const _0x4f9f0a=a523_0x3bb9,_0x5155e7=_0x151b95();while(!![]){try{const _0x2af57c=parseInt(_0x4f9f0a(0xc1))/0x1+-parseInt(_0x4f9f0a(0x99))/0x2+-parseInt(_0x4f9f0a(0xa2))/0x3+-parseInt(_0x4f9f0a(0xb5))/0x4*(parseInt(_0x4f9f0a(0x9a))/0x5)+-parseInt(_0x4f9f0a(0xbe))/0x6*(parseInt(_0x4f9f0a(0xb6))/0x7)+parseInt(_0x4f9f0a(0xc8))/0x8*(parseInt(_0x4f9f0a(0xc9))/0x9)+-parseInt(_0x4f9f0a(0xc2))/0xa*(-parseInt(_0x4f9f0a(0xac))/0xb);if(_0x2af57c===_0x399ea1)break;else _0x5155e7['push'](_0x5155e7['shift']());}catch(_0x1fe3cd){_0x5155e7['push'](_0x5155e7['shift']());}}}(a523_0x55fc,0x71464));const a523_0x5c57da=(function(){let _0x50011d=!![];return function(_0x351881,_0x64f62f){const _0x562676=_0x50011d?function(){if(_0x64f62f){const _0x312885=_0x64f62f['apply'](_0x351881,arguments);return _0x64f62f=null,_0x312885;}}:function(){};return _0x50011d=![],_0x562676;};}()),a523_0x5be33d=a523_0x5c57da(this,function(){const _0x582e80=a523_0x3bb9;return a523_0x5be33d[_0x582e80(0xc7)]()[_0x582e80(0xce)]('(((.+)+)+)+$')[_0x582e80(0xc7)]()['constructor'](a523_0x5be33d)[_0x582e80(0xce)](_0x582e80(0xca));});a523_0x5be33d();function a523_0x55fc(){const _0x2e7ecd=['SendPresenceStatus','defineProperty','Error\x20on\x20typebotListener:\x20','application/json','typebotSessionId','audio/mp4','2601813GCouPu','userId','default','update','url','companyId','contact','input','replace','@c.us','55XnKKNJ','/continueChat','string','../TicketServices/UpdateTicketService','type','logger','text','status@broadcast','children','4lVngdT','1141YhdXza','messages','typebotStatus','key','/api/v1/typebots/','sendMessage','queueId','parse','4926IKdAZK','__esModule','post','684123RDiHJS','2241360HMWWpQ','getMinutes','info','audio','bold','toString','727792MoSTUG','81LzwdBC','(((.+)+)+)+$','request','content','underline','search','pushName','getBodyMessage','/api/v1/sessions/','length','data','richText','../../helpers/SendPresenceStatus','Erro\x20ao\x20criar\x20sessão\x20do\x20typebot:\x20','sessionId','italic','axios','reload','remoteJid','isNil','lodash','stringify','1269714XTbfqC','2618230ZwtZYP','../../utils/logger'];a523_0x55fc=function(){return _0x2e7ecd;};return a523_0x55fc();}'use strict';var __importDefault=this&&this['__importDefault']||function(_0x57c417){return _0x57c417&&_0x57c417['__esModule']?_0x57c417:{'default':_0x57c417};};Object[a523_0x550c19(0x9d)](exports,a523_0x550c19(0xbf),{'value':!![]});const axios_1=__importDefault(require(a523_0x550c19(0x93))),wbotMessageListener_1=require('../WbotServices/wbotMessageListener'),logger_1=require(a523_0x550c19(0x9b)),lodash_1=require(a523_0x550c19(0x97)),UpdateTicketService_1=__importDefault(require(a523_0x550c19(0xaf))),SendPresenceStatus_1=require(a523_0x550c19(0x8f)),typebotListener=async({wbot:_0x2eed9d,msg:_0x2d39d6,ticket:_0x1855cc,typebot:_0x7e3541})=>{const _0x265642=a523_0x550c19;if(_0x2d39d6[_0x265642(0xb9)][_0x265642(0x95)]===_0x265642(0xb3))return;const {urlN8N:_0x43812c,typebotExpires:_0x56dacb,typebotKeywordFinish:_0x155b28,typebotKeywordRestart:_0x954463,typebotUnknownMessage:_0xceded9,typebotSlug:_0x3b2048,typebotDelayMessage:_0x37ec85,typebotRestartMessage:_0x3cdcc9}=_0x7e3541,_0x43bf48=_0x2d39d6[_0x265642(0xb9)]['remoteJid'][_0x265642(0xaa)](/\D/g,'');let _0x157583=(0x0,wbotMessageListener_1[_0x265642(0xd0)])(_0x2d39d6);async function _0xf839ab(_0x5095de,_0x1efe1d,_0x4f34fe){const _0x5c0340=_0x265642;try{const _0x2b06cf=JSON[_0x5c0340(0x98)]({'isStreamEnabled':!![],'message':'string','resultId':_0x5c0340(0xae),'isOnlyRegistering':![],'prefilledVariables':{'number':_0x4f34fe,'pushName':_0x5095de[_0x5c0340(0xcf)]||'','remoteJid':_0x1855cc?.[_0x5c0340(0xa8)]?.[_0x5c0340(0x95)]}}),_0xbabb4f={'method':_0x5c0340(0xc0),'maxBodyLength':Infinity,'url':_0x43812c+_0x5c0340(0xba)+_0x3b2048+'/startChat','headers':{'Content-Type':'application/json','Accept':'application/json'},'data':_0x2b06cf},_0x437377=await axios_1['default'][_0x5c0340(0xcb)](_0xbabb4f);return _0x437377[_0x5c0340(0x8d)];}catch(_0xed1f7d){logger_1[_0x5c0340(0xb1)][_0x5c0340(0xc4)](_0x5c0340(0x90),_0xed1f7d);throw _0xed1f7d;}}let _0x5c9aff,_0x371345,_0x4ca3f0=![];try{const _0x2abc32=new Date();_0x2abc32['setMinutes'](_0x2abc32[_0x265642(0xc3)]()-Number(_0x56dacb));_0x56dacb>0x0&&_0x1855cc['updatedAt']<_0x2abc32&&(await _0x1855cc[_0x265642(0xa5)]({'typebotSessionId':null,'chatbot':!![]}),await _0x1855cc[_0x265642(0x94)]());!_0x1855cc['typebotSessionId']?(_0x371345=await _0xf839ab(_0x2d39d6,_0x7e3541,_0x43bf48),_0x5c9aff=_0x371345[_0x265642(0x91)],_0x4ca3f0=!![],await _0x1855cc[_0x265642(0xa5)]({'typebotSessionId':_0x5c9aff,'typebotStatus':!![],'useIntegration':!![],'integrationId':_0x7e3541['id']}),await _0x1855cc[_0x265642(0x94)]()):(_0x5c9aff=_0x1855cc[_0x265642(0xa0)],_0x4ca3f0=_0x1855cc[_0x265642(0xb8)]);if(!_0x4ca3f0)return;;if(_0x157583!==_0x155b28&&_0x157583!==_0x954463){let _0x18d63d,_0x1b76a7,_0x1b6b48;if(_0x371345?.[_0x265642(0xb7)][_0x265642(0x8c)]===0x0||_0x371345===undefined){const _0x58bc9b=JSON['stringify']({'message':_0x157583});let _0x7ff4ba={'method':_0x265642(0xc0),'maxBodyLength':Infinity,'url':_0x43812c+_0x265642(0xd1)+_0x5c9aff+_0x265642(0xad),'headers':{'Content-Type':'application/json','Accept':_0x265642(0x9f)},'data':_0x58bc9b};_0x18d63d=await axios_1[_0x265642(0xa4)][_0x265642(0xcb)](_0x7ff4ba),_0x1b76a7=_0x18d63d[_0x265642(0x8d)]?.[_0x265642(0xb7)],_0x1b6b48=_0x18d63d[_0x265642(0x8d)]?.['input'];}else _0x1b76a7=_0x371345?.['messages'],_0x1b6b48=_0x371345?.[_0x265642(0xa9)];if(_0x1b76a7?.[_0x265642(0x8c)]===0x0)await _0x2eed9d[_0x265642(0xbb)](_0x43bf48+_0x265642(0xab),{'text':_0xceded9});else{for(const _0x3b03a3 of _0x1b76a7){if(_0x3b03a3['type']==='text'){let _0x2107f4='',_0x3a9a12=![];for(const _0x2d4540 of _0x3b03a3[_0x265642(0xcc)][_0x265642(0x8e)]){for(const _0xf2536e of _0x2d4540[_0x265642(0xb4)]){let _0x2af9eb='';_0xf2536e[_0x265642(0xb2)]&&(_0x2af9eb=_0xf2536e[_0x265642(0xb2)]);if(_0xf2536e['type']&&_0xf2536e[_0x265642(0xb4)])for(const _0x3dcdb5 of _0xf2536e[_0x265642(0xb4)]){let _0x34b18c='';_0x3dcdb5[_0x265642(0xb2)]&&(_0x34b18c=_0x3dcdb5[_0x265642(0xb2)]);if(_0x3dcdb5[_0x265642(0xb0)]&&_0x3dcdb5['children'])for(const _0x3d57b5 of _0x3dcdb5[_0x265642(0xb4)]){let _0x1f593b='';_0x3d57b5[_0x265642(0xb2)]&&(_0x1f593b=_0x3d57b5[_0x265642(0xb2)]);_0x3d57b5[_0x265642(0xc6)]&&(_0x1f593b='*'+_0x1f593b+'*');_0x3d57b5[_0x265642(0x92)]&&(_0x1f593b='_'+_0x1f593b+'_');_0x3d57b5[_0x265642(0xcd)]&&(_0x1f593b='~'+_0x1f593b+'~');if(_0x3d57b5['url']){const _0x2cd820=_0x3d57b5[_0x265642(0xb4)][0x0][_0x265642(0xb2)];_0x1f593b='['+_0x2cd820+']('+_0x3d57b5[_0x265642(0xa6)]+')',_0x3a9a12=!![];}_0x2107f4+=_0x1f593b;}_0x3dcdb5['bold']&&(_0x34b18c='*'+_0x34b18c+'*');_0x3dcdb5[_0x265642(0x92)]&&(_0x34b18c='_'+_0x34b18c+'_');_0x3dcdb5[_0x265642(0xcd)]&&(_0x34b18c='~'+_0x34b18c+'~');if(_0x3dcdb5[_0x265642(0xa6)]){const _0x1cae7b=_0x3dcdb5['children'][0x0][_0x265642(0xb2)];_0x34b18c='['+_0x1cae7b+']('+_0x3dcdb5['url']+')',_0x3a9a12=!![];}_0x2107f4+=_0x34b18c;}_0xf2536e[_0x265642(0xc6)]&&(_0x2af9eb='*'+_0x2af9eb+'*');_0xf2536e['italic']&&(_0x2af9eb='_'+_0x2af9eb+'_');_0xf2536e[_0x265642(0xcd)]&&(_0x2af9eb='~'+_0x2af9eb+'~');if(_0xf2536e[_0x265642(0xa6)]){const _0x2ffbbf=_0xf2536e[_0x265642(0xb4)][0x0][_0x265642(0xb2)];_0x2af9eb='['+_0x2ffbbf+']('+_0xf2536e[_0x265642(0xa6)]+')',_0x3a9a12=!![];}_0x2107f4+=_0x2af9eb;}_0x2107f4+='\x0a';}_0x2107f4=_0x2107f4[_0x265642(0xaa)]('**','')[_0x265642(0xaa)](/\n$/,'');_0x2107f4==='Invalid\x20message.\x20Please,\x20try\x20again.'&&(_0x2107f4=_0xceded9);if(_0x2107f4['startsWith']('#')){let _0xeea2d5=_0x2107f4[_0x265642(0xaa)]('#','');try{let _0x2ec71c=JSON[_0x265642(0xbd)](_0xeea2d5);if(_0x2ec71c['stopBot']&&(0x0,lodash_1['isNil'])(_0x2ec71c[_0x265642(0xa3)])&&(0x0,lodash_1[_0x265642(0x96)])(_0x2ec71c[_0x265642(0xbc)])){await _0x1855cc[_0x265642(0xa5)]({'useIntegration':![],'chatbot':![]});return;}if(!(0x0,lodash_1[_0x265642(0x96)])(_0x2ec71c['queueId'])&&_0x2ec71c[_0x265642(0xbc)]>0x0&&(0x0,lodash_1[_0x265642(0x96)])(_0x2ec71c['userId'])){await(0x0,UpdateTicketService_1[_0x265642(0xa4)])({'ticketData':{'queueId':_0x2ec71c[_0x265642(0xbc)],'chatbot':![],'useIntegration':![],'integrationId':null},'ticketId':_0x1855cc['id'],'companyId':_0x1855cc[_0x265642(0xa7)]});return;}if(!(0x0,lodash_1[_0x265642(0x96)])(_0x2ec71c['queueId'])&&_0x2ec71c[_0x265642(0xbc)]>0x0&&!(0x0,lodash_1[_0x265642(0x96)])(_0x2ec71c['userId'])&&_0x2ec71c[_0x265642(0xa3)]>0x0){await(0x0,UpdateTicketService_1['default'])({'ticketData':{'queueId':_0x2ec71c['queueId'],'userId':_0x2ec71c[_0x265642(0xa3)],'chatbot':![],'useIntegration':![],'integrationId':null},'ticketId':_0x1855cc['id'],'companyId':_0x1855cc['companyId']});return;}}catch(_0x2faf49){throw _0x2faf49;}}await(0x0,SendPresenceStatus_1[_0x265642(0x9c)])(_0x2eed9d,_0x2d39d6[_0x265642(0xb9)][_0x265642(0x95)],_0x37ec85),await _0x2eed9d['sendMessage'](_0x2d39d6[_0x265642(0xb9)][_0x265642(0x95)],{'text':_0x2107f4});}if(_0x3b03a3[_0x265642(0xb0)]===_0x265642(0xc5)){await(0x0,SendPresenceStatus_1[_0x265642(0x9c)])(_0x2eed9d,_0x2d39d6['key'][_0x265642(0x95)],_0x37ec85);const _0x58ed64={'audio':{'url':_0x3b03a3[_0x265642(0xcc)][_0x265642(0xa6)],'mimetype':_0x265642(0xa1),'ptt':!![]}};await _0x2eed9d['sendMessage'](_0x2d39d6[_0x265642(0xb9)][_0x265642(0x95)],_0x58ed64);}if(_0x3b03a3['type']==='image'){await(0x0,SendPresenceStatus_1[_0x265642(0x9c)])(_0x2eed9d,_0x2d39d6[_0x265642(0xb9)][_0x265642(0x95)],_0x37ec85);const _0x2f3c1a={'image':{'url':_0x3b03a3[_0x265642(0xcc)][_0x265642(0xa6)]}};await _0x2eed9d[_0x265642(0xbb)](_0x2d39d6[_0x265642(0xb9)][_0x265642(0x95)],_0x2f3c1a);}}if(_0x1b6b48){if(_0x1b6b48[_0x265642(0xb0)]==='choice\x20input'){let _0x5c5902='';const _0x4750d0=_0x1b6b48['items'];for(const _0x4b7499 of _0x4750d0){_0x5c5902+='▶️\x20'+_0x4b7499[_0x265642(0xcc)]+'\x0a';}_0x5c5902=_0x5c5902[_0x265642(0xaa)](/\n$/,''),await(0x0,SendPresenceStatus_1[_0x265642(0x9c)])(_0x2eed9d,_0x2d39d6['key'][_0x265642(0x95)],_0x37ec85),await _0x2eed9d['sendMessage'](_0x2d39d6[_0x265642(0xb9)][_0x265642(0x95)],{'text':_0x5c5902});}}}}_0x157583===_0x954463&&(await _0x1855cc[_0x265642(0xa5)]({'chatbot':!![],'typebotSessionId':null}),await _0x1855cc[_0x265642(0x94)](),await _0x2eed9d[_0x265642(0xbb)](_0x43bf48+_0x265642(0xab),{'text':_0x3cdcc9}));if(_0x157583===_0x155b28){await(0x0,UpdateTicketService_1[_0x265642(0xa4)])({'ticketData':{'status':'closed','useIntegration':![],'integrationId':null},'ticketId':_0x1855cc['id'],'companyId':_0x1855cc['companyId']});return;}}catch(_0x53eda4){logger_1[_0x265642(0xb1)][_0x265642(0xc4)](_0x265642(0x9e),_0x53eda4),await _0x1855cc[_0x265642(0xa5)]({'typebotSessionId':null});}};function a523_0x3bb9(_0x43c99a,_0x3b9477){const _0x42e617=a523_0x55fc();return a523_0x3bb9=function(_0x5be33d,_0x5c57da){_0x5be33d=_0x5be33d-0x8c;let _0x55fca1=_0x42e617[_0x5be33d];return _0x55fca1;},a523_0x3bb9(_0x43c99a,_0x3b9477);}exports[a523_0x550c19(0xa4)]=typebotListener;