const a530_0x5d5c48=a530_0x926b;(function(_0x5f2804,_0xc0de58){const _0x4b6c46=a530_0x926b,_0x546a62=_0x5f2804();while(!![]){try{const _0x4f3ae7=-parseInt(_0x4b6c46(0x18e))/0x1+-parseInt(_0x4b6c46(0x1b3))/0x2+parseInt(_0x4b6c46(0x18b))/0x3+parseInt(_0x4b6c46(0x1b0))/0x4+parseInt(_0x4b6c46(0x1a8))/0x5*(parseInt(_0x4b6c46(0x192))/0x6)+-parseInt(_0x4b6c46(0x183))/0x7*(parseInt(_0x4b6c46(0x177))/0x8)+parseInt(_0x4b6c46(0x1a4))/0x9*(parseInt(_0x4b6c46(0x19e))/0xa);if(_0x4f3ae7===_0xc0de58)break;else _0x546a62['push'](_0x546a62['shift']());}catch(_0x1af312){_0x546a62['push'](_0x546a62['shift']());}}}(a530_0x46ef,0xc1579));const a530_0x52c511=(function(){let _0x52a740=!![];return function(_0x1e87bd,_0x1efbae){const _0x335b47=_0x52a740?function(){if(_0x1efbae){const _0x34bcd8=_0x1efbae['apply'](_0x1e87bd,arguments);return _0x1efbae=null,_0x34bcd8;}}:function(){};return _0x52a740=![],_0x335b47;};}()),a530_0x54cd4f=a530_0x52c511(this,function(){const _0x15f7b1=a530_0x926b;return a530_0x54cd4f[_0x15f7b1(0x1b5)]()[_0x15f7b1(0x1ae)]('(((.+)+)+)+$')[_0x15f7b1(0x1b5)]()[_0x15f7b1(0x1b7)](a530_0x54cd4f)[_0x15f7b1(0x1ae)]('(((.+)+)+)+$');});a530_0x54cd4f();function a530_0x926b(_0x348417,_0x2b6311){const _0x264b51=a530_0x46ef();return a530_0x926b=function(_0x54cd4f,_0x52c511){_0x54cd4f=_0x54cd4f-0x171;let _0x46ef2f=_0x264b51[_0x54cd4f];return _0x46ef2f;},a530_0x926b(_0x348417,_0x2b6311);}'use strict';var __importDefault=this&&this['__importDefault']||function(_0x2c63a5){const _0xa0d18c=a530_0x926b;return _0x2c63a5&&_0x2c63a5[_0xa0d18c(0x17a)]?_0x2c63a5:{'default':_0x2c63a5};};function a530_0x46ef(){const _0x2b14e3=['4169025QnHYUD','underline','getMinutes','children','798040eIgjms','setMinutes','update','application/json','sessionId','contact','search','../../utils/logger','4756824YhPJEr','request','axios','1506508sxFzOt','userId','toString','stringify','constructor','messages','Error\x20on\x20typebotListener:\x20','getBodyMessage','remoteJid','input','url','/api/v1/typebots/','64744eFFKqR','isNil','companyId','__esModule','Erro\x20ao\x20criar\x20sessão\x20do\x20typebot:\x20','key','data','/startChat','/continueChat','typebotStatus','post','sendMessage','91LNMmqK','/api/v1/sessions/','text','SendPresenceStatus','reload','info','@c.us','default','2737848yyQZyP','../../helpers/SendPresenceStatus','italic','1074263mJkeUm','updatedAt','length','string','6UFueNF','replace','typebotSessionId','items','type','Invalid\x20message.\x20Please,\x20try\x20again.','logger','../WbotServices/wbotMessageListener','queueId','richText','audio/mp4','content','10zwDaYb','closed','▶️\x20','audio','stopBot','bold'];a530_0x46ef=function(){return _0x2b14e3;};return a530_0x46ef();}Object['defineProperty'](exports,'__esModule',{'value':!![]});const axios_1=__importDefault(require(a530_0x5d5c48(0x1b2))),wbotMessageListener_1=require(a530_0x5d5c48(0x199)),logger_1=require(a530_0x5d5c48(0x1af)),lodash_1=require('lodash'),UpdateTicketService_1=__importDefault(require('../TicketServices/UpdateTicketService')),SendPresenceStatus_1=require(a530_0x5d5c48(0x18c)),typebotListener=async({wbot:_0x5d1b,msg:_0x5a405f,ticket:_0x454a80,typebot:_0x559f4e})=>{const _0x2aaf18=a530_0x5d5c48;if(_0x5a405f['key']['remoteJid']==='status@broadcast')return;const {urlN8N:_0xc3bec5,typebotExpires:_0x1ad892,typebotKeywordFinish:_0x361e5b,typebotKeywordRestart:_0x3ac6a5,typebotUnknownMessage:_0x2fa9cd,typebotSlug:_0x302e3f,typebotDelayMessage:_0x511823,typebotRestartMessage:_0x3f15b2}=_0x559f4e,_0x526ffa=_0x5a405f[_0x2aaf18(0x17c)][_0x2aaf18(0x173)][_0x2aaf18(0x193)](/\D/g,'');let _0x30f4d4=(0x0,wbotMessageListener_1[_0x2aaf18(0x172)])(_0x5a405f);async function _0x53cc39(_0x525d8f,_0x882b45,_0x15edc1){const _0x1ea604=_0x2aaf18;try{const _0x25869e=JSON[_0x1ea604(0x1b6)]({'isStreamEnabled':!![],'message':'string','resultId':_0x1ea604(0x191),'isOnlyRegistering':![],'prefilledVariables':{'number':_0x15edc1,'pushName':_0x525d8f['pushName']||'','remoteJid':_0x454a80?.[_0x1ea604(0x1ad)]?.[_0x1ea604(0x173)]}}),_0x1d5ce1={'method':_0x1ea604(0x181),'maxBodyLength':Infinity,'url':_0xc3bec5+_0x1ea604(0x176)+_0x302e3f+_0x1ea604(0x17e),'headers':{'Content-Type':'application/json','Accept':_0x1ea604(0x1ab)},'data':_0x25869e},_0x14a788=await axios_1[_0x1ea604(0x18a)][_0x1ea604(0x1b1)](_0x1d5ce1);return _0x14a788[_0x1ea604(0x17d)];}catch(_0x2cdcdd){logger_1[_0x1ea604(0x198)][_0x1ea604(0x188)](_0x1ea604(0x17b),_0x2cdcdd);throw _0x2cdcdd;}}let _0x2ecee4,_0x3f9585,_0x596b00=![];try{const _0x53081d=new Date();_0x53081d[_0x2aaf18(0x1a9)](_0x53081d[_0x2aaf18(0x1a6)]()-Number(_0x1ad892));_0x1ad892>0x0&&_0x454a80[_0x2aaf18(0x18f)]<_0x53081d&&(await _0x454a80[_0x2aaf18(0x1aa)]({'typebotSessionId':null,'chatbot':!![]}),await _0x454a80[_0x2aaf18(0x187)]());!_0x454a80[_0x2aaf18(0x194)]?(_0x3f9585=await _0x53cc39(_0x5a405f,_0x559f4e,_0x526ffa),_0x2ecee4=_0x3f9585[_0x2aaf18(0x1ac)],_0x596b00=!![],await _0x454a80[_0x2aaf18(0x1aa)]({'typebotSessionId':_0x2ecee4,'typebotStatus':!![],'useIntegration':!![],'integrationId':_0x559f4e['id']}),await _0x454a80['reload']()):(_0x2ecee4=_0x454a80[_0x2aaf18(0x194)],_0x596b00=_0x454a80[_0x2aaf18(0x180)]);if(!_0x596b00)return;;if(_0x30f4d4!==_0x361e5b&&_0x30f4d4!==_0x3ac6a5){let _0x4747a5,_0x127d7d,_0x38680b;if(_0x3f9585?.['messages']['length']===0x0||_0x3f9585===undefined){const _0x185647=JSON[_0x2aaf18(0x1b6)]({'message':_0x30f4d4});let _0x5af83e={'method':_0x2aaf18(0x181),'maxBodyLength':Infinity,'url':_0xc3bec5+_0x2aaf18(0x184)+_0x2ecee4+_0x2aaf18(0x17f),'headers':{'Content-Type':_0x2aaf18(0x1ab),'Accept':_0x2aaf18(0x1ab)},'data':_0x185647};_0x4747a5=await axios_1[_0x2aaf18(0x18a)][_0x2aaf18(0x1b1)](_0x5af83e),_0x127d7d=_0x4747a5['data']?.[_0x2aaf18(0x1b8)],_0x38680b=_0x4747a5[_0x2aaf18(0x17d)]?.[_0x2aaf18(0x174)];}else _0x127d7d=_0x3f9585?.[_0x2aaf18(0x1b8)],_0x38680b=_0x3f9585?.[_0x2aaf18(0x174)];if(_0x127d7d?.[_0x2aaf18(0x190)]===0x0)await _0x5d1b[_0x2aaf18(0x182)](_0x526ffa+_0x2aaf18(0x189),{'text':_0x2fa9cd});else{for(const _0x22daef of _0x127d7d){if(_0x22daef['type']==='text'){let _0x4ee316='',_0x16aadd=![];for(const _0x18f72b of _0x22daef[_0x2aaf18(0x19d)][_0x2aaf18(0x19b)]){for(const _0x201182 of _0x18f72b['children']){let _0x152f0e='';_0x201182[_0x2aaf18(0x185)]&&(_0x152f0e=_0x201182['text']);if(_0x201182['type']&&_0x201182[_0x2aaf18(0x1a7)])for(const _0x12eac9 of _0x201182[_0x2aaf18(0x1a7)]){let _0x508075='';_0x12eac9['text']&&(_0x508075=_0x12eac9[_0x2aaf18(0x185)]);if(_0x12eac9[_0x2aaf18(0x196)]&&_0x12eac9[_0x2aaf18(0x1a7)])for(const _0x5960b3 of _0x12eac9[_0x2aaf18(0x1a7)]){let _0x5d2a7c='';_0x5960b3[_0x2aaf18(0x185)]&&(_0x5d2a7c=_0x5960b3[_0x2aaf18(0x185)]);_0x5960b3[_0x2aaf18(0x1a3)]&&(_0x5d2a7c='*'+_0x5d2a7c+'*');_0x5960b3['italic']&&(_0x5d2a7c='_'+_0x5d2a7c+'_');_0x5960b3[_0x2aaf18(0x1a5)]&&(_0x5d2a7c='~'+_0x5d2a7c+'~');if(_0x5960b3[_0x2aaf18(0x175)]){const _0x3afdb9=_0x5960b3[_0x2aaf18(0x1a7)][0x0][_0x2aaf18(0x185)];_0x5d2a7c='['+_0x3afdb9+']('+_0x5960b3[_0x2aaf18(0x175)]+')',_0x16aadd=!![];}_0x4ee316+=_0x5d2a7c;}_0x12eac9[_0x2aaf18(0x1a3)]&&(_0x508075='*'+_0x508075+'*');_0x12eac9[_0x2aaf18(0x18d)]&&(_0x508075='_'+_0x508075+'_');_0x12eac9['underline']&&(_0x508075='~'+_0x508075+'~');if(_0x12eac9[_0x2aaf18(0x175)]){const _0x2d9942=_0x12eac9[_0x2aaf18(0x1a7)][0x0]['text'];_0x508075='['+_0x2d9942+']('+_0x12eac9[_0x2aaf18(0x175)]+')',_0x16aadd=!![];}_0x4ee316+=_0x508075;}_0x201182[_0x2aaf18(0x1a3)]&&(_0x152f0e='*'+_0x152f0e+'*');_0x201182[_0x2aaf18(0x18d)]&&(_0x152f0e='_'+_0x152f0e+'_');_0x201182[_0x2aaf18(0x1a5)]&&(_0x152f0e='~'+_0x152f0e+'~');if(_0x201182[_0x2aaf18(0x175)]){const _0x20b612=_0x201182[_0x2aaf18(0x1a7)][0x0]['text'];_0x152f0e='['+_0x20b612+']('+_0x201182[_0x2aaf18(0x175)]+')',_0x16aadd=!![];}_0x4ee316+=_0x152f0e;}_0x4ee316+='\x0a';}_0x4ee316=_0x4ee316[_0x2aaf18(0x193)]('**','')['replace'](/\n$/,'');_0x4ee316===_0x2aaf18(0x197)&&(_0x4ee316=_0x2fa9cd);if(_0x4ee316['startsWith']('#')){let _0x2dca8a=_0x4ee316[_0x2aaf18(0x193)]('#','');try{let _0x1b4c1c=JSON['parse'](_0x2dca8a);if(_0x1b4c1c[_0x2aaf18(0x1a2)]&&(0x0,lodash_1[_0x2aaf18(0x178)])(_0x1b4c1c['userId'])&&(0x0,lodash_1[_0x2aaf18(0x178)])(_0x1b4c1c[_0x2aaf18(0x19a)])){await _0x454a80[_0x2aaf18(0x1aa)]({'useIntegration':![],'chatbot':![]});return;}if(!(0x0,lodash_1['isNil'])(_0x1b4c1c[_0x2aaf18(0x19a)])&&_0x1b4c1c[_0x2aaf18(0x19a)]>0x0&&(0x0,lodash_1[_0x2aaf18(0x178)])(_0x1b4c1c[_0x2aaf18(0x1b4)])){await(0x0,UpdateTicketService_1['default'])({'ticketData':{'queueId':_0x1b4c1c[_0x2aaf18(0x19a)],'chatbot':![],'useIntegration':![],'integrationId':null},'ticketId':_0x454a80['id'],'companyId':_0x454a80['companyId']});return;}if(!(0x0,lodash_1['isNil'])(_0x1b4c1c[_0x2aaf18(0x19a)])&&_0x1b4c1c['queueId']>0x0&&!(0x0,lodash_1[_0x2aaf18(0x178)])(_0x1b4c1c[_0x2aaf18(0x1b4)])&&_0x1b4c1c[_0x2aaf18(0x1b4)]>0x0){await(0x0,UpdateTicketService_1[_0x2aaf18(0x18a)])({'ticketData':{'queueId':_0x1b4c1c[_0x2aaf18(0x19a)],'userId':_0x1b4c1c['userId'],'chatbot':![],'useIntegration':![],'integrationId':null},'ticketId':_0x454a80['id'],'companyId':_0x454a80[_0x2aaf18(0x179)]});return;}}catch(_0x52d232){throw _0x52d232;}}await(0x0,SendPresenceStatus_1[_0x2aaf18(0x186)])(_0x5d1b,_0x5a405f['key']['remoteJid'],_0x511823),await _0x5d1b['sendMessage'](_0x5a405f['key']['remoteJid'],{'text':_0x4ee316});}if(_0x22daef[_0x2aaf18(0x196)]===_0x2aaf18(0x1a1)){await(0x0,SendPresenceStatus_1[_0x2aaf18(0x186)])(_0x5d1b,_0x5a405f[_0x2aaf18(0x17c)]['remoteJid'],_0x511823);const _0x3499e1={'audio':{'url':_0x22daef[_0x2aaf18(0x19d)][_0x2aaf18(0x175)],'mimetype':_0x2aaf18(0x19c),'ptt':!![]}};await _0x5d1b['sendMessage'](_0x5a405f['key'][_0x2aaf18(0x173)],_0x3499e1);}if(_0x22daef[_0x2aaf18(0x196)]==='image'){await(0x0,SendPresenceStatus_1['SendPresenceStatus'])(_0x5d1b,_0x5a405f['key'][_0x2aaf18(0x173)],_0x511823);const _0x41430f={'image':{'url':_0x22daef[_0x2aaf18(0x19d)]['url']}};await _0x5d1b[_0x2aaf18(0x182)](_0x5a405f[_0x2aaf18(0x17c)][_0x2aaf18(0x173)],_0x41430f);}}if(_0x38680b){if(_0x38680b[_0x2aaf18(0x196)]==='choice\x20input'){let _0x3cffef='';const _0x65fd5c=_0x38680b[_0x2aaf18(0x195)];for(const _0x24c223 of _0x65fd5c){_0x3cffef+=_0x2aaf18(0x1a0)+_0x24c223['content']+'\x0a';}_0x3cffef=_0x3cffef[_0x2aaf18(0x193)](/\n$/,''),await(0x0,SendPresenceStatus_1[_0x2aaf18(0x186)])(_0x5d1b,_0x5a405f[_0x2aaf18(0x17c)][_0x2aaf18(0x173)],_0x511823),await _0x5d1b[_0x2aaf18(0x182)](_0x5a405f[_0x2aaf18(0x17c)][_0x2aaf18(0x173)],{'text':_0x3cffef});}}}}_0x30f4d4===_0x3ac6a5&&(await _0x454a80['update']({'chatbot':!![],'typebotSessionId':null}),await _0x454a80[_0x2aaf18(0x187)](),await _0x5d1b['sendMessage'](_0x526ffa+'@c.us',{'text':_0x3f15b2}));if(_0x30f4d4===_0x361e5b){await(0x0,UpdateTicketService_1[_0x2aaf18(0x18a)])({'ticketData':{'status':_0x2aaf18(0x19f),'useIntegration':![],'integrationId':null},'ticketId':_0x454a80['id'],'companyId':_0x454a80['companyId']});return;}}catch(_0x52b253){logger_1[_0x2aaf18(0x198)][_0x2aaf18(0x188)](_0x2aaf18(0x171),_0x52b253),await _0x454a80[_0x2aaf18(0x1aa)]({'typebotSessionId':null});}};exports[a530_0x5d5c48(0x18a)]=typebotListener;