'use strict';function a632_0x1167(){const _0x58a7a3=['metadata','key','object','call','5857JiDEOt','findAll','794888geQlnU','configurable','getTime','emit','length','contact','toString','get','number','default','134SlXOSL','count','-tag-log','error','1650798brjwMX','writable','63UQJeKW','prototype','PENDENTE','value','name','__importDefault','company-','random','min','yup','Erro\x20ao\x20criar\x20log\x20de\x20tag:\x20','create','__setModuleDefault','__esModule','messageInterval','1444955jApZRu','shape','floor','8BPYCvq','../../models/CampaignSetting','1764042XyrWYf','search','forEach','(((.+)+)+)+$','validate','2364648YNmDvX','getIO','greaterInterval','defineProperty','6692300JEXQSX','string','../../models/Contact','required','getOwnPropertyNames','../../errors/AppError','message','hasOwnProperty','longerIntervalAfter','parse'];a632_0x1167=function(){return _0x58a7a3;};return a632_0x1167();}const a632_0x1c146d=a632_0x2f9e;(function(_0x4d5307,_0x3c82bb){const _0x464b16=a632_0x2f9e,_0x3a523d=_0x4d5307();while(!![]){try{const _0x551de8=-parseInt(_0x464b16(0x15b))/0x1*(parseInt(_0x464b16(0x167))/0x2)+-parseInt(_0x464b16(0x16b))/0x3+-parseInt(_0x464b16(0x142))/0x4*(-parseInt(_0x464b16(0x13f))/0x5)+-parseInt(_0x464b16(0x149))/0x6+-parseInt(_0x464b16(0x144))/0x7+-parseInt(_0x464b16(0x15d))/0x8*(-parseInt(_0x464b16(0x16d))/0x9)+parseInt(_0x464b16(0x14d))/0xa;if(_0x551de8===_0x3c82bb)break;else _0x3a523d['push'](_0x3a523d['shift']());}catch(_0x3d3def){_0x3a523d['push'](_0x3a523d['shift']());}}}(a632_0x1167,0x56694));var __createBinding=this&&this['__createBinding']||(Object[a632_0x1c146d(0x13b)]?function(_0x3ebe38,_0x52daf8,_0x24737f,_0x32e377){const _0x5bda4a=a632_0x1c146d;if(_0x32e377===undefined)_0x32e377=_0x24737f;var _0x4c9423=Object['getOwnPropertyDescriptor'](_0x52daf8,_0x24737f);(!_0x4c9423||(_0x5bda4a(0x164)in _0x4c9423?!_0x52daf8[_0x5bda4a(0x13d)]:_0x4c9423[_0x5bda4a(0x16c)]||_0x4c9423[_0x5bda4a(0x15e)]))&&(_0x4c9423={'enumerable':!![],'get':function(){return _0x52daf8[_0x24737f];}}),Object['defineProperty'](_0x3ebe38,_0x32e377,_0x4c9423);}:function(_0xc8d8a,_0x432da9,_0x3ab77f,_0x3dfcd7){if(_0x3dfcd7===undefined)_0x3dfcd7=_0x3ab77f;_0xc8d8a[_0x3dfcd7]=_0x432da9[_0x3ab77f];}),__setModuleDefault=this&&this[a632_0x1c146d(0x13c)]||(Object[a632_0x1c146d(0x13b)]?function(_0x15f51f,_0x4b5ea0){const _0x18eff3=a632_0x1c146d;Object[_0x18eff3(0x14c)](_0x15f51f,'default',{'enumerable':!![],'value':_0x4b5ea0});}:function(_0x2d872f,_0x1bb53b){const _0x14981b=a632_0x1c146d;_0x2d872f[_0x14981b(0x166)]=_0x1bb53b;}),__importStar=this&&this['__importStar']||(function(){const _0x5eb5e1=(function(){let _0x303241=!![];return function(_0x3714b7,_0x436a89){const _0x562fd2=_0x303241?function(){if(_0x436a89){const _0x4d2def=_0x436a89['apply'](_0x3714b7,arguments);return _0x436a89=null,_0x4d2def;}}:function(){};return _0x303241=![],_0x562fd2;};}()),_0x335d32=_0x5eb5e1(this,function(){const _0x511977=a632_0x2f9e;return _0x335d32[_0x511977(0x163)]()[_0x511977(0x145)]('(((.+)+)+)+$')[_0x511977(0x163)]()['constructor'](_0x335d32)['search'](_0x511977(0x147));});_0x335d32();var _0x44941b=function(_0x4cf0bf){const _0x5bd57b=a632_0x2f9e;return _0x44941b=Object[_0x5bd57b(0x151)]||function(_0x2d1b17){const _0x42c975=_0x5bd57b;var _0x4e4b7a=[];for(var _0x715627 in _0x2d1b17)if(Object[_0x42c975(0x16e)][_0x42c975(0x154)][_0x42c975(0x15a)](_0x2d1b17,_0x715627))_0x4e4b7a[_0x4e4b7a[_0x42c975(0x161)]]=_0x715627;return _0x4e4b7a;},_0x44941b(_0x4cf0bf);};return function(_0x2a5960){const _0x575dcc=a632_0x2f9e;if(_0x2a5960&&_0x2a5960[_0x575dcc(0x13d)])return _0x2a5960;var _0x401fde={};if(_0x2a5960!=null){for(var _0x55a01f=_0x44941b(_0x2a5960),_0x1443a5=0x0;_0x1443a5<_0x55a01f[_0x575dcc(0x161)];_0x1443a5++)if(_0x55a01f[_0x1443a5]!==_0x575dcc(0x166))__createBinding(_0x401fde,_0x2a5960,_0x55a01f[_0x1443a5]);}return __setModuleDefault(_0x401fde,_0x2a5960),_0x401fde;};}()),__importDefault=this&&this[a632_0x1c146d(0x172)]||function(_0x1ee975){const _0x30f00e=a632_0x1c146d;return _0x1ee975&&_0x1ee975[_0x30f00e(0x13d)]?_0x1ee975:{'default':_0x1ee975};};Object[a632_0x1c146d(0x14c)](exports,'__esModule',{'value':!![]});const Yup=__importStar(require(a632_0x1c146d(0x139))),AppError_1=__importDefault(require(a632_0x1c146d(0x152))),Schedule_1=__importDefault(require('../../models/Schedule')),Contact_1=__importDefault(require(a632_0x1c146d(0x14f))),CampaignSetting_1=__importDefault(require(a632_0x1c146d(0x143))),TagLog_1=__importDefault(require('../../models/TagLog')),socket_1=require('../../libs/socket');async function getCampaignSettings(_0x5e6acb){const _0x4fbb43=a632_0x1c146d,_0x3c24d0=await CampaignSetting_1[_0x4fbb43(0x166)][_0x4fbb43(0x15c)]({'where':{'companyId':_0x5e6acb}}),_0x4e5963={'messageInterval':0x14,'longerIntervalAfter':0x14,'greaterInterval':0x3c};return _0x3c24d0[_0x4fbb43(0x146)](_0x414940=>{const _0x2667a4=_0x4fbb43;try{_0x4e5963[_0x414940[_0x2667a4(0x158)]]=JSON[_0x2667a4(0x156)](_0x414940['value']);}catch(_0x11a448){_0x4e5963[_0x414940['key']]=_0x414940[_0x2667a4(0x170)];}}),_0x4e5963;}function randomValue(_0x5ed7e2,_0x1a85c8){const _0x52eaeb=a632_0x1c146d;return Math[_0x52eaeb(0x141)](Math[_0x52eaeb(0x174)]()*(_0x1a85c8-_0x5ed7e2+0x1))+_0x5ed7e2;}function parseToMilliseconds(_0x38b6b1){return _0x38b6b1*0x3e8;}async function createTagLog(_0x195e7e,_0x407035,_0x327704,_0x5e12a0={}){const _0x2b2ccc=a632_0x1c146d;try{const _0x4b108a=await TagLog_1['default']['create']({'tagId':_0x195e7e,'type':_0x327704,'contact':_0x5e12a0[_0x2b2ccc(0x162)]||null,'phoneNumber':_0x5e12a0['phoneNumber']||null,'message':_0x5e12a0[_0x2b2ccc(0x153)]||null,'metadata':_0x5e12a0[_0x2b2ccc(0x157)]||null}),_0x2133a3=(0x0,socket_1[_0x2b2ccc(0x14a)])();return _0x2133a3[_0x2b2ccc(0x160)](_0x2b2ccc(0x173)+_0x407035+_0x2b2ccc(0x169),{'action':_0x2b2ccc(0x13b),'tagId':_0x195e7e,'log':_0x4b108a['toJSON']()}),_0x4b108a;}catch(_0x468ac3){console[_0x2b2ccc(0x16a)](_0x2b2ccc(0x13a)+_0x468ac3);}}const CreateService=async({body:_0x3298f2,sendAt:_0x1f32d3,contactId:_0x57b97d,companyId:_0x12d582,userId:_0x557d14,saveMessage:_0x199e2f,campId:_0x168cac,daysR:_0xce1ee2,mediaPath:_0x55c3cc,mediaName:_0x2fe910,applyDelay:applyDelay=![]})=>{const _0x1d551d=a632_0x1c146d,_0x48ec15=Yup[_0x1d551d(0x159)]()[_0x1d551d(0x140)]({'body':Yup[_0x1d551d(0x14e)]()[_0x1d551d(0x150)]()[_0x1d551d(0x138)](0x5),'sendAt':Yup['string']()[_0x1d551d(0x150)]()});try{await _0x48ec15[_0x1d551d(0x148)]({'body':_0x3298f2,'sendAt':_0x1f32d3});}catch(_0x286c5b){throw new AppError_1['default'](_0x286c5b[_0x1d551d(0x153)]);}let _0xb41020=new Date(_0x1f32d3),_0x584a67=0x0,_0x1a6c62=null;if(applyDelay&&_0x168cac){const _0x461998=await getCampaignSettings(_0x12d582);_0x1a6c62=_0x461998;const _0x48abbe=await Schedule_1[_0x1d551d(0x166)][_0x1d551d(0x168)]({'where':{'campId':_0x168cac,'companyId':_0x12d582,'status':_0x1d551d(0x16f)}});if(_0x48abbe>0x0){let _0x1be81f=0x0;for(let _0x2bb454=0x1;_0x2bb454<=_0x48abbe;_0x2bb454++){_0x2bb454%_0x461998[_0x1d551d(0x155)]===0x0?_0x1be81f+=parseToMilliseconds(_0x461998[_0x1d551d(0x14b)]):_0x1be81f+=parseToMilliseconds(randomValue(0x5,_0x461998[_0x1d551d(0x13e)]));}_0xb41020=new Date(_0xb41020[_0x1d551d(0x15f)]()+_0x1be81f),_0x584a67=_0x1be81f;}}const _0x5f4811=await Schedule_1['default'][_0x1d551d(0x13b)]({'body':_0x3298f2,'sendAt':_0xb41020,'contactId':_0x57b97d,'companyId':_0x12d582,'userId':_0x557d14,'saveMessage':_0x199e2f,'status':_0x1d551d(0x16f),'campId':_0x168cac,'daysR':_0xce1ee2,'mediaPath':_0x55c3cc,'mediaName':_0x2fe910});return await _0x5f4811['reload']({'include':[{'model':Contact_1[_0x1d551d(0x166)],'as':_0x1d551d(0x162)}]}),_0x168cac&&await createTagLog(_0x168cac,_0x12d582,_0x1d551d(0x13b),{'contact':_0x5f4811['contact'][_0x1d551d(0x171)],'phoneNumber':_0x5f4811[_0x1d551d(0x162)][_0x1d551d(0x165)],'message':_0x3298f2,'metadata':{'sendAt':_0xb41020,'delayApplied':_0x584a67,'settings':_0x1a6c62?{'messageInterval':_0x1a6c62[_0x1d551d(0x13e)],'longerIntervalAfter':_0x1a6c62[_0x1d551d(0x155)],'greaterInterval':_0x1a6c62[_0x1d551d(0x14b)]}:null}}),_0x5f4811;};function a632_0x2f9e(_0x309b6d,_0x416718){const _0x39e312=a632_0x1167();return a632_0x2f9e=function(_0x1d01b7,_0x279a7d){_0x1d01b7=_0x1d01b7-0x138;let _0x11677b=_0x39e312[_0x1d01b7];return _0x11677b;},a632_0x2f9e(_0x309b6d,_0x416718);}exports[a632_0x1c146d(0x166)]=CreateService;