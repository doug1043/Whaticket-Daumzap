'use strict';function a631_0x48e5(){const _0x1f4581=['shape','-tag-log','getOwnPropertyDescriptor','getOwnPropertyNames','number','2957192RJBlvx','apply','create','findAll','min','metadata','search','parse','../../libs/socket','contact','513675gCjeWa','toString','36eioyQy','Erro\x20ao\x20criar\x20log\x20de\x20tag:\x20','required','20703QoqaeX','getTime','constructor','error','forEach','8McmxrP','company-','../../errors/AppError','2400766mLGLhf','13134942mmVVDC','../../models/Contact','key','get','hasOwnProperty','(((.+)+)+)+$','../../models/CampaignSetting','string','messageInterval','PENDENTE','default','__esModule','2453SHItPJ','greaterInterval','toJSON','call','171890QRVyaF','__importDefault','value','../../models/Schedule','48990fipapa','validate','815zrcsDC','count','__importStar','phoneNumber','emit','length','floor','prototype','configurable','message'];a631_0x48e5=function(){return _0x1f4581;};return a631_0x48e5();}const a631_0xd4adcb=a631_0x13b6;(function(_0x3135c1,_0x29847e){const _0x434858=a631_0x13b6,_0x2a1355=_0x3135c1();while(!![]){try{const _0x1965d4=-parseInt(_0x434858(0xa3))/0x1+-parseInt(_0x434858(0xab))/0x2+-parseInt(_0x434858(0x9e))/0x3*(parseInt(_0x434858(0xa0))/0x4)+parseInt(_0x434858(0x85))/0x5*(-parseInt(_0x434858(0x83))/0x6)+-parseInt(_0x434858(0x94))/0x7+parseInt(_0x434858(0xa8))/0x8*(parseInt(_0x434858(0xac))/0x9)+parseInt(_0x434858(0x7f))/0xa*(parseInt(_0x434858(0x7b))/0xb);if(_0x1965d4===_0x29847e)break;else _0x2a1355['push'](_0x2a1355['shift']());}catch(_0x1fd9e4){_0x2a1355['push'](_0x2a1355['shift']());}}}(a631_0x48e5,0xbdba3));var __createBinding=this&&this['__createBinding']||(Object[a631_0xd4adcb(0x96)]?function(_0x52a168,_0x2b0118,_0x1ed678,_0x3c56b0){const _0x340695=a631_0xd4adcb;if(_0x3c56b0===undefined)_0x3c56b0=_0x1ed678;var _0x4f303c=Object[_0x340695(0x91)](_0x2b0118,_0x1ed678);(!_0x4f303c||(_0x340695(0xaf)in _0x4f303c?!_0x2b0118[_0x340695(0x7a)]:_0x4f303c['writable']||_0x4f303c[_0x340695(0x8d)]))&&(_0x4f303c={'enumerable':!![],'get':function(){return _0x2b0118[_0x1ed678];}}),Object['defineProperty'](_0x52a168,_0x3c56b0,_0x4f303c);}:function(_0x2aa0d2,_0x5b881c,_0x433a8f,_0xe70e44){if(_0xe70e44===undefined)_0xe70e44=_0x433a8f;_0x2aa0d2[_0xe70e44]=_0x5b881c[_0x433a8f];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object['create']?function(_0x743cd1,_0x2dacb7){Object['defineProperty'](_0x743cd1,'default',{'enumerable':!![],'value':_0x2dacb7});}:function(_0x3a2cf4,_0x584aae){const _0x56b303=a631_0xd4adcb;_0x3a2cf4[_0x56b303(0x79)]=_0x584aae;}),__importStar=this&&this[a631_0xd4adcb(0x87)]||(function(){const _0xcc9465=(function(){let _0x561e82=!![];return function(_0x5057bb,_0x2baee3){const _0x558817=_0x561e82?function(){const _0xde1603=a631_0x13b6;if(_0x2baee3){const _0x119a0c=_0x2baee3[_0xde1603(0x95)](_0x5057bb,arguments);return _0x2baee3=null,_0x119a0c;}}:function(){};return _0x561e82=![],_0x558817;};}()),_0x4df753=_0xcc9465(this,function(){const _0x5ac441=a631_0x13b6;return _0x4df753['toString']()['search'](_0x5ac441(0xb1))[_0x5ac441(0x9f)]()[_0x5ac441(0xa5)](_0x4df753)[_0x5ac441(0x9a)](_0x5ac441(0xb1));});_0x4df753();var _0x2440ea=function(_0x55487a){const _0x414651=a631_0x13b6;return _0x2440ea=Object[_0x414651(0x92)]||function(_0x3c5e67){const _0x2945ba=_0x414651;var _0x549a2e=[];for(var _0x56132e in _0x3c5e67)if(Object[_0x2945ba(0x8c)][_0x2945ba(0xb0)][_0x2945ba(0x7e)](_0x3c5e67,_0x56132e))_0x549a2e[_0x549a2e[_0x2945ba(0x8a)]]=_0x56132e;return _0x549a2e;},_0x2440ea(_0x55487a);};return function(_0x2e860b){const _0x14d64c=a631_0x13b6;if(_0x2e860b&&_0x2e860b[_0x14d64c(0x7a)])return _0x2e860b;var _0x46d25b={};if(_0x2e860b!=null){for(var _0x25b562=_0x2440ea(_0x2e860b),_0x321ac3=0x0;_0x321ac3<_0x25b562[_0x14d64c(0x8a)];_0x321ac3++)if(_0x25b562[_0x321ac3]!==_0x14d64c(0x79))__createBinding(_0x46d25b,_0x2e860b,_0x25b562[_0x321ac3]);}return __setModuleDefault(_0x46d25b,_0x2e860b),_0x46d25b;};}()),__importDefault=this&&this[a631_0xd4adcb(0x80)]||function(_0x291be8){return _0x291be8&&_0x291be8['__esModule']?_0x291be8:{'default':_0x291be8};};Object['defineProperty'](exports,'__esModule',{'value':!![]});const Yup=__importStar(require('yup')),AppError_1=__importDefault(require(a631_0xd4adcb(0xaa))),Schedule_1=__importDefault(require(a631_0xd4adcb(0x82))),Contact_1=__importDefault(require(a631_0xd4adcb(0xad))),CampaignSetting_1=__importDefault(require(a631_0xd4adcb(0xb2))),TagLog_1=__importDefault(require('../../models/TagLog')),socket_1=require(a631_0xd4adcb(0x9c));async function getCampaignSettings(_0x19f79d){const _0x3a7bc2=a631_0xd4adcb,_0x3cc727=await CampaignSetting_1[_0x3a7bc2(0x79)][_0x3a7bc2(0x97)]({'where':{'companyId':_0x19f79d}}),_0x1930dc={'messageInterval':0x14,'longerIntervalAfter':0x14,'greaterInterval':0x3c};return _0x3cc727[_0x3a7bc2(0xa7)](_0x578f1b=>{const _0x5760d4=_0x3a7bc2;try{_0x1930dc[_0x578f1b['key']]=JSON[_0x5760d4(0x9b)](_0x578f1b[_0x5760d4(0x81)]);}catch(_0x36c3ae){_0x1930dc[_0x578f1b[_0x5760d4(0xae)]]=_0x578f1b[_0x5760d4(0x81)];}}),_0x1930dc;}function a631_0x13b6(_0x99c1f5,_0x137e2a){const _0x5b2fd6=a631_0x48e5();return a631_0x13b6=function(_0x3d43ff,_0x5c1347){_0x3d43ff=_0x3d43ff-0x79;let _0x48e54c=_0x5b2fd6[_0x3d43ff];return _0x48e54c;},a631_0x13b6(_0x99c1f5,_0x137e2a);}function randomValue(_0x34543c,_0x4ff6e2){const _0x329f47=a631_0xd4adcb;return Math[_0x329f47(0x8b)](Math['random']()*(_0x4ff6e2-_0x34543c+0x1))+_0x34543c;}function parseToMilliseconds(_0x228de8){return _0x228de8*0x3e8;}async function createTagLog(_0x278a7e,_0x22b55f,_0x420fad,_0x57ebc9={}){const _0x2c0793=a631_0xd4adcb;try{const _0x5582b6=await TagLog_1[_0x2c0793(0x79)]['create']({'tagId':_0x278a7e,'type':_0x420fad,'contact':_0x57ebc9[_0x2c0793(0x9d)]||null,'phoneNumber':_0x57ebc9[_0x2c0793(0x88)]||null,'message':_0x57ebc9['message']||null,'metadata':_0x57ebc9[_0x2c0793(0x99)]||null}),_0x398332=(0x0,socket_1['getIO'])();return _0x398332[_0x2c0793(0x89)](_0x2c0793(0xa9)+_0x22b55f+_0x2c0793(0x90),{'action':_0x2c0793(0x96),'tagId':_0x278a7e,'log':_0x5582b6[_0x2c0793(0x7d)]()}),_0x5582b6;}catch(_0x1eac39){console[_0x2c0793(0xa6)](_0x2c0793(0xa1)+_0x1eac39);}}const CreateService=async({body:_0x137144,sendAt:_0x230878,contactId:_0x19e6f1,companyId:_0x491f08,userId:_0x25e314,saveMessage:_0x3c2a4f,campId:_0x29342b,daysR:_0x20266e,mediaPath:_0x6ed2ca,mediaName:_0x5dda8d,applyDelay:applyDelay=![]})=>{const _0x2c2d3f=a631_0xd4adcb,_0x30a0bc=Yup['object']()[_0x2c2d3f(0x8f)]({'body':Yup[_0x2c2d3f(0xb3)]()[_0x2c2d3f(0xa2)]()[_0x2c2d3f(0x98)](0x5),'sendAt':Yup[_0x2c2d3f(0xb3)]()[_0x2c2d3f(0xa2)]()});try{await _0x30a0bc[_0x2c2d3f(0x84)]({'body':_0x137144,'sendAt':_0x230878});}catch(_0x4db67a){throw new AppError_1[(_0x2c2d3f(0x79))](_0x4db67a[_0x2c2d3f(0x8e)]);}let _0x2c558b=new Date(_0x230878),_0x1cf303=0x0,_0x124e30=null;if(applyDelay&&_0x29342b){const _0x21382e=await getCampaignSettings(_0x491f08);_0x124e30=_0x21382e;const _0x1a20c6=await Schedule_1[_0x2c2d3f(0x79)][_0x2c2d3f(0x86)]({'where':{'campId':_0x29342b,'companyId':_0x491f08,'status':'PENDENTE'}});if(_0x1a20c6>0x0){let _0x2d8f41=0x0;for(let _0x18af68=0x1;_0x18af68<=_0x1a20c6;_0x18af68++){_0x18af68%_0x21382e['longerIntervalAfter']===0x0?_0x2d8f41+=parseToMilliseconds(_0x21382e[_0x2c2d3f(0x7c)]):_0x2d8f41+=parseToMilliseconds(randomValue(0x5,_0x21382e[_0x2c2d3f(0xb4)]));}_0x2c558b=new Date(_0x2c558b[_0x2c2d3f(0xa4)]()+_0x2d8f41),_0x1cf303=_0x2d8f41;}}const _0x2a08c1=await Schedule_1[_0x2c2d3f(0x79)][_0x2c2d3f(0x96)]({'body':_0x137144,'sendAt':_0x2c558b,'contactId':_0x19e6f1,'companyId':_0x491f08,'userId':_0x25e314,'saveMessage':_0x3c2a4f,'status':_0x2c2d3f(0xb5),'campId':_0x29342b,'daysR':_0x20266e,'mediaPath':_0x6ed2ca,'mediaName':_0x5dda8d});return await _0x2a08c1['reload']({'include':[{'model':Contact_1[_0x2c2d3f(0x79)],'as':_0x2c2d3f(0x9d)}]}),_0x29342b&&await createTagLog(_0x29342b,_0x491f08,'create',{'contact':_0x2a08c1['contact']['name'],'phoneNumber':_0x2a08c1[_0x2c2d3f(0x9d)][_0x2c2d3f(0x93)],'message':_0x137144,'metadata':{'sendAt':_0x2c558b,'delayApplied':_0x1cf303,'settings':_0x124e30?{'messageInterval':_0x124e30['messageInterval'],'longerIntervalAfter':_0x124e30['longerIntervalAfter'],'greaterInterval':_0x124e30['greaterInterval']}:null}}),_0x2a08c1;};exports[a631_0xd4adcb(0x79)]=CreateService;