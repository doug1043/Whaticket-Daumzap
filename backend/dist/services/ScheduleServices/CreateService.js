'use strict';const a630_0x526964=a630_0x22e9;(function(_0x55892e,_0x3bec27){const _0x183755=a630_0x22e9,_0x16d071=_0x55892e();while(!![]){try{const _0x226fb1=parseInt(_0x183755(0xa0))/0x1*(-parseInt(_0x183755(0xc0))/0x2)+-parseInt(_0x183755(0xca))/0x3+parseInt(_0x183755(0xcb))/0x4*(parseInt(_0x183755(0xbd))/0x5)+-parseInt(_0x183755(0xa2))/0x6+parseInt(_0x183755(0xa3))/0x7*(parseInt(_0x183755(0xc5))/0x8)+parseInt(_0x183755(0xa9))/0x9*(-parseInt(_0x183755(0xd3))/0xa)+-parseInt(_0x183755(0xd8))/0xb*(-parseInt(_0x183755(0xcf))/0xc);if(_0x226fb1===_0x3bec27)break;else _0x16d071['push'](_0x16d071['shift']());}catch(_0x273ea7){_0x16d071['push'](_0x16d071['shift']());}}}(a630_0x37f5,0x9d46f));var __createBinding=this&&this[a630_0x526964(0xaa)]||(Object[a630_0x526964(0xb4)]?function(_0x468bfd,_0x10f3ef,_0x4f9cd6,_0x3b0674){const _0x4345b9=a630_0x526964;if(_0x3b0674===undefined)_0x3b0674=_0x4f9cd6;var _0x40987a=Object['getOwnPropertyDescriptor'](_0x10f3ef,_0x4f9cd6);(!_0x40987a||('get'in _0x40987a?!_0x10f3ef[_0x4345b9(0xb8)]:_0x40987a['writable']||_0x40987a[_0x4345b9(0xcc)]))&&(_0x40987a={'enumerable':!![],'get':function(){return _0x10f3ef[_0x4f9cd6];}}),Object['defineProperty'](_0x468bfd,_0x3b0674,_0x40987a);}:function(_0x51971e,_0x4b0e57,_0x4d2982,_0x2720c4){if(_0x2720c4===undefined)_0x2720c4=_0x4d2982;_0x51971e[_0x2720c4]=_0x4b0e57[_0x4d2982];}),__setModuleDefault=this&&this['__setModuleDefault']||(Object[a630_0x526964(0xb4)]?function(_0x1b99d2,_0x572b0b){const _0xf7fa95=a630_0x526964;Object[_0xf7fa95(0xd5)](_0x1b99d2,_0xf7fa95(0xd1),{'enumerable':!![],'value':_0x572b0b});}:function(_0x148cc7,_0x565fa2){_0x148cc7['default']=_0x565fa2;}),__importStar=this&&this[a630_0x526964(0xc2)]||(function(){const _0x5135ea=(function(){let _0x54ee76=!![];return function(_0x562f26,_0xf8fbc8){const _0x2cec47=_0x54ee76?function(){if(_0xf8fbc8){const _0x4f50ef=_0xf8fbc8['apply'](_0x562f26,arguments);return _0xf8fbc8=null,_0x4f50ef;}}:function(){};return _0x54ee76=![],_0x2cec47;};}()),_0x49cead=_0x5135ea(this,function(){const _0x235541=a630_0x22e9;return _0x49cead[_0x235541(0xce)]()['search'](_0x235541(0xa8))[_0x235541(0xce)]()[_0x235541(0xdb)](_0x49cead)[_0x235541(0xbc)](_0x235541(0xa8));});_0x49cead();var _0x48dc9e=function(_0x374188){const _0x5f3712=a630_0x22e9;return _0x48dc9e=Object[_0x5f3712(0xc3)]||function(_0x19fc48){const _0x5ba574=_0x5f3712;var _0x140462=[];for(var _0x115682 in _0x19fc48)if(Object[_0x5ba574(0x9f)][_0x5ba574(0xb2)][_0x5ba574(0xac)](_0x19fc48,_0x115682))_0x140462[_0x140462[_0x5ba574(0xb5)]]=_0x115682;return _0x140462;},_0x48dc9e(_0x374188);};return function(_0x967a1f){const _0x1300c0=a630_0x22e9;if(_0x967a1f&&_0x967a1f[_0x1300c0(0xb8)])return _0x967a1f;var _0x1c3ef3={};if(_0x967a1f!=null){for(var _0x318079=_0x48dc9e(_0x967a1f),_0x428e1e=0x0;_0x428e1e<_0x318079[_0x1300c0(0xb5)];_0x428e1e++)if(_0x318079[_0x428e1e]!==_0x1300c0(0xd1))__createBinding(_0x1c3ef3,_0x967a1f,_0x318079[_0x428e1e]);}return __setModuleDefault(_0x1c3ef3,_0x967a1f),_0x1c3ef3;};}()),__importDefault=this&&this[a630_0x526964(0xa5)]||function(_0x280a30){const _0x466f39=a630_0x526964;return _0x280a30&&_0x280a30[_0x466f39(0xb8)]?_0x280a30:{'default':_0x280a30};};function a630_0x37f5(){const _0x598b47=['reload','search','21685Fasuwe','Erro\x20ao\x20criar\x20log\x20de\x20tag:\x20','error','2qeHwPs','validate','__importStar','getOwnPropertyNames','required','88xAtGrO','phoneNumber','messageInterval','string','name','574080agneem','28ygtBss','configurable','count','toString','1236TUHuwH','key','default','../../models/Schedule','10nKStvE','../../libs/socket','defineProperty','parse','number','242506eQIuIN','../../errors/AppError','PENDENTE','constructor','../../models/Contact','getTime','prototype','448107eSlojp','greaterInterval','4167714qsWlyi','393239uFfONr','findAll','__importDefault','company-','random','(((.+)+)+)+$','8466759hrWbKl','__createBinding','message','call','shape','object','toJSON','contact','longerIntervalAfter','hasOwnProperty','value','create','length','../../models/CampaignSetting','min','__esModule','-tag-log','emit'];a630_0x37f5=function(){return _0x598b47;};return a630_0x37f5();}Object['defineProperty'](exports,a630_0x526964(0xb8),{'value':!![]});const Yup=__importStar(require('yup')),AppError_1=__importDefault(require(a630_0x526964(0xd9))),Schedule_1=__importDefault(require(a630_0x526964(0xd2))),Contact_1=__importDefault(require(a630_0x526964(0x9d))),CampaignSetting_1=__importDefault(require(a630_0x526964(0xb6))),TagLog_1=__importDefault(require('../../models/TagLog')),socket_1=require(a630_0x526964(0xd4));async function getCampaignSettings(_0x474c5e){const _0x549c77=a630_0x526964,_0x36157d=await CampaignSetting_1[_0x549c77(0xd1)][_0x549c77(0xa4)]({'where':{'companyId':_0x474c5e}}),_0x46d3e0={'messageInterval':0x14,'longerIntervalAfter':0x14,'greaterInterval':0x3c};return _0x36157d['forEach'](_0x48d0fe=>{const _0x2e92c1=_0x549c77;try{_0x46d3e0[_0x48d0fe[_0x2e92c1(0xd0)]]=JSON[_0x2e92c1(0xd6)](_0x48d0fe[_0x2e92c1(0xb3)]);}catch(_0x47acad){_0x46d3e0[_0x48d0fe['key']]=_0x48d0fe[_0x2e92c1(0xb3)];}}),_0x46d3e0;}function randomValue(_0x557569,_0x395dd8){const _0x415fb7=a630_0x526964;return Math['floor'](Math[_0x415fb7(0xa7)]()*(_0x395dd8-_0x557569+0x1))+_0x557569;}function parseToMilliseconds(_0x5598ae){return _0x5598ae*0x3e8;}async function createTagLog(_0x41cd53,_0x2e1528,_0x462fd9,_0x1e5f4f={}){const _0x4d5abf=a630_0x526964;try{const _0x3f1fa5=await TagLog_1[_0x4d5abf(0xd1)][_0x4d5abf(0xb4)]({'tagId':_0x41cd53,'type':_0x462fd9,'contact':_0x1e5f4f['contact']||null,'phoneNumber':_0x1e5f4f[_0x4d5abf(0xc6)]||null,'message':_0x1e5f4f[_0x4d5abf(0xab)]||null,'metadata':_0x1e5f4f['metadata']||null}),_0x3e9ce7=(0x0,socket_1['getIO'])();return _0x3e9ce7[_0x4d5abf(0xba)](_0x4d5abf(0xa6)+_0x2e1528+_0x4d5abf(0xb9),{'action':_0x4d5abf(0xb4),'tagId':_0x41cd53,'log':_0x3f1fa5[_0x4d5abf(0xaf)]()}),_0x3f1fa5;}catch(_0x545429){console[_0x4d5abf(0xbf)](_0x4d5abf(0xbe)+_0x545429);}}function a630_0x22e9(_0xa648dc,_0x3cee6d){const _0x3b6623=a630_0x37f5();return a630_0x22e9=function(_0x2813cc,_0x45678c){_0x2813cc=_0x2813cc-0x9d;let _0x37f54a=_0x3b6623[_0x2813cc];return _0x37f54a;},a630_0x22e9(_0xa648dc,_0x3cee6d);}const CreateService=async({body:_0x20e6cd,sendAt:_0x222279,contactId:_0x5d3427,companyId:_0x18698c,userId:_0x12d5a5,saveMessage:_0x403fd2,campId:_0x3b02e2,daysR:_0x2d728c,mediaPath:_0xd1c8c6,mediaName:_0x1506f9,applyDelay:applyDelay=![]})=>{const _0x353fec=a630_0x526964,_0x260090=Yup[_0x353fec(0xae)]()[_0x353fec(0xad)]({'body':Yup['string']()[_0x353fec(0xc4)]()[_0x353fec(0xb7)](0x5),'sendAt':Yup[_0x353fec(0xc8)]()['required']()});try{await _0x260090[_0x353fec(0xc1)]({'body':_0x20e6cd,'sendAt':_0x222279});}catch(_0x15a7d2){throw new AppError_1[(_0x353fec(0xd1))](_0x15a7d2[_0x353fec(0xab)]);}let _0x1f4d7f=new Date(_0x222279),_0x2a2bff=0x0,_0x106abc=null;if(applyDelay&&_0x3b02e2){const _0x4c2be4=await getCampaignSettings(_0x18698c);_0x106abc=_0x4c2be4;const _0x3ba79c=await Schedule_1[_0x353fec(0xd1)][_0x353fec(0xcd)]({'where':{'campId':_0x3b02e2,'companyId':_0x18698c,'status':'PENDENTE'}});if(_0x3ba79c>0x0){let _0x7eb083=0x0;for(let _0x56de80=0x1;_0x56de80<=_0x3ba79c;_0x56de80++){_0x56de80%_0x4c2be4[_0x353fec(0xb1)]===0x0?_0x7eb083+=parseToMilliseconds(_0x4c2be4['greaterInterval']):_0x7eb083+=parseToMilliseconds(randomValue(0x5,_0x4c2be4[_0x353fec(0xc7)]));}_0x1f4d7f=new Date(_0x1f4d7f[_0x353fec(0x9e)]()+_0x7eb083),_0x2a2bff=_0x7eb083;}}const _0x4ed69b=await Schedule_1[_0x353fec(0xd1)][_0x353fec(0xb4)]({'body':_0x20e6cd,'sendAt':_0x1f4d7f,'contactId':_0x5d3427,'companyId':_0x18698c,'userId':_0x12d5a5,'saveMessage':_0x403fd2,'status':_0x353fec(0xda),'campId':_0x3b02e2,'daysR':_0x2d728c,'mediaPath':_0xd1c8c6,'mediaName':_0x1506f9});return await _0x4ed69b[_0x353fec(0xbb)]({'include':[{'model':Contact_1[_0x353fec(0xd1)],'as':_0x353fec(0xb0)}]}),_0x3b02e2&&await createTagLog(_0x3b02e2,_0x18698c,_0x353fec(0xb4),{'contact':_0x4ed69b[_0x353fec(0xb0)][_0x353fec(0xc9)],'phoneNumber':_0x4ed69b['contact'][_0x353fec(0xd7)],'message':_0x20e6cd,'metadata':{'sendAt':_0x1f4d7f,'delayApplied':_0x2a2bff,'settings':_0x106abc?{'messageInterval':_0x106abc[_0x353fec(0xc7)],'longerIntervalAfter':_0x106abc[_0x353fec(0xb1)],'greaterInterval':_0x106abc[_0x353fec(0xa1)]}:null}}),_0x4ed69b;};exports[a630_0x526964(0xd1)]=CreateService;